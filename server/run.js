!function n(s,a,r){function o(t,e){if(!a[t]){if(!s[t]){var i="function"==typeof require&&require;if(!e&&i)return i(t,!0);if(l)return l(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}i=a[t]={exports:{}},s[t][0].call(i.exports,function(e){return o(s[t][1][e]||e)},i,i.exports,n,s,a,r)}return a[t].exports}for(var l="function"==typeof require&&require,e=0;e<r.length;e++)o(r[e]);return o}({1:[function(e,t,i){"use strict";var r=e("type/value/is"),a=e("type/plain-function/is"),o=e("es5-ext/object/assign"),l=e("es5-ext/object/normalize-options"),h=e("es5-ext/string/#/contains");(t.exports=function(e,t){var i,n,s,a;return arguments.length<2||"string"!=typeof e?(a=t,t=e,e=null):a=arguments[2],r(e)?(i=h.call(e,"c"),n=h.call(e,"e"),s=h.call(e,"w")):n=!(i=s=!0),e={value:t,configurable:i,enumerable:n,writable:s},a?o(l(a),e):e}).gs=function(e,t,i){var n,s;return"string"!=typeof e?(s=i,i=t,t=e,e=null):s=arguments[3],r(t)?a(t)?r(i)?a(i)||(s=i,i=void 0):i=void 0:(s=t,t=i=void 0):t=void 0,e=r(e)?(n=h.call(e,"c"),h.call(e,"e")):!(n=!0),t={get:t,set:i,configurable:n,enumerable:e},s?o(l(s),t):t}},{"es5-ext/object/assign":26,"es5-ext/object/normalize-options":37,"es5-ext/string/#/contains":44,"type/plain-function/is":8,"type/value/is":12}],2:[function(e,t,i){"use strict";var h=e("type/plain-function/is"),c=e("type/value/ensure"),u=e("type/value/is"),n=e("es5-ext/object/map"),p=e("es5-ext/string/#/contains"),m=Function.prototype.call,d=Object.defineProperty,f=Object.getOwnPropertyDescriptor,y=Object.getPrototypeOf,g=Object.prototype.hasOwnProperty,v={configurable:!1,enumerable:!1,writable:!1,value:null},s=function(n,s){var a,t,i,r,o,e,l=!1;return s=Object(c(s)),i=s.cacheName,e=s.flat,u(i)||(i=n),delete s.cacheName,a=s.value,o=h(a),delete s.value,(t={configurable:Boolean(s.configurable),enumerable:Boolean(s.enumerable)}).get=n!==i?function(){return g.call(this,i)||(v.value=o?m.call(a,this,s):a,v.writable=l,d(this,i,v),v.value=null,r&&d(this,n,r)),this[i]}:e?function e(){var t,i=this;if(g.call(this,n)){if((t=f(this,n)).hasOwnProperty("value"))return t.value;if("function"==typeof t.get&&t.get!==e)return t.get.call(this)}for(;!g.call(i,n);)i=y(i);return r.value=o?m.call(a,i,s):a,d(i,n,r),r.value=null,i[n]}:function e(){var t;return g.call(this,n)&&(t=f(this,n))?t.hasOwnProperty("value")?t.value:"function"==typeof t.get&&t.get!==e?t.get.call(this):a:(r.value=o?m.call(a,this,s):a,d(this,n,r),r.value=null,this[n])},t.set=function(e){if(g.call(this,n))throw new TypeError("Cannot assign to lazy defined '"+n+"' property of "+this);t.get.call(this),this[i]=e},s.desc?(r={configurable:p.call(s.desc,"c"),enumerable:p.call(s.desc,"e")},i===n?(r.writable=p.call(s.desc,"w"),r.value=null):(l=p.call(s.desc,"w"),r.get=t.get,r.set=t.set),delete s.desc):i===n&&(r={configurable:Boolean(s.configurable),enumerable:Boolean(s.enumerable),writable:Boolean(s.writable),value:null}),delete s.configurable,delete s.enumerable,delete s.writable,t};t.exports=function(e){return n(e,function(e,t){return s(t,e)})}},{"es5-ext/object/map":36,"es5-ext/string/#/contains":44,"type/plain-function/is":8,"type/value/ensure":11,"type/value/is":12}],3:[function(e,t,i){"use strict";var n=e("../prototype/is");t.exports=function(e){if("function"!=typeof e)return!1;if(!hasOwnProperty.call(e,"length"))return!1;try{if("number"!=typeof e.length)return!1;if("function"!=typeof e.call)return!1;if("function"!=typeof e.apply)return!1}catch(e){return!1}return!n(e)}},{"../prototype/is":9}],4:[function(e,t,i){"use strict";function n(e,t){return e.replace("%v",o(t))}var s=e("../value/is"),a=e("../object/is"),r=e("../string/coerce"),o=e("./to-short-string");t.exports=function(e,t,i){if(!a(i))throw new TypeError(n(t,e));if(!s(e)){if("default"in i)return i.default;if(i.isOptional)return null}i=r(i.errorMessage);throw s(i)||(i=t),new TypeError(n(i,e))}},{"../object/is":7,"../string/coerce":10,"../value/is":12,"./to-short-string":6}],5:[function(e,t,i){"use strict";t.exports=function(t){try{return t.toString()}catch(e){try{return String(t)}catch(e){return null}}}},{}],6:[function(e,t,i){"use strict";var n=e("./safe-to-string"),s=/[\n\r\u2028\u2029]/g;t.exports=function(e){e=n(e);return null===e?"<Non-coercible to string value>":(e=100<e.length?e.slice(0,99)+"â€¦":e).replace(s,function(e){switch(e){case"\n":return"\\n";case"\r":return"\\r";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:throw new Error("Unexpected character")}})}},{"./safe-to-string":5}],7:[function(e,t,i){"use strict";var n=e("../value/is"),s={object:!0,function:!0,undefined:!0};t.exports=function(e){return!!n(e)&&hasOwnProperty.call(s,typeof e)}},{"../value/is":12}],8:[function(e,t,i){"use strict";var n=e("../function/is"),s=/^\s*class[\s{/}]/,a=Function.prototype.toString;t.exports=function(e){return!!n(e)&&!s.test(a.call(e))}},{"../function/is":3}],9:[function(e,t,i){"use strict";var n=e("../object/is");t.exports=function(e){if(!n(e))return!1;try{return e.constructor?e.constructor.prototype===e:!1}catch(e){return!1}}},{"../object/is":7}],10:[function(e,t,i){"use strict";var n=e("../value/is"),s=e("../object/is"),a=Object.prototype.toString;t.exports=function(e){if(!n(e))return null;if(s(e)){var t=e.toString;if("function"!=typeof t)return null;if(t===a)return null}try{return""+e}catch(e){return null}}},{"../object/is":7,"../value/is":12}],11:[function(e,t,i){"use strict";var n=e("../lib/resolve-exception"),s=e("./is");t.exports=function(e){return s(e)?e:n(e,"Cannot use %v",arguments[1])}},{"../lib/resolve-exception":4,"./is":12}],12:[function(e,t,i){"use strict";t.exports=function(e){return null!=e}},{}],13:[function(e,t,i){"use strict";t.exports=e("./is-implemented")()?Array.from:e("./shim")},{"./is-implemented":14,"./shim":15}],14:[function(e,t,i){"use strict";t.exports=function(){var e,t=Array.from;return"function"==typeof t&&(e=t(t=["raz","dwa"]),Boolean(e&&e!==t&&"dwa"===e[1]))}},{}],15:[function(e,t,i){"use strict";var m=e("es6-symbol").iterator,d=e("../../function/is-arguments"),f=e("../../function/is-function"),y=e("../../number/to-pos-integer"),g=e("../../object/valid-callable"),v=e("../../object/valid-value"),b=e("../../object/is-value"),E=e("../../string/is-string"),T=Array.isArray,x=Function.prototype.call,S={configurable:!0,enumerable:!0,writable:!0,value:null},I=Object.defineProperty;t.exports=function(e){var t,i,n,s,a,r,o,l,h,c,u=arguments[1],p=arguments[2];if(e=Object(v(e)),b(u)&&g(u),this&&this!==Array&&f(this))t=this;else{if(!u){if(d(e))return 1!==(a=e.length)?Array.apply(null,e):((s=new Array(1))[0]=e[0],s);if(T(e)){for(s=new Array(a=e.length),i=0;i<a;++i)s[i]=e[i];return s}}s=[]}if(!T(e))if(void 0!==(h=e[m])){for(o=g(h).call(e),t&&(s=new t),l=o.next(),i=0;!l.done;)c=u?x.call(u,p,l.value,i):l.value,t?(S.value=c,I(s,i,S)):s[i]=c,l=o.next(),++i;a=i}else if(E(e)){for(a=e.length,t&&(s=new t),n=i=0;i<a;++i)c=e[i],i+1<a&&55296<=(r=c.charCodeAt(0))&&r<=56319&&(c+=e[++i]),c=u?x.call(u,p,c,n):c,t?(S.value=c,I(s,n,S)):s[n]=c,++n;a=n}if(void 0===a)for(a=y(e.length),t&&(s=new t(a)),i=0;i<a;++i)c=u?x.call(u,p,e[i],i):e[i],t?(S.value=c,I(s,i,S)):s[i]=c;return t&&(S.value=null,s.length=a),s}},{"../../function/is-arguments":17,"../../function/is-function":18,"../../number/to-pos-integer":24,"../../object/is-value":32,"../../object/valid-callable":42,"../../object/valid-value":43,"../../string/is-string":47,"es6-symbol":48}],16:[function(e,t,i){"use strict";t.exports=function(e){return e}},{}],17:[function(e,t,i){"use strict";var n=Object.prototype.toString,s=n.call(function(){return arguments}());t.exports=function(e){return n.call(e)===s}},{}],18:[function(e,t,i){"use strict";var n=Object.prototype.toString,s=RegExp.prototype.test.bind(/^[object [A-Za-z0-9]*Function]$/);t.exports=function(e){return"function"==typeof e&&s(n.call(e))}},{}],19:[function(e,t,i){"use strict";t.exports=function(){}},{}],20:[function(e,t,i){"use strict";t.exports=e("./is-implemented")()?Math.sign:e("./shim")},{"./is-implemented":21,"./shim":22}],21:[function(e,t,i){"use strict";t.exports=function(){var e=Math.sign;return"function"==typeof e&&1===e(10)&&-1===e(-20)}},{}],22:[function(e,t,i){"use strict";t.exports=function(e){return e=Number(e),isNaN(e)||0===e?e:0<e?1:-1}},{}],23:[function(e,t,i){"use strict";var n=e("../math/sign"),s=Math.abs,a=Math.floor;t.exports=function(e){return isNaN(e)?0:0!==(e=Number(e))&&isFinite(e)?n(e)*a(s(e)):e}},{"../math/sign":20}],24:[function(e,t,i){"use strict";var n=e("./to-integer"),s=Math.max;t.exports=function(e){return s(0,n(e))}},{"./to-integer":23}],25:[function(e,t,i){"use strict";var o=e("./valid-callable"),l=e("./valid-value"),h=Function.prototype.bind,c=Function.prototype.call,u=Object.keys,p=Object.prototype.propertyIsEnumerable;t.exports=function(a,r){return function(i,n){var e,s=arguments[2],t=arguments[3];return i=Object(l(i)),o(n),e=u(i),t&&e.sort("function"==typeof t?h.call(t,i):void 0),"function"!=typeof a&&(a=e[a]),c.call(a,e,function(e,t){return p.call(i,e)?c.call(n,s,i[e],e,i,t):r})}}},{"./valid-callable":42,"./valid-value":43}],26:[function(e,t,i){"use strict";t.exports=e("./is-implemented")()?Object.assign:e("./shim")},{"./is-implemented":27,"./shim":28}],27:[function(e,t,i){"use strict";t.exports=function(){var e=Object.assign;return"function"==typeof e&&(e(e={foo:"raz"},{bar:"dwa"},{trzy:"trzy"}),e.foo+e.bar+e.trzy==="razdwatrzy")}},{}],28:[function(e,t,i){"use strict";var r=e("../keys"),o=e("../valid-value"),l=Math.max;t.exports=function(t,i){var n,e,s,a=l(arguments.length,2);for(t=Object(o(t)),s=function(e){try{t[e]=i[e]}catch(e){n=n||e}},e=1;e<a;++e)r(i=arguments[e]).forEach(s);if(void 0!==n)throw n;return t}},{"../keys":33,"../valid-value":43}],29:[function(e,t,i){"use strict";var n,s,a,r,o=Object.create;e("./set-prototype-of/is-implemented")()||(n=e("./set-prototype-of/shim")),t.exports=!n||1!==n.level?o:(r={configurable:!(a={}),enumerable:!(s={}),writable:!0,value:void 0},Object.getOwnPropertyNames(Object.prototype).forEach(function(e){a[e]="__proto__"===e?{configurable:!0,enumerable:!1,writable:!0,value:void 0}:r}),Object.defineProperties(s,a),Object.defineProperty(n,"nullPolyfill",{configurable:!1,enumerable:!1,writable:!1,value:s}),function(e,t){return o(null===e?s:e,t)})},{"./set-prototype-of/is-implemented":39,"./set-prototype-of/shim":40}],30:[function(e,t,i){"use strict";t.exports=e("./_iterate")("forEach")},{"./_iterate":25}],31:[function(e,t,i){"use strict";var n=e("./is-value"),s={function:!0,object:!0};t.exports=function(e){return n(e)&&s[typeof e]||!1}},{"./is-value":32}],32:[function(e,t,i){"use strict";var n=e("../function/noop")();t.exports=function(e){return e!==n&&null!==e}},{"../function/noop":19}],33:[function(e,t,i){"use strict";t.exports=e("./is-implemented")()?Object.keys:e("./shim")},{"./is-implemented":34,"./shim":35}],34:[function(e,t,i){"use strict";t.exports=function(){try{return Object.keys("primitive"),!0}catch(e){return!1}}},{}],35:[function(e,t,i){"use strict";var n=e("../is-value"),s=Object.keys;t.exports=function(e){return s(n(e)?Object(e):e)}},{"../is-value":32}],36:[function(e,t,i){"use strict";var n=e("./valid-callable"),o=e("./for-each"),l=Function.prototype.call;t.exports=function(e,s){var a={},r=arguments[2];return n(s),o(e,function(e,t,i,n){a[t]=l.call(s,r,e,t,i,n)}),a}},{"./for-each":30,"./valid-callable":42}],37:[function(e,t,i){"use strict";var a=e("./is-value"),n=Array.prototype.forEach,r=Object.create;t.exports=function(e){var s=r(null);return n.call(arguments,function(e){if(a(e)){var t,i=Object(e),n=s;for(t in i)n[t]=i[t]}}),s}},{"./is-value":32}],38:[function(e,t,i){"use strict";t.exports=e("./is-implemented")()?Object.setPrototypeOf:e("./shim")},{"./is-implemented":39,"./shim":40}],39:[function(e,t,i){"use strict";var n=Object.create,s=Object.getPrototypeOf,a={};t.exports=function(){var e=Object.setPrototypeOf;return"function"==typeof e&&s(e((arguments[0]||n)(null),a))===a}},{}],40:[function(e,t,i){"use strict";var n,s,a=e("../is-object"),r=e("../valid-value"),o=Object.prototype.isPrototypeOf,l=Object.defineProperty,h={configurable:!0,enumerable:!1,writable:!0,value:void 0},c=function(e,t){if(r(e),null===t||a(t))return e;throw new TypeError("Prototype must be null or an object")};t.exports=(t=function(){var e,t=Object.create(null),i={},n=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__");if(n){try{(e=n.set).call(t,i)}catch(e){}if(Object.getPrototypeOf(t)===i)return{set:e,level:2}}return t.__proto__=i,Object.getPrototypeOf(t)===i?{level:2}:((t={}).__proto__=i,Object.getPrototypeOf(t)===i&&{level:1})}())?(n=2===t.level?t.set?(s=t.set,function(e,t){return s.call(c(e,t),t),e}):function(e,t){return c(e,t).__proto__=t,e}:function e(t,i){var n;return c(t,i),(n=o.call(e.nullPolyfill,t))&&delete e.nullPolyfill.__proto__,t.__proto__=i=null===i?e.nullPolyfill:i,n&&l(e.nullPolyfill,"__proto__",h),t},Object.defineProperty(n,"level",{configurable:!1,enumerable:!1,writable:!1,value:t.level})):null,e("../create")},{"../create":29,"../is-object":31,"../valid-value":43}],41:[function(e,t,i){"use strict";function n(e,t){return[t,e]}var o=e("./valid-callable"),l=e("./is-value"),h=e("./for-each"),c=Function.prototype.call;t.exports=function(e){var s=[],a=arguments[1],r=arguments[2],a=l(a)?o(a):n;return h(e,function(e,t,i,n){s.push(c.call(a,r,e,t,this,n))},e,arguments[3]),s}},{"./for-each":30,"./is-value":32,"./valid-callable":42}],42:[function(e,t,i){"use strict";t.exports=function(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");return e}},{}],43:[function(e,t,i){"use strict";var n=e("./is-value");t.exports=function(e){if(n(e))return e;throw new TypeError("Cannot use null or undefined")}},{"./is-value":32}],44:[function(e,t,i){"use strict";t.exports=e("./is-implemented")()?String.prototype.contains:e("./shim")},{"./is-implemented":45,"./shim":46}],45:[function(e,t,i){"use strict";var n="razdwatrzy";t.exports=function(){return"function"==typeof n.contains&&!0===n.contains("dwa")&&!1===n.contains("foo")}},{}],46:[function(e,t,i){"use strict";var n=String.prototype.indexOf;t.exports=function(e){return-1<n.call(this,e,arguments[1])}},{}],47:[function(e,t,i){"use strict";var n=Object.prototype.toString,s=n.call("");t.exports=function(e){return"string"==typeof e||e&&"object"==typeof e&&(e instanceof String||n.call(e)===s)||!1}},{}],48:[function(e,t,i){"use strict";t.exports=e("./is-implemented")()?e("ext/global-this").Symbol:e("./polyfill")},{"./is-implemented":49,"./polyfill":54,"ext/global-this":58}],49:[function(e,t,i){"use strict";var n=e("ext/global-this"),s={object:!0,symbol:!0};t.exports=function(){var e,t=n.Symbol;if("function"!=typeof t)return!1;e=t("test symbol");try{String(e)}catch(e){return!1}return!!s[typeof t.iterator]&&!!s[typeof t.toPrimitive]&&!!s[typeof t.toStringTag]}},{"ext/global-this":58}],50:[function(e,t,i){"use strict";t.exports=function(e){return!!e&&("symbol"==typeof e||!!e.constructor&&"Symbol"===e.constructor.name&&"Symbol"===e[e.constructor.toStringTag])}},{}],51:[function(e,t,i){"use strict";var s=e("d"),e=Object.create,a=Object.defineProperty,r=Object.prototype,o=e(null);t.exports=function(e){for(var t,i,n=0;o[e+(n||"")];)++n;return o[e+=n||""]=!0,a(r,t="@@"+e,s.gs(null,function(e){i||(i=!0,a(this,t,s(e)),i=!1)})),t}},{d:1}],52:[function(e,t,i){"use strict";var n=e("d"),s=e("ext/global-this").Symbol;t.exports=function(e){return Object.defineProperties(e,{hasInstance:n("",s&&s.hasInstance||e("hasInstance")),isConcatSpreadable:n("",s&&s.isConcatSpreadable||e("isConcatSpreadable")),iterator:n("",s&&s.iterator||e("iterator")),match:n("",s&&s.match||e("match")),replace:n("",s&&s.replace||e("replace")),search:n("",s&&s.search||e("search")),species:n("",s&&s.species||e("species")),split:n("",s&&s.split||e("split")),toPrimitive:n("",s&&s.toPrimitive||e("toPrimitive")),toStringTag:n("",s&&s.toStringTag||e("toStringTag")),unscopables:n("",s&&s.unscopables||e("unscopables"))})}},{d:1,"ext/global-this":58}],53:[function(e,t,i){"use strict";var n=e("d"),s=e("../../../validate-symbol"),a=Object.create(null);t.exports=function(t){return Object.defineProperties(t,{for:n(function(e){return a[e]||(a[e]=t(String(e)))}),keyFor:n(function(e){for(var t in s(e),a)if(a[t]===e)return t})})}},{"../../../validate-symbol":55,d:1}],54:[function(e,t,i){"use strict";var n,s,a,r=e("d"),o=e("./validate-symbol"),l=e("ext/global-this").Symbol,h=e("./lib/private/generate-name"),c=e("./lib/private/setup/standard-symbols"),e=e("./lib/private/setup/symbol-registry"),u=Object.create,p=Object.defineProperties,m=Object.defineProperty;if("function"==typeof l)try{String(l()),a=!0}catch(e){}else l=null;s=function(e){if(this instanceof s)throw new TypeError("Symbol is not a constructor");return n(e)},t.exports=n=function e(t){var i;if(this instanceof e)throw new TypeError("Symbol is not a constructor");return a?l(t):(i=u(s.prototype),t=void 0===t?"":String(t),p(i,{__description__:r("",t),__name__:r("",h(t))}))},c(n),e(n),p(s.prototype,{constructor:r(n),toString:r("",function(){return this.__name__})}),p(n.prototype,{toString:r(function(){return"Symbol ("+o(this).__description__+")"}),valueOf:r(function(){return o(this)})}),m(n.prototype,n.toPrimitive,r("",function(){var e=o(this);return"symbol"==typeof e?e:e.toString()})),m(n.prototype,n.toStringTag,r("c","Symbol")),m(s.prototype,n.toStringTag,r("c",n.prototype[n.toStringTag])),m(s.prototype,n.toPrimitive,r("c",n.prototype[n.toPrimitive]))},{"./lib/private/generate-name":51,"./lib/private/setup/standard-symbols":52,"./lib/private/setup/symbol-registry":53,"./validate-symbol":55,d:1,"ext/global-this":58}],55:[function(e,t,i){"use strict";var n=e("./is-symbol");t.exports=function(e){if(n(e))return e;throw new TypeError(e+" is not a symbol")}},{"./is-symbol":50}],56:[function(e,t,i){"use strict";var n=e("d"),r=e("es5-ext/object/valid-callable"),o=Function.prototype.apply,l=Function.prototype.call,s=Object.create,a=Object.defineProperty,h=Object.defineProperties,c=Object.prototype.hasOwnProperty,u={configurable:!0,enumerable:!1,writable:!0},p=function(e,t){var i;return r(t),c.call(this,"__ee__")?i=this.__ee__:(i=u.value=s(null),a(this,"__ee__",u),u.value=null),i[e]?"object"==typeof i[e]?i[e].push(t):i[e]=[i[e],t]:i[e]=t,this},e=function(e,t){var i,n;return r(t),n=this,p.call(this,e,i=function(){m.call(n,e,i),o.call(t,this,arguments)}),i.__eeOnceListener__=t,this},m=function(e,t){var i,n,s,a;if(r(t),c.call(this,"__ee__")&&(i=this.__ee__)[e])if("object"==typeof(n=i[e]))for(a=0;s=n[a];++a)s!==t&&s.__eeOnceListener__!==t||(2===n.length?i[e]=n[a?0:1]:n.splice(a,1));else n!==t&&n.__eeOnceListener__!==t||delete i[e];return this},d=function(e){var t,i,n,s,a;if(c.call(this,"__ee__")&&(s=this.__ee__[e]))if("object"==typeof s){for(i=arguments.length,a=new Array(i-1),t=1;t<i;++t)a[t-1]=arguments[t];for(s=s.slice(),t=0;n=s[t];++t)o.call(n,this,a)}else switch(arguments.length){case 1:l.call(s,this);break;case 2:l.call(s,this,arguments[1]);break;case 3:l.call(s,this,arguments[1],arguments[2]);break;default:for(i=arguments.length,a=new Array(i-1),t=1;t<i;++t)a[t-1]=arguments[t];o.call(s,this,a)}},f={on:p,once:e,off:m,emit:d},y={on:n(p),once:n(e),off:n(m),emit:n(d)},g=h({},y);t.exports=i=function(e){return null==e?s(g):h(Object(e),y)},i.methods=f},{d:1,"es5-ext/object/valid-callable":42}],57:[function(e,t,i){function n(){if("object"==typeof self&&self)return self;if("object"==typeof window&&window)return window;throw new Error("Unable to resolve global `this`")}t.exports=function(){if(this)return this;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:!0})}catch(e){return n()}try{return __global__?__global__:n()}finally{delete Object.prototype.__global__}}()},{}],58:[function(e,t,i){"use strict";t.exports=e("./is-implemented")()?globalThis:e("./implementation")},{"./implementation":57,"./is-implemented":59}],59:[function(e,t,i){"use strict";t.exports=function(){return"object"==typeof globalThis&&!!globalThis&&globalThis.Array===Array}},{}],60:[function(e,t,i){"use strict";e=e("./lib/private/logger-prototype");t.exports=e._createLevel("info")},{"./lib/private/logger-prototype":65}],61:[function(e,t,i){t.exports=["error","warning","notice","info","debug"]},{}],62:[function(e,t,i){"use strict";var n=e("uni-global")("medikoo/log/202110");n.emitter?t.exports=n.emitter:(e=e("event-emitter"),t.exports=n.emitter=e())},{"event-emitter":56,"uni-global":76}],63:[function(e,t,i){"use strict";t.exports=RegExp.prototype.test.bind(/^[a-z0-9-]+$/)},{}],64:[function(e,t,i){"use strict";var n=e("es5-ext/function/noop"),s=e("es5-ext/object/for-each"),e=e("d");t.exports={isEnabled:e("ew",!0),enable:e(function(){return this._setEnabledState(!0)}),disable:e(function(){return this._setEnabledState(!1)}),_setEnabledState:e(function(t){var e=[],i=(this._setEnabledStateRecursively(t,e),{restore:function(){e.forEach(function(e){e.hasDirectSetting?e.logger.isEnabled=!t:delete e.logger.isEnabled}),i.restore=n}});return i}),_setEnabledStateRecursively:e(function(t,i){this.isEnabled!==t&&(i.push({logger:this,hasDirectSetting:hasOwnProperty.call(this,"isEnabled")}),this.isEnabled=t),s(this._childNamespaceLoggers,function(e){e._setEnabledStateRecursively(t,i)})})}},{d:1,"es5-ext/function/noop":19,"es5-ext/object/for-each":30}],65:[function(e,t,i){"use strict";var n=e("type/string/ensure"),s=e("es5-ext/array/from"),a=e("es5-ext/object/assign"),r=e("es5-ext/object/set-prototype-of"),o=e("d"),l=e("d/lazy"),h=e("../../../levels"),c=e("../../emitter"),u=e("./enable-disable-props"),e=e("./namespace-props"),p=Object.create(null),m=Object.create(Function.prototype,a({isLevelInitialized:o("e",function(e){return e=n(e),this.level===e||!!(e=p[e])&&(!this.namespace||e.isNamespaceInitialized(this.namespace))}),getAllInitializedLevels:o("e",function(){return Object.keys(p).filter(function(e){return this.isLevelInitialized(e)},this).map(function(e){return this._getLevelLogger(e)},this)}),_createLogger:o(function(){return r(function e(t){c.emit("log",{logger:e,messageTokens:s(arguments)})},this)}),_createLevel:o(function(e){var t;return p[e]||(t=m._createLogger(),Object.defineProperties(t,{level:o("e",e),levelIndex:o("e",h.indexOf(e)),levelRoot:o("e",t)}),p[e]=t,c.emit("init",{logger:t}),t)}),_getLevelLogger:o(function(e){return this.level===e?this:(e=this._createLevel(e),this.namespaceTokens.reduce(function(e,t){return e._createNamespace(t)},e))})},l(a(h.reduce(function(e,t){return e[t]=o("e",function(){return this._getLevelLogger(t)},{cacheName:"_"+t}),e},{}),{warn:o(function(){return this._getLevelLogger("warning")},{cacheName:"_warning"})})),e,u));t.exports=m},{"../../../levels":61,"../../emitter":62,"./enable-disable-props":64,"./namespace-props":66,d:1,"d/lazy":2,"es5-ext/array/from":13,"es5-ext/object/assign":26,"es5-ext/object/set-prototype-of":38,"type/string/ensure":73}],66:[function(e,t,i){"use strict";var n=e("type/string/ensure"),s=e("type/lib/to-short-string"),a=e("es5-ext/function/identity"),r=e("es5-ext/object/assign"),o=e("es5-ext/object/to-array"),l=e("d"),h=e("d/lazy"),c=e("../../emitter"),u=e("../is-namespace-token");t.exports=r({get:l(function(t){var e=(t=n(t)).split(":");return e.forEach(function(e){if(!u(e))throw new TypeError(s(t)+" is not a valid namespace string (only 'a-z0-9-' chars are allowed and ':' as delimiter)")}),e.reduce(function(e,t){return e._createNamespace(t)},this)}),isNamespaceInitialized:l("e",function(e){var e=n(e).split(":"),t=this;return e.every(function(e){return t=t._childNamespaceLoggers[e]})}),getAllInitializedNamespaces:l("e",function(){return o(this._childNamespaceLoggers,a)}),_createNamespace:l(function(e){var t;return this._childNamespaceLoggers[e]||(t=Object.defineProperties(this._createLogger(),{_namespaceToken:l("",e)}),this._childNamespaceLoggers[e]=t,c.emit("init",{logger:t}),t)}),_namespaceToken:l("",null)},h({namespace:l("e",function(){return this.namespaceTokens.join(":")||null},{cacheName:"_namespace"}),namespaceTokens:l("e",function(){return this._namespaceToken?Object.getPrototypeOf(this).namespaceTokens.concat(this._namespaceToken):[]},{cacheName:"_namespaceTokens"}),_childNamespaceLoggers:l("",function(){return Object.create(null)},{cacheName:"__childNamespaceLoggers"})}))},{"../../emitter":62,"../is-namespace-token":63,d:1,"d/lazy":2,"es5-ext/function/identity":16,"es5-ext/object/assign":26,"es5-ext/object/to-array":41,"type/lib/to-short-string":70,"type/string/ensure":73}],67:[function(e,t,i){"use strict";var h=e("../string/coerce"),c=e("./to-short-string");t.exports=function(e,t,i){var n=(e=i&&i.errorMessage?h(i.errorMessage):e).indexOf("%v"),t=-1<n?c(t):null;if(i&&i.name){var s,a,r,o,l=e.indexOf("%n");if(-1<l)return-1<n?(o=n<l?(s=t,r=n,a=i.name,l):(s=i.name,r=l,a=t,n),e.slice(0,r)+s+e.slice(r+2,o)+a+e.slice(o+2)):e.slice(0,l)+i.name+e.slice(l+2)}return-1<n?e.slice(0,n)+t+e.slice(n+2):e}},{"../string/coerce":72,"./to-short-string":70}],68:[function(e,t,i){"use strict";var n=e("../value/is"),s=e("./resolve-error-message");t.exports=function(e,t,i){if(i&&!n(e)){if("default"in i)return i.default;if(i.isOptional)return null}t=new(i&&i.Error||TypeError)(s(t,e,i));throw i&&i.errorCode&&(t.code=i.errorCode),t}},{"../value/is":74,"./resolve-error-message":67}],69:[function(e,t,i){arguments[4][5][0].apply(i,arguments)},{dup:5}],70:[function(e,t,i){arguments[4][6][0].apply(i,arguments)},{"./safe-to-string":69,dup:6}],71:[function(e,t,i){arguments[4][7][0].apply(i,arguments)},{"../value/is":74,dup:7}],72:[function(e,t,i){arguments[4][10][0].apply(i,arguments)},{"../object/is":71,"../value/is":74,dup:10}],73:[function(e,t,i){"use strict";var n=e("../lib/resolve-exception"),s=e("./coerce");t.exports=function(e){var t,i=s(e);return null!==i?i:(t=(i=arguments[1])&&i.name?"Expected a string for %n, received %v":"%v is not a string",n(e,t,i))}},{"../lib/resolve-exception":68,"./coerce":72}],74:[function(e,t,i){arguments[4][12][0].apply(i,arguments)},{dup:12}],75:[function(e,t,i){var n,s,a,r;n=this,s=function(){var e="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},n=Array.prototype,D=Object.prototype,j="undefined"!=typeof Symbol?Symbol.prototype:null,G=n.push,l=n.slice,u=D.toString,H=D.hasOwnProperty,t="undefined"!=typeof ArrayBuffer,i="undefined"!=typeof DataView,B=Array.isArray,K=Object.keys,U=Object.create,F=t&&ArrayBuffer.isView,Y=isNaN,q=isFinite,W=!{toString:null}.propertyIsEnumerable("toString"),V=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],z=Math.pow(2,53)-1;function c(s,a){return a=null==a?s.length-1:+a,function(){for(var e=Math.max(arguments.length-a,0),t=Array(e),i=0;i<e;i++)t[i]=arguments[i+a];switch(a){case 0:return s.call(this,t);case 1:return s.call(this,arguments[0],t);case 2:return s.call(this,arguments[0],arguments[1],t)}for(var n=Array(a+1),i=0;i<a;i++)n[i]=arguments[i];return n[a]=t,s.apply(this,n)}}function a(e){var t=typeof e;return"function"==t||"object"==t&&!!e}function Q(e){return void 0===e}function Z(e){return!0===e||!1===e||"[object Boolean]"===u.call(e)}function s(e){var t="[object "+e+"]";return function(e){return u.call(e)===t}}var J=s("String"),X=s("Number"),r=s("Date"),$=s("RegExp"),ee=s("Error"),te=s("Symbol"),ie=s("ArrayBuffer"),o=s("Function"),e=e.document&&e.document.childNodes,p=o="function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof e?function(e){return"function"==typeof e||!1}:o,e=s("Object"),ne=i&&e(new DataView(new ArrayBuffer(8))),o="undefined"!=typeof Map&&e(new Map),i=s("DataView");var m=ne?function(e){return null!=e&&p(e.getInt8)&&ie(e.buffer)}:i,d=B||s("Array");function f(e,t){return null!=e&&H.call(e,t)}var se=s("Arguments"),ae=(!function(){se(arguments)||(se=function(e){return f(e,"callee")})}(),se);function re(e){return X(e)&&Y(e)}function oe(e){return function(){return e}}function le(t){return function(e){e=t(e);return"number"==typeof e&&0<=e&&e<=z}}function he(t){return function(e){return null==e?void 0:e[t]}}var y=he("byteLength"),ce=le(y),ue=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;var pe=t?function(e){return F?F(e)&&!m(e):ce(e)&&ue.test(u.call(e))}:oe(!1),g=he("length");function me(e,t){t=function(t){for(var i={},e=t.length,n=0;n<e;++n)i[t[n]]=!0;return{contains:function(e){return!0===i[e]},push:function(e){return i[e]=!0,t.push(e)}}}(t);var i=V.length,n=e.constructor,s=p(n)&&n.prototype||D,a="constructor";for(f(e,a)&&!t.contains(a)&&t.push(a);i--;)(a=V[i])in e&&e[a]!==s[a]&&!t.contains(a)&&t.push(a)}function v(e){if(!a(e))return[];if(K)return K(e);var t,i=[];for(t in e)f(e,t)&&i.push(t);return W&&me(e,i),i}function de(e,t){var i=v(t),n=i.length;if(null==e)return!n;for(var s=Object(e),a=0;a<n;a++){var r=i[a];if(t[r]!==s[r]||!(r in s))return!1}return!0}function b(e){return e instanceof b?e:this instanceof b?void(this._wrapped=e):new b(e)}function fe(e){return new Uint8Array(e.buffer||e,e.byteOffset||0,y(e))}b.VERSION="1.13.6",b.prototype.valueOf=b.prototype.toJSON=b.prototype.value=function(){return this._wrapped},b.prototype.toString=function(){return String(this._wrapped)};var ye="[object DataView]";function ge(e,t,i,n){var s;return e===t?0!==e||1/e==1/t:null!=e&&null!=t&&(e!=e?t!=t:("function"==(s=typeof e)||"object"==s||"object"==typeof t)&&function e(t,i,n,s){t instanceof b&&(t=t._wrapped);i instanceof b&&(i=i._wrapped);var a=u.call(t);if(a!==u.call(i))return!1;if(ne&&"[object Object]"==a&&m(t)){if(!m(i))return!1;a=ye}switch(a){case"[object RegExp]":case"[object String]":return""+t==""+i;case"[object Number]":return+t!=+t?+i!=+i:0==+t?1/+t==1/i:+t==+i;case"[object Date]":case"[object Boolean]":return+t==+i;case"[object Symbol]":return j.valueOf.call(t)===j.valueOf.call(i);case"[object ArrayBuffer]":case ye:return e(fe(t),fe(i),n,s)}a="[object Array]"===a;if(!a&&pe(t)){var r=y(t);if(r!==y(i))return!1;if(t.buffer===i.buffer&&t.byteOffset===i.byteOffset)return!0;a=!0}if(!a){if("object"!=typeof t||"object"!=typeof i)return!1;var r=t.constructor,o=i.constructor;if(r!==o&&!(p(r)&&r instanceof r&&p(o)&&o instanceof o)&&"constructor"in t&&"constructor"in i)return!1}n=n||[];s=s||[];var l=n.length;for(;l--;)if(n[l]===t)return s[l]===i;n.push(t);s.push(i);if(a){if((l=t.length)!==i.length)return!1;for(;l--;)if(!ge(t[l],i[l],n,s))return!1}else{var h,c=v(t);if(l=c.length,v(i).length!==l)return!1;for(;l--;)if(h=c[l],!f(i,h)||!ge(t[h],i[h],n,s))return!1}n.pop();s.pop();return!0}(e,t,i,n))}function h(e){if(!a(e))return[];var t,i=[];for(t in e)i.push(t);return W&&me(e,i),i}function ve(n){var s=g(n);return function(e){if(null==e)return!1;var t=h(e);if(g(t))return!1;for(var i=0;i<s;i++)if(!p(e[n[i]]))return!1;return n!==Ee||!p(e[be])}}var be="forEach",e=["clear","delete"],i=["get","has","set"],B=e.concat(be,i),Ee=e.concat(i),t=["add"].concat(e,be,"has"),i=o?ve(B):s("Map"),e=o?ve(Ee):s("WeakMap"),B=o?ve(t):s("Set"),o=s("WeakSet");function E(e){for(var t=v(e),i=t.length,n=Array(i),s=0;s<i;s++)n[s]=e[t[s]];return n}function Te(e){for(var t={},i=v(e),n=0,s=i.length;n<s;n++)t[e[i[n]]]=i[n];return t}function xe(e){var t,i=[];for(t in e)p(e[t])&&i.push(t);return i.sort()}function Se(l,h){return function(e){var t=arguments.length;if(h&&(e=Object(e)),!(t<2||null==e))for(var i=1;i<t;i++)for(var n=arguments[i],s=l(n),a=s.length,r=0;r<a;r++){var o=s[r];h&&void 0!==e[o]||(e[o]=n[o])}return e}}var Ie=Se(h),T=Se(v),ke=Se(h,!0);function we(e){var t;return a(e)?U?U(e):((t=function(){}).prototype=e,e=new t,t.prototype=null,e):{}}function Ae(e){return d(e)?e:[e]}function x(e){return b.toPath(e)}function _e(e,t){for(var i=t.length,n=0;n<i;n++){if(null==e)return;e=e[t[n]]}return i?e:void 0}function Pe(e,t,i){e=_e(e,x(t));return Q(e)?i:e}function Me(e){return e}function S(t){return t=T({},t),function(e){return de(e,t)}}function Ce(t){return t=x(t),function(e){return _e(e,t)}}function I(s,a,e){if(void 0===a)return s;switch(null==e?3:e){case 1:return function(e){return s.call(a,e)};case 3:return function(e,t,i){return s.call(a,e,t,i)};case 4:return function(e,t,i,n){return s.call(a,e,t,i,n)}}return function(){return s.apply(a,arguments)}}function Oe(e,t,i){return null==e?Me:p(e)?I(e,t,i):(a(e)&&!d(e)?S:Ce)(e)}function Ne(e,t){return Oe(e,t,1/0)}function k(e,t,i){return b.iteratee!==Ne?b.iteratee(e,t):Oe(e,t,i)}function Le(){}function Re(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))}b.toPath=Ae,b.iteratee=Ne;var w=Date.now||function(){return(new Date).getTime()};function De(t){function i(e){return t[e]}var e="(?:"+v(t).join("|")+")",n=RegExp(e),s=RegExp(e,"g");return function(e){return n.test(e=null==e?"":""+e)?e.replace(s,i):e}}var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},je=De(t),t=De(Te(t)),Ge=b.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},He=/(.)^/,Be={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},Ke=/\\|'|\r|\n|\u2028|\u2029/g;function Ue(e){return"\\"+Be[e]}var Fe=/^\s*(\w|\$)+\s*$/;var Ye=0;function qe(e,t,i,n,s){return n instanceof t?(n=we(e.prototype),a(t=e.apply(n,s))?t:n):e.apply(i,s)}var A=c(function(s,a){function r(){for(var e=0,t=a.length,i=Array(t),n=0;n<t;n++)i[n]=a[n]===o?arguments[e++]:a[n];for(;e<arguments.length;)i.push(arguments[e++]);return qe(s,r,this,this,i)}var o=A.placeholder;return r}),We=(A.placeholder=b,c(function(t,i,n){var s;if(p(t))return s=c(function(e){return qe(t,s,i,this,n.concat(e))});throw new TypeError("Bind must be called on a function")})),_=le(g);function P(e,t,i,n){if(n=n||[],t||0===t){if(t<=0)return n.concat(e)}else t=1/0;for(var s=n.length,a=0,r=g(e);a<r;a++){var o=e[a];if(_(o)&&(d(o)||ae(o)))if(1<t)P(o,t-1,i,n),s=n.length;else for(var l=0,h=o.length;l<h;)n[s++]=o[l++];else i||(n[s++]=o)}return n}var Ve=c(function(e,t){var i=(t=P(t,!1,!1)).length;if(i<1)throw new Error("bindAll must be passed function names");for(;i--;){var n=t[i];e[n]=We(e[n],e)}return e});var ze=c(function(e,t,i){return setTimeout(function(){return e.apply(null,i)},t)}),Qe=A(ze,b,1);function Ze(e){return function(){return!e.apply(this,arguments)}}function Je(e,t){var i;return function(){return 0<--e&&(i=t.apply(this,arguments)),e<=1&&(t=null),i}}var Xe=A(Je,2);function $e(e,t,i){t=k(t,i);for(var n,s=v(e),a=0,r=s.length;a<r;a++)if(t(e[n=s[a]],n,e))return n}function et(a){return function(e,t,i){t=k(t,i);for(var n=g(e),s=0<a?0:n-1;0<=s&&s<n;s+=a)if(t(e[s],s,e))return s;return-1}}var tt=et(1),it=et(-1);function nt(e,t,i,n){for(var s=(i=k(i,n,1))(t),a=0,r=g(e);a<r;){var o=Math.floor((a+r)/2);i(e[o])<s?a=o+1:r=o}return a}function st(a,r,o){return function(e,t,i){var n=0,s=g(e);if("number"==typeof i)0<a?n=0<=i?i:Math.max(i+s,n):s=0<=i?Math.min(i+1,s):i+s+1;else if(o&&i&&s)return e[i=o(e,t)]===t?i:-1;if(t!=t)return 0<=(i=r(l.call(e,n,s),re))?i+n:-1;for(i=0<a?n:s-1;0<=i&&i<s;i+=a)if(e[i]===t)return i;return-1}}var at=st(1,tt,nt),rt=st(-1,it);function ot(e,t,i){t=(_(e)?tt:$e)(e,t,i);if(void 0!==t&&-1!==t)return e[t]}function M(e,t,i){if(t=I(t,i),_(e))for(s=0,a=e.length;s<a;s++)t(e[s],s,e);else for(var n=v(e),s=0,a=n.length;s<a;s++)t(e[n[s]],n[s],e);return e}function C(e,t,i){t=k(t,i);for(var n=!_(e)&&v(e),s=(n||e).length,a=Array(s),r=0;r<s;r++){var o=n?n[r]:r;a[r]=t(e[o],o,e)}return a}function lt(p){return function(e,t,i,n){var s=3<=arguments.length,a=e,r=I(t,n,4),o=i,l=!_(a)&&v(a),h=(l||a).length,c=0<p?0:h-1;for(s||(o=a[l?l[c]:c],c+=p);0<=c&&c<h;c+=p){var u=l?l[c]:c;o=r(o,a[u],u,a)}return o}}var ht=lt(1),ct=lt(-1);function O(e,n,t){var s=[];return n=k(n,t),M(e,function(e,t,i){n(e,t,i)&&s.push(e)}),s}function ut(e,t,i){t=k(t,i);for(var n=!_(e)&&v(e),s=(n||e).length,a=0;a<s;a++){var r=n?n[a]:a;if(!t(e[r],r,e))return!1}return!0}function pt(e,t,i){t=k(t,i);for(var n=!_(e)&&v(e),s=(n||e).length,a=0;a<s;a++){var r=n?n[a]:a;if(t(e[r],r,e))return!0}return!1}function N(e,t,i,n){return _(e)||(e=E(e)),0<=at(e,t,i="number"==typeof i&&!n?i:0)}var mt=c(function(e,i,n){var s,a;return p(i)?a=i:(i=x(i),s=i.slice(0,-1),i=i[i.length-1]),C(e,function(e){var t=a;if(!t){if(null==(e=s&&s.length?_e(e,s):e))return;t=e[i]}return null==t?t:t.apply(e,n)})});function dt(e,t){return C(e,Ce(t))}function ft(e,n,t){var i,s,a=-1/0,r=-1/0;if(null==n||"number"==typeof n&&"object"!=typeof e[0]&&null!=e)for(var o=0,l=(e=_(e)?e:E(e)).length;o<l;o++)null!=(i=e[o])&&a<i&&(a=i);else n=k(n,t),M(e,function(e,t,i){s=n(e,t,i),(r<s||s===-1/0&&a===-1/0)&&(a=e,r=s)});return a}var yt=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function gt(e){return e?d(e)?l.call(e):J(e)?e.match(yt):_(e)?C(e,Me):E(e):[]}function vt(e,t,i){if(null==t||i)return(e=_(e)?e:E(e))[Re(e.length-1)];for(var n=gt(e),i=g(n),s=(t=Math.max(Math.min(t,i),0),i-1),a=0;a<t;a++){var r=Re(a,s),o=n[a];n[a]=n[r],n[r]=o}return n.slice(0,t)}function L(a,t){return function(i,n,e){var s=t?[[],[]]:{};return n=k(n,e),M(i,function(e,t){t=n(e,t,i);a(s,e,t)}),s}}var bt=L(function(e,t,i){f(e,i)?e[i].push(t):e[i]=[t]}),Et=L(function(e,t,i){e[i]=t}),Tt=L(function(e,t,i){f(e,i)?e[i]++:e[i]=1}),xt=L(function(e,t,i){e[i?0:1].push(t)},!0);function St(e,t,i){return t in i}var It=c(function(e,t){var i={},n=t[0];if(null!=e){p(n)?(1<t.length&&(n=I(n,t[1])),t=h(e)):(n=St,t=P(t,!1,!1),e=Object(e));for(var s=0,a=t.length;s<a;s++){var r=t[s],o=e[r];n(o,r,e)&&(i[r]=o)}}return i}),kt=c(function(e,i){var t,n=i[0];return p(n)?(n=Ze(n),1<i.length&&(t=i[1])):(i=C(P(i,!1,!1),String),n=function(e,t){return!N(i,t)}),It(e,n,t)});function wt(e,t,i){return l.call(e,0,Math.max(0,e.length-(null==t||i?1:t)))}function At(e,t,i){return null==e||e.length<1?null==t||i?void 0:[]:null==t||i?e[0]:wt(e,e.length-t)}function R(e,t,i){return l.call(e,null==t||i?1:t)}var _t=c(function(e,t){return t=P(t,!0,!0),O(e,function(e){return!N(t,e)})}),Pt=c(function(e,t){return _t(e,t)});function Mt(e,t,i,n){Z(t)||(n=i,i=t,t=!1),null!=i&&(i=k(i,n));for(var s=[],a=[],r=0,o=g(e);r<o;r++){var l=e[r],h=i?i(l,r,e):l;t&&!i?(r&&a===h||s.push(l),a=h):i?N(a,h)||(a.push(h),s.push(l)):N(s,l)||s.push(l)}return s}var Ct=c(function(e){return Mt(P(e,!0,!0))});function Ot(e){for(var t=e&&ft(e,g).length||0,i=Array(t),n=0;n<t;n++)i[n]=dt(e,n);return i}var Nt=c(Ot);function Lt(e,t){return e._chain?b(t).chain():t}function Rt(i){return M(xe(i),function(e){var t=b[e]=i[e];b.prototype[e]=function(){var e=[this._wrapped];return G.apply(e,arguments),Lt(this,t.apply(b,e))}}),b}M(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var i=n[t];b.prototype[t]=function(){var e=this._wrapped;return null!=e&&(i.apply(e,arguments),"shift"!==t&&"splice"!==t||0!==e.length||delete e[0]),Lt(this,e)}}),M(["concat","join","slice"],function(e){var t=n[e];b.prototype[e]=function(){var e=this._wrapped;return Lt(this,e=null!=e?t.apply(e,arguments):e)}});r=Rt({__proto__:null,VERSION:"1.13.6",restArguments:c,isObject:a,isNull:function(e){return null===e},isUndefined:Q,isBoolean:Z,isElement:function(e){return!(!e||1!==e.nodeType)},isString:J,isNumber:X,isDate:r,isRegExp:$,isError:ee,isSymbol:te,isArrayBuffer:ie,isDataView:m,isArray:d,isFunction:p,isArguments:ae,isFinite:function(e){return!te(e)&&q(e)&&!isNaN(parseFloat(e))},isNaN:re,isTypedArray:pe,isEmpty:function(e){var t;return null==e||("number"==typeof(t=g(e))&&(d(e)||J(e)||ae(e))?0===t:0===g(v(e)))},isMatch:de,isEqual:function(e,t){return ge(e,t)},isMap:i,isWeakMap:e,isSet:B,isWeakSet:o,keys:v,allKeys:h,values:E,pairs:function(e){for(var t=v(e),i=t.length,n=Array(i),s=0;s<i;s++)n[s]=[t[s],e[t[s]]];return n},invert:Te,functions:xe,methods:xe,extend:Ie,extendOwn:T,assign:T,defaults:ke,create:function(e,t){return e=we(e),t&&T(e,t),e},clone:function(e){return a(e)?d(e)?e.slice():Ie({},e):e},tap:function(e,t){return t(e),e},get:Pe,has:function(e,t){for(var i=(t=x(t)).length,n=0;n<i;n++){var s=t[n];if(!f(e,s))return!1;e=e[s]}return!!i},mapObject:function(e,t,i){t=k(t,i);for(var n=v(e),s=n.length,a={},r=0;r<s;r++){var o=n[r];a[o]=t(e[o],o,e)}return a},identity:Me,constant:oe,noop:Le,toPath:Ae,property:Ce,propertyOf:function(t){return null==t?Le:function(e){return Pe(t,e)}},matcher:S,matches:S,times:function(e,t,i){var n=Array(Math.max(0,e));t=I(t,i,1);for(var s=0;s<e;s++)n[s]=t(s);return n},random:Re,now:w,escape:je,unescape:t,templateSettings:Ge,template:function(a,e,t){e=ke({},e=!e&&t?t:e,b.templateSettings);var i,t=RegExp([(e.escape||He).source,(e.interpolate||He).source,(e.evaluate||He).source].join("|")+"|$","g"),r=0,o="__p+='";if(a.replace(t,function(e,t,i,n,s){return o+=a.slice(r,s).replace(Ke,Ue),r=s+e.length,t?o+="'+\n((__t=("+t+"))==null?'':_.escape(__t))+\n'":i?o+="'+\n((__t=("+i+"))==null?'':__t)+\n'":n&&(o+="';\n"+n+"\n__p+='"),e}),o+="';\n",t=e.variable){if(!Fe.test(t))throw new Error("variable is not a bare identifier: "+t)}else o="with(obj||{}){\n"+o+"}\n",t="obj";o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{i=new Function(t,"_",o)}catch(e){throw e.source=o,e}function n(e){return i.call(this,e,b)}return n.source="function("+t+"){\n"+o+"}",n},result:function(e,t,i){var n=(t=x(t)).length;if(!n)return p(i)?i.call(e):i;for(var s=0;s<n;s++){var a=null==e?void 0:e[t[s]];void 0===a&&(a=i,s=n),e=p(a)?a.call(e):a}return e},uniqueId:function(e){var t=++Ye+"";return e?e+t:t},chain:function(e){return(e=b(e))._chain=!0,e},iteratee:Ne,partial:A,bind:We,bindAll:Ve,memoize:function(n,s){function a(e){var t=a.cache,i=""+(s?s.apply(this,arguments):e);return f(t,i)||(t[i]=n.apply(this,arguments)),t[i]}return a.cache={},a},delay:ze,defer:Qe,throttle:function(i,n,s){function a(){c=!1===s.leading?0:w(),r=null,h=i.apply(o,l),r||(o=l=null)}function e(){var e=w(),t=(c||!1!==s.leading||(c=e),n-(e-c));return o=this,l=arguments,t<=0||n<t?(r&&(clearTimeout(r),r=null),c=e,h=i.apply(o,l),r||(o=l=null)):r||!1===s.trailing||(r=setTimeout(a,t)),h}var r,o,l,h,c=0;return s=s||{},e.cancel=function(){clearTimeout(r),c=0,r=o=l=null},e},debounce:function(t,i,n){function s(){var e=w()-r;e<i?a=setTimeout(s,i-e):(a=null,n||(l=t.apply(h,o)),a||(o=h=null))}var a,r,o,l,h,e=c(function(e){return h=this,o=e,r=w(),a||(a=setTimeout(s,i),n&&(l=t.apply(h,o))),l});return e.cancel=function(){clearTimeout(a),a=o=h=null},e},wrap:function(e,t){return A(t,e)},negate:Ze,compose:function(){var i=arguments,n=i.length-1;return function(){for(var e=n,t=i[n].apply(this,arguments);e--;)t=i[e].call(this,t);return t}},after:function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},before:Je,once:Xe,findKey:$e,findIndex:tt,findLastIndex:it,sortedIndex:nt,indexOf:at,lastIndexOf:rt,find:ot,detect:ot,findWhere:function(e,t){return ot(e,S(t))},each:M,forEach:M,map:C,collect:C,reduce:ht,foldl:ht,inject:ht,reduceRight:ct,foldr:ct,filter:O,select:O,reject:function(e,t,i){return O(e,Ze(k(t)),i)},every:ut,all:ut,some:pt,any:pt,contains:N,includes:N,include:N,invoke:mt,pluck:dt,where:function(e,t){return O(e,S(t))},max:ft,min:function(e,n,t){var i,s,a=1/0,r=1/0;if(null==n||"number"==typeof n&&"object"!=typeof e[0]&&null!=e)for(var o=0,l=(e=_(e)?e:E(e)).length;o<l;o++)null!=(i=e[o])&&i<a&&(a=i);else n=k(n,t),M(e,function(e,t,i){((s=n(e,t,i))<r||s===1/0&&a===1/0)&&(a=e,r=s)});return a},shuffle:function(e){return vt(e,1/0)},sample:vt,sortBy:function(e,n,t){var s=0;return n=k(n,t),dt(C(e,function(e,t,i){return{value:e,index:s++,criteria:n(e,t,i)}}).sort(function(e,t){var i=e.criteria,n=t.criteria;if(i!==n){if(n<i||void 0===i)return 1;if(i<n||void 0===n)return-1}return e.index-t.index}),"value")},groupBy:bt,indexBy:Et,countBy:Tt,partition:xt,toArray:gt,size:function(e){return null==e?0:(_(e)?e:v(e)).length},pick:It,omit:kt,first:At,head:At,take:At,initial:wt,last:function(e,t,i){return null==e||e.length<1?null==t||i?void 0:[]:null==t||i?e[e.length-1]:R(e,Math.max(0,e.length-t))},rest:R,tail:R,drop:R,compact:function(e){return O(e,Boolean)},flatten:function(e,t){return P(e,t,!1)},without:Pt,uniq:Mt,unique:Mt,union:Ct,intersection:function(e){for(var t=[],i=arguments.length,n=0,s=g(e);n<s;n++){var a=e[n];if(!N(t,a)){for(var r=1;r<i&&N(arguments[r],a);r++);r===i&&t.push(a)}}return t},difference:_t,unzip:Ot,transpose:Ot,zip:Nt,object:function(e,t){for(var i={},n=0,s=g(e);n<s;n++)t?i[e[n]]=t[n]:i[e[n][0]]=e[n][1];return i},range:function(e,t,i){null==t&&(t=e||0,e=0),i=i||(t<e?-1:1);for(var n=Math.max(Math.ceil((t-e)/i),0),s=Array(n),a=0;a<n;a++,e+=i)s[a]=e;return s},chunk:function(e,t){if(null==t||t<1)return[];for(var i=[],n=0,s=e.length;n<s;)i.push(l.call(e,n,n+=t));return i},mixin:Rt,default:b});return r._=r},"object"==typeof i&&void 0!==t?t.exports=s():"function"==typeof define&&define.amd?define("underscore",s):(n="undefined"!=typeof globalThis?globalThis:n||self,a=n._,(r=n._=s()).noConflict=function(){return n._=a,r})},{}],76:[function(e,t,i){"use strict";var n=e("type/string/ensure"),s=e("./lib/uni-global"),a=Object.prototype.hasOwnProperty;t.exports=function(e){var t;return e=n(e,{name:"key"}),a.call(s,e)?s[e]:(t=Object.create?Object.create(null):{},s[e]=t)}},{"./lib/uni-global":78,"type/string/ensure":73}],77:[function(e,t,i){"use strict";Object.defineProperty&&Object.create?"function"==typeof Symbol&&Symbol.for?t.exports="2015+":t.exports="5":t.exports="3"},{}],78:[function(e,t,i){"use strict";var n=e("./es-env-type");switch(n){case"3":return EvalError.$ug202109?void(t.exports=EvalError.$ug202109):void(t.exports=EvalError.$ug202109={});case"5":return EvalError.$uniGlobal202109?void(t.exports=EvalError.$uniGlobal202109):void Object.defineProperty(EvalError,"$uniGlobal202109",{value:t.exports=Object.create(null)});case"2015+":var s=Symbol.for("$uniGlobal202109");return EvalError[s]?void(t.exports=EvalError[s]):void Object.defineProperty(EvalError,s,{value:t.exports=Object.create(null)});default:throw new Error("Unrecognized environment type: "+n)}},{"./es-env-type":77}],79:[function(e,t,i){var n=e("underscore"),e=e("../shared/data/appearance.json"),s=[],a={weapon:[],weaponarcher:[],armor:[],armorarcher:[]};n.each(e,function(e,t){s.push({name:e.name,type:e.type,sprite:e.sprite,buy:e.buy}),a[e.type]&&a[e.type].push({key:t,val:e})}),t.exports.ItemGearTypes=a,t.exports.Data=s},{"../shared/data/appearance.json":150,underscore:75}],80:[function(e,t,i){var n=e("./lib/class"),s=e("underscore"),l=e("./utils");e("./message"),e("./mobdata");t.exports=Area=n.Class.extend({init:function(e,t,i,n,s,a,r,o){this.id=e;e=G_TILESIZE;this.gx=t,this.gy=i,this.x=t*e,this.y=i*e,r&&(this.x,this.width,this.y,this.height),this.width=n*e,this.height=s*e,this.map=a,this.entities=[],this.hasCompletelyRespawned=!0,this.elipse=r||!1,this.excludeId=o},_getRandomPosition:function(e,t,i){i=i||30;for(var n,s,a={},r=0,o=Math.min(t.height,t.width);r<i;){if(this.elipse?(n=2*Math.random()*Math.PI,s=l.randomRangeInt(0,~~(o/2)),a.x=Math.round(e.x+s*Math.cos(n)),a.y=Math.round(e.y+s*Math.sin(n))):(a.x=e.x+l.randomInt(t.width),a.y=e.y+l.randomInt(t.height)),this.contains(a.x,a.y,0))if(!this.map.isColliding(a.x,a.y))break;r++}return i<=r?null:a},_getRandomPositionForEntity:function(e,t,i){return this._getRandomPosition(e,{width:t,height:t},i)},_getRandomPositionInsideArea:function(e){return this._getRandomPosition(this,this,e)},contains:function(e,t,i){var n,s;return this.elipse?(n=this.x,s=this.y,n=Math.sqrt(Math.pow(e-n,2)+Math.pow(t-s,2))<this.width/2,1==i||-1==this.excludeId?n:0==i&&(s=n,(i=this.map.mobLiveAreas[this.elipseId])?s&&!i.contains(e,t,1):s)):e>=this.x&&t>=this.y&&e<this.x+this.width&&t<this.y+this.height},removeFromArea:function(e){e=s.indexOf(s.pluck(this.entities,"id"),e.id);this.entities.splice(e,1),this.isEmpty()&&this.hasCompletelyRespawned&&this.emptyCallback&&(this.hasCompletelyRespawned=!1,this.emptyCallback())},addToArea:function(e){e&&null!==e.kind&&(this.entities.push(e),e.area=this),this.isFull()&&(this.hasCompletelyRespawned=!0)},setNumberOfEntities:function(e){this.nbEntities=e},isEmpty:function(){return!s.any(this.entities,function(e){return!e.isDead})},isFull:function(){return!this.isEmpty()&&this.nbEntities===s.size(this.entities)},onEmpty:function(e){this.emptyCallback=e},respawn:function(i,e){var n=this;e=i.spawnDelay||e,this.removeFromArea(i),setTimeout(function(){var e=n.map.entities.spaceEntityRandomApart(2,n._getRandomPositionInsideArea.bind(n,20),n.entities),t=e.x,e=e.y;i.spawnX=i.x=t,i.spawnY=i.y=e,i.respawn()},e)}}),t.exports=Area},{"./lib/class":104,"./message":111,"./mobdata":117,"./utils":146,underscore:75}],81:[function(e,t,i){var n=e("./lib/class"),l=(e("./itemroom"),e("./message")),h=e("../shared/js/itemtypes"),c=e("../shared/js/gametypes");t.exports=AuctionRecord=n.Class.extend({init:function(e,t,i){this.playerName=e,this.price=t,this.item=i},save:function(e){return[this.playerName,this.price].join(",")+","+this.item.save()},toArray:function(e){return[parseInt(e),this.playerName,this.price].concat(this.item.toArray())}}),t.exports=Auction=n.Class.extend({init:function(){this.auctions={},this.load()},load:function(){console.info("AUCTION LOAD"),databaseHandler.loadAuctions(this,this.onLoad)},onLoad:function(e,t){t&&(e.auctions=t)},save:function(){console.info("AUCTION SAVED"),this.auctions&&databaseHandler.saveAuctions(this.auctions)},add:function(e,t,i,n){var s=0;this.auctions&&(s=Object.keys(this.auctions).length),this.auctions[s]=new AuctionRecord(e.name,i,t),e.inventory.setItem(n,null),e.map.entities.pushToPlayer(e,new l.Notify("AUCTION","AUCTION_ADDED"))},remove:function(e){this.auctions[e]=null},list:function(e,t){var i,n=[c.Messages.SC_AUCTIONOPEN,t,0],s=0;for(i in this.auctions){var a,r,o=this.auctions[i];o&&(a=o.item.itemKind,r=e.name===o.playerName,1===t&&!r&&h.isArmor(a)||2===t&&!r&&h.isWeapon(a)||0===t&&r)&&(n=n.concat(o.toArray(i)),++s)}n[2]=s,e.map.entities.pushToPlayer(e,new l.AuctionOpen(n))}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./itemroom":100,"./lib/class":104,"./message":111}],82:[function(e,t,i){var n=e("./lib/class"),s=(e("./itemroom"),e("./message")),a=e("../shared/js/itemtypes");e("../shared/js/gametypes");t.exports=Bank=n.Class.extend({init:function(e,t,i){if(this.owner=e,this.number=t,this.maxNumber=96,this.rooms={},console.info("number="+t),i)for(var n=0;n<i.length;n++)this.rooms[i[n].slot]=i[n]},hasItem:function(e){return this.hasItems(e,1)},hasItems:function(e,t){var i,n=0;for(i in this.rooms)if(this.rooms[i]&&this.rooms[i].itemKind===e&&t<=(n+=this.rooms[i].itemNumber))return!0;return!1},hasItemCount:function(e){var t,i=0;for(t in this.rooms)this.rooms[t]&&this.rooms[t].itemKind===e&&(i+=this.rooms[t].itemNumber);return i},makeEmptyItem:function(e){this.rooms[e]=null,delete this.rooms[e],this.setItem(e,null)},getItemCount:function(e){for(var t in this.rooms)if(this.rooms[t]&&this.rooms[t].itemKind==e)return this.rooms[t].itemNumber;return 0},getItemIndex:function(e){for(var t in this.rooms)if(this.rooms[t]&&this.rooms[t].itemKind==e)return t;return-1},getEmptyIndex:function(){for(var e=0;e<this.maxNumber;e++)if(!this.rooms[e])return e;return-1},putItem:function(e){var t=a.isConsumableItem(e.itemKind),i=a.isLootItem(e.itemKind),n=a.isCraftItem(e.itemKind);if(t||i||n)for(var s in this.rooms){s=this.combineItem(e,this.rooms[s]);if(0<=s)return s}return this._putItem(e)},combineItem:function(e,t){var i,n;return console.info(JSON.stringify(e)),console.info(JSON.stringify(t)),!e||!t||e.itemKind!=t.itemKind||a.isEquippable(e.itemKind)||a.isEquippable(t.itemKind)?-1:(i=e.slot,n=t.slot,t.itemNumber<this.maxStack&&(t.itemNumber+=e.itemNumber,t.itemNumber>this.maxStack?(e.itemNumber=t.itemNumber-this.maxStack,t.itemNumber=Math.min(t.itemNumber,this.maxStack)):e=null),t.itemNumber<=0&&(t=null),this.setItem(i,e),this.setItem(n,t),n)},_putItem:function(e){var t;return(t=this.getEmptyIndex(0,this.maxNumber))<0?(this.owner instanceof Player&&this.owner.map.entities.pushToPlayer(this.owner,new s.Notify("BANK","BANK_FULL")),-1):(this.setItem(t,e),t)},checkItem:function(e,t){return!0},setItem:function(e,t){if(t){if(!this.checkItem(e,t))return!1;(this.rooms[e]=t).slot=e}else t={slot:e,itemKind:-1},this.rooms[e]=null;return this.owner.map.entities.pushToPlayer(this.owner,new s.ItemSlot(1,[t])),!0},save:function(){databaseHandler.saveItems(this.owner,1,this.rooms)},takeOutItems:function(e,t){var i=this.rooms[e];return!i||t>i.itemNumber?null:(a.isEquippable(i.itemKind)?this.setItem(e,null):(i.itemNumber-=t,0==i.itemNumber&&(i=null),this.setItem(e,i)),i)},toString:function(){for(var e=0,t=this.maxNumber+",",e=0;e<this.maxNumber;e++){var i=this.rooms[e];t+=(itemArray=[i.itemKind,i.itemNumber,i.itemDurability,i.itemDurabilityMax,i.itemExperience]).join(",")}return t},toStringJSON:function(){for(var e="[",t=!1,i=0;i<this.maxNumber;i++){var n=this.rooms[i];n&&(e+="["+(itemArray=[i,n.itemKind,n.itemNumber,n.itemDurability,n.itemDurabilityMax,n.itemExperience]).join(",")+"],",t=!0)}return e=e.slice(0,-1),e+="]",t?e:"[]"}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./itemroom":100,"./lib/class":104,"./message":111}],83:[function(e,t,i){e("./lib/class");var n=e("./entitymoving"),c=e("../shared/js/gametypes");t.exports=Block=n.extend({init:function(e,t,i,n,s,a,r,o,l){var h=this.type=c.EntityTypes.BLOCK;this.parent=a,this.ix=o,this.iy=l,this._super(e,h,t,i,n,s),this.name=r,this.playerName=null},isCompleted:function(e){this.parent.isCompleted()&&this.parent.onComplete()},getState:function(){return this._getBaseState().concat([parseInt(this.ix),parseInt(this.iy)])},update:function(e){this.playerName=e.name,this.parent.update()}})},{"../shared/js/gametypes":167,"./entitymoving":92,"./lib/class":104}],84:[function(e,t,i){e("./lib/class");var n=e("./area.js"),o=e("./block.js"),s=e("./utils");e("../shared/js/gametypes");t.exports=BlockArea=n.extend({init:function(e,t,i,n,s,a,r){this._super(e,t,i,n,s,a,r),this.blocks=[],this.players={}},initArea:function(e,t,i){for(var n=this.map.entities.entityCount,s=0;s<i;++s)for(var a=0;a<t;++a){var r=new o(n+(t*s+a),e,this.x+a*G_TILESIZE,this.y+s*G_TILESIZE,this.map,this,"block"+e+"-"+s+"_"+a,a,s);this.map.entities.addBlock(r),this.blocks.push(r)}this.map.entities.entityCount+=t*i},randomizeBlocks:function(e){for(var t in this.blocks){var t=this.blocks[t],i=this.map.entities.spaceEntityRandomApart(e,this._getRandomPositionInsideArea.bind(this,30));i?t.setPosition(~~s.floorTo(i.x,G_TILESIZE),~~s.floorTo(i.y,G_TILESIZE)):console.error("BlockArea - randomizeBlocks: failed.")}},isCompleted:function(){var e,t,i,n=null,s=this.blocks[0];for(i in this.blocks){if(e=this.blocks[i],t=i%this.numX,n)if(0==t){if(e.y-s.y!==G_TILESIZE&&e.x-s.x!=0)return!1;s=e}else if(n.x-e.x!==G_TILESIZE&&n.y-e.y!=0)return!1;n=e}return!0},Completed:function(){for(var e in console.warn("BLOCKAREA - COMPLETED."),this.blocks){e=this.blocks[e];e.playerName&&(this.players.hasOwnProperty(e.playerName)?this.players[e.playerName]++:this.players[e.playerName]=1)}},onComplete:function(e){this.complete_callback=e},update:function(){if(this.isCompleted())for(var e in this.Completed(),this.complete_callback&&0<Object.keys(this.players).length&&this.complete_callback(this),this.blocks){e=this.blocks[e];this.map.entities.removeEntity(e),this.map.entities.pushBroadcast(e.despawn())}}})},{"../shared/js/gametypes":167,"./area.js":80,"./block.js":83,"./lib/class":104,"./utils":146}],85:[function(e,t,i){e("./lib/class");var n=e("./entitymoving"),a=e("./message"),d=e("./utils"),s=e("./mobdata"),r=(e("./npcdata"),e("./timer")),l=e("../shared/js/gametypes"),o=e("./transition");t.exports=Character=n.extend({init:function(e,t,i,n,s,a){this._super(e,t,i,n,s,a),this.nextX=-1,this.nextY=-1,this.prevX=-1,this.prevY=-1,this.atkSpeed=100,this.moveSpeed=100,this.setMoveRate(this.moveSpeed),this.walkSpeed=150,this.idleSpeed=d.randomInt(750,1e3),this.setAttackRate(1024),this.target=null,this.unconfirmedTarget=null,this.attackers={},this.isDead=!1,this.isDying=!1,this.attackingMode=!1,this.followingMode=!1,this.engagingPC=!1,this.observeTimer=new r(4096),this.step=0,this.orientation=this.setRandomOrientation(),this.movement=new o,this.path=null,this.newDestination=null,this.adjacentTiles={},this.stats={},this.stats.hp=0,this.stats.hpMax=0,this.stats.ep=0,this.stats.epMax=0,this.attackCooldown=null,this.moveCooldown=null,this.attackerLevel=0,this.defenderLevel=0,this.moveLevel=0,this.armor=null,this.weapon=null,this.freeze=!1,this.effects={},this.invincible=!1,this.mod={accuracy:1,damage:1,defence:1,attack:1,attackTime:1,crit:1,dot:0,dr:0,time:0,daze:0,hate:0},this.neighboursUpdated=!1},setMaxHpMax:function(e){this.stats.hpMax=e,this.stats.hp=e},setAttackRange:function(e){this.attackRange=e*G_TILESIZE},setOrientation:function(e){e&&(this.orientation=e||0)},idle:function(e){this.setOrientation(e)},hit:function(e){this.setOrientation(e),this.stop()},walk:function(e){this.setOrientation(e)},moveTo_:function(e,t,i){this.destination={x:e,y:t},this.adjacentTiles={},this.isMovingPath()?this.continueTo(e,t):(console.warn("requestPathfindingTo"),e=this.requestPathfindingTo(e,t),console.warn("requestPathfindingTo.path: "+JSON.stringify(e)),e&&this.followPath(e))},requestPathfindingTo:function(e,t){if(Array.isArray(this.path)&&0<this.path.length)return this.path;if(this.request_path_callback)return this.request_path_callback(e,t);console.info(this.id+" couldn't request pathfinding to "+e+", "+t),console.info("char x:"+this.x+",y: "+this.y+", x:"+e+"y: "+t);try{throw new Error}catch(e){console.info(e.stack)}return null},onRequestPath:function(e){this.request_path_callback=e},onStartPathing:function(e){this.start_pathing_callback=e},onStopPathing:function(e){this.stop_pathing_callback=e},onAbortPathing:function(e){this.abort_pathing_callback=e},followPath:function(e){e&&(this.path=e,this.step=0,this.followingMode&&e.pop(),this.start_pathing_callback)&&this.start_pathing_callback(e)},continueTo:function(e,t){this.newDestination={x:e,y:t}},onAggro:function(e){this.aggro_callback=e},onCheckAggro:function(e){this.checkaggro_callback=e},checkAggro:function(){this.checkaggro_callback&&this.checkaggro_callback()},aggro:function(e){this.aggro_callback&&this.aggro_callback(e)},onDeath:function(e){this.death_callback=e},lookAt:function(e,t){return this.getOrientationTo({x:e,y:t})},go:function(e,t){this.isAttacking()?this.disengage():this.followingMode&&(this.followingMode=!1,this.target=null),this.moveTo_(e,t)},follow:function(e){e=this.getClosestSpot(e);e&&e.x&&e.y&&this.moveTo_(e.x,e.y)},getLastMove:function(){var e;return this.path?[(e=this.path[this.path.length-1])[0],e[1]]:null},getClosestSpot:function(e,t){var t=t||G_TILESIZE,i=[],e=[e.x,e.y],n=e[0],e=e[1],s=this.x,a=this.y,r=[[n+t,e],[n-t,e],[n,e+t],[n,e-t]];for(o of r)this.map.isColliding(o[0],o[1])&&r.splice(r.indexOf(o),1);this.neighboursUpdated||(this.closestNeighbours=this.map.entities.getCharactersAround({x:s,y:a},16),this.neighboursUpdated=!0);var o,l=G_TILESIZE>>1;for(o of r){var h,c,u,p,s=o[0],a=o[1];for(h of this.closestNeighbours)h&&this!=h&&(c=h.x,u=h.y,h.path&&0<h.path.length?(p=h.getLastMove())&&(c=p[0],u=p[1],Math.abs(s-c)<=l)&&Math.abs(a-u)<=l&&r.splice(r.indexOf(o),1):Math.abs(s-c)<=l&&Math.abs(a-u)<=l&&r.splice(r.indexOf(o),1))}if(0==r.length)return null;for(o of r){var m=[o[0],o[1]];i.push({d:d.realDistance([s,a],m),p:m})}return i.sort(function(e,t){return t.d-e.d}),{x:i[0].p[0],y:i[0].p[1]}},engage:function(e){this.attackingMode=!0,this.setTarget(e)},disengage:function(){this.attackingMode=!1,this.followingMode=!1,this.removeTarget()},isAttacking:function(){return this.attackingMode},getOrientationTo:function(e){return this.getOrientation([this.x,this.y],[e.x,e.y])},isAttackedBy:function(e){return 0!=Object.keys(this.attackers).length&&this.attackers.hasOwnProperty(e.id)&&this.attackers[e.id]===e},isAttacked:function(){return!(0==Object.keys(this.attackers).length)},addAttacker:function(e){this.isAttackedBy(e)||(this.attackers[e.id]=e)},removeAttacker:function(e){this.isAttacked()&&delete this.attackers[e.id]},removeAttackers:function(){this.attackers={}},clearAttackerRefs:function(){var t=this;this.forEachAttacker(function(e){e.removeAttacker(t)})},forEachAttacker:function(t){_.each(this.attackers,function(e){t(e)})},stopInPath:function(e,t){this.isMovingPath()&&this.map.entities.pathfinder.isInPath(this.path,[e,t])&&(this.setPosition(e,t),this.interrupted=!0,this.forceStop())},stop:function(){this.isMovingPath()&&(this.interrupted=!0,this.moving=!1)},forceStop:function(){this.movement.stop(),this.orientation=0,this.moveOrientation=0,this.isMovingPath()&&(this.interrupted&&this.abort_pathing_callback&&this.abort_pathing_callback(this.x,this.y),this.interrupted=!1,this.path=null,this.newDestination=null,this.isReadyToMove=!0,this.followingMode=!1)},forceStopMove:function(){console.info("character - forceStopMove - called"),this.movement.stop(),this.moveOrientation=0,this.freeze=!1,this.movestop_callback&&this.movestop_callback()},setMoveStopCallback:function(e){this.movestop_callback=e},removeTarget:function(){this.target&&(this.target instanceof Character&&this.target.removeAttacker(this),this.removetarget_callback&&this.removetarget_callback(this.target.id),this.target=null)},onRemoveTarget:function(e){this.removetarget_callback=e},hasTarget:function(){return!(null===this.target)},waitToAttack:function(e){this.unconfirmedTarget=e},isWaitingToAttack:function(e){return this.unconfirmedTarget===e},canAttack:function(){return!(0!=this.isDead||!this.attackCooldown.isOver())},canMove:function(){return!(0!=this.isDead||!this.moveCooldown.isOver())},onHasMoved:function(e){this.hasmoved_callback=e},hasMoved:function(){this.setDirty(),this.hasmoved_callback&&this.hasmoved_callback(this)},hurt:function(){this.stopHurting(),this.sprite=this.hurtSprite,this.hurting=setTimeout(this.stopHurting.bind(this),75)},stopHurting:function(){this.sprite=this.normalSprite,clearTimeout(this.hurting)},setAttackRate:function(e){this.attackCooldown=new r(e)},setMoveRate:function(e){this.moveSpeed=e,this.walkSpeed=~~(e/4),this.moveCooldown=new r(e),this.tick=Math.round(1e3/this.moveSpeed)},getState:function(){return this._getBaseState()},modHealthBy:function(e){var t=this.stats.hp,i=this.stats.hpMax;return this.stats.hp=d.clamp(0,i,t+e),this.changePoints(e,0)},modEnergyBy:function(e){var t=this.stats.ep,i=this.stats.epMax;return this.stats.ep=d.clamp(0,i,t+e),this.changePoints(0,e)},hasFullHealth:function(){return this.stats.hp===this.stats.hpMax},hasFullEnergy:function(){return this.stats.ep===this.stats.epMax},clearTarget:function(){this.target=null},changePoints:function(e,t){return new a.ChangePoints(this,e,t)},getPathIndex:function(e){return null===!this.path||0===this.path.length||e<0||e>=this.path.length?null:this.path[e]},isWithinPath:function(e){var t=null;if("Object"==typeof e&&0<e.x&&0<e.y?t=[e.x,e.y]:Array.isArray(e)&&2==e.length&&(t=[e[0],e[1]]),t&&null!==this.path&&0!==this.path.length)for(var i=this.path.length,n=0;n<i;++n)if(this.path[n][0]===t[0]&&this.path[n][1]===t[1])return{x:t[0],y:t[1],step:n};return null},clean:function(){this.forEachAttacker(function(e){e.disengage(),e.idle()})},updateMovement:function(){var e=this.path,t=this.step;!e||t>e.length-1||(this.x<e[t][0]?this.walk(l.Orientations.RIGHT):this.x>e[t][0]?this.walk(l.Orientations.LEFT):this.y<e[t][1]?this.walk(l.Orientations.DOWN):this.y>e[t][1]?this.walk(l.Orientations.UP):this.idle())},nextStepPath:function(){return 0==this.step&&(this.step++,this.updateMovement()),this.step<this.path.length&&this.x==this.path[this.step][0]&&this.y==this.path[this.step][1]&&(this.step++,this.updateMovement(),!0)},nextStep:function(){var e,t,i=!1,n=!1;return(i=this.isMovingPath()&&!this.freeze?i:this.interrupted=!0)||(n=this.nextStepPath(),this.step>=this.path.length&&(i=!0),this.step_callback&&this.step_callback(this.x,this.y)),this.hasChangedItsPath()?(this.setPosition(this.x,this.y),e=this.newDestination.x,t=this.newDestination.y,e=this.requestPathfindingTo(e,t),this.newDestination=null,this.followPath(e),!0):(i&&(this.stop_pathing_callback&&(this.stop_pathing_callback(this.x,this.y),this.forceStop()),n=!0),n)},onBeforeMove:function(e){this.before_move_callback=e},onBeforeStep:function(e){this.before_step_callback=e},onStep:function(e){this.step_callback=e},isMoving:function(){return this.movement.inProgress},isMovingPath:function(){return this.path&&0<this.path.length},hasNextStep:function(){return this.path&&this.path.length-1>this.step},hasChangedItsPath:function(){return!(null===this.newDestination)},isNear:function(e,t){var i=!1,n=Math.abs(this.x-e.x),e=Math.abs(this.y-e.y);return i=n<=t*G_TILESIZE&&e<=t*G_TILESIZE?!0:i},onRemove:function(e){this.remove_callback=e},lookAtEntity:function(e){return e&&(this.orientation=this.getOrientationTo(e)),this.orientation},getOrientation:function(e,t){var i=Math.abs(e[0]-t[0]),n=Math.abs(e[1]-t[1]);return n<i?e[0]>t[0]?l.Orientations.LEFT:l.Orientations.RIGHT:i<n?e[1]>t[1]?l.Orientations.UP:l.Orientations.DOWN:l.Orientations.NONE},setTarget:function(e){var t;null==e?this.removeTarget():this.target!==e?(this.hasTarget()&&this.removeTarget(),this.unconfirmedTarget=null,this.target=e,this.settarget_callback&&(t=this.target.spriteName,s.Kinds[e.kind])&&t&&this.settarget_callback(e,t,e.level)):console.info(e.id+" is already the target of "+this.id)},isInReach:function(e,t,i,n,s){var i=i||this.orientation,a=G_TILESIZE,s=s||a>>1,n=n||a+s,r=s,o=s;switch(i){case l.Orientations.UP:case l.Orientations.DOWN:o=n;break;case l.Orientations.LEFT:case l.Orientations.RIGHT:r=n;break;case l.Orientations.NONE:return!1}return Math.abs(this.x-e)<=r&&Math.abs(this.y-t)<=o},canReach:function(e){var t=G_TILESIZE;return this.attackRange===t?this.isInReach(e.x,e.y,this.orientation):this.attackRange>t&&this.isNear(e,this.attackRange)},dying:function(){this.isDead=!1,this.isDying=!0},die:function(){console.warn("CHARACTER DIED!!!!!!!!!!!!!!!!!!!!!"),this.removeTarget(),this.isDying=!0,this.isDead=!0,this.death_callback&&this.death_callback()},isOverlapping:function(){var e,t=this.map.entities.getCharactersAround(this,1);res=!1,ts=G_TILESIZE;for(e of t)if(e&&this!=e){var i=e.x,n=e.y;if(Math.abs(this.x-i)<ts&&Math.abs(this.y-n)<ts){res=!0;break}}return res},resetHP:function(){var e="function"==typeof this.getHPMax?this.getHPMax():this.stats.hpMax,t=(this.stats.hpMax=e)-this.stats.hp;this.stats.hp=e,msg=new a.ChangePoints(this,t,0),this.map.entities.pushNeighbours(this,msg)},resetEP:function(){var e="function"==typeof this.getEPMax?this.getEPMax():this.stats.epMax;this.stats.epMax=e,this.stats.ep=e},setHP:function(e){e=e||"function"==typeof this.getHPMax?this.getHPMax():this.stats.hpMax,this.stats.hp=e},setEP:function(e){e=e||"function"==typeof this.getEPMax?this.getEPMax():this.stats.epMax,this.stats.ep=e},isFacing:function(e,t){var i=this.x-e,n=this.y-t;switch(this.orientation){case 1:return 0<n;case 2:return n<0;case 3:return 0<i;case 4:return i<0}return!1},isFacingEntity:function(e){return this.isFacing(e.x,e.y)},nextTile:function(e,t){e=e||this.x,t=t||this.y;var i=G_TILESIZE;switch(this.orientation){case 1:return[e,t-i];case 2:return[e,t+i];case 3:return[e-i,t];case 4:return[e+i,t]}return[e,t]},onDamage:function(e,t,i,n,s){i=i||0,n=n||0,s=s||0,0<(t=t||0)&&this.addAttacker(e),0!=t&&(this.stats.hp=d.clamp(0,this.stats.hpMax,this.stats.hp-t)),0!=i&&(this.stats.ep=d.clamp(0,this.stats.epMax,this.stats.ep-i));t=new a.Damage([e,this,-t,-i,n,s]);this.map.entities.pushNeighbours(e,t)}}),t.exports=Character},{"../shared/js/gametypes":167,"./entitymoving":92,"./lib/class":104,"./message":111,"./mobdata":117,"./npcdata":121,"./timer":138,"./transition":140,"./utils":146}],86:[function(e,t,i){var n=e("./lib/class"),s=e("./utils"),e=n.Class.extend({init:function(e,t,i,n,s,a){this.map=e,this.id=t,this.x=16*i,this.y=16*n,this.width=16*s,this.height=16*a},getRandomPosition:function(){for(var e={},t=!0;t;)e.x=this.x+s.randomInt(this.width-1),e.y=this.y+s.randomInt(this.height-1),t=this.map.isColliding(e.x,e.y);return e},isValidPosition:function(e,t){return this.map&&_.isNumber(e)&&_.isNumber(t)&&!this.map.isOutOfBounds(e,t)&&!this.map.isColliding(e,t)}});t.exports=e},{"./lib/class":104,"./utils":146}],87:[function(e,t,i){e("underscore");var n=e("./item"),s=e("./items"),o=e("../shared/js/gametypes"),l=e("./utils"),e=n.extend({init:function(e,t,i,n,s,a,r){this._super(e,o.EntityTypes.CHEST,t,i),this.map=n,this.level=l.randomRangeInt(a,r),this.setDrops(),this.area=s,this.spawnDelay=3e4},handleRespawn:function(){this.droppedItem=!1,this.area&&this.area instanceof ChestArea&&this.area.respawnChest(this,this.spawnDelay)},setDrops:function(){this.drops={};var e,t=10*Math.ceil(this.level/10);for(e in s.Kinds){var i=s.Kinds[e];if(i){if("attack"==i.typemod||"defense"==i.typemod)switch(t){case i.modifier+10:this.drops[e]=20;break;case i.modifier:this.drops[e]=10;break;case i.modifier-10:this.drops[e]=5;break;case i.modifier-20:this.drops[e]=2}if("craft"==i.typemod)switch(t){case i.modifier+10:this.drops[e]=400;break;case i.modifier:this.drops[e]=200;break;case i.modifier-10:this.drops[e]=100;break;case i.modifier-20:this.drops[e]=50}}}}});t.exports=e},{"../shared/js/gametypes":167,"./item":98,"./items":101,"./utils":146,underscore:75}],88:[function(i,e,t){var n=i("./area"),s=(i("underscore"),i("./mobdata"),i("./message"));i("../shared/js/gametypes"),i("./utils");e.exports=ChestArea=n.extend({init:function(e,t,i,n,s,a,r,o,l,h){this._super(e,a,r,o,l,h),this.nb=i,this.minLevel=n,this.maxLevel=s,this.respawns=[],this.map=h,this.setNumberOfEntities(this.nb),this.chests=[37]},spawnChests:function(){for(var e=0;e<this.nb;e+=1)this.addToArea(this._createRandomChestInsideArea())},_createRandomChestInsideArea:function(){return this._createChest()},_createChest:function(){var e=this,t=e.map.entities.spaceEntityRandomApart(2,e._getRandomPositionInsideArea.bind(e,20)),t=new(i("./chest"))(++e.map.entities.entityCount+2e4,t.x,t.y,e.map,e,e.minLevel,e.maxLevel);return e.map.entities.addChest(t),e.addToArea(t),t},respawnChest:function(t,e){var i=this;e=t.spawnDelay||e,this.removeFromArea(t),setTimeout(function(){var e=i.map.entities.spaceEntityRandomApart(2,i._getRandomPositionInsideArea.bind(i,20));t.x=e.x,t.y=e.y,i.addToArea(t),i.map.entities.addChest(t),i.map.entities.pushBroadcast(new s.Spawn(t))},e)}}),e.exports=ChestArea},{"../shared/js/gametypes":167,"./area":80,"./chest":87,"./message":111,"./mobdata":117,"./utils":146,underscore:75}],89:[function(t,e,i){t("path");e.exports=function(e){return t("./redis")}},{"./redis":133,path:void 0}],90:[function(e,t,i){e("underscore");var n=e("./lib/class"),o=e("./utils"),s=e("./skilldata"),a=(e("../shared/js/gametypes"),EffectType=n.Class.extend({init:function(e,t,i,n){this.entity=null,this.isTarget=e,this.phase=t,this.stat=i,this.modValue=n||0,this.active=!1},apply:function(e,t,i,n){if(this.phase==i&&t!=this.isTarget){var s=0,a=0,r=0;switch(this.stat){case SkillEffects.EffectStat.HP:s=e.stats.hp,r=a=e.stats.hpMax;break;case SkillEffects.EffectStat.EP:s=e.stats.ep,r=a=e.stats.epMax;break;case SkillEffects.EffectStat.ATTACK:a=s=e.stats.attack;break;case SkillEffects.EffectStat.DEFENSE:a=s=e.stats.defense}switch(0<n&&this.stat===SkillEffects.EffectStat.DAMAGE&&(s=e.stats.hp,a=n,r=e.stats.hpMax),0<s&&0<a&&this.getModDiff(s,a,r),this.stat){case SkillEffects.EffectStat.HP:e.stats.hp+=this.diff,o.clamp(0,e.stats.hpMax,e.stats.hp);break;case SkillEffects.EffectStat.EP:e.stats.ep+=this.diff,o.clamp(0,e.stats.epMax,e.stats.ep);break;case SkillEffects.EffectStat.ATTACK:e.stats.mod.attack=this.diff;break;case SkillEffects.EffectStat.DEFENSE:e.stats.mod.defense=this.diff;break;case SkillEffects.EffectStat.DAMAGE:e.stats.mod.damage=this.diff;case SkillEffects.EffectStat.FREEZE:1==this.modVal?e.freeze=!0:e.freeze=!1;break;case SkillEffects.EffectStat.MOVESPEED:e.moveSpeed+=this.modVal}}},getModDiff:function(e,t,i){var n=this.modValue*this.level,t=n=effectType.modValue<1?~~(t*this.modValue*this.level):n;return e+=n,0<i&&i<e&&(t-=e-i),e<0&&(t=e),this.diff=t}}),n.Class.extend({init:function(e,t,i){this.source,this.skillId=t,this.data=s.Skills[t],console.info("SkillEffect - skillId:"+t),this.targetType=this.data.targetType,this.activeTimer=0,this.duration=(this.data.durationPL?this.data.durationPL*this.level:this.data.duration)||0,this.duration*=1e3,this.countTotal=this.data.total||0,this.count=0,this.effectTypes=this.data.effectTypes,this.level=i,this.isActve=!1,this.interval=null,this.targets=[]},getTargets:function(e,t,i){switch(this.targetType){case SkillEffects.TargetType.SELF:return[this.source];case SkillEffects.TargetType.ENEMY:return[this.source,e];case SkillEffects.TargetType.PLAYER_AOE:return(n=e.maps.entities.getPlayerAround(e,this.data.aoe)).unshift(this.source),n;case SkillEffects.TargetType.ENEMY_AOE:var n;return(n=e.maps.entities.getMobsAround(e,this.data.aoe)).unshift(this.source,this.target),n}return[]},apply:function(e,t,i){var n=this;0<this.duration&&(this.activeTimer=0,this.interval&&(clearInterval(this.interval),this.interval=null),this.interval=setInterval(function(){n.activeTimer>n.duration?(n.applyEffects(1,0),n.isActive=!1,clearInterval(n.interval),n.interval=null):(n.applyEffects(2,0),n.activeTimer+=1e3)},1e3)),0<this.countTotal&&(this.count=0),this.targets=this.getTargets(e,t,i),this.isActive=!0,this.applyEffects(0,0)},applyEffects:function(e,t){for(var i of this.targets)for(var n in this.effectTypes)this.isActive&&n.apply(i,this.source!=i,e,t)},onInterval:function(e,t){0<this.countTotal&&this.count==this.countTotal?(this.applyEffects(1,0),this.isActive=!1):(this.applyEffects(e,t),0<this.countTotal&&5==e&&this.count++)}})),e=n.Class.extend({init:function(e){this.entity=e,this.skillEffects=[];for(var t of this.entity.skills)this.skillEffects.push(new a(this.entity,t.skillIndex,t.skillLevel))},interval:function(e,t){t=t||0;for(var i of this.skillEffects)i.onInterval(e,t)},cast:function(e,t,i,n){this.skillEffects[e].apply(t,i,n)}});t.exports=EffectType,t.exports=a,t.exports=e},{"../shared/js/gametypes":167,"./lib/class":104,"./skilldata":135,"./utils":146,underscore:75}],91:[function(e,t,i){var n=e("./lib/class"),s=e("./message"),o=e("./utils");e("./timer");t.exports=Entity=n.Class.extend({init:function(e,t,i,n,s,a){this.type=t,this.id=e,this.kind=i,this.map=a,this.mapIndex=a.index,this.shadowOffsetY=0,this.isLoaded=!1,this.isHighlighted=!1,this.visible=!0,this.isFading=!1,this.prevX=0,this.prevY=0,this.prevOrientation=null,this.name="",this.nameOffsetY=-10,this.isCritical=!1,this.isHeal=!1,this.shadowOffsetY=0,this.setPosition(Number(n),Number(s)),this.orientation=o.randomOrientation()},setName:function(e){this.name=e},setPosition:function(e,t){var i=G_TILESIZE,n=(this.x=e)>>4,s=(this.y=t)>>4,e=(void 0===this.gx&&(this.gx=n),void 0===this.gy&&(this.gy=s),e%i==0&&(this.gx=n),t%i==0&&(this.gy=s),~~(n/G_SPATIAL_SIZE)),t=~~(s/G_SPATIAL_SIZE);this.hasOwnProperty("sx")||(this.spx=e),this.hasOwnProperty("sy")||(this.spy=t),this.spatialMapid==this.map.id&&this.map.entities.spatial[this.spy][this.spx].hasOwnProperty(this.id)&&(this.map.entities.spatial[this.spy][this.spx][this.id]=null),(this.map.entities.spatial[t][e][this.id]=this).spx=e,this.spy=t,this.spatialMapId=this.map.id},ready:function(e){this.ready_func=e},clean:function(){},log_info:function(e){console.info("["+this.id+"] "+e)},log_error:function(e){console.error("["+this.id+"] "+e)},getDistanceToEntity:function(e){var t=Math.abs(e.x-this.x),e=Math.abs(e.y-this.y);return e<t?t:e},isAdjacent:function(e){var t=!1;return t=e?!(1<this.getDistanceToEntity(e)):t},isAdjacentNonDiagonal:function(e){var t=!1;return t=!this.isAdjacent(e)||this.x!==e.x&&this.y!==e.y?t:!0},isDiagonallyAdjacent:function(e){return this.isAdjacent(e)&&!this.isAdjacentNonDiagonal(e)},forEachAdjacentNonDiagonalPosition:function(e){e(this.x-1,this.y,Types.Orientations.LEFT),e(this.x,this.y-1,Types.Orientations.UP),e(this.x+1,this.y,Types.Orientations.RIGHT),e(this.x,this.y+1,Types.Orientations.DOWN)},_getBaseState:function(){return[parseInt(this.id,10),parseInt(this.type),parseInt(this.kind),this.name,parseInt(this.map.index),parseInt(this.x),parseInt(this.y),parseInt(this.orientation||0)]},getMapIndex:function(){return this.map.index},getState:function(){return this._getBaseState()},spawn:function(){return new s.Spawn(this)},despawn:function(){return new s.Despawn(this)},getPositionNextTo:function(e){var t,i=null;return e&&(i={},t=o.random(4),i.x=e.x,i.y=e.y,0===t&&(i.y-=16),1===t&&(i.y+=16),2===t&&(i.x-=16),3===t)&&(i.x+=16),i},setRandomOrientation:function(){0===(r=o.random(4))&&(this.orientation=Types.Orientations.LEFT),1===r&&(this.orientation=Types.Orientations.RIGHT),2===r&&(this.orientation=Types.Orientations.UP),3===r&&(this.orientation=Types.Orientations.DOWN)},isNextTooEntity:function(e){return this.isNextToo(e.x,e.y)},isNextToo:function(e,t,i){i=i||this.orientation,i=G_TILESIZE;return Math.abs(this.x-e)<=i&&Math.abs(this.y-t)<=i},isWithin:function(e){return Math.abs(e.x-this.x)<G_TILESIZE>>1&&Math.abs(e.y-this.y)<G_TILESIZE>>1},isTouching:function(e){return Math.abs(e.x-this.x)<G_TILESIZE&&Math.abs(e.y-this.y)<G_TILESIZE},destroy:function(){}}),t.exports=Entity},{"./lib/class":104,"./message":111,"./timer":138,"./utils":146}],92:[function(e,t,i){e("./lib/class");var n=e("./entity"),r=(e("./message"),e("./utils")),s=e("./timer"),l=e("../shared/js/gametypes"),o=e("./transition");t.exports=EntityMoving=n.extend({init:function(e,t,i,n,s,a){this._super(e,t,i,n,s,a),this.nextX=-1,this.nextY=-1,this.prevX=-1,this.prevY=-1,this.moveSpeed=100,this.setMoveRate(this.moveSpeed),this.walkSpeed=150,this.idleSpeed=r.randomInt(750,1e3),this.followingMode=!1,this.engagingPC=!1,this.step=0,this.orientation=this.setRandomOrientation(),this.movement=new o,this.path=null,this.newDestination=null,this.adjacentTiles={},this.moveCooldown=null,this.freeze=!1},setOrientation:function(e){e&&(this.orientation=e||0)},idle:function(e){this.setOrientation(e)},walk:function(e){this.setOrientation(e)},moveTo_:function(e,t,i){this.destination={x:e,y:t},this.adjacentTiles={},this.isMovingPath()?this.continueTo(e,t):(e=this.requestPathfindingTo(e,t))&&this.followPath(e)},requestPathfindingTo:function(e,t){if(Array.isArray(this.path)&&0<this.path.length)return this.path;if(this.request_path_callback)return this.request_path_callback(e,t);console.info(this.id+" couldn't request pathfinding to "+e+", "+t),console.info("char x:"+this.x+",y: "+this.y+", x:"+e+"y: "+t);try{throw new Error}catch(e){console.info(e.stack)}return null},onRequestPath:function(e){this.request_path_callback=e},onStartPathing:function(e){this.start_pathing_callback=e},onStopPathing:function(e){this.stop_pathing_callback=e},onAbortPathing:function(e){this.abort_pathing_callback=e},followPath:function(e){e&&(this.path=e,this.step=0,this.followingMode&&e.pop(),this.start_pathing_callback)&&this.start_pathing_callback(e)},continueTo:function(e,t){this.newDestination={x:e,y:t}},lookAt:function(e,t){return this.getOrientationTo([e,t])},go:function(e,t){this.isAttacking()?this.disengage():this.followingMode&&(this.followingMode=!1,this.target=null),this.moveTo_(e,t)},follow:function(e){e=this.getClosestSpot(e);e&&e.x&&e.y&&this.moveTo_(e.x,e.y)},getLastMove:function(){var e;return this.path?[(e=this.path[this.path.length-1])[0],e[1]]:null},getOrientationTo:function(e){return this.getOrientation([this.x,this.y],[e.x,e.y])},stopInPath:function(e,t){this.isMovingPath()&&this.map.entities.pathfinder.isInPath(this.path,[e,t])&&(this.setPosition(e,t),this.interrupted=!0,this.forceStop())},stop:function(){this.isMovingPath()&&(this.interrupted=!0,this.moving=!1)},forceStop:function(){this.movement.stop(),this.orientation=0,this.moveOrientation=0,this.isMovingPath()&&(this.interrupted&&this.abort_pathing_callback&&this.abort_pathing_callback(this.x,this.y),this.interrupted=!1,this.path=null,this.newDestination=null,this.isReadyToMove=!0,this.followingMode=!1)},forceStopMove:function(){console.info("character - forceStopMove - called"),this.movement.stop(),this.moveOrientation=0,this.freeze=!1,this.movestop_callback&&this.movestop_callback()},setMoveStopCallback:function(e){this.movestop_callback=e},canMove:function(){return!(0!=this.isDead||!this.moveCooldown.isOver())},onHasMoved:function(e){this.hasmoved_callback=e},hasMoved:function(){this.setDirty(),this.hasmoved_callback&&this.hasmoved_callback(this)},setMoveRate:function(e){this.moveSpeed=e,this.walkSpeed=~~(e/4),this.moveCooldown=new s(e),this.tick=Math.round(1e3/this.moveSpeed)},getState:function(){return this._getBaseState()},setFreeze:function(e,t){var i=this;e<=0?i.freeze=!1:(this.freeze=!0,this.freeze_callback=setTimeout(function(){i.freeze=!1,t&&t(i)},e))},getPathIndex:function(e){return null===!this.path||0===this.path.length||e<0||e>=this.path.length?null:this.path[e]},isWithinPath:function(e){var t=null;if("Object"==typeof e&&0<e.x&&0<e.y?t=[e.x,e.y]:Array.isArray(e)&&2==e.length&&(t=[e[0],e[1]]),t&&null!==this.path&&0!==this.path.length)for(var i=this.path.length,n=0;n<i;++n)if(this.path[n][0]===t[0]&&this.path[n][1]===t[1])return{x:t[0],y:t[1],step:n};return null},updateMovement:function(){var e=this.path,t=this.step;!e||t>e.length-1||(this.x<e[t][0]?this.walk(l.Orientations.RIGHT):this.x>e[t][0]?this.walk(l.Orientations.LEFT):this.y<e[t][1]?this.walk(l.Orientations.DOWN):this.y>e[t][1]?this.walk(l.Orientations.UP):this.idle())},nextStepPath:function(){return 0==this.step&&(this.step++,this.updateMovement()),this.step<this.path.length&&this.x==this.path[this.step][0]&&this.y==this.path[this.step][1]&&(this.step++,this.updateMovement(),!0)},nextStep:function(){var e,t,i=!1,n=!1;return(i=this.isMovingPath()&&!this.freeze?i:this.interrupted=!0)||(n=this.nextStepPath(),this.step>=this.path.length&&(i=!0),this.step_callback&&this.step_callback()),this.hasChangedItsPath()?(this.setPosition(this.x,this.y),e=this.newDestination.x,t=this.newDestination.y,e=this.requestPathfindingTo(e,t),this.newDestination=null,this.followPath(e),!0):(i&&(this.stop_pathing_callback&&(this.stop_pathing_callback(this.x,this.y),this.forceStop()),n=!0),n)},onBeforeMove:function(e){this.before_move_callback=e},onBeforeStep:function(e){this.before_step_callback=e},onStep:function(e){this.step_callback=e},isMoving:function(){return this.movement.inProgress},isMovingPath:function(){return this.path&&0<this.path.length},hasNextStep:function(){return this.path&&this.path.length-1>this.step},hasChangedItsPath:function(){return!(null===this.newDestination)},isNear:function(e,t){var i=!1,n=Math.abs(this.x-e.x),e=Math.abs(this.y-e.y);return i=n<=t*G_TILESIZE&&e<=t*G_TILESIZE?!0:i},onRemove:function(e){this.remove_callback=e},lookAtEntity:function(e){return e&&(this.orientation=this.getOrientationTo(e)),this.orientation},getOrientation:function(e,t){var i=Math.abs(e[0]-t[0]),n=Math.abs(e[1]-t[1]);return n<i?e[0]>t[0]?l.Orientations.LEFT:l.Orientations.RIGHT:i<n?e[1]>t[1]?l.Orientations.UP:l.Orientations.DOWN:l.Orientations.NONE},isInReach:function(e,t,i,n,s){var i=i||this.orientation,a=G_TILESIZE,s=s||a>>1,n=n||a+s,r=s,o=s;switch(i){case l.Orientations.UP:case l.Orientations.DOWN:o=n;break;case l.Orientations.LEFT:case l.Orientations.RIGHT:r=n;break;case l.Orientations.NONE:return!1}return Math.abs(this.x-e)<=r&&Math.abs(this.y-t)<=o},isOverlapping:function(){var e,t=this.map.entities.getCharactersAround(this,1);res=!1,ts=G_TILESIZE;for(e of t)if(e&&this!=e){var i=e.x,n=e.y;if(Math.abs(this.x-i)<ts&&Math.abs(this.y-n)<ts){res=!0;break}}return res}}),t.exports=EntityMoving},{"../shared/js/gametypes":167,"./entity":91,"./lib/class":104,"./message":111,"./timer":138,"./transition":140,"./utils":146}],93:[function(e,t,i){var n=e("underscore"),s=e("../shared/data/entity_spawn.json"),a=e("fs"),r=[],o=0;n.each(s,function(e,t){r[o++]=e});t.exports.EntitySpawnData=r,t.exports.addSpawn=function(e,t,i){r.push({id:e,x:t,y:i})},t.exports.saveSpawns=function(){a.writeFile("./shared/data/entity_spawn.json",JSON.stringify(r),function(e,t){if(e)return console.info(e)})}},{"../shared/data/entity_spawn.json":152,fs:void 0,underscore:75}],94:[function(e,t,i){var n=e("./lib/class"),s=(e("./itemroom"),e("./message")),a=e("../shared/js/itemtypes"),r=(e("../shared/js/gametypes"),e("./items"));t.exports=Equipment=n.Class.extend({init:function(e,t,i){if(this.owner=e,this.number=t,this.maxNumber=5,this.weaponSlot=4,this.rooms={},console.info("number="+t),console.info("itemSlots="+JSON.stringify(i)),i)for(var n=0;n<i.length;n++){var s=i[n].slot;this.rooms[s]=i[n]}},makeEmptyItem:function(e){this.rooms[e]=null,delete this.rooms[e],this.setItem(e,null)},getItemIndex:function(e){for(var t in this.rooms)if(this.rooms[t]&&this.rooms[t].itemKind==e)return t;return-1},combineItem:function(e,t){return-1},checkItem:function(e,t){var i,n;return!(t&&(i=t.itemKind,n=r.Kinds[i],!a.isEquipment(i)||!(0!=e||"helm"===n.type&&this.canEquip(t,n.level))||!((1!=e||"chest"===n.type&&this.canEquip(t,n.level))&&(2!=e||"gloves"===n.type&&this.canEquip(t,n.level))&&(3!=e||"boots"===n.type&&this.canEquip(t,n.level))&&(4!=e||a.isWeapon(i)&&this.canEquip(t,a.getWeaponLevel(i))))))},setItem:function(e,t){var i=this.owner;if(t){if(!this.checkItem(e,t))return!1;((this.rooms[e]=t).slot=e)==this.weaponSlot&&(i.setRange(),i.map.entities.pushNeighbours(i,new s.Looks(i)))}else this.rooms[e]=null,t={slot:e,itemKind:-1},e==this.weaponSlot&&i.map.entities.pushNeighbours(i,new s.Looks(i));return i.map.entities.pushToPlayer(i,new s.ItemSlot(2,[t])),!0},canEquip:function(e,t){var i=this.owner;e.itemKind;return!(t>i.level.base&&(i.map.entities.pushToPlayer(i,new s.Notify("EQUIP","EQUIPMENT_LEVEL",[t])),1))},save:function(){databaseHandler.saveItems(this.owner,2,this.rooms)},degradeItem:function(e,t){var i=this.rooms[e];if(i)return i.itemDurability-=t,i.itemDurability=Math.max(0,i.itemDurability),!(0==i.itemDurability&&i.itemDurabilityMax<=30&&(this.makeEmptyEquipment(e),1))},addExperience:function(e,t){var i=this.rooms[e];i&&(i.itemExperience+=t,i.itemNumber<a.getItemLevel(i.itemExperience)&&(i.itemNumber++,this.owner.map.entities.pushToPlayer(this.owner,new s.ItemLevelUp(e,i))),i.slot=e,this.owner.map.entities.pushToPlayer(this.owner,new s.ItemSlot(2,[i])))},toString:function(){for(var e=0,t=this.maxNumber+",",e=0;e<this.maxNumber;e++){var i=this.rooms[e];t+=(itemArray=[i.itemKind,i.itemNumber,i.itemDurability,i.itemDurabilityMax,i.itemExperience]).join(",")}return t},toStringJSON:function(){for(var e="[",t=!1,i=0;i<this.maxNumber;i++){var n=this.rooms[i];n&&(e+="["+(itemArray=[i,n.itemKind,n.itemNumber,n.itemDurability,n.itemDurabilityMax,n.itemExperience]).join(",")+"],",t=!0)}return e=e.slice(0,-1),e+="]",t?e:"[]"}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./itemroom":100,"./items":101,"./lib/class":104,"./message":111}],95:[function(e,t,i){var l=e("underscore"),h=e("../shared/js/gametypes");e=new(FormatChecker=Class.extend({init:function(){this.formats=[],this.usernameMax=16,this.playerMax=16,this.dateMin=167e10,this.dateMax=2e12,this.hashLen=120,this.entityIdMax=99999,this.coordMax=16384,this.bankMax=47,this.inventoryMax=47,this.goldMax=99999999,this.gemMax=9999,this.itemCountMax=100,this.itemKindMax=999,this.questMax=999,this.formats[h.Messages.BI_SYNCTIME]=[["n",this.dateMin,this.dateMax]],this.formats[h.Messages.CS_CREATE_USER]=[["s",2,this.usernameMax],["s",this.hashLen,this.hashLen]],this.formats[h.Messages.CS_LOGIN_USER]=[["s",2,this.usernameMax],["s",this.hashLen,this.hashLen]],this.formats[h.Messages.CS_CREATE_PLAYER]=[["n",0,9],["s",2,this.playerMax]],this.formats[h.Messages.CS_LOGIN_PLAYER]=[["n",0,9],["n",0,16]],this.formats[h.Messages.CS_APPEARANCEUNLOCK]=[["n",-1,255],["n",0,this.gemMax]],this.formats[h.Messages.CS_ATTACK]=[["n",this.dateMin,this.dateMax],["n",0,this.entityIdMax],["n",0,4],["n",-1,50]],this.formats[h.Messages.CS_AUCTIONBUY]=[["n",0,1e3],["n",0,3]],this.formats[h.Messages.CS_AUCTIONDELETE]=[["n",0,1e3],["n",0,3]],this.formats[h.Messages.CS_AUCTIONOPEN]=[["n",0,3]],this.formats[h.Messages.CS_AUCTIONSELL]=[["n",0,this.inventoryMax],["n",0,this.goldMax]],this.formats[h.Messages.CS_BANKRETRIEVE]=[["n",0,this.bankMax]],this.formats[h.Messages.CS_BANKSTORE]=[["n",0,this.inventoryMax]],this.formats[h.Messages.CS_CHAT]=[["s",1,256]],this.formats[h.Messages.CS_COLOR_TINT]=[["n",0,1],["s",6,6]],this.formats[h.Messages.BI_BLOCK_MODIFY]=[["n",0,1],["n",0,this.entityIdMax],["n",0,this.coordMax],["n",0,this.coordMax]],this.formats[h.Messages.CS_INVENTORY]=[["n",0,3],["n",-1,1],["n",-1,this.inventoryMax],["n",0,1]],this.formats[h.Messages.CS_LOADLOOKS]=[],this.formats[h.Messages.CS_LOOKUPDATE]=[["n",0,1],["n",0,999]],this.formats[h.Messages.CS_LOOT]=[["n",0,this.entityIdMax],["n",0,this.coordMax],["n",0,this.coordMax]],this.formats[h.Messages.CS_MOVE]=[["n",this.dateMin,this.dateMax],["n",0,this.entityIdMax],["n",0,2],["n",0,4],["n",0,this.coordMax],["n",0,this.coordMax]],this.formats[h.Messages.CS_PLAYER_REVIVE]=[],this.formats[h.Messages.BI_SEND_BANK]=[],this.formats[h.Messages.BI_SEND_INVENTORY]=[],this.formats[h.Messages.CS_GOLD]=[["n",0,1],["n",0,this.goldMax],["n",0,1]],this.formats[h.Messages.CS_STATADD]=[["n",1,5],["n",1,1]],this.formats[h.Messages.CS_STOREBUY]=[["n",1,3],["n",0,this.itemKindMax],["n",0,10]],this.formats[h.Messages.CS_CRAFT]=[["n",0,this.itemKindMax],["n",0,10]],this.formats[h.Messages.CS_STOREENCHANT]=[["n",0,2],["n",0,this.inventoryMax]],this.formats[h.Messages.CS_STOREREPAIR]=[["n",0,2],["n",0,this.inventoryMax]],this.formats[h.Messages.CS_STORESELL]=[["n",0,2],["n",0,this.inventoryMax]],this.formats[h.Messages.CS_TALKTONPC]=[["n",5,6],["n",0,this.entityIdMax]],this.formats[h.Messages.CS_TELEPORT_MAP]=[["n",0,9],["n",0,1],["n",-1,this.coordMax],["n",-1,this.coordMax]],this.formats[h.Messages.CS_SKILL]=[["n",0,50],["n",0,this.entityIdMax]],this.formats[h.Messages.CS_SKILLINSTALL]=[["n",0,6],["n",0,50]],this.formats[h.Messages.CS_PARTY]=[["n",0,4],["so",0,this.playerMax],["no",0,3]],this.formats[h.Messages.BI_PLAYERINFO]=[],this.formats[h.Messages.BI_HARVEST]=[["n",0,this.coordMax],["n",0,this.coordMax]],this.formats[h.Messages.CS_USE_NODE]=[["n",0,this.entityIdMax]],this.formats[h.Messages.CS_QUEST]=[["n",0,this.entityIdMax],["n",0,this.questMax],["n",0,2]]},checkFormat:function(e,t,i,n){n=n||!1;if(i=i||this.formats[e]){if(!n&&t.length!==i.length)return!1;for(var s=0,a=i.length;s<a;s+=1){var r=i[s],o=t[s];if(Array.isArray(r)){if("n"===r[0]&&(!l.isNumber(o)||o<r[1]||o>r[2]))return!1;if("s"===r[0]&&(!l.isString(o)||o.length<r[1]||o.length>r[2]))return!1}else{if("n"===r&&!l.isNumber(o))return!1;if("s"===r&&!l.isString(o))return!1}}return!0}return console.error("Unknown message type: "+e),!1},check:function(e){var t=e.slice(0),i=t.shift(),n=n||this.formats[i];if(this.formats[i])return this.checkFormat(i,t,this.formats[i],!1);if(i===h.Messages.CS_MOVEPATH){var n=[["n",this.dateMin,this.dateMax],["n",0,this.entityIdMax],["n",0,4],["n",0,1]];if(!this.checkFormat(i,t,n,!0))return!1;var s,a=t.splice(n.length,t.length);if(!a)return!1;if(a.length<2||16<a.length)return!1;for(s of a){if(!Array.isArray(s)||2!=s.length)return!1;for(var r,o=0;o<2;++o)if(r=s[o],!l.isNumber(r)||r<0||r>this.coordMax)return!1}return!0}if(i===h.Messages.CS_WHO){try{JSON.parse(t)}catch(e){return!1}return 0<t.length&&l.all(t,function(e){return l.isNumber(e)&&0<e&&e<99999})}if(i===h.Messages.CS_ITEMSLOT)return i=(t=e.slice(0)).shift(),n=[["n",0,3],["n",0,2],["n",-1,this.inventoryMax],["n",0,this.itemCountMax]],7==t.length&&(n=n.concat([["n",0,2],["n",-1,this.inventoryMax],["n",0,this.itemCountMax]])),this.checkFormat(i,t,n,!0);try{throw new Error}catch(e){console.info(e.stack)}return console.error("Unknown message type: "+i),console.warn("message="+t),!1}})),i.check=e.check.bind(e)},{"../shared/js/gametypes":167,underscore:75}],96:[function(e,t,i){var s=e("./utils"),e=(e("../shared/js/itemtypes"),{crit:function(e,t){return s.randomRangeInt(0,200)<=s.clamp(5,195,~~(25+e.baseCrit()-t.baseCritDef()))},dmg:function(e,t,i){var n=1,i=(e.attackTimer&&(n=s.clamp(ATTACK_INTERVAL,ATTACK_MAX,i-e.attackTimer)/ATTACK_INTERVAL),console.info("attacker baseDamage="+e.baseDamage()),console.info("defender baseDamageDef="+t.baseDamageDef()),~~(e.baseDamage()*n)),i=s.clamp(1,5e3,~~(i-t.baseDamageDef()));return e instanceof Player&&0<i&&e.incAttackExp(i),t instanceof Player&&0<i&&t.incDefenseExp(i),~~i},pickPocket:function(e,t,i){return t.level-e.level+~~s.randomRange(0,100)<=i},mindControl:function(e,t){return t.level<=e.level&&0==~~s.randomRange(0,~~(50*t.level/e.level))},hp:function(e){return 100+40*e},energy:function(e){return 100+30*e},getExpArray:function(){}});void 0!==i&&(t.exports=e)},{"../shared/js/itemtypes":168,"./utils":146}],97:[function(e,t,i){var n=e("./lib/class"),s=(e("./itemroom"),e("./message")),a=e("../shared/js/itemtypes");e("../shared/js/gametypes");t.exports=Inventory=n.Class.extend({init:function(e,t,i){if(this.owner=e,this.number=t,this.maxNumber=48,this.maxStack=100,this.rooms={},console.info("number="+t),i)for(var n=0;n<i.length;n++)this.rooms[i[n].slot]=i[n]},hasItem:function(e){return this.hasItems(e,1)},hasItems:function(e,t){var i,n=0;for(i in this.rooms)if(this.rooms[i]&&this.rooms[i].itemKind===e&&t<=(n+=this.rooms[i].itemNumber))return!0;return!1},hasItemCount:function(e){var t,i=0;for(t in this.rooms)this.rooms[t]&&this.rooms[t].itemKind===e&&(i+=this.rooms[t].itemNumber);return i},hasRoomConsumable:function(){return this.hasRoom(0,6)},hasRoom:function(e,t){t=t||this.maxNumber;for(var i=e=void 0===e?6:e;i<t;i++)if(!this.rooms[i])return!0;return!1},makeEmptyItem:function(e){this.rooms[e]=null,delete this.rooms[e],this.setItem(e,null)},getItemCount:function(e){for(var t in this.rooms)if(this.rooms[t]&&this.rooms[t].itemKind==e)return this.rooms[t].itemNumber;return 0},getItemIndex:function(e){for(var t in this.rooms)if(this.rooms[t]&&this.rooms[t].itemKind==e)return t;return-1},getEmptyIndex:function(e,t){t=t||this.maxNumber;for(var i=e=void 0===e?6:e;i<t;i++)if(!this.rooms[i])return i;return-1},putItem:function(e){var t=a.isConsumableItem(e.itemKind),i=a.isLootItem(e.itemKind),n=a.isCraftItem(e.itemKind);if(t||i||n)for(var s in this.rooms){s=this.combineItem(e,this.rooms[s]);if(0<=s)return s}return this._putItem(e)},combineItem:function(e,t){var i,n;return console.info(JSON.stringify(e)),console.info(JSON.stringify(t)),!e||!t||e.itemKind!=t.itemKind||a.isEquippable(e.itemKind)||a.isEquippable(t.itemKind)?-1:(i=e.slot,n=t.slot,t.itemNumber<this.maxStack&&(t.itemNumber+=e.itemNumber,t.itemNumber>this.maxStack?(e.itemNumber=t.itemNumber-this.maxStack,t.itemNumber=Math.min(t.itemNumber,this.maxStack)):e=null),t.itemNumber<=0&&(t=null),this.setItem(i,e),this.setItem(n,t),n)},_putItem:function(e){var t=0,i=48;return a.isConsumableItem(e.itemKind)?i=6:t=6,(t=this.getEmptyIndex(t,i))<0?(this.owner instanceof Player&&this.owner.map.entities.pushToPlayer(this.owner,new s.Notify("INVENTORY","INVENTORY_FULL")),-1):(this.setItem(t,e),t)},checkItem:function(e,t){return!t||!(e<6&&!a.isConsumableItem(t.itemKind))},setItem:function(e,t){if(t){if(!this.checkItem(e,t))return!1;(this.rooms[e]=t).slot=e}else this.rooms[e]=null,t={slot:e,itemKind:-1};return this.owner.map.entities.pushToPlayer(this.owner,new s.ItemSlot(0,[t])),!0},save:function(){databaseHandler.saveItems(this.owner,0,this.rooms)},removeItemKind:function(e,t){var i,n=t;for(i in this.rooms){var s=this.rooms[i];if(s&&s.itemKind==e){if(s.itemNumber>n)return s.itemNumber-=n,this.setItem(i,s),!0;n-=s.itemNumber,this.setItem(i,s=null)}}return!1},takeOutItems:function(e,t){var i=this.rooms[e];return!i||t>i.itemNumber?null:(a.isEquippable(i.itemKind)?this.setItem(e,null):(i.itemNumber-=t,0==i.itemNumber&&(i=null),this.setItem(e,i)),i)},getRandomItemNumber:function(){for(var e,t,i=0,n=this.rooms.length;i<n;){if(e=~~Utils.randomRange(0,n-1),(t=this.rooms[e])&&0<t.itemKind)return e;++i}return-1},toString:function(){for(var e=0,t=this.maxNumber+",",e=0;e<this.maxNumber;e++){var i=this.rooms[e];i&&(t+=(itemArray=[i.itemKind,i.itemNumber,i.itemDurability,i.itemDurabilityMax,i.itemExperience]).join(","))}return t},toStringJSON:function(){for(var e="[",t=!1,i=0;i<this.maxNumber;i++){var n=this.rooms[i];n&&(e+="["+(itemArray=[i,n.itemKind,n.itemNumber,n.itemDurability,n.itemDurabilityMax,n.itemExperience]).join(",")+"],",t=!0)}return e=e.slice(0,-1),e+="]",t?e:"[]"}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./itemroom":100,"./lib/class":104,"./message":111}],98:[function(e,t,i){var n=e("./entity"),o=(e("../shared/js/itemtypes"),e("./items"));t.exports=Item=n.extend({init:function(e,t,i,n,s,a){var r=i.itemKind;this._super(t,e,r,n,s,a),this.isStatic=!1,this.isFromChest=!1,this.orientation=Types.Orientations.DOWN,this.experience=0,this.data=o.Kinds[r],this.room=i},handleDespawn:function(e){var t=this;this.blinkTimeout=setTimeout(function(){e.blinkCallback(),t.despawnTimeout=setTimeout(e.despawnCallback,e.blinkingDuration)},e.beforeBlinkDelay)},destroy:function(){this.blinkTimeout&&clearTimeout(this.blinkTimeout),this.despawnTimeout&&clearTimeout(this.despawnTimeout),this.isStatic&&this.scheduleRespawn(3e4)},scheduleRespawn:function(e){var t=this;setTimeout(function(){t.respawnCallback&&t.respawnCallback()},e)},onRespawn:function(e){this.respawnCallback=e},getState:function(){return[parseInt(this.id,10),parseInt(this.type),parseInt(this.room.itemKind),this.data&&this.data.hasOwnProperty("name")?this.data.name:"",parseInt(this.map.index),parseInt(this.x),parseInt(this.y),parseInt(this.orientation),parseInt(this.room.itemNumber)]},getName:function(){return this.data.name},toString:function(){return this.room.itemKind+" "+this.room.itemNumber+" "+this.room.itemDurability+" "+this.room.itemDurabilityMax+" "+this.room.itemExperience+" "+this.x+" "+this.y}})},{"../shared/js/itemtypes":168,"./entity":91,"./items":101}],99:[function(e,t,i){var n=e("underscore"),e=e("../shared/data/itemloot.json"),s=[];n.each(e,function(e,t){s[t]={name:e.name,rarity:e.rarity,sprite:e.sprite,offset:e.offset,include:e.include||null}}),t.exports.ItemLoot=s},{"../shared/data/itemloot.json":153,underscore:75}],100:[function(e,t,i){var n=e("./lib/class"),a=(e("../shared/js/gametypes"),e("../shared/js/itemtypes"));t.exports=ItemRoom=n.Class.extend({init:function(e,t,i,n,s){this.set(e,t,i,n,s)},assign:function(e){this.set(e.itemKind,e.itemNumber,e.itemDurability,e.itemDurabilityMax,e.itemExperience)},set:function(e,t,i,n,s){this.slot=-1,this.itemKind=e,this.itemNumber=t,this.itemDurability=i||(a.isConsumableItem(e)||a.isCraftItem(e)?0:900),this.itemDurabilityMax=n||(a.isConsumableItem(e)||a.isCraftItem(e)?0:900),this.itemExperience=s||0},addNumber:function(e){this.itemNumber+=e},save:function(){return[this.itemKind,this.itemNumber,this.itemDurability,this.itemDurabilityMax,this.itemExperience].join(",")},toArray:function(){return[parseInt(this.slot),this.itemKind,this.itemNumber,this.itemDurability,this.itemDurabilityMax,this.itemExperience]}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./lib/class":104}],101:[function(e,t,i){var n,s=e("underscore"),a=e("../shared/js/itemtypes"),r=e("../shared/data/items2.json"),o=e("../shared/data/craft.json"),l=0;for(n of o)n.id=l++;var h={0:null};s.each(r,function(e,t){h[e.id]={name:e.name,type:e.type||"object",damageType:e.damageType||"none",typemod:e.typemod||"none",modifier:e.modifier||0,hand:e.hand||0,sprite:e.sprite||"",spriteName:e.spriteName||"",offset:e.offset||[0,0],buy:e.buy||0,buycount:e.buycount||1,staticsheet:0<e.staticsheet?e.staticsheet:0,level:e.level||e.modifier,legacy:e.legacy||0,craft:function(e){var t,i=[];for(t of o)t.o==e&&i.push(t);return i}(e.id)}}),a.setKindData(h),t.exports.Kinds=h,t.exports.CraftData=o},{"../shared/data/craft.json":151,"../shared/data/items2.json":154,"../shared/js/itemtypes":168,underscore:75}],102:[function(e,t,i){var n=e("underscore"),e=e("../shared/data/lang.json"),s={};n.each(e,function(e,t){s[t]=e}),t.exports.Data=s},{"../shared/data/lang.json":155,underscore:75}],103:[function(e,t,i){var F;e(".././utils");function Y(e,t,i,n,s,a,r,o,l,h,c,u,p){return e&&(i&&!l[s][r]&&(u[p++]={x:r,y:s}),n)&&!l[s][o]&&(u[p++]={x:o,y:s}),t&&(i&&!l[a][r]&&(u[p++]={x:r,y:a}),n)&&!l[a][o]&&(u[p++]={x:o,y:a}),u}function q(e,t,i,n,s,a,r,o,l,h,c,u,p){return e=-1<s,t=a<h,n=-1<o,r<c&&(e&&!l[s][r]&&(u[p++]={x:r,y:s}),t)&&!l[a][r]&&(u[p++]={x:r,y:a}),n&&(e&&!l[s][o]&&(u[p++]={x:o,y:s}),t)&&!l[a][o]&&(u[p++]={x:o,y:a}),u}function W(e,t,i,n,s,a,r,o,l,h,c,u,p){return u}function V(e){return F[~~e[0]][~~e[1]]}function z(e,t,i,n){return n(i(e.x-t.x),i(e.y-t.y))}function Q(e,t,i,n){var s=e.x-t.x,e=e.y-t.y;return n(s*s+e*e)}function Z(e,t,i,n){return i(e.x-t.x)+i(e.y-t.y)}return t.exports=AStar=(F=null,{AStar:function(e,t,i,n){var s,a,r,o,l,h,c,u,p,m,d,f,y,g,D,v,b,E,T,x,S,I,k,w,A,_,P,M=(F=e)[0].length,j=e.length,G=M*j,H=Math.abs,C=Math.max,B={},O=[],N=[{x:~~t[0],y:~~t[1],f:0,g:0,v:t[0]+t[1]*M}],L=1,K={x:~~i[0],y:~~i[1],v:~~i[0]+~~i[1]*M};switch(n){case"Diagonal":r=Y;case"DiagonalFree":a=z;break;case"Euclidean":r=Y;case"EuclideanFree":C=Math.sqrt,a=Q;break;default:a=Z,r=W}r=r||q;do{for(l=G,R=h=0;R<L;++R)(n=N[R].f)<l&&(l=n,h=R);if((c=N.splice(h,1)[0]).v!=K.v)for(--L,f=r,y=c.x,g=c.y,D=e,v=j,b=M,P=_=A=w=k=I=S=x=T=E=void 0,E=(g=.5+~~g)-1,T=g+1,x=(y=.5+~~y)+1,S=y-1,I=0<E&&!V([E,y]),k=T<v+1&&!V([T,y]),w=x<b+1&&!V([g,x]),A=0<S&&!V([g,S]),_=[],P=0,I&&(_[P++]={x:y,y:E}),w&&(_[P++]={x:x,y:g}),k&&(_[P++]={x:y,y:T}),A&&(_[P++]={x:S,y:g}),R=0,o=(u=f(I,k,w,A,E,T,x,S,D,v,b,_,P)).length;R<o;++R)(s=u[R]).p=c,s.f=s.g=0,s.v=~~s.x+~~s.y*M,s.v in B||(p=0,s.p&&(s.dir=(d=(m=s).p,m.x<d.x?1:m.x>d.x?2:m.y<d.y?3:m.y>d.y?4:0),s.p.dir)&&s.p.dir!=s.dir&&(p=2),s.f=(s.g=c.g+a(s,c,H,C))+a(s,K,H,C)+p,B[(N[L++]=s).v]=1);else{for(R=L=0;O[R++]=[c.x,c.y],c=c.p;);function U(e,t){t.shift(),t.unshift([e[0],e[1]]);var i,n=null;for(i of t){if(n)if(~~n[0]==~~i[0])i[0]=n[0];else{if(~~n[1]!=~~i[1])break;i[1]=n[1]}n=i}}U(i,O),O.reverse(),U(t,O)}}while(L);for(var R=2;R<O.length;++R)(0<Math.abs(O[R-2][0]-O[R][0])&&0==Math.abs(O[R-2][1]-O[R][1])||0<Math.abs(O[R-2][1]-O[R][1])&&0==Math.abs(O[R-2][0]-O[R][0]))&&O.splice(--R,1);return O}}),AStar},{".././utils":146}],104:[function(e,t,i){var n=!1,a=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;(Class=function(){}).extend=function(e){var t,s=this.prototype,i=(n=!0,new this);for(t in n=!1,e)i[t]="function"==typeof e[t]&&"function"==typeof s[t]&&a.test(e[t])?function(i,n){return function(){var e=this._super,t=(this._super=s[i],n.apply(this,arguments));return this._super=e,t}}(t,e[t]):e[t];return(Class=function(){!n&&this.init&&this.init.apply(this,arguments)}).prototype=i,(Class.constructor=Class).extend=arguments.callee,Class},void 0!==i&&(i.Class=Class)},{}],105:[function(e,t,i){var n=e("./lib/class"),s=e("./message"),a=e("./appearancedata");t.exports=Looks=n.Class.extend({init:function(){var e=a.Data.length;this.prices=new Array(e),this.load();for(var t=0;t<e;t++)this.prices[t]=500;this.prices[0]=0,this.prices[50]=0,this.prices[77]=0,this.prices[151]=0},load:function(){console.info("LOOKS LOAD"),databaseHandler.loadLooks(this.prices)},save:function(){console.info("LOOKS SAVED"),this.prices&&databaseHandler.saveLooks(this.prices)},modPrice:function(e,t){this.prices[e]+=t},pricesToString:function(){return this.prices.join(",")},sendLooks:function(e){e.map.entities.pushToPlayer(e,new s.AppearanceList(e.user,this))}})},{"./appearancedata":79,"./lib/class":104,"./message":111}],106:[function(g,e,t){!function(a){!function(){var t=g("fs"),l=g("crypto"),h=g("./metrics"),c=g("./productionconfig"),u=g("./user"),p=(g("./utils"),g("./redis"),g("underscore")),m=g("readline").createInterface({input:process.stdin,output:process.stdout}),t=(G_LATENCY=100,G_ROUNDTRIP=2*G_LATENCY,G_TILESIZE=16,G_FRAME_INTERVALS=2,G_UPDATE_INTERVAL_EXACT=1e3/60*G_FRAME_INTERVALS,G_UPDATE_INTERVAL=G_UPDATE_INTERVAL_EXACT,G_SPATIAL_SIZE=64,G_SCREEN_WIDTH=34,G_SCREEN_HEIGHT=18,ATTACK_INTERVAL=1e3,ATTACK_MAX=4e3,PLAYER_SAVE_INTERVAL=18e5,mobState={IDLE:1,ROAMING:2,AGGRO:3,CHASING:4,FIRSTATTACK:5,ATTACKING:6,RETURNING:7,STUCK:8},SAVING_SERVER=!1,AUCTION_SAVED=!1,PLAYERS_SAVED=!1,worlds=[],users={},players=[],Log=g("log"),g("fs")),d=g("util"),l=g("crypto");t.createWriteStream(a+"/../console.log",{flags:"w"}),process.stdout;function i(r){log=new Log(Log.INFO||Log.DEBUG||Log.ERROR),console.isEnabled=!0,Object.defineProperty(log,"log",{value:void 0,writable:!0,enumerable:!0}),Object.defineProperty(log,"info",{value:void 0,writable:!0,enumerable:!0}),Object.defineProperty(log,"warn",{value:void 0,writable:!0,enumerable:!0}),Object.defineProperty(log,"error",{value:void 0,writable:!0,enumerable:!0}),log.log=function(e){e="LOG: "+d.format(e)+"\n";console.info(e)},log.info=function(e){e="INFO: "+d.format(e)+"\n";console.info(e)},log.warn=function(e){e="WARN: "+d.format(e)+"\n";console.warn(e)},log.error=function(e){e="ERROR: "+d.format(e)+"\n";console.error(e)};function e(){var t,e;f(),t=250,new Promise(e=>setTimeout(e,t)),e=setInterval(function(){PLAYERS_SAVED&&AUCTION_SAVED&&(clearInterval(e),process.exit(1))},500),process.exit()}var t=new c(r),t=(t.inProduction()&&p.extend(r,t.getProductionSettings()),r.world_id),i=g("./ws"),n=g("./worldserver"),s=new i.WebsocketServer(r),a=(r.metrics_enabled&&new h(r),this),i=g("./databaseselector"),t=(console.info("Initializing RRO2 GameServer - World "+t),i(r)),o=(t(r),DBH=databaseHandler=new t(r),loadWorlds=function(){p.each(p.range(r.nb_worlds),function(e){var t=new n("world"+e,r.nb_players_per_world,s,databaseHandler);t.run(),t.name=r.world_name[e],worlds.push(t)})},console.log("REDIS SERVER CREATED!!!!!!!!!!!!!"),loadWorlds(),s.onConnect(function(e){for(var t=(new Date).valueOf().toString(),i=Math.random().toString(),t=l.createHash("sha1").update(t+i).digest("hex"),n=(e.hash=t,console.warn("onConnect: hash="+t),r),i=g("../shared/js/gametypes"),s=(console.info(JSON.stringify(n)),console.info("version sent"),console.info(i.Messages.SC_VERSION),e.sendUTF8(i.Messages.SC_VERSION+","+n.version+","+e.hash),i.Messages.SC_WORLDS),a=0;a<n.nb_worlds;++a)s+=","+a+","+worlds[a].name+","+worlds[a].getPopulation()+","+n.nb_players_per_world;e.sendUTF8(s),this.enterWorld(e)}),s.enterWorld=function(e){new u(a,e).hashChallenge=e.hash},s.onError(function(){console.error(Array.prototype.join.call(arguments,", "))}),s.onRequestStatus(function(){return JSON.stringify((e=worlds,t=[],p.each(e,function(e){t.push(e.playerCount)}),t));var e,t}),process.on("uncaughtException",function(e){console.info(JSON.stringify(e)),console.error("uncaughtException: "+e.stack)}),s._ioServer.on("connection",e=>{console.log("connected"),e.on("disconnect",function(){console.log("disconnected")}),s._ioServer.on("msg",e=>{console.log("msg="+JSON.stringify(e))})}),process.on("SIGINT",e),process.on("SIGTERM",e),process.on("SIGQUIT",e),function(){"win32"===process.platform&&m.on("SIGINT",function(){process.emit("SIGINT")}),m.question("Command:",function(e){switch(args=e.split(" "),cmdarg=args[0],args.shift(),console.info("cmd: "+e),cmdarg){case"modgems":!function(e){var t=worlds[0],i=e[0],e=e[1],t=t.getPlayerByName(i);t&&t.user?t.user.modifyGems(e):databaseHandler.modifyGems(i,e)}(args);break;case"modgold":!function(e){var t=worlds[0],i=e[0],e=e[1],t=t.getPlayerByName(i);t?t.modifyGold(e):databaseHandler.modifyGold(i,e)}(args);break;case"setpass":!function(e){worlds[0];var t=e[0],e=e[1],e=l.createHash("sha1").update(t+e).digest("hex");DBH.savePassword(t,e)}(args);break;case"exit":case"quit":case"q":case"x":f(),process.exit(1);break;case"s":case"save":y();break;case"forcequit":process.exit(1);break;case"reloadauction":p.each(worlds,function(e){e.auction.load()});break;default:console.info("Unknown command.")}setTimeout(o,100)})});o()}var e=!1;function f(){e||(e=!0,m.close(),y())}function y(){console.log("saving server!"),SAVING_SERVER=!0,p.each(worlds,function(e){e.save()})}function n(e,i){t.readFile(e,"utf8",function(e,t){i(e?null:JSON.parse(t))})}var s="./config_local.json";process.argv.forEach(function(e,t,i){2===t&&(s=e)}),n("./config.json",function(t){n(s,function(e){e?i(e):t?i(t):(console.error("Server cannot start without any configuration file."),process.exit(1))})})}.call(this)}.call(this,g("path").join(__dirname,"js"))},{"../shared/js/gametypes":167,"./databaseselector":89,"./metrics":112,"./productionconfig":130,"./redis":133,"./user":145,"./utils":146,"./worldserver":147,"./ws":148,crypto:void 0,fs:void 0,log:60,path:void 0,readline:void 0,underscore:75,util:void 0}],107:[function(e,t,i){var n=e("./lib/class"),a=(_=e("underscore"),e("fs")),r=e("../shared/js/file"),o=(e("path"),e("./utils")),s=e("./checkpoint"),l=(e("./area"),e("./maparea")),e=n.Class.extend({init:function(e,t,i,n){this.id=this.index=e,console.info("filepath: "+i+",filenameCollision: "+n);var s=this;this.name=t,this.isLoaded=!1;r.exists(i,function(e){e?a.readFile(i,function(e,t){t=JSON.parse(t);s.initMap(t,n)}):console.error(i+" doesn't exist.")}),this.tilesize=G_TILESIZE},initMap:function(e,t){this.width=e.width,this.height=e.height,this.chunkWidth=e.chunkWidth,this.chunkHeight=e.chunkHeight,this.chunkIndexes=e.chunkIndexes,this.collisions=e.collisions,this.mobAreas=e.roamingAreas,this.chestAreas=e.chestAreas,this.staticChests=e.staticChests,this.staticEntities=e.staticEntities,this.generateCollisions=!0,this.zoneWidth=e.chunkWidth,this.zoneHeight=e.chunkHeight,this.groupWidth=Math.ceil(this.width/this.zoneWidth),this.groupHeight=Math.ceil(this.height/this.zoneHeight),this.initConnectedGroups(e.doors),this.loadTileGrid(e.data),this.loadCollisionGrid(e.collision),this.initCheckpoints(e.checkpoints),this.doors=this._getDoors(e),this.isLoaded=!0,this.ready=!0,this.readyFunc(this)},ready:function(e){this.readyFunc=e},tileIndexToGridPosition:function(e){var t=e%this.width,e=Math.floor(e/this.width);return{x:t*G_TILESIZE,y:e*G_TILESIZE}},GridPositionToTileIndex:function(e,t){return t*this.width+e+1},loadTileGrid:function(e){this.tile=[];for(var t,i=0;i<this.height;i++)for(this.tile[i]=[],t=0;t<this.width;t++)this.tile[i][t]=e[i*this.width+t]},loadCollisionGrid:function(e){this.grid=[];for(var t,i=0;i<this.height;i++)for(this.grid[i]=[],t=0;t<this.width;t++)this.grid[i][t]=1==e[i*this.width+t]},GroupIdToGroupPosition:function(e){e=e.split("-");return h(parseInt(e[0],10),parseInt(e[1],10))},forEachGroup:function(e){for(var t=this.groupWidth,i=this.groupHeight,n=0;n<t;n+=1)for(var s=0;s<i;s+=1)e(n+"-"+s)},getGroupIdFromPosition:function(e,t){var i=this.zoneWidth,n=this.zoneHeight;return Math.floor(e/i)+"-"+Math.floor(t/n)},getAdjacentGroupPositions:function(e){var t=this,i=this.GroupIdToGroupPosition(e),n=i.x,i=i.y,s=[h(n-1,i-1),h(n,i-1),h(n+1,i-1),h(n-1,i),h(n,i),h(n+1,i),h(n-1,i+1),h(n,i+1),h(n+1,i+1)];return _.each(this.connectedGroups[e],function(t){_.any(s,function(e){return c(e,t)})||s.push(t)}),_.reject(s,function(e){return e.x<0||e.y<0||e.x>=t.groupWidth||e.y>=t.groupHeight})},forEachAdjacentGroup:function(e,t){e&&_.each(this.getAdjacentGroupPositions(e),function(e){t(e.x+"-"+e.y)})},initConnectedGroups:function(e){var i=this;this.connectedGroups={},_.each(e,function(e){var t=i.getGroupIdFromPosition(e.x,e.y),e=i.getGroupIdFromPosition(e.tx,e.ty),e=i.GroupIdToGroupPosition(e);t in i.connectedGroups?i.connectedGroups[t].push(e):i.connectedGroups[t]=[e]})},initCheckpoints:function(e){var i=this;this.checkpoints={},this.startingAreas=[],_.each(e,function(e){var t=new s(i,e.id,e.x,e.y,e.w,e.h);i.checkpoints[t.id]=t,1===e.s&&i.startingAreas.push(t)})},getCheckpoint:function(e){return this.checkpoints[e]},getRandomStartingPosition:function(e){var t=_.size(this.startingAreas),t=o.randomInt(t-1);return e=e||this.startingAreas[t],console.info("getRandomStartingPosition - none"),1==this.index?this.getRandomPositionArea(500*G_TILESIZE,524*G_TILESIZE,500*G_TILESIZE,524*G_TILESIZE):e?e.getRandomPosition():null},isColliding:function(e,t){var e=~~(e>>4),t=~~(t>>4),i=~~(.5+e),n=~~(.5+t),e=[[e,t],[e,n],[i,t],[i,n]],s=e[0];if(this.isOutOfBounds(s[0],s[1]))return!0;if(this.isOutOfBounds((s=e[3])[0],s[1]))return!0;s=null;for(s of e)if(this.isCollidingGrid(s[0],s[1]))return!0;return!1},isCollidingGrid:function(e,t){return!0===this.grid[t][e]},isOutOfBounds:function(e,t){return!_.isNumber(e)||!_.isNumber(t)||e<0||e>=this.width||t<0||t>=this.height},isValidPosition:function(e,t){return _.isNumber(e)&&_.isNumber(t)&&!this.isOutOfBounds(e,t)&&!this.isColliding(e,t)},getRandomPositionCollide:function(e){for(var t=this,i={},n=(i.x=o.randomRangeInt(0-(e=e||[0,0,0,0])[0],t.width-1-e[2]),i.y=o.randomRangeInt(0-e[1],t.height-1-e[3]),0);n<25&&!t.isValidPosition(i.x+e[0],i.y+e[1],i.x+e[2],i.y+e[3]);)++n,i.x=o.randomRangeInt(0-e[0],t.width-1-e[2]),i.y=o.randomRangeInt(0-e[1],t.height-1-e[3]);return 25<=n&&(i.x=-1,i.y=-1,console.log("getRandomPosition()-tries="+n)),i},getRandomPositionArea:function(e,t,i,n){for(var s={},a=this.tilesize,r=(e=o.clamp(0,this.width*a,e),t=o.clamp(0,this.width*a,t),i=o.clamp(0,this.height*a,i),n=o.clamp(0,this.height*a,n),s.x=o.randomRangeInt(e,t),s.y=o.randomRangeInt(i,n),0);r<20&&this.isColliding(s.x,s.y);)++r,s.x=o.randomRangeInt(e,t),s.y=o.randomRangeInt(i,n);return 20<=r&&(s.x=-1,s.y=-1,console.log("getRandomPosition()-tries="+r)),s},getRandomPosition:function(){for(var e=this,t={},i=(t.x=o.randomRangeInt(0,e.width*e.tilesize),t.y=o.randomRangeInt(0,e.height*e.tilesize),0);i<20&&!e.isColliding(t.x,t.y);)++i,t.x=o.randomRangeInt(0,e.width*e.tilesize),t.y=o.randomRangeInt(0,e.height*e.tilesize);return 20<=i&&(t.x=-1,t.y=-1,console.log("getRandomPosition()-tries="+i)),t},_getDoors:function(i){console.info(JSON.stringify(i.doors));var n=[];return _.each(i.doors,function(e){e.width=e.width||1,e.height=e.height||1,console.info("door.tmap="+e.tmap);var t=new l(i,!1,e.x,e.y,e.width,e.height,-1);switch(t.minLevel=e.tminLevel||0,t.maxLevel=e.tmaxLevel||200,t.map=e.tmap||1,t.portal=1===e.p,t.quest=e.tq,t.admin=e.a,e.to){case"u":t.orientation=Types.Orientations.UP;break;case"d":t.orientation=Types.Orientations.DOWN;break;case"l":t.orientation=Types.Orientations.LEFT;break;case"r":t.orientation=Types.Orientations.RIGHT;break;default:t.orientation=Types.Orientations.DOWN}n.push(t)}),console.info("return doors"),n},isDoor:function(t,i){return _.detect(this.doors,function(e){return null!=e.contains({x:t,y:i})})},getDoor:function(t){return _.detect(this.doors,function(e){return e.contains(t)})},getSubCoordinate:function(e,t){return[e%=this.chunkWidth*this.tilesize,t%=this.chunkHeight*this.tilesize]},getSubIndex:function(e,t){return~~(t/(this.chunkHeight*this.tilesize)*this.chunkHeight+e/(this.chunkWidth*this.tilesize))},isHarvestTile:function(e,t){if(console.info("isHarvestTile"),this.isOutOfBounds(e.gx,e.gy))return!1;var i=this.getTiles(e.gx,e.gy);if(console.info("tiles: "+JSON.stringify(i)),!i||0==i.length)return!1;log.info("tiles="+JSON.stringify(i));e={axe:[678,679,698,699,855,875,274,275,294,295]};return!!e.hasOwnProperty(t)&&e[t].some(function(e){return i.includes(e)})},getTiles:function(e,t){return this.tile[t][e]}}),h=function(e,t){return{x:e,y:t}},c=function(e,t){return e.x===t.x&&t.y==t.y};t.exports=e},{"../shared/js/file":166,"./area":80,"./checkpoint":86,"./lib/class":104,"./maparea":108,"./utils":146,fs:void 0,path:void 0,underscore:75}],108:[function(e,t,i){e=e("./lib/class").Class.extend({init:function(e,t,i,n,s,a){this.map=e,this.elipse=t,this.x=i*G_TILESIZE,this.y=n*G_TILESIZE,this.width=s*G_TILESIZE,this.height=a*G_TILESIZE},contains:function(e){var t,i;return elipse?elipse?!!e&&(t=this.x,i=this.y,i=(t=Math.sqrt(Math.pow(e.x-t,2)+Math.pow(e.y-i,2)))<this.width/2&&t<this.height/2,console.log("this.elipseId="+this.elipseId),i):void 0:!!e&&e.x>=this.x&&e.y>=this.y&&e.x<this.x+this.width&&e.y<this.y+this.height}});t.exports=e},{"./lib/class":104}],109:[function(e,t,i){var n=e("./lib/class"),r=(_=e("underscore"),e("path"),e("./utils")),o=(e("./chest"),e("./message")),s=e("./npcstatic"),a=e("./mobdata"),l=e("./npcdata"),h=e("../shared/js/itemtypes"),c=(e("./skilldata"),e("./mobcallback")),u=e("./mobai"),e=n.Class.extend({init:function(e,t,i,n){for(var s=this,a=(s.id=e,s.map=i,s.server=t,s.database=n,s.entities={},s.players={},s.npcplayers={},s.mobs={},s.items={},s.equipping={},s.hurt={},s.npcs={},s.chests={},s.blocks={},s.spatial=[],Math.ceil(s.map.width/G_SPATIAL_SIZE)),r=Math.ceil(s.map.height/G_SPATIAL_SIZE),o=0;o<r;o++){s.spatial[o]=[];for(var l=0;l<a;l++)s.spatial[o][l]={}}s.packets={},s.mobAreas=[],s.chestAreas=[],s.groups={},s.pathfinder=null,s.pathingGrid=null,s.zoneGroupsReady=!1,s.maxPackets=8,s.entityCount=0,this.mobCallback=null,this.mobAI=null,this.cellsize=G_TILESIZE,this.harvest={}},getSpatialEntities:function(e){for(var t=~~(Math.max(e[0],0)/G_SPATIAL_SIZE),i=~~(Math.max(e[1],0)/G_SPATIAL_SIZE),n=~~(Math.min(e[2],this.map.width)/G_SPATIAL_SIZE),s=~~(Math.min(e[3],this.map.height)/G_SPATIAL_SIZE),a={},r=i;r<=s;++r)for(var o=t;o<=n;++o)if(!(r<0||r>=this.spatial.length||o<0||o>=this.spatial[r].length))for(var[l,h]of Object.entries(this.spatial[r][o]))h&&(a[l]=h);return a},mapready:function(){this.initPathFinder(),this.initPathingGrid(),this.mobCallback=new c(this.server,this.map),this.mobAI=new u(this.server,this.map)},initPathFinder:function(){this.pathfinder=new Pathfinder(this.map.width,this.map.height)},spawnNpcs:function(e){for(var t=0;t<e;++t)this._createNpc("Npc"+t)},_createNpc:function(e){var t=this,i=(pos=t.spaceEntityRandomApart(2,function(){return t.map.getRandomPosition()}),new NpcMove(++t.entityCount,0,16*pos.x,16*pos.y,t.map));return t.addNpcPlayer(i),i},initPathingGrid:function(){for(var e=this.map,t=(console.info("pathinggrid height:"+e.height+", width:"+e.width),new Array(e.height)),i=0;i<e.height;i+=1){t[i]=new Array(e.width);for(var n=0;n<e.width;n+=1)e.grid[i][n]?t[i][n]=1:t[i][n]=0}this.entitygrid=t.slice(0),this.pathingGrid=t.slice(0),console.info("Initialized the pathing grid with static colliding cells.")},processWho:function(t){var i=this,n=[],e=[],s=(e=(e=t.knownIds).parseInt(),~~(t.x/G_TILESIZE)),a=~~(t.y/G_TILESIZE),s=this.getSpatialEntities([s-64,a-32,64+s,32+a]),a=(_.each(s,function(e){e&&e!=t&&i.isOffset(t,e)&&n.push(e.id)}),e&&0<e.length?_.difference(n,e):n);_.each(a,function(e){var e=i.getEntityById(e);e&&e!=t&&(t.knownIds.push(e.id),i.pushToPlayer(t,e.spawn()),e.path)&&(e=new o.MovePath(e,e.path),i.pushToPlayer(t,e))})},isOffset:function(e,t,i,n,s){i=(i||0)*G_TILESIZE,n=(n||32)*G_TILESIZE,s=(s||18)*G_TILESIZE;var s=Math.max(0,e.x-n-i),a=Math.max(0,e.y-n-i),r=Math.min(this.map.width*G_TILESIZE,e.x+n+i),e=Math.min(this.map.height*G_TILESIZE,e.y+n+i);return t.y>=a&&t.y<=e&&t.x>=s&&t.x<=r},processPackets:function(){var e,t=this;for(e in 0<t.packets.length&&console.info(JSON.stringify(t.packets)),t.packets)if(null!=e&&void 0!==e&&t.packets.hasOwnProperty(e)&&0<t.packets[e].length&&void 0!==t.packets[e]&&null!=t.packets[e]){var i=t.getEntityById(e);if(i&&2<=i.mapStatus&&null!=t.server.socket.getConnection(e)&&void 0!==t.server.socket.getConnection(e)){for(var i=t.server.socket.getConnection(e),n=(t.packets[e].length,[]),s=0;s<t.maxPackets&&0!=t.packets[e].length;++s)n.push(t.packets[e].shift());i.send(n)}else t.server.socket.getConnection(e)}},pushToPlayer:function(e,t){t&&e&&e.id in this.packets&&this.packets[e.id].push(t.serialize())},pushBroadcast:function(e,t){if(e)for(var i in this.packets)this.packets.hasOwnProperty(i)&&i!=t&&this.packets[i].push(e.serialize())},pushNeighbours:function(e,t,i,n){var s,a=this.getPlayerAround(e,n=n||48);for(s in e instanceof Player&&a.push(e),a){var r=a[s];r instanceof Player&&(this.packets.hasOwnProperty(r.id)&&!i||i&&r!=i)&&this.packets[r.id].push(t.serialize())}},isMobsOnSameTile:function(t){var i=t.x,n=t.y,s=!1,a=0,r=0;return t.path&&0<t.path.length&&(i=t.path[t.path.length-1][0],n=t.path[t.path.length-1][1]),_.each(self.mobs,function(e){r=e.isMoving()?(a=e.path[e.path.length-1][0],e.path[e.path.length-1][1]):(a=e.x,e.y),e.id!=t.id&&i==a&&n==r&&(s=!0)}),s},getFreeAdjacentNonDiagonalPosition:function(e){var n=this,s=null;return e.forEachAdjacentNonDiagonalPosition(function(e,t,i){s||n.map.isColliding(e,t)||n.isCharacterAt(e,t)||(s={x:e,y:t,o:i})}),s},getFreeFutureAdjacentNonDiagonalPosition:function(e){var n=this,s=[];return e.forEachFutureAdjacentNonDiagonalPosition(function(e,t,i){n.map.isColliding(e,t)||n.isMobAt(e,t)||s.push({x:e,y:t,o:i})}),s},getRandomPosition:function(e,t){var i=[],n=0;for(t*=G_TILESIZE;n++<10&&i.y!=e.y&&i.x!=e.x;){var s=r.randomRangeInt(-t,t),a=r.randomRangeInt(-t,t);if(i[0]=e.x+s,i[1]=e.y+a,!this.map.isColliding(i[0],i[1])&&(-1!=i[0]||-1!=i[1]))return{x:i[0],y:i[1]}}return console.info("getRandomPosition - failed"),null},handleOpenedChest:function(e,t){this.pushToAdjacentGroups(e.group,e.despawn()),this.removeEntity(e);t=this.server.getDroppedOrStolenItem(t,e,!1);t&&t instanceof Item&&(t.x=e.x,t.y=e.y,e.map.entities.pushBroadcast(new o.Spawn(t)),this.server.handleItemDespawn(t)),e.handleRespawn()},spawnStaticEntities:function(i){var n=this;console.info(JSON.stringify(n.map.staticEntities)),_.each(n.map.staticEntities,function(e,t){t=i.tileIndexToGridPosition(t);console.info("kind:"+e),l.isNpc(e)&&(console.info("npc:"+e+",x:"+t.x+",y:"+t.y),n.addNpc(e,t.x,t.y))})},spawnEntity:function(e,t,i,n){var s;return l.isNpc(e)?s=this.addNpc(e,t,i,n):a.isMob(e)&&(s=this.addMob(e,t,i)),s},addEntity:function(e){this.entities[e.id]=e},addPlayer:function(e){console.info("addPlayer - player id: "+e.id),this.addEntity(e),this.players[e.id]=e,this.packets[e.id]=[]},addChest:function(e){this.addEntity(e),this.chests[e.id]=e},addBlock:function(e){return this.addEntity(e),this.blocks[e.id]=e},addMob:function(e,t,i,n){e=new Mob(++this.entityCount,e,t,i,this.map,n);return e.mobAI=this.mobAI,e.onMove(this.server.onMobMoveCallback.bind(this.server)),this.mobCallback.setCallbacks(e),this.addEntity(e),this.mobs[e.id]=e},addNpc:function(e,t,i){e=new s(++this.entityCount,e,t,i,this.map);return this.addEntity(e),this.npcs[e.id]=e},addNpcPlayer:function(e){return this.addEntity(e),this.npcplayers[e.id]=e},addItem:function(e){return this.addEntity(e),this.items[e.id]=e},removeEntity:function(e){var t=this;e.id in t.entities&&delete t.entities[e.id],e.id in t.mobs&&delete t.mobs[e.id],e.id in t.items&&delete t.items[e.id],e.id in t.players&&delete t.players[e.id],e.id in t.chests&&delete t.chests[e.id],e.id in t.blocks&&delete t.blocks[e.id],e.destroy()},removePlayer:function(e){console.info("removePlayer-called");var t=this;e instanceof Player&&e.packetHandler.broadcast(e.despawn()),t.removeEntity(e),console.info("deleting player traces.."),delete t.players[e.id],delete t.packets[e.id],delete t.entities[e.id],delete e,t.server.updatePopulation()},removeNpcPlayer:function(e){console.info("removePlayer-called");this.pushBroadcast(e.despawn(0)),this.removeEntity(e),delete this.npcplayers[e.id]},createItem:function(e,t,i){var n=++this.entityCount,s=Types.EntityTypes.ITEM;return h.isEquippable(e.itemKind)||(s=Types.EntityTypes.ITEMLOOT),s=new Item(s,n,e,t,i,this.map),this.addItem(s),s},addStaticItem:function(e,t){return t.isStatic=!0,t.onRespawn(this.addStaticItem.bind(this,t)),this.addItem(t)},addItemFromChest:function(e,t,i){e=this.createItem(e,t,i);return e.isFromChest=!0,this.addItem(e)},getNpcByQuestId:function(e){var t;for(e in this.npcs)if((t=this.npcs[e]).questId==e)return t;return null},getEntityById:function(e){if(this.entities.hasOwnProperty(e))return this.entities[e]},getPlayerByName:function(e){for(var t in this.players){t=this.players[t];if(t.name===e)return t}return null},setModifyGoldByName:function(e,t){var i=this.getPlayerByName(e);i?i.modifyGold(t):this.database.modifyGold(e,t)},getEntitiesByPosition:function(t,i){return entities=[],this.forEachEntity(function(e){e.x==t&&e.y==i&&entities.push(e)}),entities},isCharacterAt:function(e,t){return 1===this.entitygrid[t][e]},isMobAt:function(n,s){var a=!1;return this.forEachMob(function(e){var t=e.x,i=e.y;e.path&&0<e.path.length&&(t=e.path[e.path.length-1][0],i=e.path[e.path.length-1][1]),n==t&&s==i&&(a=!0)}),a},forEachEntity:function(e){for(var t in this.entities)this.entities.hasOwnProperty(t)&&e(this.entities[t])},forEachPlayer:function(e){for(var t in this.players)this.players.hasOwnProperty(t)&&e(this.players[t])},forEachPartyPlayer:function(e){for(var t in this.players)this.players.hasOwnProperty(t)&&e(this.players[t])},forEachMob:function(e){for(var t in this.mobs)this.mobs.hasOwnProperty(t)&&e(this.mobs[t])},forEachCharacter:function(e){for(var t in this.entities)this.entities.hasOwnProperty(t)&&this.entities[t]instanceof Character&&e(this.entities[t])},forEachNpcPlayer:function(e){for(var t in this.npcplayers)this.npcplayers.hasOwnProperty(t)&&e(this.npcplayers[t])},getEntityCount:function(e,t,i,n){i*=G_TILESIZE;var s,a,r=t.x,o=t.y,l=0;n=n||function(e,t){return e!==t};for(a in e)e.hasOwnProperty(a)&&(s=e[a],Math.abs(s.x-r)<=i)&&Math.abs(s.y-o)<=i&&n(t,s)&&l++;return l},getEntitySpatialCount:function(e,t,i){t*=G_TILESIZE;var n,s=e.x,a=e.y,t=t>>1,r=0;for(n in i=i||function(e,t){return e!==t},this.getSpatialEntities([s-t,a-t,s+t,a+t]))i(e,n)&&r++;return r},getEntityAroundSpatial:function(e,t,i){var n,s,t=(t*=G_TILESIZE)>>1,a=e.x,r=e.y,o=[],l=(i=i||function(e,t){return e!==t},this.getSpatialEntities([a-t,r-t,a+t,r+t]));for(s in l)(n=l[s])&&i(e,n)&&o.push(n);return o},getEntityAround:function(e,t,i,n){i*=G_TILESIZE;var s,a,r=t.x,o=t.y,l=[];for(a in n=n||function(e,t){return e!==t},e)(s=e[a])&&Math.abs(s.x-r)<=i&&Math.abs(s.y-o)<=i&&n(t,s)&&l.push(s);return l},getEachEntityAround:function(e,t,i){var e=~~(e/G_TILESIZE),t=~~(t/G_TILESIZE),n=this.getSpatialEntities([e-i,t-i,e+i,t+i]);return this.getEntityAround(n,{x:e,y:t},i)},getEntitiesAround:function(e,t){var i=~~(e.x/G_TILESIZE),n=~~(e.y/G_TILESIZE),t=t>>1,i=this.getSpatialEntities([i-t,n-t,i+t,n+t]);return this.getEntityAround(i,e,t)},getCharactersAround:function(e,t){return this.getEntityAround(this.entities,e,t,null,function(e,t){return e!==t&&t instanceof Character})},getMobsAround:function(e,t){return this.getEntityAround(this.mobs,e,t)},getPlayerAround:function(e,t){return this.getEntityAround(this.players,e,t)},getAroundCount:function(e,t,i){return this.getEntityCount(e,t,i)},getEntityAroundCount:function(e,t){return this.getEntityCount(this.entities,e,t)},getPlayerAroundCount:function(e,t){return this.getEntityCount(this.players,e,t)},getPartyAround:function(e,t){return this.getEntityAround(e.party.players,e,t)},itemDespawn:function(e){this.pushNeighbours(e,new o.Despawn(e)),this.removeEntity(e)},handleEmptyChestArea:function(e){e&&this.handleItemDespawn(chest)},tryAddingMobToChestArea:function(t){_.each(this.chestAreas,function(e){e.contains(t)&&e.addToArea(t)})},findPath:function(e,t,i,n){var s=[];if(this.pathfinder&&e){var a=this.map.grid,s=null,r=[e.x,e.y];G_TILESIZE;if(this.map.isColliding(e.x,e.y))return console.warn("findPath - isColliding start."),null;var o=[t,i];if(this.map.isColliding(t,i))return console.warn("findPath - isColliding end."),null;if(r[0]==o[0]&&r[1]==o[1]){try{throw new Error}catch(e){console.info(e.stack)}return console.warn("findPath - path coordinates are the same."),null}if(!s||0==s.length){if((r[0]==o[0]||r[1]==o[1])&&this.pathfinder.isValidPath(a,l=[r,o]))return l;var l=[r,[r[0],o[1]],o];if(console.info("mp:"+JSON.stringify(l)),this.pathfinder.isValidPath(a,l))return l;if(l=[r,[o[0],r[1]],o],console.info("mp:"+JSON.stringify(l)),this.pathfinder.isValidPath(a,l))return l}s&&0!=s.length||(l=this.pathfinder.getShortGrid(a,r,o,3),s=this.pathfinder.findShortPath(l.crop,l.minX,l.minY,l.substart,l.subend)),s&&0!=s.length||(console.warn("findPath - DANGER - findPath LONGGG"),s=this.pathfinder.findPath(a,r,o,!1)),s||console.error("findPath - Error while finding the path to "+t+", "+i+" for "+e.id)}else console.error("findPath - Error while finding the path to "+t+", "+i+" for "+e.id);return s},spaceEntityRandomApart:function(e,t,i,n,s){i=i||this.entities,s=s||50;for(var a=null,r=1,o=n&&n.collision?n.collision:null,l=0;0<r&&l<s;)t&&(r=(a=t(o))?this.getAroundCount(i,{x:a.x,y:a.y},e):0),l++;return a},isGridPositionEmpty:function(e,t){if(console.info("isGridPositionEmpty: x="+e+",y="+t),this.map.isColliding(e,t))return!1;var i={x:e,y:t},e=this.getEntitiesAround(i,1);if(0!=e.length)for(var n of e)if(n.isWithin(i))return!1;return!0}});t.exports=e},{"../shared/js/itemtypes":168,"./chest":87,"./lib/class":104,"./message":111,"./mobai":114,"./mobcallback":116,"./mobdata":117,"./npcdata":121,"./npcstatic":124,"./skilldata":135,"./utils":146,path:void 0,underscore:75}],110:[function(e,t,i){var n=e("./lib/class"),s=e("./map"),v=e("./mapentities"),b=(e("./message"),e("./utils")),E=e("./npcmove"),T=(e("./blockarea"),e("./traparea"),e("./trapgroup"),e("./mobdata")),x=e("./node");t.exports=MapManager=n.Class.extend({storeMobAreas:function(e){e.mobArea=[];for(var t=0;t<e.mobAreas.length;++t){(i=e.mobAreas[t]).sMinLevel=i.sMinLevel||0,i.sMaxLevel=i.sMaxLevel||0;var i=new MobArea(i.id,i.nb,i.minLevel,i.maxLevel,i.x,i.y,i.width,i.height,i.include,i.exclude,i.definite,e,i.ellipse,i.excludeId,i.sMinLevel,i.sMaxLevel);e.mobArea.push(i)}return e.mobArea},spawnMobs:function(e){for(a of e.mobArea)a.addMobs(),a.spawnMobs()},storeChestArea:function(t){var i=[];return _.each(t.chestAreas,function(e){e=new ChestArea(e.id,e.nb,e.minLevel,e.maxLevel,e.x,e.y,e.width,e.height,t);e.spawnChests(),i.push(e)}),i},init:function(e){var g=this;this.server=e,this.maps={},this.mapCount=0,this.id=0,this.mapInstances={},this.loaded=!1,this.maps[0]=new s(0,"map0","./maps/map0.json",""),this.maps[0].ready(function(){var t=g.maps[0];t.entities=new v(g.id,g.server,t,g.server.database),t.entities.mapready(),t.entities.spawnStaticEntities(t),t.enterCallback=function(e){return t.getRandomStartingPosition()},g.MapsReady()}),this.maps[1]=new s(1,"map1","./maps/map1.json",""),this.maps[1].ready(function(){for(var t=g.maps[1],e=(t.entities=new v(g.id,g.server,t,g.server.database),t.entities.mapready(),t.mobArea=[],new MobArea(0,25,0,1,512,512,40,40,[1],null,null,t,!0,-1,null,null)),i=(t.mobArea.push(e),0),n=0,s=512,a=512,r=0,o=0,l=0,h=0;h<40;h++){o+=h%2==0?1:0;for(var c=h%4,r=1;r<=o;r++){switch(c){case n=i=0:i=40;break;case 1:n=40;break;case 2:i=-40;break;case 3:n=-40}s+=i,a+=n,l++,e=new MobArea(l,12,1+l,1+l,s,a,40,40,[l%Object.keys(T.Kinds).length],null,null,t,!0,-1,null,null),t.mobArea.push(e);var u=new Area(0,s,a,30,30,t,!0,-1),p=u._getRandomPositionInsideArea(35),m=new E(++t.entities.entityCount,l,p.x,p.y,t);if(t.entities.addNpcPlayer(m),0<l){var d=1;if(5==l)for(var f=0;f<6;++f){p=t.entities.spaceEntityRandomApart(2,u._getRandomPositionInsideArea.bind(u,100));(y=new x(++t.entities.entityCount,3,p.x,p.y,t,d,d)).name="node1",y.weaponType="any",u.addToArea(y),t.entities.addEntity(y)}else if(6==l)for(d=2,f=0;f<6;++f){p=t.entities.spaceEntityRandomApart(2,u._getRandomPositionInsideArea.bind(u,100));(y=new x(++t.entities.entityCount,3,p.x,p.y,t,d,d)).name="node2",y.weaponType="any",u.addToArea(y),t.entities.addEntity(y)}else{d=b.clamp(1,4,1+~~(l/10));for(f=0;f<10;++f){var y,p=t.entities.spaceEntityRandomApart(2,u._getRandomPositionInsideArea.bind(u,100));(y=new x(++t.entities.entityCount,2,p.x,p.y,t,d,d)).name="node"+d,y.weaponType="hammer",u.addToArea(y),t.entities.addEntity(y)}}}}}(m=new E(++t.entities.entityCount,0,8160,8160,t)).name="Old Man",m.scriptQuests=!1,t.entities.addNpcPlayer(m),g.spawnMobs(t),t.enterCallback=function(e){return t.getRandomStartingPosition()},g.MapsReady()})},MapsReady:function(){this.mapCount++,console.info("mapCount="+this.mapCount),this.isMapsReady()&&!this.loaded&&(console.info("maps ready"),this.readyFunc(),this.loaded=!0)},isMapsReady:function(){return console.info("Maps Length: "+Object.keys(this.maps).length),this.mapCount==Object.keys(this.maps).length},onMapsReady:function(e){this.readyFunc=e}})},{"./blockarea":84,"./lib/class":104,"./map":107,"./mapentities":109,"./message":111,"./mobdata":117,"./node":119,"./npcmove":122,"./traparea":142,"./trapgroup":143,"./utils":146}],111:[function(e,t,i){e("underscore");var n=e("./lib/class"),s=e("../shared/js/gametypes"),a=e("./utils"),e={},t=(t.exports=e,n.Class.extend({}));e.Spawn=t.extend({init:function(e){this.entity=e},serialize:function(){return[s.Messages.SC_SPAWN].concat(this.entity.getState())}}),e.Despawn=t.extend({init:function(e){this.id=e.id,this.mapIndex=e.map.index,this.x=e.x,this.y=e.y},serialize:function(){return[s.Messages.SC_DESPAWN,this.id,this.mapIndex,this.x,this.y]}}),e.SwapSprite=t.extend({init:function(e,t){this.entity=e,this.animId=t},serialize:function(){return[s.Messages.SC_SWAPSPRITE,this.entity.id,this.entity.kind,this.animId]}}),e.Move=t.extend({init:function(e,t,i,n,s){this.time=Date.now(),this.entity=e,this.orientation=t,this.state=i,this.x=n||this.entity.x,this.y=s||this.entity.y},serialize:function(){return[s.Messages.SC_MOVE,this.time,this.entity.map.index,this.entity.id,parseInt(this.orientation),this.state,this.entity.moveSpeed,this.x,this.y]}}),e.MovePath=t.extend({init:function(e,t){this.time=Date.now(),this.entity=e,this.path=t,this.orientation=e.orientation},serialize:function(){return[s.Messages.SC_MOVEPATH,this.time,this.entity.map.index,this.entity.id,parseInt(this.orientation),this.entity.interrupted=this.entity.interrupted?1:0,this.entity.moveSpeed].concat(this.path)}}),e.ChangePoints=t.extend({init:function(e,t,i){this.id=e.id,this.hp=e.stats.hp,this.hpMax=e.stats.hpMax,this.ep=e.stats.ep||0,this.epMax=e.stats.epMax||0,this.modhp=t,this.modep=i},serialize:function(){return[s.Messages.SC_CHANGEPOINTS,this.id,this.hp,this.hpMax,this.modhp,this.ep,this.epMax,this.modep]}}),e.Error=t.extend({init:function(e){this.message=e},serialize:function(){return[s.Messages.SC_ERROR,this.message]}}),e.Notify=t.extend({init:function(e,t,i){this.group=e,this.message=t,this.vars=i||[]},serialize:function(){return[s.Messages.SC_NOTIFY,this.group,this.message].concat(this.vars)}}),e.Quest=t.extend({init:function(e){this.quest=e},serialize:function(){var e=this.quest.toClient();return[s.Messages.SC_QUEST].concat(e)}}),e.Achievement=t.extend({init:function(e){this.achievement=e},serialize:function(){var e=this.achievement.toClient(this.achievement);return[s.Messages.SC_ACHIEVEMENT].concat(e)}}),e.Log=t.extend({init:function(e){this.message=e,this.message.unshift(s.Messages.SC_LOG)},serialize:function(){return this.message}}),e.SkillLoad=t.extend({init:function(e,t){this.index=e,this.exp=t},serialize:function(){return[s.Messages.SC_SKILLLOAD,this.index,this.exp]}}),e.SkillEffects=t.extend({init:function(e,t){this.id=e.id,this.effects=t},serialize:function(){return[s.Messages.SC_SKILLEFFECTS,this.id].concat(this.effects)}}),e.SkillXP=t.extend({init:function(e){this.skillXPs=e},serialize:function(){var e=[s.Messages.SC_SKILLXP];return e.push(skillXPs.length),e.concat(skillXPs),e}}),e.Chat=t.extend({init:function(e,t,i){this.playerId=e.id,this.group=t,this.message=i},serialize:function(){return[s.Messages.SC_CHAT,this.playerId,this.group,this.message]}}),e.TeleportMap=t.extend({init:function(e,t,i){this.entity=e,this.subIndex=t,this.status=i},serialize:function(){return[s.Messages.SC_TELEPORT_MAP,this.entity.getMapIndex(),this.subIndex,this.status,this.entity.x,this.entity.y]}}),e.Damage=t.extend({init:function(e){var t=e[0],i=e[1];this.entity1=t,this.entity2=i,this.hpMod=e[2],this.hp=i.stats.hp,this.hpMax=i.stats.hpMax,this.epMod=e[3],this.ep=i.stats.ep||0,this.epMax=i.stats.epMax||0,this.crit=e[4]?1:0,this.effects=e[5]},serialize:function(){var e=[s.Messages.SC_DAMAGE,this.entity1.id,this.entity2.id,this.entity1.orientation,this.hpMod,this.hp,this.hpMax,this.epMod,this.ep,this.epMax,this.crit];return Array.isArray(this.effects)&&0<this.effects.length&&e.concat(this.effects),e}}),e.StatInfo=t.extend({init:function(e){this.player=e},serialize:function(){return[s.Messages.SC_STATINFO,this.player.stats.attack,this.player.stats.defense,this.player.stats.health,this.player.stats.energy,this.player.stats.luck,this.player.stats.free]}}),e.UpdateLook=t.extend({init:function(e){this.player=e},serialize:function(){return[s.Messages.SC_LOOKUPDATE,this.player.id,this.player.sprites[0],this.player.sprites[1],this.player.colors[0],this.player.colors[1]]}}),e.AppearanceList=t.extend({init:function(e,t){this.looks=a.BinToHex(e.looks),this.prices=t.prices},serialize:function(){return[s.Messages.SC_APPEARANCE,this.looks].concat(this.prices)}}),e.ItemSlot=t.extend({init:function(e,t){this.type=e,this.items=t},serialize:function(){var e,t=[s.Messages.SC_ITEMSLOT,this.type,this.items.length];for(e of this.items)var i=null,i=-1==e.itemKind?[e.slot,e.itemKind]:e.toArray(),t=t.concat(i);return t}}),e.ItemLevelUp=t.extend({init:function(e,t){this.index=e,this.item=t},serialize:function(){if(this.item)return[s.Messages.SC_ITEMLEVELUP,this.index,this.item.itemNumber,this.item.itemExperience]}}),e.Kill=t.extend({init:function(e,t,i){this.entity=e,this.level=t,this.exp=i},serialize:function(){return[s.Messages.SC_KILL,this.entity?this.entity.id:-1,this.level,this.exp]}}),e.LevelUp=t.extend({init:function(e,t,i){this.type=e,this.level=t,this.exp=i},serialize:function(){return[s.Messages.SC_LEVELUP,this.type,this.level,this.exp]}}),e.List=t.extend({init:function(e){this.ids=e},serialize:function(){var e=this.ids;return e.unshift(s.Messages.SC_LIST),e}}),e.AuctionOpen=t.extend({init:function(e){this.itemData=e},serialize:function(){return this.itemData}}),e.Speech=t.extend({init:function(e,t,i){this.entityid=e.id,this.kind=t,this.value=i},serialize:function(){return[s.Messages.SC_SPEECH,this.entityid,this.kind,this.value]}}),e.Gold=t.extend({init:function(e){this.invgold=e.gold[0],this.bankgold=e.gold[1],this.gems=e.user.gems},serialize:function(){return[s.Messages.SC_GOLD,this.invgold,this.bankgold,this.gems]}}),e.BlockModify=t.extend({init:function(e,t,i){this.entity=e,this.id=t,this.state=i},serialize:function(){return[s.Messages.SC_SPAWN,this.id,this.state].concat(this.entity.getState())}}),e.PartyInvite=t.extend({init:function(e){this.id=e},serialize:function(){return[s.Messages.SC_PARTY,2,this.id]}}),e.Party=t.extend({init:function(e){this.members=e},serialize:function(){return[s.Messages.SC_PARTY,1].concat(this.members)}}),e.PlayerInfo=t.extend({init:function(e){this.player=e},serialize:function(){return[s.Messages.BI_PLAYERINFO,this.player.exp.base,this.player.exp.attack,this.player.exp.defense,this.player.exp.sword,this.player.exp.bow,this.player.exp.hammer,this.player.exp.axe,this.player.exp.logging,this.player.exp.mining]}}),e.Looks=t.extend({init:function(e){this.player=e,this.sprite1=e.sprites[0],this.sprite2=e.getWeaponSprite(),e.isArcher()&&(this.sprite1=e.sprites[2])},serialize:function(){return[s.Messages.SC_LOOKS,this.player.id,this.player.isArcher()?1:0,this.sprite1,this.sprite2]}}),e.Harvest=t.extend({init:function(e,t,i,n,s){this.duration=s||0,this.id=e.id,this.action=t,this.gx=i,this.gy=n},serialize:function(){var e=[s.Messages.BI_HARVEST,this.id,this.action,this.gx,this.gy];return 0<this.duration&&e.push(this.duration),e}}),e.Dialogue=t.extend({init:function(e,t){this.id=e.id,this.langcode=t},serialize:function(){return[s.Messages.SC_DIALOGUE,this.id,this.langcode]}})},{"../shared/js/gametypes":167,"./lib/class":104,"./utils":146,underscore:75}],112:[function(i,e,t){var r=i("underscore"),n=i("./lib/class").Class.extend({init:function(e){var t=this;this.config=e,this.client=new(i("memcache").Client)(e.memcached_port,e.memcached_host),this.client.connect(),this.isReady=!1,this.client.on("connect",function(){console.info("Metrics enabled: memcached client connected to "+e.memcached_host+":"+e.memcached_port),t.isReady=!0,t.readyCallback&&t.readyCallback()})},ready:function(e){this.readyCallback=e},updatePlayerCounters:function(e,n){var s=this,t=this.config,a=r.size(t.game_servers),e=r.reduce(e,function(e,t){return e+t.playerCount},0);this.isReady?this.client.set("player_count_"+t.server_name,e,function(){var i=0;r.each(t.game_servers,function(e){s.client.get("player_count_"+e.name,function(e,t){t=t?parseInt(t,10):0;i+=t,0===--a&&s.client.set("total_players",i,function(){n&&n(i)})})})}):console.error("Memcached client not connected")},updateWorldDistribution:function(e){this.client.set("world_distribution_"+this.config.server_name,e)},updateWorldCount:function(){this.client.set("world_count_"+this.config.server_name,this.config.nb_worlds)},getOpenWorldCount:function(i){this.client.get("world_count_"+this.config.server_name,function(e,t){i(t)})},getTotalPlayers:function(i){this.client.get("total_players",function(e,t){i(t)})}});e.exports=n},{"./lib/class":104,memcache:void 0,underscore:75}],113:[function(e,t,i){var s=e("underscore"),n=e("./character"),a=(e("./chestarea"),e("./message")),r=e("./mobarea"),o=e("./mobdata"),l=(e("./mobspeech"),e("./items")),h=e("./itemlootdata"),c=e("./utils"),u=e("../shared/js/itemtypes");t.exports=Mob=n.extend({init:function(e,t,i,n,s,a){this._super(e,Types.EntityTypes.MOB,t,i,n,s),this.data=o.Kinds[this.kind],0<this.data.level?this.level=this.data.level:this.level=a?c.randomRangeInt(Math.max(this.data.minLevel,a.minLevel),Math.min(this.data.maxLevel,a.maxLevel)):c.randomRangeInt(this.data.minLevel,this.data.maxLevel);e=Number(i),t=Number(n);this.spawnX=e,this.spawnY=t,this.stats.attack=this.data.attack*this.level,this.stats.defense=this.data.defense*this.level,this.stats.hp=Math.max(this.data.hp*this.level-40,1),this.stats.hpMax=this.stats.hp,this.stats.ep=this.data.ep*this.level,this.stats.epMax=this.stats.ep,this.stats.xp=this.data.xp*this.level,this.mod={attack:0,defense:0,damage:0,health:0},this.hatelist=[],this.hateCount=0,this.damageCount={},this.respawnTimeout=null,this.returnTimeout=null,this.isDead=!1,this.aggroRange=this.data.aggroRange,this.attackRange=this.data.attackRange*G_TILESIZE,this.isAggressive=this.data.isAggressive,this.moveSpeed=this.data.moveSpeed,this.setMoveRate(this.moveSpeed),this.setAttackRate(this.data.attackRate),this.setAggroRate(this.data.reactionDelay>>2),this.setMoveAI(c.randomRangeInt(50,150)),this.setItemLoot(),this.setDrops(),this.spawnDelay=this.data.respawn,this.canCall=!0,this.orientation=c.randomOrientation(),this.isReturning=!1,this.target=null,this.droppedItem=!1,this.isBlocking=!1,this.freeze=!1,this.aiState=mobState.IDLE,this.effects={}},setMoveAI:function(e){this.moveAICooldown=new Timer(e)},canMoveAI:function(){return this.moveAICooldown.isOver()},resetMoveAI:function(e){this.moveAICooldown.lastTime=e},setAggroRate:function(e){this.aggroCooldown=new Timer(e)},canAggro:function(){return this.aggroCooldown.isOver()},resetAggro:function(e){this.aggroCooldown.lastTime=e},awardExp:function(){var n=this;s.each(this.attackers,function(e){var t=n.damageCount[e.id],t=(n.on_killed_callback&&n.on_killed_callback(e,t),~~(n.stats.xp*(t/n.stats.hpMax))),i=1.1+.1*c.clamp(-10,10,n.level-e.level.base);e.incExp(t=~~(t*i)),e.type==Types.EntityTypes.PLAYER&&e.map.entities.pushToPlayer(e,new a.Kill(n,e.level.base,t))}),this.damageCount={}},onKilled:function(e){this.on_killed_callback=e},onDamage:function(e,t,i,n,s){var a=this.stats.hp,r=t/this.stats.hpMax,r=(log.info("dmgRatio: "+r),!this.isMoving()&&.25<=r&&(this.forceStop(),this.setFreeze(2e3,function(e){e.attackTimer=Date.now()})),this._super(e,t,i,n,s),a-this.stats.hp);0<r&&(console.info("onDamage hpMod:"+t),this.damageCount.hasOwnProperty(e.id)||(this.damageCount[e.id]=0),this.damageCount[e.id]+=r)},destroy:function(){this.isDead=!0,this.forgetEveryone(),this.clearTarget(),this.resetBars(),this.resetPosition(),this.handleRespawn()},resetBars:function(){this.stats.hp=this.stats.hpMax,this.stats.ep=this.stats.epMax},hates:function(t){return s.any(this.hatelist,function(e){return e.entity===t})},increaseHateFor:function(t,e){this.hates(t)?s.detect(this.hatelist,function(e){return e.entity===t}).hate+=e:this.hatelist.push({entity:t,hate:e}),this.returnTimeout&&(clearTimeout(this.returnTimeout),this.returnTimeout=null)},getMostHated:function(e){var t=s.sortBy(this.hatelist,function(e){return e.hate});s.size(this.hatelist);return t&&t[0]?t[0].entity:null},forgetPlayer:function(t){this.hatelist=s.reject(this.hatelist,function(e){return e.entity.id===t}),0===this.hatelist.length&&this.returnToSpawn()},forgetEveryone:function(){this.hatelist=[],this.damageCount={},this.clearAttackerRefs(),this.removeAttackers()},handleRespawn:function(){var e=this;this.area&&this.area instanceof r?this.area.respawnMob(this,this.spawnDelay):setTimeout(function(){e.respawnMob(),e.respawnCallback&&e.respawnCallback()},this.spawnDelay)},onRespawn:function(e){this.respawnCallback=e,this.hasTalked=!1},respawnMob:function(){this.forceStop(),this.forgetEveryone(),this.disengage(),this.removeAttackers(),this.isDead=!1,this.droppedItem=!1,this.setAiState(mobState.IDLE),this.map.entities.pushNeighbours(this,new a.Spawn(this))},resetPosition:function(){this.setPosition(this.spawnX,this.spawnY)},returnToSpawn:function(){if(this.aiState!=mobState.RETURNING)if(this.setAiState(mobState.RETURNING),this.forceStop(),this.hasTarget()&&this.clearTarget(),this.forgetEveryone(),this.freeze=!1,this.x==this.spawnX&&this.y==this.spawnY)this.returnedToSpawn();else if(this.go(this.spawnX,this.spawnY),console.warn("returnToSpawn - Path: "+JSON.stringify(this.path)),this.path&&0!=this.path.length){var e=this.map.entities.pathfinder.getPathTicks(this.path,this.spawnX,this.spawnY),e=Math.max(0,~~(e/this.tick*G_UPDATE_INTERVAL));console.info("returnToSpawn.delay = "+e),console.info("id="+this.id+",x="+this.spawnX+",y="+this.spawnY),setTimeout(function(){console.info("st - id="+this.id+",x="+this.spawnX+",y="+this.spawnY),this.returnedToSpawn()}.bind(this),e)}else{try{throw new Error}catch(e){console.error(e.stack)}this.returnedToSpawn()}},onMove:function(e){this.moveCallback=e},move:function(e,t){this.setPosition(e,t),this.orientation=c.getOrientationFromLastMove(this),this.moveCallback&&this.moveCallback(this)},distanceToPos:function(e,t){return c.distanceTo(this.x,this.y,e,t)},setItemLoot:function(){for(var e in this.loot={},this.lootTotal=0,h.ItemLoot){var t=h.ItemLoot[e],t=~~(1e3/t.rarity*t.rarity);0<t&&(this.loot[e]=t),this.lootTotal+=this.loot[e]}this.lootTotal=~~this.lootTotal},setDrops:function(){this.drops={};Math.ceil(this.level/10);for(var e in l.Kinds){var t=l.Kinds[e];t&&1!=t.legacy&&(t=t.level-this.level,u.isEquipment(e))&&(0<=t&&t<5&&(this.drops[e]=1),-5<=t&&t<0&&(this.drops[e]=2),-10<=t)&&t<-5&&(this.drops[e]=5)}15<=this.level&&this.level<25&&(this.drops[310]=250),25<=this.level&&this.level<35&&(this.drops[311]=250),35<=this.level&&this.level<45&&(this.drops[312]=250),45<=this.level&&(this.drops[313]=250),this.level<20?this.drops[34]=250:this.drops[36]=250},Speech:function(e,t){return null},getState:function(){return this._getBaseState().concat([this.level,this.stats.hp,this.stats.hpMax])},setAiState:function(e){this.aiState=e},die:function(){console.info("Entity is dead"),this.isDead=!0,this.map.entities.pushBroadcast(this.despawn()),this.awardExp(),this.destroy()},baseCrit:function(){var e=this.stats.attack+this.mod.attack;return~~c.clamp(5,500,~~(e+0))},baseCritDef:function(){var e=this.stats.defense+this.mod.defense;return~~c.clamp(5,500,~~(e+0))},baseDamage:function(){var e=~~(5*this.level);return~~(e+=(this.stats.attack+this.mod.attack)*(5-Math.min(3,.1*this.level)))},baseDamageDef:function(){var e=~~(2*this.level);return~~(e+=2*(this.stats.defense+this.mod.defense))},canReach:function(e){var t=this.orientation,e=(this.lookAtEntity(e),this._super(e));return this.orientation=t,e},dropGold:function(){return c.randomRangeInt(2*this.level,3*this.level)},returnedToSpawn:function(){console.info("mob.returnedToSpawn"),this.forceStop(),this.resetHP(),this.setAiState(mobState.IDLE),this.resetPosition()}}),t.exports=Mob},{"../shared/js/itemtypes":168,"./character":85,"./chestarea":88,"./itemlootdata":99,"./items":101,"./message":111,"./mobarea":115,"./mobdata":117,"./mobspeech":118,"./utils":146,underscore:75}],114:[function(e,t,i){e("./message"),e("underscore");var n=e("./utils"),s=e("./formulas");t.exports=MobAI=Class.extend({init:function(e,t){this.world=this.server=this.worldServer=e,this.map=t},checkHitAggro:function(e,t){e.isDead||e.isStunned||e.isAttacking()||e.aiState!==mobState.IDLE||e.hasTarget()||e.isAttackedBy(t)&&this.aggroPlayer(e,t)},checkAggro:function(e){var t;if(!(e.isDead||e.isStunned||e.isAttacking())&&e.isAggressive&&(e.aiState==mobState.IDLE&&!e.hasTarget()))for(t of this.map.entities.getPlayerAround(e,e.aggroRange))t.isDead||t.freeze||2*e.level>=t.level.base&&this.aggroPlayer(e,t)},aggroPlayer:function(e,t,i){var n=this.worldServer;e.resetAggro(0),e.attackingMode=!0,n.handleMobHate(e,t,1),n.createAttackLink(e,t),e.setAiState(mobState.AGGRO),e.attackTimer=Date.now()},checkHit:function(e){e.isStunned||!e.target||e.freeze||(e.aiState===mobState.FIRSTATTACK?e.setFreeze(e.data.reactionDelay,function(){e.setAiState(mobState.ATTACKING)}):e.canReach(e.target)?e.aiState===mobState.ATTACKING&&e.canAttack()&&(console.info("mob - Is Attacking"),this.handleHurt(e)):e.setAiState(mobState.CHASING))},update:function(){for(var e in this.map.entities.mobs){e=this.map.entities.mobs[e];if(!e.isDead){if(e.aiState==mobState.RETURNING)return;e.canAggro()&&this.checkAggro(e),e.hasTarget()&&(this.checkChase(e),this.checkHit(e))}}},checkChase:function(e){var t=e.target;e.freeze||t.isDead||t.isDying||(e.aiState===mobState.IDLE&&e.setAiState(mobState.AGGRO),e.aiState!==mobState.AGGRO&&e.aiState!==mobState.CHASING)||(e.canReach(t)?e.isMovingPath()||(e.isOverlapping()?e.follow(t):(e.forceStop(),console.info(e.id+" within range"),e.setAiState(mobState.FIRSTATTACK))):e.isMovingPath()||!t.isMoving()&&e.ptx==e.target.x&&e.pty==e.target.y||(e.isMoving()&&t.isMoving()?console.info(e.id+" monster and target is moving so abort."):!e.canMoveAI()||this.checkReturn(e)||(e.follow(t),e.setAiState(mobState.CHASING),e.setMoveAI(n.randomRangeInt(25,50)),e.ptx=t.x,e.pty=t.y,e.path)||e.returnToSpawn()))},handleHurt:function(e){var t;!e.target||e.freeze||e.target.isInvincible||(console.info("handleHurt."),e&&0<e.target.stats.hp&&e instanceof Mob&&(e.lookAt(e.target),console.info("handleHurt - mob"),t=s.dmg(e,e.target,e.attackTimer),s.crit(e,e.target)&&(t*=2,e.criticalHit=!1),e.target.stats.hp-=t,e.target.stats.hp<=0&&(e.target.isDead=!0),console.info("handleHurtEntity"),this.server.handleDamage(e.target,e,-t,e.criticalHit),this.server.handleHurtEntity(e.target,e),e.attackTimer=Date.now()))},checkReturn:function(e){var t;return(e.aiState===mobState.CHASING||e.aiState===mobState.STUCK||e.aiState===mobState.ROAMING)&&((t=e.target)&&(t.isDying||t.isDead)?(e.returnToSpawn(),!0):e.distanceToPos(e.spawnX,e.spawnY)>=24*G_TILESIZE||t&&e.distanceToPos(t.x,t.y)>=12*G_TILESIZE?(console.info("RETURN TO SPAWN!"),e.returnToSpawn(),!0):void 0)}})},{"./formulas":96,"./message":111,"./utils":146,underscore:75}],115:[function(e,t,i){var n=e("./area"),s=(e("underscore"),e("./mobdata")),o=(e("./message"),e("../shared/js/gametypes"),e("./utils"));t.exports=MobArea=n.extend({init:function(e,t,i,n,s,a,r,o,l,h,c,u,p,m,d,f){this._super(e,s,a,r,o,u,p,m),this.nb=t,this.minLevel=i,this.maxLevel=n,this.respawns=[],this.map=u,this.sMinLevel=d,this.sMaxLevel=f,this.include=null,"string"==typeof l&&(this.include=l.split(",")),this.exclude=null,"string"==typeof h&&(this.exclude=h.split(",")),this.setNumberOfEntities(this.nb),this.definite=null,c&&(this.definite=c)},addMobs:function(e){if(this.mobs=[],this.definite)for(var t in this.definite)this.mobs.push(s.Kinds[this.definite[t]]);else{for(var t in e&&(this.minLevel=this.sMinLevel?e+this.sMinLevel:this.minLevel,this.maxLevel=this.sMaxLevel?e+this.sMaxLevel:this.maxLevel),levelMobs=s.getByLevelRange(this.minLevel,this.maxLevel),this.mobs=this.mobs.concat(levelMobs),this.include)this.mobs.push(s.Kinds[this.include[t]]);for(var i=this.mobs.length;0<=--i;)for(var n in this.exclude)if(this.mobs[i].kind==this.exclude[n]){this.mobs.splice(i,1);break}}},spawnMobs:function(){for(var e=0;e<this.nb;++e)this.addToArea(this._createRandomMobInsideArea(),this.exclude)},_createMob:function(e){var t=this,i=t.map.entities.spaceEntityRandomApart(2,t._getRandomPositionInsideArea.bind(t,100));return i?(e=t.map.entities.addMob(e,i.x,i.y,this),t.addToArea(e),e):null},_createRandomMobInsideArea:function(){var e=0;if(!this.mobs||0==this.mobs.length)return null;if(1==this.mobs.length)return this._createMob(this.mobs[0].kind);var t=0,i=this.mobs.length;if(0==i)return console.warn("mobs length == 0 aborting create."),null;for(var n=0;n<i;++n){for(var s=0;s<this.mobs[n].spawnChance;++s)n*i+s,this.mobs[n].kind;t+=this.mobs[n].spawnChance}for(var a,e=0,r=o.randomInt(t-1),n=0;n<this.mobs.length;++n){if(r<=(a=this.mobs[n].spawnChance)){e=this.mobs[n].kind;break}r-=a}return 0==e?(console.info("this.mobs="+JSON.stringify(this.mobs)),console.warn("mob kind == 0 aborting create."),null):this._createMob(e)},respawnMob:function(i,e){var n=this;e=i.spawnDelay||e,this.removeFromArea(i),setTimeout(function(){var e=n.map.entities.spaceEntityRandomApart(1,n._getRandomPositionInsideArea.bind(n,20)),t=e.x,e=e.y;i.spawnX=i.x=t,i.spawnY=i.y=e,i.respawnMob()},e)},isNextTooEntity:function(e,t){t=t||G_TILESIZE;for(var i of this.entities)if(Math.abs(e.x-i.x)<G_TILESIZE&&Math.abs(e.y-i.y)<G_TILESIZE)return!0;return!1},Roaming:function(){G_TILESIZE}})},{"../shared/js/gametypes":167,"./area":80,"./message":111,"./mobdata":117,"./utils":146,underscore:75}],116:[function(e,t,i){var a=e("./message");e("underscore"),e("./utils"),e("./formulas"),e("./chest");t.exports=MobCallback=Class.extend({init:function(e,t){this.world=this.worldServer=e,this.map=t},setCallbacks:function(n){var s=this;n.onRespawn(function(){n.isDead=!1,n.droppedItem=!1,s.addMob(mob),n.area&&n.area instanceof ChestArea&&mob.area.addToArea(n)}),n.onStep(function(e,t){}),n.onRequestPath(function(e,t){var i=[n],e=(n.target&&i.push(n.target),s.map.entities.findPath(n,e,t,i));return e&&1==e.length&&console.error(n.id+" "+JSON.stringify(e)),e&&1<e.length?(n.orientation=n.getOrientationTo({x:e[1][0],y:e[1][1]}),t=new a.MovePath(n,e),s.map.entities.pushNeighbours(n,t),e):null}),n.onStopPathing(function(e,t){n.hasTarget()||n.setAiState(mobState.IDLE),n.aiState==mobState.CHASING&&n.mobAI.checkReturn(n,e,t)}),n.onStartPathing(function(){}),n.onAbortPathing(function(){msg=new a.Move(n,n.orientation,2,n.x,n.y),s.map.entities.pushNeighbours(n,msg),n.target||n.setAiState(mobState.IDLE)})}})},{"./chest":87,"./formulas":96,"./message":111,"./utils":146,underscore:75}],117:[function(e,t,i){var n=e("underscore"),e=e("../shared/data/mobs.json"),s={},a={};n.each(e,function(e,t){s[t.toLowerCase()]={key:t.toLowerCase(),kind:e.kind,attack:e.attackMod?3*e.attackMod:3,defense:e.defenseMod?3*e.defenseMod:3,hp:e.hpMod?150*e.hpMod:150,xp:e.xpMod?10*e.xpMod:10,level:e.level||0,minLevel:e.minLevel||0,maxLevel:e.maxLevel||0,aggroRange:e.aggroRange?e.aggroRange+1:4,attackRange:e.attackRange||1,isAggressive:1==e.isAggressive,attackRate:e.attackRateMod?1500*e.attackRateMod:1500,reactionDelay:e.reactionMod?512*e.reactionMod:512,moveSpeed:e.moveSpeedMod?~~(300+200*e.moveSpeedMod):500,respawn:e.respawnMod?3e4*e.respawnMod:3e4,dropRate:e.dropRate||1,spawnChance:e.spawnChance||50,dropBonus:e.dropBonus||0,drops:e.drops||null},a[e.kind]=s[t.toLowerCase()]});t.exports.Properties=s,t.exports.Kinds=a,t.exports.isMob=function(e){return!!a[e]},t.exports.forEachMobKind=function(e){for(var t in MobKinds)e(MobKinds[t][0],t)},t.exports.getByLevelRange=function(e,t){for(var i in levelRange=[],a){i=a[i];(0<i.level&&i.level>=e&&i.level<=t||0<i.minLevel&&0<i.maxLevel&&(e>=i.minLevel&&e<=i.maxLevel||t>=i.minLevel&&t<=i.maxLevel))&&levelRange.push(i)}return levelRange}},{"../shared/data/mobs.json":156,underscore:75}],118:[function(e,t,i){var n=e("underscore"),e=e("../shared/data/mobs_speech.json"),s={};n.each(e,function(e,t){s[t]=e}),t.exports.Speech=s},{"../shared/data/mobs_speech.json":157,underscore:75}],119:[function(e,t,i){var n=e("./entity"),s=(e("./utils"),e("./message")),e=n.extend({init:function(e,t,i,n,s,a,r){this._super(e,Types.EntityTypes.NODE,t,i,n,s),this.stats={},this.level=a,this.setDrops(),this.spawnDelay=6e4,this.spriteName="nodeset"+t,this.animName="node"+r},getState:function(){return this._getBaseState().concat([this.level,this.spriteName,this.animName,this.weaponType])},onDeath:function(e){this.death_callback=e},die:function(){this.isDead=!0,this.map.entities.pushNeighbours(this,new s.Despawn(this)),this.handleRespawn(),this.death_callback&&this.death_callback()},setDrops:function(){this.drops={},2==this.kind&&(1==this.level&&(this.drops[301]=2e3),2==this.level&&(this.drops[302]=2e3),3==this.level?this.drops[303]=2e3:this.drops[304]=2e3)},respawn:function(){this.isDead=!1,this.map.entities.pushNeighbours(this,new s.Spawn(this))},handleRespawn:function(){var e=this;this.area&&this.area instanceof Area?this.area.respawn(this,this.spawnDelay):setTimeout(function(){e.respawn(),e.respawnCallback&&e.respawnCallback()},this.spawnDelay)}});t.exports=e},{"./entity":91,"./message":111,"./utils":146}],120:[function(e,t,i){var n=e("underscore"),e=e("../shared/data/notifications.json"),s={},a=0;n.each(e,function(e,t){s[a++]={textid:e.textid,interval:e.interval}}),t.exports.Notifications=s},{"../shared/data/notifications.json":158,underscore:75}],121:[function(e,t,i){var n=e("underscore"),s=e("../shared/data/npcs.json"),e=(e("../shared/data/npc_english.json"),e("../shared/data/npc_names_eng.json")),a={},r=s;n.each(r,function(e,t){a[e.uid]={uid:e.uid,kind:t,name:e.name||e.uid}});t.exports.Properties=a,t.exports.Kinds=r,t.exports.isNpc=function(e){return!!r[e]},t.exports.NPCnames=e},{"../shared/data/npc_english.json":159,"../shared/data/npc_names_eng.json":161,"../shared/data/npcs.json":162,underscore:75}],122:[function(e,t,i){e("./entity"),e("./appearancedata");var c=e("../shared/js/gametypes"),u=(e("../shared/js/itemtypes"),e("./utils")),p=e("./mobdata"),m=(e("./npcdata"),e("./itemlootdata")),a=e("./message"),r=e("./npcmovecontroller"),d=(e("./langdata"),e("./player"),e("./quest")),o=e("./questdata"),l=e("../shared/data/npc_names.json"),e=Character.extend({init:function(e,t,i,n,s){if(this._super(e,c.EntityTypes.NPCMOVE,t,i+=8,n+=8,s),this.armor=0,this.weapon=0,this.gender=t%2,this.setMoveRate(350),this.name=l[t%41],this.activeController=new r(this),this.scriptQuests=!1,this.questCount=0,this.quests={},this.questId=this.kind,o.NpcData.hasOwnProperty(this.kind)){e=o.NpcData[this.kind];if(e&&0<e.length){var a;for(a of e)this.quests[a.id]=a}}},getState:function(){return this._getBaseState().concat([this.questId])},acceptQuest:function(e,t){var i;this.quests.hasOwnProperty(t)&&(i=this.quests[t],(pQuest=e.getQuestById(parseInt(t)))&&pQuest.status<QuestStatus.COMPLETE?(pQuest.status=QuestStatus.INPROGRESS,e.progessQuest(pQuest)):(pQuest=Object.assign(new d,i),e.foundQuest(pQuest)))},rejectQuest:function(e,t){},hasQuest:function(e){for(var t of e.quests)if(this.questId==t.npcQuestId)return e.progressQuest(t),!0;for(var i in this.quests){t=this.quests[i];if(e.hasNpcCompleteQuest(t.npcQuestId))return this.sendNoQuest(e),!0}return!1},dynamicQuests:function(e){this.hasQuest(e)||this.createQuest(e)},sendNoQuest:function(e){var t="QUESTS_NONE";0<Object.keys(this.quests).length&&(t="QUESTS_NONE_"+this.kind),this.map.entities.pushToPlayer(e,new a.Dialogue(this,t))},talk:function(e){for(var t of e.quests)if(t.type==QuestType.GETITEMKIND&&e.questAboutItemComplete(t,null))return;if(0==Object.keys(this.quests).length)this.dynamicQuests(e);else{var i=-1;if(!this.hasQuest(e)){for(var n in this.quests){var s=e.getQuestById(n);if(!s){i=n;break}}-1==i?this.sendNoQuest(e):this.map.entities.pushToPlayer(e,new a.Dialogue(this,"DIALOGUE_"+i))}}},createQuest:function(e){function t(){var e=n.map.entities.getMobsAround(n,35);if(0!=e.length){var t=u.GetGroupCountArray(e,"kind");if(console.warn("entitycount="+JSON.stringify(t)),0==t.length)return null;log.info("entitycount="+JSON.stringify(t)),t.sort(function(e,t){return t[1]-e[1]}),log.info("entitycount="+JSON.stringify(t));var i=parseInt(t[0][0]),e=e.filter(function(e){return e.kind==i}),e=u.minProp(e,"level").level,t=parseInt(t[0][1]);return t<=0?null:p.Kinds[i]?getQuestObject([c.EntityTypes.MOB,i,t,0,e,100]):null}}var i=[1,2],i=i[u.randomInt(i.length-1)],n=(e.level.base,this);if(i==QuestType.GETITEMKIND){console.info("GETITEMKIND");var s,a,r=u.randomInt(m.ItemLoot.length-1),o="02"+u.pad(this.kind,6)+u.pad(this.questCount++,4);if(s=e.getQuestById(o))s.status=QuestStatus.INPROGRESS,e.questAboutItem(s);else{if(!(a=t()))return;a.count=0;var l=u.randomRangeInt(1,5),h=30*l/(e.level.base+2),r=getQuestObject([c.EntityTypes.ITEMLOOT,r,l,h]);s=new d([o,QuestType.GETITEMKIND,this.questId,0,0,0,0,a,r]),e.foundQuest(s)}}i==QuestType.KILLMOBKIND&&(console.info("KILLMOBKIND"),o="01"+u.pad(this.kind,6)+u.pad(this.questCount++,4),(s=e.getQuestById(o))?(s.status=QuestStatus.INPROGRESS,e.progressQuest(s)):(a=t())&&(l=Math.max(e.level.base-10,10),a.count=u.clamp(5,l,a.count/2),a.count=5*Math.ceil(a.count/5),s=new d([o,QuestType.KILLMOBKIND,this.questId,0,0,0,0,a]),e.foundQuest(s)))}});t.exports=e},{"../shared/data/npc_names.json":160,"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./appearancedata":79,"./entity":91,"./itemlootdata":99,"./langdata":102,"./message":111,"./mobdata":117,"./npcdata":121,"./npcmovecontroller":123,"./player":128,"./quest":131,"./questdata":132,"./utils":146}],123:[function(e,t,i){var n=e("./message"),s=(e("underscore"),e("./utils"));t.exports=NpcMoveController=Class.extend({init:function(e){this.entity=e,this.setCallbacks()},setCallbacks:function(){var i=this;i.entity.onStep(function(t,i,n){try{t.map.entities.entitygrid[t.y][t.x]=0,t.map.entities.entitygrid[n][i]=1}catch(e){console.info(e.stack),console.info(t.x+","+t.y+","+i+","+n),console.info(t.id),console.info(t.path),console.info(t.step)}}),i.entity.onRequestPath(function(e,t){e=i.entity.map.entities.findPath(i.entity,e,t);return e&&0<e.length?(t=new n.MovePath(i.entity,e),i.entity.map.entities.pushNeighbours(i.entity,t),e):null})},randomMove:function(){var e,t=this.entity;!t||t.hasTarget()||t.isDead||t.isMoving()||1!==s.randomRangeInt(0,100)||0==t.map.entities.getPlayerAroundCount(t,20)||!(e=t.map.entities.getRandomPosition(t,2))||e.x==t.x&&e.y==t.y||t.go(e.x,e.y)},checkMove:function(e){var t=this.entity;t.isDead||!t.freeze&&t.isMoving()&&t.canMove()&&t.nextStep()}})},{"./message":111,"./utils":146,underscore:75}],124:[function(e,t,i){var n=e("./entity"),e=(e("./player"),e("./questdata"),e("./npcdata"),e("./utils"),e("./message"),n.extend({init:function(e,t,i,n,s){i+=8,n+=8,this._super(e,Types.EntityTypes.NPCSTATIC,t,i,n,s),this.map=s},talk:function(e){if(console.info("talk"),console.info("kind: "+this.kind),44==this.kind){if(console.info("THIS IS FOR COLLECTING ITEMS NPC."),e.questStatus)for(var[t,i]of Object.entries(e.questStatus))console.info("questStatus"+JSON.stringify(i)),1==i.type&&i.count<=i.objectCount&&e.questAboutItem(i,null)}else for(var n in e.quests)if(n.npcKind==this.kind)return}}));t.exports=e},{"./entity":91,"./message":111,"./npcdata":121,"./player":128,"./questdata":132,"./utils":146}],125:[function(e,t,i){e("./lib/class"),e("underscore"),e("./character"),e("./chest");var l=e("./message"),r=e("./utils"),a=(e("./mobdata"),e("./formulas")),o=e("./format").check,h=(e("./party"),e("./items")),c=(e("./bank"),e("../shared/js/gametypes")),u=e("../shared/js/itemtypes"),p=(e("bcrypt"),e("./inventory"),e("./mob")),n=(e("./node"),e("./skillhandler"),e("./trade"),e("express")),s=(e("body-parser"),n(),e("./questdata"),e("./skilldata")),m=(e("./entityspawn"),e("./appearancedata"));e("./taskhandler");t.exports=PacketHandler=Class.extend({init:function(e,t,i,n,s,a){this.user=e,this.main=t,this.player=i,this.connection=n,this.server=s,this.map=i.map,this.entities=i.map.entities;var r=this;this.connection.listen(function(e){console.info("recv="+JSON.stringify(e));var t=parseInt(e[0]);if(o(e))switch(e.shift(),t){case c.Messages.BI_PLAYERINFO:r.handlePlayerInfo(e);break;case c.Messages.CS_WHO:r.handleWho(e);break;case c.Messages.CS_CHAT:r.handleChat(e);break;case c.Messages.CS_MOVE:r.handleMoveEntity(e);break;case c.Messages.CS_MOVEPATH:r.handleMovePath(e);break;case c.Messages.CS_ATTACK:r.handleAttack(e);break;case c.Messages.CS_ITEMSLOT:r.handleItemSlot(e);break;case c.Messages.CS_STORESELL:r.handleStoreSell(e);break;case c.Messages.CS_STOREBUY:r.handleStoreBuy(e);break;case c.Messages.CS_CRAFT:r.handleCraft(e);break;case c.Messages.CS_APPEARANCEUNLOCK:r.handleAppearanceUnlock(e);break;case c.Messages.CS_LOOKUPDATE:r.handleLookUpdate(e);break;case c.Messages.CS_AUCTIONSELL:r.handleAuctionSell(e);break;case c.Messages.CS_AUCTIONBUY:r.handleAuctionBuy(e);break;case c.Messages.CS_AUCTIONOPEN:r.handleAuctionOpen(e);break;case c.Messages.CS_AUCTIONDELETE:r.handleAuctionDelete(e);break;case c.Messages.CS_STOREENCHANT:r.handleStoreEnchant(e);break;case c.Messages.CS_STOREREPAIR:r.handleStoreRepair(e);break;case c.Messages.CS_CHARACTERINFO:r.entities.pushToPlayer(r.player,new l.CharacterInfo(r.player));break;case c.Messages.CS_TELEPORT_MAP:r.handleTeleportMap(e);break;case c.Messages.CS_LOOT:r.handleLoot(e);break;case c.Messages.CS_TALKTONPC:r.handleTalkToNPC(e);break;case c.Messages.CS_QUEST:r.handleQuest(e);break;case c.Messages.CS_PLAYER_REVIVE:r.handleRevive(e);break;case c.Messages.CS_GOLD:r.handleGold(e);break;case c.Messages.CS_STATADD:r.handleStatAdd(e);break;case c.Messages.CS_SKILL:r.handleSkill(e);break;case c.Messages.CS_SKILLINSTALL:r.handleSkillInstall(e);break;case c.Messages.BI_BLOCK_MODIFY:r.handleBlock(e);break;case c.Messages.CS_PARTY:r.handleParty(e);break;case c.Messages.BI_HARVEST:r.handleHarvest(e);break;case c.Messages.CS_USE_NODE:r.handleUseNode(e);break;default:r.message_callback&&r.player.message_callback(e)}else r.connection.close("Invalid "+c.getMessageTypeAsString(t)+" message format: "+e)}),this.connection.onClose(function(){console.info("Player: "+r.player.name+" has exited the world."),r.player.user.loadedPlayer&&r.player.save(),players[r.player.name]&&(players[r.player.name]=0),r.player&&r.entities&&(console.info("deleting player connection"),r.entities.removePlayer(r.player)),delete r.player,r.user.onClose(!0),console.info("onClose - called"),clearTimeout(this.disconnectTimeout),this.exit_callback&&this.exit_callback(),this.close("onClose")})},setMap:function(e){this.map=e,this.entities=e.entities},timeout:function(){this.connection.sendUTF8("timeout"),this.connection.close("Player was idle for too long")},broadcast:function(e,t){this.broadcast_callback&&this.broadcast_callback(e,void 0===t||t)},broadcastToZone:function(e,t){this.broadcastzone_callback&&this.broadcastzone_callback(e,void 0===t||t)},sendPlayer:function(e){this.map.entities.pushToPlayer(this.player,e)},onExit:function(e){this.exit_callback=e},onMove:function(e){this.move_callback=e},onMessage:function(e){this.message_callback=e},onBroadcast:function(e){this.broadcast_callback=e},handleChat:function(e){e=r.sanitize(e[0]);console.info("Chat: "+this.player.name+": "+e),(new Date).getTime()>this.player.chatBanEndTime?this.send([c.Messages.SC_NOTIFY,"CHAT","CHATMUTED"]):!e||""===e&&" "===e||("/w"===(e=e.substr(0,256)).split(" ",3)[0]?this.send([c.Messages.SC_NOTIFY,"CHAT","CHATMUTED"]):this.server.pushWorld(new l.Chat(this.player,e)))},handleQuest:function(e){console.info("handleQuest");var t=parseInt(e[0]),i=parseInt(e[1]),e=parseInt(e[2]);npc.isNextTooEntity(this.player)?(npc=this.entities.getEntityById(t),1==e?npc.acceptQuest(this.player,i):npc.rejectQuest(this.player,i)):console.info("player not close enough to NPC!")},handleTalkToNPC:function(e){console.info("handleTalkToNPC");parseInt(e[0]);e=parseInt(e[1]);(npc=this.entities.getEntityById(e)).isNextTooEntity(this.player)?npc&&npc.talk(this.player):console.info("player not close enough to NPC!")},handleStoreSell:function(e){parseInt(e[0]);var t,e=parseInt(e[1]),i=this.player.itemStore[0].rooms[e];i&&(this.player.tut.buy=!0,this.player.tut.buy2=!0,t=i.itemKind,u.isConsumableItem(t)||u.isLootItem(t)||(t=u.getEnchantSellPrice(i))<0||(i=i.itemKind,this.player.inventory.makeEmptyItem(e),this.player.modifyGold(t),e=u.KindData[i].name,this.sendPlayer(new l.Notify("SHOP","SHOP_SOLD",[e]))))},handleAuctionSell:function(e){var t,i,n=parseInt(e[0]),e=parseInt(e[1]);e<0||n<0||n>=this.player.inventory.maxNumber||(t=this.player.inventory.rooms[n],console.info(JSON.stringify(t)),i=t.itemKind,u.isConsumableItem(i))||u.isLootItem(i)||i&&(this.server.auction.add(this.player,t,e,n),this.server.auction.list(this.player,0),this.player.inventory.setItem(n,null))},handleAuctionOpen:function(e){e=parseInt(e[0]);0<=e&&e<=3&&this.server.auction.list(this.player,e)},handleAuctionBuy:function(e){var t,i,n,s=parseInt(e[0]);s<0||s>=this.server.auction.auctions.length||!(t=this.server.auction.auctions[s])||t.playerName==this.player.name||(e=parseInt(e[1]))<0||3<e||(i=t.price)<0||(this.player.gold[0]<i?this.sendPlayer(new l.Notify("SHOP","SHOP_NOGOLD")):this.player.inventory.hasRoom()?(n=t.item.itemKind,this.player.inventory.putItem(t.item),this.player.modifyGold(-i),n=u.KindData[n].name,this.sendPlayer(new l.Notify("SHOP","SHOP_SOLD",[n])),(n=this.server.getPlayerByName(t.playerName))?n.modifyGold(i):databaseHandler.modifyGold(t.playerName,i),this.server.auction.remove(s),this.server.auction.list(this.player,e)):this.sendPlayer(new l.Notify("SHOP","SHOP_NOSPACE")))},handleAuctionDelete:function(e){var t,i,n=parseInt(e[0]);n<0||n>=this.server.auction.auctions.length||!(i=this.server.auction.auctions[n])||(e=parseInt(e[1]))<0||3<e||(this.player.inventory.hasRoom()?(t=i.item.itemKind,this.player.inventory.putItem(i.item),i=u.KindData[t].name,this.sendPlayer(new l.Notify("SHOP","SHOP_REMOVED",[i])),this.server.auction.remove(n),this.server.auction.list(this.player,e)):this.sendPlayer(new l.Notify("SHOP","SHOP_NOSPACE")))},handleStoreEnchant:function(e){var t,i=parseInt(e[0]),e=parseInt(e[1]);0==i&&6<=e&&e<this.player.inventory.maxNumber&&(t=this.player.inventory.rooms[e],this._enchantItem(i,t,e)),2==i&&0<=e&&e<this.player.equipment.maxNumber&&(t=this.player.equipment.rooms[e])&&this._enchantItem(i,t,e)},handleStoreRepair:function(e){var t,i=parseInt(e[0]),e=parseInt(e[1]);0==i&&6<=e&&e<this.player.inventory.maxNumber&&(t=this.player.inventory.rooms[e])&&this._repairItem(i,t,e),2==i&&0<=e&&e<this.player.equipment.maxNumber&&(t=this.player.equipment.rooms[e])&&this._repairItem(i,t,e)},_repairItem:function(e,t,i){var n,s;t&&t.itemKind&&(!u.isEquipment(t.itemKind)||t.itemDurability==t.itemDurabilityMax||(s=~~u.getRepairPrice(t))<=0||((goldCount=this.player.gold[0])<s?this.sendPlayer(new l.Notify("SHOP","SHOP_NOGOLD")):(n=~~((t.itemDurabilityMax-t.itemDurability)/10),t.itemDurabilityMax-=n,t.itemDurability=t.itemDurabilityMax,t.itemDurabilityMax<=0?(t=null,0==e?this.player.inventory.makeEmptyItem(i):2==e&&this.player.equipment.makeEmptyItem(i)):(console.info("itemNumber="+t.itemNumber),this.player.modifyGold(-s)),t.slot=i,this.sendPlayer(new l.ItemSlot(e,[t])),n=u.KindData[t.itemKind].name,this.sendPlayer(new l.Notify("SHOP","SHOP_REPAIRED",[n])))))},_enchantItem:function(e,t,i){var n;t&&t.itemKind&&(!u.isEquipment(t.itemKind)||(n=u.getEnchantPrice(t))<=0||((goldCount=this.player.gold[0])<n?this.sendPlayer(new l.Notify("SHOP","SHOP_NOGOLD")):(t.itemExperience=u.itemExpForLevel[t.itemNumber-1],t.itemNumber++,t.slot=i,this.sendPlayer(new l.ItemSlot(e,[t])),console.info("itemNumber="+t.itemNumber),this.player.modifyGold(-n),i=u.KindData[t.itemKind].name,this.sendPlayer(new l.Notify("SHOP","SHOP_ENCHANTED",[i])))))},handleBankStore:function(e){var t,e=parseInt(e[0]);6<=e&&e<this.player.inventory.maxNumber&&(t=this.player.inventory.rooms[e])&&t.itemKind&&0<=this.player.bank.getEmptyIndex()&&(this.player.bank.putItem(t),this.player.inventory.takeOutItems(e,t.itemNumber))},handleBankRetrieve:function(e){var t,e=parseInt(e[0]);0<=e&&e<this.player.bank.maxNumber&&(t=this.player.bank.rooms[e])&&t.itemKind&&0<=this.player.inventory.getEmptyIndex()&&(this.player.inventory.putItem(t),this.player.bank.takeOutItems(e,t.itemNumber)),this.sendPlayer(new l.Gold(this.player))},handleStoreBuy:function(e){parseInt(e[0]);var t,i,n=parseInt(e[1]),e=parseInt(e[2]),s=null;!n||e<=0||n<0||n>=u.KindData.length||(s=(t=u.KindData[n]).name,0<(i=u.getBuyPrice(n))&&(u.Store.isBuyMultiple(n)&&(e=t.buycount),this.player.gold[0]<i?this.sendPlayer(new l.Notify("SHOP","SHOP_NOGOLD")):(t=u.isConsumableItem(n))||!t&&this.player.inventory.hasRoom()?(t=new ItemRoom(n,e,0,0),-1==this.player.inventory.putItem(t)||(this.player.modifyGold(-i),this.sendPlayer(new l.Notify("SHOP","SHOP_BUY",[s])),this.player.tut.equip)||this.player.tutChat("TUTORIAL_EQUIP",10,"equip")):this.sendPlayer(new l.Notify("SHOP","SHOP_NOSPACE"))))},handleCraft:function(e){var t=parseInt(e[0]),i=parseInt(e[1]),e=0;if(!(i<=0||t<0||t>=h.CraftData.length)){var t=h.CraftData[t],n=t.o;if(u.KindData.hasOwnProperty(n)){var s=u.KindData[n],a=s.name,e=u.getCraftPrice(n);if(!(e<0))if(i=u.Store.isBuyMultiple(n)?i<s.buycount?i:s.buycount:1,this.player.gold[0]<(e*=i))this.sendPlayer(new l.Notify("SHOP","SHOP_NOGOLD"));else if(0!=s.craft.length){for(var r of t.i)if(!this.player.inventory.hasItems(r[0],r[1]*i))return void this.sendPlayer(new l.Notify("SHOP","SHOP_NOCRAFTITEMS"));if(this.player.inventory.hasRoom()){this.player.modifyGold(-e);for(var r of t.i)this.player.inventory.removeItemKind(r[0],r[1]*i);s=0,e=((u.isWeapon()||u.isArmor())&&(s=900),new ItemRoom(n,i,s,s));-1!=this.player.inventory.putItem(e)&&this.sendPlayer(new l.Notify("SHOP","SHOP_BUY",[a]))}else this.sendPlayer(new l.Notify("SHOP","SHOP_NOSPACE"))}}else console.error("handleCraft - itemData not found for kind: "+n)}},handleAppearanceUnlock:function(e){var t,i,n=parseInt(e[0]),e=parseInt(e[1]);-1==n?this.server.looks.sendLooks(this.player):n<0||n>=m.Data.length||!(t=m.Data[n])||"armorarcher"!=t.type&&"armor"!=t.type||((i=this.server.looks.prices[n])!=e?(this.sendPlayer(new l.Notify("SHOP","SHOP_MISMATCH",[t.name])),this.server.looks.sendLooks(this.player)):(e=0)<=n&&(e=this.player.user.gems,console.info("gemCount="+e),i<=e?(this.player.user.looks[n]=1,this.player.user.modifyGems(-i),this.server.looks.prices[n]+=100,this.sendPlayer(new l.Notify("SHOP","SHOP_SOLD",[t.name])),this.server.looks.sendLooks(this.player)):this.sendPlayer(new l.Notify("SHOP","SHOP_NOGEMS"))))},handleLookUpdate:function(e){var t,i=parseInt(e[0]),e=parseInt(e[1]),n=this.player;e<0||e>=m.Data.length||i<0||1<i||!(t=m.Data[e])||"armorarcher"!=t.type&&"armor"!=t.type||(1==this.player.user.looks[e]&&0==i&&(n.isArcher()?n.sprites[2]=e:n.sprites[0]=e),this.broadcast(new l.Looks(this.player),!0))},handleItemSlot:function(e){var t,i,n,s=parseInt(e[0]);this.player.isDying||this.player.isDead||2==(t=[parseInt(e[1]),parseInt(e[2]),parseInt(e[3])])[0]&&t[1]>this.player.equipment.maxNumber||(i=null,0<=t[1]&&(i=this.player.getStoredItem(t[0],t[1],t[2])),n=null,6==e.length&&(n=[parseInt(e[4]),parseInt(e[5])],t[0]==n[0])&&t[1]==n[1])||(0===s?this.player.handleInventoryEat(i,t[1]):1===s?(this.player.tut.equip=!0,this.player.handleEquip(t,n)):2===s?this.player.swapItem(t,n):3===s?this.player.handleStoreEmpty(t,i):4===s&&this.player.storeItem(t,n))},handleLoot:function(e){var t;console.info("handleLoot"),(item=this.entities.getEntityById(parseInt(e[0])))?(t=parseInt(e[1]),e=parseInt(e[2]),Math.abs(this.player.x-t)<=G_TILESIZE&&Math.abs(this.player.y-e)<=G_TILESIZE?(console.info("item="+item.toString()),item.enemyDrop&&console.info("enemyDrop"),item instanceof Item&&0<=this.player.inventory.putItem(item.room)&&(this.server.taskHandler.processEvent(this.player,PlayerEvent(EventType.LOOTITEM,item,1)),this.broadcast(item.despawn(),!1),this.entities.removeEntity(item))):console.info("Player is not close enough to item.")):console.info("no item.")},handleAttack:function(e){console.info("handleAttack");var t=this,i=(parseInt(e[0]),this.player);i.isDying||i.isDead||(i.movement.inProgress?i.attackQueue.push(e):setTimeout(function(){t.handleHitEntity(i,e)},G_LATENCY))},processAttack:function(){var e,t=this;for(e of this.player.attackQueue)console.info("processAttack, handle hit"),setTimeout(function(){t.handleHitEntity(t.player,e)},G_LATENCY);this.player.attackQueue=[]},handleHitEntity:function(e,t){console.info("handleHitEntity");console.info("message: "+JSON.stringify(t));var i=parseInt(t[1]),n=parseInt(t[2]),t=parseInt(t[3]);if(i<0)console.warn("invalid targetId");else{var s=this.entities.getEntityById(i);if(s){if(Date.now()-e.attackTimer<ATTACK_INTERVAL)console.warn("attack interval");else if(s instanceof Player&&e instanceof Player&&(e.level.base<20||s.level.base<20||10<Math.abs(e.level.base-s.level.base)))console.warn("pvp invalid diff");else if(s.aiState!=mobState.RETURNING)if(s.invincible)this.sendPlayer(new l.Notify("CHAT","COMBAT_TARGETINVINCIBLE")),console.warn("target invincible");else if(this.map.isColliding(e.x,e.y))console.warn("char.isColliding("+e.id+","+e.x+","+e.y+")");else{if(0<=t&&this.handleSkill([t,i,s.x,s.y]),e.setOrientation(n),e.engage(s),e==this.player){if(!e.canReach(s))return console.info("Player not close enough!"),console.info("p.x:"+e.x+",p.y:"+e.y),console.info("e.x:"+s.x+",e.y:"+s.y),void console.info("dx:"+Math.abs(e.x-s.x)+",dy:"+Math.abs(e.y-s.y));if(!e.attackedTime.isOver())return void console.warn("attackedTime is not over.");e.isHarvesting=!1,e.lastAction=Date.now()}e.isBlocking=!1,e.attackedTime.duration=500,e.hasAttacked=!0,e===this.player&&s instanceof p&&(this.player.tut.attack=!0),e instanceof Player&&s instanceof p&&s.mobAI.checkHitAggro(s,e),e.effectHandler&&e.effectHandler.interval(3,0);t=this.calcDamage(e,s,null,0);if(e.effectHandler)for(var a in e.effectHandler.interval(4,t.damage),e.effectHandler.skillEffects)for(var r in a.targets){var o=r.mod.damage;r.mod.damage=0,this.dealDamage(e,r,o,0)}this.dealDamage(e,s,t.damage,t.crit),e.attackTimer&&(e.attackTimer=Date.now()),e.effectHandler&&e.effectHandler.interval(5,0)}}else console.warn("invalid entity")}},calcDamage:function(e,t,i,n){var s={damage:0,crit:0,dot:0};return s.damage=Math.round(a.dmg(e,t,Date.now())),0!=s.damage&&(a.crit(e,t)&&(s.damage*=2,s.crit=1),0<e.mod.dr&&!e.hasFullHealth()&&(t=Math.ceil(s.damage*(e.mod.dr/100)),e.regenHealthBy(t),e instanceof Player))&&this.sendPlayer(e,e.health()),s},dealDamage:function(e,t,i,n){t&&(t instanceof p&&this.entities.mobAI.aggroPlayer(t,e),this.server.handleDamage(t,e,-i,n),e instanceof Player&&(e.weaponDamage+=i),this.server.handleHurtEntity(t,e),console.info("DAMAGE OCCURED "+i),t instanceof p||t.isDead&&(e==this.player&&this.entities.pushBroadcast(new l.Notify("CHAT","COMBAT_PLAYERKILLED",[e.name,t.name])),e.pStats.pk++,t.pStats.pd++))},handleSkillInstall:function(e){var t=parseInt(e[0]),e=parseInt(e[1]);t<0||6<=t||e<0||e>=s.Skills.length||(this.player.skillSlots[t]=e)},handleSkill:function(e){var t,i,n=parseInt(e[0]),s=parseInt(e[1]),a=parseInt(e[2]),e=parseInt(e[3]);this.player;n<0||n>=this.player.skills.length||(t=this.player.skills[n],s&&!(i=this.entities.getEntityById(s)))||t.isReady()&&(t.skillLevel,this.player.effectHandler.cast(n,s,a,e),t.tempXP=Math.min(t.tempXP++,1),this.handleSkillEffects(this.player,i))},handleSkillEffects:function(e,t){var i=[];if(e.effects){for(var[n,s]of Object.entries(e.effects))1==s&&i.push(parseInt(n));if(this.entities.pushToPlayer(e,new l.SkillEffects(e,i)),i=[],t){for(var[a,r]of Object.entries(t.effects))1==r&&i.push(parseInt(a));this.entities.pushToPlayer(e,new l.SkillEffects(t,i))}}},handleMoveEntity:function(e){console.info("handleMoveEntity");var t=parseInt(e[0]),i=parseInt(e[1]),n=parseInt(e[2]),s=parseInt(e[3]),a=parseInt(e[4])||-1,e=parseInt(e[5])||-1,r=this.player;i==r.id&&(r.map.isColliding(a,e)?console.warn("char.isColliding("+r.id+","+a+","+e+")"):2==n?r.isMovingPath()&&r.fullpath&&(r.abort_pathing_callback(a,e),r.forceStop()):(r.move([t,n,s,a,e]),i=new l.Move(r,s,n,a,e),this.entities.pushNeighbours(r,i,r),this.move_callback&&this.move_callback()))},handleMovePath:function(e){console.info("handleMovePath"),console.info("message="+JSON.stringify(e));var t=parseInt(e[0]),i=parseInt(e[1]),n=(parseInt(e[2]),0!=parseInt(e[3])),s=(e.splice(0,4),this.player);i!=s.id||(console.info(JSON.stringify(e)),e[0][0],e[0][1],this.player.mapStatus<2)||(this.entities.pathfinder.isValidPath(s.map.grid,e)?(s.movePath([t,n],e),i=new l.MovePath(s,e),this.entities.pushNeighbours(s,i)):console.info("handleMovePath: no valid path."))},handleTeleportMap:function(e){console.info("handleTeleportMap");var t,i,n,s=this,a=parseInt(e[0]),r=parseInt(e[1]),o=(console.info("status="+r),parseInt(e[2])),e=parseInt(e[3]),l=this.player;r<=0&&(e=o=-1);a<0||a>=s.server.maps.length?console.info("Map non-index"):(t=s.server.maps[a])&&t.ready?(console.warn("mapIndex: p.map.mapIndex:"+t.index),0==r?(l.pushSpawns=!1,l.forceStop(),l.mapStatus=0,this.handleClearMap(),this.entities.removePlayer(this.player),pos=t.enterCallback(l),i=a,l.map=t,s.setMap(t),n={x:l.x,y:l.y},console.info("handleTeleportMap - x: "+o+",y:"+e),console.warn("mapIndex: p.map.mapIndex:"+t.index),n=void 0===l.prevPosX&&void 0===l.prevPosY?s.map.getRandomStartingPosition():0===l.map.mapIndex?(l.prevPosX=l.x,l.prevPosY=l.y,s.map.getRandomStartingPosition()):1===l.map.mapIndex?{x:l.prevPosX,y:l.prevPosY}:s.map.getRandomStartingPosition(),s.entities.addPlayer(l),l.ex=l.sx=n.x,l.ey=l.sy=n.y,l.setPosition(n.x,n.y),l.move([Date.now(),3,1,n.x,n.y]),console.info("trying to send."),s.send([c.Messages.SC_TELEPORT_MAP,i,1,l.x,l.y])):1==r&&(l.mapStatus=2,s.handleSpawnMap(a,l.x,l.y),s.send([c.Messages.SC_TELEPORT_MAP,a,2,l.x,l.y]))):console.info("Map non-existant or not ready")},handleSpawnMap:function(e,t,i){var n=this.player;n.knownIds=[],this.entities.processWho(n),this.player.setPosition(t,i),this.entities.pushNeighbours(n,new l.Spawn(n),n)},handleClearMap:function(){this.player.clearTarget(),this.server.handlePlayerVanish(this.player),this.entities.removeEntity(this.player)},handleRevive:function(e){var t=this.player;1==t.isDead&&(console.info("handled Revive!!"),t.revive(),this.entities.pushNeighbours(t,new l.Spawn(t),t),t=new l.Move(t,t.orientation,2,t.x,t.y),this.sendPlayer(t))},handleStatAdd:function(e){var t=parseInt(e[0]),i=parseInt(e[1]);if(!(i<0||i>this.player.stats.free)&&4!=t){switch(t){case 1:this.player.stats.attack+=i;break;case 2:this.player.stats.defense+=i;break;case 3:this.player.stats.health+=i;break;case 5:this.player.stats.luck+=i}this.player.stats.free-=i,this.player.resetBars(),this.sendPlayer(new l.StatInfo(this.player))}},handleGold:function(e){var t=parseInt(e[0]),i=parseInt(e[1]),e=parseInt(e[2]);if(!(i<0))if(9999999<i)this.sendPlayer(new l.Notify("GOLD","MAX_TRANSFER"));else if(i>this.player.gold[t])this.sendPlayer(new l.Notify("GOLD","INSUFFICIENT_GOLD"));else{if(0===t&&1===e){if(!this.player.modifyGold(-i,0))return;this.player.modifyGold(i,1)}1===t&&0===e&&this.player.modifyGold(-i,1)&&this.player.modifyGold(i,0)}},handleBlock:function(e){var t=parseInt(e[0]),i=parseInt(e[1]),n=parseInt(e[2]),s=parseInt(e[3]),a=this.player,i=this.map.entities.getEntityById(i);if(i&&i instanceof Block&&this.player.isNextTooEntity(i)){if(0==t)this.player.holdingBlock=i;else if(1==t){if(n=r.roundTo(n,G_TILESIZE),s=r.roundTo(s,G_TILESIZE),this.map.isColliding(n,s))return;i.setPosition(n,s),i.update(this.player),this.player.holdingBlock=null}e=new l.BlockModify(i,a.id,t);this.entities.pushNeighbours(a,e,a)}},handlePlayerInfo:function(e){this.sendPlayer(new l.PlayerInfo(this.player))},handleWho:function(e){var t=parseInt(e.shift()),i=[];if(0<e.length&&(i=e),1===t&&this.entities.processWho(this.player),2===t)for(var n=0;n<i.length;++n)this.player.knownIds.splice(this.player.knownIds.indexOf(i[n]),1)},handleParty:function(e){switch(e.shift()){case 1:this.handlePartyInvite(e);break;case 2:this.handlePartyKick(e);break;case 3:this.handlePartyLeader(e);break;case 4:this.handlePartyLeave(e)}},handlePartyInvite:function(e){var t=e[0],i=this.server.getEntityByName(t);if(i){var e=e[1],n=this.player.party;if(this.player!=i)if(0==e)n&&5<=n.players.length?this.sendPlayer(new l.Notify("CHAT","PARTY_MAX_PLAYERS")):(!n||n.leader)&&i instanceof Player&&(this.sendToPlayer(i,new l.PartyInvite(this.player.id)),this.sendPlayer(new l.Notify("CHAT","PARTY_PLAYER_INVITE_SENT",[i.name])));else if(1==e){if(i.party&&i.party.removePlayer(i),n){if(5<=n.players.length)return void this.sendPlayer(new l.Notify("CHAT","PARTY_MAX_PLAYERS"));n.addPlayer(i)}else this.server.addParty(i,this.player);i&&(this.sendToPlayer(i,new l.Notify("CHAT","PARTY_PLAYER_JOINED",[this.player.name])),this.sendPlayer(new l.Notify("CHAT","PARTY_PLAYER_ADDED",[i.name])))}else 2==e&&(this.sendPlayer(new l.Notify("CHAT","PARTY_YOU_REJECTED_INVITE",[i.name])),this.sendToPlayer(i,new l.Notify("CHAT","PARTY_THEY_REJECTED_INVITE",[i.name])))}else this.sendPlayer(new l.Notify("CHAT","NO_PLAYER_EXIST",[t]))},handlePartyKick:function(e){var t,e=e[0],i=this.server.getEntityByName(e);i?this.player!=i&&((t=this.player.party)&&this.player==t.leader?(t.removePlayer(i),i instanceof Player&&this.sendToPlayer(i,new l.Notify("CHAT","PARTY_PLAYER_KICKED")),this.handlePartyAbandoned(t)):this.sendPlayer(new l.Notify("CHAT","PARTY_CANNOT_KICK"))):this.sendPlayer(new l.Notify("CHAT","NO_PLAYER_EXIST",[e]))},handlePartyLeader:function(e){var t,e=e[0],i=this.server.getEntityByName(e);i?this.player!=i&&((t=this.player.party)?(this.player==t.leader?(t.leader=i,this.sendToPlayer(i,new l.Notify("CHAT","PARTY_YOU_LEADER")),this.sendPlayer(new l.Notify("CHAT","PARTY_PLAYER_LEADER",[t.leader.name]))):this.sendPlayer(new l.Notify("CHAT","PARTY_IS_LEADER",[t.leader.name])),t.sendMembersName()):this.sendPlayer(new l.Notify("CHAT","PARTY_NOT_LEADER"))):this.sendPlayer(new l.Notify("CHAT","NO_PLAYER_EXIST",[e]))},handlePartyLeave:function(e){var t=this.player.party,i=t?t.leader:null;null!=i&&(t?(t.removePlayer(this.player),this.handlePartyAbandoned(t),this.sendToPlayer(i,new l.Notify("CHAT","PARTY_PLAYER_LEFT",[this.player.name])),this.player!=i&&this.sendPlayer(new l.Notify("CHAT","PARTY_YOU_LEFT",[i.name]))):this.sendPlayer(new l.Notify("CHAT","PARTY_NOT_IN")))},handlePartyAbandoned:function(e){1==e.players.length&&(this.sendPlayer(new l.Notify("CHAT","PARTY_ALL_LEFT")),this.sendPlayer(new l.Party([])),this.player!==e.players[0]&&e.players[0]instanceof Player&&(this.sendToPlayer(e.players[0],new l.Notify("CHAT","PARTY_ALL_LEFT")),this.sendToPlayer(e.players[0],new l.Party([]))),this.server.removeParty(e))},handleHarvest:function(e){var t=e[0],e=e[1];this.player.onHarvest(t,e)},handleUseNode:function(e){e=parseInt(e[0]),e=this.entities.getEntityById(e);this.player.onHarvestEntity(e)},sendToPlayer:function(e,t){this.map.entities.pushToPlayer(e,t)},send:function(e){this.connection.send(e)}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./appearancedata":79,"./bank":82,"./character":85,"./chest":87,"./entityspawn":93,"./format":95,"./formulas":96,"./inventory":97,"./items":101,"./lib/class":104,"./message":111,"./mob":113,"./mobdata":117,"./node":119,"./party":126,"./questdata":132,"./skilldata":135,"./skillhandler":136,"./taskhandler":137,"./trade":139,"./utils":146,bcrypt:void 0,"body-parser":void 0,express:void 0,underscore:75}],126:[function(e,t,i){e("./lib/class"),e("./mobdata.js");var n=e("./message.js");t.exports=Party=Class.extend({init:function(e,t){this.players=[e,t],e.party&&e.party.removePlayer(e),t.party&&t.party.removePlayer(t),e.party=this,(t.party=this).leader=e,this.sendMembersName()},addPlayer:function(e){e&&(this.players.push(e),e.party&&e.party.removePlayer(e),e.party=this),this.sendMembersName()},removePlayer:function(e){var t=0;if(e==this.leader&&(this.leader=this.players[0]),e)for(t=0;t<this.players.length;t++)if(e===this.players[t]){e instanceof Player&&this.players[t].send([Types.Messages.PARTY]),this.players[t].party=null,this.players.splice(t,1),this.sendMembersName();break}},sendMembersName:function(){var e=0,t=[],i=this.players;if(1<i.length)for(t.push(this.leader.name),e=0;e<i.length;e++)i[e]!==this.leader&&t.push(i[e].name);for(e=0;e<i.length;e++)i[e]instanceof Player&&i[e].map.entities.pushToPlayer(i[e],new n.Party(t))},sumTotalLevel:function(){for(var e=0,t=0,e=0;e<this.players.length;e++)t+=this.players[e].level;return t+1},getHighestLevel:function(){for(var e=0,t=0,e=0;e<this.players.length;e++)t<this.players[e].level&&(t=this.players[e].level);return t},getLowestLevel:function(){for(var e=0,t=999,e=0;e<this.players.length;e++)t>this.players[e].level&&(t=this.players[e].level);return t}})},{"./lib/class":104,"./message.js":111,"./mobdata.js":117}],127:[function(e,t,i){e("./lib/astar"),e("./utils");t.exports=Pathfinder=Class.extend({init:function(e,t){this.width=e,this.height=t,this.grid=null,this.blankGrid=[],this.initBlankGrid_(),this.ignored=[],this.included=[]},initBlankGrid_:function(){for(var e=0;e<this.height;e+=1){this.blankGrid[e]=[];for(var t=0;t<this.width;t+=1)this.blankGrid[e][t]=0}},isPathTicksTooFast:function(e,t,i){console.warn("checkPathTicks");var i=~~((Date.now()-i)*(e.tick*G_FRAME_INTERVALS/G_UPDATE_INTERVAL_EXACT)),i=Math.max(i,0),n=this.getPathTicks(t,e.x,e.y);return 0==n?(console.warn("isPathTicksTooFast: getPathTicks - "+JSON.stringify(t)+", x:"+e.x+",y:"+e.y),!1):(t=2*G_UPDATE_INTERVAL,console.warn("SPEED HACK. playerTicks - tolerance: "+n+"-"+t+", "+(n-t)+" > serverTicks: "+i+", entity.latencyDiff: "+e.latencyDiff),i<n-t&&(console.error("SPEED HACK. playerTicks - tolerance: "+n+"-"+t+", "+(n-t)+" > serverTicks: "+i+", entity.latencyDiff: "+e.latencyDiff),!0))},getPathTicks:function(e,t,i){count=0;var n,s=null;for(n of e){if(s){if(t==n[0]&&t==s[0]&&i>=Math.min(n[1],s[1])&&i<=Math.max(n[1],s[1])){count+=Math.abs(s[1]-i);break}if(i==n[1]&&i==s[1]&&t>=Math.min(n[0],s[0])&&t<=Math.max(n[0],s[0])){count+=Math.abs(s[0]-t);break}count+=Math.abs(n[0]-s[0])+Math.abs(n[1]-s[1])}s=n}return count},getPathTicks2:function(e){var t,i,n=0;for(i of e)t&&(n+=Math.abs(i[0]-t[0])+Math.abs(i[1]-t[1])),t=i;return n},getPathUntil:function(e,t){if(t<0)return null;var i,n,s=this.getPathTicks2(e)-t,a=[],r=0;for(n of e){if(i){var o=Math.abs(n[0]-i[0]),l=Math.abs(n[1]-i[1]);if((r+=t=o+l)==s){a.push(n);break}if(s<r){var h=n,c=r-s;0<o&&(h[0]+=n[0]-i[0]<0?c:-c),0<l&&(h[1]+=n[1]-i[1]<0?c:-c),a.push(h);break}}i=n,a.push(n)}return a},isInPath:function(e,t){var i,e=e.map(function(e){return e.slice()}),n=e.shift();for(i of e){if(n[0]==i[0]&&n[1]>=t[1]&&i[1]<=t[1]||n[1]==i[1]&&n[0]>=t[0]&&i[0]<=t[0])return!0;n=i}return!1},isValidPath:function(o,e){function t(e,t,i,n){e=Math.floor(e),t=Math.floor(t),i=Math.floor(i);var s=Math.min(e,t),a=Math.max(e,t);if("x"==n){for(var r=s;r<a;r++)if(o[i][r])return!1}else for(r=s;r<a;r++)if(o[r][i])return!1;return!0}for(var i=G_TILESIZE,n=o.length,s=o[0].length,a=[],r=0;r<e.length;r++)a[r]=e[r].slice();for(l of a)l[0]/=i,l[1]/=i;var l,h,c,u,p=null;for(l of a){if(l[1]<0||l[1]>=n)return!1;if(l[0]<0||l[0]>=s)return!1;if(p){if(l[0]!=p[0]&&l[1]!=p[1])return!1;if(0<Math.abs(l[0]-p[0])){if(h=p[0],c=l[0],u=l[1],!t(h,c,u,"x"))return!1}else if(0<Math.abs(l[1]-p[1])&&(h=p[1],c=l[1],u=l[0],!t(h,c,u,"y")))return!1}p=l}return!0},getShortGrid:function(e,t,i,n){for(var s=G_TILESIZE,a=(t=[t[0]/s,t[1]/s],i=[i[0]/s,i[1]/s],Math.max(Math.min(Math.floor(t[0]),Math.floor(i[0]))-n,0)),r=Math.min(Math.max(Math.ceil(t[0]),Math.ceil(i[0]))+n,e[0].length-1),s=Math.max(Math.min(Math.floor(t[1]),Math.floor(i[1]))-n,0),o=Math.min(Math.max(Math.ceil(t[1]),Math.ceil(i[1]))+n,e.length-1),l=(t=[t[0]-a,t[1]-s],i=[i[0]-a,i[1]-s],[]),h=s;h<=o;++h)l.push(e[h].slice(a,r));return{crop:l,minX:a,minY:s,substart:t,subend:i}},findNeighbourPath:function(e,t){var i=G_TILESIZE;return Math.abs(e[0]-t[0])<=i&&0==Math.abs(e[1]-t[1])||Math.abs(e[1]-t[1])<=i&&0==Math.abs(e[0]-t[0])?[[e[0],e[1]],[t[0],t[1]]]:null},findShortPath:function(e,t,i,n,s){var a=G_TILESIZE,r=AStar.AStar(e,n,s);if(r&&0<r.length){for(var o=[],l=r.length,h=0;h<l;++h)o[h]=[],o[h][0]=(r[h][0]+t)*a,o[h][1]=(r[h][1]+i)*a;return o}return null},findPath:function(e,t,i,n){return this.grid=e,this.applyIgnoreList_(this.grid,!0),this.applyIncludeList_(this.grid,!0),AStar.AStar(this.grid,t,i)},findIncompletePath_:function(e,t){for(var i,n,s=[],a=AStar.AStar(this.blankGrid,e,t),r=a.length-1;0<r;--r)if(i=a[r][0],n=a[r][1],0===this.grid[n][i]){s=AStar(this.grid,e,[i,n]);break}return s},ignoreEntity:function(e){e&&this.ignored.push(e)},includeEntity:function(e){e&&this.included.push(e)},applyIgnoreList_:function(t,i){var n,s;_.each(this.ignored,function(e){n=e.isMoving()?e.nextGridX:e.gx,s=e.isMoving()?e.nextGridY:e.gy,0<=n&&0<=s&&(t[s][n]=i?0:1)})},applyIncludeList_:function(t,i){var n,s;_.each(this.included,function(e){n=e.isMoving()?0<e.path.length?e.path[e.path.length-1][0]:e.nextGridX:e.gx,s=e.isMoving()?0<e.path.length?e.path[e.path.length-1][1]:e.nextGridY:e.gy,0<=n&&0<=s&&(t[s][n]=i?1:0)})},clearIgnoreList:function(e){this.applyIgnoreList_(e,!1),this.ignored=[]},clearIncludeList:function(e){this.applyIncludeList_(e,!1),this.ignored=[]}})},{"./lib/astar":103,"./utils":146}],128:[function(e,t,i){e("./lib/class"),e("underscore");var n=e("./character"),h=(e("./chest"),e("./message")),c=e("./utils"),s=(e("./mobdata"),e("./formulas"),e("./party"),e("./items"),e("./appearancedata"),e("./bank")),d=e("../shared/js/gametypes"),o=e("../shared/js/itemtypes"),a=(e("bcrypt"),e("./equipment")),r=e("./inventory"),l=(e("./main"),e("./mob"),e("./skillhandler")),f=e("./effecthandler"),u=(e("./trade"),e("express")),p=(e("body-parser"),u(),e("./entityspawn"),e("./packethandler"));e("./itemlootdata"),e("./quest");t.exports=Player=n.extend({init:function(e,t,i,n){this.user=e,this.main=t,this.server=n,this.connection=i,this.map=this.server.maps[0],this._super(this.connection.id,d.EntityTypes.PLAYER,1,0,0,this.map,0),this.mapStatus=0,this.mapIndex=0,this.quests=[],this.gold=new Array(2),this.skillSlots=[],this.hasLoggedIn=!1,this.hasEnteredGame=!1,this.isDead=!1,this.inventory=null,this.bank=null,this.equipment=null,this.itemStore=new Array(3),this.exp={base:0,attack:0,defense:0,move:0},this.level={base:0,attack:0,defense:0,move:0},this.stats={attack:0,defense:0,health:0,energy:0,luck:0,free:0,hp:0,hpMax:0,ep:0,epMax:0},this.mod={attack:0,defense:0,damage:0,health:0},this.cooltimeTimeout=null,this.consumeTimeout=null,this.skillHandler=new l(this),this.moveSpeed=500,this.setMoveRate(this.moveSpeed),this.attackedTime=new Timer(1e3),this.attackQueue=[],this.moveQueue=[],this.stopQueue=[],this.attackSkill=[],this.attackTimer=0,this.idleTimer=new Timer(3e4),this.packetHandler=new p(e,t,this,i,n,this.map),this.playerController=new PlayerController(this),this.onWelcomeReady=!1,this.tut={},this.tut.move=!1,this.tut.portal=!1,this.tut.attack=!1,this.tut.attack2=!1,this.tut.buy=!1,this.tut.buy2=!1,this.tut.equip=!1,this.tut.stats=!1,this.spawnsList={},this.lastAction=Date.now(),this.knownIds=[],this.sx=0,this.sy=0,this.ex=-1,this.ey=-1,this.moveOrientation=0,this.savedPlayer=!1,this.savedQuests=!1,this.savedInventory=!1,this.savedEquipment=!1,this.savedBank=!1,this.savedAll=!1,this.achievements=[],this.completeQuests={}},destroy:function(){},getState:function(){var e=this._getBaseState(),t=this.sprites[0],i=this.getWeaponSprite(),t=(this.isArcher()&&(t=this.sprites[2]),[this.level.base,this.stats.hp,this.stats.hpMax,0,t,i,this.colors[0],this.colors[1]]);return e.concat(t)},send:function(e){this.connection.send(e)},resetBars:function(){this.resetHP(),this.resetEP(),this.map.entities.pushNeighbours(this,new h.ChangePoints(this,0,0))},questAboutKill:function(e,t){var i=e.kind,n=(e.level,t.count<t.object.count),i=t.type==QuestType.KILLMOBKIND&&n&&i==t.object.kind,n=t.type==QuestType.KILLMOBS&&n,s=e.level>=t.object.level[0]&&e.level<=t.object.level[1];(i||n)&&s&&(console.info("_questAboutKill - conditions met."),t.data1+=~~(e.stats.xp/3),++t.count==t.object.count?this.questAboutKillComplete(t):this.progressQuest(t))},questAboutUseNode:function(e){var t;e.count++,e.count>=e.object.count?(e.count=e.object.count,t=10*e.object.count*this.level.base,this.pushToPlayer(new h.Kill({id:0},this.level.base,t)),this.completeQuest(e)):this.progressQuest(e)},questAboutItem:function(e){console.info(JSON.stringify(e));var t=e.object2.kind+1e3,t=this.inventory.hasItemCount(t);e.count=t,this.progressQuest(e)},questAboutFind:function(e){var t;e.count++>=e.object.count&&e.status==QuestStatus.INPROGRESS&&(e.count=e.object.count,t=10*e.object.count*this.level.base,this.pushToPlayer(new h.Kill({id:0},this.level.base,t)),this.completeQuest(e))},questAboutItemComplete:function(e,t){if(e.count>=e.object2.count&&e.status==QuestStatus.INPROGRESS){var i=e.object2.kind+1e3;if(!this.inventory.hasItemCount(i))return;this.inventory.removeItemKind(i,e.object2.count);i=10*e.object2.count*this.level.base;return this.pushToPlayer(new h.Kill({id:0},this.level.base,i)),this.completeQuest(e),t&&t(e),!0}return!1},questAboutKillComplete:function(e){console.info("_questAboutKill - completed.");var t=e.data1;this.incExp(t),e.status=QuestStatus.COMPLETE,this.pushToPlayer(new h.Kill({id:0},this.level.base,t)),this.completeQuest(e)},progressQuest:function(e){e.status=QuestStatus.INPROGRESS,this.pushToPlayer(new h.Quest(e))},completeQuest:function(e){e.status=QuestStatus.COMPLETE,this.pushToPlayer(new h.Quest(e)),this.completeQuests[e.id]=e.npcQuestId,this.quests.splice(this.quests.indexOf(e),1),delete e},foundQuest:function(e){this.quests.push(e),e.status=QuestStatus.STARTED,this.pushToPlayer(new h.Quest(e))},hasNpcCompleteQuest:function(e){for(var t in this.completeQuests)if(this.completeQuests[t]==e)return!0;return!1},getQuestById:function(e){for(var t of this.quests)if(t.id==e)return t;return null},hasQuest:function(e){for(var t of this.quests)if(t.id==e)return!0;return!1},incExp:function(e){var e=parseInt(e),e=Math.ceil(e*this.getExpBonus()),t=(this.exp.base=parseInt(this.exp.base)+parseInt(e),this.level.base);return this.level.base=d.getLevel(this.exp.base),t!==this.level.base&&this.levelUp(),e},incAttackExp:function(e){var e=parseInt(e),e=Math.ceil(e*this.getExpBonus()*.25),t=(this.exp.attack=parseInt(this.exp.attack)+parseInt(e),this.level.attack);return this.level.attack=d.getAttackLevel(this.exp.attack),t!==this.level.attack&&this.pushToPlayer(new h.LevelUp(2,this.level.attack,this.exp.attack)),e},incDefenseExp:function(e){var e=parseInt(e),e=Math.ceil(e*this.getExpBonus()),t=(this.exp.defense=parseInt(this.exp.defense)+parseInt(e),this.level.defense);return this.level.defense=d.getDefenseLevel(this.exp.defense),t!==this.level.defense&&this.pushToPlayer(new h.LevelUp(3,this.level.defense,this.exp.defense)),e},incMoveExp:function(e){var e=parseInt(e),e=Math.ceil(e*this.getExpBonus()),t=(this.exp.move=parseInt(this.exp.move)+parseInt(e),this.level.move);return this.level.move=d.getMoveLevel(this.exp.move),t!==this.level.move&&this.pushToPlayer(new h.LevelUp(4,this.level.move,this.exp.move)),e},getExpBonus:function(){var e=1;if(this.party)for(var t of this.party.players)this.isInScreen([t.x,t.y])&&(e+=.1*this.players.length);return e},levelUp:function(){this.level.base<10?(this.stats.attack+=2,this.stats.defense+=2,this.stats.health+=2,this.stats.energy+=2,this.stats.luck+=2):this.stats.free+=5,this.pushToPlayer(new h.StatInfo(this)),this.resetBars(),this.pushToPlayer(new h.ChangePoints(this,0,0)),this.pushToPlayer(new h.LevelUp(1,this.level.base,this.exp.base)),10==this.level.base&&(this.tutChat("TUTORIAL_SHOPBUY",4,"buy"),this.tutChat("TUTORIAL_SHOPBUY2",6,"buy2")),20==this.level.base&&this.tutChat("TUTORIAL_STATS",2,"stats")},sendPlayer:function(p){var e,m=this;m.mapIndex=parseInt(p.map[0]),m.map=m.server.maps[m.mapIndex],m.x=parseInt(p.map[1]),m.y=parseInt(p.map[2]),m.orientation=parseInt(p.map[3]),m.sprites=p.sprites.parseInt(),m.colors=p.colors,m.exp.base=parseInt(p.exps[0]),m.exp.attack=parseInt(p.exps[1]),m.exp.defense=parseInt(p.exps[2]),m.exp.move=parseInt(p.exps[3]),8==p.exps.length?(m.exp.sword=parseInt(p.exps[4]),m.exp.bow=parseInt(p.exps[5]),m.exp.hammer=parseInt(p.exps[6]),m.exp.axe=parseInt(p.exps[7])):(m.exp.sword=0,m.exp.bow=0,m.exp.hammer=0,m.exp.axe=0),10==p.exps.length?(m.exp.logging=parseInt(p.exps[8]),m.exp.mining=parseInt(p.exps[9])):(m.exp.logging=0,m.exp.mining=0),m.level.base=d.getLevel(m.exp.base),m.level.attack=d.getAttackLevel(m.exp.attack),m.level.defense=d.getDefenseLevel(m.exp.defense),m.level.move=d.getMoveLevel(m.exp.move),m.gold[0]=parseInt(p.gold[0]),m.gold[1]=parseInt(p.gold[1]),m.isDead=!1,m.pStats=p.pStats.parseInt(),m.level.base<10?(e=parseInt(m.level.base),m.stats.attack=2*e,m.stats.defense=2*e,m.stats.health=2*e,m.stats.energy=2*e,m.stats.luck=2*e,m.stats.free=0):(p.stats=p.stats.parseInt(),m.stats.attack=p.stats[0],m.stats.defense=p.stats[1],m.stats.health=p.stats[2],m.stats.energy=p.stats[3],m.stats.luck=p.stats[4],m.stats.free=p.stats[5]),p.completeQuests&&(m.completeQuests=p.completeQuests),m.setHP(),m.setEP(),m.resetBars(),m.setMoveRate(500-m.level.move),m.attackTimer=Date.now(),m.server.connect_callback(m),DBH.getItems(m,2,function(e){m.equipment=new a(m,2,e),m.itemStore[2]=m.equipment,DBH.getItems(m,1,function(e){m.bank=new s(m,48,e),m.itemStore[1]=m.bank,DBH.getItems(m,0,function(e){m.inventory=new r(m,48,e),m.itemStore[0]=m.inventory,DBH.loadAchievements(m,function(e){DBH.loadQuests(m,function(e){console.info("loaded quest"),console.info("sendMessage");var t,i,n,s=0,a=[d.Messages.SC_PLAYER,0,Date.now(),m.id,m.name,m.mapIndex,m.x,m.y,m.stats.hp,m.stats.ep,m.exp.base,m.exp.attack,m.exp.defense,m.exp.move,m.exp.sword,m.exp.bow,m.exp.hammer,m.exp.axe,m.exp.logging,m.exp.mining,m.colors[0],m.colors[1],m.gold[0],m.gold[1],m.user.gems,m.stats.attack,m.stats.defense,m.stats.health,m.stats.energy,m.stats.luck,m.stats.free];for(t in console.info("sendMessage - Equipment"),a.push(Object.keys(m.equipment.rooms).length),m.equipment.rooms)var r=m.equipment.rooms[t],a=a.concat(r.toArray());for(i in m.setRange(),a.push(m.isArcher()?m.sprites[2]:m.sprites[0]),a.push(m.getWeaponSprite()),console.info("sendMessage - Inventory"),a.push(Object.keys(m.inventory.rooms).length),m.inventory.rooms){r=m.inventory.rooms[i];a=a.concat(r.toArray())}for(n in console.info("sendMessage - Bank"),a.push(Object.keys(m.bank.rooms).length),m.bank.rooms){r=m.bank.rooms[n];a=a.concat(r.toArray())}e=m.quests.filter(function(e){return e.status!==QuestStatus.COMPLETE});a.push(e.length);for(var o=0;o<e.length;++o){var l=e[o];console.info(JSON.stringify(l)),a=a.concat(l.toClient())}var h=m.achievements;a.push(h.length);for(var c=0;c<h.length;++c){var u=h[c];console.info(JSON.stringify(u)),a=a.concat(u.toClient(u))}m.skillHandler.setSkills(m,p.skills),m.effectHandler=new f(m),a.push(m.skills.length);for(s=0;s<m.skills.length;++s)a.push(parseInt(m.skills[s].skillXP));m.skillSlots=p.skillSlots,a.push(m.skillSlots.length);for(s=0;s<m.skillSlots.length;++s)a.push(parseInt(m.skillSlots[s]));m.server.enter_callback&&(m.map.entities.addPlayer(m),m.server.enter_callback(m),m.connection.sendUTF8(a.join(",")),m.hasEnteredGame=!0)})})})})})},tutChat:function(e,t,i){var n=this,s=i;setTimeout(function(){n.map&&n.map.entities&&2<=n.mapStatus&&0==n.tut[s]&&(n.pushToPlayer(new h.Notify("TUTORIAL",e)),n.tut[s]=!0)},5e3*t)},handleInventoryEat:function(e,t){var i,n=this,e=e.itemKind;this.consumeTimeout||(this.consumeTimeout=setTimeout(function(){n.consumeTimeout=null},4e3),"health"==(e=o.KindData[e]).typemod?(i=e.modifier,this.hasFullHealth()||this.modHealthBy(i)):"healthpercent"==e.typemod&&(i=~~(this.stats.hpMax*e.modifier/100),this.hasFullHealth()||this.modHealthBy(i)),"energy"==e.typemod&&(i=e.modifier,this.hasFullEnergy()||this.modEnergyBy(i)),this.inventory.takeOutItems(t,1))},modHealthBy:function(e){var t;if(!this.isDead)return t=this._super(e),this.sendChangePoints(e,0),t},modEnergyBy:function(e){var t=this._super(e);return this.sendChangePoints(0,e),t},sendChangePoints:function(e,t){this.map.entities.pushNeighbours(this,new h.ChangePoints(this,e,t))},getHPMax:function(){return 300+50*this.stats.health+this.stats.health*this.stats.health},getEPMax:function(){return 500+50*this.stats.energy},getWeaponLevel:function(){var e=this.equipment.rooms[4];return e?(e=o.KindData[e.itemKind],d.getWeaponLevel(this.exp[e.type])):0},addWeaponExp:function(e){var t,i=this.equipment.rooms[4];i&&(i=o.KindData[i.itemKind],this.exp[i.type]+=~~(e/100),e=this.exp[i.type],t=d.getWeaponLevel(e),this.level[i.type]!=t&&(e=new h.LevelUp({sword:10,bow:11,hammer:12,axe:13}[i.type],t,e),this.pushToPlayer(e)),this.level[i.type]=t)},baseCrit:function(){var e=2*this.level.base,t=this.equipment.rooms[4],t=(t&&(e=3*o.getData(t.itemKind).modifier+2*t.itemNumber),this.stats.attack+2*this.stats.luck),t=c.clamp(0,500,~~(t+e));return console.info("player - baseCrit: "+t),t},baseCritDef:function(){var e,t,i=2*this.level.base;for(e in this.equipment.rooms)4!=e&&(t=this.equipment.rooms[e])&&(i+=3*o.getData(t.itemKind).modifier+2*t.itemNumber);var n=this.stats.defense+2*this.stats.luck,n=c.clamp(0,500,~~(n+i));return console.info("player - baseCritDef: "+n),n},baseDamage:function(){var e=this.equipment.rooms[4],t=this.level.base,i=~~(e?3*o.getData(e.itemKind).modifier+2*e.itemNumber:t),n=this.level.attack/50+1,e=(n*=this.getWeaponLevel()/50+1,e&&(i=~~(i*(e.itemDurability/e.itemDurabilityMax*.5+.5))),this.mod?this.mod.attack:0);i+=3*(this.stats.attack+e)+this.stats.luck;var t=c.randomRangeInt(e=~~(t*n),~~(3*e))+i,n=1.15+Math.max(0,.05*(10-this.level.base)),s=this.isArcher()?.85:1,e=~~((e+i)*n*s);return~~(t*n*s)},baseDamageDef:function(){var e,t=0,i=this.level.base+3;for(e in console.info("baseDamageDef:"),t=i,this.equipment.rooms){var n,s=this.equipment.rooms[e];s&&(n=1==e?4:2,t+=~~((o.getData(s.itemKind).modifier*n+s.itemNumber*n)*(s.itemDurability/s.itemDurabilityMax*.5+.5)))}console.info("dealt="+t);var a=this.level.defense/50+1,i=(console.info("power="+a),~~(i*a)),a=~~(2*i),r=(console.info("dealtrange="+t),this.mod?this.mod.defense:0);return t+=~~(3*(this.stats.defense+r))+this.stats.luck,console.info("dealtstats="+t),r=c.randomRangeInt(i,a)+t,r},modifyGold:function(e,t){return!(this.gold[t=t||0]+e<0||(this.gold[t]+=parseInt(e),this.pushToPlayer(new h.Gold(this)),0<e?this.pushToPlayer(new h.Notify("CHAT","GOLD_ADDED",[e])):this.pushToPlayer(new h.Notify("CHAT","GOLD_REMOVED",[e*=-1])),0))},save:function(){var e=this;console.info("SAVING PLAYER: "+this.name),DBH.savePlayer(this),DBH.saveQuests(this,this.quests),DBH.saveAchievements(this),this.inventory&&this.inventory.save(this),this.equipment&&this.equipment.save(this),this.bank&&this.bank.save(this),e.playerSaved=setInterval(function(){e.savedPlayer&&e.savedQuests&&e.savedAchievements&&e.savedInventory&&e.savedEquipment&&e.savedBank&&(e.savedAll=!0,clearInterval(e.playerSaved))},G_UPDATE_INTERVAL),SAVING_SERVER||(e.playerSaveReset=setInterval(function(){e.savedAll&&(e.savedPlayer=!1,e.savedQuests=!1,e.savedInventory=!1,e.savedEquipment=!1,e.savedBank=!1,e.savedAchievements=!1,e.savedAll=!1,clearInterval(e.playerSaveReset))},G_ROUNDTRIP))},isArcher:function(){var e=this.equipment.rooms[4];return!(!e||!o.isArcherWeapon(e.itemKind))},setRange:function(){this.setAttackRange(1),this.isArcher()&&this.setAttackRange(10)},setHP:function(e){this._super(e)},setEP:function(e){this._super(e)},movePath:function(e,t){var i=t[0][0],n=t[0][1],s=(t[t.length-1][0],t[t.length-1][1],e[0]),e=e[1],i=(console.info("set path"),this.keyMove&&this.move(this.orientation,0,this.ex,this.ey),this.sx=this.x,this.sy=this.y,this.ex=this.x2,this.ey=this.y2,this.x==i&&this.y==n||(console.error("movePath - Start Position not correct!"),console.info("movePath - x:"+i+",y:"+n+",p.x:"+this.x+",p.y:"+this.y)),this.forceStop(),orientation=this.getOrientationTo({x:t[1][0],y:t[1][1]}),this.setOrientation(orientation),this.path=this.fullpath=t,this.step=0,this.interrupted=e,~~(Date.now()+G_UPDATE_INTERVAL-(G_LATENCY+s)));this.unclampedDelay=i,i=c.clamp(0,G_LATENCY,i),this.latencyDiff=Date.now()-s,this.startMovePathTime=s+i,console.warn("movePath: delay:"+i),0<i&&this.setFreeze(i)},move:function(e){var t,i,n,s,a;self=this;e&&(a=e[0],s=e[1],t=e[2],i=e[3],n=e[4],console.info("nm:"+JSON.stringify(e)),this.isMovingPath()||(this.moving_callback&&(clearTimeout(this.moving_callback),this.moving_callback=null),3==s?(this.moveOrientation=0,this.sx=i,this.sy=n,this.ex=-1,this.ey=-1,this.keyMove=!1,this.setPosition(i,n),this.nextMove=null):(1==s&&(e=Math.max(~~(G_LATENCY+a-(Date.now()+G_UPDATE_INTERVAL)),0),console.warn("unclamped delay="+e),this.unclampedDelay=e,e=c.clamp(0,G_LATENCY,e),console.warn("delay="+e),this.latencyDiff=Date.now()-a,this.startMoveTime=a+e,this.nsx=this.x,this.nsy=this.y,a=function(){self.movement.inProgress&&self.forceStop(),self.moving_timeout=null,self.startMoving=!0,self.moveOrientation=t,self.sx=self.x,self.sy=self.y,self.ex=-1,self.ey=-1,self.keyMove=!0,self.startMoveTime=Date.now()},e<=0?a():this.moving_timeout=setTimeout(a,e),this.nextMove=null),0==s&&(console.info("move - x: "+i+", y: "+n),this.ex=i,this.ey=n,a=i==this.x&&n==this.y,e=this.sx==i&&this.sy==n,s=this.nsx==i&&this.nsy==n,console.info("move: x="+i+",y="+n),console.info("move: this.x="+this.x+",this.y="+this.y),console.info("move: this.sx="+this.sx+",this.sy="+this.sy),console.info("move: this.nsx="+this.nsx+",this.nsy="+this.nsy),a||e||s?(clearTimeout(this.moving_timeout),this.setPosition(i,n),this.forceStopMove()):(a=[[this.sx,this.sy],[i,n]],this.map.entities.pathfinder.isValidPath(this.map.grid,a)||(console.warn("INVALID PATH."),console.warn("invalidPath: "+JSON.stringify(a)),this.setPosition(this.x,this.y),this.forceStopMove()),this.map.entities.pathfinder.isPathTicksTooFast(this,a,this.startMoveTime)?this.setPosition(this.sx,this.sy):this.setPosition(i,n),this.forceStopMove(),this.keyMove=!1,this.nextMove=null)))))},getStoredItem:function(e,t,i){var n,e=this.itemStore[e],s=e.rooms;return t<0||t>=s.length?null:(n=s[t])?(s=s[t].itemNumber,(o.isLootItem(n.itemKind)||o.isConsumableItem(n.itemKind))&&0<i&&0<s&&s<i?e.takeOutItems(t,s):n):void 0},swapItem:function(e,t){console.info(JSON.stringify(e)),console.info(JSON.stringify(t));var i,n,s=this.itemStore[e[0]],a=this.itemStore[t[0]],r=s.rooms[e[1]];!r||!o.isConsumableItem(r.itemKind)&&0==t[0]&&0<=t[1]&&t[1]<6||o.isConsumableItem(r.itemKind)&&0==t[0]&&t[1]<0&&6<=t[1]||(i=a.rooms,n=null,r!=(n=0<=t[1]?i[t[1]]:n)&&(n?-1==this.inventory.combineItem(r,n)&&a.checkItem(t[1],r)&&s.checkItem(e[1],n)&&(a.setItem(t[1],r),s.setItem(e[1],n)):0<=t[1]?a.setItem(t[1],r)&&s.setItem(e[1],null):2!=t[1]&&(a.putItem(r),s.setItem(e[1],null))))},storeItem:function(e,t){this.swapItem(e,t)},handleEquip:function(e,t){console.info("handleEquip"),this.swapItem(e,t)},handleStoreEmpty:function(e,t){var i,n=t.itemKind,s=this.itemStore[e[0]],a=e[1],r=e[2];2==e[0]?console.error("handleStoreEmpty - Cannot empty equipment store."):(e=s.rooms[e[1]],i=Object.assign(new ItemRoom,e),t=this.map.entities.createItem(i,this.x,this.y),r=c.clamp(1,e.itemNumber,r),o.isEquippable(n)?s.makeEmptyItem(a):(t.room.itemNumber=r,s.takeOutItems(a,r)),this.map.entities.pushNeighbours(this,t.spawn()),this.knownIds.push(t.id),this.server.handleItemDespawn(t))},sendCurrentMove:function(){var e=new h.Move(this,this.moveOrientation,0,this.x,this.y);this.map.entities.pushNeighbours(this,e)},dropGold:function(){var e=Math.ceil(Math.random()*this.level.base*5+this.level.base),e=Math.min(e,this.gold[0]);return this.modifyGold(-e),e},revive:function(){this.isDead=!1,this.isDying=!1,this.hasEnteredGame=!0,this.resetBars()},setPosition:function(e,t){var i;this._super(e,t),this.holdingBlock&&(e=[[e,t],[e,t-(i=G_TILESIZE)],[e,t+i],[e-i,t],[e+i,t]][this.orientation],this.holdingBlock.setPosition(e[0],e[1]))},isInScreen:function(e){return~~(Math.abs(this.x-e[0])/G_TILESIZE)<=~~(G_SCREEN_WIDTH/2)&&~~(Math.abs(this.y-e[1])/G_TILESIZE)<=~~(G_SCREEN_HEIGHT/2)},getWeapon:function(){return this.equipment.rooms[4]},hasHarvestWeapon:function(e){var t,i;return!(!e||"any"!=e)||!!(t=this.getWeapon())&&(i=o.KindData[t.itemKind],e?i.type==e:o.isHarvestWeapon(t.itemKind))},getWeaponType:function(){var e=this.getWeapon();return e?o.KindData[e.itemKind].type:null},getWeaponSprite:function(){var e=this.getWeaponType();return e?"sword"==e?1:"axe"==e?2:"hammer"==e?12:"bow"==e?50:0:0},_harvest:function(t,i,n,e){var s,a,r,o,l=this;l._checkHarvest(t,i)?(s=l.x,a=l.y,r=l.getWeaponType(),l.isHarvesting=!0,o=this.exp.logging,"hammer"==r&&(o=this.exp.mining),e=~~(e*c.clamp(.1,1,1-d.getSkillLevel(o)/20)),clearTimeout(l.harvestTimeout),l.harvestTimeout=setTimeout(function(){var e=!0;l.isHarvesting||(e=!1),l.x==s&&l.y==a||(e=!1),(e=!!l.hasHarvestWeapon(r)&&e)?(n&&n(l),l.map.entities.pushNeighbours(l,new h.Harvest(l,2,t,i))):l._abortHarvest(t,i)},e),l.map.entities.pushNeighbours(l,new h.Harvest(l,1,t,i),l),l.pushToPlayer(new h.Harvest(l,1,t,i,e))):l._abortHarvest(t,i)},_checkHarvest:function(e,t){return!!this.isNextToo(e,t)&&!!this.hasHarvestWeapon()},onHarvestEntity:function(i){var e=!0,n=(this.hasHarvestWeapon(i.weaponType)||(this.pushToPlayer(new h.Notify("CHAT","HARVEST_WRONG_TYPE",type)),e=!1),i.x),s=i.y;e?(e=5e3+1e3*i.level,this._harvest(n,s,function(e){e.server.taskHandler.processEvent(e,PlayerEvent(EventType.USE_NODE,i,1)),"hammer"==e.getWeaponType()&&(e.exp.mining+=10),i.die();var t=e.server.getDrop(e,i,!1);t&&t instanceof Item&&(t.x=n,t.y=s,e.server.handleItemDespawn(t))},e)):this._abortHarvest(n,s)},_abortHarvest:function(e,t){this.map.entities.pushNeighbours(this,new h.Harvest(this,2,e,t)),this.pushToPlayer(new h.Notify("CHAT","HARVEST_INVALID"))},onHarvest:function(e,t){var i=c.getGridPosition(e,t),n=(time=this.map.entities.harvest[i.gx+"_"+i.gy],!0),s=this.getWeaponType();s||(n=!1),this.map.isHarvestTile(i,s)||(this.pushToPlayer(new h.Notify("CHAT","HARVEST_WRONG_TYPE",s)),n=!1),(n=!(time&&Date.now()-time<6e4)&&n)?this._harvest(e,t,function(e){var t;e.server.taskHandler.processEvent(e,PlayerEvent(EventType.HARVEST,e,1)),"axe"==e.getWeaponType()&&(e.exp.logging+=10),e.map.entities.harvest[i.gx+"_"+i.gy]=Date.now(),e.inventory.hasRoom()&&("axe"==e.getWeaponType()&&(t=320),t=new ItemRoom(t,1,0,0),-1!=self.inventory.putItem(t))&&(t=o.getData(t.itemKind),e.pushToPlayer(new h.Notify("CHAT","HARVEST_ADDED",t.name)))},6e3):this._abortHarvest(e,t)},pushToPlayer:function(e){this.map.entities.pushToPlayer(this,e)}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./appearancedata":79,"./bank":82,"./character":85,"./chest":87,"./effecthandler":90,"./entityspawn":93,"./equipment":94,"./formulas":96,"./inventory":97,"./itemlootdata":99,"./items":101,"./lib/class":104,"./main":106,"./message":111,"./mob":113,"./mobdata":117,"./packethandler":125,"./party":126,"./quest":131,"./skillhandler":136,"./trade":139,"./utils":146,bcrypt:void 0,"body-parser":void 0,express:void 0,underscore:75}],129:[function(e,t,i){e("./message"),e("underscore");var a=e("./utils");t.exports=PlayerController=Class.extend({init:function(e){this.player=e,this.entities=this.player.map.entities,this.setCallbacks()},setCallbacks:function(){function i(e,t){console.info("onStopPathing");var i=n.player;n.entities.pathfinder.isPathTicksTooFast(i,i.fullpath,i.startMovePathTime)?i.setPosition(i.sx,i.sy):i.setPosition(e,t),i.sx=i.x,i.sy=i.y,console.info("p.x:"+i.x+",p.y="+i.y),s(i)}var n=this,s=(n.player.onStep(function(e,t,i){}),n.player.onRequestPath(function(e,t){var i=n.player;return n.entities.findPath(i,e,t)}),function(e){e.packetHandler.processAttack()});n.player.onStopPathing(function(e,t){console.info("onStopPathing"),i(e,t)}),n.player.onAbortPathing(function(e,t){console.info("onAbortPathing"),i(e,t)}),n.player.checkStopDanger=function(e,t){var i,n,s=!1;return(-1!=e.ex||-1!=e.ey)&&(e.x==e.ex&&e.y==e.ey?(console.warn("checkStopDanger - coordinates equal"),!0):(i=e.x,n=e.y,(s=t==Types.Orientations.LEFT&&e.x<e.ex||t==Types.Orientations.RIGHT&&e.x>e.ex||t==Types.Orientations.UP&&e.y<e.ey||t==Types.Orientations.DOWN&&e.y>e.ey?!0:s)&&(e.setPosition(e.ex,e.ey),console.warn("WARN - PLAYER "+e.id+" not stopping."),console.warn("orientation: "+a.getOrientationString(t)),console.warn("x :"+i+",y :"+n),console.warn("sx:"+e.ex+",sy:"+e.ey)),s))},n.player.setMoveStopCallback(function(){var e=n.player;console.info("setMoveStopCallback"),console.info("player, x:"+e.x+",y:"+e.y),e.checkStopDanger(e,e.moveOrientation),-1==e.ex&&-1==e.ey||e.x==e.ex&&e.y==e.ey||(console.warn("ERROR - MOVING NOT SYNCHED PROPERLY, FORCING CLIENT UPDATE"),console.info("player, orientation:"+e.moveOrientation),console.info("player, x:"+e.x+",y:"+e.y),console.info("player, sx:"+e.sx+",sy:"+e.sy),console.info("player, ex:"+e.ex+",ey:"+e.ey),e.setPosition(e.sx,e.sy),e.sendCurrentMove()),s(e)})}})},{"./message":111,"./utils":146,underscore:75}],130:[function(t,e,i){var n=t("./lib/class").Class.extend({init:function(e){this.config=e;try{this.production=t("../production_hosts/"+e.production+".js")}catch(e){this.production=null}},inProduction:function(){return null!==this.production&&this.production.isActive()},getProductionSettings:function(){if(this.inProduction())return this.production}});e.exports=n},{"./lib/class":104}],131:[function(e,t,i){e=e("./lib/class");t.exports=getQuestObject=function(e){var t={toArray:function(e){return[e.type,e.kind,e.count,e.chance,e.level[0],e.level[1]]},toClient:function(e){return[e.type,e.kind,e.count]}};return t.type=parseInt(e[0]),t.kind=parseInt(e[1])||0,t.count=parseInt(e[2])||0,t.chance=parseInt(e[3])||0,4==e.length&&(t.level=[0,99]),5==e.length&&(t.level=[parseInt(e[4]),99]),6==e.length&&(t.level=[parseInt(e[4]),parseInt(e[5])]),t},t.exports=Quest=e.Class.extend({init:function(e){e&&(this.id=parseInt(e[0]),this.type=parseInt(e[1]),this.npcQuestId=parseInt(e[2]),this.count=parseInt(e[3])||0,this.status=parseInt(e[4])||0,this.data1=parseInt(e[5])||0,this.data2=parseInt(e[6])||0,this.object=e[7]||null,this.object2=e[8]||null)},assign:function(e){this.id=e.id,this.type=e.type,this.npcQuestId=e.npcQuestId,this.count=e.count,this.status=e.status,this.data1=e.data1,this.data2=e.data2,this.object=e.object,this.object2=e.object2},toArray:function(){var e=[this.id,this.type,this.npcQuestId,this.count,this.status,this.data1,this.data2];return this.object&&(e=e.concat(this.object.toArray(this.object))),e=this.object2?e.concat(this.object2.toArray(this.object2)):e},toClient:function(){var e=[this.id,this.type,this.npcQuestId,this.count,this.status,this.data1,this.data2],e=this.object?e.concat(this.object.toClient(this.object)):e.concat(["","",""]);return e=this.object2?e.concat(this.object2.toClient(this.object2)):e.concat(["","",""])},toString:function(){return this.toArray().join(",")}})},{"./lib/class":104}],132:[function(e,t,i){e("underscore"),e("./utils");var n,s=e("./quest"),a=e("../shared/data/quests.json"),r=(e("log"),{}),o={};for(n in a){var l=a[n],h=(console.info("data:"+JSON.stringify(l)),{}),l=(h.id=n,h.npcQuestId=l.npcKind,h.raw=l,h.npcKind=l.npcKind,h.type=l.type,h.level=l.level,h.data1=l.data1||0,h.data2=l.data2||0,h.count=0,h.status=0,l.object&&(h.object=getQuestObject([l.object.type,l.object.kind,l.object.count||0,l.object.chance||0,l.object.level||[0,99]])),l.object2&&(h.object2=getQuestObject([l.object2.type,l.object2.kind,l.object2.count||0,l.object2.chance||0,l.object2.level||[0,99]])),Object.assign(new s,h));r[h.id]=l,o[h.npcKind]||(o[h.npcKind]=[]),o[h.npcKind].push(l)}console.info(JSON.stringify(o)),t.exports.Data=r,t.exports.NpcData=o},{"../shared/data/quests.json":164,"./quest":131,"./utils":146,log:60,underscore:75}],133:[function(e,t,i){e("crypto"),e("fs");function l(e,t,i){if(Array.isArray(t)){for(var n=p.multi(),s=0;s<t.length;++s)n.hget(e,t[s]);n.exec(i)}else p.hget(e,t,i)}var p,n=e("redis"),c=(e("bcrypt"),e("./utils")),s=e("./lib/class"),m=(e("./player"),e("./message"),e("./../shared/js/itemtypes")),h=e("./quest"),u=(e("./inventory"),e("./skilldata")),d=e("./appearancedata"),f=e("./items");t.exports=DatabaseHandler=s.Class.extend({init:function(e){(p=n.createClient(e.redis_port,e.redis_host,{socket_nodelay:!0})).auth(e.redis_password),p.on("error",function(e){console.error("Redis error: "+e)}),p.hgetarray=l,this.ready=!0},removeLegacyItems:function(){var u=this;p.keys("*",function(e,t){if(e)return console.log(e);for(var i=0,n=t.length;i<n;i++){var s=t[i];s.startsWith("u:")&&s.substr(2),s.startsWith("p:")&&p.hgetall(s,function(e,t){if(e)return console.log(e);for(var l=t.name,h=0,c=0,i=0;i<3;++i)u.getItems({name:l},i,function(e,t){for(var i=0,n=e.length;n--;)if(item=e[n],!m.isLootItem(item.itemKind)){var s=f.Kinds[item.itemKind];if(s){if(s&&1==s.legacy){for(var a=item.itemNumber,r=Object.assign({},item),o=1;o<a;++o)r.itemNumber=o,i+=m.getEnchantPrice(r);r.itemNumber=1,i+=m.getBuyPrice(r.itemKind),e.splice(e.indexOf(item),1)}}else e.splice(e.indexOf(item),1)}u.saveItems({name:l},t,e),c+=i,3==++h&&0<c&&u.modifyGold(l,c)})})}})},createUser:function(i){var n=this,s="u:"+i.name,a=(new Date).getTime(),e=d.Data.length;i.looks=new Uint8Array(e);for(var t=0;t<e;++t)i.looks[t]=0;i.looks[0]=1,i.looks[50]=1,i.looks[77]=1,i.looks[151]=1,i.gems=2e3,p.sismember("usr",i.name,function(e,t){1===t?(i.connection.sendUTF8(Types.Messages.SC_ERROR+",userexists"),i.connection.close("Username not available: "+i.name)):(t=c.BinToHex(i.looks),p.multi().sadd("usr",i.name).hset(s,"username",i.name).hset(s,"hash",i.hash).hset(s,"salt",i.salt).hset(s,"banTime",0).hset(s,"banDuration","").hset(s,"lastLoginTime",a).hset(s,"membership",0).hset(s,"players","").hset(s,"gems",i.gems).hset(s,"looks",t).hset(s,"ipAddresses",i.connection._connection.remoteAddress).exec(function(e,t){i.hasLoggedIn=!0,users[i.name]=1,n.sendPlayers(i)}))})},savePassword:function(e,t){p.hset("u:"+e,"hash",t)},loadUser:function(r){var o=this,l="u:"+r.name;(new Date).getTime();p.sismember("usr",r.name,function(e,t){if(1===t)return p.hgetall(l,function(e,t){if(console.info("replies: "+t),console.info(JSON.stringify(t)),null!==t&&"object"==typeof t){var i,n={hash:t.hash,salt:t.salt,banTime:t.banTime,banDuration:t.banDuration,lastLoginTime:t.lastLoginTime,membership:t.membership,players:t.players,ipAddresses:t.ipAddresses,gems:t.gems};if(t.gems?n.gems=parseInt(t.gems):n.gems=1e3,!t.looks||0===parseInt(t.looks,16)||t.looks.toLowerCase().includes("nan")){var s=d.Data.length;n.looks=new Uint8Array(s);for(var a=0;a<s;++a)n.looks[a]=0}else n.looks=c.HexToBin(t.looks);n.looks[0]=1,n.looks[50]=1,n.looks[77]=1,n.looks[151]=1,console.info(JSON.stringify(n)),r.looks=n.looks.slice(),r.gems=n.gems,r.checkUser(n)&&(i=r.connection._connection.remoteAddress,t.ipAddesses?toString(t.ipAddesses).includes(i)||p.hset(l,"ipAddresses",n.ipAddresses+","+i):p.hset(l,"ipAddresses",i),p.hset(l,"lastLoginTime",(new Date).getTime()),o.sendPlayers(r))}}),!1;r.connection.sendUTF8(Types.Messages.SC_ERROR+",invalidlogin")})},sendPlayers:function(o){var e="u:"+o.name;p.hget(e,"players",function(e,t){if(console.info("players_reply:"+t),null==t||""===t)o.sendPlayers();else for(var i=t.split(","),n=[],s=0,a=0;a<i.length;++a){var r="p:"+i[a];l(r,["name","map","exps","colors","sprites"],function(e,t){t={name:t[0],map:t[1].split(",")[0],exp:t[2].split(",")[0],colors:t[3].split(","),sprites:t[4].split(",")};n.push(t),++s==i.length&&o.sendPlayers(n)})}})},loadPlayer:function(s){var e="p:"+s.name;(new Date).getTime();return console.info("player.name: "+s.name),p.multi().hget(e,"map").hget(e,"exps").hget(e,"colors").hget(e,"pStats").hget(e,"gold").hget(e,"sprites").hget(e,"stats").hget(e,"skills").hget(e,"skillSlots").hget(e,"completeQuests").exec(function(e,t){console.info(t.toString());var i={name:s.name,map:t[0].split(","),exps:t[1].split(","),colors:t[2].split(","),pStats:t[3].split(","),gold:t[4].split(","),sprites:t[5].split(","),stats:t[6].split(","),skills:t[7].split(","),skillSlots:t[8].split(","),completeQuests:t[9]};if(1==i.skills.length)for(var n=0;n<u.Skills.length;++n)i.skills[n]=0;2==i.sprites.length&&(i.sprites[2]=151,i.sprites[3]=50),i.completeQuests&&(i.completeQuests=JSON.parse(i.completeQuests)),s.hasLoggedIn=!0,s.packetHandler.loadedPlayer=!0,players.push(s),s.sendPlayer(i)}),!0},createPlayer:function(s,a){var r="u:"+s.name,o="p:"+a.name;(new Date).getTime();p.hget(o,"name",function(e,t){if(t)s.connection.sendUTF8(Types.Messages.SC_ERROR+",playerexists"),s.connection.close("Playername not available: "+a.name);else{for(var n={name:a.name,map:[0,0,0,0],exps:[0,0,0,0,0,0,0,0,0,0],colors:[0,0],pStats:[0,0],gold:[0,0],sprites:[77,0,151,50],stats:[2,2,2,2,2,0],skills:[],skillSlots:[-1,-1,-1,-1,-1,-1]},i=0;i<u.Skills.length;++i)n.skills[i]=0;p.multi().hset(o,"name",n.name).hset(o,"map",n.map.join(",")).hset(o,"exps",n.exps.join(",")).hset(o,"colors",n.colors.join(",")).hset(o,"pStats",n.pStats.join(",")).hset(o,"gold",n.gold.join(",")).hset(o,"sprites",n.sprites.join(",")).hset(o,"stats",n.stats.join(",")).hset(o,"skills",n.skills.join(",")).hset(o,"skillSlots",n.skillSlots.join(",")).exec(function(e,t){console.info(e),console.info(JSON.stringify(t)),console.info("New User: "+a.name),s.loadedPlayer=!0,p.hget(r,"players",function(e,t){var i=[];(i=t?t.split(","):i).push(a.name),p.hset(r,"players",i.join(",")),players.push(a),a.sendPlayer(n)})})}})},savePlayer:function(e){for(var t="p:"+e.name,i="u:"+e.user.name,n=[e.stats.attack,e.stats.defense,e.stats.health,e.stats.energy,e.stats.luck,e.stats.free],s=[c.NaN2Zero(e.exp.base),c.NaN2Zero(e.exp.attack),c.NaN2Zero(e.exp.defense),c.NaN2Zero(e.exp.move),c.NaN2Zero(e.exp.sword),c.NaN2Zero(e.exp.bow),c.NaN2Zero(e.exp.hammer),c.NaN2Zero(e.exp.axe),c.NaN2Zero(e.exp.logging),c.NaN2Zero(e.exp.mining)],a=[e.map.index,e.x,e.y,e.orientation],r=[],o=0;o<e.skills.length;++o)r[o]=e.skills[o].skillXP;var l=0<Object.keys(e.completeQuests).length?JSON.stringify(e.completeQuests):0,h=c.BinToHex(e.user.looks);p.multi().hset(t,"map",a.join(",")).hset(t,"stats",n.join(",")).hset(t,"exps",s.join(",")).hset(t,"gold",e.gold.join(",")).hset(t,"skills",r.join(",")).hset(t,"skillSlots",e.skillSlots.join(",")).hset(t,"pStats",e.pStats.join(",")).hset(t,"sprites",e.sprites.join(",")).hset(t,"colors",e.colors.join(",")).hset(t,"completeQuests",l).hset(i,"looks",h).hset(i,"gems",e.user.gems).exec(function(e,t){})},modifyGold:function(i,n,s){var s=s||0,n=parseInt(n),a="p:"+i;p.hget(a,"gold",function(e,t){console.info("modifyGold.gold: "+JSON.stringify(t)),t?((t=t.split(","))[s]=parseInt(t[s])+n,p.hset(a,"gold",t.join(","))):console.error("redis.modifyGold - no gold record for player '"+i+"' found.")})},modifyGems:function(e,i){var n="u:"+e,i=parseInt(i);p.hget(n,"gems",function(e,t){t=parseInt(t);p.hset(n,"gems",t+=i)})},getStoreType:function(e){var t;switch(e){case 0:t="iItem_";break;case 1:t="bItem_";break;case 2:t="eItem_"}return t},getStoreTypeNew:function(e){var t;switch(e){case 0:t="inventory";break;case 1:t="bank";break;case 2:t="equipment"}return t},getItems:function(r,o,l){var h=this,c="p:"+r.name,e=this.getStoreTypeNew(o);p.hget(c,e,function(e,t){if(e||!t)h.getItemsOld(r,o,l);else if(""==t)h.getItemsOld(r,o,l);else{var i=[];console.info(c),console.info("getItems - data="+t),dataJSON=JSON.parse(t);for(var n=0;n<dataJSON.length;n++){var s,a=dataJSON[n];a&&((s=new ItemRoom(parseInt(a[1]),parseInt(a[2]),parseInt(a[3]),parseInt(a[4]),parseInt(a[5]))).slot=parseInt(a[0]),i.push(s))}l(i,o)}})},getItemsOld:function(e,s,a){var e="p:"+e.name,r=this.getStoreType(s),o=(p.multi(),[]);p.hgetall(e,function(e,t){if(null===t)a([],s);else{for(var i in t){var n=t[i];i.startsWith(r)&&(i=i.substr(6),n=n.split(","),(n=new ItemRoom(parseInt(n[0]),parseInt(n[1]),parseInt(n[2]),parseInt(n[3]),parseInt(n[4]))).slot=i,o.push(n))}a(o,s)}})},saveItems:function(e,t,i){for(var n="p:"+e.name,s=48,a=(2==t&&(s=5),this.getStoreType(t)),r=this.getStoreTypeNew(t),o=p.multi(),l=0;l<s;l++)o.hdel(n,a+l);o.exec(function(e,t){e&&console.error(e)});var h=e.inventory;1==t&&(h=e.bank),(h=2==t?e.equipment:h)&&p.hset(n,r,h.toStringJSON())},saveQuests:function(e,t){for(var i="p:"+e.name,n=null,s=[],a="[",r=!1,o=0;o<t.length;++o)(n=t[o])&&n.status!=QuestStatus.COMPLETE&&!_.isEmpty(n)&&(s.push(n.id),a+="["+n.toString()+"],",r=!0);a=a.slice(0,-1),a+="]",p.hset(i,"newquests2",a=r?a:"[]"),this.deleteOldQuests(e)},deleteOldQuests:function(e){console.info("deleteOldQuests");var n="p:"+e.name;p.hgetall(n,function(e,t){if(null!==t){for(var i in console.info("client.hgetall="+JSON.stringify(t)),t){t[i];i.startsWith("q_")&&p.hdel(n,i)}p.hdel(n,"quests"),p.hdel(n,"quests2"),p.hdel(n,"newquests")}})},loadQuests:function(a,r){console.info("loadQuest");var o="p:"+a.name;p.multi();p.hget(o,"newquests2",function(e,t){if(!e&&t&&""!=t){console.info(o),console.info("getItems - data="+t),dataJSON=JSON.parse(t);for(var i=0;i<dataJSON.length;i++){var n,s=dataJSON[i];s&&(console.info(JSON.stringify(s)),n=new h(s.splice(0,7)),0<s.length&&(n.object=getQuestObject(s.splice(0,6))),0<s.length&&(n.object2=getQuestObject(s.splice(0,6))),a.quests.push(n))}}r(a)})},saveAchievements:function(e){console.info("saveAchievement");var t,i="p:"+e.name,n="";for(t of e.achievements)n+=t.toArray(t).join(",")+",";p.hset(i,"achievements",n)},loadAchievements:function(o,l){console.info("loadAchievement");var e="p:"+o.name;p.hget(e,"achievements",function(e,t){var i=getInitAchievements();if(e||!t)o.achievements=i;else{for(var n=t.split(","),s=~~(n.length/7),a=0;a<s;++a){var r=getAchievementObject(n.splice(0,7));o.achievements.push(r)}for(a=s;a<i.length;++a)o.achievements.push(i[a])}l(o)})},loadAuctions:function(a,r){p.hgetall("s:auction",function(e,t){var i={};if(null===t||"object"!=typeof t)console.warn("loadAuctions - err: "+JSON.stringify(e)),console.warn("loadAuctions - data: "+JSON.stringify(t)),r(a,{});else{for(var n=0;n<Object.keys(t).length;++n){var s=t[n].split(","),s=new AuctionRecord(s[0],parseInt(s[1]),new ItemRoom(parseInt(s[2]),parseInt(s[3]),parseInt(s[4]),parseInt(s[5]),parseInt(s[6])));i[n]=s}r(a,i)}})},saveAuctions:function(e){p.del("s:auction");for(var t=0,i=p.multi(),n=0;n<Object.keys(e).length;++n)e[n]&&i.hset("s:auction",t++,e[n].save(n));i.exec(function(e,t){e&&console.error("saveAuctions: "+JSON.stringify(e)),AUCTION_SAVED=!0})},loadLooks:function(e){p.hget("l:looks","prices",function(e,t){t&&t.split(",")})},saveLooks:function(e){p.hset("l:looks","prices",e.join(","))}})},{"./../shared/js/itemtypes":168,"./appearancedata":79,"./inventory":97,"./items":101,"./lib/class":104,"./message":111,"./player":128,"./quest":131,"./skilldata":135,"./utils":146,bcrypt:void 0,crypto:void 0,fs:void 0,redis:void 0}],134:[function(e,t,i){e=e("./lib/class");t.exports=RequestHandler=e.Class.extend({init:function(e,t){this.player=e,this.targetPlayer=t}})},{"./lib/class":104}],135:[function(e,t,i){e("underscore");var n,s=e("../shared/data/skills2.json"),a=(e("./effecthandler"),[]);for(n in s){var r=s[n];console.info(n+"="+JSON.stringify(r)),a.push({skillType:r.skillType,targetType:r.targetType||0,duration:r.duration||0,durationPL:r.durationPL||0,recharge:r.recharge?1e3*r.recharge:0,aoe:r.aoe||0,countTotal:r.countTotal||0,effectTypes:function(e){var t=[];for(rec in e)t.push(new EffectType(1==rec[0],rec[1],rec[2],rec[3]))}(r.effects)})}console.info("skills: "+JSON.stringify(a)),t.exports.Skills=a},{"../shared/data/skills2.json":165,"./effecthandler":90,underscore:75}],136:[function(e,t,i){var n=e("./lib/class"),s=e("./skilldata.js"),a=e("./message.js");t.exports=SkillHandler=n.Class.extend({init:function(e){e.skills=[],this.player=e,this.skills=this.player.skills},clear:function(){},setSkills:function(e,t){for(var i=0;i<t.length;++i){var n=new Skill(e,i,t[i]);e.skills[i]=n}},setSkill:function(e,t){e=player.skills[e];e.skillXP=t,e.skillLevel=Types.getSkillLevel(t)},setXPs:function(){for(var e=[],t=0;t<this.skills.length;++t){var i=this.skills[t],n=parseInt(i.tempXP);0<n&&(i.xp(n),e.push(t,i.skillXP),i.tempXP=0)}0<e.length&&this.player.map.entities.pushToPlayer(this.player,new a.SkillXP(e))}}),Skill=n.Class.extend({init:function(e,t,i){this.player=e,console.info("skillIndex:"+t),this.skillData=s.Skills[t],this.skillIndex=t,this.skillLevel=Types.getSkillLevel(i),this.skillXP=i,(this.tempXP=0)<this.skillData.recharge&&(this.skillCooldown=new Timer(this.skillData.recharge),this.skillCooldown.lastTime=0)},getSkill:function(){return this.skillData},isReady:function(){return this.skillCooldown.isOver()},xp:function(e){0!=e&&(console.info("amount="+e),this.skillXP+=e,(e=Types.getSkillLevel(this.skillXP,this.skillLevel))!=this.skillLevel)&&(this.skillLevel=e,this.player.map.entities.pushToPlayer(this.player,new a.SkillLoad(this.skillIndex,this.skillXP)))}})},{"./lib/class":104,"./message.js":111,"./skilldata.js":135}],137:[function(e,t,i){var n,s=e("./lib/class"),u=(e("./entitymoving"),e("./message")),a=(e("../shared/js/gametypes"),e("../shared/data/achievements.json")),r=(t.exports.getAchievementObject=getAchievementObject=function(e){var t={toArray:function(e){return[e.index,e.type,e.rank,e.objectType,e.objectKind,e.count,e.objectCount]},toClient:function(e){return e.toArray(e)}};return t.index=parseInt(e[0]),t.type=parseInt(e[1]),t.rank=parseInt(e[2])||0,t.objectType=parseInt(e[3])||0,t.objectKind=parseInt(e[4])||0,t.count=parseInt(e[5])||0,t.objectCount=parseInt(e[6])||0,t},0);for(n of a){var o,l=1;for(o of n){o.rank=l++;var h=[r,o.type,o.rank,o.objectType,o.objectKind,0,o.count];o.object=getAchievementObject(h)}r++}t.exports.getInitAchievements=getInitAchievements=function(){for(var e=[],t=a.length,i=0;i<t;++i){var n=a[i][0].object;n.index=i,e.push(n)}return e},t.exports.PlayerEvent=PlayerEvent=function(e,t,i){var n={};return n.eventType=e,n.object=t,n.count=i,n},t.exports=TaskHandler=s.Class.extend({init:function(){this.data=a},processEvent:function(e,t){switch(t.eventType){case EventType.KILLMOB:for(var i of e.quests)e.questAboutKill(t.object,i);break;case EventType.LOOTITEM:for(var i of e.quests)i.type==QuestType.GETITEMKIND&&i.object2.kind==t.object.kind-1e3&&e.questAboutItem(i);break;case EventType.USE_NODE:for(var i of e.quests)i.type==QuestType.USENODE&&i.object.kind==t.object.kind&&i.data1==t.object.level&&e.questAboutUseNode(i)}for(var n of e.achievements)this.processAchievement(e,t,n,function(e,t){return e.type==EventType.KILLMOB&&(0==e.objectKind||e.objectKind==t.object.kind)},15),this.processAchievement(e,t,n,function(e,t){return e.type==EventType.LOOTITEM&&t.object.hasOwnProperty("enemyDrop")},25),this.processAchievement(e,t,n,function(e,t){return e.type==EventType.DAMAGE},.25),this.processAchievement(e,t,n,function(e,t){return e.type==EventType.USE_NODE&&"hammer"==t.object.weaponType},10),this.processAchievement(e,t,n,function(e,t){return e.type==EventType.HARVEST&&"axe"==t.object.getWeaponType()},10),this.processAchievement(e,t,n,function(e,t){return e.type==EventType.USE_NODE},10)},processAchievement:function(e,t,i,n,s){if(t.eventType==i.type&&n(i,t)){var a=e.achievements.indexOf(i);if(!(a<0||a>=this.data.length)){var r=t.count;if(i.count+r<i.objectCount)i.count+=r;else{var o=this.data[a].length;if(i.rank==o&&i.count==i.objectCount)return;for(;0<r;){var l=i.count,h=i.count+r,h=(i.count=Math.min(h,i.objectCount),r-=i.objectCount-l,e.map.entities.pushToPlayer(e,new u.Achievement(i)),~~(i.objectCount*s)),l="ACHIEVEMENTS_"+a+"_COMPLETE",c=i.objectCount;if(1e6<=c?c=Number(c/1e6).toFixed(1).replace(/[.,]0$/,"")+"M":1e3<=c&&(c=Number(c/1e3).toFixed(1).replace(/[.,]0$/,"")+"K"),e.map.entities.pushToPlayer(e,new u.Notify("CHAT",l,[c,h])),i.rank==o&&i.count==i.objectCount)return;e.achievements[a]=i=this.data[a][i.rank].object,r<i.objectCount&&(i.count=r,r=0)}}e.map.entities.pushToPlayer(e,new u.Achievement(i))}}}})},{"../shared/data/achievements.json":149,"../shared/js/gametypes":167,"./entitymoving":92,"./lib/class":104,"./message":111}],138:[function(e,t,i){e=e("./lib/class");t.exports=Timer=e.Class.extend({init:function(e,t){this.lastTime=t,!isNaN(t)&&null!==t&&0!==t||(this.lastTime=Date.now()),this.duration=e},isOver:function(e){var t=!1;return(e=!isNaN(e)&&null!==e&&0!==e?e:Date.now())-this.lastTime>this.duration&&(t=!0,this.lastTime=e),t}})},{"./lib/class":104}],139:[function(e,t,i){var n=e("./lib/class"),h=e("../shared/js/gametypes"),s=e("./requesthandler"),c=e("./message");t.exports=Trade=n.Class.extend({init:function(e,t,i){this.player=e,this.otherPlayer=t,this.requestAssistant=new s(e,t),this.items={},this.currentState=null,this.rooms=i,this.roomId=0},sendRequest:function(e,t){this.otherPlayerSentRequest&&this.currentPlayerSentRequest||this.currentPlayerSentRequest&&this.otherPlayerSentRequest?this.startTradingProcess(e,t):e&&t?(e.map.entities.pushToPlayer(e,new c.Notify("TRADE","TRADE_REQUESTED",[t.name])),t.map.entities.pushToPlayer(t,new c.Notify("TRADE","TRADE_REQUEST",[e.name])),this.currentPlayerSentRequest=!0):console.info("An error has occured.")},startTradingProcess:function(e,t){e.admin?e.map.entities.pushToPlayer(e):(this.currentState=h.Messages.INVENTORYSTATE.STARTED,t.server.pushToPlayer(t,h.Messages.TRADESCREEN),e.map.entities.pushToPlayer(e,h.Messages.TRADESCREEN))},addItemToTradeSession:function(e,t,i,n,s,a,r){for(var o=0;o<i.inventory.rooms;o++)for(var l in o)ItemTypes.isConsumableItem(l.kind)?(i.map.entities.pushToPlayer(i,h.Messages.TRADESTATES.TRADECOUNT),a<t?(this.items.push(e,t),i.map.entities.pushToPlayer(i,new c.TradeStates)):this.items.push(e,a)):this.items.push(e,t)},removeItemFromTradeSession:function(e,t,i,n,s){for(s in this.roomId=s,this.rooms)s.delete(e,t),i.map.entities.pushToPlayer(i,h.Messages.TRADESTATES.ITEMREMOVED)}})},{"../shared/js/gametypes":167,"./lib/class":104,"./message":111,"./requesthandler":134}],140:[function(e,t,i){t.exports=Transition=Class.extend({init:function(){this.startValue=0,this.endValue=0,this.duration=0,this.inProgress=!1,this.currentValue=0},start:function(e,t,i,n,s,a,r){this.startTime=e,this.updateFunction=t,this.incFunction=i,this.stopFunction=n,this.modValue=s,this.duration=a,this.inProgress=!0,this.object=r},step:function(e){if(this.inProgress){this.startTime;var t=this.duration,i=this.modValue,t=Math.round(i/this.duration*t);if(0!=i&&0!=t)if(this.updateFunction)for(var n,s=Math.abs(t),a=0<t?1:-1,r=1;r<=s;++r)if(n=this.incFunction(this.object),this.updateFunction(n+a))return void this.stop()}},restart:function(e,t,i){this.start(e,this.updateFunction,this.stopFunction,this.startValue,this.endValue,this.duration),this.step(e)},stop:function(){this.stopFunction&&this.stopFunction(j),this.inProgress=!1}})},{}],141:[function(e,t,i){e("./lib/class");var n=e("./entitymoving"),c=e("../shared/js/gametypes");t.exports=Block=n.extend({init:function(e,t,i,n,s,a,r,o,l){var h=this.type=c.EntityTypes.TRAP;this.parent=a,this.ix=o,this.iy=l,this._super(e,h,t,i,n,s),this.name=r,this.active=!0},getState:function(){return this._getBaseState().concat([parseInt(this.ix),parseInt(this.iy),parseInt(this.active?1:0)])},on:function(){this.active=!0,this.map.entities.pushNeighbours(this,new Messages.SwapSprite(this.id,1))},off:function(){this.active=!1,this.map.entities.pushNeighbours(this,new Messages.SwapSprite(this.id,0))}})},{"../shared/js/gametypes":167,"./entitymoving":92,"./lib/class":104}],142:[function(e,t,i){e("./lib/class");var n=e("./area"),l=e("./timer"),r=e("./trapgroup"),o=e("./utils");e("../shared/js/gametypes");t.exports=TrapArea=n.extend({init:function(e,t,i,n,s,a,r,o){this._super(e,t,i,n,s,a),this.groups=[],this.checkTimer=new l(500),this.damage=r||0,this.switchInterval=o||1e3},addGroup:function(e){this.groups.push(e)},addRandomGroup:function(e,t,i,n){for(var s=null,n=n||50,a=0;a++<n&&(s=[this.gx+o.randomInt(this.width/G_TILESIZE-t),this.gy+o.randomInt(this.height/G_TILESIZE-i)],!this.isGroupEmptyPositions(s,t,i));)s=null;s?(e=new r(e,s[0],s[1],t,i,this.map,this.damage,this.switchInterval),this.addGroup(e)):console.error("TrapArea - addRandomGroup - failed, threshold reached.")},isGroupEmptyPositions:function(e,t,i){console.info("isGroupEmptyPositions: pos=["+e[0]+","+e[1]+"],w="+t+",h="+i);for(var n=0;n<t;++n)for(var s=0;s<i;++s)if(!this.map.entities.isGridPositionEmpty((e[0]+n)*G_TILESIZE,(e[1]+s)*G_TILESIZE))return!1;return!0},isTouching:function(e){var t=G_TILESIZE>>1,i=this.x*G_TILESIZE-t,n=(this.x+this.width)*G_TILESIZE+t,s=this.y*G_TILESIZE-t,t=(this.y+this.width)*G_TILESIZE+t;return _.inRange(e.x,i,n)&&_.inRange(e.y,s,t)},update:function(e){if(this.checkTimer.isOver()&&this.isTouching(e))for(var t of this.groups)t.update(e)}})},{"../shared/js/gametypes":167,"./area":80,"./lib/class":104,"./timer":138,"./trapgroup":143,"./utils":146}],143:[function(e,t,i){var n=e("./lib/class"),r=e("./trap"),l=e("./timer");e("./utils"),e("../shared/js/gametypes");t.exports=TrapGroup=n.Class.extend({init:function(e,t,i,n,s,a,r,o){this.kind=e,this.x=t,this.y=i,this.width=n,this.height=s,this.traps=[],this.entities={},this.map=a,this.damaging=!1,this.switchTimer=new l(o||1e3),this.damage=this.damage||0,this.damageInterval=1e3,this.generateTraps()},generateTraps:function(){for(var e=this.width,t=this.height,i=this.map.entities.entityCount,n=0;n<t;++n)for(var s=0;s<e;++s){var a=new r(a=i+(e*n+s),this.kind,(this.x+s)*G_TILESIZE,(this.y+n)*G_TILESIZE,this.map,this,"trap"+a+"-"+n+"_"+s,s,n);this.map.entities.addEntity(a),this.traps.push(a)}this.map.entities.entityCount+=e*t},isTouching:function(e){var t=G_TILESIZE>>1,i=this.x*G_TILESIZE-t,n=(this.x+this.width)*G_TILESIZE+t,s=this.y*G_TILESIZE-t,t=(this.y+this.width)*G_TILESIZE+t;return _.inRange(e.x,i,n)&&_.inRange(e.y,s,t)},update:function(e){var t=this.damaging;if(this.switchTimer.isOver()&&(this.damaging=!this.damaging),t!=this.damaging)if(this.damaging)for(var i of this.traps)i.on();else for(var i of this.traps)i.off();if(this.damaging&&this.isTouching(e)){var n=null;for(i of this.traps)if(trip.isTouching(e)){n=e;break}t=e.id;n?this.entities.getOwnProperty(t)&&this.entities[t]?this.entities[t].isOver()&&player.onDamage(this,this.damage):(player.onDamage(this,this.damage),this.entities[t]=new l(this.damageInterval)):this.entities[t]=null}}})},{"../shared/js/gametypes":167,"./lib/class":104,"./timer":138,"./trap":141,"./utils":146}],144:[function(e,t,i){e("./message"),e("underscore"),e("./utils");t.exports=Updater=Class.extend({init:function(e,t){this.ws=e,this.server=e,this.map=t,this.time=Date.now(),this.whoDist=8*G_TILESIZE},update:function(){var e,t=null;for(e in this.time=Date.now(),this.map.entities.entities){var i=this.map.entities.entities[e];i&&i instanceof Character&&(i.isDying||i.isDead||i.isStunned||(i instanceof Player?(this.updatePlayerKeyMovement(i),i.path&&this.updatePlayerPathMovement(i),i.neighboursUpdated=!1):i.path&&this.updateCharacterPathMovement(i),(t=i.movement)&&t.inProgress&&t.step(this.time)))}},checkCollide:function(e,t,i){if(e instanceof Player)return!!e.map.isColliding(t,i)||!(!e.holdingBlock||(pos=e.nextTile(),!e.map.isColliding(pos[0],pos[1])))},moveCharacter:function(e,t,i,n){return!this.checkCollide(e,t,i,n)||(c.setPosition(c.x,c.y),console.warn("char.isColliding("+e.id+","+i+","+n+")"),!1)},updateCharacterPathMovement:function(t){var e,i,n=t.tick*G_FRAME_INTERVALS,s=this.time,a=t.moveSpeed;t.isDying||t.isDead||t.freeze||t.isStunned||(e=function(e){return t.setPosition(e,t.y),t.nextStep()},!(i=function(e){return t.setPosition(t.x,e),t.nextStep()})===t.movement.inProgress&&t.isMovingPath()&&(t.orientation==Types.Orientations.LEFT?t.movement.start(s,e,function(e){return e.x},null,-n,a,t):t.orientation==Types.Orientations.RIGHT?t.movement.start(s,e,function(e){return e.x},null,n,a,t):t.orientation==Types.Orientations.UP?t.movement.start(s,i,function(e){return e.y},null,-n,a,t):t.orientation==Types.Orientations.DOWN&&t.movement.start(s,i,function(e){return e.y},null,n,a,t)))},updatePlayerPathMovement:function(t){var e,i,n=this,s=t.tick*G_FRAME_INTERVALS,a=this.time,r=t.moveSpeed;t.isDying||t.isDead||t.freeze||t.isStunned||(e=function(e){return t.setPosition(e,t.y),e%n.whoDist==0&&t.map.entities.processWho(t),t.nextStep()},!(i=function(e){return t.setPosition(t.x,e),e%n.whoDist==0&&t.map.entities.processWho(t),t.nextStep()})===t.movement.inProgress&&t.isMovingPath()&&(t.orientation==Types.Orientations.LEFT?t.movement.start(a,e,function(e){return e.x},null,-s,r,t):t.orientation==Types.Orientations.RIGHT?t.movement.start(a,e,function(e){return e.x},null,s,r,t):t.orientation==Types.Orientations.UP?t.movement.start(a,i,function(e){return e.y},null,-s,r,t):t.orientation==Types.Orientations.DOWN&&t.movement.start(a,i,function(e){return e.y},null,s,r,t)))},updatePlayerKeyMovement:function(t){var e,i,n=this,s=this.time,a=t.tick*G_FRAME_INTERVALS,r=t.moveSpeed,o=t.moveOrientation;t.freeze||t.isMovingPath()||(e=function(e){return((t.startMoving||e%G_TILESIZE==0)&&n.checkCollide(t,e,t.y)||(t.startMoving=!1,t.setPosition(e,t.y),e%n.whoDist==0&&t.map.entities.processWho(t),!!t.checkStopDanger(t,o)))&&(t.forceStopMove(),!0)},!(i=function(e){return((t.startMoving||e%G_TILESIZE==0)&&n.checkCollide(t,t.x,e)||(t.startMoving=!1,t.setPosition(t.x,e),e%n.whoDist==0&&t.map.entities.processWho(t),!!t.checkStopDanger(t,o)))&&(t.forceStopMove(),!0)})===t.movement.inProgress&&0<o&&(o==Types.Orientations.LEFT?t.movement.start(s,e,function(e){return e.x},null,-a,r,t):o==Types.Orientations.RIGHT?t.movement.start(s,e,function(e){return e.x},null,a,r,t):o==Types.Orientations.UP?t.movement.start(s,i,function(e){return e.y},null,-a,r,t):o==Types.Orientations.DOWN&&t.movement.start(s,i,function(e){return e.y},null,a,r,t)))}})},{"./message":111,"./utils":146,underscore:75}],145:[function(e,t,i){var n=e("./lib/class"),s=(e("underscore"),e("crypto")),a=e("./message"),r=e("./utils"),o=e("./format").check,l=e("../shared/js/gametypes"),h=(e("bcrypt"),e("express")),c=(e("body-parser"),h(),e("./appearancedata")),u=(e("./packethandler"),e("crypto-js"));function p(e,t){return this.index=e,this.name=t.name,this.exp=t.exp,this.colors=t.colors,this.sprites=t.sprites,this}p.prototype.toArray=function(){return[this.index,this.name,this.exp,this.colors[0],this.colors[1],this.sprites[0],this.sprites[1]]},p.prototype.toString=function(){return this.toArray().join(",")},t.exports=User=n.Class.extend({init:function(e,t){var i=this;this.main=e,this.connection=t,this.currentPlayer=null,this.players=[],this.loadedUser=!1,this.loadedPlayer=!1,this.formatChecker=new FormatChecker,this.looks=new Array(c.Data.length),this.gems=0,this.listener=function(e){console.info("recv[0]="+e);var t=parseInt(e[0]);o(e)?(e.shift(),t===l.Messages.BI_SYNCTIME?i.handleSyncTime(e):t===l.Messages.CS_CREATE_USER?i.handleCreateUser(e):t===l.Messages.CS_LOGIN_USER?i.handleLoginUser(e):i.loadedUser?t===l.Messages.CS_CREATE_PLAYER?i.handleCreatePlayer(e):t===l.Messages.CS_LOGIN_PLAYER?i.handleLoginPlayer(e):i.loadedPlayer||console.info("Cannot Login: "+e):console.info("Cannot Login User: "+e)):i.connection.close("Invalid "+l.getMessageTypeAsString(t)+" message format: "+e)},this.connection.listen(this.listener),this.connection.onClose(function(){console.info("onClose - called"),clearTimeout(this.disconnectTimeout),i.onExit(),this.close("onClose"),i.onClose()})},onClose:function(e){console.warn("User.onClose - called."),this.name&&(console.warn("name:"+this.name),users[this.name]=0);var t=this.currentPlayer;(e=e||!1)&&t&&(this.loadedPlayer&&t.save(),players.splice(players.indexOf(t),1),delete this.currentPlayer),delete users[this.name],console.warn(JSON.stringify(users))},onExit:function(){},send:function(e){this.connection.send(e)},handleSyncTime:function(e){e=parseInt(e[0]);worlds[0];this.connection.sendUTF8([l.Messages.BI_SYNCTIME,e,Date.now()].join(","))},handleCreateUser:function(e){var t=r.sanitize(e[0]),e=r.sanitize(e[1]),e=r.btoa(e),t=(console.info("Starting Client/Server Handshake"),this.name=t.substr(0,16).trim().toLowerCase(),console.info("self.user.name="+this.name),u.AES.decrypt(e,this.hashChallenge)),t=JSON.parse(t.toString(u.enc.Utf8)),i=(new Date).valueOf().toString(),n=Math.random().toString(),i=s.createHash("sha1").update(i+n).digest("hex");e=s.createHash("sha1").update(t+i).digest("hex");try{r.checkInputName(this.name)?(this.hash=e,this.salt=i,DBH.createUser(this)):this.connection.sendUTF8(l.Messages.SC_ERROR+"invalidusername")}catch(e){console.info("message="+e.message),console.info("stack="+e.stack)}},handleLoginUser:function(e){var t=r.sanitize(e[0]),e=r.sanitize(e[1]),e=r.btoa(e);console.info("Starting Client/Server Handshake"),this.name=t.substr(0,16).trim().toLowerCase(),console.info("self.name="+this.name);try{r.checkInputName(this.name)?(this.hash=e,DBH.loadUser(this)):this.connection.sendUTF8(l.Messages.SC_ERROR+",invalidname")}catch(e){console.info("message="+e.message),console.info("stack="+e.stack)}},checkUser:function(e){var t=Date.now();if(t<e.banTime+e.banDuration)return this.connection.sendUTF8(l.Messages.SC_ERROR+",ban"),this.connection.close("Closing connection to: "+player.name),!1;e.membershipTime>t&&(user.membership=!0);t=u.AES.decrypt(this.hash,this.hashChallenge),t=JSON.parse(t.toString(u.enc.Utf8)),t=s.createHash("sha1").update(t+e.salt).digest("hex");if(console.info("checkUser: "+t+" != "+e.hash),t!=e.hash)return this.connection.sendUTF8(l.Messages.SC_ERROR+",invalidlogin"),3<++this.passwordTries&&this.connection.close("Wrong Password: "+this.name),!1;if(console.warn(JSON.stringify(users)),console.info("LOGIN: "+this.name),users.hasOwnProperty(this.name)&&1==users[this.name])return this.connection.sendUTF8(l.Messages.SC_ERROR+",loggedin"),!1;users[this.name]=1,this.hasLoggedIn=!0;new Date,new Date(e.lastLoginTime);return!0},sendPlayers:function(e){if(this.loadedUser=!0,Array.isArray(e)){for(var t=[l.Messages.SC_PLAYER_SUM,e.length],i=0;i<e.length;++i){var n=new p(i,e[i]);this.players.push(n),t=t.concat(n.toArray())}this.connection.sendUTF8(t.join(","))}else this.connection.sendUTF8(l.Messages.SC_PLAYER_SUM+",0")},handleCreatePlayer:function(e){var t=parseInt(e[0]),e={name:r.sanitize(e[1])};if(console.info("Starting Client/Server Handshake"),e.name=e.name.substr(0,16).trim(),r.checkInputName(e.name)){var i,e={name:e.name,map:0,exp:0,colors:[0,0],sprites:[0,0]},n=new p(this.players.length,e);this.players.push(n),console.info("self.player.name="+e.name);try{this.loginPlayer(t,n)&&((i=this.currentPlayer).name=e.name,DBH.createPlayer(this,i))}catch(e){console.info("message="+e.message),console.info("stack="+e.stack)}}else user.connection.sendUTF8(l.Messages.SC_ERROR+",invalidname")},handleLoginPlayer:function(e){var t=parseInt(e[0]),e=parseInt(e[1]);if(e<0&&e>=this.players.length)return!1;this.loginPlayer(t,this.players[e])&&DBH.loadPlayer(this.currentPlayer)},loginPlayer:function(e,t){if(e<0&&e>=worlds.length)return!1;console.info("worldIndex: "+e);var e=worlds[e],i=new Player(this,this.main,this.connection,e);return i.name=t.name,e.connect_callback(i),this.currentPlayer=i,this.loadedPlayer=!0},modifyGems:function(e){return e=parseInt(e),this.gems-e<0?(this.connection.send(new a.Notify("SHOP","SHOP_NOGEMS").serialize()),!1):(this.gems+=e,this.connection.send(new a.Gold(this.currentPlayer).serialize()),!0)}})},{"../shared/js/gametypes":167,"./appearancedata":79,"./format":95,"./lib/class":104,"./message":111,"./packethandler":125,"./utils":146,bcrypt:void 0,"body-parser":void 0,crypto:void 0,"crypto-js":void 0,express:void 0,underscore:75}],146:[function(e,t,i){var s={},n=e("sanitizer"),a=e("../shared/js/gametypes"),r=e("../shared/js/itemtypes");s.sanitize=function(e){return n.escape(n.sanitize(e))},s.random=function(e){return Math.floor(Math.random()*e)},s.randomRange=function(e,t){return e+Math.random()*(t-e)},s.randomInt=function(e){return Math.floor(Math.random()*(e+1))},s.randomRangeInt=function(e,t){return e+Math.floor(Math.random()*(t-e+1))},s.percentToBool=function(e){return Math.random()<.01*e},s.ratioToBool=function(e){return Math.random()<e},s.clamp=function(e,t,i){return i<e?e:t<i?t:i},s.randomOrientation=function(){var e,t=s.random(4);return 0===t&&(e=a.Orientations.LEFT),1===t&&(e=a.Orientations.RIGHT),2===t&&(e=a.Orientations.UP),e=3===t?a.Orientations.DOWN:e},s.getOrientationString=function(e){var t="NONE";return 1===e?t="UP":2===e?t="DOWN":3===e?t="LEFT":4===e&&(t="RIGHT"),t},s.getOrientationFromLastMove=function(e){var t,i,n;return e.path&&0!=e.path.length?(t=e.path[e.path.length-1][0],i=e.path[e.path.length-1][1],e=1==e.path.length?(n=e.x,e.y):(n=e.path[e.path.length-2][0],e.path[e.path.length-2][1]),n<t?a.Orientations.RIGHT:t<n?a.Orientations.LEFT:e<i?a.Orientations.DOWN:i<e?a.Orientations.UP:void 0):s.randomOrientation()},s.randomPositionNextTo=function(e){var t=e.x,e=e.y,i=s.random(4);return 0===i&&--t,1===i&&++t,2===i&&--e,3===i&&++e,{x:t,y:e}},s.Mixin=function(e,t){if(t)for(var i,n=Object.keys(t),s=n.length;s--;)i=n[s],t.hasOwnProperty(i)&&(e[i]=t[i]);return e},s.distanceTo=function(e,t,i,n){e=Math.abs(e-i),i=Math.abs(t-n);return i<e?e:i},s.manhattenDistance=function(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)},s.realDistance=function(e,t){return~~Math.pow(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2),.5)},s.NaN2Zero=function(e){return isNaN(+e)?0:+e},s.trueFalse=function(e){return"true"===e},s.utilSleep=function(t){return new Promise(e=>setTimeout(e,t))},s.removeDoubleQuotes=function(e){return e.toString().replace(/^"(.+(?="$))"$/,"$1")},s.max=function(e,t){Math.max.apply(Math,e.map(function(e){return e[t]}))},s.min=function(e,t){Math.min.apply(Math,e.map(function(e){return e[t]}))},s.array_values=function(e){var t=[],i="";for(i in e)t[t.length]=e[i];return t},s.arraysEqual=function(e,t){if(e!==t){if(null==e||null==t)return!1;if(e.length!=t.length)return!1;for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!1}return!0},s.setEquipmentBonus=function(e){if(r.isWeapon(e)||r.isArcherWeapon(e)||r.isArmor(e))for(var t=s.random(1024),i=0,n=1;n<=1024;n*=2){if(t<n)return Math.max(10-i,1);++i}return 1},s.pad=function(e,t){for(var i=e+"";i.length<t;)i="0"+i;return i},s.checkInputName=function(e){if(null===e)return!1;if(""===e)return!1;if(" "===e)return!1;for(var t=0;t<e.length;t++){var i=e.charCodeAt(t);if(!(44032<=i&&i<=55203||12593<=i&&i<=12686||97<=i&&i<=122||65<=i&&i<=90||48<=i&&i<=57))return!1}return!0},Array.prototype.last||Object.defineProperty(Array.prototype,"last",{value:function(){return this[this.length-1]}}),Array.prototype.parseInt||Object.defineProperty(Array.prototype,"parseInt",{value:function(){return this.map(function(e){return parseInt(e,10)})}}),ArrayParseInt=function(){return this.map(function(e){return parseInt(e,10)})},String.prototype.reverse||(String.prototype.reverse=function(){return this.split("").reverse().join("")}),s.BinToHex=function(e){for(var t=Math.ceil(e.length/4),i="",n=0;n<t;n++){j=4*n;var s=e.slice(j,j+4).join("");i+=parseInt(s,2).toString(16).toUpperCase()}return i},s.HexToBin=function(e){for(var t,i=Math.ceil(e.length),n="",s=0;s<i;s++)t=e.substr(s,1),n+=parseInt(t,16).toString(2).padStart(4,"0");return new Uint8Array(n.split(""))},s.ceilGrid=function(e){return~~(e+.5)},Number.prototype.ceilGrid||(Number.prototype.ceilGrid=function(){return~~(this+.5)}),s.minProp=function(e,i){return e.reduce(function(e,t){return e[i]<t[i]?e:t})},s.maxProp=function(e,i){return e.reduce(function(e,t){return e[i]>t[i]?e:t})},s.Sleep=function(t){return new Promise(e=>setTimeout(e,t))};s.GetGroupCountArray=function(e,t){i=t;var i,n,s=e.reduce(function(e,t){return(e[t[i]]=e[t[i]]||[]).push(t),e},{}),a=[];for(n in s)a.push([n,s[n].length]);return console.info(JSON.stringify(a)),a.sort(function(e,t){return e[1]-t[1]}),a},s.roundTo=function(e,t){return Math.round(e/t)*t},s.floorTo=function(e,t){return Math.floor(e/t)*t},s.ceilTo=function(e,t){return Math.ceil(e/t)*t},s.btoa=function(e){return Buffer.from(e,"base64").toString("utf8")},s.getGridPosition=function(e,t){return{gx:e>>4,gy:t>>4}},t.exports=s},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,sanitizer:void 0}],147:[function(e,t,i){var n=e("./lib/class"),s=e("underscore"),c=(e("log"),e("./entity"),e("./entityspawn"),e("./character"),e("./mob")),a=(e("./node"),e("./map"),e("./mapmanager")),r=(e("./mapentities"),e("./npcstatic")),u=(e("./npcmove"),e("./npcdata"),e("./player")),o=e("./item"),p=e("./items"),m=(e("./appearancedata"),e("./mobarea"),e("./chestarea"),e("./chest")),d=e("./message"),f=(e("./mobdata"),e("./utils")),y=e("../shared/js/gametypes"),g=e("../shared/js/itemtypes"),l=(e("./playercontroller"),e("./npcmovecontroller"),e("./skilldata"),e("util"),e("./pathfinder"),e("./notificationdata.js")),h=e("../shared/data/products.json"),v=e("./updater"),b=e("./auction"),E=e("./looks"),T=e("./party"),x=e("./taskhandler");t.exports=World=n.Class.extend({init:function(e,t,i,n){var s=this;for(e in s.id=e,s.maxPlayers=t,s.socket=i,s.database=n,s.mapManager=new a(s),s.taskHandler=new x,s.maps=s.mapManager.maps,s.party=[],s.itemCount=0,s.uselessDebugging=!1,s.expMultiplier=0,s.mapManager.onMapsReady(function(){for(mapId in console.info("ALL MAPS LOADED BITCHES!"),s.maps=s.mapManager.maps,s.maps){var e=s.maps[mapId];e.updater=new v(s,e)}}),s.bets=[],s.products=JSON.parse(JSON.stringify(h)),s.auction=new b,s.looks=new E,s.lastUpdateTime=Date.now(),s.onPlayerConnect(function(e){e.map=s.maps[1]}),s.onPlayerEnter(function(i){console.info("Player: "+i.name+" has entered the "+i.map.name+" map."),i.map.entities.pushBroadcast(new d.Notify("MAP","MAP_ENTERED",[i.name,i.map.name]),!0),s.updatePopulation(),i.onDeath(function(){i.forEachAttacker(function(e){e.removeAttacker(i),e instanceof c&&e.forgetPlayer(i.id)})});i.packetHandler.onMove(function(e){}.bind(i)),i.packetHandler.onBroadcast(function(e,t){i.map.entities.pushBroadcast(e,t?i.id:null)}),i.packetHandler.onExit(function(){var e;console.info("Player: "+i.name+" has exited the world."),i.map.entities.removePlayer(i),i.party&&((e=i.party).removePlayer(i),i.packetHandler.handlePartyAbandoned(e)),s.removed_callback&&s.removed_callback()}),s.added_callback&&s.added_callback()}),s.onEntityAttack(function(e){e.target}),s.onRegenTick(function(){for(mapId in s.maps){var e=s.maps[mapId];e&&e.isLoaded&&e.entities&&(e.entities.forEachPlayer(function(e){e instanceof u&&(e.isDead||e.hasFullHealth()||e.isAttacked()||e.modHealthBy(Math.floor(e.stats.hpMax/8)))}),e.entities.forEachMob(function(e){e instanceof c&&(e.isDead||e.hasFullHealth()||e.isAttacked()||e.x!=e.spawnX||e.y!=e.spawnY||e.modHealthBy(Math.floor(e.stats.hpMax/8)))}))}}),s.notify=l.Notifications,s.notify)s.notify[e].lastTime=Date.now()-this._idleStart;setInterval(function(){for(var e in s.notify){e=s.notify[e];Date.now()-e.lastTime>=6e4*e.interval&&(s.pushWorld(new d.Notify("NOTICE",e.textid)),e.lastTime=Date.now())}},6e4)},stop:function(){this.save()},save:function(){for(mapId in this.maps){var t,e=this.maps[mapId];e&&e.isLoaded&&e.entities&&(t=0,e.entities.forEachPlayer(function(e){e.save(),e.isSaved&&t++}),e.entities.players.length==t)&&(PLAYERS_SAVED=!0)}this.auction.save(),this.looks.save()},update:function(){for(mapId in this.lastUpdateTime=Date.now(),this.maps){var e=this.maps[mapId];e&&e.ready&&e.entities&&e.updater&&0<Object.keys(e.entities.players).length&&(e.entities.processPackets(),e.updater.update())}},run:function(){var i=this;setInterval(function(){i.update()},G_UPDATE_INTERVAL),setInterval(function(){for(mapId in i.maps){var e=i.maps[mapId];e&&e.ready&&e.entities&&0<Object.keys(e.entities.players).length&&e.entities.mobAI.update()}},256),setInterval(function(){for(mapId in i.maps){var e=i.maps[mapId];if(e&&e.ready&&e.entities&&0<Object.keys(e.entities.npcplayers).length)for(npcId in e.entities.npcplayers){var t=e.entities.npcplayers[npcId];t instanceof r&&(t.activeController.randomMove(),t.activeController.checkMove(Date.now()))}}},64),setInterval(function(){i.regen_callback&&i.regen_callback()},1e4),setInterval(function(){i.exp_callback&&i.exp_callback()},6e4),setInterval(function(){i.pvp_regen_callback&&i.pvp_regen_callback()},3e5),setInterval(function(){for(mapId in i.maps){var e=i.maps[mapId];if(e&&e.ready&&e.mobArea&&0<Object.keys(e.entities.players).length)for(var t=0;t<e.mobArea.length;++t)e.mobArea[t].Roaming()}},2e3),setInterval(function(){for(mapId in i.maps){var e=i.maps[mapId];if(e&&e.ready)for(id in e.players){var t=e.players[id];t.idleTimer.isOver(),t.packetHandler.exit_callback()}}},18e4),setInterval(function(){i.save()},18e5)},addParty:function(e,t){e=new T(e,t);return this.party.push(e),e},removeParty:function(t){this.party=s.reject(this.party,function(e){return e===t}),delete t},loggedInPlayer:function(e){for(mapId in this.maps){var t=this.maps[mapId];if(t.ready&&t.entities)for(var i in t.entities.players)if(t.entities.players.hasOwnProperty(i)&&t.entities.players[i].name==e&&!t.entities.players[i].isDead)return console.info("loggedInPlayer: true"),!0}return console.info("loggedInPlayer: false"),!1},getPlayerByName:function(e){for(mapId in this.maps){var t=this.maps[mapId];if(t.ready&&t.entities)for(var i in t.entities.players)if(t.entities.players.hasOwnProperty(i)&&t.entities.players[i].name==e)return t.entities.players[i]}return null},handlePlayerVanish:function(t){t.forEachAttacker(function(e){e instanceof c&&(t.removeAttacker(e),e.clearTarget(),e.forgetPlayer(t.id,1e3))})},handleMobHate:function(e,t,i){console.info("handleMobHate"),e&&t&&t instanceof u&&e instanceof c&&(e.increaseHateFor(t,i),0<e.stats.hp)&&(t=e.getMostHated())&&this.createAttackLink(e,t)},handleEquipmentDegrading:function(e){var t,i=Math.min(5,Math.ceil(e.armorDamage/1e3));for(t in e.equipment)4!=t&&0<i&&e.equipment.degradeItem(t,1)&&e.equipment.addExperience(t,i);e.armorDamage=0;var n=Math.min(5,Math.ceil(e.weaponDamage/1e3));0<n&&e.equipment.degradeItem(4,1)&&e.equipment.addExperience(4,n),e.addWeaponExp(e.weaponDamage),e.weaponDamage=0},handleDropItem:function(e,t){var i=this.getLootItem(t,e,0);i&&i instanceof o?(console.info("LOOT ITEM SENT!"),i.x=e.x,i.y=e.y,this.handleItemDespawn(i)):(i=this.getDroppedOrStolenItem(t,e,0))&&i instanceof o&&(i.x=e.x,i.y=e.y,this.handleItemDespawn(i))},handleDamage:function(e,t,i,n){if(e.effects){console.info("entity.effects: "+JSON.stringify(e.effects));var s,a,r=[];for([s,a]of Object.entries(e.effects))1==a&&r.push(parseInt(s))}var o=-i;console.info("effects: "+JSON.stringify(r)),console.info("DAMAGE: "+i),console.info("CRIT: "+n),e.onDamage(t,o,0,n,r)},handleEntityDeath:function(e,t){t instanceof u&&(t.skillHandler.setXPs(),this.taskHandler.processEvent(t,PlayerEvent(EventType.KILLMOB,e,1))),(t instanceof u||e instanceof u)&&(t=t instanceof u?t:e,this.handleEquipmentDegrading(t)),e instanceof u&&(e.forEachAttacker(function(e){e.returnToSpawn()}),this.handlePlayerVanish(e))},handleHurtEntity:function(i,e){var n=this;i&&e&&i.stats.hp<=0&&(this.handleDropItem(i,e),i instanceof c&&i.onKilled(function(e,t){e instanceof u&&n.taskHandler.processEvent(e,PlayerEvent(EventType.DAMAGE,i,t))}),s.each(i.attackers,function(e){e instanceof u&&delete e.knownIds[i.id]}),i.die(e),this.handleEntityDeath(i,e))},handlePickpocket:function(e,t){t=this.getDroppedOrStolenItem(e,t,1);t instanceof ItemRoom&&e.inventory.hasRoom()&&e.inventory.putItem(t)},handleItemDespawn:function(e){e&&e.handleDespawn({beforeBlinkDelay:2e4,blinkCallback:function(){},blinkingDuration:8e3,despawnCallback:function(){e.map.entities.itemDespawn(e)}})},getLootItem:function(e,t,i){var n=null;if(!(!t instanceof c||!t instanceof m)){var s={};if(e instanceof u)for(var a of e.quests)a.type==QuestType.GETITEMKIND&&a.object2.type==y.EntityTypes.ITEMLOOT&&a.object.type==y.EntityTypes.MOB&&a.object.kind==t.kind&&a.status!=QuestStatus.COMPLETE&&(a.count<a.object2.count||!e.inventory.hasItemCount(a.object2.kind+1e3))&&(s[a.object2.kind+1e3]=parseInt(10*a.object2.chance),a.object2.chance+=1);var r,o,l=f.randomRangeInt(0,1e3);for(r in s){var h=s[r];if(0<=l&&l<h){n=r;break}l-=h}return n?(o=new ItemRoom(parseInt(n),1,0,0,0),(o=t.map.entities.createItem(o,t.x,t.y,1)).count=1,o.experience=0,t.map.entities.pushNeighbours(t,o.spawn()),t.map.entities.addItem(o)):null}},getPlayerDrop:function(e,t,i){var n,s,a=t.inventory.getRandomItemNumber();if(-1!=a)return item=t.inventory.rooms[a],n=1,g.isConsumableItem(item.itemKind)&&(n=Math.floor((Math.random()*t.level+2)/2))>item.itemNumber&&(n=item.itemNumber),i?((s=Object.assign(new ItemRoom,item)).itemNumber=n,e.map.entities.pushToPlayer(e,new d.Notify("CHAT","ITEM_ADDED",[p.Kinds[item.itemKind].name]))):s=t.map.entities.addItem(t.map.entities.createItem(type,item,t.x,t.y,n)),t.inventory.takeOutItems(a,n),s},getDrop:function(e,t,i){if(1!=t.droppedItem){t.droppedItem=!0;var n,s,a,r=t.drops,o=f.random(1e3);for(s in r){var l=r[s];if(0<=o&&o<l){n=s;break}o-=l}if(!n)return null;g.isEquippable(n)?(l=f.setEquipmentBonus(n),(a=new ItemRoom(n,l,0,0,900,900,0)).itemExperience=g.itemExpForLevel[l-1]):a=new ItemRoom(n,1,0,0,0,0,0);var h=t.map.entities.createItem(a,t.x,t.y,1);return i?(e instanceof u&&e.map.entities.pushToPlayer(e,new d.Notify("CHAT","ITEM_ADDED",[p.Kinds[h.itemKind].name])),a):(t.data&&t.data.dropBonus&&(h.count+=t.data.dropBonus),t.map.entities.pushNeighbours(t,h.spawn()),h.enemyDrop=!0,t.map.entities.addItem(h))}},getGoldDrop:function(e,t,i){t=t.dropGold();e instanceof u&&e.modifyGold(t)},getDroppedOrStolenItem:function(e,t,i){return e instanceof u&&t instanceof u?(this.getGoldDrop(e,t,i),this.getPlayerDrop(e,t,i)):t instanceof c||t instanceof m?(this.getGoldDrop(e,t,i),this.getDrop(e,t,i)):null},moveEntity:function(e,t,i){e&&e.setPosition(t,i)},onInit:function(e){this.init_callback=e},onPlayerConnect:function(e){this.connect_callback=e},onPlayerEnter:function(e){this.enter_callback=e},onPlayerAdded:function(e){this.added_callback=e},onPlayerRemoved:function(e){this.removed_callback=e},onRegenTick:function(e){this.regen_callback=e},onPvpRegenTick:function(e){this.pvp_regen_callback=e},onExpTick:function(e){this.exp_callback=e},onEntityAttack:function(e){this.attack_callback=e},onMobMoveCallback:function(e){},pushWorld:function(e){for(var t in this.maps){var i=this.maps[t];if(i.entities&&0<Object.keys(i.entities.packets).length)for(var n in i.entities.packets)i.entities.packets[n].push(e.serialize())}},getPopulation:function(){var e,t=0;for(e in this.maps){var i=this.maps[e];i.entities&&(t+=Object.keys(i.entities.players).length)}return t},updatePopulation:function(){var t=this;setTimeout(function(){for(var e in t.maps){e=t.maps[e];e.entities&&Object.keys(e.entities.players).length}},2e3)},createAttackLink:function(e,t){e.hasTarget()&&e.removeTarget(),e.setTarget(t),t.addAttacker(e),e.addAttacker(t)},getEntityByName:function(e){for(var t of players)if(t.name.toLowerCase()===e.toLowerCase())return t;return null}})},{"../shared/data/products.json":163,"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./appearancedata":79,"./auction":81,"./character":85,"./chest":87,"./chestarea":88,"./entity":91,"./entityspawn":93,"./item":98,"./items":101,"./lib/class":104,"./looks":105,"./map":107,"./mapentities":109,"./mapmanager":110,"./message":111,"./mob":113,"./mobarea":115,"./mobdata":117,"./node":119,"./notificationdata.js":120,"./npcdata":121,"./npcmove":122,"./npcmovecontroller":123,"./npcstatic":124,"./party":126,"./pathfinder":127,"./player":128,"./playercontroller":129,"./skilldata":135,"./taskhandler":137,"./updater":144,"./utils":146,log:60,underscore:75,util:void 0}],148:[function(e,t,i){var n=e("underscore"),s=(e("bison"),e("./lib/class")),a=e("http"),r=e("https");const o=e("socket.io")["Server"];e("url"),e("./utils");var l={},h=e("zlib"),c=(e("connect"),e("fs")),e=(t.exports=l,s.Class.extend({init:function(){},onConnect:function(e){this.connectionCallback=e},onError:function(e){this.errorCallback=e},broadcast:function(e){throw"Not implemented"},forEachConnection:function(e){n.each(this._connections,e)},addConnection:function(e){this._connections[e.id]=e},removeConnection:function(e){delete this._connections[e]},getConnection:function(e){return this._connections[e]}})),t=s.Class.extend({init:function(e,t,i){this._connection=t,this._server=i,this.id=e},onClose:function(e){this.closeCallback=e},listen:function(e){this.listenCallback=e},broadcast:function(e){throw"Not implemented"},send:function(e){throw"Not implemented"},sendUTF8:function(e){throw"Not implemented"},close:function(e){console.info("Closing connection to "+this._connection.remoteAddress+". "+e),this._connection.conn.close()}});l.WebsocketServer=e.extend({_connections:{},_counter:0,init:function(e){var t=this,i=(this._super(),{}),n=(""!=e.https_cert&&(i.cert=c.readFileSync(e.https_cert)),""!=e.https_key&&(i.key=c.readFileSync(e.https_key)),a);"https"==e.protocol&&(n=r);this._protoServer=n.createServer(i),this._protoServer.listen(e.port,e.ip,function(){console.info("Server (only) is listening on port "+e.port)}),this._ioServer=new o(this._protoServer,{cors:{origin:"*"}}),this._ioServer.on("connection",function(e){console.info("Client socket connected from "+e.conn.remoteAddress),e.remoteAddress=e.conn.remoteAddress,e=new l.socketioConnection(t._createId(),e,t),t.connectionCallback&&t.connectionCallback(e),t.addConnection(e)}),this._ioServer.on("connect_error",function(e){console.error(e)})},_createId:function(){return 5e4+this._counter++},broadcast:function(t){this.forEachConnection(function(e){e.send(t)})},onRequestStatus:function(e){this.statusCallback=e}}),l.socketioConnection=t.extend({init:function(e,t,i){var n=this;this._super(e,t,i),this._connection.on("message",function(e){var t=e.charAt(0);"2"==t?(t=Buffer.from(t,"base64"),h.gunzip(t,(e,t)=>{e?console.log(e.toString()):n.listenCallback&&n.listenCallback(JSON.parse(t))})):n.listenCallback&&n.listenCallback(JSON.parse(e.substr(1)))}),this._connection.on("disconnect",function(){console.info("Client closed socket "+n._connection.conn.remoteAddress),n.closeCallback&&n.closeCallback(),n._server.removeConnection(n.id)})},send:function(e){console.info("send="+e);var i=this,e=JSON.stringify(e);2048<=e.length?h.gzip(e,{level:1},(e,t)=>{t=new Buffer(t).toString("base64"),i.sendUTF8("2"+t)}):i.sendUTF8("1"+e)},sendUTF8:function(e){this._connection.send(e)}})},{"./lib/class":104,"./utils":146,bison:void 0,connect:void 0,fs:void 0,http:void 0,https:void 0,"socket.io":void 0,underscore:75,url:void 0,zlib:void 0}],149:[function(e,t,i){t.exports=[[{type:1,objectType:2,objectKind:0,count:10},{type:1,objectType:2,objectKind:0,count:25},{type:1,objectType:2,objectKind:0,count:50},{type:1,objectType:2,objectKind:0,count:100},{type:1,objectType:2,objectKind:0,count:200},{type:1,objectType:2,objectKind:0,count:500},{type:1,objectType:2,objectKind:0,count:1e3}],[{type:2,objectType:0,objectKind:0,count:10},{type:2,objectType:0,objectKind:0,count:25},{type:2,objectType:0,objectKind:0,count:50},{type:2,objectType:0,objectKind:0,count:100},{type:2,objectType:0,objectKind:0,count:200},{type:2,objectType:0,objectKind:0,count:500},{type:2,objectType:0,objectKind:0,count:1e3}],[{type:4,objectType:0,objectKind:0,count:1e3},{type:4,objectType:0,objectKind:0,count:2500},{type:4,objectType:0,objectKind:0,count:5e3},{type:4,objectType:0,objectKind:0,count:1e4},{type:4,objectType:0,objectKind:0,count:25e3},{type:4,objectType:0,objectKind:0,count:5e4},{type:4,objectType:0,objectKind:0,count:1e5}],[{type:5,objectType:0,objectKind:0,count:10},{type:5,objectType:0,objectKind:0,count:25},{type:5,objectType:0,objectKind:0,count:50},{type:5,objectType:0,objectKind:0,count:100},{type:5,objectType:0,objectKind:0,count:200},{type:5,objectType:0,objectKind:0,count:500},{type:5,objectType:0,objectKind:0,count:1e3}],[{type:6,objectType:0,objectKind:0,count:10},{type:6,objectType:0,objectKind:0,count:25},{type:6,objectType:0,objectKind:0,count:50},{type:6,objectType:0,objectKind:0,count:100},{type:6,objectType:0,objectKind:0,count:200},{type:6,objectType:0,objectKind:0,count:500},{type:6,objectType:0,objectKind:0,count:1e3}],[{type:5,objectType:0,objectKind:0,count:20},{type:5,objectType:0,objectKind:0,count:50},{type:5,objectType:0,objectKind:0,count:100},{type:5,objectType:0,objectKind:0,count:200},{type:5,objectType:0,objectKind:0,count:500},{type:5,objectType:0,objectKind:0,count:1e3},{type:5,objectType:0,objectKind:0,count:2e3}]]},{}],150:[function(e,t,i){t.exports=[{name:"Sword 1",type:"weapon",sprite:"sword1",buy:0},{name:"Sword 2",type:"weapon",sprite:"sword2",buy:500},{name:"Axe",type:"weapon",sprite:"axe",buy:1e3},{name:"Morning Star",type:"weapon",sprite:"morningstar",buy:1500},{name:"Blue Sword",type:"weapon",sprite:"bluesword",buy:2e3},{name:"Red Sword",type:"weapon",sprite:"redsword",buy:2500},{name:"Golden Sword",type:"weapon",sprite:"goldensword",buy:3e3},{name:"Side Sword",type:"weapon",sprite:"sidesword",buy:3500},{name:"Spear",type:"weapon",sprite:"spear",buy:4e3},{name:"Scimitar",type:"weapon",sprite:"scimitar",buy:4500},{name:"Trident",type:"weapon",sprite:"trident",buy:5e3},{name:"Blue Scimitar",type:"weapon",sprite:"bluescimitar",buy:5500},{name:"Hammer",type:"weapon",sprite:"hammer",buy:6e3},{name:"Green Light Saber",type:"weapon",sprite:"greenlightsaber",buy:6500},{name:"Sky Light Saber",type:"weapon",sprite:"skylightsaber",buy:7e3},{name:"Red Light Saber",type:"weapon",sprite:"redlightsaber",buy:7500},{name:"Bastard Sword",type:"weapon",sprite:"bastardsword",buy:8e3},{name:"Red Metal Sword",type:"weapon",sprite:"redmetalsword",buy:8500},{name:"Justice Hammer",type:"weapon",sprite:"justicehammer",buy:9e3},{name:"Rose",type:"weapon",sprite:"rose",buy:9500},{name:"Ice Rose",type:"weapon",sprite:"icerose",buy:1e4},{name:"Halberd",type:"weapon",sprite:"halberd",buy:10500},{name:"Whip",type:"weapon",sprite:"whip",buy:11e3},{name:"Forest Guardian Sword",type:"weapon",sprite:"forestguardiansword",buy:11500},{name:"Sickle",type:"weapon",sprite:"sickle",buy:12e3},{name:"Plunger",type:"weapon",sprite:"plunger",buy:12500},{name:"Red Sickle",type:"weapon",sprite:"redsickle",buy:13e3},{name:"Day Walker",type:"weapon",sprite:"daywalker",buy:13500},{name:"Purple Cloud Kallege",type:"weapon",sprite:"purplecloudkallege",buy:14e3},{name:"Sea Rage",type:"weapon",sprite:"searage",buy:14500},{name:"Breaker",type:"weapon",sprite:"breaker",buy:15e3},{name:"Enel Trident",type:"weapon",sprite:"eneltrident",buy:15500},{name:"Rainbow Sword",type:"weapon",sprite:"rainbowsword",buy:16e3},{name:"Typhoon",type:"weapon",sprite:"typhoon",buy:16500},{name:"Memme",type:"weapon",sprite:"memme",buy:17e3},{name:"Candybar",type:"weapon",sprite:"candybar",buy:17500},{name:"Butcher Knife",type:"weapon",sprite:"butcherknife",buy:18e3},{name:"Fire Shot",type:"weapon",sprite:"fireshot",buy:18500},{name:"Comb",type:"weapon",sprite:"comb",buy:19e3},{name:"Squeaky Hammer",type:"weapon",sprite:"squeakyhammer",buy:19500},{name:"Fire Play",type:"weapon",sprite:"fireplay",buy:2e4},{name:"Wea Staff",type:"weapon",sprite:"weastaff",buy:20500},{name:"Pink Sword",type:"weapon",sprite:"pinksword",buy:21e3},{name:"Conference Call",type:"weapon",sprite:"conferencecall",buy:21500},{name:"Cactus Axe",type:"weapon",sprite:"cactusaxe",buy:22e3},{name:"Devil Kazya Sword",type:"weapon",sprite:"devilkazyasword",buy:22500},{name:"Bamboo Spear",type:"weapon",sprite:"bamboospear",buy:23e3},{name:"Paewoldo",type:"weapon",sprite:"paewoldo",buy:23500},{name:"Magic Spear",type:"weapon",sprite:"magicspear",buy:24e3},{name:"Fire Sword",type:"weapon",sprite:"firesword",buy:24500},{name:"Wooden Bow",type:"weaponarcher",sprite:"woodenbow",buy:0},{name:"Plastic Bow",type:"weaponarcher",sprite:"plasticbow",buy:500},{name:"Iron Bow",type:"weaponarcher",sprite:"ironbow",buy:1e3},{name:"Red Bow",type:"weaponarcher",sprite:"redbow",buy:1500},{name:"Violet Bow",type:"weaponarcher",sprite:"violetbow",buy:2e3},{name:"Death Bow",type:"weaponarcher",sprite:"deathbow",buy:2500},{name:"Golden Bow",type:"weaponarcher",sprite:"goldenbow",buy:3e3},{name:"Watermelon Bow",type:"weaponarcher",sprite:"watermelonbow",buy:3500},{name:"Green Bow",type:"weaponarcher",sprite:"greenbow",buy:4e3},{name:"Redenel Bow",type:"weaponarcher",sprite:"redenelbow",buy:4500},{name:"Mermaid Bow",type:"weaponarcher",sprite:"mermaidbow",buy:5e3},{name:"Seahorse Bow",type:"weaponarcher",sprite:"seahorsebow",buy:5500},{name:"Hunter Bow",type:"weaponarcher",sprite:"hunterbow",buy:6e3},{name:"Green Light Bow",type:"weaponarcher",sprite:"greenlightbow",buy:6500},{name:"Sky Light Bow",type:"weaponarcher",sprite:"skylightbow",buy:7e3},{name:"Red Light Bow",type:"weaponarcher",sprite:"redlightbow",buy:7500},{name:"Captain Bow",type:"weaponarcher",sprite:"captainbow",buy:8e3},{name:"Red Metal Bow",type:"weaponarcher",sprite:"redmetalbow",buy:8500},{name:"Justice Bow",type:"weaponarcher",sprite:"justicebow",buy:9e3},{name:"Rose Bow",type:"weaponarcher",sprite:"rosebow",buy:9500},{name:"Marine Bow",type:"weaponarcher",sprite:"marinebow",buy:1e4},{name:"Crystal Bow",type:"weaponarcher",sprite:"crystalbow",buy:10500},{name:"Colorful Bow",type:"weaponarcher",sprite:"gaybow",buy:11e3},{name:"Forest Bow",type:"weaponarcher",sprite:"forestbow",buy:11500},{name:"Sickle Bow",type:"weaponarcher",sprite:"sicklebow",buy:12e3},{name:"Blood Bow",type:"weaponarcher",sprite:"bloodbow",buy:12500},{name:"Red Sickle Bow",type:"weaponarcher",sprite:"redsicklebow",buy:13e3},{name:"Cloth Armor",type:"armor",sprite:"clotharmor",buy:0},{name:"Leather Armor",type:"armor",sprite:"leatherarmor",buy:500},{name:"Mail Armor",type:"armor",sprite:"mailarmor",buy:1e3},{name:"Plate Armor",type:"armor",sprite:"platearmor",buy:1500},{name:"Red Armor",type:"armor",sprite:"redarmor",buy:2e3},{name:"Golden Armor",type:"armor",sprite:"goldenarmor",buy:2500},{name:"Green Armor",type:"armor",sprite:"greenarmor",buy:3e3},{name:"Green Wing Armor",type:"armor",sprite:"greenwingarmor",buy:3500},{name:"Guard Armor",type:"armor",sprite:"guardarmor",buy:4e3},{name:"Red Guard Armor",type:"armor",sprite:"redguardarmor",buy:4500},{name:"White Armor",type:"armor",sprite:"whitearmor",buy:5e3},{name:"Rat Armor",type:"armor",sprite:"ratarmor",buy:5500},{name:"Blue Pirate Armor",type:"armor",sprite:"bluepiratearmor",buy:6e3},{name:"Cheoli Armor",type:"armor",sprite:"cheoliarmor",buy:6500},{name:"Dovakin Armor",type:"armor",sprite:"dovakinarmor",buy:7e3},{name:"GB Wing Armor",type:"armor",sprite:"gbwingarmor",buy:7500},{name:"Red Wing Armor",type:"armor",sprite:"redwingarmor",buy:8e3},{name:"Snow Fox Armor",type:"armor",sprite:"snowfoxarmor",buy:8500},{name:"Wolf Armor",type:"armor",sprite:"wolfarmor",buy:9e3},{name:"Blue Wing Armor",type:"armor",sprite:"bluewingarmor",buy:9500},{name:"Thief Armor",type:"armor",sprite:"thiefarmor",buy:1e4},{name:"Ninja Armor",type:"armor",sprite:"ninjaarmor",buy:10500},{name:"Dragon Armor",type:"armor",sprite:"dragonarmor",buy:11e3},{name:"Fallen Armor",type:"armor",sprite:"fallenarmor",buy:11500},{name:"Paladin Armor",type:"armor",sprite:"paladinarmor",buy:12e3},{name:"Crystal Armor",type:"armor",sprite:"crystalarmor",buy:12500},{name:"Adherer Robe",type:"armor",sprite:"adhererrobe",buy:13e3},{name:"Frost Armor",type:"armor",sprite:"frostarmor",buy:13500},{name:"Strap Armor",type:"armor",sprite:"gayarmor",buy:14e3},{name:"School Uniform",type:"armor",sprite:"schooluniform",buy:14500},{name:"Beautiful Life",type:"armor",sprite:"beautifullife",buy:15e3},{name:"Region Armor",type:"armor",sprite:"regionarmor",buy:15500},{name:"Ghost Rider",type:"armor",sprite:"ghostrider",buy:16e3},{name:"Taekwondo",type:"armor",sprite:"taekwondo",buy:16500},{name:"Rabbit Armor",type:"armor",sprite:"rabbitarmor",buy:17e3},{name:"Portal Armor",type:"armor",sprite:"portalarmor",buy:17500},{name:"Pirate King",type:"armor",sprite:"pirateking",buy:18e3},{name:"Sea Dragon Armor",type:"armor",sprite:"seadragonarmor",buy:18500},{name:"Shadow Region Armor",type:"armor",sprite:"shadowregionarmor",buy:19e3},{name:"Enel Armor",type:"armor",sprite:"enelarmor",buy:19500},{name:"Mini Sea Dragon Armor",type:"armor",sprite:"miniseadragonarmor",buy:2e4},{name:"Huni Armor",type:"armor",sprite:"huniarmor",buy:20500},{name:"Dambo Armor",type:"armor",sprite:"damboarmor",buy:21e3},{name:"Squid Armor",type:"armor",sprite:"squidarmor",buy:21500},{name:"Bee Armor",type:"armor",sprite:"beearmor",buy:22e3},{name:"Blue Dambo Armor",type:"armor",sprite:"bluedamboarmor",buy:22500},{name:"Rudolf Armor",type:"armor",sprite:"rudolfarmor",buy:23e3},{name:"Christmas Armor",type:"armor",sprite:"christmasarmor",buy:23500},{name:"Robocop Armor",type:"armor",sprite:"robocoparmor",buy:24e3},{name:"Pink Cockroach Armor",type:"armor",sprite:"pinkcockroacharmor",buy:24500},{name:"Cockroach Suit",type:"armor",sprite:"cockroachsuit",buy:25e3},{name:"Dinosaur Armor",type:"armor",sprite:"dinosaurarmor",buy:25500},{name:"Cat Armor",type:"armor",sprite:"catarmor",buy:26e3},{name:"Snowman Armor",type:"armor",sprite:"snowmanarmor",buy:26500},{name:"Beetle Armor",type:"armor",sprite:"beetlearmor",buy:27e3},{name:"Hongcheol Armor",type:"armor",sprite:"hongcheolarmor",buy:27500},{name:"Tiger Armor",type:"armor",sprite:"tigerarmor",buy:28e3},{name:"Wizard Rob",type:"armor",sprite:"wizardrobe",buy:28500},{name:"Iron Knight Armor",type:"armor",sprite:"ironknightarmor",buy:29e3},{name:"Evil Armor",type:"armor",sprite:"evilarmor",buy:29500},{name:"Green Dambo Armor",type:"armor",sprite:"greendamboarmor",buy:3e4},{name:"Red Dambo Armor",type:"armor",sprite:"reddamboarmor",buy:30500},{name:"Devil Kazya Armor",type:"armor",sprite:"devilkazyaarmor",buy:31e3},{name:"Bridal Mask",type:"armor",sprite:"bridalmask",buy:31500},{name:"Black Spider Armor",type:"armor",sprite:"blackspiderarmor",buy:32e3},{name:"Frog Armor",type:"armor",sprite:"frogarmor",buy:32500},{name:"Bearseonbi Armor",type:"armor",sprite:"bearseonbiarmor",buy:33e3},{name:"Raindow A Pro",type:"armor",sprite:"rainbowapro",buy:33500},{name:"Coke Armor",type:"armor",sprite:"cokearmor",buy:34e3},{name:"Fried Potato Armor",type:"armor",sprite:"friedpotatoarmor",buy:34500},{name:"Burger Armor",type:"armor",sprite:"burgerarmor",buy:35e3},{name:"Halloween JK Armor",type:"armor",sprite:"halloweenjkarmor",buy:35500},{name:"Frankenstein Armor",type:"armor",sprite:"frankensteinarmor",buy:36e3},{name:"Admin armor",type:"armor",sprite:"adminarmor",buy:36500},{name:"Cloth Armor",type:"armorarcher",sprite:"clotharmor",buy:0},{name:"Leather Armor",type:"armorarcher",sprite:"leatherarcherarmor",buy:500},{name:"Mail Armor",type:"armorarcher",sprite:"mailarcherarmor",buy:1e3},{name:"Plate Armor",type:"armorarcher",sprite:"platearcherarmor",buy:1500},{name:"Red Armor",type:"armorarcher",sprite:"redarcherarmor",buy:2e3},{name:"Golden Armor",type:"armorarcher",sprite:"goldenarcherarmor",buy:2500},{name:"Green Armor",type:"armorarcher",sprite:"greenarcherarmor",buy:3e3},{name:"Green Wing Armor",type:"armorarcher",sprite:"greenwingarcherarmor",buy:3500},{name:"Guard Armor",type:"armorarcher",sprite:"guardarcherarmor",buy:4e3},{name:"Red Guard Armor",type:"armorarcher",sprite:"redguardarcherarmor",buy:4500},{name:"White Armor",type:"armorarcher",sprite:"whitearcherarmor",buy:5e3},{name:"Pirate Armor",type:"armorarcher",sprite:"piratearcherarmor",buy:5500},{name:"Cheoli Armor",type:"armorarcher",sprite:"cheoliarcherarmor",buy:6e3},{name:"Dovakin Armor",type:"armorarcher",sprite:"dovakinarcherarmor",buy:6500},{name:"GB Wing Armor",type:"armorarcher",sprite:"gbwingarcherarmor",buy:7e3},{name:"Red Wing Armor",type:"armorarcher",sprite:"redwingarcherarmor",buy:7500},{name:"Snow Fox Armor",type:"armorarcher",sprite:"snowfoxarcherarmor",buy:8e3},{name:"Wolf Armor",type:"armorarcher",sprite:"wolfarcherarmor",buy:8500},{name:"Blue Wing Armor",type:"armorarcher",sprite:"bluewingarcherarmor",buy:9e3},{name:"Fallen Armor",type:"armorarcher",sprite:"fallenarcherarmor",buy:9500},{name:"Crystal Armor",type:"armorarcher",sprite:"crystalarcherarmor",buy:1e4},{name:"Legolas Armor",type:"armorarcher",sprite:"legolasarmor",buy:10500},{name:"Adherer Armor",type:"armorarcher",sprite:"adhererarcherarmor",buy:11e3},{name:"School Uniform",type:"armorarcher",sprite:"archerschooluniform",buy:11500},{name:"Combat Uniform",type:"armorarcher",sprite:"combatuniform",buy:12e3},{name:"Strap Armor",type:"armorarcher",sprite:"gayarcherarmor",buy:12500}]},{}],151:[function(e,t,i){t.exports=[{i:[[310,16]],o:104},{i:[[310,4]],o:105},{i:[[310,4]],o:106},{i:[[310,4]],o:107},{i:[[311,16]],o:108},{i:[[311,4]],o:109},{i:[[311,4]],o:110},{i:[[311,4]],o:111},{i:[[312,16]],o:112},{i:[[312,4]],o:113},{i:[[312,4]],o:114},{i:[[312,4]],o:115},{i:[[301,1],[302,3]],o:305},{i:[[301,1],[303,3]],o:306},{i:[[301,1],[304,3]],o:307},{i:[[301,6],[305,10]],o:201},{i:[[301,6],[305,10]],o:211},{i:[[301,6],[305,10]],o:221},{i:[[301,6],[305,10]],o:231},{i:[[301,6],[306,10]],o:202},{i:[[301,6],[306,10]],o:212},{i:[[301,6],[306,10]],o:222},{i:[[301,6],[306,10]],o:232},{i:[[301,6],[307,10]],o:203},{i:[[301,6],[307,10]],o:213},{i:[[301,6],[307,10]],o:223},{i:[[301,6],[307,10]],o:233}]},{}],152:[function(e,t,i){t.exports=[]},{}],153:[function(e,t,i){t.exports=[{name:"Scrolls",sprite:"itemloot.png",offset:[0,0],rarity:"1"},{name:"Dice",sprite:"itemloot.png",offset:[0,1],rarity:"1"},{name:"Book",sprite:"itemloot.png",offset:[0,2],rarity:"1"},{name:"Key",sprite:"itemloot.png",offset:[0,3],rarity:"1"},{name:"Bell",sprite:"itemloot.png",offset:[0,4],rarity:"1"},{name:"Padlock",sprite:"itemloot.png",offset:[0,5],rarity:"1"},{name:"Candle",sprite:"itemloot.png",offset:[0,6],rarity:"1"},{name:"Drumstick",sprite:"itemloot.png",offset:[0,7],rarity:"1"},{name:"IronHelmet",sprite:"itemloot.png",offset:[0,8],rarity:"1"},{name:"Gumnut",sprite:"itemloot.png",offset:[0,9],rarity:"1"},{name:"Fireball",sprite:"itemloot.png",offset:[1,0],rarity:"2"},{name:"WitchHat",sprite:"itemloot.png",offset:[1,1],rarity:"2"},{name:"Chest",sprite:"itemloot.png",offset:[1,2],rarity:"2"},{name:"Shield",sprite:"itemloot.png",offset:[1,3],rarity:"2"},{name:"Log",sprite:"itemloot.png",offset:[1,4],rarity:"2"},{name:"RingOne",sprite:"itemloot.png",offset:[1,5],rarity:"2"},{name:"DreamCatcher",sprite:"itemloot.png",offset:[1,6],rarity:"2"},{name:"SealedScroll",sprite:"itemloot.png",offset:[1,7],rarity:"2"},{name:"Spider",sprite:"itemloot.png",offset:[1,8],rarity:"2"},{name:"MeltedCandles",sprite:"itemloot.png",offset:[1,9],rarity:"2"},{name:"Feather",sprite:"itemloot.png",offset:[2,0],rarity:"3"},{name:"Compass",sprite:"itemloot.png",offset:[2,1],rarity:"3"},{name:"PinkFireball",sprite:"itemloot.png",offset:[2,2],rarity:"3"},{name:"Gem",sprite:"itemloot.png",offset:[2,3],rarity:"3"},{name:"FireEye",sprite:"itemloot.png",offset:[2,4],rarity:"3"},{name:"TotemFace",sprite:"itemloot.png",offset:[2,5],rarity:"3"},{name:"Gadget",sprite:"itemloot.png",offset:[2,6],rarity:"3"},{name:"Frog",sprite:"itemloot.png",offset:[2,7],rarity:"3"},{name:"ThrowingDagger",sprite:"itemloot.png",offset:[2,8],rarity:"3"},{name:"UrnOne",sprite:"itemloot.png",offset:[2,9],rarity:"3"},{name:"NecklaceOne",sprite:"itemloot.png",offset:[3,0],rarity:"4"},{name:"Squid",sprite:"itemloot.png",offset:[3,1],rarity:"4"},{name:"ClubOne",sprite:"itemloot.png",offset:[3,2],rarity:"4"},{name:"Crystals",sprite:"itemloot.png",offset:[3,3],rarity:"4"},{name:"Mace",sprite:"itemloot.png",offset:[3,4],rarity:"4"},{name:"CoinPouch",sprite:"itemloot.png",offset:[3,5],rarity:"4"},{name:"NecklaceTwo",sprite:"itemloot.png",offset:[3,6],rarity:"4"},{name:"Bones",sprite:"itemloot.png",offset:[3,7],rarity:"4"},{name:"RingTwo",sprite:"itemloot.png",offset:[3,8],rarity:"4"},{name:"AnimalSkull",sprite:"itemloot.png",offset:[3,9],rarity:"4"},{name:"Leaf",sprite:"itemloot.png",offset:[4,0],rarity:"5"},{name:"Cheese",sprite:"itemloot.png",offset:[4,1],rarity:"5"},{name:"Mushrooms",sprite:"itemloot.png",offset:[4,2],rarity:"5"},{name:"FeatherQuill",sprite:"itemloot.png",offset:[4,3],rarity:"5"},{name:"BoneEaring",sprite:"itemloot.png",offset:[4,4],rarity:"5"},{name:"Crate",sprite:"itemloot.png",offset:[4,5],rarity:"5"},{name:"Bat",sprite:"itemloot.png",offset:[4,6],rarity:"5"},{name:"PoisonVial",sprite:"itemloot.png",offset:[4,7],rarity:"5"},{name:"ScrollsThree",sprite:"itemloot.png",offset:[4,8],rarity:"5"},{name:"Bug",sprite:"itemloot.png",offset:[4,9],rarity:"5"},{name:"Anvil",sprite:"itemloot.png",offset:[5,0],rarity:"6"},{name:"BrokenGlass",sprite:"itemloot.png",offset:[5,1],rarity:"6"},{name:"Goblet",sprite:"itemloot.png",offset:[5,2],rarity:"6"},{name:"SkullRingTwo",sprite:"itemloot.png",offset:[5,3],rarity:"6"},{name:"MonsterClaw",sprite:"itemloot.png",offset:[5,4],rarity:"6"},{name:"PoisonVialTwo",sprite:"itemloot.png",offset:[5,5],rarity:"6"},{name:"BronzeHelmet",sprite:"itemloot.png",offset:[5,6],rarity:"6"},{name:"BasicKnife",sprite:"itemloot.png",offset:[5,7],rarity:"6"},{name:"Worms",sprite:"itemloot.png",offset:[5,8],rarity:"6"},{name:"AutumnLeaf",sprite:"itemloot.png",offset:[5,9],rarity:"6"},{name:"Drum",sprite:"itemloot.png",offset:[6,0],rarity:"7"},{name:"Acorns",sprite:"itemloot.png",offset:[6,1],rarity:"7"},{name:"Pendant",sprite:"itemloot.png",offset:[6,2],rarity:"7"},{name:"Lute",sprite:"itemloot.png",offset:[6,3],rarity:"7"},{name:"RingThree",sprite:"itemloot.png",offset:[6,4],rarity:"7"},{name:"BattleAxe",sprite:"itemloot.png",offset:[6,5],rarity:"7"},{name:"AncientShield",sprite:"itemloot.png",offset:[6,6],rarity:"7"},{name:"Broach",sprite:"itemloot.png",offset:[6,7],rarity:"7"},{name:"Maul",sprite:"itemloot.png",offset:[6,8],rarity:"7"},{name:"SmokePipe",sprite:"itemloot.png",offset:[6,9],rarity:"7"},{name:"Lizard",sprite:"itemloot.png",offset:[7,0],rarity:"8"},{name:"DragonEgg",sprite:"itemloot.png",offset:[7,1],rarity:"8"},{name:"MarbleJar",sprite:"itemloot.png",offset:[7,2],rarity:"8"},{name:"OldBottle",sprite:"itemloot.png",offset:[7,3],rarity:"8"},{name:"ShortSword",sprite:"itemloot.png",offset:[7,4],rarity:"8"},{name:"BookTwo",sprite:"itemloot.png",offset:[7,5],rarity:"8"},{name:"Bread",sprite:"itemloot.png",offset:[7,6],rarity:"8"},{name:"Mirror",sprite:"itemloot.png",offset:[7,7],rarity:"8"},{name:"Cards",sprite:"itemloot.png",offset:[7,8],rarity:"8"},{name:"PotOfGold",sprite:"itemloot.png",offset:[7,9],rarity:"8"},{name:"FaceMask",sprite:"itemloot.png",offset:[8,0],rarity:"9"},{name:"Bomb",sprite:"itemloot.png",offset:[8,1],rarity:"9"},{name:"HandBag",sprite:"itemloot.png",offset:[8,2],rarity:"9"},{name:"ToothNecklace",sprite:"itemloot.png",offset:[8,3],rarity:"9"},{name:"NecklaceThree",sprite:"itemloot.png",offset:[8,4],rarity:"9"},{name:"LeafWreath",sprite:"itemloot.png",offset:[8,5],rarity:"9"},{name:"Eyeball",sprite:"itemloot.png",offset:[8,6],rarity:"9"},{name:"CrudeDagger",sprite:"itemloot.png",offset:[8,7],rarity:"9"},{name:"SapJewel",sprite:"itemloot.png",offset:[8,8],rarity:"9"},{name:"Clever",sprite:"itemloot.png",offset:[8,9],rarity:"9"},{name:"MortAndPestle",sprite:"itemloot.png",offset:[9,0],rarity:"10"},{name:"WoodHorn",sprite:"itemloot.png",offset:[9,1],rarity:"10"},{name:"Pumpkin",sprite:"itemloot.png",offset:[9,2],rarity:"10"},{name:"HumanSkull",sprite:"itemloot.png",offset:[9,3],rarity:"10"},{name:"Thorns",sprite:"itemloot.png",offset:[9,4],rarity:"10"},{name:"FineComb",sprite:"itemloot.png",offset:[9,5],rarity:"10"},{name:"Cauldron",sprite:"itemloot.png",offset:[9,6],rarity:"10"},{name:"MagicBall",sprite:"itemloot.png",offset:[9,7],rarity:"10"},{name:"Mushroom",sprite:"itemloot.png",offset:[9,8],rarity:"10"},{name:"Hook",sprite:"itemloot.png",offset:[9,9],rarity:"10"},{name:"NordicCup",sprite:"itemloot.png",offset:[10,0],rarity:"10"}]},{}],154:[function(e,t,i){t.exports=[{id:1,name:"Crude Club",type:"weapon",typemod:"attack",modifier:10,staticsheet:2,legacy:1,offset:[3,10]},{id:2,name:"Crude Sword",type:"weapon",typemod:"attack",modifier:20,staticsheet:2,legacy:1,offset:[5,9]},{id:3,name:"Beginnner Sword",type:"weapon",typemod:"attack",modifier:30,staticsheet:2,legacy:1,offset:[8,11]},{id:4,name:"Iron Sword",type:"weapon",typemod:"attack",modifier:40,staticsheet:2,legacy:1,offset:[4,0]},{id:5,name:"Steel Sword",type:"weapon",typemod:"attack",modifier:50,staticsheet:2,legacy:1,offset:[4,1]},{id:6,name:"Bronze Sword",type:"weapon",typemod:"attack",modifier:60,staticsheet:2,legacy:1,offset:[4,2]},{id:7,name:"Golden Sword",type:"weapon",typemod:"attack",modifier:70,staticsheet:2,legacy:1,offset:[4,3]},{id:8,name:"Glass Sword",type:"weapon",typemod:"attack",modifier:80,staticsheet:2,legacy:1,offset:[4,4]},{id:9,name:"Adamantite Sword",type:"weapon",typemod:"attack",modifier:90,staticsheet:2,legacy:1,offset:[4,5]},{id:10,name:"Plate Sword",type:"weapon",typemod:"attack",modifier:100,staticsheet:2,legacy:1,offset:[4,6]},{id:11,name:"Draconian Sword",type:"weapon",typemod:"attack",modifier:110,staticsheet:2,legacy:1,offset:[4,7]},{id:12,name:"Slingshot",type:"weaponarcher",typemod:"attack",modifier:10,staticsheet:2,legacy:1,offset:[1,10]},{id:13,name:"Crude Bow",type:"weaponarcher",typemod:"attack",modifier:20,staticsheet:2,legacy:1,offset:[7,8]},{id:14,name:"Beginner Bow",type:"weaponarcher",typemod:"attack",modifier:30,staticsheet:2,legacy:1,offset:[9,11]},{id:15,name:"Iron Bow",type:"weaponarcher",typemod:"attack",modifier:40,staticsheet:2,legacy:1,offset:[7,0]},{id:16,name:"Steel Bow",type:"weaponarcher",typemod:"attack",modifier:50,staticsheet:2,legacy:1,offset:[7,1]},{id:17,name:"Bronze Bow",type:"weaponarcher",typemod:"attack",modifier:60,staticsheet:2,legacy:1,offset:[7,2]},{id:18,name:"Gold Bow",type:"weaponarcher",typemod:"attack",modifier:70,staticsheet:2,legacy:1,offset:[7,3]},{id:19,name:"Glass Bow",type:"weaponarcher",typemod:"attack",modifier:80,staticsheet:2,legacy:1,offset:[7,4]},{id:20,name:"Adamantite Bow",type:"weaponarcher",typemod:"attack",modifier:90,staticsheet:2,legacy:1,offset:[7,5]},{id:21,name:"Plate Bow",type:"weaponarcher",typemod:"attack",modifier:100,staticsheet:2,legacy:1,offset:[7,6]},{id:22,name:"Draconian Bow",type:"weaponarcher",typemod:"attack",modifier:110,staticsheet:2,legacy:1,offset:[7,7]},{id:23,name:"Fur Armor",type:"armor",typemod:"defense",modifier:10,staticsheet:2,legacy:1,offset:[11,12]},{id:24,name:"Padded Armor",type:"armor",typemod:"defense",modifier:20,staticsheet:2,legacy:1,offset:[11,11]},{id:25,name:"Leather Armor",type:"armor",typemod:"defense",modifier:30,staticsheet:2,legacy:1,offset:[11,10]},{id:26,name:"Iron Armor",type:"armor",typemod:"defense",modifier:40,staticsheet:2,legacy:1,offset:[11,0]},{id:27,name:"Steel Armor",type:"armor",typemod:"defense",modifier:50,staticsheet:2,legacy:1,offset:[11,1]},{id:28,name:"Bronze Armor",type:"armor",typemod:"defense",modifier:60,staticsheet:2,legacy:1,offset:[11,2]},{id:29,name:"Golden Armor",type:"armor",typemod:"defense",modifier:70,staticsheet:2,legacy:1,offset:[11,3]},{id:30,name:"Glass Armor",type:"armor",typemod:"defense",modifier:80,staticsheet:2,legacy:1,offset:[11,4]},{id:31,name:"Adamantite Armor",type:"armor",typemod:"defense",modifier:90,staticsheet:2,legacy:1,offset:[11,5]},{id:32,name:"Plate Armor",type:"armor",typemod:"defense",modifier:100,staticsheet:2,legacy:1,offset:[11,6]},{id:33,name:"Draconian Armor",type:"armor",typemod:"defense",modifier:110,staticsheet:2,legacy:1,offset:[11,7]},{id:34,name:"Flask +250 HP",type:"object",typemod:"health",modifier:250,sprite:"item/item-flask.png",spriteName:"item-flask",offset:[0,0],buy:10,buycount:10},{id:35,name:"Burger +250 Energy",type:"object",typemod:"energy",modifier:250,sprite:"item/item-burger.png",spriteName:"item-burger",offset:[0,0],buy:30,buycount:10},{id:36,name:"Big Flask +25% HP",type:"object",typemod:"healthpercent",modifier:25,sprite:"item/item-bigflask.png",spriteName:"item-bigflask",offset:[0,0],buy:50,buycount:10},{id:100,name:"Leather Chest 1",type:"chest",typemod:"defense",level:10,modifier:10,staticsheet:1,spriteName:"armors",offset:[0,5]},{id:101,name:"Leather Helmet 1",type:"helm",typemod:"defense",level:12,modifier:5,staticsheet:1,spriteName:"armors",offset:[0,4]},{id:102,name:"Leather Gloves 1",type:"gloves",typemod:"defense",level:14,modifier:5,staticsheet:1,spriteName:"armors",offset:[0,6]},{id:103,name:"Leather Boots 1",type:"boots",typemod:"defense",level:16,modifier:5,staticsheet:1,spriteName:"armors",offset:[0,7]},{id:104,name:"Leather Chest 2",type:"chest",typemod:"defense",level:20,modifier:20,staticsheet:1,spriteName:"armors",offset:[1,5]},{id:105,name:"Leather Helmet 2",type:"helm",typemod:"defense",level:22,modifier:10,staticsheet:1,spriteName:"armors",offset:[1,4]},{id:106,name:"Leather Gloves 2",type:"gloves",typemod:"defense",level:24,modifier:10,staticsheet:1,spriteName:"armors",offset:[1,6]},{id:107,name:"Leather Boots 2",type:"boots",typemod:"defense",level:26,modifier:10,staticsheet:1,spriteName:"armors",offset:[1,7]},{id:108,name:"Leather Chest 3",type:"chest",typemod:"defense",level:30,modifier:30,staticsheet:1,spriteName:"armors",offset:[2,5]},{id:109,name:"Leather Helmet 3",type:"helm",typemod:"defense",level:32,modifier:15,staticsheet:1,spriteName:"armors",offset:[2,4]},{id:110,name:"Leather Gloves 3",type:"gloves",typemod:"defense",level:34,modifier:15,staticsheet:1,spriteName:"armors",offset:[2,6]},{id:111,name:"Leather Boots 3",type:"boots",typemod:"defense",level:36,modifier:15,staticsheet:1,spriteName:"armors",offset:[2,7]},{id:112,name:"Leather Chest 4",type:"chest",typemod:"defense",level:40,modifier:40,staticsheet:1,spriteName:"armors",offset:[3,5]},{id:113,name:"Leather Helmet 4",type:"helm",typemod:"defense",level:42,modifier:20,staticsheet:1,spriteName:"armors",offset:[3,4]},{id:114,name:"Leather Gloves 4",type:"gloves",typemod:"defense",level:44,modifier:20,staticsheet:1,spriteName:"armors",offset:[3,6]},{id:115,name:"Leather Boots 4",type:"boots",typemod:"defense",level:46,modifier:20,staticsheet:1,spriteName:"armors",offset:[3,7]},{id:200,name:"Sword 1",type:"sword",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,0]},{id:201,name:"Sword 2",type:"sword",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,0]},{id:202,name:"Sword 3",type:"sword",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,0]},{id:203,name:"Sword 4",type:"sword",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,0]},{id:204,name:"Sword 5",type:"sword",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,0]},{id:205,name:"Sword 6",type:"sword",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,0]},{id:206,name:"Sword 7",type:"sword",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,0]},{id:207,name:"Sword 8",type:"sword",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,0]},{id:208,name:"Sword 9",type:"sword",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,0]},{id:209,name:"Sword 10",type:"sword",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,0]},{id:210,name:"Bow 1",type:"bow",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,3]},{id:211,name:"Bow 2",type:"bow",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,3]},{id:212,name:"Bow 3",type:"bow",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,3]},{id:213,name:"Bow 4",type:"bow",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,3]},{id:214,name:"Bow 5",type:"bow",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,3]},{id:215,name:"Bow 6",type:"bow",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,3]},{id:216,name:"Bow 7",type:"bow",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,3]},{id:217,name:"Bow 8",type:"bow",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,3]},{id:218,name:"Bow 9",type:"bow",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,3]},{id:219,name:"Bow 10",type:"bow",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,3]},{id:220,name:"Hammer 1",type:"hammer",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,5]},{id:221,name:"Hammer 2",type:"hammer",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,5]},{id:222,name:"Hammer 3",type:"hammer",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,5]},{id:223,name:"Hammer 4",type:"hammer",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,5]},{id:224,name:"Hammer 5",type:"hammer",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,5]},{id:225,name:"Hammer 6",type:"hammer",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,5]},{id:226,name:"Hammer 7",type:"hammer",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,5]},{id:227,name:"Hammer 8",type:"hammer",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,5]},{id:228,name:"Hammer 9",type:"hammer",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,5]},{id:229,name:"Hammer 10",type:"hammer",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,5]},{id:230,name:"Axe 1",type:"axe",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,8]},{id:231,name:"Axe 2",type:"axe",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,8]},{id:232,name:"Axe 3",type:"axe",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,8]},{id:233,name:"Axe 4",type:"axe",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,8]},{id:234,name:"Axe 5",type:"axe",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,8]},{id:235,name:"Axe 6",type:"axe",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,8]},{id:236,name:"Axe 7",type:"axe",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,8]},{id:237,name:"Axe 8",type:"axe",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,8]},{id:238,name:"Axe 9",type:"axe",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,8]},{id:239,name:"Axe 10",type:"axe",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,8]},{id:300,name:"Stone",type:"craft",level:10,staticsheet:5,spriteName:"gather1",offset:[1,0]},{id:301,name:"Coal",type:"craft",level:20,staticsheet:8,spriteName:"nodeset2",offset:[1,0]},{id:302,name:"Light Iron",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[1,1]},{id:303,name:"Medium Iron",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[1,2]},{id:304,name:"Hard Iron",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[1,3]},{id:305,name:"Iron Ingot 1",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[2,1]},{id:306,name:"Iron Ingot 2",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[2,2]},{id:307,name:"Iron Ingot 3",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[2,3]},{id:310,name:"Leather 1",type:"craft",staticsheet:6,spriteName:"craft1",offset:[0,0]},{id:311,name:"Leather 2",type:"craft",staticsheet:6,spriteName:"craft1",offset:[1,0]},{id:312,name:"Leather 3",type:"craft",staticsheet:6,spriteName:"craft1",offset:[2,0]},{id:313,name:"Leather 4",type:"craft",staticsheet:6,spriteName:"craft1",offset:[3,0]},{id:320,name:"Wood",type:"craft",staticsheet:7,spriteName:"craft2",offset:[0,0]}]},{}],155:[function(e,t,i){t.exports={EN:{BANK_FULL:"Bank is full.",EQUIPMENT_FULL:"Equipment is full.",INVENTORY_FULL:"Inventory is full.",ITEM_ADDED:"{0} added",GOLD_ADDED:"{0} gold added",GOLD_REMOVED:"{0} gold removed",EQUIPMENT_LEVEL:"You need to be level {0} to equip this.",EQUIPMENT_WRONGCLASS:"Your class cannot use this Item.",CHAT_MUTED:"You are currently muted.",MAP_ENTERED:"{0} has entered the {1} map.",NOTICE_1:"Go to the Google Play Store and rate Retro RPG Online!",TRADE_REQUESTED:"You requested a trade with {0}.",TRADE_REQUEST:"{0} has requested to trade you.",TUTORIAL_MOVE:"Click or Tap on land to move.",TUTORIAL_ATTACK:"Now click or tap on a Monster to attack",TUTORIAL_ATTACK2:"Thats it now kill more Monsters.",TUTORIAL_EQUIP:"Now I want to equip my brought gear by going into Menu Backpack and selecting it.",TUTORIAL_SHOPBUY:"I should find the Beginner Store by going to the menu and pressing Town.",TUTORIAL_SHOPBUY2:"I want to buy my first Armor and Weapon that is Level 10.",TUTORIAL_STATS:"You can now assign custom Stats in Menu >> Character >> 3rd Page (Character Stats),",TUTORIAL_PORTAL:"In the Town House move to the blue Portal near the bottom left.",SHOP_REPAIRED:"{0} item repaired.",SHOP_REMOVED:"{0} item removed.",SHOP_SOLD:"{0} has been sold.",SHOP_BUY:"{0} has been bought.",SHOP_ENCHANTED:"{0} has been enchanted.",SHOP_NOGOLD:"You don't have enough Gold.",SHOP_NOGEMS:"You don't have enough Gems.",SHOP_NOSPACE:"There is not enough space in your inventory.",SHOP_MISMATCH:"The price has been changed, please try again.",AUCTION_ADDED:"The auction item you listed has been added.",SHOP_NOCRAFTITEMS:"You do not have enough craft Items.",SHOP_MISSINGITEMS:"You are missing {0} {1}'s",COMBAT_PLAYERKILLED:"/1 {0} killed {1} in combat.",COMBAT_TARGETINVINCIBLE:"Target is invincible.",GROUP_PLAYERLEFT:"{0} has left your group.",ATTACK_TOOFAR:"You are too far away to attack.",TUTORIAL:"TUTORIAL",TUTORIAL_1:"To Move, Mouse click on the Map or an Object, or use the WASD or arrow keys.",TUTORIAL_2:"To Attack, Mouse click on the Object or get in attack range and press Space bar.",TUTORIAL_3:"To Cycle Targets, use keys T to target the closest Object or Y to reverse target.",TUTORIAL_4:"You can use Keys 1-4 for Skill Shortcuts, and Keys 5-8 for consumables like Potions.",TUTORIAL_5:"If you need to buy items you can select Menu >> Town to instantly warp to Town.",TUTORIAL_6:"At level 10 you can equip Items in Menu >> Equipment, and at level 20 you can assign Stat Points.",ACHIEVEMENTS_0:"Kill {0} Monsters.",ACHIEVEMENTS_1:"Collect {0} Items.",ACHIEVEMENTS_2:"Do {0} Damage to Monsters.",ACHIEVEMENTS_3:"Mine {0} Nodes.",ACHIEVEMENTS_4:"Log {0} Trees.",ACHIEVEMENTS_5:"Interact with {0} Objects.",ACHIEVEMENTS_0_COMPLETE:"Achievement - Kill {0} Monsters Completed. {1}XP Added.",ACHIEVEMENTS_1_COMPLETE:"Achievement - Collect {0} Items Completed. {1}XP Added.",ACHIEVEMENTS_2_COMPLETE:"Achievement - Do {0} Damage to Monsters Completed. {1}XP Added.",ACHIEVEMENTS_3_COMPLETE:"Achievement - Mine {0} Nodes Completed. {1}XP Added.",ACHIEVEMENTS_4_COMPLETE:"Achievement - Log {0} Trees Completed. {1}XP Added.",ACHIEVEMENTS_5_COMPLETE:"Achievement - Interact with {0} Objects Completed. {1}XP Added.",PARTY_PLAYER_INVITE_SENT:"Party invite sent to player {0}",PARTY_MAX_PLAYERS:"Max players reached in party.",PARTY_PLAYER_JOINED:"{0} joined your party.",PARTY_PLAYER_ADDED:"You are now partied with {0}",PARTY_YOU_REJECTED_INVITE:"You rejected {0}'s invite.",PARTY_THEY_REJECTED_INVITE:"{0} rejected your invite.",PARTY_CANNOT_KICK:"You cannot kick as you are not in a party or leader.",PARTY_PLAYER_KICKED:"You have been kicked from the party.",PARTY_NOT_LEADER:"You cannot set the leader as you are not in a party.",PARTY_YOU_LEADER:"You are now the leader.",PARTY_PLAYER_LEADER:"{0} is now leader.",PARTY_IS_LEADER:"{0} is already leader.",PARTY_NOT_IN:"You cannot leave as you are not in a party.",PARTY_PLAYER_LEFT:"{0} has left your party.",PARTY_YOU_LEFT:"You have left {0}'s party.",PARTY_ALL_LEFT:"The party has been disbanded.",NO_PLAYER_EXIST:"Player {0} does not exist.",HARVEST_INVALID:"You cannot harvest at this point, use the right weapon, try somewhere else or again later.",HARVEST_ADDED:"{0} has been added to your inventory",HARVEST_WRONG_TYPE:"You cannot use this with a {0}.",HARVET_NO_WEAPON:"You do not have a harvest item equipped."}}},{}],156:[function(e,t,i){t.exports={Rat:{name:"Rat",kind:1,attackMod:1,defenseMod:1,hpMod:1,xpMod:1,minLevel:1,maxLevel:3,aggroRange:0,attackRange:1,isAggressive:0,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"rat",idleSpeedMod:1},Crab:{name:"Crab",kind:2,attackMod:1.2,defenseMod:1.2,hpMod:1,minLevel:4,maxLevel:6,aggroRange:5,attackRange:1,isAggressive:0,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"crab",idleSpeedMod:1},Skeleton:{name:"Skeleton",kind:3,attackMod:1.1,defenseMod:1.1,hpMod:1.2,minLevel:7,maxLevel:9,aggroRange:2,attackRange:1,isAggressive:1,attackRateMod:1.5,reactionMod:1.5,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"skeleton",idleSpeedMod:1},Goblin:{name:"Goblin",kind:4,attackMod:1.2,defenseMod:.9,hpMod:.9,minLevel:10,maxLevel:12,aggroRange:3,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"goblin",idleSpeedMod:1},Snake:{name:"Snake",kind:5,attackMod:1.4,defenseMod:1,hpMod:.8,minLevel:13,maxLevel:15,aggroRange:3,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"snek",idleSpeedMod:1},Bat:{name:"Bat",kind:6,attackMod:1.3,defenseMod:1,hpMod:1,minLevel:16,maxLevel:18,aggroRange:6,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:1,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"bat",idleSpeedMod:1},Skeleton2:{name:"HardSkeleton",kind:7,attackMod:1.3,defenseMod:1.3,hpMod:1.2,minLevel:19,maxLevel:21,aggroRange:2,attackRange:1,isAggressive:1,attackRateMod:2,reactionMod:2,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"skeleton2",idleSpeedMod:1},Ogre:{name:"Ogre",kind:8,attackMod:1.3,defenseMod:1.1,hpMod:1.3,minLevel:22,maxLevel:24,aggroRange:5,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"ogre",idleSpeedMod:1},Eye:{name:"Eye",kind:9,attackMod:1.4,defenseMod:1,hpMod:1,minLevel:25,maxLevel:29,aggroRange:3,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"eye",idleSpeedMod:1},Wizard:{name:"Wizard",kind:10,attackMod:1.4,defenseMod:1,hpMod:1,minLevel:30,maxLevel:34,aggroRange:6,attackRange:3,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:3,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"wizard",idleSpeedMod:1},Spectre:{name:"Spectre",kind:11,attackMod:1.3,defenseMod:1.3,hpMod:1,minLevel:35,maxLevel:40,aggroRange:2,attackRange:2,isAggressive:1,attackRateMod:2,reactionMod:.5,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"spectre",idleSpeedMod:1},DeathKnight:{name:"DeathKnight",kind:12,attackMod:1.5,defenseMod:1.5,hpMod:1.5,minLevel:41,maxLevel:50,aggroRange:4,attackRange:1,isAggressive:1,attackRateMod:2,reactionMod:.5,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"deathknight",idleSpeedMod:1}}},{}],157:[function(e,t,i){t.exports={plot:["You have awoken","You're awake","It's awake?","You will die this time","How could this happen?","Is that you?","It cant be..","But, but I thought you were dead..","This time you will not survive.","I will kill you for good.","None can survive me!","Curses youre alive still.","But, We destroyed you..","We killed your father and well kill you.","How can you be alive still?","Your brother gasped as he died.","Its, its you..","The chosen one, ha you will pay in blood"],battle:["Argh","Ugh","Oooh","Ahhh","MMmm","Eaat","Delicious","Die","Kill it","Kill","Destroy","Maimm","Death","Foood","Starving","Rawr","Roar","Yummy","Grrr","Growl"]}},{}],158:[function(e,t,i){t.exports=[{textid:"NOTICE1",interval:60}]},{}],159:[function(e,t,i){t.exports={0:{type:0,text:"Kill %count Monsters Level %level or more"},1:{type:2,text:"%names! Kill %count of em"},2:{type:2,text:"I am dying kill %count of %names"},3:{type:2,text:"%names have destroyed my home kill %count"},4:{type:2,text:"%names have swarmed us kill %count"},5:{type:2,text:"We've been overtaken by %names kill %count"},6:{type:2,text:"Kill %count %names for fun, there evil."},7:{type:1,text:"Get %count %name. Return them to Collect in town."},8:{type:4,text:"Find %name. We playing hide and seek!"}}},{}],160:[function(e,t,i){t.exports=["Aeris","Baelan","Caelum","Darian","Eldryn","Faelan","Gavriel","Haven","Ilys","Jaelin","Kaelan","Lirael","Maelis","Naelen","Ovryn","Peregrine","Quillen","Raelin","Sylas","Tyrian","Uvaine","Vaelis","Wylan","Xaelor","Yaelith","Zephyr","Aldryn","Briar","Cyran","Daelin","Elowen","Fenris","Gaelan","Harlow","Ivory","Jadis","Kieran","Loren","Myst","Nyssa"]},{}],161:[function(e,t,i){t.exports={0:["Alters","Altes","Amel","Amew","Ancin","Ancis","Andent","Anies","Arryn","Artin","Artip","Berny","Berter","Brancent","Brancis","Chames","Charles","Charliam","Drewis","Driffin","Drobert","Droguy","Edmugh","Edmund","Enryn","Ephed","Epher","Ephes","Eran","Ernam","Ethes","Ewis","Exam","Exard","Folke","Friffin","Gauwill","Gauwyn","Geoffrey","Georguy","Gerey","Gery","Gilas","Gilip","Grarder","Grobern","Gylip","Hames","Hamund","Hany","Harrey","Hony","Ilham","Ilhard","Illiam","Inghan","Jamath","Johny","Lasym","Lesym","Mesym","Munder","Narder","Nichye","Phughye","Raffin","Ralphye","Reder","Reward","Rewilh","Rewyn","Reyny","Richye","Robern","Robern","Roge","Roge","Ryany","Stephye","Stiny","Symas","Thamath","Vyncent","Vyncis","Waltin","Wilhye","Wyny"],1:["Abeth","Adon","Aebun","Aedad","Aelburg","Aengeth","Aenthrynn","Alhhild","Alyn","Anel","Argel","Auciet","Balde","Beatrey","Bely","Bily","Breawe","Brictlu","Briga","Brihta","Brione","Brithuia","Bruda","Bryne","Brytha","Burha","Cilia","Conga","Corna","Cyna","Deburg","Deleue","Ealhbun","Ealhburh","Ealket","Eanchild","Eanswild","Ebun","Ecin","Efrix","Elil","Elin","Ellet","Ellyn","Ellys","Elyn","Enen","Enet","Engard","Ennet","Ethen","Evet","Frowe","Frude","Fruna","Godga","Goldburg","Gythiue","Hely","Heve","Hily","Hone","Idgen","Isan","Izan","Joane","Kater","Kathon","Lizab","Lyse","Malia","Mara","Marey","Marget","Mary","Mery","Mildgiue","Olburh","Phone","Ricta","Ridget","Rithuia","Sabenn","Sane","Sarry","Sidwe","Stilda","Suse","Sybel","Tortga","Ware","Wellu","Wene","Wenga","Wilthroua","Wise","Witha","Withburh","Withiue","Wrtheahburg","Wuthe"]}},{}],162:[function(e,t,i){t.exports=[{uid:"default",index:0},{uid:"agent",name:"Auction",index:1},{uid:"ancientmanumentnpc",index:2},{uid:"angelnpc",index:3},{uid:"beachnpc",name:"Beachgoer",index:4},{uid:"bluebikinigirlnpc",index:5},{uid:"bluestoremannpc",name:"Bank",index:6},{uid:"boxingman",name:"Bank",index:7},{uid:"coder",name:"Looks",index:8},{uid:"desertnpc",name:"Repair",index:9},{uid:"doctor",name:"Looks",index:10},{uid:"elfnpc",index:11},{uid:"fairynpc",index:12},{uid:"firstsonangelnpc",index:13},{uid:"fisherman",index:14},{uid:"forestnpc",index:15},{uid:"guard",index:16},{uid:"iamverycoldnpc",index:17},{uid:"iceelfnpc",index:18},{uid:"king",index:19},{uid:"lavanpc",name:"Dying Man",index:20},{uid:"mermaidnpc",name:"Mermaid",index:21},{uid:"mojojojonpc",index:22},{uid:"momangelnpc",index:23},{uid:"nyan",index:24},{uid:"octocat",index:25},{uid:"octopus",index:26},{uid:"oddeyecat",index:27},{uid:"pirategirlnpc",index:28},{uid:"priest",index:29},{uid:"redbikinigirlnpc",index:30},{uid:"redstoremannpc",name:"Craft",index:31},{uid:"rick",name:"Collect",index:32},{uid:"scientist",index:33},{uid:"secondsonangelnpc",index:34},{uid:"shepherdboy",name:"Shop",index:35},{uid:"snowshepherdboy",name:"Beginner shop",index:36},{uid:"soldier",index:37},{uid:"sorcerer",index:38},{uid:"sponge",index:39},{uid:"superiorangelnpc",index:40},{uid:"vampire",index:41},{uid:"vendingmachine",name:"Enchant",index:42},{uid:"villagegirl",name:"Enchant",index:43},{uid:"villager",name:"Quests",index:44},{uid:"zombiegf",name:"Quests",index:45}]},{}],163:[function(e,t,i){t.exports=[{name:"gold100000",type:"gold",data:"100000"},{name:"gold1000000",type:"gold",data:"1000000"}]},{}],164:[function(e,t,i){t.exports={1:{npcKind:0,name:"Intro 1",type:1,level:0,object:{type:2,kind:1,count:10}},2:{npcKind:1,name:"Intro 2",type:2,level:0,object:{type:2,kind:1,level:[0,5]},object2:{type:4,kind:1,count:3,chance:20}},3:{npcKind:2,name:"Intro 3",type:2,level:0,object:{type:2,kind:1,level:[0,5]},object2:{type:4,kind:41,count:5,chance:20}},4:{npcKind:3,name:"Intro 4",type:2,level:0,object:{type:2,kind:2,level:[3,5]},object2:{type:4,kind:43,count:1,chance:5}},5:{npcKind:4,name:"Intro 5",type:1,level:0,object:{type:2,kind:2,count:10}},6:{npcKind:5,name:"Intro 6",type:5,level:0,data1:1,object:{type:10,kind:3,count:5}},7:{npcKind:6,name:"Intro 7",type:5,level:0,data1:2,object:{type:10,kind:3,count:5}}}},{}],165:[function(e,t,i){t.exports=[{name:"Beserker",skillType:0,recharge:30,iconOffset:[1,7],detail:"Beserker [l] - Boosts your attack by 3xlevel for 10 seconds,",targetType:0,duration:10,effects:[[0,0,2,3],[0,1,2,-3]]},{name:"Explosive Attack",skillType:2,recharge:10,iconOffset:[3,12],detail:"Explosive Attack [l] - AOE NOT IMPLEMENTED",targetType:1,countTotal:1,aoe:3,effects:[[1,0,4,50]]},{name:"Deadly Attack",skillType:2,recharge:10,iconOffset:[4,7],detail:"Deadly Attack [l] - Does an attack of 150 damage per level.",targetType:1,countTotal:1,effects:[[1,0,4,150]]},{name:"Daze",skillType:1,recharge:30,iconOffset:[0,12],detail:"Daze [l] - Dazes the target for [dpl]% seconds.",targetType:1,durationPL:1,effects:[[1,0,5,1],[1,1,5,0]]},{name:"Slow",skillType:1,recharge:20,iconOffset:[3,5],detail:"Slow [l] - Slows target for [dpl]% seconds.",targetType:1,durationPL:1,effects:[[1,0,6,100],[1,1,6,-100]]}]},{}],166:[function(e,t,i){var n;e=e("semver").satisfies(process.version,">=0.7.1")?e("fs"):e("path"),n=e.exists,e=e.existsSync,void 0!==i&&(t.exports.exists=n,t.exports.existsSync=e)},{fs:void 0,path:void 0,semver:void 0}],167:[function(e,t,n){EventType={KILLMOB:1,LOOTITEM:2,KILLPLAYER:3,DAMAGE:4,USE_NODE:5,HARVEST:6},QuestType={KILLMOBKIND:1,GETITEMKIND:2,KILLMOBS:3,HIDEANDSEEK:4,USENODE:5},QuestStatus={STARTED:0,INPROGRESS:1,COMPLETE:2},InventoryMode={MODE_NORMAL:0,MODE_SELL:1,MODE_REPAIR:2,MODE_ENCHANT:3,MODE_BANK:4,MODE_AUCTION:5},SkillEffects={SkillType:{SELF:0,TARGET:1,ATTACK:2},TargetType:{SELF:0,ENEMY:1,PLAYER_AOE:2,ENEMY_AOE:3},EffectStat:{HP:0,EP:1,ATTACK:2,DEFENSE:3,DAMAGE:4,FREEZE:5,MOVESPEED:6}};Types={Messages:{BI_SYNCTIME:100,CS_CREATE_USER:1,CS_LOGIN_USER:2,CS_CREATE_PLAYER:3,CS_LOGIN_PLAYER:4,CS_ITEMSLOT:10,CS_APPEARANCEUNLOCK:11,CS_ATTACK:12,CS_AUCTIONBUY:13,CS_AUCTIONDELETE:14,CS_AUCTIONOPEN:15,CS_AUCTIONSELL:16,CS_BANKRETRIEVE:17,CS_BANKSTORE:18,CS_CHAT:19,CS_COLOR_TINT:20,BI_BLOCK_MODIFY:21,CS_GOLD:22,CS_PARTY:23,BI_HARVEST:24,CS_USE_NODE:25,CS_LOADLOOKS:26,CS_LOOKUPDATE:27,CS_LOOT:28,CS_MOVE:29,CS_MOVEPATH:30,CS_PLAYER_REVIVE:31,CS_QUEST:32,BI_SEND_BANK:34,BI_SEND_INVENTORY:35,CS_STATADD:36,CS_STOREBUY:37,CS_STOREENCHANT:38,CS_STOREREPAIR:39,CS_STORESELL:40,CS_TALKTONPC:41,CS_CRAFT:42,CS_TELEPORT_MAP:43,CS_WHO:44,CS_SKILL:45,CS_SKILLINSTALL:46,SC_ERROR:60,SC_WORLDS:61,SC_VERSION:62,SC_PLAYER_SUM:63,SC_PLAYER:64,SC_ACHIEVEMENT:65,SC_AUCTIONOPEN:66,SC_ITEMSLOT:67,SC_CHANGEPOINTS:68,SC_CHAT:69,SC_COLOR_TINT:70,SC_DAMAGE:71,SC_DESPAWN:72,SC_SWAPSPRITE:73,SC_APPEARANCE:74,SC_GOLD:75,SC_PARTY:76,BI_PLAYERINFO:77,SC_ITEMLEVELUP:78,SC_KILL:79,SC_LEVELUP:80,SC_LIST:81,SC_LOOKS:82,SC_LOG:83,SC_LOOKUPDATE:84,SC_MOVE:85,SC_MOVEPATH:86,SC_NOTIFY:87,SC_QUEST:88,SC_SKILLEFFECTS:89,SC_SKILLLOAD:90,SC_SPAWN:91,SC_SPEECH:92,SC_STATINFO:93,SC_TELEPORT_MAP:94,SC_SKILL_XP:95,SC_DIALOGUE:96},Orientations:{NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4},EntityTypes:{NONE:0,PLAYER:1,MOB:2,ITEM:3,ITEMLOOT:4,NPCSTATIC:5,NPCMOVE:6,CHEST:7,BLOCK:8,TRAP:9,NODE:10},Keys:{ENTER:13,UP:38,DOWN:40,LEFT:37,RIGHT:39,W:87,A:65,S:83,D:68,SPACE:32,I:73,H:72,M:77,P:80,T:84,Y:89,KEYPAD_4:100,KEYPAD_6:102,KEYPAD_8:104,KEYPAD_2:98,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57},Skills:{BLOODSUCKING:1,RECOVERHEALTH:2,HEALANDHEAL:3,AVOIDATTACK:4,ADDEXPERIENCE:5,ATTACKWITHBLOOD:6,CRITICALATTACK:7,CRITICALRATIO:8},PlayerClass:{FIGHTER:0,ARCHER:1,DEFENDER:2,MAGE:3},PlayerState:{Roaming:0,Moving:1,Following:2,Aggro:3,Hurting:4,GettingItems:5,FollowPlayer:6}};for(Types.expForLevel=[],Types.defenseExp=[],Types.attackExp=[],Types.moveExp=[],Types.skillExp=[],Types.weaponExp=[],Types.expForLevel[0]=0,Types.defenseExp[0]=0,Types.attackExp[0]=0,Types.moveExp[0]=0,Types.skillExp[0]=0,Types.weaponExp[0]=0,i=1;i<50;i++){var s=Math.floor(300*i*Math.pow(1.5,i/5));console.info("level_"+i+"="+s),Types.expForLevel[i]=s,Types.defenseExp[i]=10*s+50,Types.attackExp[i]=10*s+50,Types.moveExp[i]=5*s+20,Types.skillExp[i]=~~(s/1.5),Types.weaponExp[i]=10*s+50}Types.getLevel=function(e){if(void 0===e||0==e)return 1;for(var t=1;t<200;t++)if(e<Types.expForLevel[t])return t;return 50},Types.getAttackLevel=function(e){if(0==e)return 1;for(var t=1;t<200;t++)if(e<Types.attackExp[t])return t;return 50},Types.getDefenseLevel=function(e){if(0==e)return 1;for(var t=1;t<200;t++)if(e<Types.defenseExp[t])return t;return 50},Types.getMoveLevel=function(e){if(0==e)return 1;for(var t=1;t<200;t++)if(e<Types.moveExp[t])return t;return 50},Types.getWeaponLevel=function(e){if(0==e)return 1;for(var t=1;t<200;t++)if(e<Types.weaponExp[t])return t;return 50},Types.getSkillLevel=function(e,t){if(void 0===e||0==e)return 1;for(var i=t=t||1;i<20;i++)if(e<Types.skillExp[i])return i;return 20},Types.isPlayer=function(e){return 1===e||222===e},Types.getOrientationAsString=function(e){switch(e){case Types.Orientations.LEFT:return"left";case Types.Orientations.RIGHT:return"right";case Types.Orientations.UP:return"up";case Types.Orientations.DOWN:return"down"}},Types.getMessageTypeAsString=function(i){var n;return _.each(Types.Messages,function(e,t){e===i&&(n=t)}),n=n||"UNKNOWN"},void 0!==n&&(t.exports=Types)},{}],168:[function(e,t,n){var r={},o={};for(r.setKindData=function(e){o=e,r.KindData=e},r.getData=function(e){e=o[e];return e&&1!=e.legacy?e:null},r.getName=function(t){try{var e=o[t];return e?e.name:""}catch(e){console.error("No name found for item: "+o[t]),console.error("Error stack: "+e.stack)}},r.getWeaponLevel=function(t){try{var e=o[t];return e?e.modifier:0}catch(e){console.error("No level found for weapon: "+o[t]),console.error("Error stack: "+e.stack)}},r.getArmorLevel=function(t){try{var e=o[t];return e?e.modifier:0}catch(e){console.error("No level found for armor: "+o[t]),console.error("Error stack: "+e.stack)}},r.getItemByLevel=function(e,t){for(var i in o){i=o[i];if(("armor"==i.type||"armorarcher"==i.type)&&i.type==e&&t==i.modifier)return i;if(("weapon"==i.type||"weaponarcher"==i.type)&&i.type==e&&t==i.modifier)return i}return null},r.getLevelByKind=function(e){var t=o[e];return r.isArmor(e)||r.isWeapon(e)?t.level:null},r.getType=function(t){try{return o[t].type}catch(e){console.error("No type found for item: "+t),console.error("Error stack: "+e.stack)}},r.getBuyPrice=function(e){var t,i=o[e];return i?"bow"==(t=i.type)||"chest"==t||r.isArmor(e)||r.isWeapon(e)?Math.floor(i.modifier*i.modifier*10):"object"==t&&0<i.buy?1<i.buyCount?i.buy*i.buyCount:i.buy:0:0},r.getCraftPrice=function(e){var t=o[e];return t&&1!=t.legacy?0<t.buy?t.buy:~~(r.getBuyPrice(e)/4):0},r.getEnchantSellPrice=function(e){var t=r.getBuyPrice(e.itemKind)/10;return 1<e.itemNumber&&(t+=~~(r.getEnchantPrice(e)/10)),t*=e.itemDurabilityMax/900,Math.floor(t)},r.getEnchantPrice=function(e){if(!e)return NaN;var t=o[e.itemKind],i=e.itemNumber+1;e.itemNumber;if(25<=i)return NaN;experience=e.itemExperience;e=t.modifier,console.info("getEnchantPrice: "+r.itemExpForLevel[i]),t=Math.floor(e*e*10*Math.pow(2,i)*(1-experience/r.itemExpForLevel[i]));return console.info("cost: "+t),t},r.getRepairPrice=function(e){var t=r.getBuyPrice(e.itemKind)/10,i=e.itemNumber;return e.itemDurability==e.itemDurabilityMax?0:(1<i&&(t+=Math.pow(1.8,i)),t*=e.itemDurability/e.itemDurabilityMax*(e.itemDurabilityMax/900)*e.itemNumber,Math.floor(t))},r.isEquippable=function(e){return!!(r.isArmor(e)||r.isWeapon(e)||r.isArcherWeapon(e)||r.isClothes(e))},r.isClothes=function(e){e=o[e];return!!e&&("helm"===e.type||"chest"===e.type||"gloves"===e.type||"boots"===e.type)},r.isArmor=function(e){return!!o[e]&&r.isClothes(e)},r.isWeapon=function(e){return!!o[e]&&(r.isMeleeWeapon(e)||r.isArcherWeapon(e))},r.isEquipment=function(e){return!!o[e]&&(r.isWeapon(e)||r.isArmor(e))},r.isMeleeWeapon=function(e){e=o[e];return!!e&&("sword"===e.type||"hammer"===e.type||"axe"===e.type)},r.isHarvestWeapon=function(e){e=o[e];return!!e&&("hammer"===e.type||"axe"===e.type)},r.isArcherWeapon=function(e){e=o[e];return!!e&&"bow"===e.type},r.isObject=function(e){e=o[e];return!!e&&"object"===e.type},r.isCraftItem=function(e){e=o[e];return!!e&&"craft"===e.type},r.isLootItem=function(e){return 1e3<=e&&e<2e3},r.isConsumableItem=function(e){e=o[e];return!!e&&"object"===e.type},r.isHealingItem=function(e){e=o[e];return!!e&&"object"===e.type&&("health"==e.typemod||"healthpercent"==e.typemod)},r.isItem=function(e){var t=r.KindData[e];return!!t&&(r.isArmor(e)||r.isWeapon(e)||"object"==t.type||"craft"==t.type)},r.forEachKind=function(e){for(var t in kindData)e(o[t],t)},r.forEachArmorKind=function(i){Types.forEachKind(function(e,t){r.isArmor(e)&&i(e,t)})},r.forEachWeaponKind=function(i){Types.forEachKind(function(e,t){r.isWeapon(e)&&i(e,t)})},r.forEachArcherWeaponKind=function(i){Types.forEachKind(function(e,t){r.isArcherWeapon(e)&&i(e,t)})},r.getItemListBy=function(e,t,i){var n,s=[];for(n in o){var a=o[n];a&&1!=a.legacy&&(4!=e||r.isArmor(n)||r.isWeapon(n)||s.push({name:a.name,kind:n,type:a.type,buyCount:a.buycount,buyPrice:a.buy,craftPrice:r.getCraftPrice(n),itemKind:n,itemNumber:a.buycount,craft:a.craft}),1==e&&"object"==a.type&&0<a.buy?s.push({name:a.name,kind:n,type:a.type,buyCount:a.buycount,buyPrice:a.buy,craftPrice:r.getCraftPrice(n),itemKind:n,itemNumber:a.buycount,craft:a.craft}):(2==e&&r.isArmor(n)&&a.modifier>=t&&a.modifier<=i||3==e&&r.isWeapon(n)&&a.modifier>=t&&a.modifier<=i)&&s.push({name:a.name,kind:n,type:a.type,buyCount:a.buyCount,buyPrice:r.getBuyPrice(n),craftPrice:r.getCraftPrice(n),rank:a.level,itemKind:n,itemNumber:a.buycount,craft:a.craft}))}return 0<s.length&&0<s[0].rank&&s.sort(function(e,t){return e.rank-t.rank}),s},r.Store={isBuy:function(e){e=o[e];return!!e&&0<e.buy},isBuyMultiple:function(e){e=o[e];return!!e&&0<e.buycount},isSell:function(e){e=o[e];return!!e&&2<=e.buy},getBuyCount:function(e){e=o[e];return!!e&&(1<e.buyCount?e.buyCount:1)},getItems:function(e,t,i){return r.getItemListBy(e,t,i)}},r.itemExpForLevel=[],r.itemExpForLevel[0]=0,i=1;i<30;i++){var s=Math.floor(150*i*Math.pow(2,i/10));r.itemExpForLevel[i]=s}r.getItemLevel=function(e){if(0==e)return 1;for(var t=1,t=1;t<30;t++)if(e>r.itemExpForLevel[t-1]&&e<=r.itemExpForLevel[t])return t;return 30},void 0!==n&&(t.exports=r)},{}]},{},[106]);
