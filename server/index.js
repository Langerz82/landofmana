(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,(function(r){var n=e[i][1][r];return o(n||r)}),p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){"use strict";var isValue=require("type/value/is"),isPlainFunction=require("type/plain-function/is"),assign=require("es5-ext/object/assign"),normalizeOpts=require("es5-ext/object/normalize-options"),contains=require("es5-ext/string/#/contains");var d=module.exports=function(dscr,value){var c,e,w,options,desc;if(arguments.length<2||typeof dscr!=="string"){options=value;value=dscr;dscr=null}else{options=arguments[2]}if(isValue(dscr)){c=contains.call(dscr,"c");e=contains.call(dscr,"e");w=contains.call(dscr,"w")}else{c=w=true;e=false}desc={value:value,configurable:c,enumerable:e,writable:w};return!options?desc:assign(normalizeOpts(options),desc)};d.gs=function(dscr,get,set){var c,e,options,desc;if(typeof dscr!=="string"){options=set;set=get;get=dscr;dscr=null}else{options=arguments[3]}if(!isValue(get)){get=undefined}else if(!isPlainFunction(get)){options=get;get=set=undefined}else if(!isValue(set)){set=undefined}else if(!isPlainFunction(set)){options=set;set=undefined}if(isValue(dscr)){c=contains.call(dscr,"c");e=contains.call(dscr,"e")}else{c=true;e=false}desc={get:get,set:set,configurable:c,enumerable:e};return!options?desc:assign(normalizeOpts(options),desc)}},{"es5-ext/object/assign":26,"es5-ext/object/normalize-options":37,"es5-ext/string/#/contains":44,"type/plain-function/is":8,"type/value/is":12}],2:[function(require,module,exports){"use strict";var isPlainFunction=require("type/plain-function/is"),ensureValue=require("type/value/ensure"),isValue=require("type/value/is"),map=require("es5-ext/object/map"),contains=require("es5-ext/string/#/contains");var call=Function.prototype.call,defineProperty=Object.defineProperty,getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor,getPrototypeOf=Object.getPrototypeOf,hasOwnProperty=Object.prototype.hasOwnProperty,cacheDesc={configurable:false,enumerable:false,writable:false,value:null},define;define=function(name,options){var value,dgs,cacheName,desc,writable=false,resolvable,flat;options=Object(ensureValue(options));cacheName=options.cacheName;flat=options.flat;if(!isValue(cacheName))cacheName=name;delete options.cacheName;value=options.value;resolvable=isPlainFunction(value);delete options.value;dgs={configurable:Boolean(options.configurable),enumerable:Boolean(options.enumerable)};if(name!==cacheName){dgs.get=function(){if(hasOwnProperty.call(this,cacheName))return this[cacheName];cacheDesc.value=resolvable?call.call(value,this,options):value;cacheDesc.writable=writable;defineProperty(this,cacheName,cacheDesc);cacheDesc.value=null;if(desc)defineProperty(this,name,desc);return this[cacheName]}}else if(!flat){dgs.get=function self(){var ownDesc;if(hasOwnProperty.call(this,name)){ownDesc=getOwnPropertyDescriptor(this,name);if(ownDesc){if(ownDesc.hasOwnProperty("value"))return ownDesc.value;if(typeof ownDesc.get==="function"&&ownDesc.get!==self){return ownDesc.get.call(this)}return value}}desc.value=resolvable?call.call(value,this,options):value;defineProperty(this,name,desc);desc.value=null;return this[name]}}else{dgs.get=function self(){var base=this,ownDesc;if(hasOwnProperty.call(this,name)){ownDesc=getOwnPropertyDescriptor(this,name);if(ownDesc.hasOwnProperty("value"))return ownDesc.value;if(typeof ownDesc.get==="function"&&ownDesc.get!==self){return ownDesc.get.call(this)}}while(!hasOwnProperty.call(base,name))base=getPrototypeOf(base);desc.value=resolvable?call.call(value,base,options):value;defineProperty(base,name,desc);desc.value=null;return base[name]}}dgs.set=function(value){if(hasOwnProperty.call(this,name)){throw new TypeError("Cannot assign to lazy defined '"+name+"' property of "+this)}dgs.get.call(this);this[cacheName]=value};if(options.desc){desc={configurable:contains.call(options.desc,"c"),enumerable:contains.call(options.desc,"e")};if(cacheName===name){desc.writable=contains.call(options.desc,"w");desc.value=null}else{writable=contains.call(options.desc,"w");desc.get=dgs.get;desc.set=dgs.set}delete options.desc}else if(cacheName===name){desc={configurable:Boolean(options.configurable),enumerable:Boolean(options.enumerable),writable:Boolean(options.writable),value:null}}delete options.configurable;delete options.enumerable;delete options.writable;return dgs};module.exports=function(props){return map(props,(function(desc,name){return define(name,desc)}))}},{"es5-ext/object/map":36,"es5-ext/string/#/contains":44,"type/plain-function/is":8,"type/value/ensure":11,"type/value/is":12}],3:[function(require,module,exports){"use strict";var isPrototype=require("../prototype/is");module.exports=function(value){if(typeof value!=="function")return false;if(!hasOwnProperty.call(value,"length"))return false;try{if(typeof value.length!=="number")return false;if(typeof value.call!=="function")return false;if(typeof value.apply!=="function")return false}catch(error){return false}return!isPrototype(value)}},{"../prototype/is":9}],4:[function(require,module,exports){"use strict";var isValue=require("../value/is"),isObject=require("../object/is"),stringCoerce=require("../string/coerce"),toShortString=require("./to-short-string");var resolveMessage=function(message,value){return message.replace("%v",toShortString(value))};module.exports=function(value,defaultMessage,inputOptions){if(!isObject(inputOptions))throw new TypeError(resolveMessage(defaultMessage,value));if(!isValue(value)){if("default"in inputOptions)return inputOptions["default"];if(inputOptions.isOptional)return null}var errorMessage=stringCoerce(inputOptions.errorMessage);if(!isValue(errorMessage))errorMessage=defaultMessage;throw new TypeError(resolveMessage(errorMessage,value))}},{"../object/is":7,"../string/coerce":10,"../value/is":12,"./to-short-string":6}],5:[function(require,module,exports){"use strict";module.exports=function(value){try{return value.toString()}catch(error){try{return String(value)}catch(error2){return null}}}},{}],6:[function(require,module,exports){"use strict";var safeToString=require("./safe-to-string");var reNewLine=/[\n\r\u2028\u2029]/g;module.exports=function(value){var string=safeToString(value);if(string===null)return"<Non-coercible to string value>";if(string.length>100)string=string.slice(0,99)+"â€¦";string=string.replace(reNewLine,(function(char){switch(char){case"\n":return"\\n";case"\r":return"\\r";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:throw new Error("Unexpected character")}}));return string}},{"./safe-to-string":5}],7:[function(require,module,exports){"use strict";var isValue=require("../value/is");var possibleTypes={object:true,function:true,undefined:true};module.exports=function(value){if(!isValue(value))return false;return hasOwnProperty.call(possibleTypes,typeof value)}},{"../value/is":12}],8:[function(require,module,exports){"use strict";var isFunction=require("../function/is");var classRe=/^\s*class[\s{/}]/,functionToString=Function.prototype.toString;module.exports=function(value){if(!isFunction(value))return false;if(classRe.test(functionToString.call(value)))return false;return true}},{"../function/is":3}],9:[function(require,module,exports){"use strict";var isObject=require("../object/is");module.exports=function(value){if(!isObject(value))return false;try{if(!value.constructor)return false;return value.constructor.prototype===value}catch(error){return false}}},{"../object/is":7}],10:[function(require,module,exports){"use strict";var isValue=require("../value/is"),isObject=require("../object/is");var objectToString=Object.prototype.toString;module.exports=function(value){if(!isValue(value))return null;if(isObject(value)){var valueToString=value.toString;if(typeof valueToString!=="function")return null;if(valueToString===objectToString)return null}try{return""+value}catch(error){return null}}},{"../object/is":7,"../value/is":12}],11:[function(require,module,exports){"use strict";var resolveException=require("../lib/resolve-exception"),is=require("./is");module.exports=function(value){if(is(value))return value;return resolveException(value,"Cannot use %v",arguments[1])}},{"../lib/resolve-exception":4,"./is":12}],12:[function(require,module,exports){"use strict";var _undefined=void 0;module.exports=function(value){return value!==_undefined&&value!==null}},{}],13:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?Array.from:require("./shim")},{"./is-implemented":14,"./shim":15}],14:[function(require,module,exports){"use strict";module.exports=function(){var from=Array.from,arr,result;if(typeof from!=="function")return false;arr=["raz","dwa"];result=from(arr);return Boolean(result&&result!==arr&&result[1]==="dwa")}},{}],15:[function(require,module,exports){"use strict";var iteratorSymbol=require("es6-symbol").iterator,isArguments=require("../../function/is-arguments"),isFunction=require("../../function/is-function"),toPosInt=require("../../number/to-pos-integer"),callable=require("../../object/valid-callable"),validValue=require("../../object/valid-value"),isValue=require("../../object/is-value"),isString=require("../../string/is-string"),isArray=Array.isArray,call=Function.prototype.call,desc={configurable:true,enumerable:true,writable:true,value:null},defineProperty=Object.defineProperty;module.exports=function(arrayLike){var mapFn=arguments[1],thisArg=arguments[2],Context,i,j,arr,length,code,iterator,result,getIterator,value;arrayLike=Object(validValue(arrayLike));if(isValue(mapFn))callable(mapFn);if(!this||this===Array||!isFunction(this)){if(!mapFn){if(isArguments(arrayLike)){length=arrayLike.length;if(length!==1)return Array.apply(null,arrayLike);arr=new Array(1);arr[0]=arrayLike[0];return arr}if(isArray(arrayLike)){arr=new Array(length=arrayLike.length);for(i=0;i<length;++i)arr[i]=arrayLike[i];return arr}}arr=[]}else{Context=this}if(!isArray(arrayLike)){if((getIterator=arrayLike[iteratorSymbol])!==undefined){iterator=callable(getIterator).call(arrayLike);if(Context)arr=new Context;result=iterator.next();i=0;while(!result.done){value=mapFn?call.call(mapFn,thisArg,result.value,i):result.value;if(Context){desc.value=value;defineProperty(arr,i,desc)}else{arr[i]=value}result=iterator.next();++i}length=i}else if(isString(arrayLike)){length=arrayLike.length;if(Context)arr=new Context;for(i=0,j=0;i<length;++i){value=arrayLike[i];if(i+1<length){code=value.charCodeAt(0);if(code>=55296&&code<=56319)value+=arrayLike[++i]}value=mapFn?call.call(mapFn,thisArg,value,j):value;if(Context){desc.value=value;defineProperty(arr,j,desc)}else{arr[j]=value}++j}length=j}}if(length===undefined){length=toPosInt(arrayLike.length);if(Context)arr=new Context(length);for(i=0;i<length;++i){value=mapFn?call.call(mapFn,thisArg,arrayLike[i],i):arrayLike[i];if(Context){desc.value=value;defineProperty(arr,i,desc)}else{arr[i]=value}}}if(Context){desc.value=null;arr.length=length}return arr}},{"../../function/is-arguments":17,"../../function/is-function":18,"../../number/to-pos-integer":24,"../../object/is-value":32,"../../object/valid-callable":42,"../../object/valid-value":43,"../../string/is-string":47,"es6-symbol":48}],16:[function(require,module,exports){"use strict";module.exports=function(value){return value}},{}],17:[function(require,module,exports){"use strict";var objToString=Object.prototype.toString,id=objToString.call(function(){return arguments}());module.exports=function(value){return objToString.call(value)===id}},{}],18:[function(require,module,exports){"use strict";var objToString=Object.prototype.toString,isFunctionStringTag=RegExp.prototype.test.bind(/^[object [A-Za-z0-9]*Function]$/);module.exports=function(value){return typeof value==="function"&&isFunctionStringTag(objToString.call(value))}},{}],19:[function(require,module,exports){"use strict";module.exports=function(){}},{}],20:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?Math.sign:require("./shim")},{"./is-implemented":21,"./shim":22}],21:[function(require,module,exports){"use strict";module.exports=function(){var sign=Math.sign;if(typeof sign!=="function")return false;return sign(10)===1&&sign(-20)===-1}},{}],22:[function(require,module,exports){"use strict";module.exports=function(value){value=Number(value);if(isNaN(value)||value===0)return value;return value>0?1:-1}},{}],23:[function(require,module,exports){"use strict";var sign=require("../math/sign"),abs=Math.abs,floor=Math.floor;module.exports=function(value){if(isNaN(value))return 0;value=Number(value);if(value===0||!isFinite(value))return value;return sign(value)*floor(abs(value))}},{"../math/sign":20}],24:[function(require,module,exports){"use strict";var toInteger=require("./to-integer"),max=Math.max;module.exports=function(value){return max(0,toInteger(value))}},{"./to-integer":23}],25:[function(require,module,exports){"use strict";var callable=require("./valid-callable"),value=require("./valid-value"),bind=Function.prototype.bind,call=Function.prototype.call,keys=Object.keys,objPropertyIsEnumerable=Object.prototype.propertyIsEnumerable;module.exports=function(method,defVal){return function(obj,cb){var list,thisArg=arguments[2],compareFn=arguments[3];obj=Object(value(obj));callable(cb);list=keys(obj);if(compareFn){list.sort(typeof compareFn==="function"?bind.call(compareFn,obj):undefined)}if(typeof method!=="function")method=list[method];return call.call(method,list,(function(key,index){if(!objPropertyIsEnumerable.call(obj,key))return defVal;return call.call(cb,thisArg,obj[key],key,obj,index)}))}}},{"./valid-callable":42,"./valid-value":43}],26:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?Object.assign:require("./shim")},{"./is-implemented":27,"./shim":28}],27:[function(require,module,exports){"use strict";module.exports=function(){var assign=Object.assign,obj;if(typeof assign!=="function")return false;obj={foo:"raz"};assign(obj,{bar:"dwa"},{trzy:"trzy"});return obj.foo+obj.bar+obj.trzy==="razdwatrzy"}},{}],28:[function(require,module,exports){"use strict";var keys=require("../keys"),value=require("../valid-value"),max=Math.max;module.exports=function(dest,src){var error,i,length=max(arguments.length,2),assign;dest=Object(value(dest));assign=function(key){try{dest[key]=src[key]}catch(e){if(!error)error=e}};for(i=1;i<length;++i){src=arguments[i];keys(src).forEach(assign)}if(error!==undefined)throw error;return dest}},{"../keys":33,"../valid-value":43}],29:[function(require,module,exports){"use strict";var create=Object.create,shim;if(!require("./set-prototype-of/is-implemented")()){shim=require("./set-prototype-of/shim")}module.exports=function(){var nullObject,polyProps,desc;if(!shim)return create;if(shim.level!==1)return create;nullObject={};polyProps={};desc={configurable:false,enumerable:false,writable:true,value:undefined};Object.getOwnPropertyNames(Object.prototype).forEach((function(name){if(name==="__proto__"){polyProps[name]={configurable:true,enumerable:false,writable:true,value:undefined};return}polyProps[name]=desc}));Object.defineProperties(nullObject,polyProps);Object.defineProperty(shim,"nullPolyfill",{configurable:false,enumerable:false,writable:false,value:nullObject});return function(prototype,props){return create(prototype===null?nullObject:prototype,props)}}()},{"./set-prototype-of/is-implemented":39,"./set-prototype-of/shim":40}],30:[function(require,module,exports){"use strict";module.exports=require("./_iterate")("forEach")},{"./_iterate":25}],31:[function(require,module,exports){"use strict";var isValue=require("./is-value");var map={function:true,object:true};module.exports=function(value){return isValue(value)&&map[typeof value]||false}},{"./is-value":32}],32:[function(require,module,exports){"use strict";var _undefined=require("../function/noop")();module.exports=function(val){return val!==_undefined&&val!==null}},{"../function/noop":19}],33:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?Object.keys:require("./shim")},{"./is-implemented":34,"./shim":35}],34:[function(require,module,exports){"use strict";module.exports=function(){try{Object.keys("primitive");return true}catch(e){return false}}},{}],35:[function(require,module,exports){"use strict";var isValue=require("../is-value");var keys=Object.keys;module.exports=function(object){return keys(isValue(object)?Object(object):object)}},{"../is-value":32}],36:[function(require,module,exports){"use strict";var callable=require("./valid-callable"),forEach=require("./for-each"),call=Function.prototype.call;module.exports=function(obj,cb){var result={},thisArg=arguments[2];callable(cb);forEach(obj,(function(value,key,targetObj,index){result[key]=call.call(cb,thisArg,value,key,targetObj,index)}));return result}},{"./for-each":30,"./valid-callable":42}],37:[function(require,module,exports){"use strict";var isValue=require("./is-value");var forEach=Array.prototype.forEach,create=Object.create;var process=function(src,obj){var key;for(key in src)obj[key]=src[key]};module.exports=function(opts1){var result=create(null);forEach.call(arguments,(function(options){if(!isValue(options))return;process(Object(options),result)}));return result}},{"./is-value":32}],38:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?Object.setPrototypeOf:require("./shim")},{"./is-implemented":39,"./shim":40}],39:[function(require,module,exports){"use strict";var create=Object.create,getPrototypeOf=Object.getPrototypeOf,plainObject={};module.exports=function(){var setPrototypeOf=Object.setPrototypeOf,customCreate=arguments[0]||create;if(typeof setPrototypeOf!=="function")return false;return getPrototypeOf(setPrototypeOf(customCreate(null),plainObject))===plainObject}},{}],40:[function(require,module,exports){"use strict";var isObject=require("../is-object"),value=require("../valid-value"),objIsPrototypeOf=Object.prototype.isPrototypeOf,defineProperty=Object.defineProperty,nullDesc={configurable:true,enumerable:false,writable:true,value:undefined},validate;validate=function(obj,prototype){value(obj);if(prototype===null||isObject(prototype))return obj;throw new TypeError("Prototype must be null or an object")};module.exports=function(status){var fn,set;if(!status)return null;if(status.level===2){if(status.set){set=status.set;fn=function(obj,prototype){set.call(validate(obj,prototype),prototype);return obj}}else{fn=function(obj,prototype){validate(obj,prototype).__proto__=prototype;return obj}}}else{fn=function self(obj,prototype){var isNullBase;validate(obj,prototype);isNullBase=objIsPrototypeOf.call(self.nullPolyfill,obj);if(isNullBase)delete self.nullPolyfill.__proto__;if(prototype===null)prototype=self.nullPolyfill;obj.__proto__=prototype;if(isNullBase)defineProperty(self.nullPolyfill,"__proto__",nullDesc);return obj}}return Object.defineProperty(fn,"level",{configurable:false,enumerable:false,writable:false,value:status.level})}(function(){var tmpObj1=Object.create(null),tmpObj2={},set,desc=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__");if(desc){try{set=desc.set;set.call(tmpObj1,tmpObj2)}catch(ignore){}if(Object.getPrototypeOf(tmpObj1)===tmpObj2)return{set:set,level:2}}tmpObj1.__proto__=tmpObj2;if(Object.getPrototypeOf(tmpObj1)===tmpObj2)return{level:2};tmpObj1={};tmpObj1.__proto__=tmpObj2;if(Object.getPrototypeOf(tmpObj1)===tmpObj2)return{level:1};return false}());require("../create")},{"../create":29,"../is-object":31,"../valid-value":43}],41:[function(require,module,exports){"use strict";var callable=require("./valid-callable"),isValue=require("./is-value"),forEach=require("./for-each"),call=Function.prototype.call,defaultCb=function(value,key){return[key,value]};module.exports=function(obj){var a=[],cb=arguments[1],thisArg=arguments[2];cb=isValue(cb)?callable(cb):defaultCb;forEach(obj,(function(value,key,targetObj,index){a.push(call.call(cb,thisArg,value,key,this,index))}),obj,arguments[3]);return a}},{"./for-each":30,"./is-value":32,"./valid-callable":42}],42:[function(require,module,exports){"use strict";module.exports=function(fn){if(typeof fn!=="function")throw new TypeError(fn+" is not a function");return fn}},{}],43:[function(require,module,exports){"use strict";var isValue=require("./is-value");module.exports=function(value){if(!isValue(value))throw new TypeError("Cannot use null or undefined");return value}},{"./is-value":32}],44:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?String.prototype.contains:require("./shim")},{"./is-implemented":45,"./shim":46}],45:[function(require,module,exports){"use strict";var str="razdwatrzy";module.exports=function(){if(typeof str.contains!=="function")return false;return str.contains("dwa")===true&&str.contains("foo")===false}},{}],46:[function(require,module,exports){"use strict";var indexOf=String.prototype.indexOf;module.exports=function(searchString){return indexOf.call(this,searchString,arguments[1])>-1}},{}],47:[function(require,module,exports){"use strict";var objToString=Object.prototype.toString,id=objToString.call("");module.exports=function(value){return typeof value==="string"||value&&typeof value==="object"&&(value instanceof String||objToString.call(value)===id)||false}},{}],48:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?require("ext/global-this").Symbol:require("./polyfill")},{"./is-implemented":49,"./polyfill":54,"ext/global-this":58}],49:[function(require,module,exports){"use strict";var global=require("ext/global-this"),validTypes={object:true,symbol:true};module.exports=function(){var Symbol=global.Symbol;var symbol;if(typeof Symbol!=="function")return false;symbol=Symbol("test symbol");try{String(symbol)}catch(e){return false}if(!validTypes[typeof Symbol.iterator])return false;if(!validTypes[typeof Symbol.toPrimitive])return false;if(!validTypes[typeof Symbol.toStringTag])return false;return true}},{"ext/global-this":58}],50:[function(require,module,exports){"use strict";module.exports=function(value){if(!value)return false;if(typeof value==="symbol")return true;if(!value.constructor)return false;if(value.constructor.name!=="Symbol")return false;return value[value.constructor.toStringTag]==="Symbol"}},{}],51:[function(require,module,exports){"use strict";var d=require("d");var create=Object.create,defineProperty=Object.defineProperty,objPrototype=Object.prototype;var created=create(null);module.exports=function(desc){var postfix=0,name,ie11BugWorkaround;while(created[desc+(postfix||"")])++postfix;desc+=postfix||"";created[desc]=true;name="@@"+desc;defineProperty(objPrototype,name,d.gs(null,(function(value){if(ie11BugWorkaround)return;ie11BugWorkaround=true;defineProperty(this,name,d(value));ie11BugWorkaround=false})));return name}},{d:1}],52:[function(require,module,exports){"use strict";var d=require("d"),NativeSymbol=require("ext/global-this").Symbol;module.exports=function(SymbolPolyfill){return Object.defineProperties(SymbolPolyfill,{hasInstance:d("",NativeSymbol&&NativeSymbol.hasInstance||SymbolPolyfill("hasInstance")),isConcatSpreadable:d("",NativeSymbol&&NativeSymbol.isConcatSpreadable||SymbolPolyfill("isConcatSpreadable")),iterator:d("",NativeSymbol&&NativeSymbol.iterator||SymbolPolyfill("iterator")),match:d("",NativeSymbol&&NativeSymbol.match||SymbolPolyfill("match")),replace:d("",NativeSymbol&&NativeSymbol.replace||SymbolPolyfill("replace")),search:d("",NativeSymbol&&NativeSymbol.search||SymbolPolyfill("search")),species:d("",NativeSymbol&&NativeSymbol.species||SymbolPolyfill("species")),split:d("",NativeSymbol&&NativeSymbol.split||SymbolPolyfill("split")),toPrimitive:d("",NativeSymbol&&NativeSymbol.toPrimitive||SymbolPolyfill("toPrimitive")),toStringTag:d("",NativeSymbol&&NativeSymbol.toStringTag||SymbolPolyfill("toStringTag")),unscopables:d("",NativeSymbol&&NativeSymbol.unscopables||SymbolPolyfill("unscopables"))})}},{d:1,"ext/global-this":58}],53:[function(require,module,exports){"use strict";var d=require("d"),validateSymbol=require("../../../validate-symbol");var registry=Object.create(null);module.exports=function(SymbolPolyfill){return Object.defineProperties(SymbolPolyfill,{for:d((function(key){if(registry[key])return registry[key];return registry[key]=SymbolPolyfill(String(key))})),keyFor:d((function(symbol){var key;validateSymbol(symbol);for(key in registry){if(registry[key]===symbol)return key}return undefined}))})}},{"../../../validate-symbol":55,d:1}],54:[function(require,module,exports){"use strict";var d=require("d"),validateSymbol=require("./validate-symbol"),NativeSymbol=require("ext/global-this").Symbol,generateName=require("./lib/private/generate-name"),setupStandardSymbols=require("./lib/private/setup/standard-symbols"),setupSymbolRegistry=require("./lib/private/setup/symbol-registry");var create=Object.create,defineProperties=Object.defineProperties,defineProperty=Object.defineProperty;var SymbolPolyfill,HiddenSymbol,isNativeSafe;if(typeof NativeSymbol==="function"){try{String(NativeSymbol());isNativeSafe=true}catch(ignore){}}else{NativeSymbol=null}HiddenSymbol=function Symbol(description){if(this instanceof HiddenSymbol)throw new TypeError("Symbol is not a constructor");return SymbolPolyfill(description)};module.exports=SymbolPolyfill=function Symbol(description){var symbol;if(this instanceof Symbol)throw new TypeError("Symbol is not a constructor");if(isNativeSafe)return NativeSymbol(description);symbol=create(HiddenSymbol.prototype);description=description===undefined?"":String(description);return defineProperties(symbol,{__description__:d("",description),__name__:d("",generateName(description))})};setupStandardSymbols(SymbolPolyfill);setupSymbolRegistry(SymbolPolyfill);defineProperties(HiddenSymbol.prototype,{constructor:d(SymbolPolyfill),toString:d("",(function(){return this.__name__}))});defineProperties(SymbolPolyfill.prototype,{toString:d((function(){return"Symbol ("+validateSymbol(this).__description__+")"})),valueOf:d((function(){return validateSymbol(this)}))});defineProperty(SymbolPolyfill.prototype,SymbolPolyfill.toPrimitive,d("",(function(){var symbol=validateSymbol(this);if(typeof symbol==="symbol")return symbol;return symbol.toString()})));defineProperty(SymbolPolyfill.prototype,SymbolPolyfill.toStringTag,d("c","Symbol"));defineProperty(HiddenSymbol.prototype,SymbolPolyfill.toStringTag,d("c",SymbolPolyfill.prototype[SymbolPolyfill.toStringTag]));defineProperty(HiddenSymbol.prototype,SymbolPolyfill.toPrimitive,d("c",SymbolPolyfill.prototype[SymbolPolyfill.toPrimitive]))},{"./lib/private/generate-name":51,"./lib/private/setup/standard-symbols":52,"./lib/private/setup/symbol-registry":53,"./validate-symbol":55,d:1,"ext/global-this":58}],55:[function(require,module,exports){"use strict";var isSymbol=require("./is-symbol");module.exports=function(value){if(!isSymbol(value))throw new TypeError(value+" is not a symbol");return value}},{"./is-symbol":50}],56:[function(require,module,exports){"use strict";var d=require("d"),callable=require("es5-ext/object/valid-callable"),apply=Function.prototype.apply,call=Function.prototype.call,create=Object.create,defineProperty=Object.defineProperty,defineProperties=Object.defineProperties,hasOwnProperty=Object.prototype.hasOwnProperty,descriptor={configurable:true,enumerable:false,writable:true},on,once,off,emit,methods,descriptors,base;on=function(type,listener){var data;callable(listener);if(!hasOwnProperty.call(this,"__ee__")){data=descriptor.value=create(null);defineProperty(this,"__ee__",descriptor);descriptor.value=null}else{data=this.__ee__}if(!data[type])data[type]=listener;else if(typeof data[type]==="object")data[type].push(listener);else data[type]=[data[type],listener];return this};once=function(type,listener){var once,self;callable(listener);self=this;on.call(this,type,once=function(){off.call(self,type,once);apply.call(listener,this,arguments)});once.__eeOnceListener__=listener;return this};off=function(type,listener){var data,listeners,candidate,i;callable(listener);if(!hasOwnProperty.call(this,"__ee__"))return this;data=this.__ee__;if(!data[type])return this;listeners=data[type];if(typeof listeners==="object"){for(i=0;candidate=listeners[i];++i){if(candidate===listener||candidate.__eeOnceListener__===listener){if(listeners.length===2)data[type]=listeners[i?0:1];else listeners.splice(i,1)}}}else{if(listeners===listener||listeners.__eeOnceListener__===listener){delete data[type]}}return this};emit=function(type){var i,l,listener,listeners,args;if(!hasOwnProperty.call(this,"__ee__"))return;listeners=this.__ee__[type];if(!listeners)return;if(typeof listeners==="object"){l=arguments.length;args=new Array(l-1);for(i=1;i<l;++i)args[i-1]=arguments[i];listeners=listeners.slice();for(i=0;listener=listeners[i];++i){apply.call(listener,this,args)}}else{switch(arguments.length){case 1:call.call(listeners,this);break;case 2:call.call(listeners,this,arguments[1]);break;case 3:call.call(listeners,this,arguments[1],arguments[2]);break;default:l=arguments.length;args=new Array(l-1);for(i=1;i<l;++i){args[i-1]=arguments[i]}apply.call(listeners,this,args)}}};methods={on:on,once:once,off:off,emit:emit};descriptors={on:d(on),once:d(once),off:d(off),emit:d(emit)};base=defineProperties({},descriptors);module.exports=exports=function(o){return o==null?create(base):defineProperties(Object(o),descriptors)};exports.methods=methods},{d:1,"es5-ext/object/valid-callable":42}],57:[function(require,module,exports){var naiveFallback=function(){if(typeof self==="object"&&self)return self;if(typeof window==="object"&&window)return window;throw new Error("Unable to resolve global `this`")};module.exports=function(){if(this)return this;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:true})}catch(error){return naiveFallback()}try{if(!__global__)return naiveFallback();return __global__}finally{delete Object.prototype.__global__}}()},{}],58:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?globalThis:require("./implementation")},{"./implementation":57,"./is-implemented":59}],59:[function(require,module,exports){"use strict";module.exports=function(){if(typeof globalThis!=="object")return false;if(!globalThis)return false;return globalThis.Array===Array}},{}],60:[function(require,module,exports){"use strict";var loggerPrototype=require("./lib/private/logger-prototype");module.exports=loggerPrototype._createLevel("info")},{"./lib/private/logger-prototype":65}],61:[function(require,module,exports){module.exports=["error","warning","notice","info","debug"]},{}],62:[function(require,module,exports){"use strict";var uniGlobal=require("uni-global")("medikoo/log/202110");if(uniGlobal.emitter){module.exports=uniGlobal.emitter;return}var ee=require("event-emitter");module.exports=uniGlobal.emitter=ee()},{"event-emitter":56,"uni-global":76}],63:[function(require,module,exports){"use strict";module.exports=RegExp.prototype.test.bind(/^[a-z0-9-]+$/)},{}],64:[function(require,module,exports){"use strict";var noop=require("es5-ext/function/noop"),objForEach=require("es5-ext/object/for-each"),d=require("d");module.exports={isEnabled:d("ew",true),enable:d((function(){return this._setEnabledState(true)})),disable:d((function(){return this._setEnabledState(false)})),_setEnabledState:d((function(state){var cache=[];this._setEnabledStateRecursively(state,cache);var result={restore:function(){cache.forEach((function(data){if(data.hasDirectSetting)data.logger.isEnabled=!state;else delete data.logger.isEnabled}));result.restore=noop}};return result})),_setEnabledStateRecursively:d((function(newState,cache){if(this.isEnabled!==newState){cache.push({logger:this,hasDirectSetting:hasOwnProperty.call(this,"isEnabled")});this.isEnabled=newState}objForEach(this._childNamespaceLoggers,(function(namespacedLogger){namespacedLogger._setEnabledStateRecursively(newState,cache)}))}))}},{d:1,"es5-ext/function/noop":19,"es5-ext/object/for-each":30}],65:[function(require,module,exports){"use strict";var ensureString=require("type/string/ensure"),aFrom=require("es5-ext/array/from"),assign=require("es5-ext/object/assign"),setPrototypeOf=require("es5-ext/object/set-prototype-of"),d=require("d"),lazy=require("d/lazy"),levelNames=require("../../../levels"),emitter=require("../../emitter"),enableDisableProps=require("./enable-disable-props"),namespaceProps=require("./namespace-props");var levelLoggers=Object.create(null);var loggerPrototype=Object.create(Function.prototype,assign({isLevelInitialized:d("e",(function(level){level=ensureString(level);if(this.level===level)return true;var logger=levelLoggers[level];if(!logger)return false;if(!this.namespace)return true;return logger.isNamespaceInitialized(this.namespace)})),getAllInitializedLevels:d("e",(function(){return Object.keys(levelLoggers).filter((function(level){return this.isLevelInitialized(level)}),this).map((function(level){return this._getLevelLogger(level)}),this)})),_createLogger:d((function(){return setPrototypeOf((function self(msgItemIgnored){emitter.emit("log",{logger:self,messageTokens:aFrom(arguments)})}),this)})),_createLevel:d((function(levelName){if(levelLoggers[levelName])return levelLoggers[levelName];var logger=loggerPrototype._createLogger();Object.defineProperties(logger,{level:d("e",levelName),levelIndex:d("e",levelNames.indexOf(levelName)),levelRoot:d("e",logger)});levelLoggers[levelName]=logger;emitter.emit("init",{logger:logger});return logger})),_getLevelLogger:d((function(newLevel){if(this.level===newLevel)return this;var levelLogger=this._createLevel(newLevel);return this.namespaceTokens.reduce((function(currentLogger,token){return currentLogger._createNamespace(token)}),levelLogger)}))},lazy(assign(levelNames.reduce((function(descriptors,level){descriptors[level]=d("e",(function(){return this._getLevelLogger(level)}),{cacheName:"_"+level});return descriptors}),{}),{warn:d((function(){return this._getLevelLogger("warning")}),{cacheName:"_warning"})})),namespaceProps,enableDisableProps));module.exports=loggerPrototype},{"../../../levels":61,"../../emitter":62,"./enable-disable-props":64,"./namespace-props":66,d:1,"d/lazy":2,"es5-ext/array/from":13,"es5-ext/object/assign":26,"es5-ext/object/set-prototype-of":38,"type/string/ensure":73}],66:[function(require,module,exports){"use strict";var ensureString=require("type/string/ensure"),toShortString=require("type/lib/to-short-string"),identity=require("es5-ext/function/identity"),assign=require("es5-ext/object/assign"),objToArray=require("es5-ext/object/to-array"),d=require("d"),lazy=require("d/lazy"),emitter=require("../../emitter"),isNamespaceToken=require("../is-namespace-token");module.exports=assign({get:d((function(namespace){namespace=ensureString(namespace);var namespaceTokens=namespace.split(":");namespaceTokens.forEach((function(namespaceToken){if(!isNamespaceToken(namespaceToken)){throw new TypeError(toShortString(namespace)+" is not a valid namespace string "+"(only 'a-z0-9-' chars are allowed and ':' as delimiter)")}}));return namespaceTokens.reduce((function(currentLogger,token){return currentLogger._createNamespace(token)}),this)})),isNamespaceInitialized:d("e",(function(namespace){var namespaceTokens=ensureString(namespace).split(":");var currentLogger=this;return namespaceTokens.every((function(nsToken){return currentLogger=currentLogger._childNamespaceLoggers[nsToken]}))})),getAllInitializedNamespaces:d("e",(function(){return objToArray(this._childNamespaceLoggers,identity)})),_createNamespace:d((function(namespaceToken){if(this._childNamespaceLoggers[namespaceToken]){return this._childNamespaceLoggers[namespaceToken]}var logger=Object.defineProperties(this._createLogger(),{_namespaceToken:d("",namespaceToken)});this._childNamespaceLoggers[namespaceToken]=logger;emitter.emit("init",{logger:logger});return logger})),_namespaceToken:d("",null)},lazy({namespace:d("e",(function(){return this.namespaceTokens.join(":")||null}),{cacheName:"_namespace"}),namespaceTokens:d("e",(function(){return this._namespaceToken?Object.getPrototypeOf(this).namespaceTokens.concat(this._namespaceToken):[]}),{cacheName:"_namespaceTokens"}),_childNamespaceLoggers:d("",(function(){return Object.create(null)}),{cacheName:"__childNamespaceLoggers"})}))},{"../../emitter":62,"../is-namespace-token":63,d:1,"d/lazy":2,"es5-ext/function/identity":16,"es5-ext/object/assign":26,"es5-ext/object/to-array":41,"type/lib/to-short-string":70,"type/string/ensure":73}],67:[function(require,module,exports){"use strict";var stringCoerce=require("../string/coerce"),toShortString=require("./to-short-string");module.exports=function(errorMessage,value,inputOptions){if(inputOptions&&inputOptions.errorMessage){errorMessage=stringCoerce(inputOptions.errorMessage)}var valueInsertIndex=errorMessage.indexOf("%v");var valueToken=valueInsertIndex>-1?toShortString(value):null;if(inputOptions&&inputOptions.name){var nameInsertIndex=errorMessage.indexOf("%n");if(nameInsertIndex>-1){if(valueInsertIndex>-1){var firstToken,secondToken,firstInsertIndex,secondInsertIndex;if(nameInsertIndex>valueInsertIndex){firstToken=valueToken;firstInsertIndex=valueInsertIndex;secondToken=inputOptions.name;secondInsertIndex=nameInsertIndex}else{firstToken=inputOptions.name;firstInsertIndex=nameInsertIndex;secondToken=valueToken;secondInsertIndex=valueInsertIndex}return errorMessage.slice(0,firstInsertIndex)+firstToken+errorMessage.slice(firstInsertIndex+2,secondInsertIndex)+secondToken+errorMessage.slice(secondInsertIndex+2)}return errorMessage.slice(0,nameInsertIndex)+inputOptions.name+errorMessage.slice(nameInsertIndex+2)}}if(valueInsertIndex>-1){return errorMessage.slice(0,valueInsertIndex)+valueToken+errorMessage.slice(valueInsertIndex+2)}return errorMessage}},{"../string/coerce":72,"./to-short-string":70}],68:[function(require,module,exports){"use strict";var isValue=require("../value/is"),resolveErrorMessage=require("./resolve-error-message");module.exports=function(value,defaultMessage,inputOptions){if(inputOptions&&!isValue(value)){if("default"in inputOptions)return inputOptions["default"];if(inputOptions.isOptional)return null}var ErrorConstructor=inputOptions&&inputOptions.Error||TypeError;var error=new ErrorConstructor(resolveErrorMessage(defaultMessage,value,inputOptions));if(inputOptions&&inputOptions.errorCode)error.code=inputOptions.errorCode;throw error}},{"../value/is":74,"./resolve-error-message":67}],69:[function(require,module,exports){arguments[4][5][0].apply(exports,arguments)},{dup:5}],70:[function(require,module,exports){arguments[4][6][0].apply(exports,arguments)},{"./safe-to-string":69,dup:6}],71:[function(require,module,exports){arguments[4][7][0].apply(exports,arguments)},{"../value/is":74,dup:7}],72:[function(require,module,exports){arguments[4][10][0].apply(exports,arguments)},{"../object/is":71,"../value/is":74,dup:10}],73:[function(require,module,exports){"use strict";var resolveException=require("../lib/resolve-exception"),coerce=require("./coerce");module.exports=function(value){var coerced=coerce(value);if(coerced!==null)return coerced;var options=arguments[1];var errorMessage=options&&options.name?"Expected a string for %n, received %v":"%v is not a string";return resolveException(value,errorMessage,options)}},{"../lib/resolve-exception":68,"./coerce":72}],74:[function(require,module,exports){arguments[4][12][0].apply(exports,arguments)},{dup:12}],75:[function(require,module,exports){(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define("underscore",factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,function(){var current=global._;var exports=global._=factory();exports.noConflict=function(){global._=current;return exports}}())})(this,(function(){var VERSION="1.13.6";var root=typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global||Function("return this")()||{};var ArrayProto=Array.prototype,ObjProto=Object.prototype;var SymbolProto=typeof Symbol!=="undefined"?Symbol.prototype:null;var push=ArrayProto.push,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var supportsArrayBuffer=typeof ArrayBuffer!=="undefined",supportsDataView=typeof DataView!=="undefined";var nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeCreate=Object.create,nativeIsView=supportsArrayBuffer&&ArrayBuffer.isView;var _isNaN=isNaN,_isFinite=isFinite;var hasEnumBug=!{toString:null}.propertyIsEnumerable("toString");var nonEnumerableProps=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];var MAX_ARRAY_INDEX=Math.pow(2,53)-1;function restArguments(func,startIndex){startIndex=startIndex==null?func.length-1:+startIndex;return function(){var length=Math.max(arguments.length-startIndex,0),rest=Array(length),index=0;for(;index<length;index++){rest[index]=arguments[index+startIndex]}switch(startIndex){case 0:return func.call(this,rest);case 1:return func.call(this,arguments[0],rest);case 2:return func.call(this,arguments[0],arguments[1],rest)}var args=Array(startIndex+1);for(index=0;index<startIndex;index++){args[index]=arguments[index]}args[startIndex]=rest;return func.apply(this,args)}}function isObject(obj){var type=typeof obj;return type==="function"||type==="object"&&!!obj}function isNull(obj){return obj===null}function isUndefined(obj){return obj===void 0}function isBoolean(obj){return obj===true||obj===false||toString.call(obj)==="[object Boolean]"}function isElement(obj){return!!(obj&&obj.nodeType===1)}function tagTester(name){var tag="[object "+name+"]";return function(obj){return toString.call(obj)===tag}}var isString=tagTester("String");var isNumber=tagTester("Number");var isDate=tagTester("Date");var isRegExp=tagTester("RegExp");var isError=tagTester("Error");var isSymbol=tagTester("Symbol");var isArrayBuffer=tagTester("ArrayBuffer");var isFunction=tagTester("Function");var nodelist=root.document&&root.document.childNodes;if(typeof/./!="function"&&typeof Int8Array!="object"&&typeof nodelist!="function"){isFunction=function(obj){return typeof obj=="function"||false}}var isFunction$1=isFunction;var hasObjectTag=tagTester("Object");var hasStringTagBug=supportsDataView&&hasObjectTag(new DataView(new ArrayBuffer(8))),isIE11=typeof Map!=="undefined"&&hasObjectTag(new Map);var isDataView=tagTester("DataView");function ie10IsDataView(obj){return obj!=null&&isFunction$1(obj.getInt8)&&isArrayBuffer(obj.buffer)}var isDataView$1=hasStringTagBug?ie10IsDataView:isDataView;var isArray=nativeIsArray||tagTester("Array");function has$1(obj,key){return obj!=null&&hasOwnProperty.call(obj,key)}var isArguments=tagTester("Arguments");(function(){if(!isArguments(arguments)){isArguments=function(obj){return has$1(obj,"callee")}}})();var isArguments$1=isArguments;function isFinite$1(obj){return!isSymbol(obj)&&_isFinite(obj)&&!isNaN(parseFloat(obj))}function isNaN$1(obj){return isNumber(obj)&&_isNaN(obj)}function constant(value){return function(){return value}}function createSizePropertyCheck(getSizeProperty){return function(collection){var sizeProperty=getSizeProperty(collection);return typeof sizeProperty=="number"&&sizeProperty>=0&&sizeProperty<=MAX_ARRAY_INDEX}}function shallowProperty(key){return function(obj){return obj==null?void 0:obj[key]}}var getByteLength=shallowProperty("byteLength");var isBufferLike=createSizePropertyCheck(getByteLength);var typedArrayPattern=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;function isTypedArray(obj){return nativeIsView?nativeIsView(obj)&&!isDataView$1(obj):isBufferLike(obj)&&typedArrayPattern.test(toString.call(obj))}var isTypedArray$1=supportsArrayBuffer?isTypedArray:constant(false);var getLength=shallowProperty("length");function emulatedSet(keys){var hash={};for(var l=keys.length,i=0;i<l;++i)hash[keys[i]]=true;return{contains:function(key){return hash[key]===true},push:function(key){hash[key]=true;return keys.push(key)}}}function collectNonEnumProps(obj,keys){keys=emulatedSet(keys);var nonEnumIdx=nonEnumerableProps.length;var constructor=obj.constructor;var proto=isFunction$1(constructor)&&constructor.prototype||ObjProto;var prop="constructor";if(has$1(obj,prop)&&!keys.contains(prop))keys.push(prop);while(nonEnumIdx--){prop=nonEnumerableProps[nonEnumIdx];if(prop in obj&&obj[prop]!==proto[prop]&&!keys.contains(prop)){keys.push(prop)}}}function keys(obj){if(!isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)if(has$1(obj,key))keys.push(key);if(hasEnumBug)collectNonEnumProps(obj,keys);return keys}function isEmpty(obj){if(obj==null)return true;var length=getLength(obj);if(typeof length=="number"&&(isArray(obj)||isString(obj)||isArguments$1(obj)))return length===0;return getLength(keys(obj))===0}function isMatch(object,attrs){var _keys=keys(attrs),length=_keys.length;if(object==null)return!length;var obj=Object(object);for(var i=0;i<length;i++){var key=_keys[i];if(attrs[key]!==obj[key]||!(key in obj))return false}return true}function _$1(obj){if(obj instanceof _$1)return obj;if(!(this instanceof _$1))return new _$1(obj);this._wrapped=obj}_$1.VERSION=VERSION;_$1.prototype.value=function(){return this._wrapped};_$1.prototype.valueOf=_$1.prototype.toJSON=_$1.prototype.value;_$1.prototype.toString=function(){return String(this._wrapped)};function toBufferView(bufferSource){return new Uint8Array(bufferSource.buffer||bufferSource,bufferSource.byteOffset||0,getByteLength(bufferSource))}var tagDataView="[object DataView]";function eq(a,b,aStack,bStack){if(a===b)return a!==0||1/a===1/b;if(a==null||b==null)return false;if(a!==a)return b!==b;var type=typeof a;if(type!=="function"&&type!=="object"&&typeof b!="object")return false;return deepEq(a,b,aStack,bStack)}function deepEq(a,b,aStack,bStack){if(a instanceof _$1)a=a._wrapped;if(b instanceof _$1)b=b._wrapped;var className=toString.call(a);if(className!==toString.call(b))return false;if(hasStringTagBug&&className=="[object Object]"&&isDataView$1(a)){if(!isDataView$1(b))return false;className=tagDataView}switch(className){case"[object RegExp]":case"[object String]":return""+a===""+b;case"[object Number]":if(+a!==+a)return+b!==+b;return+a===0?1/+a===1/b:+a===+b;case"[object Date]":case"[object Boolean]":return+a===+b;case"[object Symbol]":return SymbolProto.valueOf.call(a)===SymbolProto.valueOf.call(b);case"[object ArrayBuffer]":case tagDataView:return deepEq(toBufferView(a),toBufferView(b),aStack,bStack)}var areArrays=className==="[object Array]";if(!areArrays&&isTypedArray$1(a)){var byteLength=getByteLength(a);if(byteLength!==getByteLength(b))return false;if(a.buffer===b.buffer&&a.byteOffset===b.byteOffset)return true;areArrays=true}if(!areArrays){if(typeof a!="object"||typeof b!="object")return false;var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(isFunction$1(aCtor)&&aCtor instanceof aCtor&&isFunction$1(bCtor)&&bCtor instanceof bCtor)&&("constructor"in a&&"constructor"in b)){return false}}aStack=aStack||[];bStack=bStack||[];var length=aStack.length;while(length--){if(aStack[length]===a)return bStack[length]===b}aStack.push(a);bStack.push(b);if(areArrays){length=a.length;if(length!==b.length)return false;while(length--){if(!eq(a[length],b[length],aStack,bStack))return false}}else{var _keys=keys(a),key;length=_keys.length;if(keys(b).length!==length)return false;while(length--){key=_keys[length];if(!(has$1(b,key)&&eq(a[key],b[key],aStack,bStack)))return false}}aStack.pop();bStack.pop();return true}function isEqual(a,b){return eq(a,b)}function allKeys(obj){if(!isObject(obj))return[];var keys=[];for(var key in obj)keys.push(key);if(hasEnumBug)collectNonEnumProps(obj,keys);return keys}function ie11fingerprint(methods){var length=getLength(methods);return function(obj){if(obj==null)return false;var keys=allKeys(obj);if(getLength(keys))return false;for(var i=0;i<length;i++){if(!isFunction$1(obj[methods[i]]))return false}return methods!==weakMapMethods||!isFunction$1(obj[forEachName])}}var forEachName="forEach",hasName="has",commonInit=["clear","delete"],mapTail=["get",hasName,"set"];var mapMethods=commonInit.concat(forEachName,mapTail),weakMapMethods=commonInit.concat(mapTail),setMethods=["add"].concat(commonInit,forEachName,hasName);var isMap=isIE11?ie11fingerprint(mapMethods):tagTester("Map");var isWeakMap=isIE11?ie11fingerprint(weakMapMethods):tagTester("WeakMap");var isSet=isIE11?ie11fingerprint(setMethods):tagTester("Set");var isWeakSet=tagTester("WeakSet");function values(obj){var _keys=keys(obj);var length=_keys.length;var values=Array(length);for(var i=0;i<length;i++){values[i]=obj[_keys[i]]}return values}function pairs(obj){var _keys=keys(obj);var length=_keys.length;var pairs=Array(length);for(var i=0;i<length;i++){pairs[i]=[_keys[i],obj[_keys[i]]]}return pairs}function invert(obj){var result={};var _keys=keys(obj);for(var i=0,length=_keys.length;i<length;i++){result[obj[_keys[i]]]=_keys[i]}return result}function functions(obj){var names=[];for(var key in obj){if(isFunction$1(obj[key]))names.push(key)}return names.sort()}function createAssigner(keysFunc,defaults){return function(obj){var length=arguments.length;if(defaults)obj=Object(obj);if(length<2||obj==null)return obj;for(var index=1;index<length;index++){var source=arguments[index],keys=keysFunc(source),l=keys.length;for(var i=0;i<l;i++){var key=keys[i];if(!defaults||obj[key]===void 0)obj[key]=source[key]}}return obj}}var extend=createAssigner(allKeys);var extendOwn=createAssigner(keys);var defaults=createAssigner(allKeys,true);function ctor(){return function(){}}function baseCreate(prototype){if(!isObject(prototype))return{};if(nativeCreate)return nativeCreate(prototype);var Ctor=ctor();Ctor.prototype=prototype;var result=new Ctor;Ctor.prototype=null;return result}function create(prototype,props){var result=baseCreate(prototype);if(props)extendOwn(result,props);return result}function clone(obj){if(!isObject(obj))return obj;return isArray(obj)?obj.slice():extend({},obj)}function tap(obj,interceptor){interceptor(obj);return obj}function toPath$1(path){return isArray(path)?path:[path]}_$1.toPath=toPath$1;function toPath(path){return _$1.toPath(path)}function deepGet(obj,path){var length=path.length;for(var i=0;i<length;i++){if(obj==null)return void 0;obj=obj[path[i]]}return length?obj:void 0}function get(object,path,defaultValue){var value=deepGet(object,toPath(path));return isUndefined(value)?defaultValue:value}function has(obj,path){path=toPath(path);var length=path.length;for(var i=0;i<length;i++){var key=path[i];if(!has$1(obj,key))return false;obj=obj[key]}return!!length}function identity(value){return value}function matcher(attrs){attrs=extendOwn({},attrs);return function(obj){return isMatch(obj,attrs)}}function property(path){path=toPath(path);return function(obj){return deepGet(obj,path)}}function optimizeCb(func,context,argCount){if(context===void 0)return func;switch(argCount==null?3:argCount){case 1:return function(value){return func.call(context,value)};case 3:return function(value,index,collection){return func.call(context,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(context,accumulator,value,index,collection)}}return function(){return func.apply(context,arguments)}}function baseIteratee(value,context,argCount){if(value==null)return identity;if(isFunction$1(value))return optimizeCb(value,context,argCount);if(isObject(value)&&!isArray(value))return matcher(value);return property(value)}function iteratee(value,context){return baseIteratee(value,context,Infinity)}_$1.iteratee=iteratee;function cb(value,context,argCount){if(_$1.iteratee!==iteratee)return _$1.iteratee(value,context);return baseIteratee(value,context,argCount)}function mapObject(obj,iteratee,context){iteratee=cb(iteratee,context);var _keys=keys(obj),length=_keys.length,results={};for(var index=0;index<length;index++){var currentKey=_keys[index];results[currentKey]=iteratee(obj[currentKey],currentKey,obj)}return results}function noop(){}function propertyOf(obj){if(obj==null)return noop;return function(path){return get(obj,path)}}function times(n,iteratee,context){var accum=Array(Math.max(0,n));iteratee=optimizeCb(iteratee,context,1);for(var i=0;i<n;i++)accum[i]=iteratee(i);return accum}function random(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))}var now=Date.now||function(){return(new Date).getTime()};function createEscaper(map){var escaper=function(match){return map[match]};var source="(?:"+keys(map).join("|")+")";var testRegexp=RegExp(source);var replaceRegexp=RegExp(source,"g");return function(string){string=string==null?"":""+string;return testRegexp.test(string)?string.replace(replaceRegexp,escaper):string}}var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};var _escape=createEscaper(escapeMap);var unescapeMap=invert(escapeMap);var _unescape=createEscaper(unescapeMap);var templateSettings=_$1.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"};var escapeRegExp=/\\|'|\r|\n|\u2028|\u2029/g;function escapeChar(match){return"\\"+escapes[match]}var bareIdentifier=/^\s*(\w|\$)+\s*$/;function template(text,settings,oldSettings){if(!settings&&oldSettings)settings=oldSettings;settings=defaults({},settings,_$1.templateSettings);var matcher=RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,(function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escapeRegExp,escapeChar);index=offset+match.length;if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}else if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}else if(evaluate){source+="';\n"+evaluate+"\n__p+='"}return match}));source+="';\n";var argument=settings.variable;if(argument){if(!bareIdentifier.test(argument))throw new Error("variable is not a bare identifier: "+argument)}else{source="with(obj||{}){\n"+source+"}\n";argument="obj"}source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";var render;try{render=new Function(argument,"_",source)}catch(e){e.source=source;throw e}var template=function(data){return render.call(this,data,_$1)};template.source="function("+argument+"){\n"+source+"}";return template}function result(obj,path,fallback){path=toPath(path);var length=path.length;if(!length){return isFunction$1(fallback)?fallback.call(obj):fallback}for(var i=0;i<length;i++){var prop=obj==null?void 0:obj[path[i]];if(prop===void 0){prop=fallback;i=length}obj=isFunction$1(prop)?prop.call(obj):prop}return obj}var idCounter=0;function uniqueId(prefix){var id=++idCounter+"";return prefix?prefix+id:id}function chain(obj){var instance=_$1(obj);instance._chain=true;return instance}function executeBound(sourceFunc,boundFunc,context,callingContext,args){if(!(callingContext instanceof boundFunc))return sourceFunc.apply(context,args);var self=baseCreate(sourceFunc.prototype);var result=sourceFunc.apply(self,args);if(isObject(result))return result;return self}var partial=restArguments((function(func,boundArgs){var placeholder=partial.placeholder;var bound=function(){var position=0,length=boundArgs.length;var args=Array(length);for(var i=0;i<length;i++){args[i]=boundArgs[i]===placeholder?arguments[position++]:boundArgs[i]}while(position<arguments.length)args.push(arguments[position++]);return executeBound(func,bound,this,this,args)};return bound}));partial.placeholder=_$1;var bind=restArguments((function(func,context,args){if(!isFunction$1(func))throw new TypeError("Bind must be called on a function");var bound=restArguments((function(callArgs){return executeBound(func,bound,context,this,args.concat(callArgs))}));return bound}));var isArrayLike=createSizePropertyCheck(getLength);function flatten$1(input,depth,strict,output){output=output||[];if(!depth&&depth!==0){depth=Infinity}else if(depth<=0){return output.concat(input)}var idx=output.length;for(var i=0,length=getLength(input);i<length;i++){var value=input[i];if(isArrayLike(value)&&(isArray(value)||isArguments$1(value))){if(depth>1){flatten$1(value,depth-1,strict,output);idx=output.length}else{var j=0,len=value.length;while(j<len)output[idx++]=value[j++]}}else if(!strict){output[idx++]=value}}return output}var bindAll=restArguments((function(obj,keys){keys=flatten$1(keys,false,false);var index=keys.length;if(index<1)throw new Error("bindAll must be passed function names");while(index--){var key=keys[index];obj[key]=bind(obj[key],obj)}return obj}));function memoize(func,hasher){var memoize=function(key){var cache=memoize.cache;var address=""+(hasher?hasher.apply(this,arguments):key);if(!has$1(cache,address))cache[address]=func.apply(this,arguments);return cache[address]};memoize.cache={};return memoize}var delay=restArguments((function(func,wait,args){return setTimeout((function(){return func.apply(null,args)}),wait)}));var defer=partial(delay,_$1,1);function throttle(func,wait,options){var timeout,context,args,result;var previous=0;if(!options)options={};var later=function(){previous=options.leading===false?0:now();timeout=null;result=func.apply(context,args);if(!timeout)context=args=null};var throttled=function(){var _now=now();if(!previous&&options.leading===false)previous=_now;var remaining=wait-(_now-previous);context=this;args=arguments;if(remaining<=0||remaining>wait){if(timeout){clearTimeout(timeout);timeout=null}previous=_now;result=func.apply(context,args);if(!timeout)context=args=null}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result};throttled.cancel=function(){clearTimeout(timeout);previous=0;timeout=context=args=null};return throttled}function debounce(func,wait,immediate){var timeout,previous,args,result,context;var later=function(){var passed=now()-previous;if(wait>passed){timeout=setTimeout(later,wait-passed)}else{timeout=null;if(!immediate)result=func.apply(context,args);if(!timeout)args=context=null}};var debounced=restArguments((function(_args){context=this;args=_args;previous=now();if(!timeout){timeout=setTimeout(later,wait);if(immediate)result=func.apply(context,args)}return result}));debounced.cancel=function(){clearTimeout(timeout);timeout=args=context=null};return debounced}function wrap(func,wrapper){return partial(wrapper,func)}function negate(predicate){return function(){return!predicate.apply(this,arguments)}}function compose(){var args=arguments;var start=args.length-1;return function(){var i=start;var result=args[start].apply(this,arguments);while(i--)result=args[i].call(this,result);return result}}function after(times,func){return function(){if(--times<1){return func.apply(this,arguments)}}}function before(times,func){var memo;return function(){if(--times>0){memo=func.apply(this,arguments)}if(times<=1)func=null;return memo}}var once=partial(before,2);function findKey(obj,predicate,context){predicate=cb(predicate,context);var _keys=keys(obj),key;for(var i=0,length=_keys.length;i<length;i++){key=_keys[i];if(predicate(obj[key],key,obj))return key}}function createPredicateIndexFinder(dir){return function(array,predicate,context){predicate=cb(predicate,context);var length=getLength(array);var index=dir>0?0:length-1;for(;index>=0&&index<length;index+=dir){if(predicate(array[index],index,array))return index}return-1}}var findIndex=createPredicateIndexFinder(1);var findLastIndex=createPredicateIndexFinder(-1);function sortedIndex(array,obj,iteratee,context){iteratee=cb(iteratee,context,1);var value=iteratee(obj);var low=0,high=getLength(array);while(low<high){var mid=Math.floor((low+high)/2);if(iteratee(array[mid])<value)low=mid+1;else high=mid}return low}function createIndexFinder(dir,predicateFind,sortedIndex){return function(array,item,idx){var i=0,length=getLength(array);if(typeof idx=="number"){if(dir>0){i=idx>=0?idx:Math.max(idx+length,i)}else{length=idx>=0?Math.min(idx+1,length):idx+length+1}}else if(sortedIndex&&idx&&length){idx=sortedIndex(array,item);return array[idx]===item?idx:-1}if(item!==item){idx=predicateFind(slice.call(array,i,length),isNaN$1);return idx>=0?idx+i:-1}for(idx=dir>0?i:length-1;idx>=0&&idx<length;idx+=dir){if(array[idx]===item)return idx}return-1}}var indexOf=createIndexFinder(1,findIndex,sortedIndex);var lastIndexOf=createIndexFinder(-1,findLastIndex);function find(obj,predicate,context){var keyFinder=isArrayLike(obj)?findIndex:findKey;var key=keyFinder(obj,predicate,context);if(key!==void 0&&key!==-1)return obj[key]}function findWhere(obj,attrs){return find(obj,matcher(attrs))}function each(obj,iteratee,context){iteratee=optimizeCb(iteratee,context);var i,length;if(isArrayLike(obj)){for(i=0,length=obj.length;i<length;i++){iteratee(obj[i],i,obj)}}else{var _keys=keys(obj);for(i=0,length=_keys.length;i<length;i++){iteratee(obj[_keys[i]],_keys[i],obj)}}return obj}function map(obj,iteratee,context){iteratee=cb(iteratee,context);var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length,results=Array(length);for(var index=0;index<length;index++){var currentKey=_keys?_keys[index]:index;results[index]=iteratee(obj[currentKey],currentKey,obj)}return results}function createReduce(dir){var reducer=function(obj,iteratee,memo,initial){var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length,index=dir>0?0:length-1;if(!initial){memo=obj[_keys?_keys[index]:index];index+=dir}for(;index>=0&&index<length;index+=dir){var currentKey=_keys?_keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo};return function(obj,iteratee,memo,context){var initial=arguments.length>=3;return reducer(obj,optimizeCb(iteratee,context,4),memo,initial)}}var reduce=createReduce(1);var reduceRight=createReduce(-1);function filter(obj,predicate,context){var results=[];predicate=cb(predicate,context);each(obj,(function(value,index,list){if(predicate(value,index,list))results.push(value)}));return results}function reject(obj,predicate,context){return filter(obj,negate(cb(predicate)),context)}function every(obj,predicate,context){predicate=cb(predicate,context);var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length;for(var index=0;index<length;index++){var currentKey=_keys?_keys[index]:index;if(!predicate(obj[currentKey],currentKey,obj))return false}return true}function some(obj,predicate,context){predicate=cb(predicate,context);var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length;for(var index=0;index<length;index++){var currentKey=_keys?_keys[index]:index;if(predicate(obj[currentKey],currentKey,obj))return true}return false}function contains(obj,item,fromIndex,guard){if(!isArrayLike(obj))obj=values(obj);if(typeof fromIndex!="number"||guard)fromIndex=0;return indexOf(obj,item,fromIndex)>=0}var invoke=restArguments((function(obj,path,args){var contextPath,func;if(isFunction$1(path)){func=path}else{path=toPath(path);contextPath=path.slice(0,-1);path=path[path.length-1]}return map(obj,(function(context){var method=func;if(!method){if(contextPath&&contextPath.length){context=deepGet(context,contextPath)}if(context==null)return void 0;method=context[path]}return method==null?method:method.apply(context,args)}))}));function pluck(obj,key){return map(obj,property(key))}function where(obj,attrs){return filter(obj,matcher(attrs))}function max(obj,iteratee,context){var result=-Infinity,lastComputed=-Infinity,value,computed;if(iteratee==null||typeof iteratee=="number"&&typeof obj[0]!="object"&&obj!=null){obj=isArrayLike(obj)?obj:values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value!=null&&value>result){result=value}}}else{iteratee=cb(iteratee,context);each(obj,(function(v,index,list){computed=iteratee(v,index,list);if(computed>lastComputed||computed===-Infinity&&result===-Infinity){result=v;lastComputed=computed}}))}return result}function min(obj,iteratee,context){var result=Infinity,lastComputed=Infinity,value,computed;if(iteratee==null||typeof iteratee=="number"&&typeof obj[0]!="object"&&obj!=null){obj=isArrayLike(obj)?obj:values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value!=null&&value<result){result=value}}}else{iteratee=cb(iteratee,context);each(obj,(function(v,index,list){computed=iteratee(v,index,list);if(computed<lastComputed||computed===Infinity&&result===Infinity){result=v;lastComputed=computed}}))}return result}var reStrSymbol=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function toArray(obj){if(!obj)return[];if(isArray(obj))return slice.call(obj);if(isString(obj)){return obj.match(reStrSymbol)}if(isArrayLike(obj))return map(obj,identity);return values(obj)}function sample(obj,n,guard){if(n==null||guard){if(!isArrayLike(obj))obj=values(obj);return obj[random(obj.length-1)]}var sample=toArray(obj);var length=getLength(sample);n=Math.max(Math.min(n,length),0);var last=length-1;for(var index=0;index<n;index++){var rand=random(index,last);var temp=sample[index];sample[index]=sample[rand];sample[rand]=temp}return sample.slice(0,n)}function shuffle(obj){return sample(obj,Infinity)}function sortBy(obj,iteratee,context){var index=0;iteratee=cb(iteratee,context);return pluck(map(obj,(function(value,key,list){return{value:value,index:index++,criteria:iteratee(value,key,list)}})).sort((function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index-right.index})),"value")}function group(behavior,partition){return function(obj,iteratee,context){var result=partition?[[],[]]:{};iteratee=cb(iteratee,context);each(obj,(function(value,index){var key=iteratee(value,index,obj);behavior(result,value,key)}));return result}}var groupBy=group((function(result,value,key){if(has$1(result,key))result[key].push(value);else result[key]=[value]}));var indexBy=group((function(result,value,key){result[key]=value}));var countBy=group((function(result,value,key){if(has$1(result,key))result[key]++;else result[key]=1}));var partition=group((function(result,value,pass){result[pass?0:1].push(value)}),true);function size(obj){if(obj==null)return 0;return isArrayLike(obj)?obj.length:keys(obj).length}function keyInObj(value,key,obj){return key in obj}var pick=restArguments((function(obj,keys){var result={},iteratee=keys[0];if(obj==null)return result;if(isFunction$1(iteratee)){if(keys.length>1)iteratee=optimizeCb(iteratee,keys[1]);keys=allKeys(obj)}else{iteratee=keyInObj;keys=flatten$1(keys,false,false);obj=Object(obj)}for(var i=0,length=keys.length;i<length;i++){var key=keys[i];var value=obj[key];if(iteratee(value,key,obj))result[key]=value}return result}));var omit=restArguments((function(obj,keys){var iteratee=keys[0],context;if(isFunction$1(iteratee)){iteratee=negate(iteratee);if(keys.length>1)context=keys[1]}else{keys=map(flatten$1(keys,false,false),String);iteratee=function(value,key){return!contains(keys,key)}}return pick(obj,iteratee,context)}));function initial(array,n,guard){return slice.call(array,0,Math.max(0,array.length-(n==null||guard?1:n)))}function first(array,n,guard){if(array==null||array.length<1)return n==null||guard?void 0:[];if(n==null||guard)return array[0];return initial(array,array.length-n)}function rest(array,n,guard){return slice.call(array,n==null||guard?1:n)}function last(array,n,guard){if(array==null||array.length<1)return n==null||guard?void 0:[];if(n==null||guard)return array[array.length-1];return rest(array,Math.max(0,array.length-n))}function compact(array){return filter(array,Boolean)}function flatten(array,depth){return flatten$1(array,depth,false)}var difference=restArguments((function(array,rest){rest=flatten$1(rest,true,true);return filter(array,(function(value){return!contains(rest,value)}))}));var without=restArguments((function(array,otherArrays){return difference(array,otherArrays)}));function uniq(array,isSorted,iteratee,context){if(!isBoolean(isSorted)){context=iteratee;iteratee=isSorted;isSorted=false}if(iteratee!=null)iteratee=cb(iteratee,context);var result=[];var seen=[];for(var i=0,length=getLength(array);i<length;i++){var value=array[i],computed=iteratee?iteratee(value,i,array):value;if(isSorted&&!iteratee){if(!i||seen!==computed)result.push(value);seen=computed}else if(iteratee){if(!contains(seen,computed)){seen.push(computed);result.push(value)}}else if(!contains(result,value)){result.push(value)}}return result}var union=restArguments((function(arrays){return uniq(flatten$1(arrays,true,true))}));function intersection(array){var result=[];var argsLength=arguments.length;for(var i=0,length=getLength(array);i<length;i++){var item=array[i];if(contains(result,item))continue;var j;for(j=1;j<argsLength;j++){if(!contains(arguments[j],item))break}if(j===argsLength)result.push(item)}return result}function unzip(array){var length=array&&max(array,getLength).length||0;var result=Array(length);for(var index=0;index<length;index++){result[index]=pluck(array,index)}return result}var zip=restArguments(unzip);function object(list,values){var result={};for(var i=0,length=getLength(list);i<length;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result}function range(start,stop,step){if(stop==null){stop=start||0;start=0}if(!step){step=stop<start?-1:1}var length=Math.max(Math.ceil((stop-start)/step),0);var range=Array(length);for(var idx=0;idx<length;idx++,start+=step){range[idx]=start}return range}function chunk(array,count){if(count==null||count<1)return[];var result=[];var i=0,length=array.length;while(i<length){result.push(slice.call(array,i,i+=count))}return result}function chainResult(instance,obj){return instance._chain?_$1(obj).chain():obj}function mixin(obj){each(functions(obj),(function(name){var func=_$1[name]=obj[name];_$1.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return chainResult(this,func.apply(_$1,args))}}));return _$1}each(["pop","push","reverse","shift","sort","splice","unshift"],(function(name){var method=ArrayProto[name];_$1.prototype[name]=function(){var obj=this._wrapped;if(obj!=null){method.apply(obj,arguments);if((name==="shift"||name==="splice")&&obj.length===0){delete obj[0]}}return chainResult(this,obj)}}));each(["concat","join","slice"],(function(name){var method=ArrayProto[name];_$1.prototype[name]=function(){var obj=this._wrapped;if(obj!=null)obj=method.apply(obj,arguments);return chainResult(this,obj)}}));var allExports={__proto__:null,VERSION:VERSION,restArguments:restArguments,isObject:isObject,isNull:isNull,isUndefined:isUndefined,isBoolean:isBoolean,isElement:isElement,isString:isString,isNumber:isNumber,isDate:isDate,isRegExp:isRegExp,isError:isError,isSymbol:isSymbol,isArrayBuffer:isArrayBuffer,isDataView:isDataView$1,isArray:isArray,isFunction:isFunction$1,isArguments:isArguments$1,isFinite:isFinite$1,isNaN:isNaN$1,isTypedArray:isTypedArray$1,isEmpty:isEmpty,isMatch:isMatch,isEqual:isEqual,isMap:isMap,isWeakMap:isWeakMap,isSet:isSet,isWeakSet:isWeakSet,keys:keys,allKeys:allKeys,values:values,pairs:pairs,invert:invert,functions:functions,methods:functions,extend:extend,extendOwn:extendOwn,assign:extendOwn,defaults:defaults,create:create,clone:clone,tap:tap,get:get,has:has,mapObject:mapObject,identity:identity,constant:constant,noop:noop,toPath:toPath$1,property:property,propertyOf:propertyOf,matcher:matcher,matches:matcher,times:times,random:random,now:now,escape:_escape,unescape:_unescape,templateSettings:templateSettings,template:template,result:result,uniqueId:uniqueId,chain:chain,iteratee:iteratee,partial:partial,bind:bind,bindAll:bindAll,memoize:memoize,delay:delay,defer:defer,throttle:throttle,debounce:debounce,wrap:wrap,negate:negate,compose:compose,after:after,before:before,once:once,findKey:findKey,findIndex:findIndex,findLastIndex:findLastIndex,sortedIndex:sortedIndex,indexOf:indexOf,lastIndexOf:lastIndexOf,find:find,detect:find,findWhere:findWhere,each:each,forEach:each,map:map,collect:map,reduce:reduce,foldl:reduce,inject:reduce,reduceRight:reduceRight,foldr:reduceRight,filter:filter,select:filter,reject:reject,every:every,all:every,some:some,any:some,contains:contains,includes:contains,include:contains,invoke:invoke,pluck:pluck,where:where,max:max,min:min,shuffle:shuffle,sample:sample,sortBy:sortBy,groupBy:groupBy,indexBy:indexBy,countBy:countBy,partition:partition,toArray:toArray,size:size,pick:pick,omit:omit,first:first,head:first,take:first,initial:initial,last:last,rest:rest,tail:rest,drop:rest,compact:compact,flatten:flatten,without:without,uniq:uniq,unique:uniq,union:union,intersection:intersection,difference:difference,unzip:unzip,transpose:unzip,zip:zip,object:object,range:range,chunk:chunk,mixin:mixin,default:_$1};var _=mixin(allExports);_._=_;return _}))},{}],76:[function(require,module,exports){"use strict";var ensureString=require("type/string/ensure"),uniGlobal=require("./lib/uni-global");var objHasOwnProperty=Object.prototype.hasOwnProperty;module.exports=function(key){key=ensureString(key,{name:"key"});if(objHasOwnProperty.call(uniGlobal,key))return uniGlobal[key];var value=Object.create?Object.create(null):{};uniGlobal[key]=value;return value}},{"./lib/uni-global":78,"type/string/ensure":73}],77:[function(require,module,exports){"use strict";if(!Object.defineProperty||!Object.create)module.exports="3";else if(typeof Symbol==="function"&&Symbol["for"])module.exports="2015+";else module.exports="5"},{}],78:[function(require,module,exports){"use strict";var esEnvType=require("./es-env-type");switch(esEnvType){case"3":if(EvalError.$ug202109){module.exports=EvalError.$ug202109;return}module.exports=EvalError.$ug202109={};return;case"5":if(EvalError.$uniGlobal202109){module.exports=EvalError.$uniGlobal202109;return}Object.defineProperty(EvalError,"$uniGlobal202109",{value:module.exports=Object.create(null)});return;case"2015+":var uniGlobalSymbol=Symbol["for"]("$uniGlobal202109");if(EvalError[uniGlobalSymbol]){module.exports=EvalError[uniGlobalSymbol];return}Object.defineProperty(EvalError,uniGlobalSymbol,{value:module.exports=Object.create(null)});return;default:throw new Error("Unrecognized environment type: "+esEnvType)}},{"./es-env-type":77}],79:[function(require,module,exports){var _=require("underscore"),AppearancesJson=require("../shared/data/appearance.json");var AppearanceData=[];var ItemGearTypes={weapon:[],weaponarcher:[],armor:[],armorarcher:[]};_.each(AppearancesJson,(function(value,key){AppearanceData.push({name:value.name,type:value.type,sprite:value.sprite,buy:value.buy});if(ItemGearTypes[value.type]){ItemGearTypes[value.type].push({key:key,val:value})}}));module.exports.ItemGearTypes=ItemGearTypes;module.exports.Data=AppearanceData},{"../shared/data/appearance.json":150,underscore:75}],80:[function(require,module,exports){var cls=require("./lib/class");var _=require("underscore");var Utils=require("./utils");var Messages=require("./message");var MobData=require("./mobdata");module.exports=Area=cls.Class.extend({init:function(id,x,y,width,height,map,elipse,excludeId){this.id=id;var ts=G_TILESIZE;this.gx=x;this.gy=y;this.x=x*ts;this.y=y*ts;if(elipse){this.x+this.width/2;this.y+this.height/2}this.width=width*ts;this.height=height*ts;this.map=map;this.entities=[];this.hasCompletelyRespawned=true;this.elipse=elipse||false;this.excludeId=excludeId},_getRandomPositionInsideArea:function(threshold){var pos={};var valid=false;var count=0;while(count<=threshold){if(!this.elipse){pos.x=this.x+Utils.randomInt(this.width);pos.y=this.y+Utils.randomInt(this.height)}else{var a=Math.random()*2*Math.PI;var r=Math.floor(this.width/2*Math.sqrt(Math.random()));pos.x=Math.round(this.x+r*Math.cos(a));pos.y=Math.round(this.y+r*Math.sin(a))}if(!this.containsReal(pos.x,pos.y,0)){count++;continue}if(this.map.isColliding(pos.x,pos.y)){count++;continue}else{break}count++}if(count>threshold){console.error("_getRandomPositionInsideArea:"+pos.x+","+pos.y);process.exit(1);return null}return pos},containsReal:function(x,y,iteration){var tw=this.width;var th=this.height;if(!this.elipse){return x>=this.x&&y>=this.y&&x<this.x+tw&&y<this.y+th}else{var cx=this.x;var cy=this.y;var d=Math.sqrt(Math.pow(x-cx,2)+Math.pow(y-cy,2));var inElipse=d<tw/2;if(iteration==1||this.excludeId==-1){return inElipse}else if(iteration==0){var prevArea=this.map.mobArea[this.excludeId];return inElipse&&!prevArea.containsReal(x,y,1)}return false}},contains:function(x,y,iteration){if(!this.elipse){return x>=this.x&&y>=this.y&&x<this.x+this.width&&y<this.y+this.height}else{var cx=this.x;var cy=this.y;var d=Math.sqrt(Math.pow(x-cx,2)+Math.pow(y-cy,2));var inElipse=d<this.width/2;if(iteration==1||this.excludeId==-1){return inElipse}else if(iteration==0){var prevArea=this.map.mobArea[this.excludeId];return inElipse&&!prevArea.contains(x,y,1)}return false}},removeFromArea:function(entity){var i=_.indexOf(_.pluck(this.entities,"id"),entity.id);this.entities.splice(i,1);if(this.isEmpty()&&this.hasCompletelyRespawned&&this.emptyCallback){this.hasCompletelyRespawned=false;this.emptyCallback()}},addToArea:function(entity){if(entity&&entity.kind!==null){this.entities.push(entity);entity.area=this}if(this.isFull()){this.hasCompletelyRespawned=true}},setNumberOfEntities:function(nb){this.nbEntities=nb},isEmpty:function(){return!_.any(this.entities,(function(entity){return!entity.isDead}))},isFull:function(){return!this.isEmpty()&&this.nbEntities===_.size(this.entities)},onEmpty:function(callback){this.emptyCallback=callback},respawn:function(entity,delay){var self=this;delay=entity.spawnDelay||delay;this.removeFromArea(entity);setTimeout((function(){var pos=self.map.entities.spaceEntityRandomApart(2,self._getRandomPositionInsideArea.bind(self,20));var x=pos.x,y=pos.y;entity.spawnX=entity.x=x;entity.spawnY=entity.y=y;entity.respawn()}),delay)}});module.exports=Area},{"./lib/class":105,"./message":112,"./mobdata":118,"./utils":146,underscore:75}],81:[function(require,module,exports){var cls=require("./lib/class"),ItemRoom=require("./itemroom"),Messages=require("./message"),ItemTypes=require("../shared/js/itemtypes"),Types=require("../shared/js/gametypes");module.exports=AuctionRecord=cls.Class.extend({init:function(playerName,price,item){this.playerName=playerName;this.price=price;this.item=item},save:function(index){var cols=[this.playerName,this.price];return cols.join(",")+","+this.item.save()},toArray:function(index){var cols=[parseInt(index),this.playerName,this.price];cols=cols.concat(this.item.toArray());return cols}});module.exports=Auction=cls.Class.extend({init:function(){this.auctions={};this.load()},load:function(){var self=this;console.info("AUCTION LOAD");databaseHandler.loadAuctions(self,self.onLoad)},onLoad:function(self,auctions){if(auctions)self.auctions=auctions},save:function(){console.info("AUCTION SAVED");if(this.auctions)databaseHandler.saveAuctions(this.auctions)},add:function(player,item,price,invIndex){var count=0;if(this.auctions)count=Object.keys(this.auctions).length;this.auctions[count]=new AuctionRecord(player.name,price,item);player.inventory.setItem(invIndex,null);player.map.entities.pushToPlayer(player,new Messages.Notify("AUCTION","AUCTION_ADDED"))},remove:function(index){this.auctions[index]=null},list:function(player,type){var msg=[Types.Messages.SC_AUCTIONOPEN,type,0];var recCount=0;for(var i in this.auctions){var rec=this.auctions[i];if(!rec){continue}var kind=rec.item.itemKind;if(type===1&&ItemTypes.isArmor(kind)||type===2&&ItemTypes.isWeapon(kind)||type===0&&player.name===rec.playerName){msg=msg.concat(rec.toArray(i));++recCount}}msg[2]=recCount;player.map.entities.pushToPlayer(player,new Messages.AuctionOpen(msg))}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./itemroom":101,"./lib/class":105,"./message":112}],82:[function(require,module,exports){var cls=require("./lib/class"),ItemRoom=require("./itemroom"),Messages=require("./message"),ItemTypes=require("../shared/js/itemtypes"),Types=require("../shared/js/gametypes");module.exports=Bank=cls.Class.extend({init:function(owner,number,items){this.owner=owner;this.number=number;this.maxNumber=96;this.rooms={};console.info("number="+number);if(items){for(var i=0;i<items.length;i++){this.rooms[items[i].slot]=items[i]}}},hasItem:function(itemKind){return this.hasItems(itemKind,1)},hasItems:function(itemKind,itemCount){var a=0;for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind===itemKind){a+=this.rooms[i].itemNumber;if(a>=itemCount)return true}}return false},hasItemCount:function(itemKind){var a=0;for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind===itemKind){a+=this.rooms[i].itemNumber}}return a},makeEmptyItem:function(index){this.rooms[index]=null;delete this.rooms[index];this.setItem(index,null)},getItemCount:function(itemKind){for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind==itemKind){return this.rooms[i].itemNumber}}return 0},getItemIndex:function(itemKind){for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind==itemKind){return i}}return-1},getEmptyIndex:function(){for(var index=0;index<this.maxNumber;index++){if(!this.rooms[index]){return index}}return-1},putItem:function(item){var maxNumber=96;var consume=ItemTypes.isConsumableItem(item.itemKind);var loot=ItemTypes.isLootItem(item.itemKind);var craft=ItemTypes.isCraftItem(item.itemKind);if(consume||loot||craft){for(var i in this.rooms){var slot=this.combineItem(item,this.rooms[i]);if(slot>=0)return slot}}return this._putItem(item)},combineItem:function(item,item2){console.info(JSON.stringify(item));console.info(JSON.stringify(item2));if(!item||!item2)return-1;if(item.itemKind!=item2.itemKind)return-1;if(ItemTypes.isEquippable(item.itemKind)||ItemTypes.isEquippable(item2.itemKind)){return-1}var slot=item.slot;var slot2=item2.slot;if(item2.itemNumber<this.maxStack){item2.itemNumber+=item.itemNumber;if(item2.itemNumber>this.maxStack){item.itemNumber=item2.itemNumber-this.maxStack;item2.itemNumber=Math.min(item2.itemNumber,this.maxStack)}else{item=null}}if(item2.itemNumber<=0){item2=null}this.setItem(slot,item);this.setItem(slot2,item2);return slot2},_putItem:function(item){var i=0;i=this.getEmptyIndex(i,this.maxNumber);if(i<0){if(this.owner instanceof Player)this.owner.map.entities.pushToPlayer(this.owner,new Messages.Notify("BANK","BANK_FULL"));return-1}else{this.setItem(i,item);return i}},checkItem:function(index,item){return true},setItem:function(index,item){if(!item){item={slot:index,itemKind:-1};this.rooms[index]=null}else{if(!this.checkItem(index,item))return false;this.rooms[index]=item;item.slot=index}this.owner.map.entities.pushToPlayer(this.owner,new Messages.ItemSlot(1,[item]));return true},save:function(){databaseHandler.saveItems(this.owner,1,this.rooms)},takeOutItems:function(index,number){var item=this.rooms[index];if(!item)return null;if(number>item.itemNumber)return null;if(ItemTypes.isEquippable(item.itemKind)){this.setItem(index,null);return item}item.itemNumber-=number;if(item.itemNumber==0)item=null;this.setItem(index,item);return item},toString:function(){var i=0;var itemString=""+this.maxNumber+",";for(i=0;i<this.maxNumber;i++){var item=this.rooms[i];itemArray=[item.itemKind,item.itemNumber,item.itemDurability,item.itemDurabilityMax,item.itemExperience];itemString+=itemArray.join(",")}return itemString},toStringJSON:function(){var itemString="[";var isItems=false;for(var i=0;i<this.maxNumber;i++){var item=this.rooms[i];if(!item)continue;itemArray=[i,item.itemKind,item.itemNumber,item.itemDurability,item.itemDurabilityMax,item.itemExperience];itemString+="["+itemArray.join(",")+"],";isItems=true}itemString=itemString.slice(0,-1);itemString+="]";if(!isItems)return"[]";return itemString}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./itemroom":101,"./lib/class":105,"./message":112}],83:[function(require,module,exports){var cls=require("./lib/class"),EntityMoving=require("./entitymoving"),Types=require("../shared/js/gametypes");module.exports=Block=EntityMoving.extend({init:function(id,kind,x,y,map,parent,name,ix,iy){var type=this.type=Types.EntityTypes.BLOCK;this.parent=parent;this.ix=ix;this.iy=iy;this._super(id,type,kind,x,y,map);this.name=name;this.playerName=null},isCompleted:function(player){if(this.parent.isCompleted())this.parent.onComplete()},getState:function(){return this._getBaseState().concat([parseInt(this.ix),parseInt(this.iy)])},update:function(player){this.playerName=player.name;this.parent.update()}})},{"../shared/js/gametypes":167,"./entitymoving":92,"./lib/class":105}],84:[function(require,module,exports){var cls=require("./lib/class"),Area=require("./area.js"),Block=require("./block.js"),Utils=require("./utils"),Types=require("../shared/js/gametypes");module.exports=BlockArea=Area.extend({init:function(id,x,y,width,height,map,elipse){this._super(id,x,y,width,height,map,elipse);this.blocks=[];this.players={}},initArea:function(kind,width,height){var startID=this.map.entities.entityCount;var id=0;var blockName;for(var j=0;j<height;++j){for(var i=0;i<width;++i){id=startID+(width*j+i);blockName="block"+kind+"-"+j+"_"+i;var block=new Block(id,kind,this.x+i*G_TILESIZE,this.y+j*G_TILESIZE,this.map,this,blockName,i,j);this.map.entities.addBlock(block);this.blocks.push(block)}}this.map.entities.entityCount+=width*height},randomizeBlocks:function(distApart){var self=this;for(var i in this.blocks){var block=this.blocks[i];var pos=this.map.entities.spaceEntityRandomApart(distApart,self._getRandomPositionInsideArea.bind(self,30));if(pos){block.setPosition(~~Utils.floorTo(pos.x,G_TILESIZE),~~Utils.floorTo(pos.y,G_TILESIZE))}else{console.error("BlockArea - randomizeBlocks: failed.")}}},isCompleted:function(){var b1=this.blocks[0],b2=null;var b3=b1;var x=0;for(var i in this.blocks){b1=this.blocks[i];x=i%this.numX;if(b2){if(x===0){if(!(b1.y-b3.y===G_TILESIZE||b1.x-b3.x===0))return false;b3=b1}else{if(!(b2.x-b1.x===G_TILESIZE||b2.y-b1.y===0))return false}}b2=b1}return true},Completed:function(){console.warn("BLOCKAREA - COMPLETED.");for(var i in this.blocks){var block=this.blocks[i];if(!block.playerName)continue;if(this.players.hasOwnProperty(block.playerName))this.players[block.playerName]++;else{this.players[block.playerName]=1}}},onComplete:function(callback){this.complete_callback=callback},update:function(){if(this.isCompleted()){this.Completed();if(this.complete_callback&&Object.keys(this.players).length>0)this.complete_callback(this);for(var i in this.blocks){var block=this.blocks[i];this.map.entities.removeEntity(block);this.map.entities.pushBroadcast(block.despawn())}delete this}}})},{"../shared/js/gametypes":167,"./area.js":80,"./block.js":83,"./lib/class":105,"./utils":146}],85:[function(require,module,exports){var cls=require("./lib/class"),EntityMoving=require("./entitymoving"),Messages=require("./message"),Utils=require("./utils"),MobData=require("./mobdata"),NpcData=require("./npcdata"),Timer=require("./timer"),Types=require("../shared/js/gametypes"),Transition=require("./transition");module.exports=Character=EntityMoving.extend({init:function(id,type,kind,x,y,map){var self=this;this._super(id,type,kind,x,y,map);this.nextX=-1;this.nextY=-1;this.prevX=-1;this.prevY=-1;this.atkSpeed=100;this.moveSpeed=100;this.setMoveRate(this.moveSpeed);this.walkSpeed=150;this.idleSpeed=Utils.randomInt(750,1e3);this.setAttackRate(1024);this.target=null;this.unconfirmedTarget=null;this.attackers={};this.isDead=false;this.isDying=false;this.attackingMode=false;this.followingMode=false;this.engagingPC=false;this.observeTimer=new Timer(4096);this.step=0;this.orientation=this.setRandomOrientation();this.movement=new Transition;this.path=null;this.newDestination=null;this.adjacentTiles={};this.stats={};this.stats.hp=0;this.stats.hpMax=0;this.stats.ep=0;this.stats.epMax=0;this.attackCooldown=null;this.moveCooldown=null;this.attackerLevel=0;this.defenderLevel=0;this.moveLevel=0;this.armor=null;this.weapon=null;this.freeze=false;this.effects={};this.invincible=false;this.mod={accuracy:1,damage:1,defence:1,attack:1,attackTime:1,crit:1,dot:0,dr:0,time:0,daze:0,hate:0};this.neighboursUpdated=false},setMaxHpMax:function(hp){this.stats.hpMax=hp;this.stats.hp=hp},setAttackRange:function(range){this.attackRange=range*G_TILESIZE},setOrientation:function(orientation){if(orientation){this.orientation=orientation||0}},idle:function(orientation){this.setOrientation(orientation)},hit:function(orientation){this.setOrientation(orientation);this.stop()},walk:function(orientation){this.setOrientation(orientation)},moveTo_:function(x,y,callback){this.destination={x:x,y:y};this.adjacentTiles={};if(this.isMovingPath()){this.continueTo(x,y)}else{console.warn("requestPathfindingTo");var path=this.requestPathfindingTo(x,y);console.warn("requestPathfindingTo.path: "+JSON.stringify(path));if(path)this.followPath(path)}},requestPathfindingTo:function(x,y){if(Array.isArray(this.path)&&this.path.length>0){return this.path}else if(this.request_path_callback){return this.request_path_callback(x,y)}else{console.info(this.id+" couldn't request pathfinding to "+x+", "+y);console.info("char x:"+this.x+",y: "+this.y+", x:"+x+"y: "+y);try{throw new Error}catch(e){console.info(e.stack)}return null}},onRequestPath:function(callback){this.request_path_callback=callback},onStartPathing:function(callback){this.start_pathing_callback=callback},onStopPathing:function(callback){this.stop_pathing_callback=callback},onAbortPathing:function(callback){this.abort_pathing_callback=callback},followPath:function(path){if(!path)return;this.path=path;this.step=0;if(this.followingMode){path.pop()}if(this.start_pathing_callback){this.start_pathing_callback(path)}},continueTo:function(x,y){this.newDestination={x:x,y:y}},onAggro:function(callback){this.aggro_callback=callback},onCheckAggro:function(callback){this.checkaggro_callback=callback},checkAggro:function(){if(this.checkaggro_callback){this.checkaggro_callback()}},aggro:function(character){if(this.aggro_callback){this.aggro_callback(character)}},onDeath:function(callback){this.death_callback=callback},lookAt:function(target){if(target){this.orientation=this.getOrientationTo(target)}},go:function(x,y){if(this.isAttacking()){this.disengage()}else if(this.followingMode){this.followingMode=false;this.target=null}this.moveTo_(x,y)},follow:function(entity){var found=false;var spot=this.getClosestSpot(entity);if(spot&&spot.x&&spot.y)this.moveTo_(spot.x,spot.y)},getLastMove:function(){if(!this.path)return null;var lastPath=this.path[this.path.length-1];return[lastPath[0],lastPath[1]]},getClosestSpot:function(dest,adjDist){var d=adjDist||G_TILESIZE;var coords=[];var pos=[dest.x,dest.y];var x2=pos[0],y2=pos[1];var x=this.x,y=this.y;var poss=[[x2+d,y2],[x2-d,y2],[x2,y2+d],[x2,y2-d]];for(var p of poss){if(this.map.isColliding(p[0],p[1]))poss.splice(poss.indexOf(p),1)}if(!this.neighboursUpdated){this.closestNeighbours=this.map.entities.getCharactersAround({x:x,y:y},16);this.neighboursUpdated=true}var ts=G_TILESIZE;var tsh=ts>>1;for(var p of poss){var x=p[0];var y=p[1];for(var entity of this.closestNeighbours){if(!entity||this==entity)continue;var tx=entity.x;var ty=entity.y;if(entity.path&&entity.path.length>0){var tp=entity.getLastMove();if(tp){tx=tp[0];ty=tp[1];if(Math.abs(x-tx)<=tsh&&Math.abs(y-ty)<=tsh){poss.splice(poss.indexOf(p),1)}}}else if(Math.abs(x-tx)<=tsh&&Math.abs(y-ty)<=tsh){poss.splice(poss.indexOf(p),1)}}}if(poss.length==0)return null;for(var p of poss){var pc=[p[0],p[1]];coords.push({d:Utils.realDistance([x,y],pc),p:pc})}coords.sort((function(a,b){return a.d-b.d}));return{x:coords[0].p[0],y:coords[0].p[1]}},engage:function(character){this.attackingMode=true;this.setTarget(character)},disengage:function(){this.attackingMode=false;this.followingMode=false;this.removeTarget()},isAttacking:function(){return this.attackingMode},getOrientationTo:function(character){if(this.x<character.x){return Types.Orientations.RIGHT}else if(this.x>character.x){return Types.Orientations.LEFT}else if(this.y>character.y){return Types.Orientations.UP}else{return Types.Orientations.DOWN}},isAttackedBy:function(character){if(Object.keys(this.attackers).length==0){return false}return this.attackers.hasOwnProperty(character.id)&&this.attackers[character.id]===character},isAttacked:function(){return!(Object.keys(this.attackers).length==0)},addAttacker:function(character){if(!this.isAttackedBy(character)){this.attackers[character.id]=character}},removeAttacker:function(character){if(!this.isAttacked()){return}delete this.attackers[character.id]},removeAttackers:function(){this.attackers={}},clearAttackerRefs:function(){var self=this;this.forEachAttacker((function(c){c.removeAttacker(self)}))},forEachAttacker:function(callback){_.each(this.attackers,(function(attacker){callback(attacker)}))},stopInPath:function(x,y){if(this.isMovingPath()){if(this.map.entities.pathfinder.isInPath(this.path,[x,y])){this.setPosition(x,y);this.interrupted=true;this.forceStop()}}},stop:function(){if(this.isMovingPath()){this.interrupted=true;this.moving=false}},forceStop:function(){this.movement.stop();this.orientation=0;this.moveOrientation=0;if(this.isMovingPath()){if(this.interrupted&&this.abort_pathing_callback)this.abort_pathing_callback(this.x,this.y);this.interrupted=false;this.path=null;this.newDestination=null;this.isReadyToMove=true;this.followingMode=false}},forceStopMove:function(){console.info("character - forceStopMove - called");this.movement.stop();this.moveOrientation=0;this.freeze=false;if(this.movestop_callback)this.movestop_callback()},setMoveStopCallback:function(callback){this.movestop_callback=callback},removeTarget:function(){var self=this;if(this.target){if(this.target instanceof Character){this.target.removeAttacker(this)}if(this.removetarget_callback)this.removetarget_callback(this.target.id);this.target=null}},onRemoveTarget:function(callback){this.removetarget_callback=callback},hasTarget:function(){return!(this.target===null)},waitToAttack:function(character){this.unconfirmedTarget=character},isWaitingToAttack:function(character){return this.unconfirmedTarget===character},canAttack:function(){if(this.isDead==false&&this.attackCooldown.isOver()){return true}return false},canMove:function(){if(this.isDead==false&&this.moveCooldown.isOver()){return true}return false},onHasMoved:function(callback){this.hasmoved_callback=callback},hasMoved:function(){this.setDirty();if(this.hasmoved_callback){this.hasmoved_callback(this)}},hurt:function(){var self=this;this.stopHurting();this.sprite=this.hurtSprite;this.hurting=setTimeout(this.stopHurting.bind(this),75)},stopHurting:function(){this.sprite=this.normalSprite;clearTimeout(this.hurting)},setAttackRate:function(rate){this.attackCooldown=new Timer(rate)},setMoveRate:function(rate){this.moveSpeed=rate;this.walkSpeed=~~(rate/4);this.moveCooldown=new Timer(rate);this.tick=Math.round(1e3/this.moveSpeed)},getState:function(){return this._getBaseState()},modHealthBy:function(val){var hp=this.stats.hp,max=this.stats.hpMax;this.stats.hp=Utils.clamp(0,max,hp+val);return this.changePoints(val,0)},modEnergyBy:function(val){var ep=this.stats.ep,max=this.stats.epMax;this.stats.ep=Utils.clamp(0,max,ep+val);return this.changePoints(0,val)},hasFullHealth:function(){return this.stats.hp===this.stats.hpMax},hasFullEnergy:function(){return this.stats.ep===this.stats.epMax},clearTarget:function(){this.target=null},changePoints:function(modhp,modep){return new Messages.ChangePoints(this,modhp,modep)},setFreeze:function(ms,callback){var self=this;if(ms<=0){self.freeze=false;return}this.freeze=true;this.freeze_callback=setTimeout((function(){self.freeze=false;if(callback)callback(self)}),ms)},getPathIndex:function(step){if(!this.path===null||this.path.length===0)return null;if(step<0||step>=this.path.length)return null;return this.path[step]},isWithinPath:function(coords){var tCoords=null;if(typeof coords==="Object"&&coords.x>0&&coords.y>0){tCoords=[coords.x,coords.y]}else if(Array.isArray(coords)&&coords.length==2){tCoords=[coords[0],coords[1]]}if(!tCoords)return null;if(this.path===null||this.path.length===0)return null;var pathLen=this.path.length;for(var i=0;i<pathLen;++i){if(this.path[i][0]===tCoords[0]&&this.path[i][1]===tCoords[1])return{x:tCoords[0],y:tCoords[1],step:i}}return null},clean:function(){this.forEachAttacker((function(attacker){attacker.disengage();attacker.idle()}))},updateMovement:function(){var p=this.path,i=this.step;if(!p||i>p.length-1)return;if(this.x<p[i][0]){this.walk(Types.Orientations.RIGHT)}else if(this.x>p[i][0]){this.walk(Types.Orientations.LEFT)}else if(this.y<p[i][1]){this.walk(Types.Orientations.DOWN)}else if(this.y>p[i][1]){this.walk(Types.Orientations.UP)}else{this.idle()}},nextStepPath:function(){if(this.step==0){this.step++;this.updateMovement()}if(this.step<this.path.length){if(this.x==this.path[this.step][0]&&this.y==this.path[this.step][1]){this.step++;this.updateMovement();return true}return false}return false},nextStep:function(){var stop=false,res=false,path,x,y;if(!this.isMovingPath()||this.freeze){this.interrupted=true;stop=true}if(!stop){res=this.nextStepPath();if(this.step>=this.path.length){stop=true}if(this.step_callback){this.step_callback(this.x,this.y)}}if(this.hasChangedItsPath()){this.setPosition(this.x,this.y);x=this.newDestination.x;y=this.newDestination.y;path=this.requestPathfindingTo(x,y);this.newDestination=null;this.followPath(path);return true}if(stop){if(this.stop_pathing_callback){this.stop_pathing_callback(this.x,this.y);this.forceStop()}res=true}return res},onBeforeMove:function(callback){this.before_move_callback=callback},onBeforeStep:function(callback){this.before_step_callback=callback},onStep:function(callback){this.step_callback=callback},isMoving:function(){return this.movement.inProgress},isMovingPath:function(){return this.path&&this.path.length>0},hasNextStep:function(){return this.path&&this.path.length-1>this.step},hasChangedItsPath:function(){return!(this.newDestination===null)},isNear:function(character,distance){var dx,dy,near=false;dx=Math.abs(this.x-character.x);dy=Math.abs(this.y-character.y);if(dx<=distance*G_TILESIZE&&dy<=distance*G_TILESIZE){near=true}return near},onRemove:function(callback){this.remove_callback=callback},lookAtEntity:function(entity){if(entity){this.orientation=this.getOrientationTo(entity)}return this.orientation},lookAt:function(x,y){return this.getOrientationTo({x:x,y:y})},getOrientationTo:function(object){return this.getOrientation([this.x,this.y],[object.x,object.y])},getOrientation:function(p1,p2){var x=Math.abs(p1[0]-p2[0]);var y=Math.abs(p1[1]-p2[1]);if(x>y){if(p1[0]>p2[0])return Types.Orientations.LEFT;else return Types.Orientations.RIGHT}else if(y>x){if(p1[1]>p2[1])return Types.Orientations.UP;else return Types.Orientations.DOWN}return Types.Orientations.NONE},setTarget:function(character){if(character==null){this.removeTarget();return}if(this.target!==character){if(this.hasTarget()){this.removeTarget()}this.unconfirmedTarget=null;this.target=character;if(this.settarget_callback){var targetName=this.target.spriteName;if(MobData.Kinds[character.kind]&&targetName)this.settarget_callback(character,targetName,character.level)}}else{console.info(character.id+" is already the target of "+this.id)}},isInReach:function(x,y,o,r,rs){var o=o||this.orientation;var ts=G_TILESIZE;var rs=rs||ts>>1;var r=r||ts+rs;var a=rs,b=rs;switch(o){case Types.Orientations.UP:case Types.Orientations.DOWN:b=r;break;case Types.Orientations.LEFT:case Types.Orientations.RIGHT:a=r;break;case Types.Orientations.NONE:return false}return Math.abs(this.x-x)<=a&&Math.abs(this.y-y)<=b},canReach:function(entity){var ts=G_TILESIZE;if(this.attackRange===ts)return this.isInReach(entity.x,entity.y,this.orientation);if(this.attackRange>ts){return this.isNear(entity,this.attackRange)}return false},dying:function(){this.isDead=false;this.isDying=true},die:function(){console.warn("CHARACTER DIED!!!!!!!!!!!!!!!!!!!!!");this.removeTarget();this.isDying=true;this.isDead=true;if(this.death_callback){this.death_callback()}},isOverlapping:function(){var entities=this.map.entities.getCharactersAround(this,1);res=false,ts=G_TILESIZE;for(var entity of entities){if(!entity||this==entity)continue;var tx=entity.x;var ty=entity.y;if(Math.abs(this.x-tx)<ts&&Math.abs(this.y-ty)<ts){res=true;break}}return res},resetHP:function(){var max=typeof this.getHPMax==="function"?this.getHPMax():this.stats.hpMax;this.stats.hpMax=max;var diff=max-this.stats.hp;this.stats.hp=max;msg=new Messages.ChangePoints(this,diff,0);this.map.entities.pushNeighbours(this,msg)},resetEP:function(){var max=typeof this.getEPMax==="function"?this.getEPMax():this.stats.epMax;this.stats.epMax=max;this.stats.ep=max},setHP:function(val){val=val||typeof this.getHPMax==="function"?this.getHPMax():this.stats.hpMax;this.stats.hp=val},setEP:function(val){val=val||typeof this.getEPMax==="function"?this.getEPMax():this.stats.epMax;this.stats.ep=val},isFacing:function(x,y){var dx=this.x-x;var dy=this.y-y;switch(this.orientation){case 1:return dy>0;case 2:return dy<0;case 3:return dx>0;case 4:return dx<0}return false},isFacingEntity:function(entity){return this.isFacing(entity.x,entity.y)},nextTile:function(x,y){x=x||this.x;y=y||this.y;var ts=G_TILESIZE;switch(this.orientation){case 1:return[x,y-ts];case 2:return[x,y+ts];case 3:return[x-ts,y];case 4:return[x+ts,y]}return[x,y]},onDamage:function(attacker,hpMod,epMod,crit,effects){hpMod=hpMod||0;epMod=epMod||0;crit=crit||0;effects=effects||0;if(hpMod>0)this.addAttacker(attacker);if(hpMod!=0)this.stats.hp=Utils.clamp(0,this.stats.hpMax,this.stats.hp-hpMod);if(epMod!=0)this.stats.ep=Utils.clamp(0,this.stats.epMax,this.stats.ep-epMod);var msg=new Messages.Damage([attacker,this,-hpMod,-epMod,crit,effects]);this.map.entities.pushNeighbours(attacker,msg)}});module.exports=Character},{"../shared/js/gametypes":167,"./entitymoving":92,"./lib/class":105,"./message":112,"./mobdata":118,"./npcdata":121,"./timer":138,"./transition":140,"./utils":146}],86:[function(require,module,exports){var cls=require("./lib/class");var Utils=require("./utils");var Checkpoint=cls.Class.extend({init:function(map,id,x,y,width,height){this.map=map;this.id=id;this.x=x*16;this.y=y*16;this.width=width*16;this.height=height*16},getRandomPosition:function(){var pos={};var valid=true;while(valid){pos.x=this.x+Utils.randomInt(this.width-1);pos.y=this.y+Utils.randomInt(this.height-1);valid=this.map.isColliding(pos.x,pos.y)}return pos},isValidPosition:function(x,y){var self=this;return self.map&&_.isNumber(x)&&_.isNumber(y)&&!self.map.isOutOfBounds(x,y)&&!self.map.isColliding(x,y)}});module.exports=Checkpoint},{"./lib/class":105,"./utils":146}],87:[function(require,module,exports){var _=require("underscore");var Item=require("./item");var Items=require("./items");var Types=require("../shared/js/gametypes");var Utils=require("./utils");var Chest=Item.extend({init:function(id,x,y,map,area,minLevel,maxLevel){this._super(id,Types.EntityTypes.CHEST,x,y);this.map=map;this.level=Utils.randomRangeInt(minLevel,maxLevel);this.setDrops();this.area=area;this.spawnDelay=3e4},handleRespawn:function(){var self=this;this.droppedItem=false;if(this.area&&this.area instanceof ChestArea){this.area.respawnChest(this,this.spawnDelay)}},setDrops:function(){this.drops={};var dropLevel=Math.ceil(this.level/10)*10;for(var itemId in Items.Kinds){var item=Items.Kinds[itemId];if(!item)continue;if(item.typemod=="attack"||item.typemod=="defense"){switch(dropLevel){case item.modifier+10:this.drops[itemId]=20;break;case item.modifier:this.drops[itemId]=10;break;case item.modifier-10:this.drops[itemId]=5;break;case item.modifier-20:this.drops[itemId]=2;break}}if(item.typemod=="craft"){switch(dropLevel){case item.modifier+10:this.drops[itemId]=400;break;case item.modifier:this.drops[itemId]=200;break;case item.modifier-10:this.drops[itemId]=100;break;case item.modifier-20:this.drops[itemId]=50;break}}}}});module.exports=Chest},{"../shared/js/gametypes":167,"./item":99,"./items":102,"./utils":146,underscore:75}],88:[function(require,module,exports){var Area=require("./area"),_=require("underscore"),MobData=require("./mobdata"),Messages=require("./message"),Types=require("../shared/js/gametypes"),Utils=require("./utils");module.exports=ChestArea=Area.extend({init:function(id,elipse,nb,minLevel,maxLevel,x,y,width,height,map){this._super(id,x,y,width,height,map);this.nb=nb;this.minLevel=minLevel;this.maxLevel=maxLevel;this.respawns=[];this.map=map;this.setNumberOfEntities(this.nb);this.chests=[37]},spawnChests:function(){for(var i=0;i<this.nb;i+=1){this.addToArea(this._createRandomChestInsideArea())}},_createRandomChestInsideArea:function(){return this._createChest()},_createChest:function(){var self=this;var pos=self.map.entities.spaceEntityRandomApart(2,self._getRandomPositionInsideArea.bind(self,20));var Chest=require("./chest");var chest=new Chest(2e4+ ++self.map.entities.entityCount,pos.x,pos.y,self.map,self,self.minLevel,self.maxLevel);self.map.entities.addChest(chest);self.addToArea(chest);return chest},respawnChest:function(chest,delay){var self=this;delay=chest.spawnDelay||delay;this.removeFromArea(chest);setTimeout((function(){var pos=self.map.entities.spaceEntityRandomApart(2,self._getRandomPositionInsideArea.bind(self,20));chest.x=pos.x;chest.y=pos.y;self.addToArea(chest);self.map.entities.addChest(chest);self.map.entities.pushBroadcast(new Messages.Spawn(chest))}),delay)}});module.exports=ChestArea},{"../shared/js/gametypes":167,"./area":80,"./chest":87,"./message":112,"./mobdata":118,"./utils":146,underscore:75}],89:[function(require,module,exports){var path=require("path");var server;module.exports=function(config){return require("./redis")}},{"./redis":133,path:undefined}],90:[function(require,module,exports){var _=require("underscore"),cls=require("./lib/class"),Utils=require("./utils"),SkillData=require("./skilldata"),Types=require("../shared/js/gametypes");EffectType=cls.Class.extend({init:function(isTarget,phase,stat,modValue){this.entity=null;this.isTarget=isTarget;this.phase=phase;this.stat=stat;this.modValue=modValue||0;this.active=false},apply:function(target,isTarget,phase,damage){if(this.phase!=phase)return;if(isTarget==this.isTarget)return;var val1=0,val2=0,vmax=0;switch(this.stat){case SkillEffects.EffectStat.HP:val1=target.stats.hp;vmax=val2=target.stats.hpMax;break;case SkillEffects.EffectStat.EP:val1=target.stats.ep;vmax=val2=target.stats.epMax;break;case SkillEffects.EffectStat.ATTACK:val2=val1=target.stats.attack;break;case SkillEffects.EffectStat.DEFENSE:val2=val1=target.stats.defense;break}if(damage>0){switch(this.stat){case SkillEffects.EffectStat.DAMAGE:val1=target.stats.hp;val2=damage;vmax=target.stats.hpMax;break}}if(val1>0&&val2>0){this.getModDiff(val1,val2,vmax)}switch(this.stat){case SkillEffects.EffectStat.HP:target.stats.hp+=this.diff;Utils.clamp(0,target.stats.hpMax,target.stats.hp);break;case SkillEffects.EffectStat.EP:target.stats.ep+=this.diff;Utils.clamp(0,target.stats.epMax,target.stats.ep);break;case SkillEffects.EffectStat.ATTACK:target.stats.mod.attack=this.diff;break;case SkillEffects.EffectStat.DEFENSE:target.stats.mod.defense=this.diff;break;case SkillEffects.EffectStat.DAMAGE:target.stats.mod.damage=this.diff;case SkillEffects.EffectStat.FREEZE:if(this.modVal==1)target.freeze=true;else{target.freeze=false}break;case SkillEffects.EffectStat.MOVESPEED:target.moveSpeed+=this.modVal;break}return},getModDiff:function(stat,statmod,vmax){var modVal=this.modValue*this.level;if(effectType.modValue<1){modVal=~~(statmod*this.modValue*this.level)}var diff=modVal;stat+=modVal;if(vmax>0){if(stat>vmax)diff-=stat-vmax}if(stat<0){diff=stat}this.diff=diff;return diff}});var SkillEffect=cls.Class.extend({init:function(source,skillId,skillLevel){this.source;this.skillId=skillId;this.data=SkillData.Skills[skillId];console.info("SkillEffect - skillId:"+skillId);this.targetType=this.data.targetType;this.activeTimer=0;this.duration=(this.data.durationPL?this.data.durationPL*this.level:this.data.duration)||0;this.duration*=1e3;this.countTotal=this.data.total||0;this.count=0;this.effectTypes=this.data.effectTypes;this.level=skillLevel;this.isActve=false;this.interval=null;this.targets=[]},getTargets:function(target,x,y){switch(this.targetType){case SkillEffects.TargetType.SELF:return[this.source];case SkillEffects.TargetType.ENEMY:return[this.source,target];case SkillEffects.TargetType.PLAYER_AOE:var arr=target.maps.entities.getPlayerAround(target,this.data.aoe);arr.unshift(this.source);return arr;case SkillEffects.TargetType.ENEMY_AOE:var arr=target.maps.entities.getMobsAround(target,this.data.aoe);arr.unshift(this.source,this.target);return arr}return[]},apply:function(target,targetX,targetY){var self=this;if(this.duration>0){this.activeTimer=0;if(this.interval){clearInterval(this.interval);this.interval=null}this.interval=setInterval((function(){if(self.activeTimer>self.duration){self.applyEffects(1,0);self.isActive=false;clearInterval(self.interval);self.interval=null}else{self.applyEffects(2,0);self.activeTimer+=1e3}}),1e3)}if(this.countTotal>0)this.count=0;this.targets=this.getTargets(target,targetX,targetY);this.isActive=true;this.applyEffects(0,0)},applyEffects:function(phase,damage){for(var target of this.targets){for(var effect in this.effectTypes){if(this.isActive)effect.apply(target,this.source!=target,phase,damage)}}},onInterval:function(phase,damage){if(this.countTotal>0&&this.count==this.countTotal){this.applyEffects(1,0);this.isActive=false;return}this.applyEffects(phase,damage);if(this.countTotal>0&&phase==5){this.count++}}});var SkillEffectHandler=cls.Class.extend({init:function(entity){this.entity=entity;this.skillEffects=[];for(var skill of this.entity.skills){this.skillEffects.push(new SkillEffect(this.entity,skill.skillIndex,skill.skillLevel))}},interval:function(phase,damage){damage=damage||0;for(var effect of this.skillEffects)effect.onInterval(phase,damage)},cast:function(skillId,target,x,y){this.skillEffects[skillId].apply(target,x,y)}});module.exports=EffectType;module.exports=SkillEffect;module.exports=SkillEffectHandler},{"../shared/js/gametypes":167,"./lib/class":105,"./skilldata":135,"./utils":146,underscore:75}],91:[function(require,module,exports){var cls=require("./lib/class");var Messages=require("./message");var Utils=require("./utils");var Timer=require("./timer");module.exports=Entity=cls.Class.extend({init:function(id,type,kind,x,y,map){var self=this;this.type=type;this.id=id;this.kind=kind;this.map=map;this.mapIndex=map.index;this.shadowOffsetY=0;this.isLoaded=false;this.isHighlighted=false;this.visible=true;this.isFading=false;this.prevX=0;this.prevY=0;this.prevOrientation=null;this.name="";this.nameOffsetY=-10;this.isCritical=false;this.isHeal=false;this.shadowOffsetY=0;this.setPosition(Number(x),Number(y));this.orientation=Utils.randomOrientation()},setName:function(name){this.name=name},setPosition:function(x,y){var ts=G_TILESIZE;this.x=x;this.y=y;var gx=x>>4;var gy=y>>4;if(typeof this.gx==="undefined")this.gx=gx;if(typeof this.gy==="undefined")this.gy=gy;if(x%ts==0)this.gx=gx;if(y%ts==0)this.gy=gy;var spx=~~(gx/G_SPATIAL_SIZE);var spy=~~(gy/G_SPATIAL_SIZE);if(!this.hasOwnProperty("sx"))this.spx=spx;if(!this.hasOwnProperty("sy"))this.spy=spy;if(this.spatialMapid==this.map.id&&this.map.entities.spatial[this.spy][this.spx].hasOwnProperty(this.id)){this.map.entities.spatial[this.spy][this.spx][this.id]=null}this.map.entities.spatial[spy][spx][this.id]=this;this.spx=spx;this.spy=spy;this.spatialMapId=this.map.id},ready:function(f){this.ready_func=f},clean:function(){},log_info:function(message){console.info("["+this.id+"] "+message)},log_error:function(message){console.error("["+this.id+"] "+message)},getDistanceToEntity:function(entity){var distX=Math.abs(entity.x-this.x),distY=Math.abs(entity.y-this.y);return distX>distY?distX:distY},isAdjacent:function(entity){var adjacent=false;if(entity){adjacent=this.getDistanceToEntity(entity)>1?false:true}return adjacent},isAdjacentNonDiagonal:function(entity){var result=false;if(this.isAdjacent(entity)&&!(this.x!==entity.x&&this.y!==entity.y)){result=true}return result},isDiagonallyAdjacent:function(entity){return this.isAdjacent(entity)&&!this.isAdjacentNonDiagonal(entity)},forEachAdjacentNonDiagonalPosition:function(callback){callback(this.x-1,this.y,Types.Orientations.LEFT);callback(this.x,this.y-1,Types.Orientations.UP);callback(this.x+1,this.y,Types.Orientations.RIGHT);callback(this.x,this.y+1,Types.Orientations.DOWN)},_getBaseState:function(){return[parseInt(this.id,10),parseInt(this.type),parseInt(this.kind),this.name,parseInt(this.map.index),parseInt(this.x),parseInt(this.y),parseInt(this.orientation||0)]},getMapIndex:function(){return this.map.index},getState:function(){return this._getBaseState()},spawn:function(){return new Messages.Spawn(this)},despawn:function(){return new Messages.Despawn(this)},getPositionNextTo:function(entity){var pos=null;if(entity){pos={};var r=Utils.random(4);pos.x=entity.x;pos.y=entity.y;if(r===0){pos.y-=16}if(r===1){pos.y+=16}if(r===2){pos.x-=16}if(r===3){pos.x+=16}}return pos},setRandomOrientation:function(){r=Utils.random(4);if(r===0)this.orientation=Types.Orientations.LEFT;if(r===1)this.orientation=Types.Orientations.RIGHT;if(r===2)this.orientation=Types.Orientations.UP;if(r===3)this.orientation=Types.Orientations.DOWN},isNextTooEntity:function(entity){return this.isNextToo(entity.x,entity.y)},isNextToo:function(x,y,o){var o=o||this.orientation;var ts=G_TILESIZE;return Math.abs(this.x-x)<=ts&&Math.abs(this.y-y)<=ts},isWithin:function(entity){return Math.abs(entity.x-this.x)<G_TILESIZE>>1&&Math.abs(entity.y-this.y)<G_TILESIZE>>1},isTouching:function(entity){return Math.abs(entity.x-this.x)<G_TILESIZE&&Math.abs(entity.y-this.y)<G_TILESIZE},destroy:function(){}});module.exports=Entity},{"./lib/class":105,"./message":112,"./timer":138,"./utils":146}],92:[function(require,module,exports){var cls=require("./lib/class"),Entity=require("./entity"),Messages=require("./message"),Utils=require("./utils"),Timer=require("./timer"),Types=require("../shared/js/gametypes"),Transition=require("./transition");module.exports=EntityMoving=Entity.extend({init:function(id,type,kind,x,y,map){var self=this;this._super(id,type,kind,x,y,map);this.nextX=-1;this.nextY=-1;this.prevX=-1;this.prevY=-1;this.moveSpeed=100;this.setMoveRate(this.moveSpeed);this.walkSpeed=150;this.idleSpeed=Utils.randomInt(750,1e3);this.followingMode=false;this.engagingPC=false;this.step=0;this.orientation=this.setRandomOrientation();this.movement=new Transition;this.path=null;this.newDestination=null;this.adjacentTiles={};this.moveCooldown=null;this.freeze=false},setOrientation:function(orientation){if(orientation){this.orientation=orientation||0}},idle:function(orientation){this.setOrientation(orientation)},walk:function(orientation){this.setOrientation(orientation)},moveTo_:function(x,y,callback){this.destination={x:x,y:y};this.adjacentTiles={};if(this.isMovingPath()){this.continueTo(x,y)}else{var path=this.requestPathfindingTo(x,y);if(path)this.followPath(path)}},requestPathfindingTo:function(x,y){if(Array.isArray(this.path)&&this.path.length>0){return this.path}else if(this.request_path_callback){return this.request_path_callback(x,y)}else{console.info(this.id+" couldn't request pathfinding to "+x+", "+y);console.info("char x:"+this.x+",y: "+this.y+", x:"+x+"y: "+y);try{throw new Error}catch(e){console.info(e.stack)}return null}},onRequestPath:function(callback){this.request_path_callback=callback},onStartPathing:function(callback){this.start_pathing_callback=callback},onStopPathing:function(callback){this.stop_pathing_callback=callback},onAbortPathing:function(callback){this.abort_pathing_callback=callback},followPath:function(path){if(!path)return;this.path=path;this.step=0;if(this.followingMode){path.pop()}if(this.start_pathing_callback){this.start_pathing_callback(path)}},continueTo:function(x,y){this.newDestination={x:x,y:y}},lookAt:function(target){if(target){this.orientation=this.getOrientationTo(target)}},go:function(x,y){if(this.isAttacking()){this.disengage()}else if(this.followingMode){this.followingMode=false;this.target=null}this.moveTo_(x,y)},follow:function(entity){var found=false;var spot=this.getClosestSpot(entity);if(spot&&spot.x&&spot.y)this.moveTo_(spot.x,spot.y)},getLastMove:function(){if(!this.path)return null;var lastPath=this.path[this.path.length-1];return[lastPath[0],lastPath[1]]},getOrientationTo:function(character){if(this.x<character.x){return Types.Orientations.RIGHT}else if(this.x>character.x){return Types.Orientations.LEFT}else if(this.y>character.y){return Types.Orientations.UP}else{return Types.Orientations.DOWN}},stopInPath:function(x,y){if(this.isMovingPath()){if(this.map.entities.pathfinder.isInPath(this.path,[x,y])){this.setPosition(x,y);this.interrupted=true;this.forceStop()}}},stop:function(){if(this.isMovingPath()){this.interrupted=true;this.moving=false}},forceStop:function(){this.movement.stop();this.orientation=0;this.moveOrientation=0;if(this.isMovingPath()){if(this.interrupted&&this.abort_pathing_callback)this.abort_pathing_callback(this.x,this.y);this.interrupted=false;this.path=null;this.newDestination=null;this.isReadyToMove=true;this.followingMode=false}},forceStopMove:function(){console.info("character - forceStopMove - called");this.movement.stop();this.moveOrientation=0;this.freeze=false;if(this.movestop_callback)this.movestop_callback()},setMoveStopCallback:function(callback){this.movestop_callback=callback},canMove:function(){if(this.isDead==false&&this.moveCooldown.isOver()){return true}return false},onHasMoved:function(callback){this.hasmoved_callback=callback},hasMoved:function(){this.setDirty();if(this.hasmoved_callback){this.hasmoved_callback(this)}},setMoveRate:function(rate){this.moveSpeed=rate;this.walkSpeed=~~(rate/4);this.moveCooldown=new Timer(rate);this.tick=Math.round(1e3/this.moveSpeed)},getState:function(){return this._getBaseState()},setFreeze:function(ms,callback){var self=this;if(ms<=0){self.freeze=false;return}this.freeze=true;this.freeze_callback=setTimeout((function(){self.freeze=false;if(callback)callback(self)}),ms)},getPathIndex:function(step){if(!this.path===null||this.path.length===0)return null;if(step<0||step>=this.path.length)return null;return this.path[step]},isWithinPath:function(coords){var tCoords=null;if(typeof coords==="Object"&&coords.x>0&&coords.y>0){tCoords=[coords.x,coords.y]}else if(Array.isArray(coords)&&coords.length==2){tCoords=[coords[0],coords[1]]}if(!tCoords)return null;if(this.path===null||this.path.length===0)return null;var pathLen=this.path.length;for(var i=0;i<pathLen;++i){if(this.path[i][0]===tCoords[0]&&this.path[i][1]===tCoords[1])return{x:tCoords[0],y:tCoords[1],step:i}}return null},updateMovement:function(){var p=this.path,i=this.step;if(!p||i>p.length-1)return;if(this.x<p[i][0]){this.walk(Types.Orientations.RIGHT)}else if(this.x>p[i][0]){this.walk(Types.Orientations.LEFT)}else if(this.y<p[i][1]){this.walk(Types.Orientations.DOWN)}else if(this.y>p[i][1]){this.walk(Types.Orientations.UP)}else{this.idle()}},nextStepPath:function(){if(this.step==0){this.step++;this.updateMovement()}if(this.step<this.path.length){if(this.x==this.path[this.step][0]&&this.y==this.path[this.step][1]){this.step++;this.updateMovement();return true}return false}return false},nextStep:function(){var stop=false,res=false,path,x,y;if(!this.isMovingPath()||this.freeze){this.interrupted=true;stop=true}if(!stop){res=this.nextStepPath();if(this.step>=this.path.length){stop=true}if(this.step_callback){this.step_callback()}}if(this.hasChangedItsPath()){this.setPosition(this.x,this.y);x=this.newDestination.x;y=this.newDestination.y;path=this.requestPathfindingTo(x,y);this.newDestination=null;this.followPath(path);return true}if(stop){if(this.stop_pathing_callback){this.stop_pathing_callback(this.x,this.y);this.forceStop()}res=true}return res},onBeforeMove:function(callback){this.before_move_callback=callback},onBeforeStep:function(callback){this.before_step_callback=callback},onStep:function(callback){this.step_callback=callback},isMoving:function(){return this.movement.inProgress},isMovingPath:function(){return this.path&&this.path.length>0},hasNextStep:function(){return this.path&&this.path.length-1>this.step},hasChangedItsPath:function(){return!(this.newDestination===null)},isNear:function(character,distance){var dx,dy,near=false;dx=Math.abs(this.x-character.x);dy=Math.abs(this.y-character.y);if(dx<=distance*G_TILESIZE&&dy<=distance*G_TILESIZE){near=true}return near},onRemove:function(callback){this.remove_callback=callback},lookAtEntity:function(entity){if(entity){this.orientation=this.getOrientationTo(entity)}return this.orientation},lookAt:function(x,y){return this.getOrientationTo([x,y])},getOrientationTo:function(object){return this.getOrientation([this.x,this.y],[object.x,object.y])},getOrientation:function(p1,p2){var x=Math.abs(p1[0]-p2[0]);var y=Math.abs(p1[1]-p2[1]);if(x>y){if(p1[0]>p2[0])return Types.Orientations.LEFT;else return Types.Orientations.RIGHT}else if(y>x){if(p1[1]>p2[1])return Types.Orientations.UP;else return Types.Orientations.DOWN}return Types.Orientations.NONE},isInReach:function(x,y,o,r,rs){var o=o||this.orientation;var ts=G_TILESIZE;var rs=rs||ts>>1;var r=r||ts+rs;var a=rs,b=rs;switch(o){case Types.Orientations.UP:case Types.Orientations.DOWN:b=r;break;case Types.Orientations.LEFT:case Types.Orientations.RIGHT:a=r;break;case Types.Orientations.NONE:return false}return Math.abs(this.x-x)<=a&&Math.abs(this.y-y)<=b},isOverlapping:function(){var entities=this.map.entities.getCharactersAround(this,1);res=false,ts=G_TILESIZE;for(var entity of entities){if(!entity||this==entity)continue;var tx=entity.x;var ty=entity.y;if(Math.abs(this.x-tx)<ts&&Math.abs(this.y-ty)<ts){res=true;break}}return res}});module.exports=EntityMoving},{"../shared/js/gametypes":167,"./entity":91,"./lib/class":105,"./message":112,"./timer":138,"./transition":140,"./utils":146}],93:[function(require,module,exports){var _=require("underscore"),SpawnJson=require("../shared/data/entity_spawn.json"),fs=require("fs");var EntitySpawnData=[];var i=0;_.each(SpawnJson,(function(value,key){EntitySpawnData[i++]=value}));var addSpawn=function(id,x,y){EntitySpawnData.push({id:id,x:x,y:y})};var saveSpawns=function(){fs.writeFile("./shared/data/entity_spawn.json",JSON.stringify(EntitySpawnData),(function(err,data){if(err){return console.info(err)}}))};module.exports.EntitySpawnData=EntitySpawnData;module.exports.addSpawn=addSpawn;module.exports.saveSpawns=saveSpawns},{"../shared/data/entity_spawn.json":152,fs:undefined,underscore:75}],94:[function(require,module,exports){var cls=require("./lib/class"),ItemRoom=require("./itemroom"),Messages=require("./message"),ItemTypes=require("../shared/js/itemtypes"),Types=require("../shared/js/gametypes"),Items=require("./items");module.exports=Equipment=cls.Class.extend({init:function(owner,number,items){this.owner=owner;this.number=number;this.maxNumber=5;this.weaponSlot=4;this.rooms={};console.info("number="+number);console.info("itemSlots="+JSON.stringify(items));if(items){for(var i=0;i<items.length;i++){var index=items[i].slot;this.rooms[index]=items[i]}}},makeEmptyItem:function(index){this.rooms[index]=null;delete this.rooms[index];this.setItem(index,null)},getItemIndex:function(itemKind){for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind==itemKind){return i}}return-1},combineItem:function(item,item2){return-1},checkItem:function(index,item){if(!item)return true;var kind=item.itemKind;var data=Items.Kinds[kind];if(!ItemTypes.isEquipment(kind))return false;if(index==0&&!(data.type==="helm"&&this.canEquip(item,data.level)))return false;if(index==1&&!(data.type==="chest"&&this.canEquip(item,data.level)))return false;if(index==2&&!(data.type==="gloves"&&this.canEquip(item,data.level)))return false;if(index==3&&!(data.type==="boots"&&this.canEquip(item,data.level)))return false;if(index==4&&!(ItemTypes.isWeapon(kind)&&this.canEquip(item,ItemTypes.getWeaponLevel(kind))))return false;return true},setItem:function(index,item){var player=this.owner;if(!item){this.rooms[index]=null;item={slot:index,itemKind:-1};if(index==this.weaponSlot){player.map.entities.pushNeighbours(player,new Messages.Looks(player))}}else{if(!this.checkItem(index,item))return false;this.rooms[index]=item;item.slot=index;if(index==this.weaponSlot){player.setRange();player.map.entities.pushNeighbours(player,new Messages.Looks(player))}}player.map.entities.pushToPlayer(player,new Messages.ItemSlot(2,[item]));return true},canEquip:function(item,level){var player=this.owner;var kind=item.itemKind;if(level>player.level.base){player.map.entities.pushToPlayer(player,new Messages.Notify("EQUIP","EQUIPMENT_LEVEL",[level]));return false}return true},save:function(){databaseHandler.saveItems(this.owner,2,this.rooms)},degradeItem:function(slot,adjustment){var item=this.rooms[slot];if(!item)return;item.itemDurability-=adjustment;item.itemDurability=Math.max(0,item.itemDurability);if(item.itemDurability==0&&item.itemDurabilityMax<=30){this.makeEmptyEquipment(slot);return false}return true},addExperience:function(slot,adjustment){var item=this.rooms[slot];if(!item)return;item.itemExperience+=adjustment;var oldItemNumber=item.itemNumber;var newItemNumber=ItemTypes.getItemLevel(item.itemExperience);if(oldItemNumber<newItemNumber){item.itemNumber++;this.owner.map.entities.pushToPlayer(this.owner,new Messages.ItemLevelUp(slot,item))}item.slot=slot;this.owner.map.entities.pushToPlayer(this.owner,new Messages.ItemSlot(2,[item]))},toString:function(){var i=0;var itemString=""+this.maxNumber+",";for(i=0;i<this.maxNumber;i++){var item=this.rooms[i];itemArray=[item.itemKind,item.itemNumber,item.itemDurability,item.itemDurabilityMax,item.itemExperience];itemString+=itemArray.join(",")}return itemString},toStringJSON:function(){var itemString="[";var isItems=false;for(var i=0;i<this.maxNumber;i++){var item=this.rooms[i];if(!item)continue;itemArray=[i,item.itemKind,item.itemNumber,item.itemDurability,item.itemDurabilityMax,item.itemExperience];itemString+="["+itemArray.join(",")+"],";isItems=true}itemString=itemString.slice(0,-1);itemString+="]";if(!isItems)return"[]";return itemString}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./itemroom":101,"./items":102,"./lib/class":105,"./message":112}],95:[function(require,module,exports){var _=require("underscore");var Types=require("../shared/js/gametypes");(function(){FormatChecker=Class.extend({init:function(){this.formats=[];this.usernameMax=16;this.playerMax=16;this.dateMin=167e10;this.dateMax=2e12;this.hashLen=120;this.entityIdMax=99999;this.coordMax=16384;this.bankMax=47;this.inventoryMax=47;this.goldMax=99999999;this.gemMax=9999;this.itemCountMax=100;this.itemKindMax=999;this.formats[Types.Messages.BI_SYNCTIME]=[["n",this.dateMin,this.dateMax]],this.formats[Types.Messages.CS_CREATE_USER]=[["s",2,this.usernameMax],["s",this.hashLen,this.hashLen]],this.formats[Types.Messages.CS_LOGIN_USER]=[["s",2,this.usernameMax],["s",this.hashLen,this.hashLen]],this.formats[Types.Messages.CS_CREATE_PLAYER]=[["n",0,9],["s",2,this.playerMax]],this.formats[Types.Messages.CS_LOGIN_PLAYER]=[["n",0,9],["n",0,16]],this.formats[Types.Messages.CS_APPEARANCEUNLOCK]=[["n",-1,255],["n",0,this.gemMax]],this.formats[Types.Messages.CS_ATTACK]=[["n",this.dateMin,this.dateMax],["n",0,this.entityIdMax],["n",0,4],["n",-1,50]],this.formats[Types.Messages.CS_AUCTIONBUY]=[["n",0,1e3],["n",0,3]],this.formats[Types.Messages.CS_AUCTIONDELETE]=[["n",0,1e3],["n",0,3]],this.formats[Types.Messages.CS_AUCTIONOPEN]=[["n",0,3]],this.formats[Types.Messages.CS_AUCTIONSELL]=[["n",0,this.inventoryMax],["n",0,this.goldMax]],this.formats[Types.Messages.CS_BANKRETRIEVE]=[["n",0,this.bankMax]],this.formats[Types.Messages.CS_BANKSTORE]=[["n",0,this.inventoryMax]],this.formats[Types.Messages.CS_CHAT]=[["s",1,256]],this.formats[Types.Messages.CS_COLOR_TINT]=[["n",0,1],["s",6,6]],this.formats[Types.Messages.BI_BLOCK_MODIFY]=[["n",0,1],["n",0,this.entityIdMax],["n",0,this.coordMax],["n",0,this.coordMax]],this.formats[Types.Messages.CS_INVENTORY]=[["n",0,3],["n",-1,1],["n",-1,this.inventoryMax],["n",0,1]],this.formats[Types.Messages.CS_LOADLOOKS]=[],this.formats[Types.Messages.CS_LOOKUPDATE]=[["n",0,1],["n",0,999]],this.formats[Types.Messages.CS_LOOT]=[["n",0,this.entityIdMax],["n",0,this.coordMax],["n",0,this.coordMax]],this.formats[Types.Messages.CS_MOVE]=[["n",this.dateMin,this.dateMax],["n",0,this.entityIdMax],["n",0,2],["n",0,4],["n",0,this.coordMax],["n",0,this.coordMax]],this.formats[Types.Messages.CS_PLAYER_REVIVE]=[],this.formats[Types.Messages.BI_SEND_BANK]=[],this.formats[Types.Messages.BI_SEND_INVENTORY]=[],this.formats[Types.Messages.CS_GOLD]=[["n",0,1],["n",0,this.goldMax],["n",0,1]],this.formats[Types.Messages.CS_STATADD]=[["n",1,5],["n",1,1]],this.formats[Types.Messages.CS_STOREBUY]=[["n",1,3],["n",0,this.itemKindMax],["n",0,10]],this.formats[Types.Messages.CS_CRAFT]=[["n",0,this.itemKindMax],["n",0,10]],this.formats[Types.Messages.CS_STOREENCHANT]=[["n",0,2],["n",0,this.inventoryMax]],this.formats[Types.Messages.CS_STOREREPAIR]=[["n",0,2],["n",0,this.inventoryMax]],this.formats[Types.Messages.CS_STORESELL]=[["n",0,2],["n",0,this.inventoryMax]],this.formats[Types.Messages.CS_TALKTONPC]=[["n",5,6],["n",0,this.entityIdMax]],this.formats[Types.Messages.CS_TELEPORT_MAP]=[["n",0,9],["n",0,1],["n",-1,this.coordMax],["n",-1,this.coordMax]],this.formats[Types.Messages.CS_SKILL]=[["n",0,50],["n",0,this.entityIdMax]],this.formats[Types.Messages.CS_SKILLINSTALL]=[["n",0,6],["n",0,50]],this.formats[Types.Messages.CS_PARTY]=[["n",0,4],["so",0,this.playerMax],["no",0,3]],this.formats[Types.Messages.BI_PLAYERINFO]=[],this.formats[Types.Messages.BI_HARVEST]=[["n",0,this.coordMax],["n",0,this.coordMax]],this.formats[Types.Messages.CS_HARVEST_ENTITY]=[["n",0,this.entityIdMax]]},checkFormat:function(type,message,format,ignoreLength){var format=format||this.formats[type];ignoreLength=ignoreLength||false;var formatTypes=function(data){};if(format){if(!ignoreLength&&message.length!==format.length){return false}for(var i=0,n=format.length;i<n;i+=1){var fmt=format[i];var msg=message[i];if(Array.isArray(fmt)){var fnn=fmt[0]==="n"&&(!_.isNumber(msg)||msg<fmt[1]||msg>fmt[2]);if(fnn)return false;var fss=fmt[0]==="s"&&(!_.isString(msg)||msg.length<fmt[1]||msg.length>fmt[2]);if(fss)return false}else{if(fmt==="n"&&!_.isNumber(msg)){return false}if(fmt==="s"&&!_.isString(msg)){return false}}}return true}else{console.error("Unknown message type: "+type);return false}},check:function(msg){var message=msg.slice(0),type=message.shift(),format=format||this.formats[type];if(this.formats[type]){return this.checkFormat(type,message,this.formats[type],false)}if(type===Types.Messages.CS_MOVEPATH){var format=[["n",this.dateMin,this.dateMax],["n",0,this.entityIdMax],["n",0,4],["n",0,1]];if(!this.checkFormat(type,message,format,true))return false;var path=message.splice(format.length,message.length);if(!path)return false;if(path.length<2||path.length>16)return false;for(var coord of path){if(!Array.isArray(coord)||coord.length!=2)return false;var a=0;for(var i=0;i<2;++i){a=coord[i];if(!_.isNumber(a)||a<0||a>this.coordMax)return false}}return true}else if(type===Types.Messages.CS_WHO){try{var arr=JSON.parse(message)}catch(e){return false}return message.length>0&&_.all(message,(function(param){return _.isNumber(param)&&param>0&&param<99999}))}else if(type===Types.Messages.CS_ITEMSLOT){var message=msg.slice(0),type=message.shift();var format=[["n",0,3],["n",0,2],["n",-1,this.inventoryMax],["n",0,this.itemCountMax]];if(message.length==7){format=format.concat([["n",0,2],["n",-1,this.inventoryMax],["n",0,this.itemCountMax]])}return this.checkFormat(type,message,format,true)}else{try{throw new Error}catch(err){console.info(err.stack)}console.error("Unknown message type: "+type);console.warn("message="+message);return false}}});var checker=new FormatChecker;exports.check=checker.check.bind(checker)})()},{"../shared/js/gametypes":167,underscore:75}],96:[function(require,module,exports){var Utils=require("./utils"),ItemTypes=require("../shared/js/itemtypes"),Formulas={};Formulas.crit=function(attacker,defender){var chance=Utils.randomRangeInt(0,200)<=Utils.clamp(5,195,~~(25+attacker.baseCrit()-defender.baseCritDef()));return chance};Formulas.dmg=function(attacker,defender,time){var attackPower=1;if(attacker.attackTimer)attackPower=Utils.clamp(ATTACK_INTERVAL,ATTACK_MAX,time-attacker.attackTimer)/ATTACK_INTERVAL;console.info("attacker baseDamage="+attacker.baseDamage());console.info("defender baseDamageDef="+defender.baseDamageDef());var dmg=~~(attacker.baseDamage()*attackPower);dmg=Utils.clamp(1,5e3,~~(dmg-defender.baseDamageDef()));if(attacker instanceof Player&&dmg>0)attacker.incAttackExp(dmg);if(defender instanceof Player&&dmg>0)defender.incDefenseExp(dmg);return~~dmg};Formulas.pickPocket=function(source,target,chance){if(target.level-source.level+~~Utils.randomRange(0,100)<=chance)return true;return false};Formulas.mindControl=function(source,target){if(target.level<=source.level&&~~Utils.randomRange(0,~~(target.level*50/source.level))===0)return true;return false};Formulas.hp=function(entityLevel){return 100+entityLevel*40};Formulas.energy=function(entityLevel){return 100+entityLevel*30};Formulas.getExpArray=function(){};if(!(typeof exports==="undefined")){module.exports=Formulas}},{"../shared/js/itemtypes":168,"./utils":146}],97:[function(require,module,exports){var Entity=require("./entity");var Utils=require("./utils");var Messages=require("./message");var Gather=Entity.extend({init:function(id,kind,x,y,map,level){this._super(id,Types.EntityTypes.GATHER,kind,x,y,map);this.stats={};this.level=level;this.setDrops();this.spawnDelay=6e4},getState:function(){var arr=this._getBaseState();return arr.concat([this.level,0,0])},onDeath:function(callback){this.death_callback=callback},die:function(){this.isDead=true;this.map.entities.pushNeighbours(this,new Messages.Despawn(this));this.handleRespawn();if(this.death_callback){this.death_callback()}},setDrops:function(){this.drops={};if(this.level==1)this.drops[301]=2e3;if(this.level==2)this.drops[302]=2e3;if(this.level==3)this.drops[303]=2e3;else this.drops[304]=2e3},respawn:function(){this.isDead=false;this.map.entities.pushNeighbours(this,new Messages.Spawn(this))},handleRespawn:function(){var self=this;if(this.area&&this.area instanceof Area){this.area.respawn(this,this.spawnDelay)}else{setTimeout((function(){self.respawn();if(self.respawnCallback){self.respawnCallback()}}),this.spawnDelay)}}});module.exports=Gather},{"./entity":91,"./message":112,"./utils":146}],98:[function(require,module,exports){var cls=require("./lib/class"),ItemRoom=require("./itemroom"),Messages=require("./message"),ItemTypes=require("../shared/js/itemtypes"),Types=require("../shared/js/gametypes");module.exports=Inventory=cls.Class.extend({init:function(owner,number,items){this.owner=owner;this.number=number;this.maxNumber=48;this.maxStack=100;this.rooms={};console.info("number="+number);if(items){for(var i=0;i<items.length;i++){this.rooms[items[i].slot]=items[i]}}},hasItem:function(itemKind){return this.hasItems(itemKind,1)},hasItems:function(itemKind,itemCount){var a=0;for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind===itemKind){a+=this.rooms[i].itemNumber;if(a>=itemCount)return true}}return false},hasItemCount:function(itemKind){var a=0;for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind===itemKind){a+=this.rooms[i].itemNumber}}return a},hasRoomConsumable:function(){return this.hasRoom(0,6)},hasRoom:function(start,end){start=typeof start==="undefined"?6:start;end=end||this.maxNumber;for(var i=start;i<end;i++){if(!this.rooms[i]){return true}}return false},makeEmptyItem:function(index){this.rooms[index]=null;delete this.rooms[index];this.setItem(index,null)},getItemCount:function(itemKind){for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind==itemKind){return this.rooms[i].itemNumber}}return 0},getItemIndex:function(itemKind){for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind==itemKind){return i}}return-1},getEmptyIndex:function(start,end){if(typeof start==="undefined")start=6;end=end||this.maxNumber;for(var index=start;index<end;index++){if(!this.rooms[index]){return index}}return-1},putItem:function(item){var maxNumber=48;var consume=ItemTypes.isConsumableItem(item.itemKind);var loot=ItemTypes.isLootItem(item.itemKind);var craft=ItemTypes.isCraftItem(item.itemKind);if(consume)maxNumber=6;if(consume||loot||craft){for(var i in this.rooms){var slot=this.combineItem(item,this.rooms[i]);if(slot>=0)return slot}}return this._putItem(item)},combineItem:function(item,item2){console.info(JSON.stringify(item));console.info(JSON.stringify(item2));if(!item||!item2)return-1;if(item.itemKind!=item2.itemKind)return-1;if(ItemTypes.isEquippable(item.itemKind)||ItemTypes.isEquippable(item2.itemKind)){return-1}var slot=item.slot;var slot2=item2.slot;if(item2.itemNumber<this.maxStack){item2.itemNumber+=item.itemNumber;if(item2.itemNumber>this.maxStack){item.itemNumber=item2.itemNumber-this.maxStack;item2.itemNumber=Math.min(item2.itemNumber,this.maxStack)}else{item=null}}if(item2.itemNumber<=0){item2=null}this.setItem(slot,item);this.setItem(slot2,item2);return slot2},_putItem:function(item){var i=0;var maxNumber=48;if(ItemTypes.isConsumableItem(item.itemKind)){maxNumber=6}else{i=6}i=this.getEmptyIndex(i,maxNumber);if(i<0){if(this.owner instanceof Player)this.owner.map.entities.pushToPlayer(this.owner,new Messages.Notify("INVENTORY","INVENTORY_FULL"));return-1}else{this.setItem(i,item);return i}},checkItem:function(index,item){if(!item)return true;if(index<6&&!ItemTypes.isConsumableItem(item.itemKind))return false;return true},setItem:function(index,item){if(!item){this.rooms[index]=null;item={slot:index,itemKind:-1}}else{if(!this.checkItem(index,item))return false;this.rooms[index]=item;item.slot=index}this.owner.map.entities.pushToPlayer(this.owner,new Messages.ItemSlot(0,[item]));return true},save:function(){databaseHandler.saveItems(this.owner,0,this.rooms)},removeItemKind:function(kind,number){var j=number;for(var i in this.rooms){var r=this.rooms[i];if(!r)continue;if(r.itemKind==kind){if(r.itemNumber>j){r.itemNumber-=j;this.setItem(i,r);return true}else{j-=r.itemNumber;r=null}this.setItem(i,r)}}return false},takeOutItems:function(index,number){var item=this.rooms[index];if(!item)return null;if(number>item.itemNumber)return null;if(ItemTypes.isEquippable(item.itemKind)){this.setItem(index,null);return item}item.itemNumber-=number;if(item.itemNumber==0)item=null;this.setItem(index,item);return item},getRandomItemNumber:function(){var i=0;var index=-1;var item=null;var len=this.rooms.length;while(i<len){index=~~Utils.randomRange(0,len-1);item=this.rooms[index];if(item&&item.itemKind>0)return index;++i}return-1},toString:function(){var i=0;var itemString=""+this.maxNumber+",";for(i=0;i<this.maxNumber;i++){var item=this.rooms[i];if(!item)continue;itemArray=[item.itemKind,item.itemNumber,item.itemDurability,item.itemDurabilityMax,item.itemExperience];itemString+=itemArray.join(",")}return itemString},toStringJSON:function(){var itemString="[";var isItems=false;for(var i=0;i<this.maxNumber;i++){var item=this.rooms[i];if(!item)continue;itemArray=[i,item.itemKind,item.itemNumber,item.itemDurability,item.itemDurabilityMax,item.itemExperience];itemString+="["+itemArray.join(",")+"],";isItems=true}itemString=itemString.slice(0,-1);itemString+="]";if(!isItems)return"[]";return itemString}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./itemroom":101,"./lib/class":105,"./message":112}],99:[function(require,module,exports){var Entity=require("./entity"),ItemTypes=require("../shared/js/itemtypes");var ItemData=require("./items");module.exports=Item=Entity.extend({init:function(type,id,itemRoom,x,y,map){var kind=itemRoom.itemKind;this._super(id,type,kind,x,y,map);this.isStatic=false;this.isFromChest=false;this.orientation=Types.Orientations.DOWN;this.experience=0;this.data=ItemData.Kinds[kind];this.room=itemRoom},handleDespawn:function(params){var self=this;this.blinkTimeout=setTimeout((function(){params.blinkCallback();self.despawnTimeout=setTimeout(params.despawnCallback,params.blinkingDuration)}),params.beforeBlinkDelay)},destroy:function(){if(this.blinkTimeout){clearTimeout(this.blinkTimeout)}if(this.despawnTimeout){clearTimeout(this.despawnTimeout)}if(this.isStatic){this.scheduleRespawn(3e4)}},scheduleRespawn:function(delay){var self=this;setTimeout((function(){if(self.respawnCallback){self.respawnCallback()}}),delay)},onRespawn:function(callback){this.respawnCallback=callback},getState:function(){return[parseInt(this.id,10),parseInt(this.type),parseInt(this.room.itemKind),this.data&&this.data.hasOwnProperty("name")?this.data.name:"",parseInt(this.map.index),parseInt(this.x),parseInt(this.y),parseInt(this.orientation),parseInt(this.room.itemNumber)]},getName:function(){return this.data.name},toString:function(){return this.room.itemKind+" "+this.room.itemNumber+" "+this.room.itemDurability+" "+this.room.itemDurabilityMax+" "+this.room.itemExperience+" "+this.x+" "+this.y}})},{"../shared/js/itemtypes":168,"./entity":91,"./items":102}],100:[function(require,module,exports){var _=require("underscore");var ItemLootJson=require("../shared/data/itemloot.json");var ItemLoot=[];_.each(ItemLootJson,(function(val,key){ItemLoot[key]={name:val.name,rarity:val.rarity,sprite:val.sprite,offset:val.offset,include:val.include?val.include:null}}));module.exports.ItemLoot=ItemLoot},{"../shared/data/itemloot.json":153,underscore:75}],101:[function(require,module,exports){var cls=require("./lib/class"),Types=require("../shared/js/gametypes"),ItemTypes=require("../shared/js/itemtypes");module.exports=ItemRoom=cls.Class.extend({init:function(itemKind,itemNumber,itemDurability,itemDurabilityMax,itemExperience){this.set(itemKind,itemNumber,itemDurability,itemDurabilityMax,itemExperience)},assign:function(itemRoom){this.set(itemRoom.itemKind,itemRoom.itemNumber,itemRoom.itemDurability,itemRoom.itemDurabilityMax,itemRoom.itemExperience)},set:function(itemKind,itemNumber,itemDurability,itemDurabilityMax,itemExperience){this.slot=-1;this.itemKind=itemKind;this.itemNumber=itemNumber;this.itemDurability=itemDurability?itemDurability:ItemTypes.isConsumableItem(itemKind)||ItemTypes.isCraftItem(itemKind)?0:900;this.itemDurabilityMax=itemDurabilityMax?itemDurabilityMax:ItemTypes.isConsumableItem(itemKind)||ItemTypes.isCraftItem(itemKind)?0:900;this.itemExperience=itemExperience||0},addNumber:function(number){this.itemNumber+=number},save:function(){var cols=[this.itemKind,this.itemNumber,this.itemDurability,this.itemDurabilityMax,this.itemExperience];return cols.join(",")},toArray:function(){var cols=[parseInt(this.slot),this.itemKind,this.itemNumber,this.itemDurability,this.itemDurabilityMax,this.itemExperience];return cols}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./lib/class":105}],102:[function(require,module,exports){var _=require("underscore"),ItemTypes=require("../shared/js/itemtypes"),ItemsJson=require("../shared/data/items2.json"),CraftData=require("../shared/data/craft.json");var id=0;for(var craft of CraftData){craft.id=id++}var getCraftData=function(index){var data=[];for(var craft of CraftData){if(craft.o==index)data.push(craft)}return data};var KindData={};KindData[0]=null;_.each(ItemsJson,(function(itemValue,key){KindData[itemValue.id]={name:itemValue.name,type:itemValue.type?itemValue.type:"object",damageType:itemValue.damageType?itemValue.damageType:"none",typemod:itemValue.typemod?itemValue.typemod:"none",modifier:itemValue.modifier?itemValue.modifier:0,hand:itemValue.hand?itemValue.hand:0,sprite:itemValue.sprite?itemValue.sprite:"",spriteName:itemValue.spriteName?itemValue.spriteName:"",offset:itemValue.offset?itemValue.offset:[0,0],buy:itemValue.buy?itemValue.buy:0,buycount:itemValue.buycount?itemValue.buycount:1,staticsheet:itemValue.staticsheet>0?itemValue.staticsheet:0,level:itemValue.level?itemValue.level:itemValue.modifier,legacy:itemValue.legacy?itemValue.legacy:0,craft:getCraftData(itemValue.id)}}));ItemTypes.setKindData(KindData);module.exports.Kinds=KindData;module.exports.CraftData=CraftData},{"../shared/data/craft.json":151,"../shared/data/items2.json":154,"../shared/js/itemtypes":168,underscore:75}],103:[function(require,module,exports){var _=require("underscore");var LangJson=require("../shared/data/lang.json");var LangData={};_.each(LangJson,(function(val,key){LangData[key]=val}));module.exports.Data=LangData},{"../shared/data/lang.json":155,underscore:75}],104:[function(require,module,exports){var Utils=require(".././utils");module.exports=AStar=function(){
/**
     * Advanced A* (A-Star) algorithm for a path finder.
     * This does pixel based path finding, for map grids and is an advance
     * on the original authors code.
     *
     * @originalAuthor  Andrea Giammarchi
     * @revisedAuthor  Langerz82
     * @license Mit Style License.
     */
var asGridCellSize=16;var gGrid=null;function diagonalSuccessors($N,$S,$E,$W,N,S,E,W,grid,rows,cols,result,i){if($N){$E&&!grid[N][E]&&(result[i++]={x:E,y:N});$W&&!grid[N][W]&&(result[i++]={x:W,y:N})}if($S){$E&&!grid[S][E]&&(result[i++]={x:E,y:S});$W&&!grid[S][W]&&(result[i++]={x:W,y:S})}return result}function diagonalSuccessorsFree($N,$S,$E,$W,N,S,E,W,grid,rows,cols,result,i){$N=N>-1;$S=S<rows;$E=E<cols;$W=W>-1;if($E){$N&&!grid[N][E]&&(result[i++]={x:E,y:N});$S&&!grid[S][E]&&(result[i++]={x:E,y:S})}if($W){$N&&!grid[N][W]&&(result[i++]={x:W,y:N});$S&&!grid[S][W]&&(result[i++]={x:W,y:S})}return result}function nothingToDo($N,$S,$E,$W,N,S,E,W,grid,rows,cols,result,i){return result}function grids(coord){return gGrid[~~coord[0]][~~coord[1]]}function successors(find,x,y,grid,rows,cols){x=~~x+.5;y=~~y+.5;var N=y-1,S=y+1,E=x+1,W=x-1,$N=N>0&&!grids([N,x]),$S=S<rows+1&&!grids([S,x]),$E=E<cols+1&&!grids([y,E]),$W=W>0&&!grids([y,W]),result=[],i=0;$N&&(result[i++]={x:x,y:N});$E&&(result[i++]={x:E,y:y});$S&&(result[i++]={x:x,y:S});$W&&(result[i++]={x:W,y:y});return find($N,$S,$E,$W,N,S,E,W,grid,rows,cols,result,i)}function diagonal(start,end,f1,f2){return f2(f1(start.x-end.x),f1(start.y-end.y))}function euclidean(start,end,f1,f2){var x=start.x-end.x,y=start.y-end.y;return f2(x*x+y*y)}function manhattan(start,end,f1,f2){return f1(start.x-end.x)+f1(start.y-end.y)}function getDir(n1,n2){if(n1.x<n2.x)return 1;if(n1.x>n2.x)return 2;if(n1.y<n2.y)return 3;if(n1.y>n2.y)return 4;return 0}function AStar(grid,start,end,f){gGrid=grid;var cols=grid[0].length,rows=grid.length,limit=cols*rows,f1=Math.abs,f2=Math.max,list={},result=[],open=[{x:~~start[0],y:~~start[1],f:0,g:0,v:start[0]+start[1]*cols}],length=1,adj,distance,find,i,j,max,min,current,next,endnode={x:~~end[0],y:~~end[1],v:~~end[0]+~~end[1]*cols};switch(f){case"Diagonal":find=diagonalSuccessors;case"DiagonalFree":distance=diagonal;break;case"Euclidean":find=diagonalSuccessors;case"EuclideanFree":f2=Math.sqrt;distance=euclidean;break;default:distance=manhattan;find=nothingToDo;break}find||(find=diagonalSuccessorsFree);do{max=limit;min=0;for(i=0;i<length;++i){if((f=open[i].f)<max){max=f;min=i}}current=open.splice(min,1)[0];if(current.v!=endnode.v){--length;next=successors(find,current.x,current.y,grid,rows,cols);for(i=0,j=next.length;i<j;++i){(adj=next[i]).p=current;adj.f=adj.g=0;adj.v=~~adj.x+~~adj.y*cols;if(!(adj.v in list)){var extra=0;if(adj.p){adj.dir=getDir(adj,adj.p);if(adj.p.dir&&adj.p.dir!=adj.dir)extra=2}adj.f=(adj.g=current.g+distance(adj,current,f1,f2))+distance(adj,endnode,f1,f2)+extra;open[length++]=adj;list[adj.v]=1}}}else{i=length=0;do{result[i++]=[current.x,current.y]}while(current=current.p);var fn=function(node,result){result.shift();result.unshift([node[0],node[1]]);var it2=null;for(var it of result){if(it2){if(~~it2[0]==~~it[0])it[0]=it2[0];else if(~~it2[1]==~~it[1])it[1]=it2[1];else{break}}it2=it}};fn(end,result);result.reverse();fn(start,result)}}while(length);for(var i=2;i<result.length;++i){if(Math.abs(result[i-2][0]-result[i][0])>0&&Math.abs(result[i-2][1]-result[i][1])==0||Math.abs(result[i-2][1]-result[i][1])>0&&Math.abs(result[i-2][0]-result[i][0])==0){result.splice(--i,1)}}return result}return{AStar:AStar}}();return AStar},{".././utils":146}],105:[function(require,module,exports){var initializing=false,fnTest=/xyz/.test((function(){xyz}))?/\b_super\b/:/.*/;Class=function(){};Class.extend=function(prop){var _super=this.prototype;initializing=true;var prototype=new this;initializing=false;for(var name in prop){prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"&&fnTest.test(prop[name])?function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret}}(name,prop[name]):prop[name]}Class=function(){if(!initializing&&this.init)this.init.apply(this,arguments)};Class.prototype=prototype;Class.constructor=Class;Class.extend=arguments.callee;return Class};if(!(typeof exports==="undefined")){exports.Class=Class}},{}],106:[function(require,module,exports){var cls=require("./lib/class"),Messages=require("./message"),AppearanceData=require("./appearancedata");module.exports=Looks=cls.Class.extend({init:function(){var length=AppearanceData.Data.length;this.prices=new Array(length);this.load();for(var i=0;i<length;i++){this.prices[i]=500}this.prices[0]=0;this.prices[50]=0;this.prices[77]=0;this.prices[151]=0},load:function(){console.info("LOOKS LOAD");databaseHandler.loadLooks(this.prices)},save:function(){console.info("LOOKS SAVED");if(this.prices)databaseHandler.saveLooks(this.prices)},modPrice:function(index,modPrice){this.prices[index]+=modPrice},pricesToString:function(){return this.prices.join(",")},sendLooks:function(player){player.map.entities.pushToPlayer(player,new Messages.AppearanceList(player.user,this))}})},{"./appearancedata":79,"./lib/class":105,"./message":112}],107:[function(require,module,exports){(function(__dirname){(function(){var fs=require("fs");var crypto=require("crypto");var Metrics=require("./metrics");var ProductionConfig=require("./productionconfig");var User=require("./user");var Utils=require("./utils");var redis=require("./redis");var _=require("underscore");var readline=require("readline").createInterface({input:process.stdin,output:process.stdout});let packageName="com.retrorpgonline2";let IO_STATES={MSG_BUYPRODUCT:1,MSG_ERRORPRODUCT:2};G_LATENCY=100;G_ROUNDTRIP=G_LATENCY*2;G_TILESIZE=16;G_FRAME_INTERVALS=1;G_UPDATE_INTERVAL_EXACT=1e3/60*G_FRAME_INTERVALS;G_UPDATE_INTERVAL=~~G_UPDATE_INTERVAL_EXACT;G_SPATIAL_SIZE=64;G_SCREEN_WIDTH=34;G_SCREEN_HEIGHT=18;ATTACK_INTERVAL=1e3;ATTACK_MAX=4e3;PLAYER_SAVE_INTERVAL=18e5;mobState={IDLE:1,ROAMING:2,AGGRO:3,CHASING:4,FIRSTATTACK:5,ATTACKING:6,RETURNING:7,STUCK:8};SAVING_SERVER=false;AUCTION_SAVED=false;PLAYERS_SAVED=false;worlds=[];users={};players=[];Log=require("log");var fs=require("fs");var util=require("util");var crypto=require("crypto");var log_file=fs.createWriteStream(__dirname+"/../console.log",{flags:"w"});var log_stdout=process.stdout;function main(config){log=new Log(Log.INFO||Log.DEBUG||Log.ERROR);console.isEnabled=true;Object.defineProperty(log,"log",{value:undefined,writable:true,enumerable:true});Object.defineProperty(log,"info",{value:undefined,writable:true,enumerable:true});Object.defineProperty(log,"warn",{value:undefined,writable:true,enumerable:true});Object.defineProperty(log,"error",{value:undefined,writable:true,enumerable:true});log.log=function(d){var txt="LOG: "+util.format(d)+"\n";console.info(txt)};log.info=function(d){var txt="INFO: "+util.format(d)+"\n";console.info(txt)};log.warn=function(d){var txt="WARN: "+util.format(d)+"\n";console.warn(txt)};log.error=function(d){var txt="ERROR: "+util.format(d)+"\n";console.error(txt)};var production_config=new ProductionConfig(config);if(production_config.inProduction()){_.extend(config,production_config.getProductionSettings())}var worldId=config.world_id;var ws=require("./ws");var WorldServer=require("./worldserver");var server=new ws.WebsocketServer(config);var metrics=config.metrics_enabled?new Metrics(config):null;var lastTotalPlayers=0;var self=this;var DatabaseSelector=require("./databaseselector");console.info("Initializing RRO2 GameServer - World "+worldId);var selector=DatabaseSelector(config);selector(config);DBH=databaseHandler=new selector(config);loadWorlds=function(){_.each(_.range(config.nb_worlds),(function(i){var world=new WorldServer("world"+i,config.nb_players_per_world,server,databaseHandler);world.run();world.name=config.world_name[i];worlds.push(world)}))};console.log("REDIS SERVER CREATED!!!!!!!!!!!!!");loadWorlds();server.onConnect((function(connection){var self=this;var current_date=(new Date).valueOf().toString();var random=Math.random().toString();var hash=crypto.createHash("sha1").update(current_date+random).digest("hex");connection.hash=hash;console.warn("onConnect: hash="+hash);var connect=function(config){var Types=require("../shared/js/gametypes");console.info(JSON.stringify(config));console.info("version sent");console.info(Types.Messages.SC_VERSION);connection.sendUTF8(Types.Messages.SC_VERSION+","+config.version+","+connection.hash);var worldsReply=Types.Messages.SC_WORLDS;for(var i=0;i<config.nb_worlds;++i){worldsReply+=","+i+","+worlds[i].name+","+worlds[i].getPopulation()+","+config.nb_players_per_world}connection.sendUTF8(worldsReply)};connect(config);self.enterWorld(connection)}));server.enterWorld=function(conn){var user=new User(self,conn);user.hashChallenge=conn.hash};server.onError((function(){console.error(Array.prototype.join.call(arguments,", "))}));server.onRequestStatus((function(){return JSON.stringify(getWorldDistribution(worlds))}));process.on("uncaughtException",(function(e){console.info(JSON.stringify(e));console.error("uncaughtException: "+e.stack)}));server._ioServer.on("connection",(socket=>{console.log("connected");socket.on("disconnect",(function(){console.log("disconnected")}));server._ioServer.on("msg",(message=>{console.log("msg="+JSON.stringify(message))}))}));var signalHandler=function(){closeServer();sleep(250);checkSaved();process.exit()};process.on("SIGINT",signalHandler);process.on("SIGTERM",signalHandler);process.on("SIGQUIT",signalHandler);var cmdPrompt=function(){if(process.platform==="win32"){readline.on("SIGINT",(function(){process.emit("SIGINT")}))}readline.question("Command:",(function(line){getInput(line);setTimeout(cmdPrompt,100)}))};cmdPrompt()}function modgems(args){var world=worlds[0];var playerName=args[0];var gems=args[1];var player=world.getPlayerByName(playerName);if(player&&player.user)player.user.modifyGems(gems);else databaseHandler.modifyGems(playerName,gems)}function modgold(args){var world=worlds[0];var playerName=args[0];var gold=args[1];var player=world.getPlayerByName(playerName);if(player)player.modifyGold(gold);else databaseHandler.modifyGold(playerName,gold)}function changePassword(args){var world=worlds[0];var username=args[0];var password=args[1];var hash=crypto.createHash("sha1").update(username+password).digest("hex");DBH.savePassword(username,hash)}function getInput(cmd){args=cmd.split(" ");cmdarg=args[0];args.shift();console.info("cmd: "+cmd);switch(cmdarg){case"modgems":modgems(args);break;case"modgold":modgold(args);break;case"setpass":changePassword(args);break;case"exit":case"quit":case"q":case"x":closeServer();process.exit(1);break;case"s":case"save":saveServer();break;case"forcequit":process.exit(1);break;case"reloadauction":reloadAuction();break;default:console.info("Unknown command.")}}function reloadAuction(){_.each(worlds,(function(world){world.auction.load()}))}function checkSaved(){var allSaved=setInterval((function(){if(PLAYERS_SAVED&&AUCTION_SAVED){clearInterval(allSaved);process.exit(1)}}),500)}var serverClosed=false;function closeServer(){if(serverClosed)return;serverClosed=true;readline.close();saveServer()}function sleep(ms){return new Promise((resolve=>setTimeout(resolve,ms)))}function saveServer(){console.log("saving server!");SAVING_SERVER=true;_.each(worlds,(function(world){world.save()}))}function getWorldDistribution(worlds){var distribution=[];_.each(worlds,(function(world){distribution.push(world.playerCount)}));return distribution}function getConfigFile(path,callback){fs.readFile(path,"utf8",(function(err,json_string){if(err){callback(null)}else{callback(JSON.parse(json_string))}}))}var defaultConfigPath="./config.json";var customConfigPath="./config_local.json";process.argv.forEach((function(val,index,array){if(index===2){customConfigPath=val}}));getConfigFile(defaultConfigPath,(function(defaultConfig){getConfigFile(customConfigPath,(function(localConfig){if(localConfig){main(localConfig)}else if(defaultConfig){main(defaultConfig)}else{console.error("Server cannot start without any configuration file.");process.exit(1)}}))}))}).call(this)}).call(this,require("path").join(__dirname,"js"))},{"../shared/js/gametypes":167,"./databaseselector":89,"./metrics":113,"./productionconfig":130,"./redis":133,"./user":145,"./utils":146,"./worldserver":147,"./ws":148,crypto:undefined,fs:undefined,log:60,path:undefined,readline:undefined,underscore:75,util:undefined}],108:[function(require,module,exports){var cls=require("./lib/class");_=require("underscore");var fs=require("fs");var file=require("../shared/js/file");var path=require("path");var Utils=require("./utils");var Checkpoint=require("./checkpoint");var Area=require("./area");var MapArea=require("./maparea");var Map=cls.Class.extend({init:function(id,name,filepath,filenameCollision){this.id=this.index=id;console.info("filepath: "+filepath+",filenameCollision: "+filenameCollision);var self=this;this.name=name;this.isLoaded=false;var filenameCollision=filenameCollision;file.exists(filepath,(function(exists){if(!exists){console.error(filepath+" doesn't exist.");return}fs.readFile(filepath,(function(err,file){var json=JSON.parse(file);self.initMap(json,filenameCollision)}))}));this.tilesize=G_TILESIZE},initMap:function(thismap,filenameCollision){this.width=thismap.width;this.height=thismap.height;this.chunkWidth=thismap.chunkWidth;this.chunkHeight=thismap.chunkHeight;this.chunkIndexes=thismap.chunkIndexes;this.collisions=thismap.collisions;this.mobAreas=thismap.roamingAreas;this.chestAreas=thismap.chestAreas;this.staticChests=thismap.staticChests;this.staticEntities=thismap.staticEntities;this.generateCollisions=true;this.zoneWidth=thismap.chunkWidth;this.zoneHeight=thismap.chunkHeight;this.groupWidth=Math.ceil(this.width/this.zoneWidth);this.groupHeight=Math.ceil(this.height/this.zoneHeight);this.initConnectedGroups(thismap.doors);this.loadTileGrid(thismap.data);this.loadCollisionGrid(thismap.collision);this.initCheckpoints(thismap.checkpoints);this.doors=this._getDoors(thismap);this.isLoaded=true;this.ready=true;this.readyFunc(this)},ready:function(f){this.readyFunc=f},tileIndexToGridPosition:function(tileNum){var x=0;var y=0;x=tileNum%this.width;y=Math.floor(tileNum/this.width);return{x:x*G_TILESIZE,y:y*G_TILESIZE}},GridPositionToTileIndex:function(x,y){return y*this.width+x+1},loadTileGrid:function(tiles){var self=this;this.tile=[];for(var j,i=0;i<this.height;i++){this.tile[i]=[];for(j=0;j<this.width;j++){this.tile[i][j]=tiles[i*this.width+j]}}},loadCollisionGrid:function(collisions){var self=this;this.grid=[];for(var j,i=0;i<this.height;i++){this.grid[i]=[];for(j=0;j<this.width;j++){this.grid[i][j]=collisions[i*this.width+j]==1?true:false}}},GroupIdToGroupPosition:function(id){var posArray=id.split("-");return pos(parseInt(posArray[0],10),parseInt(posArray[1],10))},forEachGroup:function(callback){var width=this.groupWidth;var height=this.groupHeight;for(var x=0;x<width;x+=1){for(var y=0;y<height;y+=1){callback(x+"-"+y)}}},getGroupIdFromPosition:function(x,y){var w=this.zoneWidth;var h=this.zoneHeight;var gx=Math.floor(x/w);var gy=Math.floor(y/h);return gx+"-"+gy},getAdjacentGroupPositions:function(id){var self=this;var position=this.GroupIdToGroupPosition(id);var x=position.x;var y=position.y;var list=[pos(x-1,y-1),pos(x,y-1),pos(x+1,y-1),pos(x-1,y),pos(x,y),pos(x+1,y),pos(x-1,y+1),pos(x,y+1),pos(x+1,y+1)];_.each(this.connectedGroups[id],(function(position){if(!_.any(list,(function(groupPos){return equalPositions(groupPos,position)}))){list.push(position)}}));return _.reject(list,(function(pos){return pos.x<0||pos.y<0||pos.x>=self.groupWidth||pos.y>=self.groupHeight}))},forEachAdjacentGroup:function(groupId,callback){if(groupId){_.each(this.getAdjacentGroupPositions(groupId),(function(pos){callback(pos.x+"-"+pos.y)}))}},initConnectedGroups:function(doors){var self=this;this.connectedGroups={};_.each(doors,(function(door){var groupId=self.getGroupIdFromPosition(door.x,door.y);var connectedGroupId=self.getGroupIdFromPosition(door.tx,door.ty);var connectedPosition=self.GroupIdToGroupPosition(connectedGroupId);if(groupId in self.connectedGroups){self.connectedGroups[groupId].push(connectedPosition)}else{self.connectedGroups[groupId]=[connectedPosition]}}))},initCheckpoints:function(cpList){var self=this;this.checkpoints={};this.startingAreas=[];_.each(cpList,(function(cp){var checkpoint=new Checkpoint(self,cp.id,cp.x,cp.y,cp.w,cp.h);self.checkpoints[checkpoint.id]=checkpoint;if(cp.s===1){self.startingAreas.push(checkpoint)}}))},getCheckpoint:function(id){return this.checkpoints[id]},getRandomStartingPosition:function(area){var nbAreas=_.size(this.startingAreas);var i=Utils.randomInt(nbAreas-1);if(!area)area=this.startingAreas[i];console.info("getRandomStartingPosition - none");if(this.index==1){var pos=this.getRandomPositionArea(500*G_TILESIZE,524*G_TILESIZE,500*G_TILESIZE,524*G_TILESIZE);return pos}if(area)return area.getRandomPosition();else{return null}},isColliding:function(x,y){var x1=~~(x>>4),y1=~~(y>>4),x2=~~(x1+.5),y2=~~(y1+.5);var arr=[[x1,y1],[x1,y2],[x2,y1],[x2,y2]];var c=arr[0];if(this.isOutOfBounds(c[0],c[1])){return true}c=arr[3];if(this.isOutOfBounds(c[0],c[1])){return true}c=null;for(c of arr){if(this.isCollidingGrid(c[0],c[1])){return true}}return false},isCollidingGrid:function(x,y){return this.grid[y][x]===true},isOutOfBounds:function(x,y){return!_.isNumber(x)||!_.isNumber(y)||(x<0||x>=this.width||y<0||y>=this.height)},isValidPosition:function(x,y){var self=this;return _.isNumber(x)&&_.isNumber(y)&&!self.isOutOfBounds(x,y)&&!self.isColliding(x,y)},getRandomPositionCollide:function(collide){collide=collide||[0,0,0,0];var self=this;var pos={};pos.x=Utils.randomRangeInt(0-collide[0],self.width-1-collide[2]);pos.y=Utils.randomRangeInt(0-collide[1],self.height-1-collide[3]);var tries=0;while(tries<25&&!self.isValidPosition(pos.x+collide[0],pos.y+collide[1],pos.x+collide[2],pos.y+collide[3])){++tries;pos.x=Utils.randomRangeInt(0-collide[0],self.width-1-collide[2]);pos.y=Utils.randomRangeInt(0-collide[1],self.height-1-collide[3])}if(tries>=25){pos.x=-1;pos.y=-1;console.log("getRandomPosition()-tries="+tries)}return pos},getRandomPositionArea:function(x1,x2,y1,y2){var pos={};var ts=this.tilesize;x1=Utils.clamp(0,this.width*ts,x1);x2=Utils.clamp(0,this.width*ts,x2);y1=Utils.clamp(0,this.height*ts,y1);y2=Utils.clamp(0,this.height*ts,y2);pos.x=Utils.randomRangeInt(x1,x2);pos.y=Utils.randomRangeInt(y1,y2);var tries=0;while(tries<20){if(!this.isColliding(pos.x,pos.y))break;++tries;pos.x=Utils.randomRangeInt(x1,x2);pos.y=Utils.randomRangeInt(y1,y2)}if(tries>=20){pos.x=-1;pos.y=-1;console.log("getRandomPosition()-tries="+tries)}return pos},getRandomPosition:function(){var self=this;var pos={};pos.x=Utils.randomRangeInt(0,self.width*self.tilesize);pos.y=Utils.randomRangeInt(0,self.height*self.tilesize);var tries=0;while(tries<20&&!self.isColliding(pos.x,pos.y)){++tries;pos.x=Utils.randomRangeInt(0,self.width*self.tilesize);pos.y=Utils.randomRangeInt(0,self.height*self.tilesize)}if(tries>=20){pos.x=-1;pos.y=-1;console.log("getRandomPosition()-tries="+tries)}return pos},_getDoors:function(map){var self=this;console.info(JSON.stringify(map.doors));var doors=[];_.each(map.doors,(function(door){door.width=door.width?door.width:1;door.height=door.height?door.height:1;console.info("door.tmap="+door.tmap);var area=new MapArea(map,false,door.x,door.y,door.width,door.height,-1);area.minLevel=door.tminLevel||0,area.maxLevel=door.tmaxLevel||200,area.map=door.tmap?door.tmap:1,area.portal=door.p===1,area.quest=door.tq,area.admin=door.a;switch(door.to){case"u":area.orientation=Types.Orientations.UP;break;case"d":area.orientation=Types.Orientations.DOWN;break;case"l":area.orientation=Types.Orientations.LEFT;break;case"r":area.orientation=Types.Orientations.RIGHT;break;default:area.orientation=Types.Orientations.DOWN}doors.push(area)}));console.info("return doors");return doors},isDoor:function(x,y){return _.detect(this.doors,(function(door){return door.contains({x:x,y:y})!=null}))},getDoor:function(entity){return _.detect(this.doors,(function(door){return door.contains(entity)}))},getSubCoordinate:function(x,y){x=x%(this.chunkWidth*this.tilesize);y=y%(this.chunkHeight*this.tilesize);return[x,y]},getSubIndex:function(x,y){return~~(y/(this.chunkHeight*this.tilesize)*this.chunkHeight+x/(this.chunkWidth*this.tilesize))},isHarvestTile:function(pos,type){console.info("isHarvestTile");if(this.isOutOfBounds(pos.gx,pos.gy))return false;var tiles=this.getTiles(pos.gx,pos.gy);console.info("tiles: "+JSON.stringify(tiles));if(!tiles||tiles.length==0)return false;log.info("tiles="+JSON.stringify(tiles));var types={};types.axe=[678,679,698,699,855,875,274,275,294,295];if(!types.hasOwnProperty(type))return false;var res=types[type].some((function(tile){return tiles.includes(tile)}));return res},getTiles:function(gx,gy){return this.tile[gy][gx]}});var pos=function(x,y){return{x:x,y:y}};var equalPositions=function(pos1,pos2){return pos1.x===pos2.x&&pos2.y===pos2.y};module.exports=Map},{"../shared/js/file":166,"./area":80,"./checkpoint":86,"./lib/class":105,"./maparea":109,"./utils":146,fs:undefined,path:undefined,underscore:75}],109:[function(require,module,exports){var cls=require("./lib/class");var MapArea=cls.Class.extend({init:function(map,elipse,x,y,width,height){this.map=map;this.elipse=elipse;this.x=x*G_TILESIZE;this.y=y*G_TILESIZE;this.width=width*G_TILESIZE;this.height=height*G_TILESIZE},contains:function(entity){if(!elipse){if(entity){return entity.x>=this.x&&entity.y>=this.y&&entity.x<this.x+this.width&&entity.y<this.y+this.height}else{return false}}if(elipse){if(entity){var cx=this.x+this.width/2;var cy=this.y+this.height/2;var d=Math.sqrt(Math.pow(entity.x-cx,2)+Math.pow(entity.y-cy,2));var inElipse=d<this.width/2&&d<this.height/2;console.log("this.elipseId="+this.elipseId);return inElipse}else{return false}}}});module.exports=MapArea},{"./lib/class":105}],110:[function(require,module,exports){var cls=require("./lib/class");_=require("underscore");var path=require("path");var Utils=require("./utils");var Chest=require("./chest");var Messages=require("./message");var NpcStatic=require("./npcstatic");var MobData=require("./mobdata");var NpcData=require("./npcdata");var ItemTypes=require("../shared/js/itemtypes");var SkillData=require("./skilldata");var MobCallback=require("./mobcallback");var MobAI=require("./mobai");var MapEntities=cls.Class.extend({init:function(id,server,map,database){var self=this;self.id=id;self.map=map;self.server=server;self.database=database;self.entities={};self.players={};self.npcplayers={};self.mobs={};self.items={};self.equipping={};self.hurt={};self.npcs={};self.chests={};self.blocks={};self.spatial=[];var spatialWidth=Math.ceil(self.map.width/G_SPATIAL_SIZE);var spatialHeight=Math.ceil(self.map.height/G_SPATIAL_SIZE);for(var i=0;i<spatialHeight;i++){self.spatial[i]=[];for(var j=0;j<spatialWidth;j++){self.spatial[i][j]={}}}self.packets={};self.mobAreas=[];self.chestAreas=[];self.groups={};self.pathfinder=null;self.pathingGrid=null;self.zoneGroupsReady=false;self.maxPackets=8;self.entityCount=0;this.mobCallback=null;this.mobAI=null;this.cellsize=G_TILESIZE;this.harvest={}},getSpatialEntities:function(arr){var x1=~~(Math.max(arr[0],0)/G_SPATIAL_SIZE);var y1=~~(Math.max(arr[1],0)/G_SPATIAL_SIZE);var x2=~~(Math.min(arr[2],this.map.width)/G_SPATIAL_SIZE);var y2=~~(Math.min(arr[3],this.map.height)/G_SPATIAL_SIZE);var res={};for(var j=y1;j<=y2;++j){for(var i=x1;i<=x2;++i){for(var[id,entity]of Object.entries(this.spatial[j][i])){if(!entity)continue;res[id]=entity}}}return res},mapready:function(){this.initPathFinder();this.initPathingGrid();this.mobCallback=new MobCallback(this.server,this.map);this.mobAI=new MobAI(this.server,this.map)},initPathFinder:function(){this.pathfinder=new Pathfinder(this.map.width,this.map.height)},spawnNpcs:function(count){var npc;for(var i=0;i<count;++i){npc=this._createNpc("Npc"+i)}},_createNpc:function(name){var self=this;pos=self.spaceEntityRandomApart(2,(function(){return self.map.getRandomPosition()}));var npc=new NpcMove(++self.entityCount,0,pos.x*16,pos.y*16,self.map);self.addNpcPlayer(npc);return npc},initPathingGrid:function(){var map=this.map,self=this;console.info("pathinggrid height:"+map.height+", width:"+map.width);var grid=new Array(map.height);for(var i=0;i<map.height;i+=1){grid[i]=new Array(map.width);for(var j=0;j<map.width;j+=1){if(map.grid[i][j])grid[i][j]=1;else grid[i][j]=0}}self.entitygrid=grid.slice(0);self.pathingGrid=grid.slice(0);console.info("Initialized the pathing grid with static colliding cells.")},processWho:function(player){var self=this;var screens=[];var ids=[];var knowns=[];var ids=player.knownIds;ids=ids.parseInt();var pgx=~~(player.x/G_TILESIZE);var pgy=~~(player.y/G_TILESIZE);var x1=pgx-32;var y1=pgy-18;var x2=pgx+32;var y2=pgy+18;var entities=this.getSpatialEntities([x1,y1,x2,y2]);_.each(entities,(function(entity){if(entity&&!(entity==player)&&self.isOffset(player,entity))screens.push(entity.id)}));var screenIds=ids&&ids.length>0?_.difference(screens,ids):screens;_.each(screenIds,(function(id){var entity=self.getEntityById(id);if(entity&&!(entity==player)){player.knownIds.push(entity.id);self.pushToPlayer(player,entity.spawn())}}))},isOffset:function(entity,entity2,extra,cameraHalfX,cameraHalfY){extra=(extra||0)*G_TILESIZE;cameraHalfX=(cameraHalfX||32)*G_TILESIZE;cameraHalfY=(cameraHalfY||18)*G_TILESIZE;var minX=Math.max(0,entity.x-cameraHalfX-extra);var minY=Math.max(0,entity.y-cameraHalfX-extra);var maxX=Math.min(this.map.width*G_TILESIZE,entity.x+cameraHalfX+extra);var maxY=Math.min(this.map.height*G_TILESIZE,entity.y+cameraHalfX+extra);if(entity2.y>=minY&&entity2.y<=maxY&&entity2.x>=minX&&entity2.x<=maxX){return true}else{return false}},processPackets:function(){var self=this;var connection;if(self.packets.length>0)console.info(JSON.stringify(self.packets));for(var id in self.packets){if(id!=null&&typeof id!=="undefined"){if(self.packets.hasOwnProperty(id)){if(self.packets[id].length>0&&typeof self.packets[id]!="undefined"&&self.packets[id]!=null){var player=self.getEntityById(id);if(player&&player.mapStatus>=2&&self.server.socket.getConnection(id)!=null&&typeof self.server.socket.getConnection(id)!="undefined"){connection=self.server.socket.getConnection(id);var packetCount=self.packets[id].length;var packet=[];for(var i=0;i<self.maxPackets;++i){if(self.packets[id].length==0)break;packet.push(self.packets[id].shift())}connection.send(packet)}else delete self.server.socket.getConnection(id)}}}}},pushToPlayer:function(player,message){if(!message)return;var self=this;if(player&&player.id in self.packets){self.packets[player.id].push(message.serialize())}},pushBroadcast:function(message,ignoredPlayer){if(!message)return;var self=this;for(var id in self.packets){if(self.packets.hasOwnProperty(id)){if(id!=ignoredPlayer){self.packets[id].push(message.serialize())}}}},pushNeighbours:function(entity,message,ignoredPlayer,areaLength){var self=this;areaLength=areaLength||30;var entities=self.getPlayerAround(entity,areaLength);if(entity instanceof Player)entities.push(entity);for(var entityId in entities){var neighbour=entities[entityId];if(neighbour instanceof Player){if(self.packets.hasOwnProperty(neighbour.id)&&!ignoredPlayer||ignoredPlayer&&neighbour!=ignoredPlayer){self.packets[neighbour.id].push(message.serialize())}}}},isMobsOnSameTile:function(mob){var X=mob.x,Y=mob.y,result=false,X2=0,Y2=0;if(mob.path&&mob.path.length>0){X=mob.path[mob.path.length-1][0];Y=mob.path[mob.path.length-1][1]}_.each(self.mobs,(function(entity){if(entity.isMoving()){X2=entity.path[entity.path.length-1][0];Y2=entity.path[entity.path.length-1][1]}else{X2=entity.x;Y2=entity.y}if(entity.id!=mob.id&&X==X2&&Y==Y2){result=true}}));return result},getFreeAdjacentNonDiagonalPosition:function(entity){var self=this,result=null;entity.forEachAdjacentNonDiagonalPosition((function(x,y,orientation){if(!result&&!self.map.isColliding(x,y)&&!self.isCharacterAt(x,y)){result={x:x,y:y,o:orientation}}}));return result},getFreeFutureAdjacentNonDiagonalPosition:function(entity){var self=this,result=[];entity.forEachFutureAdjacentNonDiagonalPosition((function(x,y,orientation){if(!self.map.isColliding(x,y)&&!self.isMobAt(x,y)){result.push({x:x,y:y,o:orientation})}}));return result},getRandomPosition:function(entity,threshold){var pos=[];var valid=false;var tries=10;var attempts=0;threshold*=G_TILESIZE;while(attempts++<tries&&(pos.y!=entity.y&&pos.x!=entity.x)){var r1=Utils.randomRangeInt(-threshold,threshold);var r2=Utils.randomRangeInt(-threshold,threshold);pos[0]=entity.x+r1;pos[1]=entity.y+r2;valid=!this.map.isColliding(pos[0],pos[1]);if(valid&&!(pos[0]==-1&&pos[1]==-1))return{x:pos[0],y:pos[1]}}console.info("getRandomPosition - failed");return null},handleOpenedChest:function(chest,player){var self=this;self.pushToAdjacentGroups(chest.group,chest.despawn());self.removeEntity(chest);var item=self.server.getDroppedOrStolenItem(player,chest,false);if(item&&item instanceof Item){item.x=chest.x;item.y=chest.y;chest.map.entities.pushBroadcast(new Messages.Spawn(item));self.server.handleItemDespawn(item)}chest.handleRespawn()},spawnStaticEntities:function(map){var self=this;var count=0;console.info(JSON.stringify(self.map.staticEntities));_.each(self.map.staticEntities,(function(kind,tid){var pos=map.tileIndexToGridPosition(tid);console.info("kind:"+kind);if(NpcData.isNpc(kind)){console.info("npc:"+kind+",x:"+pos.x+",y:"+pos.y);self.addNpc(kind,pos.x,pos.y)}}))},spawnEntity:function(kind,x,y,map){var self=this;var entity;if(NpcData.isNpc(kind)){entity=self.addNpc(kind,x,y,map)}else if(MobData.isMob(kind)){entity=self.addMob(kind,x,y)}return entity},addEntity:function(entity){this.entities[entity.id]=entity},addPlayer:function(player){console.info("addPlayer - player id: "+player.id);this.addEntity(player);this.players[player.id]=player;this.packets[player.id]=[]},addChest:function(chest){this.addEntity(chest);this.chests[chest.id]=chest},addBlock:function(block){this.addEntity(block);this.blocks[block.id]=block;return block},addMob:function(kind,x,y,area){var self=this;var mob=new Mob(++self.entityCount,kind,x,y,self.map,area);mob.mobAI=this.mobAI;mob.onMove(self.server.onMobMoveCallback.bind(self.server));this.mobCallback.setCallbacks(mob);this.addEntity(mob);this.mobs[mob.id]=mob;return mob},addNpc:function(kind,x,y){var self=this;var npc=new NpcStatic(++self.entityCount,kind,x,y,self.map);self.addEntity(npc);self.npcs[npc.id]=npc;return npc},addNpcPlayer:function(player){var self=this;self.addEntity(player);self.npcplayers[player.id]=player;return player},addItem:function(item){var self=this;self.addEntity(item);self.items[item.id]=item;return item},removeEntity:function(entity){var self=this;if(entity.id in self.entities)delete self.entities[entity.id];if(entity.id in self.mobs)delete self.mobs[entity.id];if(entity.id in self.items)delete self.items[entity.id];if(entity.id in self.players)delete self.players[entity.id];if(entity.id in self.chests)delete self.chests[entity.id];if(entity.id in self.blocks)delete self.blocks[entity.id];entity.destroy()},removePlayer:function(player){console.info("removePlayer-called");var self=this;if(player instanceof Player)player.packetHandler.broadcast(player.despawn());self.removeEntity(player);console.info("deleting player traces..");delete self.players[player.id];delete self.packets[player.id];delete self.entities[player.id];delete player;self.server.updatePopulation()},removeNpcPlayer:function(player){console.info("removePlayer-called");var self=this;self.pushBroadcast(player.despawn(0));self.removeEntity(player);delete self.npcplayers[player.id]},createItem:function(itemRoom,x,y){var id=++this.entityCount;var item=null;var type=Types.EntityTypes.ITEM;if(!ItemTypes.isEquippable(itemRoom.itemKind))type=Types.EntityTypes.ITEMLOOT;item=new Item(type,id,itemRoom,x,y,this.map);this.addItem(item);return item},addStaticItem:function(map,item){var self=this;item.isStatic=true;item.onRespawn(self.addStaticItem.bind(self,item));return self.addItem(item)},addItemFromChest:function(kind,x,y){var item=this.createItem(kind,x,y);item.isFromChest=true;return this.addItem(item)},getEntityById:function(id){var self=this;if(self.entities.hasOwnProperty(id))return self.entities[id];else;},getPlayerByName:function(name){for(var id in this.players){var player=this.players[id];if(player.name===name)return player}return null},setModifyGoldByName:function(name,mod){var player=this.getPlayerByName(name);if(player)player.modifyGold(mod);else this.database.modifyGold(name,mod)},getEntitiesByPosition:function(x,y){entities=[];this.forEachEntity((function(e){if(e.x==x&&e.y==y)entities.push(e)}));return entities},isCharacterAt:function(x,y){return this.entitygrid[y][x]===1},isMobAt:function(x,y){var result=false;this.forEachMob((function(mob){var X=mob.x,Y=mob.y;if(mob.path&&mob.path.length>0){X=mob.path[mob.path.length-1][0];Y=mob.path[mob.path.length-1][1]}if(x==X&&y==Y)result=true}));return result},forEachEntity:function(callback){var self=this;for(var id in self.entities){if(self.entities.hasOwnProperty(id))callback(self.entities[id])}},forEachPlayer:function(callback){var self=this;for(var id in self.players){if(self.players.hasOwnProperty(id))callback(self.players[id])}},forEachPartyPlayer:function(callback){var self=this;for(var id in self.players){if(self.players.hasOwnProperty(id))callback(self.players[id])}},forEachMob:function(callback){var self=this;for(var id in self.mobs){if(self.mobs.hasOwnProperty(id)){callback(self.mobs[id])}}},forEachCharacter:function(callback){var self=this;for(var id in self.entities){if(self.entities.hasOwnProperty(id)&&self.entities[id]instanceof Character)callback(self.entities[id])}},forEachNpcPlayer:function(callback){var self=this;for(var id in self.npcplayers){if(self.npcplayers.hasOwnProperty(id))callback(self.npcplayers[id])}},getEntityCount:function(group,entity,range,conditional){range*=G_TILESIZE;var x=entity.x;var y=entity.y;var r=range>>1;var count=0;var def_conditional=function(e,e2){return e!==e2};conditional=conditional||def_conditional;var e2=null;for(var id in group){if(group.hasOwnProperty(id)){e2=group[id];if(Math.abs(e2.x-x)<=range&&Math.abs(e2.y-y)<=range&&conditional(entity,e2)){count++}}}return count},getEntitySpatialCount:function(entity,range,conditional){range*=G_TILESIZE;var x=entity.x;var y=entity.y;var r=range>>1;var count=0;var def_conditional=function(e1,e2){return e1!==e2};conditional=conditional||def_conditional;var group=this.getSpatialEntities([x-r,y-r,x+r,y+r]);for(var e2 in group){if(conditional(entity,e2))count++}return count},getEntityAroundSpatial:function(entity,range,conditional){range*=G_TILESIZE;var r=range>>1;var x=entity.x;var y=entity.y;var entities=[];var def_conditional=function(e1,e2){return e1!==e2};conditional=conditional||def_conditional;var e2;var group=this.getSpatialEntities([x-r,y-r,x+r,y+r]);for(var id in group){e2=group[id];if(!e2)continue;if(conditional(entity,e2)){entities.push(e2)}}return entities},getEntityAround:function(group,entity,range,conditional){range*=G_TILESIZE;var x=entity.x;var y=entity.y;var entities=[];var def_conditional=function(e1,e2){return e1!==e2};conditional=conditional||def_conditional;var e2;for(var id in group){e2=group[id];if(!e2)continue;if(Math.abs(e2.x-x)<=range&&Math.abs(e2.y-y)<=range&&conditional(entity,e2)){entities.push(e2)}}return entities},getEachEntityAround:function(x,y,s){var x=~~(x/G_TILESIZE);var y=~~(y/G_TILESIZE);var entities=this.getSpatialEntities([x-s,y-s,x+s,y+s]);return this.getEntityAround(entities,{x:x,y:y},s)},getEntitiesAround:function(entity,range){var x=~~(entity.x/G_TILESIZE);var y=~~(entity.y/G_TILESIZE);var r=range>>1;var entities=this.getSpatialEntities([x-r,y-r,x+r,y+r]);return this.getEntityAround(entities,entity,r)},getCharactersAround:function(entity,range){return this.getEntityAround(this.entities,entity,range,null,(function(e1,e2){return e1!==e2&&e2 instanceof Character}))},getMobsAround:function(entity,range){return this.getEntityAround(this.mobs,entity,range)},getPlayerAround:function(entity,range){return this.getEntityAround(this.players,entity,range)},getEntityAroundCount:function(entity,range){return this.getEntityCount(this.entities,entity,range)},getPlayerAroundCount:function(entity,range){return this.getEntityCount(this.player,entity,range)},getPartyAround:function(entity,range){return this.getEntityAround(entity.party.players,entity,range)},itemDespawn:function(item){this.pushNeighbours(item,new Messages.Despawn(item));this.removeEntity(item)},handleEmptyChestArea:function(area){var self=this;if(area){self.handleItemDespawn(chest)}},tryAddingMobToChestArea:function(mob){var self=this;_.each(self.chestAreas,(function(area){if(area.contains(mob))area.addToArea(mob)}))},findPath:function(character,x,y,ignoreList){var self=this,path=[];if(this.pathfinder&&character){var grid=self.map.grid;var path=null;var pS=[character.x,character.y];var ts=G_TILESIZE;if(this.map.isColliding(character.x,character.y)){console.warn("findPath - isColliding start.");return null}var pE=[x,y];if(this.map.isColliding(x,y)){console.warn("findPath - isColliding end.");return null}if(pS[0]==pE[0]&&pS[1]==pE[1]){console.warn("findPath - path coordinates are the same.");return null}if(!path||path.length==0){if(pS[0]==pE[0]||pS[1]==pE[1]){mp=[pS,pE];if(this.pathfinder.isValidPath(grid,mp)){return mp}}var mp=[pS,[pS[0],pE[1]],pE];console.info("mp:"+JSON.stringify(mp));if(this.pathfinder.isValidPath(grid,mp)){return mp}mp=[pS,[pE[0],pS[1]],pE];console.info("mp:"+JSON.stringify(mp));if(this.pathfinder.isValidPath(grid,mp)){return mp}}if(!path||path.length==0){var shortGrid=this.pathfinder.getShortGrid(grid,pS,pE,3);path=this.pathfinder.findShortPath(shortGrid.crop,shortGrid.minX,shortGrid.minY,shortGrid.substart,shortGrid.subend)}if(!path||path.length==0){console.warn("findPath - DANGER - findPath LONGGG");path=this.pathfinder.findPath(grid,pS,pE,false)}if(!path)console.error("findPath - Error while finding the path to "+x+", "+y+" for "+character.id);return path}else{console.error("findPath - Error while finding the path to "+x+", "+y+" for "+character.id)}return path},spaceEntityRandomApart:function(dist,callback_func,entity){var pos=null;var count=1;var param=entity&&entity.collision?entity.collision:null;while(count>0){if(callback_func){pos=callback_func(param);count=pos?this.getEntityAroundCount({x:pos.x,y:pos.y},dist):0}}return pos},isGridPositionEmpty:function(x,y){console.info("isGridPositionEmpty: x="+x+",y="+y);if(this.map.isColliding(x,y))return false;var pos={x:x,y:y};var entities=this.getEntitiesAround(pos,1);if(entities.length==0)return true;for(var entity of entities){if(entity.isWithin(pos))return false}return true}});module.exports=MapEntities},{"../shared/js/itemtypes":168,"./chest":87,"./lib/class":105,"./message":112,"./mobai":115,"./mobcallback":117,"./mobdata":118,"./npcdata":121,"./npcstatic":124,"./skilldata":135,"./utils":146,path:undefined,underscore:75}],111:[function(require,module,exports){var cls=require("./lib/class");var Map=require("./map");var MapEntities=require("./mapentities");var Messages=require("./message");var Utils=require("./utils");var NpcMove=require("./npcmove");var BlockArea=require("./blockarea");var TrapArea=require("./traparea");var TrapGroup=require("./trapgroup");var MobData=require("./mobdata");var Gather=require("./gather");module.exports=MapManager=cls.Class.extend({storeMobAreas:function(map){var self=this;map.mobArea=[];var a;for(var i=0;i<map.mobAreas.length;++i){a=map.mobAreas[i];a.sMinLevel=a.sMinLevel||0;a.sMaxLevel=a.sMaxLevel||0;var area=new MobArea(a.id,a.nb,a.minLevel,a.maxLevel,a.x,a.y,a.width,a.height,a.include,a.exclude,a.definite,map,a.ellipse,a.excludeId,a.sMinLevel,a.sMaxLevel);map.mobArea.push(area)}return map.mobArea},spawnMobs:function(map){var self=this;for(a of map.mobArea){a.addMobs();a.spawnMobs()}},storeChestArea:function(map){var self=this;var chestAreas=[];_.each(map.chestAreas,(function(a){var area=new ChestArea(a.id,a.nb,a.minLevel,a.maxLevel,a.x,a.y,a.width,a.height,map);area.spawnChests();chestAreas.push(area)}));return chestAreas},init:function(server){var self=this;this.server=server;this.maps={};this.mapCount=0;this.id=0;this.mapInstances={};this.loaded=false;this.maps[0]=new Map(0,"map0","./maps/map0.json","");this.maps[0].ready((function(){var map=self.maps[0];map.entities=new MapEntities(self.id,self.server,map,self.server.database);map.entities.mapready();map.entities.spawnStaticEntities(map);map.enterCallback=function(player){var pos=map.getRandomStartingPosition();return pos};self.MapsReady()}));this.maps[1]=new Map(1,"map1","./maps/map1.json","");this.maps[1].ready((function(){var map=self.maps[1];map.entities=new MapEntities(self.id,self.server,map,self.server.database);map.entities.mapready();map.mobArea=[];var mobArea=new MobArea(0,30,0,1,512,512,50,50,[1],null,null,map,true,-1,null,null);map.mobArea.push(mobArea);var x=0;var y=0;var a=512;var b=512;var j=0;var j_max=0;var id=0;var offset=40;for(var i=0;i<40;i++){j_max+=i%2==0?1:0;var dir=i%4;for(var j=1;j<=j_max;j++){x=0;y=0;switch(dir){case 0:x=offset;break;case 1:y=offset;break;case 2:x=-offset;break;case 3:y=-offset;break}a+=x;b+=y;id++;mobArea=new MobArea(id,20,1+id,1+id,a,b,35,35,[id%Object.keys(MobData.Kinds).length],null,null,map,true,-1,null,null);map.mobArea.push(mobArea);var area=new Area(0,a-15,b-15,30,30,map,false,-1);var pos=area._getRandomPositionInsideArea(35);var npc=new NpcMove(++map.entities.entityCount,1+id,pos.x,pos.y,map);map.entities.addNpcPlayer(npc);if(id>0){var level=0;for(var k=0;k<10;++k){level=~~(id/10)+1;var pos=map.entities.spaceEntityRandomApart(2,area._getRandomPositionInsideArea.bind(area,100));var gather=new Gather(++map.entities.entityCount,2,pos.x,pos.y,map,level);gather.name="node"+level;gather.weaponType="hammer";area.addToArea(gather);map.entities.addEntity(gather)}}}}var npc=new NpcMove(++map.entities.entityCount,0,510*16,510*16,map);npc.name="Old Man";npc.scriptQuests=false;map.entities.addNpcPlayer(npc);self.spawnMobs(map);map.enterCallback=function(player){var pos=map.getRandomStartingPosition();return pos};self.MapsReady()}))},MapsReady:function(){this.mapCount++;console.info("mapCount="+this.mapCount);if(this.isMapsReady()&&!this.loaded){console.info("maps ready");this.readyFunc();this.loaded=true}},isMapsReady:function(){console.info("Maps Length: "+Object.keys(this.maps).length);return this.mapCount==Object.keys(this.maps).length},onMapsReady:function(readyFunc){this.readyFunc=readyFunc}})},{"./blockarea":84,"./gather":97,"./lib/class":105,"./map":108,"./mapentities":110,"./message":112,"./mobdata":118,"./npcmove":122,"./traparea":142,"./trapgroup":143,"./utils":146}],112:[function(require,module,exports){var _=require("underscore");var cls=require("./lib/class");var Types=require("../shared/js/gametypes");var Utils=require("./utils");var Messages={};module.exports=Messages;var Message=cls.Class.extend({});Messages.Spawn=Message.extend({init:function(entity){this.entity=entity},serialize:function(){var spawn=[Types.Messages.SC_SPAWN];return spawn.concat(this.entity.getState())}});Messages.Despawn=Message.extend({init:function(entity){this.id=entity.id;this.mapIndex=entity.map.index;this.x=entity.x;this.y=entity.y},serialize:function(){return[Types.Messages.SC_DESPAWN,this.id,this.mapIndex,this.x,this.y]}});Messages.SwapSprite=Message.extend({init:function(entity,animId){this.entity=entity;this.animId=animId},serialize:function(){return[Types.Messages.SC_SWAPSPRITE,this.entity.id,this.entity.kind,this.animId]}});Messages.Move=Message.extend({init:function(entity,orientation,state,x,y){this.time=Date.now(),this.entity=entity,this.orientation=orientation;this.state=state;this.x=x||this.entity.x;this.y=y||this.entity.y},serialize:function(){return[Types.Messages.SC_MOVE,this.time,this.entity.map.index,this.entity.id,parseInt(this.orientation),this.state,this.entity.moveSpeed,this.x,this.y]}});Messages.MovePath=Message.extend({init:function(entity,path){this.time=Date.now(),this.entity=entity,this.path=path,this.orientation=entity.orientation},serialize:function(){return[Types.Messages.SC_MOVEPATH,this.time,this.entity.map.index,this.entity.id,parseInt(this.orientation),this.entity.interrupted=this.entity.interrupted?1:0,this.entity.moveSpeed].concat(this.path)}});Messages.ChangePoints=Message.extend({init:function(entity,modhp,modep){this.id=entity.id;this.hp=entity.stats.hp;this.hpMax=entity.stats.hpMax;this.ep=entity.stats.ep||0;this.epMax=entity.stats.epMax||0;this.modhp=modhp;this.modep=modep},serialize:function(){return[Types.Messages.SC_CHANGEPOINTS,this.id,this.hp,this.hpMax,this.modhp,this.ep,this.epMax,this.modep]}});Messages.Error=Message.extend({init:function(message){this.message=message},serialize:function(){return[Types.Messages.SC_ERROR,this.message]}});Messages.Notify=Message.extend({init:function(group,message,vars){this.group=group;this.message=message;this.vars=vars||[]},serialize:function(){var arr=[Types.Messages.SC_NOTIFY,this.group,this.message];return arr.concat(this.vars)}});Messages.Quest=Message.extend({init:function(quest){this.quest=quest},serialize:function(){var arr=this.quest.toClient();return[Types.Messages.SC_QUEST].concat(arr)}});Messages.Achievement=Message.extend({init:function(achievement){this.achievement=achievement},serialize:function(){var arr=this.achievement.toClient(this.achievement);return[Types.Messages.SC_ACHIEVEMENT].concat(arr)}});Messages.Log=Message.extend({init:function(message){this.message=message;this.message.unshift(Types.Messages.SC_LOG)},serialize:function(){return this.message}});Messages.SkillLoad=Message.extend({init:function(index,exp){this.index=index;this.exp=exp},serialize:function(){return[Types.Messages.SC_SKILLLOAD,this.index,this.exp]}});Messages.SkillEffects=Message.extend({init:function(player,effects){this.id=player.id;this.effects=effects},serialize:function(){return[Types.Messages.SC_SKILLEFFECTS,this.id].concat(this.effects)}});Messages.SkillXP=Message.extend({init:function(skillXPs){this.skillXPs=skillXPs},serialize:function(){var arr=[Types.Messages.SC_SKILLXP];arr.push(skillXPs.length);arr.concat(skillXPs);return arr}});Messages.Chat=Message.extend({init:function(player,group,message){this.playerId=player.id;this.group=group;this.message=message},serialize:function(){return[Types.Messages.SC_CHAT,this.playerId,this.group,this.message]}});Messages.TeleportMap=Message.extend({init:function(entity,subIndex,status){this.entity=entity,this.subIndex=subIndex,this.status=status},serialize:function(){return[Types.Messages.SC_TELEPORT_MAP,this.entity.getMapIndex(),this.subIndex,this.status,this.entity.x,this.entity.y]}});Messages.Damage=Message.extend({init:function(data){var attacker=data[0];var target=data[1];this.entity1=attacker;this.entity2=target;this.hpMod=data[2];this.hp=target.stats.hp;this.hpMax=target.stats.hpMax;this.epMod=data[3];this.ep=target.stats.ep||0;this.epMax=target.stats.epMax||0;this.crit=data[4]?1:0;this.effects=data[5]},serialize:function(){var arr=[Types.Messages.SC_DAMAGE,this.entity1.id,this.entity2.id,this.entity1.orientation,this.hpMod,this.hp,this.hpMax,this.epMod,this.ep,this.epMax,this.crit];if(Array.isArray(this.effects)&&this.effects.length>0)arr.concat(this.effects);return arr}});Messages.StatInfo=Message.extend({init:function(player){this.player=player},serialize:function(){var data=[Types.Messages.SC_STATINFO,this.player.stats.attack,this.player.stats.defense,this.player.stats.health,this.player.stats.energy,this.player.stats.luck,this.player.stats.free];return data}});Messages.UpdateLook=Message.extend({init:function(player){this.player=player},serialize:function(){return[Types.Messages.SC_LOOKUPDATE,this.player.id,this.player.sprites[0],this.player.sprites[1],this.player.colors[0],this.player.colors[1]]}});Messages.AppearanceList=Message.extend({init:function(user,looks){this.looks=Utils.BinToHex(user.looks);this.prices=looks.prices},serialize:function(){return[Types.Messages.SC_APPEARANCE,this.looks].concat(this.prices)}});Messages.ItemSlot=Message.extend({init:function(type,items){this.type=type;this.items=items},serialize:function(){var msg=[Types.Messages.SC_ITEMSLOT,this.type,this.items.length];for(var item of this.items){var arr=null;if(item.itemKind==-1)arr=[item.slot,item.itemKind];else{arr=item.toArray()}msg=msg.concat(arr)}return msg}});Messages.ItemLevelUp=Message.extend({init:function(index,item){this.index=index;this.item=item},serialize:function(){if(this.item){return[Types.Messages.SC_ITEMLEVELUP,this.index,this.item.itemNumber,this.item.itemExperience]}}});Messages.Kill=Message.extend({init:function(entity,level,exp){this.entity=entity;this.level=level;this.exp=exp},serialize:function(){return[Types.Messages.SC_KILL,this.entity?this.entity.id:-1,this.level,this.exp]}});Messages.LevelUp=Message.extend({init:function(type,level,exp){this.type=type;this.level=level;this.exp=exp},serialize:function(){return[Types.Messages.SC_LEVELUP,this.type,this.level,this.exp]}});Messages.List=Message.extend({init:function(ids){this.ids=ids},serialize:function(){var list=this.ids;list.unshift(Types.Messages.SC_LIST);return list}});Messages.AuctionOpen=Message.extend({init:function(itemData){this.itemData=itemData},serialize:function(){return this.itemData}});Messages.Speech=Message.extend({init:function(entity,kind,value){this.entityid=entity.id;this.kind=kind;this.value=value},serialize:function(){return[Types.Messages.SC_SPEECH,this.entityid,this.kind,this.value]}});Messages.Gold=Message.extend({init:function(player){this.invgold=player.gold[0];this.bankgold=player.gold[1];this.gems=player.user.gems},serialize:function(){return[Types.Messages.SC_GOLD,this.invgold,this.bankgold,this.gems]}});Messages.BlockModify=Message.extend({init:function(entity,id,state){this.entity=entity;this.id=id;this.state=state},serialize:function(){var spawn=[Types.Messages.SC_SPAWN,this.id,this.state];return spawn.concat(this.entity.getState())}});Messages.PartyInvite=Message.extend({init:function(id){this.id=id},serialize:function(){return[Types.Messages.SC_PARTY,2,this.id]}});Messages.Party=Message.extend({init:function(members){this.members=members},serialize:function(){return[Types.Messages.SC_PARTY,1].concat(this.members)}});Messages.PlayerInfo=Message.extend({init:function(player){this.player=player},serialize:function(){return[Types.Messages.BI_PLAYERINFO,this.player.exp.base,this.player.exp.attack,this.player.exp.defense,this.player.exp.sword,this.player.exp.bow,this.player.exp.hammer,this.player.exp.axe,this.player.exp.logging,this.player.exp.mining]}});Messages.Looks=Message.extend({init:function(player){this.player=player;this.sprite1=player.sprites[0];this.sprite2=player.getWeaponSprite();if(player.isArcher()){this.sprite1=player.sprites[2]}},serialize:function(){return[Types.Messages.SC_LOOKS,this.player.id,this.player.isArcher()?1:0,this.sprite1,this.sprite2]}});Messages.Harvest=Message.extend({init:function(player,action,gx,gy){this.id=player.id;this.action=action;this.gx=gx;this.gy=gy},serialize:function(){return[Types.Messages.BI_HARVEST,this.id,this.action,this.gx,this.gy]}})},{"../shared/js/gametypes":167,"./lib/class":105,"./utils":146,underscore:75}],113:[function(require,module,exports){var _=require("underscore");var cls=require("./lib/class");var Metrics={};Metrics=cls.Class.extend({init:function(config){var self=this;this.config=config;this.client=new(require("memcache").Client)(config.memcached_port,config.memcached_host);this.client.connect();this.isReady=false;this.client.on("connect",(function(){console.info("Metrics enabled: memcached client connected to "+config.memcached_host+":"+config.memcached_port);self.isReady=true;if(self.readyCallback){self.readyCallback()}}))},ready:function(callback){this.readyCallback=callback},updatePlayerCounters:function(worlds,updatedCallback){var self=this;var config=this.config;var numServers=_.size(config.game_servers);var playerCount=_.reduce(worlds,(function(sum,world){return sum+world.playerCount}),0);if(this.isReady){this.client.set("player_count_"+config.server_name,playerCount,(function(){var totalPlayers=0;_.each(config.game_servers,(function(server){self.client.get("player_count_"+server.name,(function(error,result){var count=result?parseInt(result,10):0;totalPlayers+=count;numServers-=1;if(numServers===0){self.client.set("total_players",totalPlayers,(function(){if(updatedCallback){updatedCallback(totalPlayers)}}))}}))}))}))}else{console.error("Memcached client not connected")}},updateWorldDistribution:function(worlds){this.client.set("world_distribution_"+this.config.server_name,worlds)},updateWorldCount:function(){this.client.set("world_count_"+this.config.server_name,this.config.nb_worlds)},getOpenWorldCount:function(callback){this.client.get("world_count_"+this.config.server_name,(function(error,result){callback(result)}))},getTotalPlayers:function(callback){this.client.get("total_players",(function(error,result){callback(result)}))}});module.exports=Metrics},{"./lib/class":105,memcache:undefined,underscore:75}],114:[function(require,module,exports){var _=require("underscore");var Character=require("./character"),ChestArea=require("./chestarea"),Messages=require("./message"),MobArea=require("./mobarea"),MobData=require("./mobdata"),MobSpeech=require("./mobspeech"),Items=require("./items"),ItemLootData=require("./itemlootdata"),Utils=require("./utils"),ItemTypes=require("../shared/js/itemtypes");module.exports=Mob=Character.extend({init:function(id,kind,x,y,map,mobArea){this._super(id,Types.EntityTypes.MOB,kind,x,y,map);this.data=MobData.Kinds[this.kind];if(this.data.level>0)this.level=this.data.level;else{if(mobArea)this.level=Utils.randomRangeInt(Math.max(this.data.minLevel,mobArea.minLevel),Math.min(this.data.maxLevel,mobArea.maxLevel));else this.level=Utils.randomRangeInt(this.data.minLevel,this.data.maxLevel)}var tx=Number(x),ty=Number(y);this.spawnX=tx;this.spawnY=ty;this.stats.attack=this.data.attack*this.level;this.stats.defense=this.data.defense*this.level;this.stats.hp=Math.max(this.data.hp*this.level-40,1);this.stats.hpMax=this.stats.hp;this.stats.ep=this.data.ep*this.level;this.stats.epMax=this.stats.ep;this.stats.xp=this.data.xp*this.level;this.mod={attack:0,defense:0,damage:0,health:0};this.hatelist=[];this.hateCount=0;this.damageCount={};this.respawnTimeout=null;this.returnTimeout=null;this.isDead=false;this.aggroRange=this.data.aggroRange;this.attackRange=this.data.attackRange*G_TILESIZE;this.isAggressive=this.data.isAggressive;this.moveSpeed=this.data.moveSpeed;this.setMoveRate(this.moveSpeed);this.setAttackRate(this.data.attackRate);this.setAggroRate(this.data.reactionDelay>>2);this.setMoveAI(Utils.randomRangeInt(50,150));this.setItemLoot();this.setDrops();this.spawnDelay=this.data.respawn;this.canCall=true;this.orientation=Utils.randomOrientation();this.isReturning=false;this.target=null;this.droppedItem=false;this.isBlocking=false;this.freeze=false;this.aiState=mobState.IDLE;this.effects={}},setMoveAI:function(duration){this.moveAICooldown=new Timer(duration)},canMoveAI:function(){return this.moveAICooldown.isOver()},resetMoveAI:function(time){this.moveAICooldown.lastTime=time},setAggroRate:function(duration){this.aggroCooldown=new Timer(duration)},canAggro:function(){return this.aggroCooldown.isOver()},resetAggro:function(time){this.aggroCooldown.lastTime=time},awardExp:function(){var self=this;_.each(this.attackers,(function(attacker){var damage=self.damageCount[attacker.id];if(self.on_killed_callback)self.on_killed_callback(attacker,damage);var xp=~~(self.stats.xp*(damage/self.stats.hpMax));var diff=10;var div=1/diff;var mod=1+div+Utils.clamp(-diff,diff,self.level-attacker.level.base)*div;var xp=~~(xp*mod);attacker.incExp(xp);if(attacker.type==Types.EntityTypes.PLAYER){attacker.map.entities.pushToPlayer(attacker,new Messages.Kill(self,attacker.level.base,xp))}}));this.damageCount={}},onKilled:function(callback){this.on_killed_callback=callback},onDamage:function(attacker,hpMod,epMod,crit,effects){var hp=this.stats.hp;this._super(attacker,hpMod,epMod,crit,effects);var hpDiff=hp-this.stats.hp;if(hpDiff>0){console.info("onDamage hpMod:"+hpMod);if(!this.damageCount.hasOwnProperty(attacker.id))this.damageCount[attacker.id]=0;this.damageCount[attacker.id]+=hpDiff}},destroy:function(){this.isDead=true;this.forgetEveryone();this.clearTarget();this.resetBars();this.resetPosition();this.handleRespawn()},resetBars:function(){this.stats.hp=this.stats.hpMax;this.stats.ep=this.stats.epMax},hates:function(entity){return _.any(this.hatelist,(function(obj){return obj.entity===entity}))},increaseHateFor:function(entity,points){if(this.hates(entity)){_.detect(this.hatelist,(function(obj){return obj.entity===entity})).hate+=points}else{this.hatelist.push({entity:entity,hate:points})}if(this.returnTimeout){clearTimeout(this.returnTimeout);this.returnTimeout=null}},getMostHated:function(hateRank){var i,playerId,sorted=_.sortBy(this.hatelist,(function(obj){return obj.hate})),size=_.size(this.hatelist);if(sorted&&sorted[0]){return sorted[0].entity}return null},forgetPlayer:function(playerId){this.hatelist=_.reject(this.hatelist,(function(obj){return obj.entity.id===playerId}));if(this.hatelist.length===0){this.returnToSpawn()}},forgetEveryone:function(){this.hatelist=[];this.damageCount={};this.clearAttackerRefs();this.removeAttackers()},handleRespawn:function(){var self=this;if(this.area&&this.area instanceof MobArea){this.area.respawnMob(this,this.spawnDelay)}else{setTimeout((function(){self.respawnMob();if(self.respawnCallback){self.respawnCallback()}}),this.spawnDelay)}},onRespawn:function(callback){this.respawnCallback=callback;this.hasTalked=false},respawnMob:function(){this.forceStop();this.forgetEveryone();this.disengage();this.removeAttackers();this.isDead=false;this.droppedItem=false;this.setAiState(mobState.IDLE);this.map.entities.pushNeighbours(this,new Messages.Spawn(this))},resetPosition:function(){this.setPosition(this.spawnX,this.spawnY)},returnToSpawn:function(){if(this.aiState==mobState.RETURNING)return;this.setAiState(mobState.RETURNING);this.forceStop();if(this.hasTarget())this.clearTarget();this.forgetEveryone();this.freeze=false;if(this.x==this.spawnX&&this.y==this.spawnY){this.returnedToSpawn();return}this.go(this.spawnX,this.spawnY);console.warn("returnToSpawn - Path: "+JSON.stringify(this.path));if(!this.path||this.path.length==0){try{throw new Error}catch(err){console.error(err.stack)}this.returnedToSpawn()}else{var pathTicks=this.map.entities.pathfinder.getPathTicks(this.path,this.spawnX,this.spawnY);var delay=Math.max(0,~~(pathTicks/this.tick*G_UPDATE_INTERVAL));console.info("returnToSpawn.delay = "+delay);console.info("id="+this.id+",x="+this.spawnX+",y="+this.spawnY);setTimeout(function(){console.info("st - id="+this.id+",x="+this.spawnX+",y="+this.spawnY);this.returnedToSpawn()}.bind(this),delay)}},onMove:function(callback){this.moveCallback=callback},move:function(x,y){this.setPosition(x,y);this.orientation=Utils.getOrientationFromLastMove(this);if(this.moveCallback){this.moveCallback(this)}},distanceToPos:function(x,y){return Utils.distanceTo(this.x,this.y,x,y)},setItemLoot:function(){this.loot={};this.lootTotal=0;for(var lootId in ItemLootData.ItemLoot){var loot=ItemLootData.ItemLoot[lootId];var chance=~~(1e3/loot.rarity*loot.rarity);if(chance>0)this.loot[lootId]=chance;this.lootTotal+=this.loot[lootId]}this.lootTotal=~~this.lootTotal},setDrops:function(){this.drops={};var dropLevel=Math.ceil(this.level/10)*10;for(var kind in Items.Kinds){var item=Items.Kinds[kind];if(!item||item.legacy==1)continue;var diff=item.level-this.level;if(ItemTypes.isEquipment(kind)){if(diff>=0&&diff<5)this.drops[kind]=1;if(diff>=-5&&diff<0)this.drops[kind]=2;if(diff>=-10&&diff<-5)this.drops[kind]=5}}if(this.level>=15&&this.level<25)this.drops[310]=250;if(this.level>=25&&this.level<35)this.drops[311]=250;if(this.level>=35&&this.level<45)this.drops[312]=250;if(this.level>=45)this.drops[313]=250;if(this.level<20)this.drops[34]=250;else this.drops[36]=250},Speech:function(key,value){return null},getState:function(){return this._getBaseState().concat([this.level,this.stats.hp,this.stats.hpMax])},setAiState:function(state){this.aiState=state},die:function(){console.info("Entity is dead");this.isDead=true;this.map.entities.pushBroadcast(this.despawn());this.awardExp();this.destroy()},baseCrit:function(){var modDiff=0;var statDiff=this.stats.attack+this.mod.attack;var chance=~~Utils.clamp(5,500,~~(statDiff+modDiff));return chance},baseCritDef:function(){var modDiff=0;var statDiff=this.stats.defense+this.mod.defense;var chance=~~Utils.clamp(5,500,~~(statDiff+modDiff));return chance},baseDamage:function(){var dealt,absorbed,dmg;dealt=~~(this.level*6);dealt+=(this.stats.attack+this.mod.attack)*5.75;dmg=~~dealt;return dmg},baseDamageDef:function(){var dealt,absorbed,dmg;dealt=~~(this.level*2);dealt+=(this.stats.defense+this.mod.defense)*2;dmg=~~dealt;return dmg},canReach:function(entity){var o=this.orientation;this.lookAtEntity(entity);var res=this._super(entity);this.orientation=o;return res},dropGold:function(){return Utils.randomRangeInt(this.level*2,this.level*5)},returnedToSpawn:function(){console.info("mob.returnedToSpawn");this.forceStop();this.resetHP();this.setAiState(mobState.IDLE);this.resetPosition()}});module.exports=Mob},{"../shared/js/itemtypes":168,"./character":85,"./chestarea":88,"./itemlootdata":100,"./items":102,"./message":112,"./mobarea":116,"./mobdata":118,"./mobspeech":119,"./utils":146,underscore:75}],115:[function(require,module,exports){var Messages=require("./message"),_=require("underscore"),Utils=require("./utils"),Formulas=require("./formulas");module.exports=MobAI=Class.extend({init:function(ws,map){this.world=this.server=this.worldServer=ws;this.map=map},checkHitAggro:function(mob,sEntity){if(mob.isDead||mob.isStunned||mob.isAttacking())return;if(mob.aiState!==mobState.IDLE)return;if(mob.hasTarget())return;if(mob.isAttackedBy(sEntity))this.aggroPlayer(mob,sEntity);return},checkAggro:function(mob){if(mob.isDead||mob.isStunned||mob.isAttacking()||!mob.isAggressive){return}if(mob.aiState!=mobState.IDLE){return}if(mob.hasTarget()){return}var players=this.map.entities.getPlayerAround(mob,mob.aggroRange);for(var player of players){if(player.isDead||player.freeze){continue}if(mob.level*2>=player.level.base){this.aggroPlayer(mob,player)}}},aggroPlayer:function(mob,player,dmg){var self=this;var ws=this.worldServer;dmg=dmg||1;mob.resetAggro(0);mob.attackingMode=true;ws.handleMobHate(mob,player,1);ws.createAttackLink(mob,player);mob.setAiState(mobState.AGGRO);mob.attackTimer=Date.now()},checkHit:function(mob){var self=this;if(mob.isStunned||!mob.target||mob.freeze)return;if(mob.aiState===mobState.FIRSTATTACK){mob.setFreeze(mob.data.reactionDelay,(function(){mob.setAiState(mobState.ATTACKING)}));return}if(!mob.canReach(mob.target)){mob.setAiState(mobState.CHASING);return}if(mob.aiState!==mobState.ATTACKING)return;if(mob.canAttack()){console.info("mob - Is Attacking");this.handleHurt(mob)}},update:function(){for(var mobId in this.map.entities.mobs){var mob=this.map.entities.mobs[mobId];if(mob.isDead)continue;if(mob.aiState==mobState.RETURNING)return;if(mob.canAggro())this.checkAggro(mob);if(mob.hasTarget()){this.checkChase(mob);this.checkHit(mob)}}},checkChase:function(mob){var target=mob.target;if(mob.freeze){return}if(target.isDead||target.isDying){return}if(mob.aiState===mobState.IDLE){mob.setAiState(mobState.AGGRO)}if(!(mob.aiState===mobState.AGGRO||mob.aiState===mobState.CHASING)){return}if(!mob.canReach(target)){if(mob.isMovingPath()){return}if(!target.isMoving()&&mob.ptx==mob.target.x&&mob.pty==mob.target.y){return}if(mob.isMoving()&&target.isMoving()){console.info(mob.id+" monster and target is moving so abort.");return}if(mob.canMoveAI()){if(this.checkReturn(mob))return;mob.follow(target);mob.setAiState(mobState.CHASING);mob.setMoveAI(Utils.randomRangeInt(25,50));mob.ptx=target.x;mob.pty=target.y;if(!mob.path){mob.returnToSpawn();return}}}else{if(!mob.isMovingPath()){if(mob.isOverlapping()){mob.follow(target);return}mob.forceStop();console.info(mob.id+" within range");mob.setAiState(mobState.FIRSTATTACK)}}},handleHurt:function(mob){var self=this;if(!mob.target)return;if(mob.target.isInvincible){return}console.info("handleHurt.");if(mob&&mob.target.stats.hp>0&&mob instanceof Mob){mob.lookAt(mob.target);console.info("handleHurt - mob");var dmg=Formulas.dmg(mob,mob.target,mob.attackTimer);var canCrit=Formulas.crit(mob,mob.target);if(canCrit){dmg*=2;mob.criticalHit=false}mob.target.stats.hp-=dmg;if(mob.target.stats.hp<=0){mob.target.isDead=true}console.info("handleHurtEntity");this.server.handleDamage(mob.target,mob,-dmg,mob.criticalHit);this.server.handleHurtEntity(mob.target,mob);mob.attackTimer=Date.now()}},checkReturn:function(entity){if(entity.aiState!==mobState.CHASING&&entity.aiState!==mobState.STUCK&&entity.aiState!==mobState.ROAMING){return false}var et=entity.target;if(et&&(et.isDying||et.isDead)){entity.returnToSpawn();return true}if(entity.distanceToPos(entity.spawnX,entity.spawnY)>=24*G_TILESIZE||et&&entity.distanceToPos(et.x,et.y)>=12*G_TILESIZE){console.info("RETURN TO SPAWN!");entity.returnToSpawn();return true}}})},{"./formulas":96,"./message":112,"./utils":146,underscore:75}],116:[function(require,module,exports){var Area=require("./area"),_=require("underscore"),MobData=require("./mobdata"),Messages=require("./message"),Types=require("../shared/js/gametypes"),Utils=require("./utils");module.exports=MobArea=Area.extend({init:function(id,nb,minLevel,maxLevel,x,y,width,height,include,exclude,definite,map,elipse,excludeId,sMinLevel,sMaxLevel){this._super(id,x,y,width,height,map,elipse,excludeId);this.nb=nb;this.minLevel=minLevel;this.maxLevel=maxLevel;this.respawns=[];this.map=map;this.sMinLevel=sMinLevel;this.sMaxLevel=sMaxLevel;this.include=null;if(typeof include==="string")this.include=include.split(",");this.exclude=null;if(typeof exclude==="string")this.exclude=exclude.split(",");this.setNumberOfEntities(this.nb);this.definite=null;if(definite)this.definite=definite},addMobs:function(level){this.mobs=[];if(this.definite){for(var index in this.definite){this.mobs.push(MobData.Kinds[this.definite[index]])}return}if(level){this.minLevel=this.sMinLevel?level+this.sMinLevel:this.minLevel;this.maxLevel=this.sMaxLevel?level+this.sMaxLevel:this.maxLevel}levelMobs=MobData.getByLevelRange(this.minLevel,this.maxLevel);this.mobs=this.mobs.concat(levelMobs);for(var index in this.include){this.mobs.push(MobData.Kinds[this.include[index]])}var i=this.mobs.length;while(--i>=0){for(var j in this.exclude){if(this.mobs[i].kind==this.exclude[j]){this.mobs.splice(i,1);break}}}},spawnMobs:function(){for(var i=0;i<this.nb;++i){this.addToArea(this._createRandomMobInsideArea(),this.exclude)}},_createMob:function(kind){var self=this;var pos=self.map.entities.spaceEntityRandomApart(2,self._getRandomPositionInsideArea.bind(self,100));if(!pos)return null;var mob=self.map.entities.addMob(kind,pos.x,pos.y,this);self.addToArea(mob);return mob},_createRandomMobInsideArea:function(){var randomMob=0;var kind=0;if(!this.mobs||this.mobs.length==0)return null;if(this.mobs.length==1){return this._createMob(this.mobs[0].kind)}var mobRatio=[];var mobRatioTotal=0;var l=this.mobs.length;if(l==0){console.warn("mobs length == 0 aborting create.");return null}for(var i=0;i<l;++i){for(var j=0;j<this.mobs[i].spawnChance;++j){mobRatio[i*l+j]=this.mobs[i].kind}mobRatioTotal+=this.mobs[i].spawnChance}var kind=0;var randNum=Utils.randomInt(mobRatioTotal-1);var r=randNum;var sc=0;for(var i=0;i<this.mobs.length;++i){sc=this.mobs[i].spawnChance;if(r<=sc){kind=this.mobs[i].kind;break}r-=sc}if(kind==0){console.info("this.mobs="+JSON.stringify(this.mobs));console.warn("mob kind == 0 aborting create.");return null}return this._createMob(kind)},respawnMob:function(mob,delay){var self=this;delay=mob.spawnDelay||delay;this.removeFromArea(mob);setTimeout((function(){var pos=self.map.entities.spaceEntityRandomApart(1,self._getRandomPositionInsideArea.bind(self,20));var x=pos.x,y=pos.y;mob.spawnX=mob.x=x;mob.spawnY=mob.y=y;mob.respawnMob()}),delay)},Roaming:function(){return;var self=this;_.each(self.map.entities.mobs,(function(mob){if(mob&&!mob.hasTarget()&&!mob.isDead&&!mob.isReturning&&!mob.isMoving()){var canRoam=Utils.randomRangeInt(0,5)===1&&self.map.entities.getPlayerAroundCount(mob,25)>0;if(!canRoam)return;var pos=self.map.entities.getRandomPosition(mob,5);if(pos&&self.contains(pos.x,pos.y,0)&&!(pos.x==mob.x&&pos.y==mob.y)){return;mob.go(pos.x,pos.y);mob.aiState=mobState.ROAMING;if(mob.path){mob.spawnX=pos.x;mob.spawnY=pos.y}}}}))}})},{"../shared/js/gametypes":167,"./area":80,"./message":112,"./mobdata":118,"./utils":146,underscore:75}],117:[function(require,module,exports){var Messages=require("./message"),_=require("underscore"),Utils=require("./utils"),Formulas=require("./formulas"),Chest=require("./chest");module.exports=MobCallback=Class.extend({init:function(ws,map){this.world=this.worldServer=ws;this.map=map},setCallbacks:function(entity){var self=this;entity.onRespawn((function(){entity.isDead=false;entity.droppedItem=false;self.addMob(mob);if(entity.area&&entity.area instanceof ChestArea)mob.area.addToArea(entity)}));entity.onStep((function(x,y){if(!entity)return}));entity.onRequestPath((function(x,y){var ignored=[entity];if(entity.target)ignored.push(entity.target);var path=self.map.entities.findPath(entity,x,y,ignored);if(path&&path.length==1)console.error(entity.id+" "+JSON.stringify(path));if(path&&path.length>1){entity.orientation=entity.getOrientationTo({x:path[1][0],y:path[1][1]});var msg=new Messages.MovePath(entity,path);self.map.entities.pushNeighbours(entity,msg);return path}return null}));entity.onStopPathing((function(x,y){if(!entity.hasTarget())entity.setAiState(mobState.IDLE);if(entity.aiState==mobState.CHASING)entity.mobAI.checkReturn(entity,x,y)}));entity.onStartPathing((function(){}));entity.onAbortPathing((function(){msg=new Messages.Move(entity,entity.orientation,false,entity.x,entity.y);self.map.entities.pushNeighbours(entity,msg);if(!entity.target)entity.setAiState(mobState.IDLE)}))}})},{"./chest":87,"./formulas":96,"./message":112,"./utils":146,underscore:75}],118:[function(require,module,exports){var _=require("underscore");var Mobs=require("../shared/data/mobs.json");var Properties={};var Kinds={};_.each(Mobs,(function(value,key){Properties[key.toLowerCase()]={key:key.toLowerCase(),kind:value.kind,attack:value.attackMod?value.attackMod*3:3,defense:value.defenseMod?value.defenseMod*3:3,hp:value.hpMod?value.hpMod*150:150,xp:value.xpMod?value.xpMod*20:20,level:value.level?value.level:0,minLevel:value.minLevel?value.minLevel:0,maxLevel:value.maxLevel?value.maxLevel:0,aggroRange:value.aggroRange?value.aggroRange+1:4,attackRange:value.attackRange?value.attackRange:1,isAggressive:value.isAggressive==1?true:false,attackRate:value.attackRateMod?value.attackRateMod*1500:1500,reactionDelay:value.reactionMod?value.reactionMod*512:512,moveSpeed:value.moveSpeedMod?~~(300+200*value.moveSpeedMod):500,respawn:value.respawnMod?value.respawnMod*3e4:3e4,dropRate:value.dropRate?value.dropRate:1,spawnChance:value.spawnChance?value.spawnChance:50,dropBonus:value.dropBonus?value.dropBonus:0,drops:value.drops?value.drops:null};Kinds[value.kind]=Properties[key.toLowerCase()]}));var isMob=function(kind){return Kinds[kind]?true:false};var forEachMobKind=function(callback){for(var k in MobKinds){callback(MobKinds[k][0],k)}};var getByLevelRange=function(min,max){levelRange=[];for(var k in Kinds){var mobKind=Kinds[k];if(mobKind.level>0&&mobKind.level>=min&&mobKind.level<=max)levelRange.push(mobKind);else if(mobKind.minLevel>0&&mobKind.maxLevel>0&&(min>=mobKind.minLevel&&min<=mobKind.maxLevel||max>=mobKind.minLevel&&max<=mobKind.maxLevel))levelRange.push(mobKind)}return levelRange};module.exports.Properties=Properties;module.exports.Kinds=Kinds;module.exports.isMob=isMob;module.exports.forEachMobKind=forEachMobKind;module.exports.getByLevelRange=getByLevelRange},{"../shared/data/mobs.json":156,underscore:75}],119:[function(require,module,exports){var _=require("underscore");var MobSpeech=require("../shared/data/mobs_speech.json");var speech={};_.each(MobSpeech,(function(value,key){speech[key]=value}));module.exports.Speech=speech},{"../shared/data/mobs_speech.json":157,underscore:75}],120:[function(require,module,exports){var _=require("underscore");var NotifyJSON=require("../shared/data/notifications.json");var Notifications={};var i=0;_.each(NotifyJSON,(function(value,key){Notifications[i++]={textid:value.textid,interval:value.interval}}));module.exports.Notifications=Notifications},{"../shared/data/notifications.json":158,underscore:75}],121:[function(require,module,exports){var _=require("underscore");var NPCsJSON=require("../shared/data/npcs.json");var NPCspeak=require("../shared/data/npc_english.json");var NPCnames=require("../shared/data/npc_names_eng.json");var Properties={};var Kinds=NPCsJSON;_.each(Kinds,(function(value,key){Properties[value.uid]={uid:value.uid,kind:key,name:value.name?value.name:value.uid}}));var isNpc=function(kind){return Kinds[kind]?true:false};module.exports.Properties=Properties;module.exports.Kinds=Kinds;module.exports.isNpc=isNpc;module.exports.NPCnames=NPCnames},{"../shared/data/npc_english.json":159,"../shared/data/npc_names_eng.json":161,"../shared/data/npcs.json":162,underscore:75}],122:[function(require,module,exports){var Entity=require("./entity");var AppearanceData=require("./appearancedata");var Types=require("../shared/js/gametypes");var ItemTypes=require("../shared/js/itemtypes");var Utils=require("./utils");var MobData=require("./mobdata");var NpcData=require("./npcdata");var ItemLootData=require("./itemlootdata");var Messages=require("./message");var NpcMoveController=require("./npcmovecontroller");var LangData=require("./langdata");var Player=require("./player");var Quest=require("./quest");var QuestData=require("./questdata");var NPCnames=require("../shared/data/npc_names.json");var NpcMove=Character.extend({init:function(id,kind,x,y,map){x+=8;y+=8;this._super(id,Types.EntityTypes.NPCMOVE,kind,x,y,map);this.armor=0;this.weapon=0;this.gender=kind%2;this.setMoveRate(350);this.name=NPCnames[kind%41];this.activeController=new NpcMoveController(this);this.scriptQuests=false;this.questCount=0},getState:function(){return this._getBaseState()},talk:function(player){for(var q of player.quests){if(q.status<2&&q.type==QuestType.GETITEMKIND&&q.count>=q.object2.count){if(player.questAboutItemComplete(q,null));return}}for(var quest of player.quests){if(this.id==quest.npcId&&quest.status<QuestStatus.COMPLETE)return}if(this.scriptQuests&&QuestData.NpcData[this.kind]&&QuestData.NpcData[this.kind].length>0){var newQuest=null;var pQuest=null;for(var quest of QuestData.NpcData[this.kind]){pQuest=player.getQuestById(parseInt(quest.id));if(pQuest){if(pQuest.status<QuestStatus.COMPLETE){pQuest.status=QuestStatus.INPROGRESS;player.progessQuest(pQuest);return}}else{newQuest=quest;break}}if(newQuest){var qData=QuestData.Data[newQuest.id];quest=new Quest([qData.id,qData.type,this.id,0,0,0,0,qData.object,qData.object2]);player.foundQuest(quest);return}}var qTypes=[1,2];var questType=qTypes[Utils.randomInt(qTypes.length-1)];var pLvl=player.level.base;var self=this;var getMobObject=function(){var entities=self.map.entities.getMobsAround(self,48);if(entities.length==0)return;var entitycount=Utils.GetGroupCountArray(entities,"kind");console.warn("entitycount="+JSON.stringify(entitycount));if(entitycount.length==0)return null;entitycount.sort((function(a,b){return b[1]-a[1]}));var kind=parseInt(entitycount[0][0]);entities=entities.filter((function(entity){return entity.kind==kind}));var minLevel=Utils.minProp(entities,"level").level;var mobCount=parseInt(entitycount[0][1]);if(mobCount<=0)return null;if(!MobData.Kinds[kind])return null;return getQuestObject([Types.EntityTypes.MOB,kind,mobCount,0,minLevel,100])};if(questType==QuestType.GETITEMKIND){console.info("GETITEMKIND");var itemKind=Utils.randomInt(ItemLootData.ItemLoot.length-1);var id="02"+Utils.pad(this.id,6)+Utils.pad(this.questCount++,4);var quest=player.getQuestById(id);if(!quest){var mobObject=getMobObject();if(!mobObject)return;mobObject.count=0;var itemCount=Utils.randomRangeInt(1,5);var itemChance=30*itemCount/(player.level.base+2);var itemObject=getQuestObject([Types.EntityTypes.ITEMLOOT,itemKind,itemCount,itemChance]);quest=new Quest([id,QuestType.GETITEMKIND,this.id,0,0,0,0,mobObject,itemObject]);player.foundQuest(quest)}else{quest.status=QuestStatus.INPROGRESS;player.questAboutItem(quest)}}if(questType==QuestType.KILLMOBKIND){console.info("KILLMOBKIND");var id="01"+Utils.pad(this.id,6)+Utils.pad(this.questCount++,4);var quest=player.getQuestById(id);if(!quest){var mobObject=getMobObject();if(!mobObject)return;mobObject.count=Utils.clamp(10,Math.round(Math.ceil(player.level/5)*5)+10,Math.round(Math.ceil(mobObject.count/5)));quest=new Quest([id,QuestType.KILLMOBKIND,this.id,0,0,0,0,mobObject]);player.foundQuest(quest)}else{quest.status=QuestStatus.INPROGRESS;player.progessQuest(quest)}}}});module.exports=NpcMove},{"../shared/data/npc_names.json":160,"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./appearancedata":79,"./entity":91,"./itemlootdata":100,"./langdata":103,"./message":112,"./mobdata":118,"./npcdata":121,"./npcmovecontroller":123,"./player":128,"./quest":131,"./questdata":132,"./utils":146}],123:[function(require,module,exports){var Messages=require("./message"),_=require("underscore"),Utils=require("./utils");module.exports=NpcMoveController=Class.extend({init:function(entity){this.entity=entity;this.setCallbacks()},setCallbacks:function(){var self=this;self.entity.onStep((function(entity,x,y){try{entity.map.entities.entitygrid[entity.y][entity.x]=0;entity.map.entities.entitygrid[y][x]=1}catch(e){console.info(e.stack);console.info(entity.x+","+entity.y+","+x+","+y);console.info(entity.id);console.info(entity.path);console.info(entity.step)}}));self.entity.onRequestPath((function(x,y){var path=self.entity.map.entities.findPath(self.entity,x,y);if(path&&path.length>0){var msg=new Messages.MovePath(self.entity,path);self.entity.map.entities.pushNeighbours(self.entity,msg);return path}return null}))},randomMove:function(){var self=this;var entity=this.entity;if(entity&&!entity.hasTarget()&&!entity.isDead&&!entity.isMoving()){var canRoam=Utils.randomRangeInt(0,100)===1;if(!canRoam||entity.map.entities.getPlayerAroundCount(entity,20)==0)return;var pos=entity.map.entities.getRandomPosition(entity,2);if(pos&&!(pos.x==entity.x&&pos.y==entity.y)){entity.go(pos.x,pos.y)}}},checkMove:function(time){var npc=this.entity;if(npc.isDead)return;if(!npc.freeze&&npc.isMoving()&&npc.canMove()){npc.nextStep()}}})},{"./message":112,"./utils":146,underscore:75}],124:[function(require,module,exports){var Entity=require("./entity");var Player=require("./player");var QuestData=require("./questdata");var NpcData=require("./npcdata");var Utils=require("./utils");var Messages=require("./message");var NpcStatic=Entity.extend({init:function(id,kind,x,y,map){x+=8;y+=8;this._super(id,Types.EntityTypes.NPCSTATIC,kind,x,y,map);this.map=map},talk:function(player){console.info("talk");console.info("kind: "+this.kind);if(this.kind==44){console.info("THIS IS FOR COLLECTING ITEMS NPC.");if(player.questStatus){for(let[key,questStatus]of Object.entries(player.questStatus)){console.info("questStatus"+JSON.stringify(questStatus));if(questStatus.type==1&&questStatus.count<=questStatus.objectCount){player.questAboutItem(questStatus,null)}}}return}for(var quest in player.quests){if(quest.npcId==this.id&&quest.status<QuestStatus.COMPLETE){return}}}});module.exports=NpcStatic},{"./entity":91,"./message":112,"./npcdata":121,"./player":128,"./questdata":132,"./utils":146}],125:[function(require,module,exports){var cls=require("./lib/class"),_=require("underscore"),Character=require("./character"),Chest=require("./chest"),Messages=require("./message"),Utils=require("./utils"),MobData=require("./mobdata"),Formulas=require("./formulas"),formatCheck=require("./format").check,Party=require("./party"),Items=require("./items"),Bank=require("./bank"),Types=require("../shared/js/gametypes"),ItemTypes=require("../shared/js/itemtypes"),bcrypt=require("bcrypt"),Inventory=require("./inventory"),Mob=require("./mob"),Gather=require("./gather"),SkillHandler=require("./skillhandler"),Trade=require("./trade"),express=require("express"),bodyParser=require("body-parser"),app=express(),Quests=require("./questdata"),SkillData=require("./skilldata"),EntitySpawn=require("./entityspawn"),AppearanceData=require("./appearancedata"),TaskHandler=require("./taskhandler");module.exports=PacketHandler=Class.extend({init:function(user,main,player,connection,worldServer,map){this.user=user;this.main=main;this.player=player;this.connection=connection;this.server=worldServer;this.map=player.map;this.entities=player.map.entities;var self=this;this.connection.listen((function(message){console.info("recv="+JSON.stringify(message));var action=parseInt(message[0]);if(!formatCheck(message)){self.connection.close("Invalid "+Types.getMessageTypeAsString(action)+" message format: "+message);return}message.shift();switch(action){case Types.Messages.BI_PLAYERINFO:self.handlePlayerInfo(message);break;case Types.Messages.CS_WHO:self.handleWho(message);break;case Types.Messages.CS_CHAT:self.handleChat(message);break;case Types.Messages.CS_MOVE:self.handleMoveEntity(message);break;case Types.Messages.CS_MOVEPATH:self.handleMovePath(message);break;case Types.Messages.CS_ATTACK:self.handleAttack(message);break;case Types.Messages.CS_ITEMSLOT:self.handleItemSlot(message);break;case Types.Messages.CS_STORESELL:self.handleStoreSell(message);break;case Types.Messages.CS_STOREBUY:self.handleStoreBuy(message);break;case Types.Messages.CS_CRAFT:self.handleCraft(message);break;case Types.Messages.CS_APPEARANCEUNLOCK:self.handleAppearanceUnlock(message);break;case Types.Messages.CS_LOOKUPDATE:self.handleLookUpdate(message);break;case Types.Messages.CS_AUCTIONSELL:self.handleAuctionSell(message);break;case Types.Messages.CS_AUCTIONBUY:self.handleAuctionBuy(message);break;case Types.Messages.CS_AUCTIONOPEN:self.handleAuctionOpen(message);break;case Types.Messages.CS_AUCTIONDELETE:self.handleAuctionDelete(message);break;case Types.Messages.CS_STOREENCHANT:self.handleStoreEnchant(message);break;case Types.Messages.CS_STOREREPAIR:self.handleStoreRepair(message);break;case Types.Messages.CS_CHARACTERINFO:self.entities.pushToPlayer(self.player,new Messages.CharacterInfo(self.player));break;case Types.Messages.CS_TELEPORT_MAP:self.handleTeleportMap(message);break;case Types.Messages.CS_LOOT:self.handleLoot(message);break;case Types.Messages.CS_TALKTONPC:self.handleTalkToNPC(message);break;case Types.Messages.CS_PLAYER_REVIVE:self.handleRevive(message);break;case Types.Messages.CS_GOLD:self.handleGold(message);break;case Types.Messages.CS_STATADD:self.handleStatAdd(message);break;case Types.Messages.CS_SKILL:self.handleSkill(message);break;case Types.Messages.CS_SKILLINSTALL:self.handleSkillInstall(message);break;case Types.Messages.BI_BLOCK_MODIFY:self.handleBlock(message);break;case Types.Messages.CS_PARTY:self.handleParty(message);break;case Types.Messages.BI_HARVEST:self.handleHarvest(message);break;case Types.Messages.CS_HARVEST_ENTITY:self.handleHarvestEntity(message);break;default:if(self.message_callback)self.player.message_callback(message);break}}));this.connection.onClose((function(){console.info("Player: "+self.player.name+" has exited the world.");if(self.player.user.loadedPlayer)self.player.save();if(players[self.player.name])players[self.player.name]=0;if(self.player&&self.entities){console.info("deleting player connection");self.entities.removePlayer(self.player)}delete self.player;self.user.onClose(true);console.info("onClose - called");clearTimeout(this.disconnectTimeout);if(this.exit_callback){this.exit_callback()}this.close("onClose")}))},setMap:function(map){this.map=map;this.entities=map.entities},timeout:function(){this.connection.sendUTF8("timeout");this.connection.close("Player was idle for too long")},broadcast:function(message,ignoreSelf){if(this.broadcast_callback){this.broadcast_callback(message,ignoreSelf===undefined?true:ignoreSelf)}},broadcastToZone:function(message,ignoreSelf){if(this.broadcastzone_callback){this.broadcastzone_callback(message,ignoreSelf===undefined?true:ignoreSelf)}},sendPlayer:function(message){this.map.entities.pushToPlayer(this.player,message)},onExit:function(callback){this.exit_callback=callback},onMove:function(callback){this.move_callback=callback},onMessage:function(callback){this.message_callback=callback},onBroadcast:function(callback){this.broadcast_callback=callback},handleChat:function(message){var self=this;var msg=Utils.sanitize(message[0]);console.info("Chat: "+self.player.name+": "+msg);if((new Date).getTime()>self.player.chatBanEndTime){self.send([Types.Messages.SC_NOTIFY,"CHAT","CHATMUTED"]);return}if(msg&&(msg!==""||msg!==" ")){msg=msg.substr(0,256);var command=msg.split(" ",3);switch(command[0]){case"/w":self.send([Types.Messages.SC_NOTIFY,"CHAT","CHATMUTED"]);break;default:self.server.pushWorld(new Messages.Chat(self.player,msg));break}}},handleTalkToNPC:function(message){console.info("handleTalkToNPC");var self=this;var type=parseInt(message[0]);var npcId=parseInt(message[1]);npc=self.entities.getEntityById(npcId);if(npc)npc.talk(this.player)},handleStoreSell:function(message){var type=parseInt(message[0]);var itemIndex=parseInt(message[1]);var item=this.player.itemStore[0].rooms[itemIndex];if(!item)return;this.player.tut.buy=true;this.player.tut.buy2=true;var kind=item.itemKind;if(ItemTypes.isConsumableItem(kind)||ItemTypes.isLootItem(kind))return;var price=ItemTypes.getEnchantSellPrice(item);if(price<0)return;var itemKind=item.itemKind;this.player.inventory.makeEmptyItem(itemIndex);this.player.modifyGold(price);var itemName=ItemTypes.KindData[itemKind].name;this.sendPlayer(new Messages.Notify("SHOP","SHOP_SOLD",[itemName]))},handleAuctionSell:function(message){var itemIndex=parseInt(message[0]),price=parseInt(message[1]);if(price<0||itemIndex<0||itemIndex>=this.player.inventory.maxNumber)return;var item=this.player.inventory.rooms[itemIndex];console.info(JSON.stringify(item));var kind=item.itemKind;if(ItemTypes.isConsumableItem(kind)||ItemTypes.isLootItem(kind))return;if(kind){this.server.auction.add(this.player,item,price,itemIndex);this.server.auction.list(this.player,0);this.player.inventory.setItem(itemIndex,null)}},handleAuctionOpen:function(message){var type=parseInt(message[0]);if(type>=0&&type<=3)this.server.auction.list(this.player,type)},handleAuctionBuy:function(message){var auctionIndex=parseInt(message[0]);if(auctionIndex<0||auctionIndex>=this.server.auction.auctions.length)return;var auction=this.server.auction.auctions[auctionIndex];if(!auction)return;if(auction.playerName==this.player.name)return;var type=parseInt(message[1]);if(type<0||type>3)return;var self=this;var price=auction.price;if(price<0)return;var goldCount=self.player.gold[0];if(goldCount<price){this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGOLD"));return}if(!self.player.inventory.hasRoom()){this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOSPACE"));return}var itemKind=auction.item.itemKind;self.player.inventory.putItem(auction.item);self.player.modifyGold(price);var itemName=ItemTypes.KindData[itemKind].name;self.sendPlayer(new Messages.Notify("SHOP","SHOP_SOLD",[itemName]));var auctionPlayer=self.server.getPlayerByName(auction.playerName);if(auctionPlayer)auctionPlayer.modifyGold(price);else databaseHandler.modifyGold(auction.playerName,price);this.server.auction.remove(auctionIndex);this.server.auction.list(this.player,type)},handleAuctionDelete:function(message){var auctionIndex=parseInt(message[0]);if(auctionIndex<0||auctionIndex>=this.server.auction.auctions.length)return;var auction=this.server.auction.auctions[auctionIndex];if(!auction)return;var type=parseInt(message[1]);if(type<0||type>3)return;var self=this;if(!self.player.inventory.hasRoom()){self.sendPlayer(new Messages.Notify("SHOP","SHOP_NOSPACE"));return}var itemKind=auction.item.itemKind;self.player.inventory.putItem(auction.item);var itemName=ItemTypes.KindData[itemKind].name;self.sendPlayer(new Messages.Notify("SHOP","SHOP_REMOVED",[itemName]));this.server.auction.remove(auctionIndex);this.server.auction.list(this.player,type)},handleStoreEnchant:function(message){var type=parseInt(message[0]),itemIndex=parseInt(message[1]);if(type==0&&itemIndex>=6&&itemIndex<this.player.inventory.maxNumber){var item=this.player.inventory.rooms[itemIndex];this._enchantItem(type,item,itemIndex)}if(type==2&&itemIndex>=0&&itemIndex<this.player.equipment.maxNumber){var item=this.player.equipment.rooms[itemIndex];if(item){this._enchantItem(type,item,itemIndex)}}},handleStoreRepair:function(message){var type=parseInt(message[0]),itemIndex=parseInt(message[1]);if(type==0&&itemIndex>=6&&itemIndex<this.player.inventory.maxNumber){var item=this.player.inventory.rooms[itemIndex];if(item){this._repairItem(type,item,itemIndex)}}if(type==2&&itemIndex>=0&&itemIndex<this.player.equipment.maxNumber){var item=this.player.equipment.rooms[itemIndex];if(item){this._repairItem(type,item,itemIndex)}}},_repairItem:function(type,item,index){var itemKind=null,price=0;if(item&&item.itemKind){if(!ItemTypes.isEquipment(item.itemKind))return;if(item.itemDurability==item.itemDurabilityMax)return;price=~~ItemTypes.getRepairPrice(item);if(price<=0)return;goldCount=this.player.gold[0];if(goldCount<price){this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGOLD"));return}var degrade=~~((item.itemDurabilityMax-item.itemDurability)/10);item.itemDurabilityMax-=degrade;item.itemDurability=item.itemDurabilityMax;if(item.itemDurabilityMax<=0){item=null;if(type==0){this.player.inventory.makeEmptyItem(index)}else if(type==2){this.player.equipment.makeEmptyItem(index)}}else{console.info("itemNumber="+item.itemNumber);this.player.modifyGold(-price)}item.slot=index;this.sendPlayer(new Messages.ItemSlot(type,[item]));var itemName=ItemTypes.KindData[item.itemKind].name;this.sendPlayer(new Messages.Notify("SHOP","SHOP_REPAIRED",[itemName]))}},_enchantItem:function(type,item,index){var itemKind=null,price=0;if(item&&item.itemKind){if(!ItemTypes.isEquipment(item.itemKind))return;price=ItemTypes.getEnchantPrice(item);if(price<=0)return;goldCount=this.player.gold[0];if(goldCount<price){this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGOLD"));return}item.itemExperience=ItemTypes.itemExpForLevel[item.itemNumber-1];item.itemNumber++;item.slot=index;this.sendPlayer(new Messages.ItemSlot(type,[item]));console.info("itemNumber="+item.itemNumber);this.player.modifyGold(-price);var itemName=ItemTypes.KindData[item.itemKind].name;this.sendPlayer(new Messages.Notify("SHOP","SHOP_ENCHANTED",[itemName]))}},handleBankStore:function(message){var itemIndex=parseInt(message[0]);if(itemIndex>=6&&itemIndex<this.player.inventory.maxNumber){var item=this.player.inventory.rooms[itemIndex];if(item&&item.itemKind){var slot=this.player.bank.getEmptyIndex();if(slot>=0){this.player.bank.putItem(item);this.player.inventory.takeOutItems(itemIndex,item.itemNumber)}}}},handleBankRetrieve:function(message){var bankIndex=parseInt(message[0]);if(bankIndex>=0&&bankIndex<this.player.bank.maxNumber){var item=this.player.bank.rooms[bankIndex];if(item&&item.itemKind){var slot=this.player.inventory.getEmptyIndex();if(slot>=0){this.player.inventory.putItem(item);this.player.bank.takeOutItems(bankIndex,item.itemNumber)}}}this.sendPlayer(new Messages.Gold(this.player))},handleStoreBuy:function(message){var itemType=parseInt(message[0]),itemKind=parseInt(message[1]),itemCount=parseInt(message[2]),itemName=null,price=0,goldCount=0,buyCount=0;if(!itemKind||itemCount<=0){return}if(itemKind<0||itemKind>=ItemTypes.KindData.length)return;var itemData=ItemTypes.KindData[itemKind];var itemName=itemData.name;price=ItemTypes.getBuyPrice(itemKind);if(price>0){if(ItemTypes.Store.isBuyMultiple(itemKind)){itemCount=itemData.buycount}goldCount=this.player.gold[0];if(goldCount<price){this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGOLD"));return}var consume=ItemTypes.isConsumableItem(itemKind);if(consume||!consume&&this.player.inventory.hasRoom()){var item=new ItemRoom(itemKind,itemCount,0,0);var res=this.player.inventory.putItem(item);if(res==-1)return;this.player.modifyGold(-price);this.sendPlayer(new Messages.Notify("SHOP","SHOP_BUY",[itemName]));if(!this.player.tut.equip){this.player.tutChat("TUTORIAL_EQUIP",10,"equip")}}else{this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOSPACE"))}}},handleCraft:function(message){var craftId=parseInt(message[0]),itemCount=parseInt(message[1]),itemName=null,price=0,goldCount=0,buyCount=0;if(itemCount<=0){return}if(craftId<0||craftId>=Items.CraftData.length)return;var craftData=Items.CraftData[craftId];var itemKind=craftData.o;if(!ItemTypes.KindData.hasOwnProperty(itemKind)){console.error("handleCraft - itemData not found for kind: "+itemKind);return}var itemData=ItemTypes.KindData[itemKind];var itemName=itemData.name;price=ItemTypes.getCraftPrice(itemKind);if(price<0)return;if(ItemTypes.Store.isBuyMultiple(itemKind)){itemCount=itemCount<itemData.buycount?itemCount:itemData.buycount}else{itemCount=1}price=price*itemCount;goldCount=this.player.gold[0];if(goldCount<price){this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGOLD"));return}if(itemData.craft.length==0)return;for(var it of craftData.i){if(!this.player.inventory.hasItems(it[0],it[1]*itemCount)){this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOCRAFTITEMS"));return}}if(!this.player.inventory.hasRoom()){this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOSPACE"));return}this.player.modifyGold(-price);for(var it of craftData.i){this.player.inventory.removeItemKind(it[0],it[1]*itemCount)}var durability=0;if(ItemTypes.isWeapon()||ItemTypes.isArmor())durability=900;var item=new ItemRoom(itemKind,itemCount,durability,durability);if(this.player.inventory.putItem(item)==-1)return;this.sendPlayer(new Messages.Notify("SHOP","SHOP_BUY",[itemName]))},handleAppearanceUnlock:function(message){var appearanceIndex=parseInt(message[0]);var priceClient=parseInt(message[1]);if(appearanceIndex==-1){this.server.looks.sendLooks(this.player);return}if(appearanceIndex<0||appearanceIndex>=AppearanceData.Data.length)return;var itemData=AppearanceData.Data[appearanceIndex];if(!itemData)return;if(!(itemData.type=="armorarcher"||itemData.type=="armor"))return;var price=this.server.looks.prices[appearanceIndex];if(price!=priceClient){this.sendPlayer(new Messages.Notify("SHOP","SHOP_MISMATCH",[itemData.name]));this.server.looks.sendLooks(this.player);return}var gemCount=0;if(appearanceIndex>=0){gemCount=this.player.user.gems;console.info("gemCount="+gemCount);if(gemCount>=price){this.player.user.looks[appearanceIndex]=1;this.player.user.modifyGems(-price);this.server.looks.prices[appearanceIndex]+=100;this.sendPlayer(new Messages.Notify("SHOP","SHOP_SOLD",[itemData.name]));this.server.looks.sendLooks(this.player)}else{this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGEMS"))}}},handleLookUpdate:function(message){var type=parseInt(message[0]),id=parseInt(message[1]);var p=this.player;if(id<0||id>=AppearanceData.Data.length)return;if(type<0||type>1)return;var itemData=AppearanceData.Data[id];if(!itemData)return;if(!(itemData.type=="armorarcher"||itemData.type=="armor"))return;var appearance=this.player.user.looks[id];if(appearance==1){if(type==0){if(p.isArcher())p.sprites[2]=id;else p.sprites[0]=id}}this.broadcast(new Messages.Looks(this.player),true)},handleItemSlot:function(message){var self=this;var action=parseInt(message[0]);if(this.player.isDying||this.player.isDead)return;var slot=[parseInt(message[1]),parseInt(message[2]),parseInt(message[3])];if(slot[0]==2&&slot[1]>this.player.equipment.maxNumber)return;var item=null;if(slot[1]>=0)item=this.player.getStoredItem(slot[0],slot[1],slot[2]);var slot2=null;if(message.length==6){slot2=[parseInt(message[4]),parseInt(message[5])];if(slot[0]==slot2[0]&&slot[1]==slot2[1])return}if(action===0){this.player.handleInventoryEat(item,slot[1])}else if(action===1){this.player.tut.equip=true;this.player.handleEquip(slot,slot2)}else if(action===2){this.player.swapItem(slot,slot2)}else if(action===3){this.player.handleStoreEmpty(slot,item)}else if(action===4){this.player.storeItem(slot,slot2)}},handleLoot:function(message){var self=this;console.info("handleLoot");item=this.entities.getEntityById(parseInt(message[0]));if(!item){console.info("no item.");return}var x=parseInt(message[1]),y=parseInt(message[2]);if(!(Math.abs(self.player.x-x)<=G_TILESIZE&&Math.abs(self.player.y-y)<=G_TILESIZE)){console.info("Player is not close enough to item.");return}console.info("item="+item.toString());if(item.enemyDrop)console.info("enemyDrop");if(item instanceof Item){if(self.player.inventory.putItem(item.room)>=0){this.server.taskHandler.processEvent(this.player,PlayerEvent(EventType.LOOTITEM,item,1));this.broadcast(item.despawn(),false);this.entities.removeEntity(item)}}},handleAttack:function(message){console.info("handleAttack");var self=this;var time=parseInt(message[0]);var p=this.player;if(p.isDying||p.isDead)return;if(p.movement.inProgress){p.attackQueue.push(message)}else{setTimeout((function(){self.handleHitEntity(p,message)}),G_LATENCY)}},processAttack:function(){var self=this;for(var msg of this.player.attackQueue){console.info("processAttack, handle hit");setTimeout((function(){self.handleHitEntity(self.player,msg)}),G_LATENCY)}this.player.attackQueue=[]},handleHitEntity:function(sEntity,message){console.info("handleHitEntity");var self=this;console.info("message: "+JSON.stringify(message));var targetId=parseInt(message[1]);var orientation=parseInt(message[2]);var skillId=parseInt(message[3]);if(targetId<0){console.warn("invalid targetId");return}var tEntity=this.entities.getEntityById(targetId);if(!tEntity){console.warn("invalid entity");return}var attackTime=Date.now()-sEntity.attackTimer;if(attackTime<ATTACK_INTERVAL){console.warn("attack interval");return}if(tEntity instanceof Player&&sEntity instanceof Player&&(sEntity.level.base<20||tEntity.level.base<20||Math.abs(sEntity.level.base-tEntity.level.base)>10)){console.warn("pvp invalid diff");return}if(tEntity.aiState==mobState.RETURNING)return;if(tEntity.invincible){this.sendPlayer(new Messages.Notify("CHAT","COMBAT_TARGETINVINCIBLE"));console.warn("target invincible");return}if(this.map.isColliding(sEntity.x,sEntity.y)){console.warn("char.isColliding("+sEntity.id+","+sEntity.x+","+sEntity.y+")");return}if(skillId>=0){this.handleSkill([skillId,targetId,tEntity.x,tEntity.y])}sEntity.setOrientation(orientation);sEntity.engage(tEntity);if(sEntity==self.player){if(!sEntity.canReach(tEntity)){console.info("Player not close enough!");console.info("p.x:"+sEntity.x+",p.y:"+sEntity.y);console.info("e.x:"+tEntity.x+",e.y:"+tEntity.y);console.info("dx:"+Math.abs(sEntity.x-tEntity.x)+",dy:"+Math.abs(sEntity.y-tEntity.y));return}if(!sEntity.attackedTime.isOver()){console.warn("attackedTime is not over.");return}sEntity.isHarvesting=false;sEntity.lastAction=Date.now()}sEntity.isBlocking=false;sEntity.attackedTime.duration=500;sEntity.hasAttacked=true;if(sEntity===this.player&&tEntity instanceof Mob){this.player.tut.attack=true}if(sEntity instanceof Player&&tEntity instanceof Mob){tEntity.mobAI.checkHitAggro(tEntity,sEntity)}if(sEntity.effectHandler){sEntity.effectHandler.interval(3,0)}var damageObj=self.calcDamage(sEntity,tEntity,null,0);if(sEntity.effectHandler){sEntity.effectHandler.interval(4,damageObj.damage);for(var skillEffect in sEntity.effectHandler.skillEffects){for(var target in skillEffect.targets){var damage=target.mod.damage;target.mod.damage=0;self.dealDamage(sEntity,target,damage,0)}}}self.dealDamage(sEntity,tEntity,damageObj.damage,damageObj.crit);if(sEntity.attackTimer)sEntity.attackTimer=Date.now();if(sEntity.effectHandler){sEntity.effectHandler.interval(5,0)}},calcDamage:function(sEntity,tEntity,skill,attackType){var self=this;var damageObj={damage:0,crit:0,dot:0};damageObj.damage=Math.round(Formulas.dmg(sEntity,tEntity,Date.now()));if(damageObj.damage==0)return damageObj;var canCrit=Formulas.crit(sEntity,tEntity);if(canCrit){damageObj.damage*=2;damageObj.crit=1}if(sEntity.mod.dr>0&&!sEntity.hasFullHealth()){var amount=Math.ceil(damageObj.damage*(sEntity.mod.dr/100));sEntity.regenHealthBy(amount);if(sEntity instanceof Player)this.sendPlayer(sEntity,sEntity.health())}return damageObj},dealDamage:function(sEntity,tEntity,dmg,crit){var self=this;if(!tEntity)return;if(tEntity instanceof Mob)this.entities.mobAI.aggroPlayer(tEntity,sEntity);self.server.handleDamage(tEntity,sEntity,-dmg,crit);if(sEntity instanceof Player)sEntity.weaponDamage+=dmg;self.server.handleHurtEntity(tEntity,sEntity);console.info("DAMAGE OCCURED "+dmg);if(tEntity instanceof Mob||tEntity instanceof Gather){}else{if(tEntity.isDead){if(sEntity==self.player)self.entities.pushBroadcast(new Messages.Notify("CHAT","COMBAT_PLAYERKILLED",[sEntity.name,tEntity.name]));sEntity.pStats.pk++;tEntity.pStats.pd++}}},handleSkillInstall:function(message){var shortcutIndex=parseInt(message[0]);var skillIndex=parseInt(message[1]);if(shortcutIndex<0||shortcutIndex>=6)return;if(skillIndex<0||skillIndex>=SkillData.Skills.length)return;var p=this.player;p.skillSlots[shortcutIndex]=skillIndex},handleSkill:function(message){var self=this;var skillId=parseInt(message[0]);var targetId=parseInt(message[1]);var x=parseInt(message[2]);var y=parseInt(message[3]);var p=this.player;if(skillId<0||skillId>=this.player.skills.length)return;var skill=this.player.skills[skillId];var target;if(targetId){target=this.entities.getEntityById(targetId);if(!target)return}if(!skill.isReady())return;var level=skill.skillLevel+1;this.player.effectHandler.cast(skillId,targetId,x,y);skill.tempXP=Math.min(skill.tempXP++,1);self.handleSkillEffects(self.player,target)},handleSkillEffects:function(source,target){var self=this;var effects=[];if(!source.effects)return;for(let[k,v]of Object.entries(source.effects)){if(v==1)effects.push(parseInt(k))}self.entities.pushToPlayer(source,new Messages.SkillEffects(source,effects));effects=[];if(!target)return;for(let[k,v]of Object.entries(target.effects)){if(v==1)effects.push(parseInt(k))}self.entities.pushToPlayer(source,new Messages.SkillEffects(target,effects))},handleMoveEntity:function(message){console.info("handleMoveEntity");var time=parseInt(message[0]),entityId=parseInt(message[1]),state=parseInt(message[2]),orientation=parseInt(message[3]),x=parseInt(message[4])||-1,y=parseInt(message[5])||-1;var p=this.player;if(entityId!=p.id)return;if(p.map.isColliding(x,y)){console.warn("char.isColliding("+p.id+","+x+","+y+")");return}if(state==2){if(p.isMovingPath()&&p.fullpath){p.abort_pathing_callback(x,y);p.forceStop()}return}var arr=[time,state,orientation,x,y];p.move(arr);var msg=new Messages.Move(p,orientation,state,x,y);this.entities.pushNeighbours(p,msg,p);if(this.move_callback)this.move_callback()},handleMovePath:function(message){console.info("handleMovePath");console.info("message="+JSON.stringify(message));var time=parseInt(message[0]),entityId=parseInt(message[1]),orientation=parseInt(message[2]),interrupted=parseInt(message[3])==0?false:true;message.splice(0,4);var path=message;var p=this.player;if(entityId!=p.id)return;console.info(JSON.stringify(path));var x=path[0][0],y=path[0][1];if(this.player.mapStatus<2)return;if(!this.entities.pathfinder.isValidPath(p.map.grid,path)){console.info("handleMovePath: no valid path.");return}p.movePath([time,interrupted],path);var msg=new Messages.MovePath(p,path);this.entities.pushNeighbours(p,msg)},handleTeleportMap:function(msg){console.info("handleTeleportMap");var self=this;var mapId=parseInt(msg[0]);var status=parseInt(msg[1]);console.info("status="+status);var x=parseInt(msg[2]),y=parseInt(msg[3]);var p=this.player;if(status<=0){x=-1;y=-1}var mapInstanceId=null;var mapName=null;if(mapId<0||mapId>=self.server.maps.length){console.info("Map non-index");return}var map=self.server.maps[mapId];if(!(map&&map.ready)){console.info("Map non-existant or not ready");return}console.warn("mapIndex: p.map.mapIndex:"+map.index);if(status==0){p.pushSpawns=false;p.forceStop();p.mapStatus=0;this.handleClearMap();this.entities.removePlayer(this.player);var finishTeleportMaps=function(mapId){p.map=map;self.setMap(map);var pos={x:p.x,y:p.y};console.info("handleTeleportMap - x: "+x+",y:"+y);console.warn("mapIndex: p.map.mapIndex:"+map.index);if(typeof p.prevPosX==="undefined"&&typeof p.prevPosY==="undefined"){pos=self.map.getRandomStartingPosition()}else if(p.map.mapIndex===0){p.prevPosX=p.x;p.prevPosY=p.y;pos=self.map.getRandomStartingPosition()}else if(p.map.mapIndex===1){pos={x:p.prevPosX,y:p.prevPosY}}else{pos=self.map.getRandomStartingPosition()}self.entities.addPlayer(p);p.ex=p.sx=pos.x;p.ey=p.sy=pos.y;p.setPosition(pos.x,pos.y);p.move([Date.now(),3,1,pos.x,pos.y]);console.info("trying to send.");self.send([Types.Messages.SC_TELEPORT_MAP,mapId,1,p.x,p.y])};pos=map.enterCallback(p);finishTeleportMaps(mapId)}else if(status==1){p.mapStatus=2;self.handleSpawnMap(mapId,p.x,p.y);self.send([Types.Messages.SC_TELEPORT_MAP,mapId,2,p.x,p.y])}},handleSpawnMap:function(mapId,x,y){var p=this.player;p.knownIds=[];this.entities.processWho(p);this.player.setPosition(x,y);this.entities.pushNeighbours(p,new Messages.Spawn(p),p)},handleClearMap:function(){var self=this;this.player.clearTarget();this.server.handlePlayerVanish(this.player);this.entities.removeEntity(this.player)},handleRevive:function(data){var p=this.player;if(p.isDead==true){console.info("handled Revive!!");p.revive();this.entities.pushNeighbours(p,new Messages.Spawn(p),p);var msg=new Messages.Move(p,p.orientation,2,p.x,p.y);this.sendPlayer(msg)}},handleStatAdd:function(message){var self=this;var attribute=parseInt(message[0]);var points=parseInt(message[1]);if(points<0||points>this.player.stats.free)return;if(attribute==4)return;switch(attribute){case 1:this.player.stats.attack+=points;break;case 2:this.player.stats.defense+=points;break;case 3:this.player.stats.health+=points;break;case 5:this.player.stats.luck+=points;break}this.player.stats.free-=points;this.player.resetBars();this.sendPlayer(new Messages.StatInfo(this.player))},handleGold:function(message){var type=parseInt(message[0]);var gold=parseInt(message[1]);var type2=parseInt(message[2]);if(gold<0)return;if(gold>9999999){this.sendPlayer(new Messages.Notify("GOLD","MAX_TRANSFER"));return}if(gold>this.player.gold[type]){this.sendPlayer(new Messages.Notify("GOLD","INSUFFICIENT_GOLD"));return}if(type===0&&type2===1){if(!this.player.modifyGold(-gold,0))return;this.player.modifyGold(gold,1)}if(type===1&&type2===0){if(!this.player.modifyGold(-gold,1))return;this.player.modifyGold(gold,0)}},handleBlock:function(msg){var type=parseInt(msg[0]);var id=parseInt(msg[1]);var x=parseInt(msg[2]);var y=parseInt(msg[3]);var p=this.player;var block=this.map.entities.getEntityById(id);if(!block||!(block instanceof Block))return;if(!this.player.isNextTooEntity(block))return;if(type==0){this.player.holdingBlock=block}else if(type==1){x=Utils.roundTo(x,G_TILESIZE);y=Utils.roundTo(y,G_TILESIZE);if(this.map.isColliding(x,y))return;block.setPosition(x,y);block.update(this.player);this.player.holdingBlock=null}var msg=new Messages.BlockModify(block,p.id,type);this.entities.pushNeighbours(p,msg,p)},handlePlayerInfo:function(message){this.sendPlayer(new Messages.PlayerInfo(this.player))},handleWho:function(message){var cmd=parseInt(message.shift());var ids=[];if(message.length>0)ids=message;if(cmd===1)this.entities.processWho(this.player);if(cmd===2){for(var i=0;i<ids.length;++i)this.player.knownIds.splice(this.player.knownIds.indexOf(ids[i]),1)}},handleParty:function(msg){var partyType=msg.shift();switch(partyType){case 1:this.handlePartyInvite(msg);break;case 2:this.handlePartyKick(msg);break;case 3:this.handlePartyLeader(msg);break;case 4:this.handlePartyLeave(msg);break}},handlePartyInvite:function(msg){var name=msg[0];var player2=this.server.getEntityByName(name);if(!player2){this.sendPlayer(new Messages.Notify("CHAT","NO_PLAYER_EXIST",[name]));return}var status=msg[1];var curParty=this.player.party;if(this.player==player2)return;if(status==0){if(curParty&&curParty.players.length>=5){this.sendPlayer(new Messages.Notify("CHAT","PARTY_MAX_PLAYERS"));return}if((!curParty||curParty.leader)&&player2 instanceof Player){this.sendToPlayer(player2,new Messages.PartyInvite(this.player.id));this.sendPlayer(new Messages.Notify("CHAT","PARTY_PLAYER_INVITE_SENT",[player2.name]))}}else if(status==1){if(player2.party){player2.party.removePlayer(player2)}if(curParty){if(curParty.players.length>=5){this.sendPlayer(new Messages.Notify("CHAT","PARTY_MAX_PLAYERS"));return}curParty.addPlayer(player2)}else{this.server.addParty(player2,this.player)}if(player2){this.sendToPlayer(player2,new Messages.Notify("CHAT","PARTY_PLAYER_JOINED",[this.player.name]));this.sendPlayer(new Messages.Notify("CHAT","PARTY_PLAYER_ADDED",[player2.name]))}}else if(status==2){this.sendPlayer(new Messages.Notify("CHAT","PARTY_YOU_REJECTED_INVITE",[player2.name]));this.sendToPlayer(player2,new Messages.Notify("CHAT","PARTY_THEY_REJECTED_INVITE",[player2.name]))}},handlePartyKick:function(msg){var name=msg[0];var player2=this.server.getEntityByName(name);if(!player2){this.sendPlayer(new Messages.Notify("CHAT","NO_PLAYER_EXIST",[name]));return}if(this.player==player2)return;var party=this.player.party;if(!party){this.sendPlayer(new Messages.Notify("CHAT","PARTY_CANNOT_KICK"));return}if(this.player==party.leader){party.removePlayer(player2);if(player2 instanceof Player)this.sendToPlayer(player2,new Messages.Notify("CHAT","PARTY_PLAYER_KICKED"));this.handlePartyAbandoned(party)}else{this.sendPlayer(new Messages.Notify("CHAT","PARTY_CANNOT_KICK"))}},handlePartyLeader:function(msg){var name=msg[0];var player2=this.server.getEntityByName(name);if(!player2){this.sendPlayer(new Messages.Notify("CHAT","NO_PLAYER_EXIST",[name]));return}if(this.player==player2)return;var party=this.player.party;if(!party){this.sendPlayer(new Messages.Notify("CHAT","PARTY_NOT_LEADER"));return}if(this.player==party.leader){party.leader=player2;this.sendToPlayer(player2,new Messages.Notify("CHAT","PARTY_YOU_LEADER"));this.sendPlayer(new Messages.Notify("CHAT","PARTY_PLAYER_LEADER",[party.leader.name]))}else{this.sendPlayer(new Messages.Notify("CHAT","PARTY_IS_LEADER",[party.leader.name]))}party.sendMembersName()},handlePartyLeave:function(msg){var party=this.player.party;var leader=party?party.leader:null;if(leader==null)return;if(!party){this.sendPlayer(new Messages.Notify("CHAT","PARTY_NOT_IN"));return}party.removePlayer(this.player);this.handlePartyAbandoned(party);this.sendToPlayer(leader,new Messages.Notify("CHAT","PARTY_PLAYER_LEFT",[this.player.name]));if(this.player!=leader)this.sendPlayer(new Messages.Notify("CHAT","PARTY_YOU_LEFT",[leader.name]))},handlePartyAbandoned:function(party){if(party.players.length==1){this.sendPlayer(new Messages.Notify("CHAT","PARTY_ALL_LEFT"));this.sendPlayer(new Messages.Party([]));if(this.player!==party.players[0]&&party.players[0]instanceof Player){this.sendToPlayer(party.players[0],new Messages.Notify("CHAT","PARTY_ALL_LEFT"));this.sendToPlayer(party.players[0],new Messages.Party([]))}this.server.removeParty(party)}},handleHarvest:function(msg){var self=this;var x=msg[0],y=msg[1];this.player.onHarvest(x,y)},handleHarvestEntity:function(msg){var id=parseInt(msg[0]);var entity=this.entities.getEntityById(id);this.player.onHarvestEntity(entity)},sendToPlayer:function(player,message){this.map.entities.pushToPlayer(player,message)},send:function(message){this.connection.send(message)}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./appearancedata":79,"./bank":82,"./character":85,"./chest":87,"./entityspawn":93,"./format":95,"./formulas":96,"./gather":97,"./inventory":98,"./items":102,"./lib/class":105,"./message":112,"./mob":114,"./mobdata":118,"./party":126,"./questdata":132,"./skilldata":135,"./skillhandler":136,"./taskhandler":137,"./trade":139,"./utils":146,bcrypt:undefined,"body-parser":undefined,express:undefined,underscore:75}],126:[function(require,module,exports){var cls=require("./lib/class");var MobData=require("./mobdata.js");var Messages=require("./message.js");module.exports=Party=Class.extend({init:function(player1,player2){this.players=[player1,player2];if(player1.party){player1.party.removePlayer(player1)}if(player2.party){player2.party.removePlayer(player2)}player1.party=this;player2.party=this;this.leader=player1;this.sendMembersName()},addPlayer:function(player){if(player){this.players.push(player);if(player.party){player.party.removePlayer(player)}player.party=this}this.sendMembersName()},removePlayer:function(player){var i=0;if(player==this.leader)this.leader=this.players[0];if(player){for(i=0;i<this.players.length;i++){if(player===this.players[i]){if(player instanceof Player)this.players[i].send([Types.Messages.PARTY]);this.players[i].party=null;this.players.splice(i,1);this.sendMembersName();break}}}},sendMembersName:function(){var i=0;var names=[];var players=this.players;if(players.length>1){names.push(this.leader.name);for(i=0;i<players.length;i++){if(players[i]!==this.leader)names.push(players[i].name)}}for(i=0;i<players.length;i++){if(players[i]instanceof Player)players[i].map.entities.pushToPlayer(players[i],new Messages.Party(names))}},sumTotalLevel:function(){var i=0;var sum=0;for(i=0;i<this.players.length;i++){sum+=this.players[i].level}return sum+1},getHighestLevel:function(){var i=0;var highestLevel=0;for(i=0;i<this.players.length;i++){if(highestLevel<this.players[i].level){highestLevel=this.players[i].level}}return highestLevel},getLowestLevel:function(){var i=0;var lowestLevel=999;for(i=0;i<this.players.length;i++){if(lowestLevel>this.players[i].level){lowestLevel=this.players[i].level}}return lowestLevel}})},{"./lib/class":105,"./message.js":112,"./mobdata.js":118}],127:[function(require,module,exports){var astar=require("./lib/astar");var Utils=require("./utils");module.exports=Pathfinder=Class.extend({init:function(width,height){this.width=width;this.height=height;this.grid=null;this.blankGrid=[];this.initBlankGrid_();this.ignored=[];this.included=[]},initBlankGrid_:function(){for(var i=0;i<this.height;i+=1){this.blankGrid[i]=[];for(var j=0;j<this.width;j+=1){this.blankGrid[i][j]=0}}},isPathTicksTooFast:function(entity,path,startTime){console.warn("checkPathTicks");var elapsed=Date.now()-startTime;var serverTicks=~~(elapsed*(entity.tick*G_FRAME_INTERVALS/G_UPDATE_INTERVAL_EXACT));serverTicks=Math.max(serverTicks,0);var playerTicks=this.getPathTicks(path,entity.x,entity.y);if(playerTicks==0){console.warn("isPathTicksTooFast: getPathTicks - "+JSON.stringify(path)+", x:"+entity.x+",y:"+entity.y);return false}var tolerance=G_UPDATE_INTERVAL*2;console.warn("SPEED HACK. playerTicks - tolerance: "+playerTicks+"-"+tolerance+", "+(playerTicks-tolerance)+" > serverTicks: "+serverTicks+", entity.latencyDiff: "+entity.latencyDiff);if(playerTicks-tolerance>serverTicks){console.error("SPEED HACK. playerTicks - tolerance: "+playerTicks+"-"+tolerance+", "+(playerTicks-tolerance)+" > serverTicks: "+serverTicks+", entity.latencyDiff: "+entity.latencyDiff);return true}return false},getPathTicks:function(path,x,y){count=0;var n2=null;for(var n1 of path){if(n2){if(x==n1[0]&&x==n2[0]&&y>=Math.min(n1[1],n2[1])&&y<=Math.max(n1[1],n2[1])){count+=Math.abs(n2[1]-y);break}if(y==n1[1]&&y==n2[1]&&x>=Math.min(n1[0],n2[0])&&x<=Math.max(n1[0],n2[0])){count+=Math.abs(n2[0]-x);break}else{count+=Math.abs(n1[0]-n2[0])+Math.abs(n1[1]-n2[1])}}n2=n1}return count},getPathTicks2:function(path){var node2;var total=0;for(var node1 of path){if(node2){total+=Math.abs(node1[0]-node2[0])+Math.abs(node1[1]-node2[1])}node2=node1}return total},getPathUntil:function(path,dist){if(dist<0)return null;var totalDist=this.getPathTicks2(path);var subDist=totalDist-dist;var node2;var newPath=[];var subTotal=0;for(var node1 of path){if(node2){var dx=Math.abs(node1[0]-node2[0]);var dy=Math.abs(node1[1]-node2[1]);var dist=dx+dy;subTotal+=dist;if(subTotal==subDist){newPath.push(node1);break}else if(subTotal>subDist){var node3=node1;var tdiff=subTotal-subDist;if(dx>0)node3[0]+=node1[0]-node2[0]<0?tdiff:-tdiff;if(dy>0)node3[1]+=node1[1]-node2[1]<0?tdiff:-tdiff;newPath.push(node3);break}}node2=node1;newPath.push(node1)}return newPath},isInPath:function(path,node){var tmpPath=path.map((function(arr){return arr.slice()}));var node1=tmpPath.shift();for(var node2 of tmpPath){if(node1[0]==node2[0]&&node1[1]>=node[1]&&node2[1]<=node[1]||node1[1]==node2[1]&&node1[0]>=node[0]&&node2[0]<=node[0])return true;node1=node2}return false},isValidPath:function(grid,path){var ts=G_TILESIZE,ly=grid.length,lx=grid[0].length;var c1to2on3=function(n1,n2,n3,axis){n1=Math.floor(n1),n2=Math.floor(n2),n3=Math.floor(n3);var i1=Math.min(n1,n2),i2=Math.max(n1,n2);if(axis=="x"){for(var i=i1;i<i2;i++){if(grid[n3][i]){return false}}}else{for(var i=i1;i<i2;i++){if(grid[i][n3]){return false}}}return true};var xf=function(x1,x2,y){return c1to2on3(x1,x2,y,"x")};var yf=function(y1,y2,x){return c1to2on3(y1,y2,x,"y")};var path2=[];for(var i=0;i<path.length;i++)path2[i]=path[i].slice();for(var coord of path2){coord[0]/=ts;coord[1]/=ts}var pCoord=null;for(var coord of path2){if(coord[1]<0||coord[1]>=ly)return false;if(coord[0]<0||coord[0]>=lx)return false;if(pCoord){if(coord[0]!=pCoord[0]&&coord[1]!=pCoord[1])return false;if(Math.abs(coord[0]-pCoord[0])>0){if(!xf(pCoord[0],coord[0],coord[1]))return false}else if(Math.abs(coord[1]-pCoord[1])>0){if(!yf(pCoord[1],coord[1],coord[0]))return false}}pCoord=coord}return true},getShortGrid:function(grid,start,end,gridEdges){var ts=G_TILESIZE;start=[start[0]/ts,start[1]/ts];end=[end[0]/ts,end[1]/ts];var minX=Math.max(Math.min(Math.floor(start[0]),Math.floor(end[0]))-gridEdges,0);var maxX=Math.min(Math.max(Math.ceil(start[0]),Math.ceil(end[0]))+gridEdges,grid[0].length-1);var minY=Math.max(Math.min(Math.floor(start[1]),Math.floor(end[1]))-gridEdges,0);var maxY=Math.min(Math.max(Math.ceil(start[1]),Math.ceil(end[1]))+gridEdges,grid.length-1);start=[start[0]-minX,start[1]-minY];end=[end[0]-minX,end[1]-minY];var crop=[];for(var i=minY;i<=maxY;++i){crop.push(grid[i].slice(minX,maxX))}return{crop:crop,minX:minX,minY:minY,substart:start,subend:end}},findNeighbourPath:function(start,end){var ts=G_TILESIZE;if(Math.abs(start[0]-end[0])<=ts&&Math.abs(start[1]-end[1])==0||Math.abs(start[1]-end[1])<=ts&&Math.abs(start[0]-end[0])==0)return[[start[0],start[1]],[end[0],end[1]]];return null},findShortPath:function(crop,offsetX,offsetY,start,end){var ts=G_TILESIZE;var path;var subpath=AStar.AStar(crop,start,end);if(subpath&&subpath.length>0){var path=[];var len=subpath.length;for(var j=0;j<len;++j){path[j]=[];path[j][0]=(subpath[j][0]+offsetX)*ts;path[j][1]=(subpath[j][1]+offsetY)*ts}return path}return null},findPath:function(grid,start,end,findIncomplete){var path;this.grid=grid;this.applyIgnoreList_(this.grid,true);this.applyIncludeList_(this.grid,true);path=AStar.AStar(this.grid,start,end);return path},findIncompletePath_:function(start,end){var perfect,x,y,incomplete=[];perfect=AStar.AStar(this.blankGrid,start,end);for(var i=perfect.length-1;i>0;i-=1){x=perfect[i][0];y=perfect[i][1];if(this.grid[y][x]===0){incomplete=AStar(this.grid,start,[x,y]);break}}return incomplete},ignoreEntity:function(entity){if(entity){this.ignored.push(entity)}},includeEntity:function(entity){if(entity){this.included.push(entity)}},applyIgnoreList_:function(grid,ignored){var self=this,x,y;_.each(this.ignored,(function(entity){x=entity.isMoving()?entity.nextGridX:entity.gx;y=entity.isMoving()?entity.nextGridY:entity.gy;if(x>=0&&y>=0){grid[y][x]=ignored?0:1}}))},applyIncludeList_:function(grid,included){var self=this,x,y;_.each(this.included,(function(entity){x=entity.isMoving()?entity.path.length>0?entity.path[entity.path.length-1][0]:entity.nextGridX:entity.gx;y=entity.isMoving()?entity.path.length>0?entity.path[entity.path.length-1][1]:entity.nextGridY:entity.gy;if(x>=0&&y>=0){grid[y][x]=included?1:0}}))},clearIgnoreList:function(grid){this.applyIgnoreList_(grid,false);this.ignored=[]},clearIncludeList:function(grid){this.applyIncludeList_(grid,false);this.ignored=[]}})},{"./lib/astar":104,"./utils":146}],128:[function(require,module,exports){var cls=require("./lib/class"),_=require("underscore"),Character=require("./character"),Chest=require("./chest"),Messages=require("./message"),Utils=require("./utils"),MobData=require("./mobdata"),Formulas=require("./formulas"),Party=require("./party"),Items=require("./items"),AppearanceData=require("./appearancedata"),Bank=require("./bank"),Types=require("../shared/js/gametypes"),ItemTypes=require("../shared/js/itemtypes"),bcrypt=require("bcrypt"),Equipment=require("./equipment"),Inventory=require("./inventory"),Main=require("./main"),Mob=require("./mob"),SkillHandler=require("./skillhandler"),SkillEffectHandler=require("./effecthandler"),Trade=require("./trade"),express=require("express"),bodyParser=require("body-parser"),app=express(),EntitySpawn=require("./entityspawn"),PacketHandler=require("./packethandler"),ItemLootData=require("./itemlootdata"),Quest=require("./quest");module.exports=Player=Character.extend({init:function(user,main,connection,worldServer){var self=this;this.user=user;this.main=main;this.server=worldServer;this.connection=connection;this.map=this.server.maps[0];this._super(this.connection.id,Types.EntityTypes.PLAYER,1,0,0,this.map,0);this.mapStatus=0;this.mapIndex=0;this.quests=[];this.gold=new Array(2);this.skillSlots=[];this.hasLoggedIn=false;this.hasEnteredGame=false;this.isDead=false;this.inventory=null;this.bank=null;this.equipment=null;this.itemStore=new Array(3);this.exp={base:0,attack:0,defense:0,move:0};this.level={base:0,attack:0,defense:0,move:0};this.stats={attack:0,defense:0,health:0,energy:0,luck:0,free:0,hp:0,hpMax:0,ep:0,epMax:0};this.mod={attack:0,defense:0,damage:0,health:0};this.cooltimeTimeout=null;this.consumeTimeout=null;this.skillHandler=new SkillHandler(this);this.moveSpeed=500;this.setMoveRate(this.moveSpeed);this.attackedTime=new Timer(1e3);this.attackQueue=[];this.moveQueue=[];this.stopQueue=[];this.attackSkill=[];this.attackTimer=0;this.idleTimer=new Timer(3e4);this.packetHandler=new PacketHandler(user,main,this,connection,worldServer,this.map);this.playerController=new PlayerController(this);this.onWelcomeReady=false;this.tut={};this.tut.move=false;this.tut.portal=false;this.tut.attack=false;this.tut.attack2=false;this.tut.buy=false;this.tut.buy2=false;this.tut.equip=false;this.tut.stats=false;this.spawnsList={};this.lastAction=Date.now();this.knownIds=[];this.sx=0;this.sy=0;this.ex=-1;this.ey=-1;this.moveOrientation=0;this.savedPlayer=false;this.savedQuests=false;this.savedInventory=false;this.savedEquipment=false;this.savedBank=false;this.savedAll=false;this.achievements=[]},destroy:function(){var self=this},getState:function(){var basestate=this._getBaseState();var sprite1=this.sprites[0],sprite2=this.getWeaponSprite();if(this.isArcher()){sprite1=this.sprites[2]}var state=[this.level.base,this.stats.hp,this.stats.hpMax,0,sprite1,sprite2,this.colors[0],this.colors[1]];return basestate.concat(state)},send:function(message){this.connection.send(message)},resetBars:function(){this.resetHP();this.resetEP();this.map.entities.pushNeighbours(this,new Messages.ChangePoints(this,0,0))},questAboutKill:function(mob,quest){var mobKind=mob.kind,mobLevel=mob.level;var a=quest.count<quest.object.count;var b=quest.type==QuestType.KILLMOBKIND&&a&&mobKind==quest.object.kind;var c=quest.type==QuestType.KILLMOBS&&a;var d=mob.level>=quest.object.level[0]&&mob.level<=quest.object.level[1];if((b||c)&&d){console.info("_questAboutKill - conditions met.");quest.data1+=~~(mob.stats.xp/3);if(++quest.count==quest.object.count){this.questAboutKillComplete(quest)}else{this.progressQuest(quest)}}},questAboutItem:function(quest){console.info(JSON.stringify(quest));var kind=quest.object2.kind+1e3;var countItems=this.inventory.hasItemCount(kind);quest.count=countItems;this.progressQuest(quest)},questAboutFind:function(quest){if(quest.count++>=quest.object.count&&quest.status==QuestStatus.INPROGRESS){quest.count=quest.object.count;var xp=quest.object.count*10*this.level.base;this.pushToPlayer(new Messages.Kill({id:0},this.level.base,xp));this.completeQuest(quest)}},questAboutItemComplete:function(quest,callback){if(quest.count>=quest.object2.count&&quest.status==QuestStatus.INPROGRESS){var kind=quest.object2.kind+1e3;if(!this.inventory.hasItemCount(kind))return;this.inventory.removeItemKind(kind,quest.object2.count);var xp=quest.object2.count*10*this.level.base;this.pushToPlayer(new Messages.Kill({id:0},this.level.base,xp));this.completeQuest(quest);if(callback)callback(quest);return true}return false},questAboutKillComplete:function(quest){console.info("_questAboutKill - completed.");var xp=quest.data1;this.incExp(xp);quest.status=QuestStatus.COMPLETE;this.pushToPlayer(new Messages.Kill({id:0},this.level.base,xp));this.completeQuest(quest)},progressQuest:function(quest){quest.status=QuestStatus.INPROGRESS;this.pushToPlayer(new Messages.Quest(quest))},completeQuest:function(quest){quest.status=QuestStatus.COMPLETE;this.pushToPlayer(new Messages.Quest(quest));delete quest},foundQuest:function(quest){this.quests.push(quest);quest.status=QuestStatus.STARTED;this.pushToPlayer(new Messages.Quest(quest))},getQuestById:function(id){for(var q of this.quests){if(q.id==id){return q}}return null},incExp:function(gotexp){var incExp=parseInt(gotexp);incExp=Math.ceil(incExp*this.getExpBonus());this.exp.base=parseInt(this.exp.base)+parseInt(incExp);var origLevel=this.level.base;this.level.base=Types.getLevel(this.exp.base);if(origLevel!==this.level.base){this.levelUp()}return incExp},incAttackExp:function(gotexp){var incExp=parseInt(gotexp);incExp=Math.ceil(incExp*this.getExpBonus());this.exp.attack=parseInt(this.exp.attack)+parseInt(incExp);var origLevel=this.level.attack;this.level.attack=Types.getAttackLevel(this.exp.attack);if(origLevel!==this.level.attack){this.pushToPlayer(new Messages.LevelUp(2,this.level.attack,this.exp.attack))}return incExp},incDefenseExp:function(gotexp){var incExp=parseInt(gotexp);incExp=Math.ceil(incExp*this.getExpBonus());this.exp.defense=parseInt(this.exp.defense)+parseInt(incExp);var origLevel=this.level.defense;this.level.defense=Types.getDefenseLevel(this.exp.defense);if(origLevel!==this.level.defense){this.pushToPlayer(new Messages.LevelUp(3,this.level.defense,this.exp.defense))}return incExp},incMoveExp:function(gotexp){var incExp=parseInt(gotexp);incExp=Math.ceil(incExp*this.getExpBonus());this.exp.move=parseInt(this.exp.move)+parseInt(incExp);var origLevel=this.level.move;this.level.move=Types.getMoveLevel(this.exp.move);if(origLevel!==this.level.move){this.pushToPlayer(new Messages.LevelUp(4,this.level.move,this.exp.move))}return incExp},getExpBonus:function(){var bonus=1;if(this.party){for(var player of this.party.players){if(this.isInScreen([player.x,player.y])){bonus+=.1*this.players.length}}}return bonus},levelUp:function(){if(this.level.base<10){this.stats.attack+=2;this.stats.defense+=2;this.stats.health+=2;this.stats.energy+=2;this.stats.luck+=2}else{this.stats.free+=5}this.pushToPlayer(new Messages.StatInfo(this));this.resetBars();this.pushToPlayer(new Messages.ChangePoints(this,0,0));this.pushToPlayer(new Messages.LevelUp(1,this.level.base,this.exp.base));if(this.level.base==10){this.tutChat("TUTORIAL_SHOPBUY",4,"buy");this.tutChat("TUTORIAL_SHOPBUY2",6,"buy2")}if(this.level.base==20){this.tutChat("TUTORIAL_STATS",2,"stats")}},sendPlayer:function(db_player){var self=this;var sendMessage;self.mapIndex=parseInt(db_player.map[0]);self.map=self.server.maps[self.mapIndex];self.x=parseInt(db_player.map[1]);self.y=parseInt(db_player.map[2]);self.orientation=parseInt(db_player.map[3]);self.sprites=db_player.sprites.parseInt();self.colors=db_player.colors;self.exp.base=parseInt(db_player.exps[0]);self.exp.attack=parseInt(db_player.exps[1]);self.exp.defense=parseInt(db_player.exps[2]);self.exp.move=parseInt(db_player.exps[3]);if(db_player.exps.length==8){self.exp.sword=parseInt(db_player.exps[4]);self.exp.bow=parseInt(db_player.exps[5]);self.exp.hammer=parseInt(db_player.exps[6]);self.exp.axe=parseInt(db_player.exps[7])}else{self.exp.sword=0;self.exp.bow=0;self.exp.hammer=0;self.exp.axe=0}if(db_player.exps.length==10){self.exp.logging=parseInt(db_player.exps[8]);self.exp.mining=parseInt(db_player.exps[9])}else{self.exp.logging=0;self.exp.mining=0}self.level.base=Types.getLevel(self.exp.base);self.level.attack=Types.getAttackLevel(self.exp.attack);self.level.defense=Types.getDefenseLevel(self.exp.defense);self.level.move=Types.getMoveLevel(self.exp.move);self.gold[0]=parseInt(db_player.gold[0]);self.gold[1]=parseInt(db_player.gold[1]);self.isDead=false;self.pStats=db_player.pStats.parseInt();if(self.level.base<10){var l=parseInt(self.level.base);self.stats.attack=l*2;self.stats.defense=l*2;self.stats.health=l*2;self.stats.energy=l*2;self.stats.luck=l*2;self.stats.free=0}else{db_player.stats=db_player.stats.parseInt();self.stats.attack=db_player.stats[0];self.stats.defense=db_player.stats[1];self.stats.health=db_player.stats[2];self.stats.energy=db_player.stats[3];self.stats.luck=db_player.stats[4];self.stats.free=db_player.stats[5]}self.setHP();self.setEP();self.resetBars();self.setMoveRate(500-self.level.move);self.attackTimer=Date.now();self.server.connect_callback(self);var sendMessage;DBH.getItems(self,2,(function(eItems){self.equipment=new Equipment(self,2,eItems);self.itemStore[2]=self.equipment;DBH.getItems(self,1,(function(bItems){self.bank=new Bank(self,48,bItems);self.itemStore[1]=self.bank;DBH.getItems(self,0,(function(iItems){self.inventory=new Inventory(self,48,iItems);self.itemStore[0]=self.inventory;DBH.loadAchievements(self,(function(achievements){DBH.loadQuests(self,(function(quests){console.info("loaded quest");console.info("sendMessage");var i=0;var sendMessage=[Types.Messages.SC_PLAYER,0,Date.now(),self.id,self.name,self.mapIndex,self.x,self.y,self.stats.hp,self.stats.ep,self.exp.base,self.exp.attack,self.exp.defense,self.exp.move,self.exp.sword,self.exp.bow,self.exp.hammer,self.exp.axe,self.exp.logging,self.exp.mining,self.colors[0],self.colors[1],self.gold[0],self.gold[1],self.user.gems,self.stats.attack,self.stats.defense,self.stats.health,self.stats.energy,self.stats.luck,self.stats.free];console.info("sendMessage - Equipment");sendMessage.push(Object.keys(self.equipment.rooms).length);for(var equipIndex in self.equipment.rooms){var item=self.equipment.rooms[equipIndex];sendMessage=sendMessage.concat(item.toArray())}self.setRange();sendMessage.push(self.isArcher()?self.sprites[2]:self.sprites[0]);sendMessage.push(self.getWeaponSprite());console.info("sendMessage - Inventory");sendMessage.push(Object.keys(self.inventory.rooms).length);for(var invIndex in self.inventory.rooms){var item=self.inventory.rooms[invIndex];sendMessage=sendMessage.concat(item.toArray())}console.info("sendMessage - Bank");sendMessage.push(Object.keys(self.bank.rooms).length);for(var bankIndex in self.bank.rooms){var item=self.bank.rooms[bankIndex];sendMessage=sendMessage.concat(item.toArray())}var quests=self.quests.filter((function(q){return q.status!==QuestStatus.COMPLETE}));sendMessage.push(quests.length);for(var questIndex=0;questIndex<quests.length;++questIndex){var q=quests[questIndex];console.info(JSON.stringify(q));sendMessage=sendMessage.concat(q.toClient())}var achievements=self.achievements;sendMessage.push(achievements.length);for(var achieveIndex=0;achieveIndex<achievements.length;++achieveIndex){var achievement=achievements[achieveIndex];console.info(JSON.stringify(achievement));sendMessage=sendMessage.concat(achievement.toClient(achievement))}self.skillHandler.setSkills(self,db_player.skills);self.effectHandler=new SkillEffectHandler(self);sendMessage.push(self.skills.length);for(var i=0;i<self.skills.length;++i){sendMessage.push(parseInt(self.skills[i].skillXP))}self.skillSlots=db_player.skillSlots;sendMessage.push(self.skillSlots.length);for(var i=0;i<self.skillSlots.length;++i){sendMessage.push(parseInt(self.skillSlots[i]))}if(self.server.enter_callback){self.map.entities.addPlayer(self);self.server.enter_callback(self);self.connection.sendUTF8(sendMessage.join(","));self.hasEnteredGame=true}}))}))}))}))}))},tutChat:function(text,delay,check){var self=this;var tutCheck=check;setTimeout((function(){if(self.map&&self.map.entities&&self.mapStatus>=2&&self.tut[tutCheck]==false){self.pushToPlayer(new Messages.Notify("TUTORIAL",text));self.tut[tutCheck]=true}}),delay*5e3)},handleInventoryEat:function(item,slot){var self=this;var kind=item.itemKind;if(this.consumeTimeout){return}else{this.consumeTimeout=setTimeout((function(){self.consumeTimeout=null}),4e3)}var amount;var itemData=ItemTypes.KindData[kind];if(itemData.typemod=="health"){amount=itemData.modifier;if(!this.hasFullHealth()){this.modHealthBy(amount)}}else if(itemData.typemod=="healthpercent"){amount=~~(this.stats.hpMax*itemData.modifier/100);if(!this.hasFullHealth()){this.modHealthBy(amount)}}if(itemData.typemod=="energy"){amount=itemData.modifier;if(!this.hasFullEnergy()){this.modEnergyBy(amount)}}this.inventory.takeOutItems(slot,1)},modHealthBy:function(hp){if(this.isDead)return;var msg=this._super(hp);this.sendChangePoints(hp,0);return msg},modEnergyBy:function(ep){var msg=this._super(ep);this.sendChangePoints(0,ep);return msg},sendChangePoints:function(health,energy){this.map.entities.pushNeighbours(this,new Messages.ChangePoints(this,health,energy))},getHPMax:function(){var hp=300+this.stats.health*50+this.stats.health*this.stats.health*2;return hp},getEPMax:function(){var ep=500+this.stats.energy*50;return ep},getWeaponLevel:function(){var weapon=this.equipment.rooms[4];if(!weapon)return 0;var weaponData=ItemTypes.KindData[weapon.itemKind];return Types.getWeaponLevel(this.exp[weaponData.type])},addWeaponExp:function(damage){var weapon=this.equipment.rooms[4];if(!weapon)return;var weaponData=ItemTypes.KindData[weapon.itemKind];this.exp[weaponData.type]+=~~(damage/100);var xp=this.exp[weaponData.type];var types={sword:10,bow:11,hammer:12,axe:13};var lvl=Types.getWeaponLevel(xp);if(this.level[weaponData.type]!=lvl){var msg=new Messages.LevelUp(types[weaponData.type],lvl,xp);this.pushToPlayer(msg)}this.level[weaponData.type]=lvl},baseCrit:function(){var itemDiff=this.level.base*2;var item=this.equipment.rooms[4];if(item){itemDiff=3*ItemTypes.getData(item.itemKind).modifier+item.itemNumber*2}var statDiff=this.stats.attack+this.stats.luck*2;var chance=Utils.clamp(0,500,~~(statDiff+itemDiff));console.info("player - baseCrit: "+chance);return chance},baseCritDef:function(){var itemDiff=this.level.base*2;for(var id in this.equipment.rooms){if(id==4)continue;var item=this.equipment.rooms[id];if(item){itemDiff+=3*ItemTypes.getData(item.itemKind).modifier+item.itemNumber*2}}var statDiff=this.stats.defense+this.stats.luck*2;var chance=Utils.clamp(0,500,~~(statDiff+itemDiff));console.info("player - baseCritDef: "+chance);return chance},baseDamage:function(){var dealt,dmg;var weapon=this.equipment.rooms[4];var level=this.level.base;dealt=~~(weapon?ItemTypes.getData(weapon.itemKind).modifier*3+weapon.itemNumber*2:level);var power=this.level.attack/50+1;power*=this.getWeaponLevel()/50+1;if(weapon){dealt=~~(dealt*(weapon.itemDurability/weapon.itemDurabilityMax*.5+.5))}var mods=this.mod?this.mod.attack:0;dealt+=(this.stats.attack+mods)*3+this.stats.luck;var min=~~(level*power);var max=~~(min*3);dmg=Utils.randomRangeInt(min,max)+dealt;var noobLvl=10;var noobMulti=1+Math.max(0,(noobLvl-this.level.base)*(.5/noobLvl));var rangeMulti=this.isArcher()?.85:1;dmg=~~(dmg*noobMulti*rangeMulti);min=~~((min+dealt)*noobMulti*rangeMulti);max=~~((max+dealt)*noobMulti*rangeMulti);return dmg},baseDamageDef:function(){var dealt=0,dmg=0;var level=this.level.base+3;console.info("baseDamageDef:");dealt=level;for(var id in this.equipment.rooms){var item=this.equipment.rooms[id];if(item){var eq_multi=id==1?4:2;var def=ItemTypes.getData(item.itemKind).modifier*eq_multi+item.itemNumber*eq_multi;dealt+=~~(def*(item.itemDurability/item.itemDurabilityMax*.5+.5))}}console.info("dealt="+dealt);var power=this.level.defense/50+1;console.info("power="+power);var min=~~(level*power);var max=~~(min*2);console.info("dealtrange="+dealt);var mods=this.mod?this.mod.defense:0;dealt+=~~((this.stats.defense+mods)*3)+this.stats.luck;console.info("dealtstats="+dealt);dmg=Utils.randomRangeInt(min,max)+dealt;min+=dealt;max+=dealt;return dmg},modifyGold:function(gold,type){type=type||0;if(this.gold[type]+gold<0)return false;this.gold[type]+=parseInt(gold);this.pushToPlayer(new Messages.Gold(this));if(gold>0)this.pushToPlayer(new Messages.Notify("CHAT","GOLD_ADDED",[gold]));else{gold*=-1;this.pushToPlayer(new Messages.Notify("CHAT","GOLD_REMOVED",[gold]))}return true},save:function(){var self=this;console.info("SAVING PLAYER: "+this.name);DBH.savePlayer(this);DBH.saveQuests(this,this.quests);DBH.saveAchievements(this);if(this.inventory)this.inventory.save(this);if(this.equipment)this.equipment.save(this);if(this.bank)this.bank.save(this);self.playerSaved=setInterval((function(){if(!self.savedPlayer)return;if(!self.savedQuests)return;if(!self.savedAchievements)return;if(!self.savedInventory)return;if(!self.savedEquipment)return;if(!self.savedBank)return;self.savedAll=true;clearInterval(self.playerSaved)}),G_UPDATE_INTERVAL);if(!SAVING_SERVER){self.playerSaveReset=setInterval((function(){if(self.savedAll){self.savedPlayer=false;self.savedQuests=false;self.savedInventory=false;self.savedEquipment=false;self.savedBank=false;self.savedAchievements=false;self.savedAll=false;clearInterval(self.playerSaveReset)}}),G_ROUNDTRIP)}},isArcher:function(){var weapon=this.equipment.rooms[4];if(weapon&&ItemTypes.isArcherWeapon(weapon.itemKind)){return true}return false},setRange:function(){this.setAttackRange(1);if(this.isArcher()){this.setAttackRange(10)}},setHP:function(val){this._super(val)},setEP:function(val){this._super(val)},movePath:function(data,path){var x=path[0][0],y=path[0][1],x2=path[path.length-1][0],y2=path[path.length-1][1],time=data[0],interrupted=data[1];console.info("set path");if(this.keyMove){this.move(this.orientation,0,this.ex,this.ey)}this.sx=this.x;this.sy=this.y;this.ex=this.x2;this.ey=this.y2;if(!(this.x==x&&this.y==y)){console.error("movePath - Start Position not correct!");console.info("movePath - x:"+x+",y:"+y+",p.x:"+this.x+",p.y:"+this.y)}this.forceStop();orientation=this.getOrientationTo({x:path[1][0],y:path[1][1]});this.setOrientation(orientation);this.path=this.fullpath=path;this.step=0;this.interrupted=interrupted;var delay=~~(Date.now()+G_UPDATE_INTERVAL-(G_LATENCY+time));this.unclampedDelay=delay;delay=Utils.clamp(0,G_LATENCY,delay);this.latencyDiff=Date.now()-time;this.startMovePathTime=time+delay;console.warn("movePath: delay:"+delay);if(delay>0)this.setFreeze(delay)},move:function(nm){var p=self=this;if(!nm)return;var time=nm[0],state=nm[1],o=nm[2],x=nm[3],y=nm[4];console.info("nm:"+JSON.stringify(nm));if(this.isMovingPath()){return}if(this.moving_callback){clearTimeout(this.moving_callback);this.moving_callback=null}if(state==3){this.moveOrientation=0;this.sx=x;this.sy=y;this.ex=-1;this.ey=-1;this.keyMove=false;this.setPosition(x,y);this.nextMove=null;return}if(state==1){var delay=Math.max(~~(G_LATENCY+time-(Date.now()+G_UPDATE_INTERVAL)),0);console.warn("unclamped delay="+delay);this.unclampedDelay=delay;delay=Utils.clamp(0,G_LATENCY,delay);console.warn("delay="+delay);this.latencyDiff=Date.now()-time;this.startMoveTime=time+delay;this.nsx=this.x;this.nsy=this.y;var execMove=function(){if(self.movement.inProgress){self.forceStop()}self.moving_timeout=null;self.startMoving=true;self.moveOrientation=o;self.sx=self.x;self.sy=self.y;self.ex=-1;self.ey=-1;self.keyMove=true;self.startMoveTime=Date.now();return};if(delay<=0)execMove();else this.moving_timeout=setTimeout(execMove,delay);this.nextMove=null}if(state==0){console.info("move - x: "+x+", y: "+y);this.ex=x;this.ey=y;var a=x==this.x&&y==this.y;var b=this.sx==x&&this.sy==y;var c=this.nsx==x&&this.nsy==y;console.info("move: x="+x+",y="+y);console.info("move: this.x="+this.x+",this.y="+this.y);console.info("move: this.sx="+this.sx+",this.sy="+this.sy);console.info("move: this.nsx="+this.nsx+",this.nsy="+this.nsy);if(a||b||c){clearTimeout(this.moving_timeout);this.setPosition(x,y);this.forceStopMove();return}var path=[[this.sx,this.sy],[x,y]];if(!this.map.entities.pathfinder.isValidPath(this.map.grid,path)){console.warn("INVALID PATH.");console.warn("invalidPath: "+JSON.stringify(path));this.setPosition(this.x,this.y);this.forceStopMove()}if(this.map.entities.pathfinder.isPathTicksTooFast(this,path,this.startMoveTime)){this.setPosition(this.sx,this.sy)}else{this.setPosition(x,y)}this.forceStopMove();this.keyMove=false;this.nextMove=null}},getStoredItem:function(type,slot,count){var store=this.itemStore[type];var rooms=store.rooms;if(slot<0||slot>=rooms.length)return null;var item=rooms[slot];if(!item)return;var count2=rooms[slot].itemNumber;if(ItemTypes.isLootItem(item.itemKind)||ItemTypes.isConsumableItem(item.itemKind)){if(count>0&&count2>0&&count2<count)item=store.takeOutItems(slot,count2)}return item},swapItem:function(slot,slot2){console.info(JSON.stringify(slot));console.info(JSON.stringify(slot2));var store1=this.itemStore[slot[0]];var store2=this.itemStore[slot2[0]];var room1=store1.rooms;var rs1=room1[slot[1]];if(!rs1)return;if(!ItemTypes.isConsumableItem(rs1.itemKind)&&slot2[0]==0&&slot2[1]>=0&&slot2[1]<6)return;if(ItemTypes.isConsumableItem(rs1.itemKind)&&slot2[0]==0&&slot2[1]<0&&slot2[1]>=6)return;var room2=store2.rooms;var rs2=null;if(slot2[1]>=0)rs2=room2[slot2[1]];if(rs1==rs2)return;if(rs2){if(this.inventory.combineItem(rs1,rs2)==-1){var tmp=rs2;if(store2.checkItem(slot2[1],rs1)&&store1.checkItem(slot[1],rs2)){store2.setItem(slot2[1],rs1);store1.setItem(slot[1],rs2)}}}else if(slot2[1]>=0){if(store2.setItem(slot2[1],rs1))store1.setItem(slot[1],null)}else{if(slot2[1]==2)return;store2.putItem(rs1);store1.setItem(slot[1],null)}},storeItem:function(slot,slot2){this.swapItem(slot,slot2)},handleEquip:function(slot,slot2){console.info("handleEquip");this.swapItem(slot,slot2)},handleStoreEmpty:function(slot,item){var kind=item.itemKind;var store=this.itemStore[slot[0]];var index=slot[1];var count=slot[2];if(slot[0]==2){console.error("handleStoreEmpty - Cannot empty equipment store.");return}var itemRoom=store.rooms[slot[1]];var newItemRoom=Object.assign(new ItemRoom,itemRoom);var item=this.map.entities.createItem(newItemRoom,this.x,this.y);count=Utils.clamp(1,itemRoom.itemNumber,count);if(!ItemTypes.isEquippable(kind)){item.room.itemNumber=count;store.takeOutItems(index,count)}else{store.makeEmptyItem(index)}this.map.entities.pushNeighbours(this,item.spawn());this.knownIds.push(item.id);this.server.handleItemDespawn(item)},sendCurrentMove:function(){var msg=new Messages.Move(this,this.moveOrientation,0,this.x,this.y);this.map.entities.pushNeighbours(this,msg)},dropGold:function(){var count=Math.ceil(Math.random()*this.level.base*5+this.level.base);count=Math.min(count,this.gold[0]);this.modifyGold(-count);return count},revive:function(){this.isDead=false;this.isDying=false;this.hasEnteredGame=true;this.resetBars()},setPosition:function(x,y){this._super(x,y);if(this.holdingBlock){var ts=G_TILESIZE;var posArray=[[x,y],[x,y-ts],[x,y+ts],[x-ts,y],[x+ts,y]];var pos=posArray[this.orientation];this.holdingBlock.setPosition(pos[0],pos[1])}},isInScreen:function(pos){return~~(Math.abs(this.x-pos[0])/G_TILESIZE)<=~~(G_SCREEN_WIDTH/2)&&~~(Math.abs(this.y-pos[1])/G_TILESIZE)<=~~(G_SCREEN_HEIGHT/2)},getWeapon:function(){var weapon=this.equipment.rooms[4];return weapon},hasHarvestWeapon:function(){var weapon=this.getWeapon();if(!weapon)return false;return ItemTypes.isHarvestWeapon(weapon.itemKind)},getWeaponType:function(){var weapon=this.getWeapon();if(!weapon)return null;var weaponData=ItemTypes.KindData[weapon.itemKind];return weaponData.type},getWeaponSprite:function(){var type=this.getWeaponType();if(!type)return 0;if(type=="sword")return 1;if(type=="axe")return 2;if(type=="hammer")return 12;if(type=="bow")return 50;return 0},_harvest:function(x,y,callback,duration){var p=this;var valid=p._checkHarvest(x,y);if(!valid){p._abortHarvest(x,y);return}var px=p.x,py=p.y;var type=p.getWeaponType();p.isHarvesting=true;var exp=this.exp.logging;if(type=="hammer")exp=this.exp.mining;var durationMod=Utils.clamp(.1,1,1-Types.getSkillLevel(exp)/20);duration=~~(duration*durationMod);clearTimeout(p.harvestTimeout);p.harvestTimeout=setTimeout((function(){var complete=true;if(!p.isHarvesting)complete=false;if(!(p.x==px&&p.y==py))complete=false;if(type!=p.getWeaponType())complete=false;if(!complete){p._abortHarvest(x,y);return}var xpMod=10;if(type=="hammer")p.exp.mining+=xpMod;else p.exp.logging+=xpMod;if(callback)callback(p);p.map.entities.pushNeighbours(p,new Messages.Harvest(p,2,x,y))}),duration);p.map.entities.pushNeighbours(p,new Messages.Harvest(p,1,x,y))},_checkHarvest:function(x,y){var p=this;if(!p.isNextToo(x,y))return false;if(!p.hasHarvestWeapon())return false;return true},onHarvestEntity:function(entity){var res=true;var type=this.getWeaponType();if(!type){res=false}if(type!=entity.weaponType){this.pushToPlayer(new Messages.Notify("CHAT","HARVEST_WRONG_TYPE",type));res=false}var x=entity.x,y=entity.y;if(!res){this._abortHarvest(x,y);return}var duration=5e3+entity.level*1e3;this._harvest(x,y,(function(p){entity.die();var item=p.server.getDrop(p,entity,false);if(item&&item instanceof Item){item.x=x;item.y=y;p.server.handleItemDespawn(item)}return}),duration)},_abortHarvest:function(x,y){var p=this;p.map.entities.pushNeighbours(p,new Messages.Harvest(p,2,x,y));p.pushToPlayer(new Messages.Notify("CHAT","HARVEST_INVALID"))},onHarvest:function(x,y){var p=this;var gp=Utils.getGridPosition(x,y);time=p.map.entities.harvest[gp.gx+"_"+gp.gy];var res=true;var type=p.getWeaponType();if(!type){res=false}if(!this.map.isHarvestTile(gp,type)){p.pushToPlayer(new Messages.Notify("CHAT","HARVEST_WRONG_TYPE",type));res=false}if(time&&Date.now()-time<6e4){res=false}if(!res){this._abortHarvest(x,y);return}var duration=6e3;p._harvest(x,y,(function(p){p.map.entities.harvest[gp.gx+"_"+gp.gy]=Date.now();if(p.inventory.hasRoom()){var kind;if(p.getWeaponType()=="axe")kind=320;var item=new ItemRoom(kind,1,0,0);if(self.inventory.putItem(item)==-1)return;var data=ItemTypes.getData(item.itemKind);p.pushToPlayer(new Messages.Notify("CHAT","HARVEST_ADDED",data.name))}}),duration)},pushToPlayer:function(msg){this.map.entities.pushToPlayer(this,msg)}})},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./appearancedata":79,"./bank":82,"./character":85,"./chest":87,"./effecthandler":90,"./entityspawn":93,"./equipment":94,"./formulas":96,"./inventory":98,"./itemlootdata":100,"./items":102,"./lib/class":105,"./main":107,"./message":112,"./mob":114,"./mobdata":118,"./packethandler":125,"./party":126,"./quest":131,"./skillhandler":136,"./trade":139,"./utils":146,bcrypt:undefined,"body-parser":undefined,express:undefined,underscore:75}],129:[function(require,module,exports){var Messages=require("./message"),_=require("underscore"),Utils=require("./utils");module.exports=PlayerController=Class.extend({init:function(entity){this.player=entity;this.entities=this.player.map.entities;this.setCallbacks()},setCallbacks:function(){var self=this;self.player.onStep((function(player,x,y){}));self.player.onRequestPath((function(x,y){var p=self.player;return self.entities.findPath(p,x,y)}));var checkContinueMove=function(x,y){};var attackFunc=function(p){p.packetHandler.processAttack()};var stopPathing=function(x,y){console.info("onStopPathing");var p=self.player;if(self.entities.pathfinder.isPathTicksTooFast(p,p.fullpath,p.startMovePathTime))p.setPosition(p.sx,p.sy);else p.setPosition(x,y);p.sx=p.x;p.sy=p.y;console.info("p.x:"+p.x+",p.y="+p.y);attackFunc(p)};self.player.onStopPathing((function(x,y){console.info("onStopPathing");stopPathing(x,y)}));self.player.onAbortPathing((function(x,y){console.info("onAbortPathing");stopPathing(x,y)}));self.player.checkStopDanger=function(c,o){var res=false;if(c.ex==-1&&c.ey==-1){return false}if(c.x==c.ex&&c.y==c.ey){console.warn("checkStopDanger - coordinates equal");return true}var x=c.x,y=c.y;if(o==Types.Orientations.LEFT&&c.x<c.ex){res=true}else if(o==Types.Orientations.RIGHT&&c.x>c.ex){res=true}else if(o==Types.Orientations.UP&&c.y<c.ey){res=true}else if(o==Types.Orientations.DOWN&&c.y>c.ey){res=true}if(res){c.setPosition(c.ex,c.ey);console.warn("WARN - PLAYER "+c.id+" not stopping.");console.warn("orientation: "+Utils.getOrientationString(o));console.warn("x :"+x+",y :"+y);console.warn("sx:"+c.ex+",sy:"+c.ey)}return res};self.player.setMoveStopCallback((function(){var p=self.player;console.info("setMoveStopCallback");console.info("player, x:"+p.x+",y:"+p.y);p.checkStopDanger(p,p.moveOrientation);if(!(p.ex==-1&&p.ey==-1)&&!(p.x==p.ex&&p.y==p.ey)){console.warn("ERROR - MOVING NOT SYNCHED PROPERLY, FORCING CLIENT UPDATE");console.info("player, orientation:"+p.moveOrientation);console.info("player, x:"+p.x+",y:"+p.y);console.info("player, sx:"+p.sx+",sy:"+p.sy);console.info("player, ex:"+p.ex+",ey:"+p.ey);p.setPosition(p.sx,p.sy);p.sendCurrentMove()}attackFunc(p)}))}})},{"./message":112,"./utils":146,underscore:75}],130:[function(require,module,exports){var cls=require("./lib/class");var ProductionConfig={};ProductionConfig=cls.Class.extend({init:function(config){this.config=config;try{this.production=require("../production_hosts/"+config.production+".js")}catch(err){this.production=null}},inProduction:function(){if(this.production!==null){return this.production.isActive()}return false},getProductionSettings:function(){if(this.inProduction()){return this.production}}});module.exports=ProductionConfig},{"./lib/class":105}],131:[function(require,module,exports){var cls=require("./lib/class");module.exports=getQuestObject=function(arr){var self={};self.toArray=function(obj){return[obj.type,obj.kind,obj.count,obj.chance,obj.level[0],obj.level[1]]};self.toClient=function(obj){return[obj.type,obj.kind,obj.count]};self.type=parseInt(arr[0]);self.kind=parseInt(arr[1])||0;self.count=parseInt(arr[2])||0;self.chance=parseInt(arr[3])||0;if(arr.length==6)self.level=[parseInt(arr[4]),parseInt(arr[5])];else self.level=[0,99];return self};module.exports=Quest=cls.Class.extend({init:function(qArray){this.id=parseInt(qArray[0]);this.type=parseInt(qArray[1]);this.npcId=parseInt(qArray[2]);this.count=parseInt(qArray[3])||0;this.status=parseInt(qArray[4])||0;this.data1=parseInt(qArray[5])||0;this.data2=parseInt(qArray[6])||0;this.object=qArray[7]||null;this.object2=qArray[8]||null},toArray:function(){var cols=[this.id,this.type,this.npcId,this.count,this.status,this.data1,this.data2];if(this.object){cols=cols.concat(this.object.toArray(this.object))}if(this.object2){cols=cols.concat(this.object2.toArray(this.object2))}return cols},toClient:function(){var cols=[this.id,this.type,this.npcId,this.count,this.status];if(this.object){cols=cols.concat(this.object.toClient(this.object))}else{cols=cols.concat(["","",""])}if(this.object2){cols=cols.concat(this.object2.toClient(this.object2))}else{cols=cols.concat(["","",""])}return cols},toString:function(){return this.toArray().join(",")}})},{"./lib/class":105}],132:[function(require,module,exports){var _=require("underscore"),Utils=require("./utils"),Quest=require("./quest"),QuestsJson=require("../shared/data/quests.json"),Log=require("log");var QuestData={};var QuestNpcData={};for(var id in QuestsJson){var data=QuestsJson[id];console.info("data:"+JSON.stringify(data));var quest={};quest.id=id;quest.raw=data;quest.npcId=data.npcId;quest.type=data.type;quest.level=data.level;if(data.object){quest.object=getQuestObject([data.object.type,data.object.kind,data.object.count||0,data.object.chance||0,data.object.level||[0,99]])}if(data.object2){quest.object2=getQuestObject([data.object2.type,data.object2.kind,data.object2.count||0,data.object2.chance||0,data.object2.level||[0,99]])}QuestData[quest.id]=quest;if(!QuestNpcData[quest.npcId])QuestNpcData[quest.npcId]=[];QuestNpcData[quest.npcId].push(quest)}module.exports.Data=QuestData;module.exports.NpcData=QuestNpcData},{"../shared/data/quests.json":164,"./quest":131,"./utils":146,log:60,underscore:75}],133:[function(require,module,exports){var crypto=require("crypto");var fs=require("fs");var redis=require("redis");var bcrypt=require("bcrypt");var Utils=require("./utils");var cls=require("./lib/class"),Player=require("./player"),Messages=require("./message"),ItemTypes=require("./../shared/js/itemtypes"),Quest=require("./quest"),inventory=require("./inventory"),SkillData=require("./skilldata"),AppearanceData=require("./appearancedata"),Auction="./auction",TaskHandler="./taskhandler",Items=require("./items");var client;var hgetarray=function(hash,key,callback){if(Array.isArray(key)){var m=client.multi();for(var i=0;i<key.length;++i)m.hget(hash,key[i]);m.exec(callback)}else{client.hget(hash,key,callback)}};module.exports=DatabaseHandler=cls.Class.extend({init:function(config){var self=this;client=redis.createClient(config.redis_port,config.redis_host,{socket_nodelay:true});client.auth(config.redis_password);client.on("error",(function(err){console.error("Redis error: "+err)}));client.hgetarray=hgetarray;self.ready=true},removeLegacyItems:function(){var self=this;client.keys("*",(function(err,keys){if(err)return console.log(err);for(var i=0,len=keys.length;i<len;i++){var key=keys[i];if(key.startsWith("u:")){var username=key.substr(2)}if(!key.startsWith("p:"))continue;client.hgetall(key,(function(err,value){if(err)return console.log(err);var name=value.name;var it=0;var totalGold=0;var funcGold=function(gold){totalGold+=gold;if(++it==3){if(totalGold>0){self.modifyGold(name,totalGold)}}};for(var j=0;j<3;++j){var func=function(items,type){var gold=0;var k=items.length;while(k--){item=items[k];if(ItemTypes.isLootItem(item.itemKind))continue;var data=Items.Kinds[item.itemKind];if(!data){items.splice(items.indexOf(item),1);continue}if(data&&data.legacy==1){var itemNumber=item.itemNumber;var tmpItem=Object.assign({},item);for(var l=1;l<itemNumber;++l){tmpItem.itemNumber=l;gold+=ItemTypes.getEnchantPrice(tmpItem)}tmpItem.itemNumber=1;gold+=ItemTypes.getBuyPrice(tmpItem.itemKind);items.splice(items.indexOf(item),1)}}self.saveItems({name:name},type,items);funcGold(gold)};self.getItems({name:name},j,func)}}))}}))},createUser:function(user){var self=this;var uKey="u:"+user.name;var curTime=(new Date).getTime();var lenLooks=AppearanceData.Data.length;user.looks=new Uint8Array(lenLooks);for(var i=0;i<lenLooks;++i)user.looks[i]=0;user.looks[0]=1;user.looks[50]=1;user.looks[77]=1;user.looks[151]=1;user.gems=2e3;client.sismember("usr",user.name,(function(err,reply){if(reply===1){user.connection.sendUTF8(Types.Messages.SC_ERROR+",userexists");user.connection.close("Username not available: "+user.name)}else{var looksHex=Utils.BinToHex(user.looks);client.multi().sadd("usr",user.name).hset(uKey,"username",user.name).hset(uKey,"hash",user.hash).hset(uKey,"salt",user.salt).hset(uKey,"banTime",0).hset(uKey,"banDuration","").hset(uKey,"lastLoginTime",curTime).hset(uKey,"membership",0).hset(uKey,"players","").hset(uKey,"gems",user.gems).hset(uKey,"looks",looksHex).hset(uKey,"ipAddresses",user.connection._connection.remoteAddress).exec((function(err,replies){user.hasLoggedIn=true;users[user.name]=1;self.sendPlayers(user)}))}}))},savePassword:function(username,hash){var uKey="u:"+username;client.hset(uKey,"hash",hash)},loadUser:function(user){var self=this;var uKey="u:"+user.name;var curTime=(new Date).getTime();client.sismember("usr",user.name,(function(err,reply){if(reply!==1){user.connection.sendUTF8(Types.Messages.SC_ERROR+",invalidlogin");return}client.hgetall(uKey,(function(err,data){console.info("replies: "+data);console.info(JSON.stringify(data));if(data===null||!(typeof data==="object"))return;var db_user={hash:data.hash,salt:data.salt,banTime:data.banTime,banDuration:data.banDuration,lastLoginTime:data.lastLoginTime,membership:data.membership,players:data.players,ipAddresses:data.ipAddresses,gems:data.gems};if(!data.gems)db_user.gems=1e3;else db_user.gems=parseInt(data.gems);if(!data.looks||parseInt(data.looks,16)===0||data.looks.toLowerCase().includes("nan")){var len=AppearanceData.Data.length;db_user.looks=new Uint8Array(len);for(var i=0;i<len;++i)db_user.looks[i]=0}else{db_user.looks=Utils.HexToBin(data.looks)}db_user.looks[0]=1;db_user.looks[50]=1;db_user.looks[77]=1;db_user.looks[151]=1;console.info(JSON.stringify(db_user));user.looks=db_user.looks.slice();user.gems=db_user.gems;if(user.checkUser(db_user)){var ipAddress=user.connection._connection.remoteAddress;if(!data.ipAddesses)client.hset(uKey,"ipAddresses",ipAddress);else{if(!toString(data.ipAddesses).includes(ipAddress))client.hset(uKey,"ipAddresses",db_user.ipAddresses+","+ipAddress)}client.hset(uKey,"lastLoginTime",(new Date).getTime());self.sendPlayers(user)}}));return false}))},sendPlayers:function(user){var uKey="u:"+user.name;client.hget(uKey,"players",(function(err,reply){console.info("players_reply:"+reply);if(reply==null||reply===""){user.sendPlayers();return}var playerNames=reply.split(",");var db_players=[];var count=0;for(var i=0;i<playerNames.length;++i){var pKey="p:"+playerNames[i];hgetarray(pKey,["name","map","exps","colors","sprites"],(function(err,reply){var db_player={name:reply[0],map:reply[1].split(",")[0],exp:reply[2].split(",")[0],colors:reply[3].split(","),sprites:reply[4].split(",")};db_players.push(db_player);if(++count==playerNames.length)user.sendPlayers(db_players)}))}}))},loadPlayer:function(player){var self=this;var pKey="p:"+player.name;var curTime=(new Date).getTime();console.info("player.name: "+player.name);client.multi().hget(pKey,"map").hget(pKey,"exps").hget(pKey,"colors").hget(pKey,"pStats").hget(pKey,"gold").hget(pKey,"sprites").hget(pKey,"stats").hget(pKey,"skills").hget(pKey,"skillSlots").exec((function(err,replies){console.info(replies.toString());var db_player={name:player.name,map:replies[0].split(","),exps:replies[1].split(","),colors:replies[2].split(","),pStats:replies[3].split(","),gold:replies[4].split(","),sprites:replies[5].split(","),stats:replies[6].split(","),skills:replies[7].split(","),skillSlots:replies[8].split(",")};if(db_player.skills.length==1){for(var i=0;i<SkillData.Skills.length;++i)db_player.skills[i]=0}if(db_player.sprites.length==2){db_player.sprites[2]=151;db_player.sprites[3]=50}player.hasLoggedIn=true;player.packetHandler.loadedPlayer=true;players.push(player);player.sendPlayer(db_player)}));return true},createPlayer:function(user,player){var uKey="u:"+user.name;var pKey="p:"+player.name;var curTime=(new Date).getTime();client.hget(pKey,"name",(function(err,reply){if(reply){user.connection.sendUTF8(Types.Messages.SC_ERROR+",playerexists");user.connection.close("Playername not available: "+player.name);return}var db_player={name:player.name,map:[0,0,0,0],exps:[0,0,0,0,0,0,0,0,0,0],colors:[0,0],pStats:[0,0],gold:[0,0],sprites:[77,0,151,50],stats:[2,2,2,2,2,0],skills:[],skillSlots:[-1,-1,-1,-1,-1,-1]};for(var i=0;i<SkillData.Skills.length;++i)db_player.skills[i]=0;client.multi().hset(pKey,"name",db_player.name).hset(pKey,"map",db_player.map.join(",")).hset(pKey,"exps",db_player.exps.join(",")).hset(pKey,"colors",db_player.colors.join(",")).hset(pKey,"pStats",db_player.pStats.join(",")).hset(pKey,"gold",db_player.gold.join(",")).hset(pKey,"sprites",db_player.sprites.join(",")).hset(pKey,"stats",db_player.stats.join(",")).hset(pKey,"skills",db_player.skills.join(",")).hset(pKey,"skillSlots",db_player.skillSlots.join(",")).exec((function(err,replies){console.info(err);console.info(JSON.stringify(replies));console.info("New User: "+player.name);user.loadedPlayer=true;client.hget(uKey,"players",(function(err,reply){var db_players=[];if(reply)db_players=reply.split(",");db_players.push(player.name);client.hset(uKey,"players",db_players.join(","));players.push(player);player.sendPlayer(db_player)}))}))}))},modifyGold:function(playerName,golddiff,type){var type=type||0;var golddiff=parseInt(golddiff);var pKey="p:"+playerName;client.hget(pKey,"gold",(function(err,data){console.info("modifyGold.gold: "+JSON.stringify(data));if(!data){console.error("redis.modifyGold - no gold record for player '"+playerName+"' found.");return}var gold=data.split(",");gold[type]=parseInt(gold[type])+golddiff;client.hset(pKey,"gold",gold.join(","))}))},modifyGems:function(userName,diff){var uKey="u:"+userName;var diff=parseInt(diff);client.hget(uKey,"gems",(function(err,data){var gems=parseInt(data);gems+=diff;client.hset(uKey,"gems",gems)}))},getStoreType:function(type){var sType;switch(type){case 0:sType="iItem_";break;case 1:sType="bItem_";break;case 2:sType="eItem_";break}return sType},getStoreTypeNew:function(type){var sType;switch(type){case 0:sType="inventory";break;case 1:sType="bank";break;case 2:sType="equipment";break}return sType},getItems:function(player,type,callback){var self=this;var pKey="p:"+player.name;var maxNumber=48;if(type==2)maxNumber=5;var sType=this.getStoreTypeNew(type);client.hget(pKey,sType,(function(err,data){if(err||!data){self.getItemsOld(player,type,callback);return}if(data==""){self.getItemsOld(player,type,callback);return}var items=[];console.info(pKey);console.info("getItems - data="+data);dataJSON=JSON.parse(data);for(var i=0;i<dataJSON.length;i++){var itemData=dataJSON[i];if(itemData){var item=new ItemRoom(parseInt(itemData[1]),parseInt(itemData[2]),parseInt(itemData[3]),parseInt(itemData[4]),parseInt(itemData[5]));item.slot=parseInt(itemData[0]);items.push(item)}}callback(items,type)}))},getItemsOld:function(player,type,callback){var pKey="p:"+player.name;var maxNumber=48;if(type==2)maxNumber=5;var sType=this.getStoreType(type);var multi=client.multi();var keys=[];var items=[];client.hgetall(pKey,(function(err,data){if(data===null){callback([],type);return}for(var id in data){var val=data[id];if(id.startsWith(sType)){var slot=id.substr(6);var rec=val.split(",");var item=new ItemRoom(parseInt(rec[0]),parseInt(rec[1]),parseInt(rec[2]),parseInt(rec[3]),parseInt(rec[4]));item.slot=slot;items.push(item)}}callback(items,type)}))},saveItems:function(player,type,items){var pKey="p:"+player.name;var maxNumber=48;if(type==2)maxNumber=5;var sType=this.getStoreType(type);var sTypeNew=this.getStoreTypeNew(type);var multi=client.multi();for(var i=0;i<maxNumber;i++){multi.hdel(pKey,sType+i)}multi.exec((function(err,replies){if(err)console.error(err)}));var store=player.inventory;if(type==1)store=player.bank;if(type==2)store=player.equipment;if(!store)return;client.hset(pKey,sTypeNew,store.toStringJSON())},savePlayer:function(player){var pKey="p:"+player.name;var uKey="u:"+player.user.name;var stats=[player.stats.attack,player.stats.defense,player.stats.health,player.stats.energy,player.stats.luck,player.stats.free];var exps=[Utils.NaN2Zero(player.exp.base),Utils.NaN2Zero(player.exp.attack),Utils.NaN2Zero(player.exp.defense),Utils.NaN2Zero(player.exp.move),Utils.NaN2Zero(player.exp.sword),Utils.NaN2Zero(player.exp.bow),Utils.NaN2Zero(player.exp.hammer),Utils.NaN2Zero(player.exp.axe),Utils.NaN2Zero(player.exp.logging),Utils.NaN2Zero(player.exp.mining)];var map=[player.map.index,player.x,player.y,player.orientation];var skillexps=[];for(var i=0;i<player.skills.length;++i)skillexps[i]=player.skills[i].skillXP;var hexLooks=Utils.BinToHex(player.user.looks);client.multi().hset(pKey,"map",map.join(",")).hset(pKey,"stats",stats.join(",")).hset(pKey,"exps",exps.join(",")).hset(pKey,"gold",player.gold.join(",")).hset(pKey,"skills",skillexps.join(",")).hset(pKey,"skillSlots",player.skillSlots.join(",")).hset(pKey,"pStats",player.pStats.join(",")).hset(pKey,"sprites",player.sprites.join(",")).hset(pKey,"colors",player.colors.join(",")).hset(uKey,"looks",hexLooks).hset(uKey,"gems",player.user.gems).exec((function(err,replies){}))},saveQuests:function(player,quests){var pKey="p:"+player.name;var quest=null;var questKey=[];var questString="[";var hasQuests=false;for(var i=0;i<quests.length;++i){quest=quests[i];if(!quest||quest.status==QuestStatus.COMPLETE||_.isEmpty(quest))continue;questKey.push(quest.id);questString+="["+quest.toString()+"],";hasQuests=true}questString=questString.slice(0,-1);questString+="]";if(!hasQuests)questString="[]";client.hset(pKey,"newquests",questString);this.deleteOldQuests(player)},deleteOldQuests:function(player){console.info("deleteOldQuests");var pKey="p:"+player.name;var indexes;client.hgetall(pKey,(function(err,data){if(data===null){return}console.info("client.hgetall="+JSON.stringify(data));for(var id in data){var val=data[id];if(id.startsWith("q_"))client.hdel(pKey,id)}client.hdel(pKey,"quests");client.hdel(pKey,"quests2")}))},loadQuests:function(player,callback){var self=this;console.info("loadQuest");var pKey="p:"+player.name;var multi=client.multi();var indexes;client.hget(pKey,"newquests",(function(err,data){if(err||!data){self.loadQuestsOld(player,callback);return}if(data==""){self.loadQuestsOld(player,callback);return}var quests=[];console.info(pKey);dataJSON=JSON.parse(data);for(var i=0;i<dataJSON.length;i++){var questData=dataJSON[i];if(questData){console.info(JSON.stringify(questData));var quest=new Quest(questData.splice(0,7));if(questData.length>0)quest.object=getQuestObject(questData.splice(0,6));if(questData.length>0)quest.object2=getQuestObject(questData.splice(0,6));player.quests.push(quest)}}callback(player)}))},loadQuestsOld:function(player,callback){console.info("loadQuest");var pKey="p:"+player.name;var multi=client.multi();var indexes;client.hget(pKey,"quests2",(function(err,data){if(err||!data){callback(player);return}console.info(JSON.stringify(data));indexes=data.split(",");console.info(JSON.stringify(indexes));var indexLen=indexes.length;for(var i=0;i<indexLen;++i){if(!indexes[i])continue;multi.hget(pKey,"q_"+indexes[i])}multi.exec((function(e,val2){if(err||!val2){callback(player);return}for(var j=0;j<val2.length;++j){var rec=val2[j].split(",");console.info(JSON.stringify(val2[j]));var quest=new Quest(rec.splice(0,7));if(rec.length>0)quest.object=getQuestObject(rec.splice(0,6));if(rec.length>0)quest.object2=getQuestObject(rec.splice(0,6));player.quests.push(quest)}callback(player)}))}))},saveAchievements:function(player){console.info("saveAchievement");var pKey="p:"+player.name;var data="";for(var achievement of player.achievements){data+=achievement.toArray(achievement).join(",")+","}client.hset(pKey,"achievements",data)},loadAchievements:function(player,callback){console.info("loadAchievement");var pKey="p:"+player.name;client.hget(pKey,"achievements",(function(err,data){var achievements=getInitAchievements();if(err||!data){player.achievements=achievements;callback(player);return}var rec=data.split(",");var len=~~(rec.length/7);for(var i=0;i<len;++i){var achievement=getAchievementObject(rec.splice(0,7));player.achievements.push(achievement)}for(var i=len;i<achievements.length;++i){player.achievements.push(achievements[i])}callback(player)}))},loadAuctions:function(self,callback){client.hgetall("s:auction",(function(err,data){var auctions={};if(data===null||!(typeof data==="object")){console.warn("loadAuctions - err: "+JSON.stringify(err));console.warn("loadAuctions - data: "+JSON.stringify(data));callback(self,{});return}for(var i=0;i<Object.keys(data).length;++i){var rec=data[i];var sData=rec.split(",");var record=new AuctionRecord(sData[0],parseInt(sData[1]),new ItemRoom(parseInt(sData[2]),parseInt(sData[3]),parseInt(sData[4]),parseInt(sData[5]),parseInt(sData[6])));auctions[i]=record}callback(self,auctions);return}))},saveAuctions:function(auctions){client.del("s:auction");var j=0;var multi=client.multi();for(var i=0;i<Object.keys(auctions).length;++i){if(auctions[i])multi.hset("s:auction",j++,auctions[i].save(i))}multi.exec((function(err,replies){if(err)console.error("saveAuctions: "+JSON.stringify(err));AUCTION_SAVED=true}))},loadLooks:function(looks){client.hget("l:looks","prices",(function(err,data){if(data)looks=data.split(",")}))},saveLooks:function(looks){client.hset("l:looks","prices",looks.join(","))}})},{"./../shared/js/itemtypes":168,"./appearancedata":79,"./inventory":98,"./items":102,"./lib/class":105,"./message":112,"./player":128,"./quest":131,"./skilldata":135,"./utils":146,bcrypt:undefined,crypto:undefined,fs:undefined,redis:undefined}],134:[function(require,module,exports){var cls=require("./lib/class");module.exports=RequestHandler=cls.Class.extend({init:function(player,targetPlayer){this.player=player;this.targetPlayer=targetPlayer}})},{"./lib/class":105}],135:[function(require,module,exports){var _=require("underscore");var SkillsJSON=require("../shared/data/skills2.json");var EffectHandler=require("./effecthandler");var Skills=[];var getSkillEffects=function(data){var effects=[];for(rec in data){effects.push(new EffectType(rec[0]==1,rec[1],rec[2],rec[3]))}};var i=0;for(var index in SkillsJSON){var value=SkillsJSON[index];console.info(index+"="+JSON.stringify(value));Skills.push({skillType:value.skillType,targetType:value.targetType?value.targetType:0,duration:value.duration?value.duration:0,durationPL:value.durationPL?value.durationPL:0,recharge:value.recharge?value.recharge*1e3:0,aoe:value.aoe?value.aoe:0,countTotal:value.countTotal?value.countTotal:0,effectTypes:getSkillEffects(value.effects)})}console.info("skills: "+JSON.stringify(Skills));module.exports.Skills=Skills},{"../shared/data/skills2.json":165,"./effecthandler":90,underscore:75}],136:[function(require,module,exports){var cls=require("./lib/class");var SkillData=require("./skilldata.js");var Messages=require("./message.js");module.exports=SkillHandler=cls.Class.extend({init:function(player){player.skills=[];this.player=player;this.skills=this.player.skills},clear:function(){},setSkills:function(player,skills){for(var i=0;i<skills.length;++i){var skill=new Skill(player,i,skills[i]);player.skills[i]=skill}},setSkill:function(index,exp){var skill=player.skills[index];skill.skillXP=exp;skill.skillLevel=Types.getSkillLevel(exp)},setXPs:function(){var skillXPs=[];for(var i=0;i<this.skills.length;++i){var skill=this.skills[i];var xp=parseInt(skill.tempXP);if(xp>0){skill.xp(xp);skillXPs.push(i,skill.skillXP);skill.tempXP=0}}if(skillXPs.length>0)this.player.map.entities.pushToPlayer(this.player,new Messages.SkillXP(skillXPs))}});Skill=cls.Class.extend({init:function(player,skillIndex,skillXP){this.player=player;console.info("skillIndex:"+skillIndex);this.skillData=SkillData.Skills[skillIndex];this.skillIndex=skillIndex;this.skillLevel=Types.getSkillLevel(skillXP);this.skillXP=skillXP;this.tempXP=0;if(this.skillData.recharge>0){this.skillCooldown=new Timer(this.skillData.recharge);this.skillCooldown.lastTime=0}},getSkill:function(){return this.skillData},isReady:function(){return this.skillCooldown.isOver()},xp:function(amount){if(amount==0)return;console.info("amount="+amount);this.skillXP+=amount;var skillLevel=Types.getSkillLevel(this.skillXP,this.skillLevel);if(skillLevel!=this.skillLevel){this.skillLevel=skillLevel;this.player.map.entities.pushToPlayer(this.player,new Messages.SkillLoad(this.skillIndex,this.skillXP))}}})},{"./lib/class":105,"./message.js":112,"./skilldata.js":135}],137:[function(require,module,exports){var cls=require("./lib/class"),EntityMoving=require("./entitymoving"),Messages=require("./message"),Types=require("../shared/js/gametypes"),AchievementJson=require("../shared/data/achievements.json");module.exports.getAchievementObject=getAchievementObject=function(arr){var self={};self.toArray=function(obj){return[obj.index,obj.type,obj.rank,obj.objectType,obj.objectKind,obj.count,obj.objectCount]};self.toClient=function(obj){return obj.toArray(obj)};self.index=parseInt(arr[0]);self.type=parseInt(arr[1]);self.rank=parseInt(arr[2])||0;self.objectType=parseInt(arr[3])||0;self.objectKind=parseInt(arr[4])||0;self.count=parseInt(arr[5])||0;self.objectCount=parseInt(arr[6])||0;return self};var i=0;for(var r1 of AchievementJson){var rank=1;for(var r2 of r1){r2.rank=rank++;var data=[i,r2.type,r2.rank,r2.objectType,r2.objectKind,0,r2.count];r2.object=getAchievementObject(data)}i++}module.exports.getInitAchievements=getInitAchievements=function(){var achievements=[];var len=AchievementJson.length;for(var i=0;i<len;++i){var achievement=AchievementJson[i][0].object;achievement.index=i;achievements.push(achievement)}return achievements};module.exports.PlayerEvent=PlayerEvent=function(eventType,object,count){var playerEvent={};playerEvent.eventType=eventType;playerEvent.object=object;playerEvent.count=count;return playerEvent};module.exports=TaskHandler=cls.Class.extend({init:function(){var i=0;this.data=AchievementJson},processEvent:function(player,playerEvent){switch(playerEvent.eventType){case EventType.KILLMOB:for(var q in player.quests){var quest=player.quests[q];player.questAboutKill(playerEvent.object,quest)}break;case EventType.LOOTITEM:for(var q in player.quests){var quest=player.quests[q];if(quest.type==QuestType.GETITEMKIND&&quest.object2.kind==playerEvent.object.kind-1e3){player.questAboutItem(quest)}}break}for(var achievement of player.achievements){this.processAchievement(player,playerEvent,achievement,(function(achievement,event){return achievement.type==EventType.KILLMOB&&(achievement.objectKind==0||achievement.objectKind==event.object.kind)}),15);this.processAchievement(player,playerEvent,achievement,(function(achievement,event){return achievement.type==EventType.LOOTITEM&&event.object.hasOwnProperty("enemyDrop")}),25);this.processAchievement(player,playerEvent,achievement,(function(achievement,event){return achievement.type==EventType.DAMAGE}),.25)}},processAchievement:function(player,event,achievement,condition,expMultiplier){if(event.eventType!=achievement.type)return;if(!condition(achievement,event))return;var ti=player.achievements.indexOf(achievement);if(ti<0||ti>=this.data.length)return;var count=event.count;if(achievement.count+count<achievement.objectCount){achievement.count+=count}else{var rankCount=this.data[ti].length;if(achievement.rank==rankCount&&achievement.count==achievement.objectCount)return;while(count>0){var prevCount=achievement.count;var diff=achievement.count+count;achievement.count=Math.min(diff,achievement.objectCount);count-=achievement.objectCount-prevCount;player.map.entities.pushToPlayer(player,new Messages.Achievement(achievement));var xp=~~(achievement.objectCount*expMultiplier);var chatAchievement="ACHIEVEMENTS_"+ti+"_COMPLETE";var objectCount=achievement.objectCount;if(objectCount>=1e6)objectCount=Number(objectCount/1e6).toFixed(1).replace(/[.,]0$/,"")+"M";else if(objectCount>=1e3)objectCount=Number(objectCount/1e3).toFixed(1).replace(/[.,]0$/,"")+"K";player.map.entities.pushToPlayer(player,new Messages.Notify("CHAT",chatAchievement,[objectCount,xp]));if(achievement.rank==rankCount&&achievement.count==achievement.objectCount)return;player.achievements[ti]=achievement=this.data[ti][achievement.rank].object;if(count<achievement.objectCount){achievement.count=count;count=0}}}player.map.entities.pushToPlayer(player,new Messages.Achievement(achievement))}})},{"../shared/data/achievements.json":149,"../shared/js/gametypes":167,"./entitymoving":92,"./lib/class":105,"./message":112}],138:[function(require,module,exports){var cls=require("./lib/class");module.exports=Timer=cls.Class.extend({init:function(duration,startTime){this.lastTime=startTime;if(isNaN(startTime)||startTime===null||startTime===0){this.lastTime=Date.now()}this.duration=duration},isOver:function(time){var over=false;if(isNaN(time)||time===null||time===0){time=Date.now()}if(time-this.lastTime>this.duration){over=true;this.lastTime=time}return over}})},{"./lib/class":105}],139:[function(require,module,exports){var cls=require("./lib/class"),Types=require("../shared/js/gametypes"),RequestHandler=require("./requesthandler"),Messages=require("./message");module.exports=Trade=cls.Class.extend({init:function(player,otherPlayer,rooms){this.player=player;this.otherPlayer=otherPlayer;this.requestAssistant=new RequestHandler(player,otherPlayer);this.items={};this.currentState=null;this.rooms=rooms;this.roomId=0},sendRequest:function(player,otherPlayer){if(this.otherPlayerSentRequest&&this.currentPlayerSentRequest||this.currentPlayerSentRequest&&this.otherPlayerSentRequest){this.startTradingProcess(player,otherPlayer);return}if(player&&otherPlayer){player.map.entities.pushToPlayer(player,new Messages.Notify("TRADE","TRADE_REQUESTED",[otherPlayer.name]));otherPlayer.map.entities.pushToPlayer(otherPlayer,new Messages.Notify("TRADE","TRADE_REQUEST",[player.name]));this.currentPlayerSentRequest=true;return}console.info("An error has occured.")},startTradingProcess:function(player,otherPlayer){if(player.admin){player.map.entities.pushToPlayer(player);return}this.currentState=Types.Messages.INVENTORYSTATE.STARTED;otherPlayer.server.pushToPlayer(otherPlayer,Types.Messages.TRADESCREEN);player.map.entities.pushToPlayer(player,Types.Messages.TRADESCREEN)},addItemToTradeSession:function(itemKind,itemCount,player,otherPlayer,inventoryNumber,playerCountChosen,otherPlayerChosenCount){for(var iRooms=0;iRooms<player.inventory.rooms;iRooms++){for(var selectedInventory in iRooms){if(ItemTypes.isConsumableItem(selectedInventory.kind)){player.map.entities.pushToPlayer(player,Types.Messages.TRADESTATES.TRADECOUNT);if(itemCount>playerCountChosen){this.items.push(itemKind,itemCount);player.map.entities.pushToPlayer(player,new Messages.TradeStates)}else{this.items.push(itemKind,playerCountChosen)}}else{this.items.push(itemKind,itemCount)}}}},removeItemFromTradeSession:function(itemKind,itemCount,player,otherPlayer,roomId){this.roomId=roomId;for(roomId in this.rooms){roomId.delete(itemKind,itemCount);player.map.entities.pushToPlayer(player,Types.Messages.TRADESTATES.ITEMREMOVED)}}})},{"../shared/js/gametypes":167,"./lib/class":105,"./message":112,"./requesthandler":134}],140:[function(require,module,exports){module.exports=Transition=Class.extend({init:function(){this.startValue=0;this.endValue=0;this.duration=0;this.inProgress=false;this.currentValue=0},start:function(currentTime,updateFunction,incFunction,stopFunction,modValue,duration,object){this.startTime=currentTime;this.updateFunction=updateFunction;this.incFunction=incFunction;this.stopFunction=stopFunction;this.modValue=modValue;this.duration=duration;this.inProgress=true;this.object=object},step:function(currentTime){if(this.inProgress){var elapsed=currentTime-this.startTime;elapsed=this.duration;var diff=this.modValue;var inc=Math.round(diff/this.duration*elapsed);if(diff==0||inc==0)return;var j=0;if(this.updateFunction){var it;var itCount=Math.abs(inc);var start=0;var mod=inc>0?1:-1;for(it=1;it<=itCount;++it){start=this.incFunction(this.object);if(this.updateFunction(start+mod)){this.stop();return}}}}},restart:function(currentTime,startValue,endValue){this.start(currentTime,this.updateFunction,this.stopFunction,this.startValue,this.endValue,this.duration);this.step(currentTime)},stop:function(){if(this.stopFunction)this.stopFunction(j);this.inProgress=false}})},{}],141:[function(require,module,exports){var cls=require("./lib/class"),EntityMoving=require("./entitymoving"),Types=require("../shared/js/gametypes");module.exports=Block=EntityMoving.extend({init:function(id,kind,x,y,map,parent,name,ix,iy){var type=this.type=Types.EntityTypes.TRAP;this.parent=parent;this.ix=ix;this.iy=iy;this._super(id,type,kind,x,y,map);this.name=name;this.active=true},getState:function(){return this._getBaseState().concat([parseInt(this.ix),parseInt(this.iy),parseInt(this.active?1:0)])},on:function(){this.active=true;this.map.entities.pushNeighbours(this,new Messages.SwapSprite(this.id,1))},off:function(){this.active=false;this.map.entities.pushNeighbours(this,new Messages.SwapSprite(this.id,0))}})},{"../shared/js/gametypes":167,"./entitymoving":92,"./lib/class":105}],142:[function(require,module,exports){var cls=require("./lib/class"),Area=require("./area"),Timer=require("./timer"),TrapGroup=require("./trapgroup"),Utils=require("./utils"),Types=require("../shared/js/gametypes");module.exports=TrapArea=Area.extend({init:function(id,x,y,width,height,map,damage,switchInterval){this._super(id,x,y,width,height,map);this.groups=[];this.checkTimer=new Timer(500);this.damage=damage||0;this.switchInterval=switchInterval||1e3},addGroup:function(group){this.groups.push(group)},addRandomGroup:function(kind,width,height,threshold){var pos=null;var threshold=threshold||50;var t=0;while(t++<threshold){pos=[this.gx+Utils.randomInt(this.width/G_TILESIZE-width),this.gy+Utils.randomInt(this.height/G_TILESIZE-height)];if(this.isGroupEmptyPositions(pos,width,height))break;pos=null}if(!pos){console.error("TrapArea - addRandomGroup - failed, threshold reached.");return}var group=new TrapGroup(kind,pos[0],pos[1],width,height,this.map,this.damage,this.switchInterval);this.addGroup(group)},isGroupEmptyPositions:function(pos,width,height){console.info("isGroupEmptyPositions: pos=["+pos[0]+","+pos[1]+"],w="+width+",h="+height);for(var i=0;i<width;++i){for(var j=0;j<height;++j){if(!this.map.entities.isGridPositionEmpty((pos[0]+i)*G_TILESIZE,(pos[1]+j)*G_TILESIZE)){return false}}}return true},isTouching:function(entity){var th=G_TILESIZE>>1;var x1=this.x*G_TILESIZE-th;var x2=(this.x+this.width)*G_TILESIZE+th;var y1=this.y*G_TILESIZE-th;var y2=(this.y+this.width)*G_TILESIZE+th;return _.inRange(entity.x,x1,x2)&&_.inRange(entity.y,y1,y2)},update:function(entity){if(!this.checkTimer.isOver())return;if(!this.isTouching(entity))return;for(var group of this.groups){group.update(entity)}}})},{"../shared/js/gametypes":167,"./area":80,"./lib/class":105,"./timer":138,"./trapgroup":143,"./utils":146}],143:[function(require,module,exports){var cls=require("./lib/class"),Trap=require("./trap"),Timer=require("./timer"),Utils=require("./utils"),Types=require("../shared/js/gametypes");module.exports=TrapGroup=cls.Class.extend({init:function(kind,x,y,width,height,map,damage,interval){this.kind=kind;this.x=x;this.y=y;this.width=width;this.height=height;this.traps=[];this.entities={};this.map=map;this.damaging=false;this.switchTimer=new Timer(interval||1e3);this.damage=this.damage||0;this.damageInterval=1e3;this.generateTraps()},generateTraps:function(){var width=this.width;var height=this.height;var startID=this.map.entities.entityCount;var id=0;var blockName;for(var j=0;j<height;++j){for(var i=0;i<width;++i){id=startID+(width*j+i);blockName="trap"+id+"-"+j+"_"+i;var trap=new Trap(id,this.kind,(this.x+i)*G_TILESIZE,(this.y+j)*G_TILESIZE,this.map,this,blockName,i,j);this.map.entities.addEntity(trap);this.traps.push(trap)}}this.map.entities.entityCount+=width*height},isTouching:function(entity){var th=G_TILESIZE>>1;var x1=this.x*G_TILESIZE-th;var x2=(this.x+this.width)*G_TILESIZE+th;var y1=this.y*G_TILESIZE-th;var y2=(this.y+this.width)*G_TILESIZE+th;return _.inRange(entity.x,x1,x2)&&_.inRange(entity.y,y1,y2)},update:function(entity){var dmg=this.damaging;if(this.switchTimer.isOver())this.damaging=!this.damaging;if(dmg!=this.damaging){if(this.damaging){for(var trap of this.traps){trap.on()}}else{for(var trap of this.traps){trap.off()}}}if(!this.damaging)return;if(!this.isTouching(entity))return;var victim=null;for(var trap of this.traps){if(trip.isTouching(entity)){victim=entity;break}}var id=entity.id;if(!victim){this.entities[id]=null;return}if(this.entities.getOwnProperty(id)&&this.entities[id]){if(this.entities[id].isOver())player.onDamage(this,this.damage)}else{player.onDamage(this,this.damage);this.entities[id]=new Timer(this.damageInterval)}}})},{"../shared/js/gametypes":167,"./lib/class":105,"./timer":138,"./trap":141,"./utils":146}],144:[function(require,module,exports){var Messages=require("./message"),_=require("underscore"),Utils=require("./utils");module.exports=Updater=Class.extend({init:function(ws,map){this.ws=ws;this.server=ws;this.map=map;this.time=Date.now();this.whoDist=8*G_TILESIZE},update:function(){var self=this,m=null;this.time=Date.now();for(var entityId in this.map.entities.entities){var entity=this.map.entities.entities[entityId];if(!entity||!(entity instanceof Character))continue;if(entity.isDying||entity.isDead||entity.isStunned){continue}if(entity instanceof Player){this.updatePlayerKeyMovement(entity);this.updatePlayerPathMovement(entity);entity.neighboursUpdated=false}else{this.updateCharacterPathMovement(entity)}m=entity.movement;if(m&&m.inProgress){m.step(this.time)}}},checkCollide:function(c,x,y){if(c instanceof Player){if(c.map.isColliding(x,y))return true;if(c.holdingBlock){pos=c.nextTile();if(c.map.isColliding(pos[0],pos[1]))return true}return false}},moveCharacter:function(char,axis,x,y){if(this.checkCollide(char,axis,x,y)){c.setPosition(c.x,c.y);console.warn("char.isColliding("+char.id+","+x+","+y+")");return false}return true},updateCharacterPathMovement:function(c){var self=this;var tick=c.tick*G_FRAME_INTERVALS;var time=this.time;var speed=c.moveSpeed;if(c.isDying||c.isDead||c.freeze||c.isStunned){return}var xf=function(x){c.setPosition(x,c.y);return c.nextStep()};var yf=function(y){c.setPosition(c.x,y);return c.nextStep()};var canMove=c.movement.inProgress===false&&c.isMovingPath();if(canMove){if(c.orientation==Types.Orientations.LEFT){c.movement.start(time,xf,(function(c){return c.x}),null,-tick,speed,c)}else if(c.orientation==Types.Orientations.RIGHT){c.movement.start(time,xf,(function(c){return c.x}),null,tick,speed,c)}else if(c.orientation==Types.Orientations.UP){c.movement.start(time,yf,(function(c){return c.y}),null,-tick,speed,c)}else if(c.orientation==Types.Orientations.DOWN){c.movement.start(time,yf,(function(c){return c.y}),null,tick,speed,c)}}},updatePlayerPathMovement:function(c){var self=this;var tick=c.tick*G_FRAME_INTERVALS;var time=this.time;var speed=c.moveSpeed;var whoDist=8;if(c.isDying||c.isDead||c.freeze||c.isStunned){return}var xf=function(x){c.setPosition(x,c.y);if(x%self.whoDist==0)c.map.entities.processWho(c);return c.nextStep()};var yf=function(y){c.setPosition(c.x,y);if(y%self.whoDist==0)c.map.entities.processWho(c);return c.nextStep()};var canMove=c.movement.inProgress===false&&c.isMovingPath();if(canMove){if(c.orientation==Types.Orientations.LEFT){c.movement.start(time,xf,(function(c){return c.x}),null,-tick,speed,c)}else if(c.orientation==Types.Orientations.RIGHT){c.movement.start(time,xf,(function(c){return c.x}),null,tick,speed,c)}else if(c.orientation==Types.Orientations.UP){c.movement.start(time,yf,(function(c){return c.y}),null,-tick,speed,c)}else if(c.orientation==Types.Orientations.DOWN){c.movement.start(time,yf,(function(c){return c.y}),null,tick,speed,c)}}},updatePlayerKeyMovement:function(c){var self=this;var time=this.time;var tick=c.tick*G_FRAME_INTERVALS;var speed=c.moveSpeed;var o=c.moveOrientation;var whoDist=8;if(c.freeze||c.isMovingPath()){return}var xf=function(x){if((c.startMoving||x%G_TILESIZE==0)&&self.checkCollide(c,x,c.y)){c.forceStopMove();return true}c.startMoving=false;c.setPosition(x,c.y);if(x%self.whoDist==0)c.map.entities.processWho(c);if(c.checkStopDanger(c,o)){c.forceStopMove();return true}return false};var yf=function(y){if((c.startMoving||y%G_TILESIZE==0)&&self.checkCollide(c,c.x,y)){c.forceStopMove();return true}c.startMoving=false;c.setPosition(c.x,y);if(y%self.whoDist==0)c.map.entities.processWho(c);if(c.checkStopDanger(c,o)){c.forceStopMove();return true}return false};var canMove=c.movement.inProgress===false&&o>0;if(canMove){if(o==Types.Orientations.LEFT){c.movement.start(time,xf,(function(c){return c.x}),null,-tick,speed,c)}else if(o==Types.Orientations.RIGHT){c.movement.start(time,xf,(function(c){return c.x}),null,tick,speed,c)}else if(o==Types.Orientations.UP){c.movement.start(time,yf,(function(c){return c.y}),null,-tick,speed,c)}else if(o==Types.Orientations.DOWN){c.movement.start(time,yf,(function(c){return c.y}),null,tick,speed,c)}}}})},{"./message":112,"./utils":146,underscore:75}],145:[function(require,module,exports){var cls=require("./lib/class"),_=require("underscore"),crypto=require("crypto"),Messages=require("./message"),Utils=require("./utils"),formatCheck=require("./format").check,Types=require("../shared/js/gametypes"),bcrypt=require("bcrypt"),express=require("express"),bodyParser=require("body-parser"),app=express(),AppearanceData=require("./appearancedata"),PacketHandler=require("./packethandler");var CryptoJS=require("crypto-js");function PlayerSummary(index,db_player){this.index=index;this.name=db_player.name;this.exp=db_player.exp;this.colors=db_player.colors;this.sprites=db_player.sprites;return this}PlayerSummary.prototype.toArray=function(){return[this.index,this.name,this.exp,this.colors[0],this.colors[1],this.sprites[0],this.sprites[1]]};PlayerSummary.prototype.toString=function(){return this.toArray().join(",")};module.exports=User=cls.Class.extend({init:function(main,connection){var self=this;this.main=main;this.connection=connection;this.currentPlayer=null;this.players=[];this.loadedUser=false;this.loadedPlayer=false;this.formatChecker=new FormatChecker;this.looks=new Array(AppearanceData.Data.length);this.gems=0;this.listener=function(message){console.info("recv[0]="+message);var action=parseInt(message[0]);if(!formatCheck(message)){self.connection.close("Invalid "+Types.getMessageTypeAsString(action)+" message format: "+message);return}message.shift();if(action===Types.Messages.BI_SYNCTIME){self.handleSyncTime(message);return}if(action===Types.Messages.CS_CREATE_USER){self.handleCreateUser(message);return}else if(action===Types.Messages.CS_LOGIN_USER){self.handleLoginUser(message);return}if(!self.loadedUser){console.info("Cannot Login User: "+message);return}if(action===Types.Messages.CS_CREATE_PLAYER){self.handleCreatePlayer(message);return}else if(action===Types.Messages.CS_LOGIN_PLAYER){self.handleLoginPlayer(message);return}if(!self.loadedPlayer){console.info("Cannot Login: "+message);return}};this.connection.listen(this.listener);this.connection.onClose((function(){console.info("onClose - called");clearTimeout(this.disconnectTimeout);self.onExit();this.close("onClose");self.onClose()}))},onClose:function(save){console.warn("User.onClose - called.");if(this.name){console.warn("name:"+this.name);users[this.name]=0}save=save||false;var p=this.currentPlayer;if(save&&p){if(this.loadedPlayer)p.save();players.splice(players.indexOf(p),1);delete this.currentPlayer}delete users[this.name];console.warn(JSON.stringify(users));delete this},onExit:function(){},send:function(message){this.connection.send(message)},handleSyncTime:function(message){var clientTime=parseInt(message[0]);var world=worlds[0];this.connection.sendUTF8([Types.Messages.BI_SYNCTIME,clientTime,Date.now()].join(","))},handleCreateUser:function(message){var self=this;var name=Utils.sanitize(message[0]);var hash=Utils.sanitize(message[1]);hash=Utils.btoa(hash);console.info("Starting Client/Server Handshake");self.name=name.substr(0,16).trim().toLowerCase();console.info("self.user.name="+self.name);var bytes=CryptoJS.AES.decrypt(hash,this.hashChallenge);var decrypt=JSON.parse(bytes.toString(CryptoJS.enc.Utf8));var current_date=(new Date).valueOf().toString();var random=Math.random().toString();var salt=crypto.createHash("sha1").update(current_date+random).digest("hex");hash=crypto.createHash("sha1").update(decrypt+salt).digest("hex");try{if(!Utils.checkInputName(self.name)){self.connection.sendUTF8(Types.Messages.SC_ERROR+"invalidusername");return}self.hash=hash;self.salt=salt;DBH.createUser(self)}catch(e){console.info("message="+e.message);console.info("stack="+e.stack)}},handleLoginUser:function(message){var self=this;var name=Utils.sanitize(message[0]);var hash=Utils.sanitize(message[1]);hash=Utils.btoa(hash);console.info("Starting Client/Server Handshake");self.name=name.substr(0,16).trim().toLowerCase();console.info("self.name="+self.name);try{if(!Utils.checkInputName(self.name)){self.connection.sendUTF8(Types.Messages.SC_ERROR+",invalidname");return}self.hash=hash;DBH.loadUser(self)}catch(e){console.info("message="+e.message);console.info("stack="+e.stack)}},checkUser:function(db_user){var curTime=Date.now();var banTime=db_user.banTime+db_user.banDuration;if(banTime>curTime){this.connection.sendUTF8(Types.Messages.SC_ERROR+",ban");this.connection.close("Closing connection to: "+player.name);return false}if(db_user.membershipTime>curTime){user.membership=true}var bytes=CryptoJS.AES.decrypt(this.hash,this.hashChallenge);var decrypt=JSON.parse(bytes.toString(CryptoJS.enc.Utf8));var hash=crypto.createHash("sha1").update(decrypt+db_user.salt).digest("hex");console.info("checkUser: "+hash+" != "+db_user.hash);if(hash!=db_user.hash){this.connection.sendUTF8(Types.Messages.SC_ERROR+",invalidlogin");if(++this.passwordTries>3)this.connection.close("Wrong Password: "+this.name);return false}console.warn(JSON.stringify(users));console.info("LOGIN: "+this.name);if(users.hasOwnProperty(this.name)&&users[this.name]==1){this.connection.sendUTF8(Types.Messages.SC_ERROR+",loggedin");return false}users[this.name]=1;this.hasLoggedIn=true;var d=new Date;var lastLoginTimeDate=new Date(db_user.lastLoginTime);return true},sendPlayers:function(db_players){this.loadedUser=true;if(!Array.isArray(db_players)){this.connection.sendUTF8(Types.Messages.SC_PLAYER_SUM+",0");return}var sendMsg=[Types.Messages.SC_PLAYER_SUM,db_players.length];for(var i=0;i<db_players.length;++i){var dbp=db_players[i];var playerSum=new PlayerSummary(i,dbp);this.players.push(playerSum);sendMsg=sendMsg.concat(playerSum.toArray())}this.connection.sendUTF8(sendMsg.join(","))},handleCreatePlayer:function(message){var worldIndex=parseInt(message[0]);var name=Utils.sanitize(message[1]);var self=this;var tmpPlayer={name:name};console.info("Starting Client/Server Handshake");tmpPlayer.name=tmpPlayer.name.substr(0,16).trim();if(!Utils.checkInputName(tmpPlayer.name)){user.connection.sendUTF8(Types.Messages.SC_ERROR+",invalidname");return}var db_player={name:tmpPlayer.name,map:0,exp:0,colors:[0,0],sprites:[0,0]};var playerSummary=new PlayerSummary(this.players.length,db_player);this.players.push(playerSummary);console.info("self.player.name="+db_player.name);try{if(this.loginPlayer(worldIndex,playerSummary)){var p=this.currentPlayer;p.name=db_player.name;DBH.createPlayer(this,p)}}catch(e){console.info("message="+e.message);console.info("stack="+e.stack)}},handleLoginPlayer:function(message){var worldIndex=parseInt(message[0]);var playerIndex=parseInt(message[1]);if(playerIndex<0&&playerIndex>=this.players.length)return false;if(this.loginPlayer(worldIndex,this.players[playerIndex]))DBH.loadPlayer(this.currentPlayer)},loginPlayer:function(worldIndex,playerSummary){if(worldIndex<0&&worldIndex>=worlds.length)return false;console.info("worldIndex: "+worldIndex);var world=worlds[worldIndex];var player=new Player(this,this.main,this.connection,world);player.name=playerSummary.name;world.connect_callback(player);this.currentPlayer=player;this.loadedPlayer=true;return true},modifyGems:function(diff){diff=parseInt(diff);if(this.gems-diff<0){this.connection.send(new Messages.Notify("SHOP","SHOP_NOGEMS").serialize());return false}this.gems+=diff;this.connection.send(new Messages.Gold(this.currentPlayer).serialize());return true}})},{"../shared/js/gametypes":167,"./appearancedata":79,"./format":95,"./lib/class":105,"./message":112,"./packethandler":125,"./utils":146,bcrypt:undefined,"body-parser":undefined,crypto:undefined,"crypto-js":undefined,express:undefined,underscore:75}],146:[function(require,module,exports){var Utils={},sanitizer=require("sanitizer"),Types=require("../shared/js/gametypes"),ItemTypes=require("../shared/js/itemtypes");Utils.sanitize=function(string){return sanitizer.escape(sanitizer.sanitize(string))};Utils.random=function(range){return Math.floor(Math.random()*range)};Utils.randomRange=function(min,max){return min+Math.random()*(max-min)};Utils.randomInt=function(val){return Math.floor(Math.random()*(val+1))};Utils.randomRangeInt=function(min,max){return min+Math.floor(Math.random()*(max-min+1))};Utils.percentToBool=function(percent){if(Math.random()<percent*.01){return true}else{return false}};Utils.ratioToBool=function(ratio){if(Math.random()<ratio){return true}else{return false}};Utils.clamp=function(min,max,value){if(value<min){return min}else if(value>max){return max}else{return value}};Utils.randomOrientation=function(){var o,r=Utils.random(4);if(r===0)o=Types.Orientations.LEFT;if(r===1)o=Types.Orientations.RIGHT;if(r===2)o=Types.Orientations.UP;if(r===3)o=Types.Orientations.DOWN;return o};Utils.getOrientationString=function(r){var o="NONE";if(r===1)o="UP";else if(r===2)o="DOWN";else if(r===3)o="LEFT";else if(r===4)o="RIGHT";return o};Utils.getOrientationFromLastMove=function(entity){if(!entity.path||entity.path.length==0)return Utils.randomOrientation();var x2=entity.path[entity.path.length-1][0];var y2=entity.path[entity.path.length-1][1];if(entity.path.length==1){var x=entity.x;var y=entity.y}else{var x=entity.path[entity.path.length-2][0];var y=entity.path[entity.path.length-2][1]}if(x2>x)return Types.Orientations.RIGHT;else if(x2<x)return Types.Orientations.LEFT;else if(y2>y)return Types.Orientations.DOWN;else if(y2<y)return Types.Orientations.UP};Utils.randomPositionNextTo=function(entity){var a=entity.x,b=entity.y,r=Utils.random(4);if(r===0)--a;if(r===1)++a;if(r===2)--b;if(r===3)++b;return{x:a,y:b}};Utils.Mixin=function(target,source){if(source){for(var key,keys=Object.keys(source),l=keys.length;l--;){key=keys[l];if(source.hasOwnProperty(key)){target[key]=source[key]}}}return target};Utils.distanceTo=function(x,y,x2,y2){var distX=Math.abs(x-x2);var distY=Math.abs(y-y2);return distX>distY?distX:distY};Utils.manhattenDistance=function(pos1,pos2){return Math.abs(pos1.x-pos2.x)+Math.abs(pos1.y-pos2.y)},Utils.realDistance=function(p1,p2){return~~Math.pow(Math.pow(p2[0]-p1[0],2)+Math.pow(p2[1]-p1[1],2),.5)},Utils.NaN2Zero=function(num){if(isNaN(num*1)){return 0}else{return num*1}};Utils.trueFalse=function(bool){return bool==="true"?true:false};Utils.utilSleep=function(ms){return new Promise((resolve=>setTimeout(resolve,ms)))};Utils.removeDoubleQuotes=function(val){return val.toString().replace(/^"(.+(?="$))"$/,"$1")};Utils.max=function(array,colIndex){Math.max.apply(Math,array.map((function(v){return v[colIndex]})))};Utils.min=function(array,colIndex){Math.min.apply(Math,array.map((function(v){return v[colIndex]})))};Utils.array_values=function(input){var tmp_arr=[],key="";for(key in input)tmp_arr[tmp_arr.length]=input[key];return tmp_arr};Utils.arraysEqual=function(a,b){if(a===b)return true;if(a==null||b==null)return false;if(a.length!=b.length)return false;for(var i=0;i<a.length;++i){if(a[i]!==b[i])return false}return true};Utils.setEquipmentBonus=function(kind){if(ItemTypes.isWeapon(kind)||ItemTypes.isArcherWeapon(kind)||ItemTypes.isArmor(kind)){var probability=Utils.random(1024);var bonus=0;for(var i=1;i<=1024;i*=2){if(probability<i){return Math.max(10-bonus,1)}++bonus}}return 1};Utils.pad=function(val,size){var s=val+"";while(s.length<size)s="0"+s;return s};Utils.checkInputName=function(name){if(name===null)return false;else if(name==="")return false;else if(name===" ")return false;for(var i=0;i<name.length;i++){var c=name.charCodeAt(i);if(!(44032<=c&&c<=55203||12593<=c&&c<=12686||97<=c&&c<=122||65<=c&&c<=90||48<=c&&c<=57)){return false}}return true};if(!Array.prototype.last){Object.defineProperty(Array.prototype,"last",{value:function(){return this[this.length-1]}})}if(!Array.prototype.parseInt){Object.defineProperty(Array.prototype,"parseInt",{value:function(){return this.map((function(x){return parseInt(x,10)}))}})}ArrayParseInt=function(){return this.map((function(x){return parseInt(x,10)}))};if(!String.prototype.reverse){String.prototype.reverse=function(){return this.split("").reverse().join("")}}Utils.BinToHex=function(uint8array){var len=Math.ceil(uint8array.length/4);var hex="";for(var i=0;i<len;i++){j=i*4;var num=uint8array.slice(j,j+4).join("");hex+=parseInt(num,2).toString(16).toUpperCase()}return hex};Utils.HexToBin=function(hex){var len=Math.ceil(hex.length);var tmp;var sum="";for(var i=0;i<len;i++){tmp=hex.substr(i,1);sum+=parseInt(tmp,16).toString(2).padStart(4,"0")}var uint8arr=new Uint8Array(sum.split(""));return uint8arr};Utils.ceilGrid=function(val){return~~(val+.5)};if(!Number.prototype.ceilGrid){Number.prototype.ceilGrid=function(){return~~(this+.5)}}Utils.minProp=function(arr,prop){return arr.reduce((function(prev,curr){return prev[prop]<curr[prop]?prev:curr}))};Utils.maxProp=function(arr,prop){return arr.reduce((function(prev,curr){return prev[prop]>curr[prop]?prev:curr}))};Utils.Sleep=function(ms){return new Promise((resolve=>setTimeout(resolve,ms)))};var groupBy=function(xs,key){return xs.reduce((function(rv,x){(rv[x[key]]=rv[x[key]]||[]).push(x);return rv}),{})};Utils.GetGroupCountArray=function(groupArray,field){var group=groupBy(groupArray,field);var array=[];for(var rec in group){array.push([rec,group[rec].length])}console.info(JSON.stringify(array));array.sort((function(a,b){return a[1]-b[1]}));return array};Utils.roundTo=function(val,nearest){return Math.round(val/nearest)*nearest};Utils.floorTo=function(val,nearest){return Math.floor(val/nearest)*nearest};Utils.ceilTo=function(val,nearest){return Math.ceil(val/nearest)*nearest};Utils.btoa=function(val){return Buffer.from(val,"base64").toString("utf8")};Utils.getGridPosition=function(x,y){return{gx:x>>4,gy:y>>4}};module.exports=Utils},{"../shared/js/gametypes":167,"../shared/js/itemtypes":168,sanitizer:undefined}],147:[function(require,module,exports){var cls=require("./lib/class"),_=require("underscore"),Log=require("log"),Entity=require("./entity"),EntitySpawn=require("./entityspawn"),Character=require("./character"),Mob=require("./mob"),Gather=require("./gather"),Map=require("./map"),MapManager=require("./mapmanager"),MapEntities=require("./mapentities"),NpcStatic=require("./npcstatic"),NpcMove=require("./npcmove"),NpcData=require("./npcdata"),Player=require("./player"),Item=require("./item"),Items=require("./items"),AppearanceData=require("./appearancedata"),MobArea=require("./mobarea"),ChestArea=require("./chestarea"),Chest=require("./chest"),Messages=require("./message"),MobData=require("./mobdata"),Utils=require("./utils"),Types=require("../shared/js/gametypes"),ItemTypes=require("../shared/js/itemtypes"),PlayerController=require("./playercontroller"),NpcMoveController=require("./npcmovecontroller"),SkillData=require("./skilldata"),util=require("util"),Pathfinder=require("./pathfinder"),NotifyData=require("./notificationdata.js"),Products=require("../shared/data/products.json"),Updater=require("./updater"),Auction=require("./auction"),Looks=require("./looks"),Party=require("./party"),TaskHandler=require("./taskhandler");module.exports=World=cls.Class.extend({init:function(id,maxPlayers,socket,database){var self=this;self.id=id;self.maxPlayers=maxPlayers;self.socket=socket;self.database=database;self.mapManager=new MapManager(self);self.taskHandler=new TaskHandler;self.maps=self.mapManager.maps;self.party=[];self.itemCount=0;self.uselessDebugging=false;self.expMultiplier=0;self.mapManager.onMapsReady((function(){console.info("ALL MAPS LOADED BITCHES!");self.maps=self.mapManager.maps;for(mapId in self.maps){var map=self.maps[mapId];map.updater=new Updater(self,map)}}));self.bets=[];self.products=JSON.parse(JSON.stringify(Products));self.auction=new Auction;self.looks=new Looks;self.onPlayerConnect((function(player){player.map=self.maps[1]}));self.onPlayerEnter((function(player){console.info("Player: "+player.name+" has entered the "+player.map.name+" map.");player.map.entities.pushBroadcast(new Messages.Notify("MAP","MAP_ENTERED",[player.name,player.map.name]),true);self.updatePopulation();player.onDeath((function(){player.forEachAttacker((function(c){c.removeAttacker(player);if(c instanceof Mob)c.forgetPlayer(player.id)}))}));var move_callback=function(p){};player.packetHandler.onMove(move_callback.bind(player));player.packetHandler.onBroadcast((function(message,ignoreSelf){player.map.entities.pushBroadcast(message,ignoreSelf?player.id:null)}));player.packetHandler.onExit((function(){console.info("Player: "+player.name+" has exited the world.");player.map.entities.removePlayer(player);if(player.party){var party=player.party;party.removePlayer(player);player.packetHandler.handlePartyAbandoned(party)}if(self.removed_callback)self.removed_callback()}));if(self.added_callback)self.added_callback()}));self.onEntityAttack((function(attacker){if(!attacker.target)return}));self.onRegenTick((function(){for(mapId in self.maps){var map=self.maps[mapId];if(map&&map.isLoaded&&map.entities){map.entities.forEachPlayer((function(character){if(character instanceof Player){if(!character.isDead&&!character.hasFullHealth()&&!character.isAttacked()){var packet=character.modHealthBy(Math.floor(character.stats.hpMax/8))}}}));map.entities.forEachMob((function(character){if(character instanceof Mob){if(!character.isDead&&!character.hasFullHealth()&&!character.isAttacked()&&character.x==character.spawnX&&character.y==character.spawnY){var packet=character.modHealthBy(Math.floor(character.stats.hpMax/8))}}}))}}}));self.notify=NotifyData.Notifications;for(var id in self.notify){self.notify[id].lastTime=Date.now()-this._idleStart}setInterval((function(){for(var id in self.notify){var notify=self.notify[id];if(Date.now()-notify.lastTime>=notify.interval*6e4){self.pushWorld(new Messages.Notify("NOTICE",notify.textid));notify.lastTime=Date.now()}}}),6e4)},stop:function(){this.save()},save:function(){for(mapId in this.maps){var map=this.maps[mapId];if(map&&map.isLoaded&&map.entities){var savedPlayers=0;map.entities.forEachPlayer((function(p){p.save();if(p.isSaved)savedPlayers++}));if(map.entities.players.length==savedPlayers)PLAYERS_SAVED=true}}this.auction.save();this.looks.save()},run:function(){var self=this;setInterval((function(){for(mapId in self.maps){var map=self.maps[mapId];if(map&&map.ready&&map.entities&&map.updater&&Object.keys(map.entities.players).length>0){map.entities.processPackets();map.updater.update()}}}),G_UPDATE_INTERVAL);setInterval((function(){for(mapId in self.maps){var map=self.maps[mapId];if(map&&map.ready&&map.entities&&Object.keys(map.entities.players).length>0){map.entities.mobAI.update()}}}),256);setInterval((function(){for(mapId in self.maps){var map=self.maps[mapId];if(map&&map.ready&&map.entities&&Object.keys(map.entities.npcplayers).length>0){for(npcId in map.entities.npcplayers){var npc=map.entities.npcplayers[npcId];if(npc instanceof NpcStatic){npc.activeController.randomMove();npc.activeController.checkMove(Date.now())}}}}}),64);setInterval((function(){if(self.regen_callback){self.regen_callback()}}),1e4);setInterval((function(){if(self.exp_callback){self.exp_callback()}}),6e4);setInterval((function(){if(self.pvp_regen_callback){self.pvp_regen_callback()}}),3e5);setInterval((function(){for(mapId in self.maps){var map=self.maps[mapId];if(map&&map.ready&&map.mobArea&&Object.keys(map.entities.players).length>0){for(var i=0;i<map.mobArea.length;++i){map.mobArea[i].Roaming()}}}}),1e4);setInterval((function(){for(mapId in self.maps){var map=self.maps[mapId];if(map&&map.ready){for(id in map.players){var player=map.players[id];if(player.idleTimer.isOver());player.packetHandler.exit_callback()}}}}),18e4);setInterval((function(){self.save()}),18e5)},addParty:function(player1,player2){var party=new Party(player1,player2);this.party.push(party);return party},removeParty:function(party){this.party=_.reject(this.party,(function(el){return el===party}));delete party},loggedInPlayer:function(name){var self=this;for(mapId in self.maps){var map=self.maps[mapId];if(map.ready&&map.entities){for(var id in map.entities.players){if(map.entities.players.hasOwnProperty(id)){if(map.entities.players[id].name==name){if(!map.entities.players[id].isDead){console.info("loggedInPlayer: true");return true}}}}}}console.info("loggedInPlayer: false");return false},getPlayerByName:function(name){var self=this;for(mapId in self.maps){var map=self.maps[mapId];if(map.ready&&map.entities){for(var id in map.entities.players){if(map.entities.players.hasOwnProperty(id)){if(map.entities.players[id].name==name){return map.entities.players[id]}}}}}return null},handlePlayerVanish:function(player){var self=this;player.forEachAttacker((function(mob){if(mob instanceof Mob){player.removeAttacker(mob);mob.clearTarget();mob.forgetPlayer(player.id,1e3)}}))},handleMobHate:function(sEntity,tEntity,hatePoints){console.info("handleMobHate");if(sEntity&&tEntity&&tEntity instanceof Player&&sEntity instanceof Mob){sEntity.increaseHateFor(tEntity,hatePoints);if(sEntity.stats.hp>0){var hEntity=sEntity.getMostHated();if(hEntity)this.createAttackLink(sEntity,hEntity)}}},handleEquipmentDegrading:function(target){var weaponSlot=4;var armorDamage=Math.min(5,Math.ceil(target.armorDamage/1e3));for(var it in target.equipment){if(it==weaponSlot)continue;if(armorDamage>0){if(target.equipment.degradeItem(it,1))target.equipment.addExperience(it,armorDamage)}}target.armorDamage=0;var weaponDamage=Math.min(5,Math.ceil(target.weaponDamage/1e3));if(weaponDamage>0){if(target.equipment.degradeItem(weaponSlot,1))target.equipment.addExperience(weaponSlot,weaponDamage)}target.addWeaponExp(target.weaponDamage);target.weaponDamage=0},handleDropItem:function(entity,attacker){var itemLoot=this.getLootItem(attacker,entity,0);if(itemLoot&&itemLoot instanceof Item){console.info("LOOT ITEM SENT!");itemLoot.x=entity.x;itemLoot.y=entity.y;this.handleItemDespawn(itemLoot);return}var item=this.getDroppedOrStolenItem(attacker,entity,0);if(item&&item instanceof Item){item.x=entity.x;item.y=entity.y;this.handleItemDespawn(item);return}},handleDamage:function(entity,attacker,damage,crit){if(entity.effects){console.info("entity.effects: "+JSON.stringify(entity.effects));var effects=[];for(let[k,v]of Object.entries(entity.effects)){if(v==1)effects.push(parseInt(k))}}var hpMod=-damage;var epMod=0;console.info("effects: "+JSON.stringify(effects));console.info("DAMAGE: "+damage);console.info("CRIT: "+crit);entity.onDamage(attacker,hpMod,epMod,crit,effects)},handleEntityDeath:function(entity,attacker){if(attacker instanceof Player){attacker.skillHandler.setXPs();this.taskHandler.processEvent(attacker,PlayerEvent(EventType.KILLMOB,entity,1))}if(attacker instanceof Player||entity instanceof Player){var target=attacker instanceof Player?attacker:entity;this.handleEquipmentDegrading(target)}if(entity instanceof Player){entity.forEachAttacker((function(c){c.returnToSpawn()}));this.handlePlayerVanish(entity)}},handleHurtEntity:function(entity,attacker){var self=this;if(!entity||!attacker)return;if(entity.stats.hp<=0){this.handleDropItem(entity,attacker);if(entity instanceof Mob){entity.onKilled((function(attacker,damage){if(attacker instanceof Player){self.taskHandler.processEvent(attacker,PlayerEvent(EventType.DAMAGE,entity,damage))}}))}entity.die(attacker);this.handleEntityDeath(entity,attacker)}},handlePickpocket:function(source,target){var item=this.getDroppedOrStolenItem(source,target,1);if(item instanceof ItemRoom&&source.inventory.hasRoom()){source.inventory.putItem(item)}},handleItemDespawn:function(item){if(item){item.handleDespawn({beforeBlinkDelay:2e4,blinkCallback:function(){},blinkingDuration:8e3,despawnCallback:function(){item.map.entities.itemDespawn(item)}})}},getLootItem:function(source,target,stolen){var self=this;var itemId2=null;if(!target instanceof Mob||!target instanceof Chest)return;var drops={};if(source instanceof Player){for(var quest of source.quests){if(quest.type==QuestType.GETITEMKIND&&quest.object2.type==Types.EntityTypes.ITEMLOOT&&quest.object.type==Types.EntityTypes.MOB&&quest.object.kind==target.kind&&quest.status!=QuestStatus.COMPLETE&&(quest.count<quest.object2.count||!source.inventory.hasItemCount(quest.object2.kind+1e3))){drops[quest.object2.kind+1e3]=parseInt(quest.object2.chance*10)}}}var v=Utils.randomRangeInt(0,1e3);var itemId2;for(var d in drops){var count=drops[d];if(v>=0&&v<count){itemId2=d;break}v-=count}if(itemId2){var itemRoom=new ItemRoom(parseInt(itemId2),1,0,0,0);var lootItem=target.map.entities.createItem(itemRoom,target.x,target.y,1);lootItem.count=1;lootItem.experience=0;target.map.entities.pushNeighbours(target,lootItem.spawn());return target.map.entities.addItem(lootItem)}return null},getPlayerDrop:function(source,target,stolen){var itemIndex=target.inventory.getRandomItemNumber();if(itemIndex==-1)return;item=target.inventory.rooms[itemIndex];var count=1;if(ItemTypes.isConsumableItem(item.itemKind)){count=Math.floor((Math.random()*target.level+2)/2);if(count>item.itemNumber)count=item.itemNumber}var item2;if(stolen){item2=Object.assign(new ItemRoom,item);item2.itemNumber=count;source.map.entities.pushToPlayer(source,new Messages.Notify("CHAT","ITEM_ADDED",[Items.Kinds[item.itemKind].name]))}else{item2=target.map.entities.addItem(target.map.entities.createItem(type,item,target.x,target.y,count))}target.inventory.takeOutItems(itemIndex,count);return item2},getDrop:function(source,target,stolen){if(target.droppedItem==true)return;target.droppedItem=true;var drops=target.drops;var v=Utils.random(1e3);var itemId2;for(var itemId in drops){var count=drops[itemId];if(v>=0&&v<count){itemId2=itemId;break}v-=count}if(!itemId2)return null;var itemRoom;if(ItemTypes.isEquippable(itemId2)){var count=Utils.setEquipmentBonus(itemId2);itemRoom=new ItemRoom(itemId2,count,0,0,900,900,0);itemRoom.itemExperience=ItemTypes.itemExpForLevel[count-1]}else{itemRoom=new ItemRoom(itemId2,1,0,0,0,0,0)}var item=target.map.entities.createItem(itemRoom,target.x,target.y,1);if(stolen){if(source instanceof Player)source.map.entities.pushToPlayer(source,new Messages.Notify("CHAT","ITEM_ADDED",[Items.Kinds[item.itemKind].name]));return itemRoom}else{if(target.data&&target.data.dropBonus)item.count+=target.data.dropBonus;target.map.entities.pushNeighbours(target,item.spawn());item.enemyDrop=true;return target.map.entities.addItem(item)}},getGoldDrop:function(source,target,stolen){var count=target.dropGold();if(source instanceof Player){source.modifyGold(count)}},getDroppedOrStolenItem:function(source,target,stolen){var self=this;var item=null;if(source instanceof Player&&target instanceof Player){this.getGoldDrop(source,target,stolen);return this.getPlayerDrop(source,target,stolen)}else if(target instanceof Mob||target instanceof Chest){this.getGoldDrop(source,target,stolen);return this.getDrop(source,target,stolen)}return null},moveEntity:function(entity,x,y){var self=this;if(entity){entity.setPosition(x,y)}},onInit:function(callback){this.init_callback=callback},onPlayerConnect:function(callback){this.connect_callback=callback},onPlayerEnter:function(callback){this.enter_callback=callback},onPlayerAdded:function(callback){this.added_callback=callback},onPlayerRemoved:function(callback){this.removed_callback=callback},onRegenTick:function(callback){this.regen_callback=callback},onPvpRegenTick:function(callback){this.pvp_regen_callback=callback},onExpTick:function(callback){this.exp_callback=callback},onEntityAttack:function(callback){this.attack_callback=callback},onMobMoveCallback:function(mob){var self=this},pushWorld:function(message){var self=this;for(var mapId in self.maps){var map=self.maps[mapId];if(map.entities&&Object.keys(map.entities.packets).length>0){for(var id in map.entities.packets){map.entities.packets[id].push(message.serialize())}}}},getPopulation:function(){var self=this;var count=0;for(var id in self.maps){var map=self.maps[id];if(map.entities)count+=Object.keys(map.entities.players).length}return count},updatePopulation:function(){var self=this;setTimeout((function(){var count=0;for(var id in self.maps){var map=self.maps[id];if(map.entities)count+=Object.keys(map.entities.players).length}}),2e3)},createAttackLink:function(attacker,target){if(attacker.hasTarget()){attacker.removeTarget()}attacker.setTarget(target);target.addAttacker(attacker);attacker.addAttacker(target)},addParty:function(player1,player2){var party=new Party(player1,player2);this.party.push(party);return party},removeParty:function(party){this.party=_.reject(this.party,(function(el){return el===party}));delete party},getEntityByName:function(name){for(var player of players){if(player.name.toLowerCase()===name.toLowerCase())return player}return null}})},{"../shared/data/products.json":163,"../shared/js/gametypes":167,"../shared/js/itemtypes":168,"./appearancedata":79,"./auction":81,"./character":85,"./chest":87,"./chestarea":88,"./entity":91,"./entityspawn":93,"./gather":97,"./item":99,"./items":102,"./lib/class":105,"./looks":106,"./map":108,"./mapentities":110,"./mapmanager":111,"./message":112,"./mob":114,"./mobarea":116,"./mobdata":118,"./notificationdata.js":120,"./npcdata":121,"./npcmove":122,"./npcmovecontroller":123,"./npcstatic":124,"./party":126,"./pathfinder":127,"./player":128,"./playercontroller":129,"./skilldata":135,"./taskhandler":137,"./updater":144,"./utils":146,log:60,underscore:75,util:undefined}],148:[function(require,module,exports){var _=require("underscore");var BISON=require("bison");var useBison=false;var cls=require("./lib/class");var http=require("http");var https=require("https");const{Server:Server}=require("socket.io");var url=require("url");var Utils=require("./utils");var WS={};var zlib=require("zlib");var connect=require("connect");var fs=require("fs");module.exports=WS;var sServer=cls.Class.extend({init:function(){},onConnect:function(callback){this.connectionCallback=callback},onError:function(callback){this.errorCallback=callback},broadcast:function(message){throw"Not implemented"},forEachConnection:function(callback){_.each(this._connections,callback)},addConnection:function(connection){this._connections[connection.id]=connection},removeConnection:function(id){delete this._connections[id]},getConnection:function(id){return this._connections[id]}});var Connection=cls.Class.extend({init:function(id,connection,server){this._connection=connection;this._server=server;this.id=id},onClose:function(callback){this.closeCallback=callback},listen:function(callback){this.listenCallback=callback},broadcast:function(message){throw"Not implemented"},send:function(message){throw"Not implemented"},sendUTF8:function(data){throw"Not implemented"},close:function(logError){console.info("Closing connection to "+this._connection.remoteAddress+". "+logError);this._connection.conn.close()}});WS.WebsocketServer=sServer.extend({_connections:{},_counter:0,init:function(config){var self=this;this._super();var app={};if(config.https_cert!=""){app.cert=fs.readFileSync(config.https_cert)}if(config.https_key!=""){app.key=fs.readFileSync(config.https_key)}var client_connect=function(socket){console.info("Client socket connected from "+socket.conn.remoteAddress);socket.remoteAddress=socket.conn.remoteAddress;var c=new WS.socketioConnection(self._createId(),socket,self);if(self.connectionCallback){self.connectionCallback(c)}self.addConnection(c)};if(config.use_http){this._httpServer=http.createServer();this._httpServer.listen(config.http_port,config.ip,(function serverOnlyListening(){console.info("Server (only) is listening on port "+config.http_port)}));this._ioServer=new Server(this._httpServer,{cors:{origin:"*"}});this._ioServer.on("connection",(function webSocketListener(socket){client_connect(socket)}));this._ioServer.on("connect_error",(function(err){console.error(err)}))}if(config.use_https){this._httpsServer=https.createServer(app);this._httpsServer.listen(config.https_port,config.ip,(function serverOnlyListening(){console.info("Server (only) is listening on port "+config.https_port)}));this._ioServer2=new Server(this._httpsServer,{cors:{origin:"*"}});this._ioServer2.on("connection",(function webSocketListener(socket){client_connect(socket)}));this._ioServer2.on("connect_error",(function(err){console.error(err)}))}},_createId:function(){return 5e4+this._counter++},broadcast:function(message){this.forEachConnection((function(connection){connection.send(message)}))},onRequestStatus:function(statusCallback){this.statusCallback=statusCallback}});WS.socketioConnection=Connection.extend({init:function(id,connection,server){var self=this;this._super(id,connection,server);this._connection.on("message",(function(message){var flag=message.charAt(0);if(flag=="2"){var buffer=Buffer.from(flag,"base64");zlib.gunzip(buffer,((err,buffer)=>{if(err)console.log(err.toString());else{if(self.listenCallback){if(useBison){self.listenCallback(BISON.decode(buffer))}else{self.listenCallback(JSON.parse(buffer))}}}}))}else{if(self.listenCallback){if(useBison){self.listenCallback(BISON.decode(message.substr(1)))}else{self.listenCallback(JSON.parse(message.substr(1)))}}}}));this._connection.on("disconnect",(function(){console.info("Client closed socket "+self._connection.conn.remoteAddress);if(self.closeCallback){self.closeCallback()}delete self._server.removeConnection(self.id)}))},send:function(message){console.info("send="+message);var self=this;var data;if(useBison){data=BISON.encode(message)}else{data=JSON.stringify(message)}if(data.length>=2048){zlib.gzip(data,{level:1},((err,buffer)=>{buffer=new Buffer(buffer).toString("base64");self.sendUTF8("2"+buffer)}))}else{self.sendUTF8("1"+data)}},sendUTF8:function(data){this._connection.send(data)}})},{"./lib/class":105,"./utils":146,bison:undefined,connect:undefined,fs:undefined,http:undefined,https:undefined,"socket.io":undefined,underscore:75,url:undefined,zlib:undefined}],149:[function(require,module,exports){module.exports=[[{type:1,objectType:2,objectKind:0,count:10},{type:1,objectType:2,objectKind:0,count:25},{type:1,objectType:2,objectKind:0,count:50},{type:1,objectType:2,objectKind:0,count:100},{type:1,objectType:2,objectKind:0,count:200},{type:1,objectType:2,objectKind:0,count:500},{type:1,objectType:2,objectKind:0,count:1e3}],[{type:2,objectType:0,objectKind:0,count:10},{type:2,objectType:0,objectKind:0,count:25},{type:2,objectType:0,objectKind:0,count:50},{type:2,objectType:0,objectKind:0,count:100},{type:2,objectType:0,objectKind:0,count:200},{type:2,objectType:0,objectKind:0,count:500},{type:2,objectType:0,objectKind:0,count:1e3}],[{type:4,objectType:0,objectKind:0,count:1e3},{type:4,objectType:0,objectKind:0,count:2500},{type:4,objectType:0,objectKind:0,count:5e3},{type:4,objectType:0,objectKind:0,count:1e4},{type:4,objectType:0,objectKind:0,count:25e3},{type:4,objectType:0,objectKind:0,count:5e4},{type:4,objectType:0,objectKind:0,count:1e5}]]},{}],150:[function(require,module,exports){module.exports=[{name:"Sword 1",type:"weapon",sprite:"sword1",buy:0},{name:"Sword 2",type:"weapon",sprite:"sword2",buy:500},{name:"Axe",type:"weapon",sprite:"axe",buy:1e3},{name:"Morning Star",type:"weapon",sprite:"morningstar",buy:1500},{name:"Blue Sword",type:"weapon",sprite:"bluesword",buy:2e3},{name:"Red Sword",type:"weapon",sprite:"redsword",buy:2500},{name:"Golden Sword",type:"weapon",sprite:"goldensword",buy:3e3},{name:"Side Sword",type:"weapon",sprite:"sidesword",buy:3500},{name:"Spear",type:"weapon",sprite:"spear",buy:4e3},{name:"Scimitar",type:"weapon",sprite:"scimitar",buy:4500},{name:"Trident",type:"weapon",sprite:"trident",buy:5e3},{name:"Blue Scimitar",type:"weapon",sprite:"bluescimitar",buy:5500},{name:"Hammer",type:"weapon",sprite:"hammer",buy:6e3},{name:"Green Light Saber",type:"weapon",sprite:"greenlightsaber",buy:6500},{name:"Sky Light Saber",type:"weapon",sprite:"skylightsaber",buy:7e3},{name:"Red Light Saber",type:"weapon",sprite:"redlightsaber",buy:7500},{name:"Bastard Sword",type:"weapon",sprite:"bastardsword",buy:8e3},{name:"Red Metal Sword",type:"weapon",sprite:"redmetalsword",buy:8500},{name:"Justice Hammer",type:"weapon",sprite:"justicehammer",buy:9e3},{name:"Rose",type:"weapon",sprite:"rose",buy:9500},{name:"Ice Rose",type:"weapon",sprite:"icerose",buy:1e4},{name:"Halberd",type:"weapon",sprite:"halberd",buy:10500},{name:"Whip",type:"weapon",sprite:"whip",buy:11e3},{name:"Forest Guardian Sword",type:"weapon",sprite:"forestguardiansword",buy:11500},{name:"Sickle",type:"weapon",sprite:"sickle",buy:12e3},{name:"Plunger",type:"weapon",sprite:"plunger",buy:12500},{name:"Red Sickle",type:"weapon",sprite:"redsickle",buy:13e3},{name:"Day Walker",type:"weapon",sprite:"daywalker",buy:13500},{name:"Purple Cloud Kallege",type:"weapon",sprite:"purplecloudkallege",buy:14e3},{name:"Sea Rage",type:"weapon",sprite:"searage",buy:14500},{name:"Breaker",type:"weapon",sprite:"breaker",buy:15e3},{name:"Enel Trident",type:"weapon",sprite:"eneltrident",buy:15500},{name:"Rainbow Sword",type:"weapon",sprite:"rainbowsword",buy:16e3},{name:"Typhoon",type:"weapon",sprite:"typhoon",buy:16500},{name:"Memme",type:"weapon",sprite:"memme",buy:17e3},{name:"Candybar",type:"weapon",sprite:"candybar",buy:17500},{name:"Butcher Knife",type:"weapon",sprite:"butcherknife",buy:18e3},{name:"Fire Shot",type:"weapon",sprite:"fireshot",buy:18500},{name:"Comb",type:"weapon",sprite:"comb",buy:19e3},{name:"Squeaky Hammer",type:"weapon",sprite:"squeakyhammer",buy:19500},{name:"Fire Play",type:"weapon",sprite:"fireplay",buy:2e4},{name:"Wea Staff",type:"weapon",sprite:"weastaff",buy:20500},{name:"Pink Sword",type:"weapon",sprite:"pinksword",buy:21e3},{name:"Conference Call",type:"weapon",sprite:"conferencecall",buy:21500},{name:"Cactus Axe",type:"weapon",sprite:"cactusaxe",buy:22e3},{name:"Devil Kazya Sword",type:"weapon",sprite:"devilkazyasword",buy:22500},{name:"Bamboo Spear",type:"weapon",sprite:"bamboospear",buy:23e3},{name:"Paewoldo",type:"weapon",sprite:"paewoldo",buy:23500},{name:"Magic Spear",type:"weapon",sprite:"magicspear",buy:24e3},{name:"Fire Sword",type:"weapon",sprite:"firesword",buy:24500},{name:"Wooden Bow",type:"weaponarcher",sprite:"woodenbow",buy:0},{name:"Plastic Bow",type:"weaponarcher",sprite:"plasticbow",buy:500},{name:"Iron Bow",type:"weaponarcher",sprite:"ironbow",buy:1e3},{name:"Red Bow",type:"weaponarcher",sprite:"redbow",buy:1500},{name:"Violet Bow",type:"weaponarcher",sprite:"violetbow",buy:2e3},{name:"Death Bow",type:"weaponarcher",sprite:"deathbow",buy:2500},{name:"Golden Bow",type:"weaponarcher",sprite:"goldenbow",buy:3e3},{name:"Watermelon Bow",type:"weaponarcher",sprite:"watermelonbow",buy:3500},{name:"Green Bow",type:"weaponarcher",sprite:"greenbow",buy:4e3},{name:"Redenel Bow",type:"weaponarcher",sprite:"redenelbow",buy:4500},{name:"Mermaid Bow",type:"weaponarcher",sprite:"mermaidbow",buy:5e3},{name:"Seahorse Bow",type:"weaponarcher",sprite:"seahorsebow",buy:5500},{name:"Hunter Bow",type:"weaponarcher",sprite:"hunterbow",buy:6e3},{name:"Green Light Bow",type:"weaponarcher",sprite:"greenlightbow",buy:6500},{name:"Sky Light Bow",type:"weaponarcher",sprite:"skylightbow",buy:7e3},{name:"Red Light Bow",type:"weaponarcher",sprite:"redlightbow",buy:7500},{name:"Captain Bow",type:"weaponarcher",sprite:"captainbow",buy:8e3},{name:"Red Metal Bow",type:"weaponarcher",sprite:"redmetalbow",buy:8500},{name:"Justice Bow",type:"weaponarcher",sprite:"justicebow",buy:9e3},{name:"Rose Bow",type:"weaponarcher",sprite:"rosebow",buy:9500},{name:"Marine Bow",type:"weaponarcher",sprite:"marinebow",buy:1e4},{name:"Crystal Bow",type:"weaponarcher",sprite:"crystalbow",buy:10500},{name:"Colorful Bow",type:"weaponarcher",sprite:"gaybow",buy:11e3},{name:"Forest Bow",type:"weaponarcher",sprite:"forestbow",buy:11500},{name:"Sickle Bow",type:"weaponarcher",sprite:"sicklebow",buy:12e3},{name:"Blood Bow",type:"weaponarcher",sprite:"bloodbow",buy:12500},{name:"Red Sickle Bow",type:"weaponarcher",sprite:"redsicklebow",buy:13e3},{name:"Cloth Armor",type:"armor",sprite:"clotharmor",buy:0},{name:"Leather Armor",type:"armor",sprite:"leatherarmor",buy:500},{name:"Mail Armor",type:"armor",sprite:"mailarmor",buy:1e3},{name:"Plate Armor",type:"armor",sprite:"platearmor",buy:1500},{name:"Red Armor",type:"armor",sprite:"redarmor",buy:2e3},{name:"Golden Armor",type:"armor",sprite:"goldenarmor",buy:2500},{name:"Green Armor",type:"armor",sprite:"greenarmor",buy:3e3},{name:"Green Wing Armor",type:"armor",sprite:"greenwingarmor",buy:3500},{name:"Guard Armor",type:"armor",sprite:"guardarmor",buy:4e3},{name:"Red Guard Armor",type:"armor",sprite:"redguardarmor",buy:4500},{name:"White Armor",type:"armor",sprite:"whitearmor",buy:5e3},{name:"Rat Armor",type:"armor",sprite:"ratarmor",buy:5500},{name:"Blue Pirate Armor",type:"armor",sprite:"bluepiratearmor",buy:6e3},{name:"Cheoli Armor",type:"armor",sprite:"cheoliarmor",buy:6500},{name:"Dovakin Armor",type:"armor",sprite:"dovakinarmor",buy:7e3},{name:"GB Wing Armor",type:"armor",sprite:"gbwingarmor",buy:7500},{name:"Red Wing Armor",type:"armor",sprite:"redwingarmor",buy:8e3},{name:"Snow Fox Armor",type:"armor",sprite:"snowfoxarmor",buy:8500},{name:"Wolf Armor",type:"armor",sprite:"wolfarmor",buy:9e3},{name:"Blue Wing Armor",type:"armor",sprite:"bluewingarmor",buy:9500},{name:"Thief Armor",type:"armor",sprite:"thiefarmor",buy:1e4},{name:"Ninja Armor",type:"armor",sprite:"ninjaarmor",buy:10500},{name:"Dragon Armor",type:"armor",sprite:"dragonarmor",buy:11e3},{name:"Fallen Armor",type:"armor",sprite:"fallenarmor",buy:11500},{name:"Paladin Armor",type:"armor",sprite:"paladinarmor",buy:12e3},{name:"Crystal Armor",type:"armor",sprite:"crystalarmor",buy:12500},{name:"Adherer Robe",type:"armor",sprite:"adhererrobe",buy:13e3},{name:"Frost Armor",type:"armor",sprite:"frostarmor",buy:13500},{name:"Strap Armor",type:"armor",sprite:"gayarmor",buy:14e3},{name:"School Uniform",type:"armor",sprite:"schooluniform",buy:14500},{name:"Beautiful Life",type:"armor",sprite:"beautifullife",buy:15e3},{name:"Region Armor",type:"armor",sprite:"regionarmor",buy:15500},{name:"Ghost Rider",type:"armor",sprite:"ghostrider",buy:16e3},{name:"Taekwondo",type:"armor",sprite:"taekwondo",buy:16500},{name:"Rabbit Armor",type:"armor",sprite:"rabbitarmor",buy:17e3},{name:"Portal Armor",type:"armor",sprite:"portalarmor",buy:17500},{name:"Pirate King",type:"armor",sprite:"pirateking",buy:18e3},{name:"Sea Dragon Armor",type:"armor",sprite:"seadragonarmor",buy:18500},{name:"Shadow Region Armor",type:"armor",sprite:"shadowregionarmor",buy:19e3},{name:"Enel Armor",type:"armor",sprite:"enelarmor",buy:19500},{name:"Mini Sea Dragon Armor",type:"armor",sprite:"miniseadragonarmor",buy:2e4},{name:"Huni Armor",type:"armor",sprite:"huniarmor",buy:20500},{name:"Dambo Armor",type:"armor",sprite:"damboarmor",buy:21e3},{name:"Squid Armor",type:"armor",sprite:"squidarmor",buy:21500},{name:"Bee Armor",type:"armor",sprite:"beearmor",buy:22e3},{name:"Blue Dambo Armor",type:"armor",sprite:"bluedamboarmor",buy:22500},{name:"Rudolf Armor",type:"armor",sprite:"rudolfarmor",buy:23e3},{name:"Christmas Armor",type:"armor",sprite:"christmasarmor",buy:23500},{name:"Robocop Armor",type:"armor",sprite:"robocoparmor",buy:24e3},{name:"Pink Cockroach Armor",type:"armor",sprite:"pinkcockroacharmor",buy:24500},{name:"Cockroach Suit",type:"armor",sprite:"cockroachsuit",buy:25e3},{name:"Dinosaur Armor",type:"armor",sprite:"dinosaurarmor",buy:25500},{name:"Cat Armor",type:"armor",sprite:"catarmor",buy:26e3},{name:"Snowman Armor",type:"armor",sprite:"snowmanarmor",buy:26500},{name:"Beetle Armor",type:"armor",sprite:"beetlearmor",buy:27e3},{name:"Hongcheol Armor",type:"armor",sprite:"hongcheolarmor",buy:27500},{name:"Tiger Armor",type:"armor",sprite:"tigerarmor",buy:28e3},{name:"Wizard Rob",type:"armor",sprite:"wizardrobe",buy:28500},{name:"Iron Knight Armor",type:"armor",sprite:"ironknightarmor",buy:29e3},{name:"Evil Armor",type:"armor",sprite:"evilarmor",buy:29500},{name:"Green Dambo Armor",type:"armor",sprite:"greendamboarmor",buy:3e4},{name:"Red Dambo Armor",type:"armor",sprite:"reddamboarmor",buy:30500},{name:"Devil Kazya Armor",type:"armor",sprite:"devilkazyaarmor",buy:31e3},{name:"Bridal Mask",type:"armor",sprite:"bridalmask",buy:31500},{name:"Black Spider Armor",type:"armor",sprite:"blackspiderarmor",buy:32e3},{name:"Frog Armor",type:"armor",sprite:"frogarmor",buy:32500},{name:"Bearseonbi Armor",type:"armor",sprite:"bearseonbiarmor",buy:33e3},{name:"Raindow A Pro",type:"armor",sprite:"rainbowapro",buy:33500},{name:"Coke Armor",type:"armor",sprite:"cokearmor",buy:34e3},{name:"Fried Potato Armor",type:"armor",sprite:"friedpotatoarmor",buy:34500},{name:"Burger Armor",type:"armor",sprite:"burgerarmor",buy:35e3},{name:"Halloween JK Armor",type:"armor",sprite:"halloweenjkarmor",buy:35500},{name:"Frankenstein Armor",type:"armor",sprite:"frankensteinarmor",buy:36e3},{name:"Admin armor",type:"armor",sprite:"adminarmor",buy:36500},{name:"Cloth Armor",type:"armorarcher",sprite:"clotharmor",buy:0},{name:"Leather Armor",type:"armorarcher",sprite:"leatherarcherarmor",buy:500},{name:"Mail Armor",type:"armorarcher",sprite:"mailarcherarmor",buy:1e3},{name:"Plate Armor",type:"armorarcher",sprite:"platearcherarmor",buy:1500},{name:"Red Armor",type:"armorarcher",sprite:"redarcherarmor",buy:2e3},{name:"Golden Armor",type:"armorarcher",sprite:"goldenarcherarmor",buy:2500},{name:"Green Armor",type:"armorarcher",sprite:"greenarcherarmor",buy:3e3},{name:"Green Wing Armor",type:"armorarcher",sprite:"greenwingarcherarmor",buy:3500},{name:"Guard Armor",type:"armorarcher",sprite:"guardarcherarmor",buy:4e3},{name:"Red Guard Armor",type:"armorarcher",sprite:"redguardarcherarmor",buy:4500},{name:"White Armor",type:"armorarcher",sprite:"whitearcherarmor",buy:5e3},{name:"Pirate Armor",type:"armorarcher",sprite:"piratearcherarmor",buy:5500},{name:"Cheoli Armor",type:"armorarcher",sprite:"cheoliarcherarmor",buy:6e3},{name:"Dovakin Armor",type:"armorarcher",sprite:"dovakinarcherarmor",buy:6500},{name:"GB Wing Armor",type:"armorarcher",sprite:"gbwingarcherarmor",buy:7e3},{name:"Red Wing Armor",type:"armorarcher",sprite:"redwingarcherarmor",buy:7500},{name:"Snow Fox Armor",type:"armorarcher",sprite:"snowfoxarcherarmor",buy:8e3},{name:"Wolf Armor",type:"armorarcher",sprite:"wolfarcherarmor",buy:8500},{name:"Blue Wing Armor",type:"armorarcher",sprite:"bluewingarcherarmor",buy:9e3},{name:"Fallen Armor",type:"armorarcher",sprite:"fallenarcherarmor",buy:9500},{name:"Crystal Armor",type:"armorarcher",sprite:"crystalarcherarmor",buy:1e4},{name:"Legolas Armor",type:"armorarcher",sprite:"legolasarmor",buy:10500},{name:"Adherer Armor",type:"armorarcher",sprite:"adhererarcherarmor",buy:11e3},{name:"School Uniform",type:"armorarcher",sprite:"archerschooluniform",buy:11500},{name:"Combat Uniform",type:"armorarcher",sprite:"combatuniform",buy:12e3},{name:"Strap Armor",type:"armorarcher",sprite:"gayarcherarmor",buy:12500}]},{}],151:[function(require,module,exports){module.exports=[{i:[[310,16]],o:104},{i:[[310,4]],o:105},{i:[[310,4]],o:106},{i:[[310,4]],o:107},{i:[[311,16]],o:108},{i:[[311,4]],o:109},{i:[[311,4]],o:110},{i:[[311,4]],o:111},{i:[[312,16]],o:112},{i:[[312,4]],o:113},{i:[[312,4]],o:114},{i:[[312,4]],o:115},{i:[[301,1],[302,3]],o:305},{i:[[301,1],[303,3]],o:306},{i:[[301,1],[304,3]],o:307},{i:[[301,6],[305,10]],o:201},{i:[[301,6],[305,10]],o:211},{i:[[301,6],[305,10]],o:221},{i:[[301,6],[305,10]],o:231},{i:[[301,6],[306,10]],o:202},{i:[[301,6],[306,10]],o:212},{i:[[301,6],[306,10]],o:222},{i:[[301,6],[306,10]],o:232},{i:[[301,6],[307,10]],o:203},{i:[[301,6],[307,10]],o:213},{i:[[301,6],[307,10]],o:223},{i:[[301,6],[307,10]],o:233}]},{}],152:[function(require,module,exports){module.exports=[]},{}],153:[function(require,module,exports){module.exports=[{name:"Scrolls",sprite:"itemloot.png",offset:[0,0],rarity:"1"},{name:"Dice",sprite:"itemloot.png",offset:[0,1],rarity:"1"},{name:"Book",sprite:"itemloot.png",offset:[0,2],rarity:"1"},{name:"Key",sprite:"itemloot.png",offset:[0,3],rarity:"1"},{name:"Bell",sprite:"itemloot.png",offset:[0,4],rarity:"1"},{name:"Padlock",sprite:"itemloot.png",offset:[0,5],rarity:"1"},{name:"Candle",sprite:"itemloot.png",offset:[0,6],rarity:"1"},{name:"Drumstick",sprite:"itemloot.png",offset:[0,7],rarity:"1"},{name:"IronHelmet",sprite:"itemloot.png",offset:[0,8],rarity:"1"},{name:"Gumnut",sprite:"itemloot.png",offset:[0,9],rarity:"1"},{name:"Fireball",sprite:"itemloot.png",offset:[1,0],rarity:"2"},{name:"WitchHat",sprite:"itemloot.png",offset:[1,1],rarity:"2"},{name:"Chest",sprite:"itemloot.png",offset:[1,2],rarity:"2"},{name:"Shield",sprite:"itemloot.png",offset:[1,3],rarity:"2"},{name:"Log",sprite:"itemloot.png",offset:[1,4],rarity:"2"},{name:"RingOne",sprite:"itemloot.png",offset:[1,5],rarity:"2"},{name:"DreamCatcher",sprite:"itemloot.png",offset:[1,6],rarity:"2"},{name:"SealedScroll",sprite:"itemloot.png",offset:[1,7],rarity:"2"},{name:"Spider",sprite:"itemloot.png",offset:[1,8],rarity:"2"},{name:"MeltedCandles",sprite:"itemloot.png",offset:[1,9],rarity:"2"},{name:"Feather",sprite:"itemloot.png",offset:[2,0],rarity:"3"},{name:"Compass",sprite:"itemloot.png",offset:[2,1],rarity:"3"},{name:"PinkFireball",sprite:"itemloot.png",offset:[2,2],rarity:"3"},{name:"Gem",sprite:"itemloot.png",offset:[2,3],rarity:"3"},{name:"FireEye",sprite:"itemloot.png",offset:[2,4],rarity:"3"},{name:"TotemFace",sprite:"itemloot.png",offset:[2,5],rarity:"3"},{name:"Gadget",sprite:"itemloot.png",offset:[2,6],rarity:"3"},{name:"Frog",sprite:"itemloot.png",offset:[2,7],rarity:"3"},{name:"ThrowingDagger",sprite:"itemloot.png",offset:[2,8],rarity:"3"},{name:"UrnOne",sprite:"itemloot.png",offset:[2,9],rarity:"3"},{name:"NecklaceOne",sprite:"itemloot.png",offset:[3,0],rarity:"4"},{name:"Squid",sprite:"itemloot.png",offset:[3,1],rarity:"4"},{name:"ClubOne",sprite:"itemloot.png",offset:[3,2],rarity:"4"},{name:"Crystals",sprite:"itemloot.png",offset:[3,3],rarity:"4"},{name:"Mace",sprite:"itemloot.png",offset:[3,4],rarity:"4"},{name:"CoinPouch",sprite:"itemloot.png",offset:[3,5],rarity:"4"},{name:"NecklaceTwo",sprite:"itemloot.png",offset:[3,6],rarity:"4"},{name:"Bones",sprite:"itemloot.png",offset:[3,7],rarity:"4"},{name:"RingTwo",sprite:"itemloot.png",offset:[3,8],rarity:"4"},{name:"AnimalSkull",sprite:"itemloot.png",offset:[3,9],rarity:"4"},{name:"Leaf",sprite:"itemloot.png",offset:[4,0],rarity:"5"},{name:"Cheese",sprite:"itemloot.png",offset:[4,1],rarity:"5"},{name:"Mushrooms",sprite:"itemloot.png",offset:[4,2],rarity:"5"},{name:"FeatherQuill",sprite:"itemloot.png",offset:[4,3],rarity:"5"},{name:"BoneEaring",sprite:"itemloot.png",offset:[4,4],rarity:"5"},{name:"Crate",sprite:"itemloot.png",offset:[4,5],rarity:"5"},{name:"Bat",sprite:"itemloot.png",offset:[4,6],rarity:"5"},{name:"PoisonVial",sprite:"itemloot.png",offset:[4,7],rarity:"5"},{name:"ScrollsThree",sprite:"itemloot.png",offset:[4,8],rarity:"5"},{name:"Bug",sprite:"itemloot.png",offset:[4,9],rarity:"5"},{name:"Anvil",sprite:"itemloot.png",offset:[5,0],rarity:"6"},{name:"BrokenGlass",sprite:"itemloot.png",offset:[5,1],rarity:"6"},{name:"Goblet",sprite:"itemloot.png",offset:[5,2],rarity:"6"},{name:"SkullRingTwo",sprite:"itemloot.png",offset:[5,3],rarity:"6"},{name:"MonsterClaw",sprite:"itemloot.png",offset:[5,4],rarity:"6"},{name:"PoisonVialTwo",sprite:"itemloot.png",offset:[5,5],rarity:"6"},{name:"BronzeHelmet",sprite:"itemloot.png",offset:[5,6],rarity:"6"},{name:"BasicKnife",sprite:"itemloot.png",offset:[5,7],rarity:"6"},{name:"Worms",sprite:"itemloot.png",offset:[5,8],rarity:"6"},{name:"AutumnLeaf",sprite:"itemloot.png",offset:[5,9],rarity:"6"},{name:"Drum",sprite:"itemloot.png",offset:[6,0],rarity:"7"},{name:"Acorns",sprite:"itemloot.png",offset:[6,1],rarity:"7"},{name:"Pendant",sprite:"itemloot.png",offset:[6,2],rarity:"7"},{name:"Lute",sprite:"itemloot.png",offset:[6,3],rarity:"7"},{name:"RingThree",sprite:"itemloot.png",offset:[6,4],rarity:"7"},{name:"BattleAxe",sprite:"itemloot.png",offset:[6,5],rarity:"7"},{name:"AncientShield",sprite:"itemloot.png",offset:[6,6],rarity:"7"},{name:"Broach",sprite:"itemloot.png",offset:[6,7],rarity:"7"},{name:"Maul",sprite:"itemloot.png",offset:[6,8],rarity:"7"},{name:"SmokePipe",sprite:"itemloot.png",offset:[6,9],rarity:"7"},{name:"Lizard",sprite:"itemloot.png",offset:[7,0],rarity:"8"},{name:"DragonEgg",sprite:"itemloot.png",offset:[7,1],rarity:"8"},{name:"MarbleJar",sprite:"itemloot.png",offset:[7,2],rarity:"8"},{name:"OldBottle",sprite:"itemloot.png",offset:[7,3],rarity:"8"},{name:"ShortSword",sprite:"itemloot.png",offset:[7,4],rarity:"8"},{name:"BookTwo",sprite:"itemloot.png",offset:[7,5],rarity:"8"},{name:"Bread",sprite:"itemloot.png",offset:[7,6],rarity:"8"},{name:"Mirror",sprite:"itemloot.png",offset:[7,7],rarity:"8"},{name:"Cards",sprite:"itemloot.png",offset:[7,8],rarity:"8"},{name:"PotOfGold",sprite:"itemloot.png",offset:[7,9],rarity:"8"},{name:"FaceMask",sprite:"itemloot.png",offset:[8,0],rarity:"9"},{name:"Bomb",sprite:"itemloot.png",offset:[8,1],rarity:"9"},{name:"HandBag",sprite:"itemloot.png",offset:[8,2],rarity:"9"},{name:"ToothNecklace",sprite:"itemloot.png",offset:[8,3],rarity:"9"},{name:"NecklaceThree",sprite:"itemloot.png",offset:[8,4],rarity:"9"},{name:"LeafWreath",sprite:"itemloot.png",offset:[8,5],rarity:"9"},{name:"Eyeball",sprite:"itemloot.png",offset:[8,6],rarity:"9"},{name:"CrudeDagger",sprite:"itemloot.png",offset:[8,7],rarity:"9"},{name:"SapJewel",sprite:"itemloot.png",offset:[8,8],rarity:"9"},{name:"Clever",sprite:"itemloot.png",offset:[8,9],rarity:"9"},{name:"MortAndPestle",sprite:"itemloot.png",offset:[9,0],rarity:"10"},{name:"WoodHorn",sprite:"itemloot.png",offset:[9,1],rarity:"10"},{name:"Pumpkin",sprite:"itemloot.png",offset:[9,2],rarity:"10"},{name:"HumanSkull",sprite:"itemloot.png",offset:[9,3],rarity:"10"},{name:"Thorns",sprite:"itemloot.png",offset:[9,4],rarity:"10"},{name:"FineComb",sprite:"itemloot.png",offset:[9,5],rarity:"10"},{name:"Cauldron",sprite:"itemloot.png",offset:[9,6],rarity:"10"},{name:"MagicBall",sprite:"itemloot.png",offset:[9,7],rarity:"10"},{name:"Mushroom",sprite:"itemloot.png",offset:[9,8],rarity:"10"},{name:"Hook",sprite:"itemloot.png",offset:[9,9],rarity:"10"},{name:"NordicCup",sprite:"itemloot.png",offset:[10,0],rarity:"10"}]},{}],154:[function(require,module,exports){module.exports=[{id:1,name:"Crude Club",type:"weapon",typemod:"attack",modifier:10,staticsheet:2,legacy:1,offset:[3,10]},{id:2,name:"Crude Sword",type:"weapon",typemod:"attack",modifier:20,staticsheet:2,legacy:1,offset:[5,9]},{id:3,name:"Beginnner Sword",type:"weapon",typemod:"attack",modifier:30,staticsheet:2,legacy:1,offset:[8,11]},{id:4,name:"Iron Sword",type:"weapon",typemod:"attack",modifier:40,staticsheet:2,legacy:1,offset:[4,0]},{id:5,name:"Steel Sword",type:"weapon",typemod:"attack",modifier:50,staticsheet:2,legacy:1,offset:[4,1]},{id:6,name:"Bronze Sword",type:"weapon",typemod:"attack",modifier:60,staticsheet:2,legacy:1,offset:[4,2]},{id:7,name:"Golden Sword",type:"weapon",typemod:"attack",modifier:70,staticsheet:2,legacy:1,offset:[4,3]},{id:8,name:"Glass Sword",type:"weapon",typemod:"attack",modifier:80,staticsheet:2,legacy:1,offset:[4,4]},{id:9,name:"Adamantite Sword",type:"weapon",typemod:"attack",modifier:90,staticsheet:2,legacy:1,offset:[4,5]},{id:10,name:"Plate Sword",type:"weapon",typemod:"attack",modifier:100,staticsheet:2,legacy:1,offset:[4,6]},{id:11,name:"Draconian Sword",type:"weapon",typemod:"attack",modifier:110,staticsheet:2,legacy:1,offset:[4,7]},{id:12,name:"Slingshot",type:"weaponarcher",typemod:"attack",modifier:10,staticsheet:2,legacy:1,offset:[1,10]},{id:13,name:"Crude Bow",type:"weaponarcher",typemod:"attack",modifier:20,staticsheet:2,legacy:1,offset:[7,8]},{id:14,name:"Beginner Bow",type:"weaponarcher",typemod:"attack",modifier:30,staticsheet:2,legacy:1,offset:[9,11]},{id:15,name:"Iron Bow",type:"weaponarcher",typemod:"attack",modifier:40,staticsheet:2,legacy:1,offset:[7,0]},{id:16,name:"Steel Bow",type:"weaponarcher",typemod:"attack",modifier:50,staticsheet:2,legacy:1,offset:[7,1]},{id:17,name:"Bronze Bow",type:"weaponarcher",typemod:"attack",modifier:60,staticsheet:2,legacy:1,offset:[7,2]},{id:18,name:"Gold Bow",type:"weaponarcher",typemod:"attack",modifier:70,staticsheet:2,legacy:1,offset:[7,3]},{id:19,name:"Glass Bow",type:"weaponarcher",typemod:"attack",modifier:80,staticsheet:2,legacy:1,offset:[7,4]},{id:20,name:"Adamantite Bow",type:"weaponarcher",typemod:"attack",modifier:90,staticsheet:2,legacy:1,offset:[7,5]},{id:21,name:"Plate Bow",type:"weaponarcher",typemod:"attack",modifier:100,staticsheet:2,legacy:1,offset:[7,6]},{id:22,name:"Draconian Bow",type:"weaponarcher",typemod:"attack",modifier:110,staticsheet:2,legacy:1,offset:[7,7]},{id:23,name:"Fur Armor",type:"armor",typemod:"defense",modifier:10,staticsheet:2,legacy:1,offset:[11,12]},{id:24,name:"Padded Armor",type:"armor",typemod:"defense",modifier:20,staticsheet:2,legacy:1,offset:[11,11]},{id:25,name:"Leather Armor",type:"armor",typemod:"defense",modifier:30,staticsheet:2,legacy:1,offset:[11,10]},{id:26,name:"Iron Armor",type:"armor",typemod:"defense",modifier:40,staticsheet:2,legacy:1,offset:[11,0]},{id:27,name:"Steel Armor",type:"armor",typemod:"defense",modifier:50,staticsheet:2,legacy:1,offset:[11,1]},{id:28,name:"Bronze Armor",type:"armor",typemod:"defense",modifier:60,staticsheet:2,legacy:1,offset:[11,2]},{id:29,name:"Golden Armor",type:"armor",typemod:"defense",modifier:70,staticsheet:2,legacy:1,offset:[11,3]},{id:30,name:"Glass Armor",type:"armor",typemod:"defense",modifier:80,staticsheet:2,legacy:1,offset:[11,4]},{id:31,name:"Adamantite Armor",type:"armor",typemod:"defense",modifier:90,staticsheet:2,legacy:1,offset:[11,5]},{id:32,name:"Plate Armor",type:"armor",typemod:"defense",modifier:100,staticsheet:2,legacy:1,offset:[11,6]},{id:33,name:"Draconian Armor",type:"armor",typemod:"defense",modifier:110,staticsheet:2,legacy:1,offset:[11,7]},{id:34,name:"Flask +250 HP",type:"object",typemod:"health",modifier:250,sprite:"item/item-flask.png",spriteName:"item-flask",offset:[0,0],buy:10,buycount:10},{id:35,name:"Burger +250 Energy",type:"object",typemod:"energy",modifier:250,sprite:"item/item-burger.png",spriteName:"item-burger",offset:[0,0],buy:30,buycount:10},{id:36,name:"Big Flask +25% HP",type:"object",typemod:"healthpercent",modifier:25,sprite:"item/item-bigflask.png",spriteName:"item-bigflask",offset:[0,0],buy:50,buycount:10},{id:100,name:"Leather Chest 1",type:"chest",typemod:"defense",level:10,modifier:10,staticsheet:1,spriteName:"armors",offset:[0,5]},{id:101,name:"Leather Helmet 1",type:"helm",typemod:"defense",level:12,modifier:5,staticsheet:1,spriteName:"armors",offset:[0,4]},{id:102,name:"Leather Gloves 1",type:"gloves",typemod:"defense",level:14,modifier:5,staticsheet:1,spriteName:"armors",offset:[0,6]},{id:103,name:"Leather Boots 1",type:"boots",typemod:"defense",level:16,modifier:5,staticsheet:1,spriteName:"armors",offset:[0,7]},{id:104,name:"Leather Chest 2",type:"chest",typemod:"defense",level:20,modifier:20,staticsheet:1,spriteName:"armors",offset:[1,5]},{id:105,name:"Leather Helmet 2",type:"helm",typemod:"defense",level:22,modifier:10,staticsheet:1,spriteName:"armors",offset:[1,4]},{id:106,name:"Leather Gloves 2",type:"gloves",typemod:"defense",level:24,modifier:10,staticsheet:1,spriteName:"armors",offset:[1,6]},{id:107,name:"Leather Boots 2",type:"boots",typemod:"defense",level:26,modifier:10,staticsheet:1,spriteName:"armors",offset:[1,7]},{id:108,name:"Leather Chest 3",type:"chest",typemod:"defense",level:30,modifier:30,staticsheet:1,spriteName:"armors",offset:[2,5]},{id:109,name:"Leather Helmet 3",type:"helm",typemod:"defense",level:32,modifier:15,staticsheet:1,spriteName:"armors",offset:[2,4]},{id:110,name:"Leather Gloves 3",type:"gloves",typemod:"defense",level:34,modifier:15,staticsheet:1,spriteName:"armors",offset:[2,6]},{id:111,name:"Leather Boots 3",type:"boots",typemod:"defense",level:36,modifier:15,staticsheet:1,spriteName:"armors",offset:[2,7]},{id:112,name:"Leather Chest 4",type:"chest",typemod:"defense",level:40,modifier:40,staticsheet:1,spriteName:"armors",offset:[3,5]},{id:113,name:"Leather Helmet 4",type:"helm",typemod:"defense",level:42,modifier:20,staticsheet:1,spriteName:"armors",offset:[3,4]},{id:114,name:"Leather Gloves 4",type:"gloves",typemod:"defense",level:44,modifier:20,staticsheet:1,spriteName:"armors",offset:[3,6]},{id:115,name:"Leather Boots 4",type:"boots",typemod:"defense",level:46,modifier:20,staticsheet:1,spriteName:"armors",offset:[3,7]},{id:200,name:"Sword 1",type:"sword",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,0]},{id:201,name:"Sword 2",type:"sword",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,0]},{id:202,name:"Sword 3",type:"sword",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,0]},{id:203,name:"Sword 4",type:"sword",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,0]},{id:204,name:"Sword 5",type:"sword",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,0]},{id:205,name:"Sword 6",type:"sword",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,0]},{id:206,name:"Sword 7",type:"sword",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,0]},{id:207,name:"Sword 8",type:"sword",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,0]},{id:208,name:"Sword 9",type:"sword",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,0]},{id:209,name:"Sword 10",type:"sword",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,0]},{id:210,name:"Bow 1",type:"bow",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,3]},{id:211,name:"Bow 2",type:"bow",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,3]},{id:212,name:"Bow 3",type:"bow",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,3]},{id:213,name:"Bow 4",type:"bow",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,3]},{id:214,name:"Bow 5",type:"bow",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,3]},{id:215,name:"Bow 6",type:"bow",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,3]},{id:216,name:"Bow 7",type:"bow",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,3]},{id:217,name:"Bow 8",type:"bow",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,3]},{id:218,name:"Bow 9",type:"bow",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,3]},{id:219,name:"Bow 10",type:"bow",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,3]},{id:220,name:"Hammer 1",type:"hammer",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,5]},{id:221,name:"Hammer 2",type:"hammer",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,5]},{id:222,name:"Hammer 3",type:"hammer",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,5]},{id:223,name:"Hammer 4",type:"hammer",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,5]},{id:224,name:"Hammer 5",type:"hammer",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,5]},{id:225,name:"Hammer 6",type:"hammer",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,5]},{id:226,name:"Hammer 7",type:"hammer",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,5]},{id:227,name:"Hammer 8",type:"hammer",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,5]},{id:228,name:"Hammer 9",type:"hammer",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,5]},{id:229,name:"Hammer 10",type:"hammer",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,5]},{id:230,name:"Axe 1",type:"axe",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,8]},{id:231,name:"Axe 2",type:"axe",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,8]},{id:232,name:"Axe 3",type:"axe",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,8]},{id:233,name:"Axe 4",type:"axe",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,8]},{id:234,name:"Axe 5",type:"axe",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,8]},{id:235,name:"Axe 6",type:"axe",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,8]},{id:236,name:"Axe 7",type:"axe",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,8]},{id:237,name:"Axe 8",type:"axe",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,8]},{id:238,name:"Axe 9",type:"axe",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,8]},{id:239,name:"Axe 10",type:"axe",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,8]},{id:300,name:"Stone",type:"craft",level:10,staticsheet:5,spriteName:"gather1",offset:[1,0]},{id:301,name:"Coal",type:"craft",level:20,staticsheet:8,spriteName:"nodeset2",offset:[1,0]},{id:302,name:"Light Iron",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[1,1]},{id:303,name:"Medium Iron",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[1,2]},{id:304,name:"Hard Iron",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[1,3]},{id:305,name:"Iron Ingot 1",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[2,1]},{id:306,name:"Iron Ingot 2",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[2,2]},{id:307,name:"Iron Ingot 3",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[2,3]},{id:310,name:"Leather 1",type:"craft",staticsheet:6,spriteName:"craft1",offset:[0,0]},{id:311,name:"Leather 2",type:"craft",staticsheet:6,spriteName:"craft1",offset:[1,0]},{id:312,name:"Leather 3",type:"craft",staticsheet:6,spriteName:"craft1",offset:[2,0]},{id:313,name:"Leather 4",type:"craft",staticsheet:6,spriteName:"craft1",offset:[3,0]},{id:320,name:"Wood",type:"craft",staticsheet:7,spriteName:"craft2",offset:[0,0]}]},{}],155:[function(require,module,exports){module.exports={EN:{BANK_FULL:"Bank is full.",EQUIPMENT_FULL:"Equipment is full.",INVENTORY_FULL:"Inventory is full.",ITEM_ADDED:"{0} added",GOLD_ADDED:"{0} gold added",GOLD_REMOVED:"{0} gold removed",EQUIPMENT_LEVEL:"You need to be level {0} to equip this.",EQUIPMENT_WRONGCLASS:"Your class cannot use this Item.",CHAT_MUTED:"You are currently muted.",MAP_ENTERED:"{0} has entered the {1} map.",NOTICE_1:"Go to the Google Play Store and rate Retro RPG Online!",TRADE_REQUESTED:"You requested a trade with {0}.",TRADE_REQUEST:"{0} has requested to trade you.",TUTORIAL_MOVE:"Click or Tap on land to move.",TUTORIAL_ATTACK:"Now click or tap on a Monster to attack",TUTORIAL_ATTACK2:"Thats it now kill more Monsters.",TUTORIAL_EQUIP:"Now I want to equip my brought gear by going into Menu Backpack and selecting it.",TUTORIAL_SHOPBUY:"I should find the Beginner Store by going to the menu and pressing Town.",TUTORIAL_SHOPBUY2:"I want to buy my first Armor and Weapon that is Level 10.",TUTORIAL_STATS:"You can now assign custom Stats in Menu >> Character >> 3rd Page (Character Stats),",TUTORIAL_PORTAL:"In the Town House move to the blue Portal near the bottom left.",SHOP_REPAIRED:"{0} item repaired.",SHOP_REMOVED:"{0} item removed.",SHOP_SOLD:"{0} has been sold.",SHOP_BUY:"{0} has been bought.",SHOP_ENCHANTED:"{0} has been enchanted.",SHOP_NOGOLD:"You don't have enough Gold.",SHOP_NOGEMS:"You don't have enough Gems.",SHOP_NOSPACE:"There is not enough space in your inventory.",SHOP_MISMATCH:"The price has been changed, please try again.",AUCTION_ADDED:"The auction item you listed has been added.",SHOP_NOCRAFTITEMS:"You do not have enough craft Items.",SHOP_MISSINGITEMS:"You are missing {0} {1}'s",COMBAT_PLAYERKILLED:"/1 {0} killed {1} in combat.",COMBAT_TARGETINVINCIBLE:"Target is invincible.",GROUP_PLAYERLEFT:"{0} has left your group.",ATTACK_TOOFAR:"You are too far away to attack.",TUTORIAL:"TUTORIAL",TUTORIAL_1:"To Move, Mouse click on the Map or an Object, or use the WASD or arrow keys.",TUTORIAL_2:"To Attack, Mouse click on the Object or get in attack range and press Space bar.",TUTORIAL_3:"To Cycle Targets, use keys T to target the closest Object or Y to reverse target.",TUTORIAL_4:"You can use Keys 1-4 for Skill Shortcuts, and Keys 5-8 for consumables like Potions.",TUTORIAL_5:"If you need to buy items you can select Menu >> Town to instantly warp to Town.",TUTORIAL_6:"At level 10 you can equip Items in Menu >> Equipment, and at level 20 you can assign Stat Points.",ACHIEVEMENTS_0:"Kill {0} Monsters.",ACHIEVEMENTS_1:"Collect {0} Items.",ACHIEVEMENTS_2:"Do {0} Damage to Monsters.",ACHIEVEMENTS_0_COMPLETE:"Achievement - Kill {0} Monsters Completed. {1}XP Added.",ACHIEVEMENTS_1_COMPLETE:"Achievement - Collect {0} Items Completed. {1}XP Added.",ACHIEVEMENTS_2_COMPLETE:"Achievement - Do {0} Damage to Monsters Completed. {1}XP Added.",PARTY_PLAYER_INVITE_SENT:"Party invite sent to player {0}",PARTY_MAX_PLAYERS:"Max players reached in party.",PARTY_PLAYER_JOINED:"{0} joined your party.",PARTY_PLAYER_ADDED:"You are now partied with {0}",PARTY_YOU_REJECTED_INVITE:"You rejected {0}'s invite.",PARTY_THEY_REJECTED_INVITE:"{0} rejected your invite.",PARTY_CANNOT_KICK:"You cannot kick as you are not in a party or leader.",PARTY_PLAYER_KICKED:"You have been kicked from the party.",PARTY_NOT_LEADER:"You cannot set the leader as you are not in a party.",PARTY_YOU_LEADER:"You are now the leader.",PARTY_PLAYER_LEADER:"{0} is now leader.",PARTY_IS_LEADER:"{0} is already leader.",PARTY_NOT_IN:"You cannot leave as you are not in a party.",PARTY_PLAYER_LEFT:"{0} has left your party.",PARTY_YOU_LEFT:"You have left {0}'s party.",PARTY_ALL_LEFT:"The party has been disbanded.",NO_PLAYER_EXIST:"Player {0} does not exist.",HARVEST_INVALID:"You cannot harvest at this point, use the right weapon, try somewhere else or again later.",HARVEST_ADDED:"{0} has been added to your inventory",HARVEST_WRONG_TYPE:"You cannot harvest this with a {0}.",HARVET_NO_WEAPON:"You do not have a harvest item equipped.",QUESTS:{1:[[[0,"You look lost young boy..."],[1,"Where am I?"],[0,"What do you mean where you are? Anyway I need help son."],[0,"You see, young one, my house, well, it's not quite the welcoming place it used to be."],[0,"It's overrun by rats, scurrying through every nook and cranny, making themselves right at home."],[0,"It's a bit of a mess, I'm afraid. Can you kill %count% rats for me, Sonny?"],[0,"That way I can get into my home again."]],["Kill %count% %name%'s"]],2:["QUESTS2: %name2%'s have stolen my %count% %name%s'. I need you to kill %name2%'s and get my %name%s' back.","Have you got my %count% %name%'s?","Thank you for returning my %name%'s now I can use them."]},QUESTS_MOB:[["Kill %count% %name%'s for me.","Killed %count% %name%'s"]],QUESTS_ITEM:[["%name2%'s have stolen my %count% %name%s'. I need you to kill %name2%'s and get my %name%s' back.","Have you got my %count% %name%'s?","Thank you for returning my %name%'s now I can use them."]],QUEST_SUMMARY:{1:"Kill %count% %name%'s",2:"Retrieve %count% %name%'s from %name2%s'"}}}},{}],156:[function(require,module,exports){module.exports={Rat:{name:"Rat",kind:1,attackMod:1,defenseMod:1,hpMod:1,xpMod:1,minLevel:1,maxLevel:3,aggroRange:0,attackRange:1,isAggressive:0,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"rat",idleSpeedMod:1},Crab:{name:"Crab",kind:2,attackMod:1.2,defenseMod:1.2,hpMod:1,minLevel:4,maxLevel:6,aggroRange:5,attackRange:1,isAggressive:0,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"crab",idleSpeedMod:1},Skeleton:{name:"Skeleton",kind:3,attackMod:1.1,defenseMod:1.1,hpMod:1.2,minLevel:7,maxLevel:9,aggroRange:2,attackRange:1,isAggressive:1,attackRateMod:1.5,reactionMod:1.5,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"skeleton",idleSpeedMod:1},Goblin:{name:"Goblin",kind:4,attackMod:1.2,defenseMod:.9,hpMod:.9,minLevel:10,maxLevel:12,aggroRange:3,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"goblin",idleSpeedMod:1},Snake:{name:"Snake",kind:5,attackMod:1.4,defenseMod:1,hpMod:.8,minLevel:13,maxLevel:15,aggroRange:3,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"snek",idleSpeedMod:1},Bat:{name:"Bat",kind:6,attackMod:1.3,defenseMod:1,hpMod:1,minLevel:16,maxLevel:18,aggroRange:6,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:1,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"bat",idleSpeedMod:1},Skeleton2:{name:"HardSkeleton",kind:7,attackMod:1.3,defenseMod:1.3,hpMod:1.2,minLevel:19,maxLevel:21,aggroRange:2,attackRange:1,isAggressive:1,attackRateMod:2,reactionMod:2,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"skeleton2",idleSpeedMod:1},Ogre:{name:"Ogre",kind:8,attackMod:1.3,defenseMod:1.1,hpMod:1.3,minLevel:22,maxLevel:24,aggroRange:5,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"ogre",idleSpeedMod:1},Eye:{name:"Eye",kind:9,attackMod:1.4,defenseMod:1,hpMod:1,minLevel:25,maxLevel:29,aggroRange:3,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"eye",idleSpeedMod:1},Wizard:{name:"Wizard",kind:10,attackMod:1.4,defenseMod:1,hpMod:1,minLevel:30,maxLevel:34,aggroRange:6,attackRange:3,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:3,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"wizard",idleSpeedMod:1},Spectre:{name:"Spectre",kind:11,attackMod:1.3,defenseMod:1.3,hpMod:1,minLevel:35,maxLevel:40,aggroRange:2,attackRange:2,isAggressive:1,attackRateMod:2,reactionMod:.5,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"spectre",idleSpeedMod:1},DeathKnight:{name:"DeathKnight",kind:12,attackMod:1.5,defenseMod:1.5,hpMod:1.5,minLevel:41,maxLevel:50,aggroRange:4,attackRange:1,isAggressive:1,attackRateMod:2,reactionMod:.5,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"deathknight",idleSpeedMod:1}}},{}],157:[function(require,module,exports){module.exports={plot:["You have awoken","You're awake","It's awake?","You will die this time","How could this happen?","Is that you?","It cant be..","But, but I thought you were dead..","This time you will not survive.","I will kill you for good.","None can survive me!","Curses youre alive still.","But, We destroyed you..","We killed your father and well kill you.","How can you be alive still?","Your brother gasped as he died.","Its, its you..","The chosen one, ha you will pay in blood"],battle:["Argh","Ugh","Oooh","Ahhh","MMmm","Eaat","Delicious","Die","Kill it","Kill","Destroy","Maimm","Death","Foood","Starving","Rawr","Roar","Yummy","Grrr","Growl"]}},{}],158:[function(require,module,exports){module.exports=[{textid:"NOTICE1",interval:60}]},{}],159:[function(require,module,exports){module.exports={0:{type:0,text:"Kill %count Monsters Level %level or more"},1:{type:2,text:"%names! Kill %count of em"},2:{type:2,text:"I am dying kill %count of %names"},3:{type:2,text:"%names have destroyed my home kill %count"},4:{type:2,text:"%names have swarmed us kill %count"},5:{type:2,text:"We've been overtaken by %names kill %count"},6:{type:2,text:"Kill %count %names for fun, there evil."},7:{type:1,text:"Get %count %name. Return them to Collect in town."},8:{type:4,text:"Find %name. We playing hide and seek!"}}},{}],160:[function(require,module,exports){module.exports=["Aeris","Baelan","Caelum","Darian","Eldryn","Faelan","Gavriel","Haven","Ilys","Jaelin","Kaelan","Lirael","Maelis","Naelen","Ovryn","Peregrine","Quillen","Raelin","Sylas","Tyrian","Uvaine","Vaelis","Wylan","Xaelor","Yaelith","Zephyr","Aldryn","Briar","Cyran","Daelin","Elowen","Fenris","Gaelan","Harlow","Ivory","Jadis","Kieran","Loren","Myst","Nyssa"]},{}],161:[function(require,module,exports){module.exports={0:["Alters","Altes","Amel","Amew","Ancin","Ancis","Andent","Anies","Arryn","Artin","Artip","Berny","Berter","Brancent","Brancis","Chames","Charles","Charliam","Drewis","Driffin","Drobert","Droguy","Edmugh","Edmund","Enryn","Ephed","Epher","Ephes","Eran","Ernam","Ethes","Ewis","Exam","Exard","Folke","Friffin","Gauwill","Gauwyn","Geoffrey","Georguy","Gerey","Gery","Gilas","Gilip","Grarder","Grobern","Gylip","Hames","Hamund","Hany","Harrey","Hony","Ilham","Ilhard","Illiam","Inghan","Jamath","Johny","Lasym","Lesym","Mesym","Munder","Narder","Nichye","Phughye","Raffin","Ralphye","Reder","Reward","Rewilh","Rewyn","Reyny","Richye","Robern","Robern","Roge","Roge","Ryany","Stephye","Stiny","Symas","Thamath","Vyncent","Vyncis","Waltin","Wilhye","Wyny"],1:["Abeth","Adon","Aebun","Aedad","Aelburg","Aengeth","Aenthrynn","Alhhild","Alyn","Anel","Argel","Auciet","Balde","Beatrey","Bely","Bily","Breawe","Brictlu","Briga","Brihta","Brione","Brithuia","Bruda","Bryne","Brytha","Burha","Cilia","Conga","Corna","Cyna","Deburg","Deleue","Ealhbun","Ealhburh","Ealket","Eanchild","Eanswild","Ebun","Ecin","Efrix","Elil","Elin","Ellet","Ellyn","Ellys","Elyn","Enen","Enet","Engard","Ennet","Ethen","Evet","Frowe","Frude","Fruna","Godga","Goldburg","Gythiue","Hely","Heve","Hily","Hone","Idgen","Isan","Izan","Joane","Kater","Kathon","Lizab","Lyse","Malia","Mara","Marey","Marget","Mary","Mery","Mildgiue","Olburh","Phone","Ricta","Ridget","Rithuia","Sabenn","Sane","Sarry","Sidwe","Stilda","Suse","Sybel","Tortga","Ware","Wellu","Wene","Wenga","Wilthroua","Wise","Witha","Withburh","Withiue","Wrtheahburg","Wuthe"]}},{}],162:[function(require,module,exports){module.exports=[{uid:"default",index:0},{uid:"agent",name:"Auction",index:1},{uid:"ancientmanumentnpc",index:2},{uid:"angelnpc",index:3},{uid:"beachnpc",name:"Beachgoer",index:4},{uid:"bluebikinigirlnpc",index:5},{uid:"bluestoremannpc",name:"Bank",index:6},{uid:"boxingman",name:"Bank",index:7},{uid:"coder",name:"Looks",index:8},{uid:"desertnpc",name:"Repair",index:9},{uid:"doctor",name:"Looks",index:10},{uid:"elfnpc",index:11},{uid:"fairynpc",index:12},{uid:"firstsonangelnpc",index:13},{uid:"fisherman",index:14},{uid:"forestnpc",index:15},{uid:"guard",index:16},{uid:"iamverycoldnpc",index:17},{uid:"iceelfnpc",index:18},{uid:"king",index:19},{uid:"lavanpc",name:"Dying Man",index:20},{uid:"mermaidnpc",name:"Mermaid",index:21},{uid:"mojojojonpc",index:22},{uid:"momangelnpc",index:23},{uid:"nyan",index:24},{uid:"octocat",index:25},{uid:"octopus",index:26},{uid:"oddeyecat",index:27},{uid:"pirategirlnpc",index:28},{uid:"priest",index:29},{uid:"redbikinigirlnpc",index:30},{uid:"redstoremannpc",name:"Craft",index:31},{uid:"rick",name:"Collect",index:32},{uid:"scientist",index:33},{uid:"secondsonangelnpc",index:34},{uid:"shepherdboy",name:"Shop",index:35},{uid:"snowshepherdboy",name:"Beginner shop",index:36},{uid:"soldier",index:37},{uid:"sorcerer",index:38},{uid:"sponge",index:39},{uid:"superiorangelnpc",index:40},{uid:"vampire",index:41},{uid:"vendingmachine",name:"Enchant",index:42},{uid:"villagegirl",name:"Enchant",index:43},{uid:"villager",name:"Quests",index:44},{uid:"zombiegf",name:"Quests",index:45}]},{}],163:[function(require,module,exports){module.exports=[{name:"gold100000",type:"gold",data:"100000"},{name:"gold1000000",type:"gold",data:"1000000"}]},{}],164:[function(require,module,exports){module.exports={1:{npcId:575,name:"Intro 1",type:1,level:0,object:{type:2,kind:1,count:1}},2:{npcId:575,name:"Intro 2",type:2,level:0,object:{type:2,kind:1,level:[0,2]},object2:{type:4,kind:1,count:3,chance:20}}}},{}],165:[function(require,module,exports){module.exports=[{name:"Beserker",skillType:0,recharge:30,iconOffset:[1,7],detail:"Beserker [l] - Boosts your attack by 3xlevel for 10 seconds,",targetType:0,duration:10,effects:[[0,0,2,3],[0,1,2,-3]]},{name:"Explosive Attack",skillType:2,recharge:10,iconOffset:[3,12],detail:"Explosive Attack [l] - AOE NOT IMPLEMENTED",targetType:1,countTotal:1,aoe:3,effects:[[1,0,4,50]]},{name:"Deadly Attack",skillType:2,recharge:10,iconOffset:[4,7],detail:"Deadly Attack [l] - Does an attack of 150 damage per level.",targetType:1,countTotal:1,effects:[[1,0,4,150]]},{name:"Daze",skillType:1,recharge:30,iconOffset:[0,12],detail:"Daze [l] - Dazes the target for [dpl]% seconds.",targetType:1,durationPL:1,effects:[[1,0,5,1],[1,1,5,0]]},{name:"Slow",skillType:1,recharge:20,iconOffset:[3,5],detail:"Slow [l] - Slows target for [dpl]% seconds.",targetType:1,durationPL:1,effects:[[1,0,6,100],[1,1,6,-100]]}]},{}],166:[function(require,module,exports){var exists,existsSync;(function(){var semver=require("semver");var module=semver.satisfies(process.version,">=0.7.1")?require("fs"):require("path");exists=module.exists;existsSync=module.existsSync})();if(!(typeof exports==="undefined")){module.exports.exists=exists;module.exports.existsSync=existsSync}},{fs:undefined,path:undefined,semver:undefined}],167:[function(require,module,exports){EventType={KILLMOB:1,LOOTITEM:2,KILLPLAYER:3,DAMAGE:4};QuestType={KILLMOBKIND:1,GETITEMKIND:2,KILLMOBS:3,HIDEANDSEEK:4};QuestStatus={STARTED:0,INPROGRESS:1,COMPLETE:2};InventoryMode={MODE_NORMAL:0,MODE_SELL:1,MODE_REPAIR:2,MODE_ENCHANT:3,MODE_BANK:4,MODE_AUCTION:5};SkillEffects={SkillType:{SELF:0,TARGET:1,ATTACK:2},TargetType:{SELF:0,ENEMY:1,PLAYER_AOE:2,ENEMY_AOE:3},EffectStat:{HP:0,EP:1,ATTACK:2,DEFENSE:3,DAMAGE:4,FREEZE:5,MOVESPEED:6}};Types={Messages:{BI_SYNCTIME:100,CS_CREATE_USER:1,CS_LOGIN_USER:2,CS_CREATE_PLAYER:3,CS_LOGIN_PLAYER:4,CS_ITEMSLOT:10,CS_APPEARANCEUNLOCK:11,CS_ATTACK:12,CS_AUCTIONBUY:13,CS_AUCTIONDELETE:14,CS_AUCTIONOPEN:15,CS_AUCTIONSELL:16,CS_BANKRETRIEVE:17,CS_BANKSTORE:18,CS_CHAT:19,CS_COLOR_TINT:20,BI_BLOCK_MODIFY:21,CS_GOLD:22,CS_PARTY:23,BI_HARVEST:24,CS_HARVEST_ENTITY:25,CS_LOADLOOKS:26,CS_LOOKUPDATE:27,CS_LOOT:28,CS_MOVE:29,CS_MOVEPATH:30,CS_PLAYER_REVIVE:31,BI_SEND_BANK:34,BI_SEND_INVENTORY:35,CS_STATADD:36,CS_STOREBUY:37,CS_STOREENCHANT:38,CS_STOREREPAIR:39,CS_STORESELL:40,CS_TALKTONPC:41,CS_CRAFT:42,CS_TELEPORT_MAP:43,CS_WHO:44,CS_SKILL:45,CS_SKILLINSTALL:46,SC_ERROR:60,SC_WORLDS:61,SC_VERSION:62,SC_PLAYER_SUM:63,SC_PLAYER:64,SC_ACHIEVEMENT:65,SC_AUCTIONOPEN:66,SC_ITEMSLOT:67,SC_CHANGEPOINTS:68,SC_CHAT:69,SC_COLOR_TINT:70,SC_DAMAGE:71,SC_DESPAWN:72,SC_SWAPSPRITE:73,SC_APPEARANCE:74,SC_GOLD:75,SC_PARTY:76,BI_PLAYERINFO:77,SC_ITEMLEVELUP:78,SC_KILL:79,SC_LEVELUP:80,SC_LIST:81,SC_LOOKS:82,SC_LOG:83,SC_LOOKUPDATE:84,SC_MOVE:85,SC_MOVEPATH:86,SC_NOTIFY:87,SC_QUEST:88,SC_SKILLEFFECTS:89,SC_SKILLLOAD:90,SC_SPAWN:91,SC_SPEECH:92,SC_STATINFO:93,SC_TELEPORT_MAP:94,SC_SKILL_XP:95},Orientations:{NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4},EntityTypes:{NONE:0,PLAYER:1,MOB:2,ITEM:3,ITEMLOOT:4,NPCSTATIC:5,NPCMOVE:6,CHEST:7,BLOCK:8,TRAP:9,GATHER:10},Keys:{ENTER:13,UP:38,DOWN:40,LEFT:37,RIGHT:39,W:87,A:65,S:83,D:68,SPACE:32,I:73,H:72,M:77,P:80,T:84,Y:89,KEYPAD_4:100,KEYPAD_6:102,KEYPAD_8:104,KEYPAD_2:98,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57},Skills:{BLOODSUCKING:1,RECOVERHEALTH:2,HEALANDHEAL:3,AVOIDATTACK:4,ADDEXPERIENCE:5,ATTACKWITHBLOOD:6,CRITICALATTACK:7,CRITICALRATIO:8},PlayerClass:{FIGHTER:0,ARCHER:1,DEFENDER:2,MAGE:3},PlayerState:{Roaming:0,Moving:1,Following:2,Aggro:3,Hurting:4,GettingItems:5,FollowPlayer:6}};var EntityTypes=Types.EntityTypes;Types.expForLevel=[];Types.defenseExp=[];Types.attackExp=[];Types.moveExp=[];Types.skillExp=[];Types.weaponExp=[];Types.expForLevel[0]=0;Types.defenseExp[0]=0;Types.attackExp[0]=0;Types.moveExp[0]=0;Types.skillExp[0]=0;Types.weaponExp[0]=0;for(i=1;i<50;i++){var points=Math.floor(i*300*Math.pow(1.5,i/5));console.info("level_"+i+"="+points);Types.expForLevel[i]=points;Types.defenseExp[i]=points*10+50;Types.attackExp[i]=points*10+50;Types.moveExp[i]=points*5+20;Types.skillExp[i]=~~(points/1.5);Types.weaponExp[i]=points*10+50}Types.getLevel=function(exp){if(typeof exp=="undefined"||exp==0)return 1;for(var i=1;i<200;i++){if(exp<Types.expForLevel[i]){return i}}return 50};Types.getAttackLevel=function(exp){if(exp==0)return 1;for(var i=1;i<200;i++){if(exp<Types.attackExp[i]){return i}}return 50};Types.getDefenseLevel=function(exp){if(exp==0)return 1;for(var i=1;i<200;i++){if(exp<Types.defenseExp[i]){return i}}return 50};Types.getMoveLevel=function(exp){if(exp==0)return 1;for(var i=1;i<200;i++){if(exp<Types.moveExp[i]){return i}}return 50};Types.getWeaponLevel=function(exp){if(exp==0)return 1;for(var i=1;i<200;i++){if(exp<Types.weaponExp[i]){return i}}return 50};Types.getSkillLevel=function(exp,level){level=level||1;if(typeof exp=="undefined"||exp==0)return 1;for(var i=level;i<20;i++){if(exp<Types.skillExp[i]){return i}}return 20};Types.isPlayer=function(kind){if(kind===1||kind===222)return true;return false};Types.getOrientationAsString=function(orientation){switch(orientation){case Types.Orientations.LEFT:return"left";break;case Types.Orientations.RIGHT:return"right";break;case Types.Orientations.UP:return"up";break;case Types.Orientations.DOWN:return"down";break}};Types.getMessageTypeAsString=function(type){var typeName;_.each(Types.Messages,(function(value,name){if(value===type){typeName=name}}));if(!typeName){typeName="UNKNOWN"}return typeName};if(!(typeof exports==="undefined")){module.exports=Types}},{}],168:[function(require,module,exports){var ItemTypes={};var ItemData={};var KindData={};ItemTypes.setKindData=function(kindData){KindData=kindData;ItemTypes.KindData=kindData};ItemTypes.getData=function(k){var data=KindData[k];if(!data||data.legacy==1)return null;return data};ItemTypes.getName=function(kind){try{var item=KindData[kind];if(!item)return"";return item.name}catch(e){console.error("No name found for item: "+KindData[kind]);console.error("Error stack: "+e.stack)}};ItemTypes.getWeaponLevel=function(kind){try{var item=KindData[kind];if(!item)return 0;return item.modifier}catch(e){console.error("No level found for weapon: "+KindData[kind]);console.error("Error stack: "+e.stack)}};ItemTypes.getArmorLevel=function(kind){try{var item=KindData[kind];if(!item)return 0;return item.modifier}catch(e){console.error("No level found for armor: "+KindData[kind]);console.error("Error stack: "+e.stack)}};ItemTypes.getItemByLevel=function(type,level){for(var kind in KindData){var item=KindData[kind];if((item.type=="armor"||item.type=="armorarcher")&&item.type==type&&level==item.modifier){return item}if((item.type=="weapon"||item.type=="weaponarcher")&&item.type==type&&level==item.modifier){return item}}return null};ItemTypes.getLevelByKind=function(kind){var item=KindData[kind];if(ItemTypes.isArmor(kind)){return item.level}if(ItemTypes.isWeapon(kind)){return item.level}return null};ItemTypes.getType=function(kind){try{var item=KindData[kind];return item.type}catch(e){console.error("No type found for item: "+kind);console.error("Error stack: "+e.stack)}};ItemTypes.getBuyPrice=function(kind){var item=KindData[kind];if(!item)return 0;var type=item.type;if(type=="bow"){return Math.floor(item.modifier*item.modifier*10)}else if(type=="chest"){return Math.floor(item.modifier*item.modifier*10)}else if(ItemTypes.isArmor(kind)){return Math.floor(item.modifier*item.modifier*10)}else if(ItemTypes.isWeapon(kind)){return Math.floor(item.modifier*item.modifier*10)}else if(type=="object"&&item.buy>0){if(item.buyCount>1)return item.buy*item.buyCount;else return item.buy}return 0};ItemTypes.getCraftPrice=function(k){var item=KindData[k];if(!item||item.legacy==1)return 0;if(item.buy>0)return item.buy;return~~(ItemTypes.getBuyPrice(k)/4)};ItemTypes.getEnchantSellPrice=function(item){var value=ItemTypes.getBuyPrice(item.itemKind)/10;var enchantLevel=item.itemNumber;if(enchantLevel>1){value+=~~(ItemTypes.getEnchantPrice(item)/10)}value*=item.itemDurabilityMax/900;return Math.floor(value)};ItemTypes.getEnchantPrice=function(item){if(!item)return NaN;var data=KindData[item.itemKind];var enchantLevel=item.itemNumber+1;var curLevel=item.itemNumber;if(enchantLevel>=25)return NaN;experience=item.itemExperience;var baseLevel=data.modifier;console.info("getEnchantPrice: "+ItemTypes.itemExpForLevel[enchantLevel]);var cost=Math.floor(baseLevel*baseLevel*10*Math.pow(2,enchantLevel)*(1-experience/ItemTypes.itemExpForLevel[enchantLevel]));console.info("cost: "+cost);return cost};ItemTypes.getRepairPrice=function(item){var value=ItemTypes.getBuyPrice(item.itemKind)/10;var point=item.itemNumber;if(item.itemDurability==item.itemDurabilityMax)return 0;if(point>1){value+=Math.pow(1.8,point)}value*=item.itemDurability/item.itemDurabilityMax*(item.itemDurabilityMax/900)*item.itemNumber;return Math.floor(value)};ItemTypes.isEquippable=function(kind){if(ItemTypes.isArmor(kind)||ItemTypes.isWeapon(kind)||ItemTypes.isArcherWeapon(kind)||ItemTypes.isClothes(kind))return true;return false};ItemTypes.isClothes=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="helm"||item.type==="chest"||item.type==="gloves"||item.type==="boots"};ItemTypes.isArmor=function(kind){var item=KindData[kind];if(!item)return false;return ItemTypes.isClothes(kind)};ItemTypes.isWeapon=function(kind){var item=KindData[kind];if(!item)return false;return ItemTypes.isMeleeWeapon(kind)||ItemTypes.isArcherWeapon(kind)};ItemTypes.isEquipment=function(kind){var item=KindData[kind];if(!item)return false;return ItemTypes.isWeapon(kind)||ItemTypes.isArmor(kind)};ItemTypes.isMeleeWeapon=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="sword"||item.type==="hammer"||item.type==="axe"};ItemTypes.isHarvestWeapon=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="hammer"||item.type==="axe"};ItemTypes.isArcherWeapon=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="bow"};ItemTypes.isObject=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="object"};ItemTypes.isCraftItem=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="craft"};ItemTypes.isLootItem=function(kind){return kind>=1e3&&kind<2e3};ItemTypes.isConsumableItem=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="object"};ItemTypes.isHealingItem=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="object"&&(item.typemod=="health"||item.typemod=="healthpercent")};ItemTypes.isItem=function(kind){var item=ItemTypes.KindData[kind];if(!item)return false;return ItemTypes.isArmor(kind)||ItemTypes.isWeapon(kind)||item.type=="object"||item.type=="craft"};ItemTypes.forEachKind=function(callback){for(var k in kindData){callback(KindData[k],k)}};ItemTypes.forEachArmorKind=function(callback){Types.forEachKind((function(kind,kindName){if(ItemTypes.isArmor(kind)){callback(kind,kindName)}}))};ItemTypes.forEachWeaponKind=function(callback){Types.forEachKind((function(kind,kindName){if(ItemTypes.isWeapon(kind)){callback(kind,kindName)}}))};ItemTypes.forEachArcherWeaponKind=function(callback){Types.forEachKind((function(kind,kindName){if(ItemTypes.isArcherWeapon(kind)){callback(kind,kindName)}}))};ItemTypes.getItemListBy=function(itemType,minLevel,maxLevel){var ItemsList=[];for(var k in KindData){var item=KindData[k];if(!item||item.legacy==1)continue;if(itemType==4&&!(ItemTypes.isArmor(k)||ItemTypes.isWeapon(k))){ItemsList.push({name:item.name,kind:k,type:item.type,buyCount:item.buycount,buyPrice:item.buy,craftPrice:ItemTypes.getCraftPrice(k),itemKind:k,itemNumber:item.buycount,craft:item.craft})}if(itemType==1&&item.type=="object"&&item.buy>0){ItemsList.push({name:item.name,kind:k,type:item.type,buyCount:item.buycount,buyPrice:item.buy,craftPrice:ItemTypes.getCraftPrice(k),itemKind:k,itemNumber:item.buycount,craft:item.craft})}else if(itemType==2&&ItemTypes.isArmor(k)&&item.modifier>=minLevel&&item.modifier<=maxLevel){ItemsList.push({name:item.name,kind:k,type:item.type,buyCount:item.buyCount,buyPrice:ItemTypes.getBuyPrice(k),craftPrice:ItemTypes.getCraftPrice(k),rank:item.level,itemKind:k,itemNumber:item.buycount,craft:item.craft})}else if(itemType==3&&ItemTypes.isWeapon(k)&&item.modifier>=minLevel&&item.modifier<=maxLevel){ItemsList.push({name:item.name,kind:k,type:item.type,buyCount:item.buyCount,buyPrice:ItemTypes.getBuyPrice(k),craftPrice:ItemTypes.getCraftPrice(k),rank:item.level,itemKind:k,itemNumber:item.buycount,craft:item.craft})}}if(ItemsList.length>0&&ItemsList[0].rank>0)ItemsList.sort((function(a,b){return a.rank-b.rank}));return ItemsList};ItemTypes.Store={isBuy:function(id){var item=KindData[id];if(!item)return false;return item.buy>0?true:false},isBuyMultiple:function(id){var item=KindData[id];if(!item)return false;return item.buycount>0?true:false},isSell:function(id){var item=KindData[id];if(!item)return false;return item.buy>=2?true:false},getBuyCount:function(id){var item=KindData[id];if(!item)return false;return item.buyCount>1?item.buyCount:1},getItems:function(type,min,max){return ItemTypes.getItemListBy(type,min,max)}};ItemTypes.itemExpForLevel=[];ItemTypes.itemExpForLevel[0]=0;for(i=1;i<30;i++){var points=Math.floor(i*150*Math.pow(2,i/10));ItemTypes.itemExpForLevel[i]=points}ItemTypes.getItemLevel=function(exp){if(exp==0)return 1;var i=1;for(i=1;i<30;i++){if(exp>ItemTypes.itemExpForLevel[i-1]&&exp<=ItemTypes.itemExpForLevel[i]){return i}}return 30};if(!(typeof exports==="undefined")){module.exports=ItemTypes}},{}]},{},[107]);
