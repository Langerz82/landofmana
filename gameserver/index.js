(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){var cls=require("../lib/class");var Utils=require("../utils");module.exports=Area=cls.Class.extend({init:function(map,id,x,y,width,height,elipse,excludeId){this.id=id;var ts=G_TILESIZE;this.gx=x;this.gy=y;this.x=x*ts;this.y=y*ts;if(elipse){this.x+this.width/2;this.y+this.height/2}this.width=width*ts;this.height=height*ts;this.map=map;this.elipse=elipse||false;this.excludeId=excludeId||-1},_getRandomPosition:function(xandy,dist,threshold){threshold=threshold||30;var pos={};var valid=false;var count=0;var d=Math.min(dist.height,dist.width);while(count<threshold){if(!this.elipse){pos.x=xandy.x+Utils.randomInt(dist.width*2)-dist.width;pos.y=xandy.y+Utils.randomInt(dist.height*2)-dist.height}else{var a=Math.random()*2*Math.PI;var r=Utils.randomRangeInt(0,~~(d/2));pos.x=Math.round(xandy.x+r*Math.cos(a));pos.y=Math.round(xandy.y+r*Math.sin(a))}if(!this.contains(pos.x,pos.y,0)){count++;continue}if(this.map.isColliding(pos.x,pos.y)){count++;continue}else{break}count++}if(count>=threshold){return null}return pos},_getRandomPositionForEntity:function(entity,dist,threshold){return this._getRandomPosition(entity,{width:dist,height:dist},threshold)},_getRandomPositionInsideArea:function(threshold){return this._getRandomPosition(this,this,threshold)},contains:function(x,y,iteration){if(!this.elipse){return x>=this.x&&y>=this.y&&x<this.x+this.width&&y<this.y+this.height}else{var cx=this.x;var cy=this.y;var d=Math.sqrt(Math.pow(x-cx,2)+Math.pow(y-cy,2));var inElipse=d<this.width/2;if(iteration===1||this.excludeId===-1){return inElipse}else if(iteration===0){var res=inElipse;var prevArea=this.map.mobLiveAreas[this.elipseId];if(prevArea)res=res&&!prevArea.contains(x,y,1);return res}return false}}});module.exports=Area},{"../lib/class":44,"../utils":66}],2:[function(require,module,exports){var Utils=require("../utils");var Area=require("./area");var Checkpoint=Area.extend({init:function(map,id,x,y,width,height){this._super(map,id,x,y,width,height)},isValidPosition:function(x,y){return this.map&&this.map.isValidPosition(x,y)}});module.exports=Checkpoint},{"../utils":66,"./area":1}],3:[function(require,module,exports){var EntityArea=require("./entityarea"),_=require("underscore"),Messages=require("../message");module.exports=ChestArea=EntityArea.extend({init:function(map,id,elipse,nb,minLevel,maxLevel,x,y,width,height){this._super(map,id,x,y,width,height);this.nb=nb;this.minLevel=minLevel;this.maxLevel=maxLevel;this.respawns=[];this.map=map;this.setNumberOfEntities(this.nb);this.chests=[37]},spawnChests:function(){for(var i=0;i<this.nb;i+=1){this.addToArea(this._createRandomChestInsideArea())}},_createRandomChestInsideArea:function(){return this._createChest()},_createChest:function(){var self=this;var pos=self.map.entities.spaceEntityRandomApart(2,self._getRandomPositionInsideArea.bind(self,20));var Chest=require("./chest");var chest=new Chest(2e4+ ++self.map.entities.entityCount,pos.x,pos.y,self.map,self,self.minLevel,self.maxLevel);self.map.entities.addChest(chest);self.addToArea(chest);return chest},respawnChest:function(chest,delay){var self=this;delay=chest.spawnDelay||delay;this.removeFromArea(chest);setTimeout(function(){var pos=self.map.entities.spaceEntityRandomApart(2,self._getRandomPositionInsideArea.bind(self,20));chest.x=pos.x;chest.y=pos.y;self.addToArea(chest);self.map.entities.addChest(chest);self.map.entities.sendBroadcast(new Messages.Spawn(chest))},delay)}});module.exports=ChestArea},{"../message":49,"./chest":undefined,"./entityarea":4,underscore:310}],4:[function(require,module,exports){var Area=require("./area"),Utils=require("../utils");var EntityArea=Area.extend({init:function(map,id,x,y,width,height,elipse,excludeId){this._super(map,id,x,y,width,height,elipse,excludeId);this.entities=[];this.hasCompletelyRespawned=true},removeFromArea:function(entity){var i=_.indexOf(_.pluck(this.entities,"id"),entity.id);this.entities.splice(i,1);if(this.isEmpty()&&this.hasCompletelyRespawned&&this.emptyCallback){this.hasCompletelyRespawned=false;this.emptyCallback()}},onEmpty:function(callback){this.emptyCallback=callback},addToArea:function(entity){if(entity&&entity.kind!==null){this.entities.push(entity);entity.area=this}if(this.isFull()){this.hasCompletelyRespawned=true}},setNumberOfEntities:function(nb){this.nbEntities=nb},isEmpty:function(){return!_.any(this.entities,function(entity){return!entity.isDead})},isFull:function(){return!this.isEmpty()&&this.nbEntities===_.size(this.entities)},respawn:function(entity,delay){var self=this;delay=entity.spawnDelay||delay;this.removeFromArea(entity);setTimeout(function(){var pos=self.map.entities.spaceEntityRandomApart(2,self._getRandomPositionInsideArea.bind(self,20),self.entities);if(pos){entity.spawnX=pos.x;entity.spawnY=pos.y;entity.setPosition(pos.x,pos.y)}entity.respawn()},delay)}});module.exports=EntityArea},{"../utils":66,"./area":1}],5:[function(require,module,exports){var cls=require("../lib/class");var MapArea=cls.Class.extend({init:function(map,elipse,x,y,width,height){this.map=map;this.elipse=elipse;this.x=x*G_TILESIZE;this.y=y*G_TILESIZE;this.width=width*G_TILESIZE;this.height=height*G_TILESIZE},contains:function(entity){if(!elipse){if(entity){return entity.x>=this.x&&entity.y>=this.y&&entity.x<this.x+this.width&&entity.y<this.y+this.height}else{return false}}if(elipse){if(entity){var cx=this.x;var cy=this.y;var d=Math.sqrt(Math.pow(entity.x-cx,2)+Math.pow(entity.y-cy,2));var inElipse=d<this.width/2&&d<this.height/2;console.log("this.elipseId="+this.elipseId);return inElipse}else{return false}}}});module.exports=MapArea},{"../lib/class":44}],6:[function(require,module,exports){var EntityArea=require("./entityarea"),_=require("underscore"),Messages=require("../message");module.exports=MobArea=EntityArea.extend({init:function(map,id,nb,minLevel,maxLevel,x,y,width,height,include,exclude,definite,elipse,excludeId,level){this._super(map,id,x,y,width,height,elipse,excludeId);this.nb=nb;this.minLevel=minLevel;this.maxLevel=maxLevel;this.respawns=[];this.level=level;this.include=null;if(include){if(typeof include==="string"&&include.indexOf(",")>=0)this.include=include.split(",");else{this.include=[include]}}this.exclude=null;if(exclude){if(typeof exclude==="string"&&exclude.indexOf(",")>=0)this.exclude=exclude.split(",");else{this.exclude=[exclude]}}this.setNumberOfEntities(this.nb);this.definite=null;if(definite)this.definite=definite},addMobs:function(level){this.mobs=[];if(Array.isArray(this.definite)){for(var i of this.definite){this.mobs.push(MobData.Kinds[i])}return}if(level&&this.level){this.minLevel=level+this.minLevel;this.maxLevel=level+this.maxLevel}levelMobs=MobData.getByLevelRange(this.minLevel,this.maxLevel);this.mobs=this.mobs.concat(levelMobs);if(Array.isArray(this.include)){for(var i of this.include){this.mobs.push(MobData.Kinds[i])}}if(Array.isArray(this.exclude)){var i=this.mobs.length;while(--i>=0){for(var j of this.exclude){if(this.mobs[i].kind===j){this.mobs.splice(i,1);break}}}}},spawnMobs:function(){console.info("spawnMobs - nb: "+this.nb);for(var i=0;i<this.nb;++i){this.addToArea(this._createRandomMobInsideArea(),this.exclude)}},_createMob:function(kind){var self=this;var pos=self.map.entities.spaceEntityRandomApart(2,self._getRandomPositionInsideArea.bind(self,100));if(!pos)return null;var mob=self.map.entities.addMob(kind,pos.x,pos.y,this);return mob},_createRandomMobInsideArea:function(){var randomMob=0;var kind=0;if(!this.mobs||this.mobs.length===0)return null;if(this.mobs.length===1){return this._createMob(this.mobs[0].kind)}var mobRatio=[];var mobRatioTotal=0;var l=this.mobs.length;if(l===0){console.warn("mobs length === 0 aborting create.");return null}for(var i=0;i<l;++i){for(var j=0;j<this.mobs[i].spawnChance;++j){mobRatio[i*l+j]=this.mobs[i].kind}mobRatioTotal+=this.mobs[i].spawnChance}var kind=0;var randNum=Utils.randomInt(mobRatioTotal-1);var r=randNum;var sc=0;for(var i=0;i<this.mobs.length;++i){sc=this.mobs[i].spawnChance;if(r<=sc){kind=this.mobs[i].kind;break}r-=sc}if(kind===0){console.info("this.mobs="+JSON.stringify(this.mobs));console.warn("mob kind === 0 aborting create.");return null}return this._createMob(kind)},respawnMob:function(mob,delay){var self=this;delay=mob.spawnDelay||delay;var self_mob=mob;setTimeout(function(){var pos=self.map.entities.spaceEntityRandomApart(3,self._getRandomPositionInsideArea.bind(self,20));if(pos){self_mob.spawnX=pos.x;self_mob.spawnY=pos.y;self_mob.setPosition(pos.x,pos.y)}if(self_mob.respawnCallback){self_mob.respawnCallback()}},delay)},isNextTooEntity:function(entity,dist){dist=dist||G_TILESIZE;for(var en of this.entities){if(Math.abs(entity.x-en.x)<G_TILESIZE&&Math.abs(entity.y-en.y)<G_TILESIZE)return true}return false}})},{"../message":49,"./entityarea":4,underscore:310}],7:[function(require,module,exports){var Messages=require("../message"),Formulas=require("../formulas"),ChestArea=require("../area/chestarea");module.exports=MobCallback=Class.extend({init:function(){},setCallbacks:function(entity){entity.onRespawn(function(){this.respawn()});entity.onStep(function(x,y){return});entity.onRequestPath(function(x,y){var ignored=[this];if(this.target)ignored.push(this.target);var path=this.map.entities.findPath(this,x,y,ignored);if(path&&path.length===1)console.error(this.id+" "+JSON.stringify(path));if(path&&path.length>1){this.orientation=this.getOrientation([this.x,this.y],path[1]);var msg=new Messages.MovePath(this,path);this.map.entities.sendNeighbours(this,msg);return path}return null});entity.onStopPathing(function(x,y){if(!this.hasTarget())this.setAiState(mobState.IDLE);if(this.aiState===mobState.CHASING)this.mobAI.checkReturn(this,x,y)});entity.onStartPathing(function(){});entity.onAbortPathing(function(){msg=new Messages.Move(this,this.orientation,2,this.x,this.y);this.map.entities.sendNeighbours(this,msg);if(!this.target)this.setAiState(mobState.IDLE)});entity.onKilled(function(attacker,damage){if(attacker instanceof Player){attacker.skillHandler.setXPs();this.world.taskHandler.processEvent(attacker,PlayerEvent(EventType.DAMAGE,this,damage))}});entity.onDeath(function(attacker){if(attacker instanceof Player){this.world.taskHandler.processEvent(attacker,PlayerEvent(EventType.KILLMOB,this,1))}this.world.loot.handleDropItem(this,attacker)})}})},{"../area/chestarea":3,"../formulas":36,"../message":49}],8:[function(require,module,exports){module.exports=NpcMoveCallback=Class.extend({init:function(){},setCallbacks:function(entity){var self=entity;entity.onStep(function(entity,x,y){try{entity.map.entities.entitygrid[entity.y][entity.x]=0;entity.map.entities.entitygrid[y][x]=1}catch(e){console.info(e.stack);console.info(entity.x+","+entity.y+","+x+","+y);console.info(entity.id);console.info(entity.path);console.info(entity.step)}});entity.onRequestPath(function(x,y){var path=self.entity.map.entities.findPath(self.entity,x,y);if(path&&path.length>0){var msg=new Messages.MovePath(self.entity,path);self.entity.map.entities.sendNeighbours(self.entity,msg);return path}return null})}})},{}],9:[function(require,module,exports){module.exports=PlayerCallback=Class.extend({init:function(){},setCallbacks:function(entity){var self=this;var p=entity;this.player=entity;this.entities=p.map.entities;p.onStep(function(player,x,y){});p.onRequestPath(function(x,y){var p=this;return self.entities.findPath(p,x,y)});var attackFunc=function(p){p.packetHandler.processAttack()};var stopPathing=function(p,x,y){console.info("onStopPathing");if(self.entities.pathfinder.isPathTicksTooFast(p,p.fullpath,p.startMovePathTime)){console.error("path - isPathTicksTooFast = true.");p.resetMove(p.sx,p.sy);return}p.setPosition(x,y);p.sx=p.x;p.sy=p.y;console.info("p.x:"+p.x+",p.y="+p.y);attackFunc(p)};p.onStopPathing(function(x,y){console.info("onStopPathing");stopPathing(this,x,y)});p.onAbortPathing(function(x,y){console.info("onAbortPathing");stopPathing(this,x,y)});p.checkStopDanger=function(c,o){var res=false;if(c.ex===-1&&c.ey===-1){return false}else if(c.x===c.ex&&c.y===c.ey){return true}var x=c.x,y=c.y;if(o===Types.Orientations.LEFT&&c.x<c.ex){res=true}else if(o===Types.Orientations.RIGHT&&c.x>c.ex){res=true}else if(o===Types.Orientations.UP&&c.y<c.ey){res=true}else if(o===Types.Orientations.DOWN&&c.y>c.ey){res=true}if(res){c.setPosition(c.ex,c.ey);console.warn("WARN - PLAYER "+c.id+" not stopping.");console.warn("orientation: "+Utils.getOrientationString(o));console.warn("x :"+x+",y :"+y);console.warn("sx:"+c.ex+",sy:"+c.ey)}return res};p.checkStartMove=function(x,y){var p=this;var fnNotCorrectPos=function(x,y){var dx=Math.abs(p.x-x),dy=Math.abs(p.y-y);var tx=Math.trunc(p.x)-Math.trunc(x)===0;var ty=Math.trunc(p.y)-Math.trunc(y)===0;if(tx&&dy!==0||ty&&dx!==0){var path=[[p.x,p.y],[x,y]];if(!p.endMoveTime||!p.map.entities.pathfinder.isPathTicksTooFast(p,path,p.endMoveTime)){console.error("FIXED MOVE");p.fixMove(x,y);return true}}console.error("PLAYER NOT IN CORRECT POSITION");console.info("p.x:"+p.x+",p.y:"+p.y);console.info("c.x:"+x+",c.y:"+y);console.error("dx:"+dx+",dy:"+dy);p.resetMove(p.x,p.y);return false};if(!(p.x===x&&p.y===y)){return fnNotCorrectPos(x,y)}return true};p.correctMove=function(x,y){var p=this;if(!(p.ex===-1&&p.ey===-1)&&!(p.x===x&&p.y===y)){console.warn("ERROR - MOVING NOT SYNCHED PROPERLY, FORCING CLIENT UPDATE");console.info("player, orientation:"+p.moveOrientation);console.info("player, x:"+p.x+",y:"+p.y);console.info("player, sx:"+p.sx+",sy:"+p.sy);console.info("player, ex:"+p.ex+",ey:"+p.ey);p.resetMove(p.sx,p.sy)}};p.setMoveStopCallback(function(){var p=this;console.info("setMoveStopCallback");console.info("player, x:"+p.x+",y:"+p.y);p.checkStopDanger(p,p.moveOrientation);p.correctMove(p.ex,p.ey);p.endMoveTime=Date.now();attackFunc(p)});p.onTeleport(function(){p.forEachAttacker(function(entity){if(entity instanceof Mob){entity.returnToSpawn()}});p.clearAttackerRefs()});p.onKilled(function(attacker,damage){});p.onDeath(function(attacker){p.world.loot.handleDropItem(p,attacker)})}})},{}],10:[function(require,module,exports){cls=require("./lib/class");_=require("underscore");GameTypes=require("../shared/js/gametypes");ItemTypes=require("../shared/js/itemtypes");Types=GameTypes;Utils=require("./utils")},{"../shared/js/gametypes":349,"../shared/js/itemtypes":350,"./lib/class":44,"./utils":66,underscore:310}],11:[function(require,module,exports){var AppearancesJson=require("../../shared/data/appearance.json");var AppearanceData=[];var ItemGearTypes={weapon:[],weaponarcher:[],armor:[],armorarcher:[]};_.each(AppearancesJson,function(value,key){AppearanceData.push({name:value.name,type:value.type,sprite:value.sprite,buy:value.buy});if(ItemGearTypes[value.type]){ItemGearTypes[value.type].push({key:key,val:value})}});module.exports.ItemGearTypes=ItemGearTypes;module.exports.Data=AppearanceData;module.exports.getSpriteByID=function(id){return AppearanceData[id].sprite}},{"../../shared/data/appearance.json":333}],12:[function(require,module,exports){MobData=require("./mobdata");SkillData=require("./skilldata");ItemData=require("./itemdata");AppearanceData=require("./appearancedata");MobSpeechData=require("./mobspeechdata");ItemLootData=require("./itemlootdata");NpcData=require("./npcdata");LangData=require("./langdata");QuestData=require("./questdata");NotifyData=require("./notificationdata");EntitySpawnData=require("./entityspawndata")},{"./appearancedata":11,"./entityspawndata":13,"./itemdata":14,"./itemlootdata":15,"./langdata":16,"./mobdata":17,"./mobspeechdata":18,"./notificationdata":19,"./npcdata":20,"./questdata":21,"./skilldata":22}],13:[function(require,module,exports){var SpawnJson=require("../../shared/data/entity_spawn.json"),fs=require("fs");var EntitySpawnData=[];var i=0;_.each(SpawnJson,function(value,key){EntitySpawnData[i++]=value});var addSpawn=function(id,x,y){EntitySpawnData.push({id:id,x:x,y:y})};var saveSpawns=function(){fs.writeFile("./shared/data/entity_spawn.json",JSON.stringify(EntitySpawnData),function(err,data){if(err){return console.info(err)}})};module.exports.EntitySpawnData=EntitySpawnData;module.exports.addSpawn=addSpawn;module.exports.saveSpawns=saveSpawns},{"../../shared/data/entity_spawn.json":335,fs:undefined}],14:[function(require,module,exports){var _=require("underscore"),ItemsJson=require("../../shared/data/items2.json"),CraftData=require("../../shared/data/craft.json");var id=0;for(var craft of CraftData){craft.id=id++}var getCraftData=function(index){var data=[];for(var craft of CraftData){if(craft.o===index)data.push(craft)}return data};var KindData={};KindData[0]=null;_.each(ItemsJson,function(itemValue,key){KindData[itemValue.id]={name:itemValue.name,type:itemValue.type?itemValue.type:"object",damageType:itemValue.damageType?itemValue.damageType:"none",typemod:itemValue.typemod?itemValue.typemod:"none",modifier:itemValue.modifier?itemValue.modifier:0,hand:itemValue.hand?itemValue.hand:0,sprite:itemValue.sprite?itemValue.sprite:"",spriteName:itemValue.spriteName?itemValue.spriteName:"",offset:itemValue.offset?itemValue.offset:[0,0],buy:itemValue.buy?itemValue.buy:0,buycount:itemValue.buycount?itemValue.buycount:1,staticsheet:itemValue.staticsheet>0?itemValue.staticsheet:0,level:itemValue.level?itemValue.level:itemValue.modifier,legacy:itemValue.legacy?itemValue.legacy:0,craft:getCraftData(itemValue.id)}});ItemTypes.setKindData(KindData);module.exports.Kinds=KindData;module.exports.CraftData=CraftData},{"../../shared/data/craft.json":334,"../../shared/data/items2.json":337,underscore:310}],15:[function(require,module,exports){var _=require("underscore"),ItemLootJson=require("../../shared/data/itemloot.json");var ItemLoot=[];_.each(ItemLootJson,function(val,key){ItemLoot[key]={name:val.name,rarity:val.rarity,sprite:val.sprite,offset:val.offset,include:val.include?val.include:null}});module.exports.ItemLoot=ItemLoot},{"../../shared/data/itemloot.json":336,underscore:310}],16:[function(require,module,exports){var _=require("underscore"),LangJson=require("../../shared/data/lang.json");var LangData={};_.each(LangJson,function(val,key){LangData[key]=val});module.exports.Data=LangData},{"../../shared/data/lang.json":338,underscore:310}],17:[function(require,module,exports){var _=require("underscore"),Mobs=require("../../shared/data/mobs.json");var Properties={};var Kinds={};_.each(Mobs,function(value,key){var mob=Properties[key.toLowerCase()]={key:key.toLowerCase(),kind:value.kind,attackMod:value.attackMod?value.attackMod:1,defenseMod:value.defenseMod?value.defenseMod:1,attackRateMod:value.attackRateMod?1/value.attackRateMod:1,hpMod:value.hpMod?value.hpMod:1,attack:value.attackMod?value.attackMod*3:3,defense:value.defenseMod?value.defenseMod*3:3,hp:value.hpMod?value.hpMod*150:150,xp:value.xpMod?value.xpMod*10:10,minLevel:value.minLevel?value.minLevel:1,maxLevel:value.maxLevel?value.maxLevel:99,aggroRange:value.aggroRange?value.aggroRange+1:4,attackRange:value.attackRange?value.attackRange:1,isAggressive:value.isAggressive===1?true:false,attackRate:value.attackRateMod?value.attackRateMod*1500:1500,reactionDelay:value.reactionMod?value.reactionMod*256:256,moveSpeed:value.moveSpeedMod?~~(300+200*value.moveSpeedMod):500,respawn:value.respawnMod?value.respawnMod*3e4:3e4,dropRate:value.dropRate?value.dropRate:1,spawnChance:value.spawnChance?value.spawnChance:50,dropBonus:value.dropBonus?value.dropBonus:0,drops:value.drops?value.drops:null,modDamage:{hammer:1,axe:1,sword:1,bow:.9}};if(value.modDamage)Object.assign(mob.modDamage,value.modDamage);Kinds[value.kind]=mob});var isMob=function(kind){return Kinds[kind]?true:false};var forEachMobKind=function(callback){for(var k in MobKinds){callback(MobKinds[k][0],k)}};var getByLevelRange=function(min,max){levelRange=[];for(var k in Kinds){var mobKind=Kinds[k];if(mobKind.level>0&&mobKind.level>=min&&mobKind.level<=max)levelRange.push(mobKind);else if(mobKind.minLevel>0&&mobKind.maxLevel>0&&(min>=mobKind.minLevel&&min<=mobKind.maxLevel||max>=mobKind.minLevel&&max<=mobKind.maxLevel))levelRange.push(mobKind)}return levelRange};module.exports.Properties=Properties;module.exports.Kinds=Kinds;module.exports.isMob=isMob;module.exports.forEachMobKind=forEachMobKind;module.exports.getByLevelRange=getByLevelRange},{"../../shared/data/mobs.json":339,underscore:310}],18:[function(require,module,exports){var _=require("underscore"),MobSpeech=require("../../shared/data/mobs_speech.json");var speech={};_.each(MobSpeech,function(value,key){speech[key]=value});module.exports.Speech=speech},{"../../shared/data/mobs_speech.json":340,underscore:310}],19:[function(require,module,exports){var _=require("underscore"),NotifyJSON=require("../../shared/data/notifications.json");var Notifications={};var i=0;_.each(NotifyJSON,function(value,key){Notifications[i++]={textid:value.textid,interval:value.interval}});module.exports.Notifications=Notifications},{"../../shared/data/notifications.json":341,underscore:310}],20:[function(require,module,exports){var _=require("underscore"),NPCsJSON=require("../../shared/data/npcs.json"),NPCspeak=require("../../shared/data/npc_english.json"),NPCnames=require("../../shared/data/npc_names_eng.json");var Properties={};var Kinds=NPCsJSON;_.each(Kinds,function(value,key){Properties[value.uid]={uid:value.uid,kind:key,name:value.name?value.name:value.uid}});var isNpc=function(kind){return Kinds[kind]?true:false};module.exports.Properties=Properties;module.exports.Kinds=Kinds;module.exports.isNpc=isNpc;module.exports.NPCnames=NPCnames},{"../../shared/data/npc_english.json":342,"../../shared/data/npc_names_eng.json":344,"../../shared/data/npcs.json":345,underscore:310}],21:[function(require,module,exports){var Utils=require("../utils"),Quest=require("../quest"),QuestsJson=require("../../shared/data/quests.json");var QuestData={};var QuestNpcData={};for(var id in QuestsJson){var data=QuestsJson[id];console.info("data:"+JSON.stringify(data));var quest={};quest.id=id;quest.npcQuestId=data.npcKind;quest.raw=data;quest.npcKind=data.npcKind;quest.type=data.type;quest.level=data.level;quest.data1=data.data1||0;quest.data2=data.data2||0;quest.count=0;quest.status=0;quest.gold=data.gold||0;quest.reward=data.reward||[];quest.expMultiplier=data.expMultiplier||1;if(data.object){quest.object=getQuestObject([data.object.type,data.object.kind,data.object.count||0,data.object.chance||0,data.object.level||[0,99]])}if(data.object2){quest.object2=getQuestObject([data.object2.type,data.object2.kind,data.object2.count||0,data.object2.chance||0,data.object2.level||[0,99]])}var questObject=Object.assign(new Quest,quest);questObject.data=quest;QuestData[quest.id]=questObject;if(!QuestNpcData[quest.npcKind])QuestNpcData[quest.npcKind]=[];QuestNpcData[quest.npcKind].push(questObject)}console.info(JSON.stringify(QuestNpcData));module.exports.Data=QuestData;module.exports.NpcData=QuestNpcData},{"../../shared/data/quests.json":346,"../quest":58,"../utils":66}],22:[function(require,module,exports){var SkillsJSON=require("../../shared/data/skills2.json"),EffectHandler=require("../effecthandler");var Skills=[];var getSkillEffects=function(data){var effects=[];for(var rec of data){effects.push(new EffectType(rec[0]==="target",rec[1],rec[2],rec[3]))}return effects};var i=0;for(var index in SkillsJSON){var value=SkillsJSON[index];console.info(index+"="+JSON.stringify(value));Skills.push({skillType:value.skillType,targetType:value.targetType?value.targetType:0,duration:value.duration?value.duration:0,durationPL:value.durationPL?value.durationPL:0,recharge:value.recharge?value.recharge*1e3:0,aoe:value.aoe?value.aoe:0,countTotal:value.countTotal?value.countTotal:0,effectTypes:getSkillEffects(value.effects)})}console.info("skills: "+JSON.stringify(Skills));module.exports.Skills=Skills},{"../../shared/data/skills2.json":347,"../effecthandler":23}],23:[function(require,module,exports){EffectType=cls.Class.extend({init:function(isTarget,phase,stat,modValue){this.entity=null;this.isTarget=isTarget;this.phase=phase;this.stat=stat;this.modValue=parseFloat(modValue)||0;this.active=false},apply:function(skillEffect,target,phase,damage){if(target.isDead)return;if(this.phase!=phase)return;var val1=0,val2=0,statmax=0;var runModDiff=true;switch(this.stat){case"hp":val1=target.stats.hp;statmax=val2=target.stats.hpMax;break;case"ep":val1=target.stats.ep;statmax=val2=target.stats.epMax;break;case"attack":val2=val1=target.stats.attack;break;case"defense":val2=val1=target.stats.defense;break;case"damage":val1=0;val2=damage;break;default:runModDiff=false;break}if(runModDiff)this.diff=this.getModDiff(skillEffect,val1,val2,statmax);switch(this.stat){case"hp":target.modHealthBy(this.diff);break;case"ep":target.stats.ep+=this.diff;target.stats.ep=Utils.clamp(0,target.stats.epMax,target.stats.ep);break;case"attack":target.stats.mod.attack=this.diff;break;case"defense":target.stats.mod.defense=this.diff;break;case"damage":target.stats.mod.damage=this.diff;break;case"freeze":if(this.modVal===1)target.freeze=true;else{target.freeze=false}break;case"slow":target.moveSpeed+=this.modVal;break}return},getModDiff:function(skillEffect,stat,statmod,statmax){var diff=this.modValue*skillEffect.level;if(this.modValue<1){if(statmax>0)diff=Math.round(diff*statmax);else diff=Math.round(diff*stat)}else{diff=Math.round(diff)}if(stat===0)return diff;if(diff>0){if(statmax>0){if(stat+diff>statmax)diff=statmax-stat}}else if(diff<0){if(stat+diff<0)diff=-stat}return diff}});var SkillEffect=cls.Class.extend({init:function(handler,skillId,skillLevel){this.handler=handler;this.source=handler.entity;this.skillId=skillId;this.data=SkillData.Skills[skillId];console.info("SkillEffect - skillId:"+skillId);this.targetType=this.data.targetType;this.activeTimer=0;this.duration=(this.data.durationPL?this.data.durationPL*this.level:this.data.duration)||0;this.duration*=1e3;this.countTotal=this.data.countTotal||0;this.count=0;this.effectTypes=this.data.effectTypes;this.level=skillLevel;this.interval=null;this.targets=[]},getTargets:function(target,x,y){switch(this.targetType){case"self":return[this.source];case"enemy":return[target];case"ally":return[target];case"ally_aoe":var arr=target.map.entities.getPlayerAround(target,this.data.aoe);arr.unshift(this.source);return arr;case"enemy_aoe":var arr=target.map.entities.getMobsAround(target,this.data.aoe);arr.unshift(target);return arr}return[]},apply:function(target,targetX,targetY){var self=this;if(this.duration>0){this.activeTimer=0;if(this.interval){clearInterval(this.interval);this.interval=null}this.interval=setInterval(function(){if(self.activeTimer>self.duration){self.applyEffects("end",0);clearInterval(self.interval);self.interval=null}else{self.applyEffects("interval",0);self.activeTimer+=2e3}},2e3)}if(this.countTotal>0)this.count=0;this.targets=this.getTargets(target,targetX,targetY);this.applyEffects("start",0)},applyEffect:function(effect,target,phase,damage){var index=target.activeEffects.indexOf(this);if(index<0){target.activeEffects.push(this)}effect.apply(this,target,phase,damage);if(index>=0&&phase==="end"){target.activeEffects.splice(index,1)}},applyEffects:function(phase,damage){for(var effect of this.effectTypes){if(effect.phase===phase){if(effect.isTarget){for(var target of this.targets){this.applyEffect(effect,target,phase,damage)}}else{this.applyEffect(effect,this.source,phase,damage)}}}if(phase==="end"){this.count=0;this.activeTimer=0;this.handler.removeSkillEffect(this)}},endEffects:function(){for(var target of this.targets){for(var self of target.activeEffects){for(var effect of self.effectTypes)effect.apply(self,target,"end",0)}target.activeEffects=[]}},onInterval:function(phase,damage){if(this.duration!=0)return;this.applyEffects(phase,damage);if(phase=="afterhit"&&this.countTotal>0&&this.count===this.countTotal){this.applyEffects("end",0);this.count=0;return}if(phase=="onhit"&&this.countTotal>0){this.count++}}});var SkillEffectHandler=cls.Class.extend({init:function(entity){this.entity=entity;this.skills=entity.skills;this.skillEffects=[]},interval:function(phase,damage){damage=damage||0;for(var skillEffect of this.entity.activeEffects)skillEffect.onInterval(phase,damage)},cast:function(skillId,target,x,y){var skill=this.skills[skillId];var skillLevel=skill.skillLevel;var skillEffect=new SkillEffect(this,skillId,skillLevel);this.skillEffects.push(skillEffect);skill.xp(1);skillEffect.level=skill.skillLevel;skillEffect.apply(target,x,y)},removeSkillEffect:function(skillEffect){var index=this.skillEffects.indexOf(skillEffect);if(index>=0)this.skillEffects.splice(index,1)}});module.exports=EffectType;module.exports=SkillEffect;module.exports=SkillEffectHandler},{}],24:[function(require,module,exports){var EntityMoving=require("./entitymoving"),Messages=require("../message"),Timer=require("../timer"),Transition=require("../transition");module.exports=Character=EntityMoving.extend({init:function(id,type,kind,x,y,map){var self=this;this._super(id,type,kind,x,y,map);this.nextX=-1;this.nextY=-1;this.prevX=-1;this.prevY=-1;this.atkSpeed=100;this.moveSpeed=100;this.setMoveRate(this.moveSpeed);this.walkSpeed=150;this.idleSpeed=Utils.randomInt(750,1e3);this.setAttackRate(1024);this.target=null;this.unconfirmedTarget=null;this.attackers={};this.isDead=false;this.attackingMode=false;this.followingMode=false;this.engagingPC=false;this.observeTimer=new Timer(4096);this.step=0;this.orientation=this.setRandomOrientation();this.movement=new Transition(this);this.path=null;this.newDestination=null;this.adjacentTiles={};this.stats={};this.stats.hp=0;this.stats.hpMax=0;this.stats.ep=0;this.stats.epMax=0;this.attackCooldown=null;this.moveCooldown=null;this.attackerLevel=0;this.defenderLevel=0;this.moveLevel=0;this.armor=null;this.weapon=null;this.freeze=false;this.activeEffects=[];this.effects={};this.invincible=false;this.mod={accuracy:1,damage:1,defence:1,attack:1,attackTime:1,crit:1,dot:0,dr:0,time:0,daze:0,hate:0};this.neighboursUpdated=false},hit:function(orientation){this.setOrientation(orientation);this.stop()},onAggro:function(callback){this.aggro_callback=callback},onCheckAggro:function(callback){this.checkaggro_callback=callback},checkAggro:function(){if(this.checkaggro_callback){this.checkaggro_callback()}},aggro:function(character){if(this.aggro_callback){this.aggro_callback(character)}},onDeath:function(callback){this.death_callback=callback},hurt:function(){var self=this;this.stopHurting();this.sprite=this.hurtSprite;this.hurting=setTimeout(this.stopHurting.bind(this),75)},stopHurting:function(){this.sprite=this.normalSprite;clearTimeout(this.hurting)},engage:function(character){this.attackingMode=true;this.setTarget(character)},disengage:function(){this.attackingMode=false;this.followingMode=false;this.removeTarget()},isAttacking:function(){return this.attackingMode},isAttackedBy:function(character){if(Object.keys(this.attackers).length===0){return false}return this.attackers.hasOwnProperty(character.id)&&this.attackers[character.id]===character},isAttacked:function(){return!(Object.keys(this.attackers).length===0)},addAttacker:function(character){if(!this.isAttackedBy(character)){this.attackers[character.id]=character}},removeAttacker:function(character){if(!this.isAttacked()){return}delete this.attackers[character.id]},removeAttackers:function(){this.attackers={}},clearAttackerRefs:function(){var self=this;this.forEachAttacker(function(c){c.removeAttacker(self)})},forEachAttacker:function(callback){_.each(this.attackers,function(attacker){callback(attacker)})},waitToAttack:function(character){this.unconfirmedTarget=character},isWaitingToAttack:function(character){return this.unconfirmedTarget===character},canAttack:function(){if(this.isDead===false&&this.attackCooldown.isOver()){return true}return false},setAttackRate:function(rate){this.attackCooldown=new Timer(rate)},createAttackLink:function(target){if(this.hasTarget()){this.removeTarget()}this.setTarget(target);target.addAttacker(this);this.addAttacker(target)},removeTarget:function(){var self=this;if(this.target){if(this.target instanceof Character){this.target.removeAttacker(this)}if(this.removetarget_callback)this.removetarget_callback(this.target.id);this.target=null}},onRemoveTarget:function(callback){this.removetarget_callback=callback},hasTarget:function(){return!(this.target===null)},canInteract:function(entity){return this.isInReach(entity.x,entity.y)},canReach:function(entity){var ts=G_TILESIZE;if(this.attackRange===1)return this.isInReach(entity.x,entity.y,this.orientation);if(this.attackRange>1){var range=~~(Utils.realDistance([entity.x,entity.y],[this.x,this.y])/G_TILESIZE);return range<=this.attackRange}return false},clearTarget:function(){this.target=null},setTarget:function(character){if(character===null){this.removeTarget();return}if(this.target!==character){if(this.hasTarget()){this.removeTarget()}this.unconfirmedTarget=null;this.target=character;if(this.settarget_callback){var targetName=this.target.spriteName;if(MobData.Kinds[character.kind]&&targetName)this.settarget_callback(character,targetName,character.level)}}else{console.info(character.id+" is already the target of "+this.id)}},lookAt:function(target){if(target){this.orientation=this.getOrientationTo(target)}},clearTarget:function(){this.target=null},die:function(attacker){var self=this;console.warn("CHARACTER DIED!!!!!!!!!!!!!!!!!!!!!");this.forceStop();this.removeTarget();this.isDead=true;this.freeze=true;this.removeAttackers();this.endEffects();if(this.death_callback){this.death_callback(attacker)}},endEffects:function(){for(var skilleffect of this.activeEffects){skilleffect.endEffects()}this.activeEffects=[]},resetHP:function(){var max=typeof this.getHPMax==="function"?this.getHPMax():this.stats.hpMax;this.stats.hpMax=max;var diff=max-this.stats.hp;this.stats.hp=max;msg=new Messages.ChangePoints(this,diff,0);this.map.entities.sendNeighbours(this,msg)},resetEP:function(){var max=typeof this.getEPMax==="function"?this.getEPMax():this.stats.epMax;this.stats.epMax=max;this.stats.ep=max},setHP:function(val){val=val||typeof this.getHPMax==="function"?this.getHPMax():this.stats.hpMax;this.stats.hp=val},setEP:function(val){val=val||typeof this.getEPMax==="function"?this.getEPMax():this.stats.epMax;this.stats.ep=val},setHPMax:function(val){val=val||typeof this.getHPMax==="function"?this.getHPMax():this.stats.hpMax;this.stats.hpMax=val},setEPMax:function(val){val=val||typeof this.getEPMax==="function"?this.getEPMax():this.stats.epMax;this.stats.epMax=val},onDamage:function(attacker,hpMod,epMod,crit,effects){hpMod=hpMod||0;epMod=epMod||0;crit=crit||0;effects=effects||0;if(this.invincible)return;var prevHP=this.stats.hp;if(hpMod>0)this.addAttacker(attacker);if(hpMod!==0)this.stats.hp=Utils.clamp(0,this.stats.hpMax,this.stats.hp-hpMod);if(epMod!==0)this.stats.ep=Utils.clamp(0,this.stats.epMax,this.stats.ep-epMod);var msg=new Messages.Damage([attacker,this,-hpMod,-epMod,crit,effects]);this.map.entities.sendNeighbours(attacker,msg)},canMove:function(){if(this.isDead===false&&this.moveCooldown.isOver()){return true}return false},modHealthBy:function(val){var hp=this.stats.hp,max=this.stats.hpMax;this.stats.hp=Utils.clamp(0,max,hp+val);return this.changePoints(val,0)},modEnergyBy:function(val){var ep=this.stats.ep,max=this.stats.epMax;this.stats.ep=Utils.clamp(0,max,ep+val);return this.changePoints(0,val)},hasFullHealth:function(){return this.stats.hp===this.stats.hpMax},hasFullEnergy:function(){return this.stats.ep===this.stats.epMax},changePoints:function(modhp,modep){return new Messages.ChangePoints(this,modhp,modep)},setMaxHpMax:function(hp){this.stats.hpMax=hp;this.stats.hp=hp},setAttackRange:function(range){this.attackRange=range*G_TILESIZE},clean:function(){this.forEachAttacker(function(attacker){attacker.disengage();attacker.idle()})},onRemove:function(callback){this.remove_callback=callback},getClosestSpot:function(dest,adjStart,adjEnd){adjStart=adjStart||1;adjEnd=adjEnd||1;var poss=this.getSpotsAroundFrom(dest,adjStart,adjEnd);var sx=this.x,sy=this.y;for(var p of poss){if(this.map.isColliding(p.x,p.y))poss.splice(poss.indexOf(p),1)}var entities=this.map.entities.getCharactersAround(dest,adjEnd);var ts=G_TILESIZE;var tsh=ts>>1;var x,y,tx,ty;for(var p of poss){x=p.x;y=p.y;for(var e2 of entities){if(!e2||this===e2)continue;tx=e2.x;ty=e2.y;if(e2.isMovingPath()){var tp=e2.getLastMove();if(tp){tx=tp[0];ty=tp[1]}}if(Math.abs(x-tx)<=tsh&&Math.abs(y-ty)<=tsh){poss.splice(poss.indexOf(p),1)}}}if(poss.length===0)return null;poss.sort(function(a,b){return a.d-b.d});return{x:poss[0].x,y:poss[0].y}},followAttack:function(entity){var found=false;var spot=this.getClosestSpot(entity,1,this.attackRange);if(spot&&spot.x&&spot.y)this.moveTo_(spot.x,spot.y)},isAlive:function(){return!this.isDead}});module.exports=Character},{"../message":49,"../timer":60,"../transition":61,"./entitymoving":27}],25:[function(require,module,exports){var Item=require("./item");var Chest=Item.extend({init:function(id,x,y,map,area,minLevel,maxLevel){this._super(id,Types.EntityTypes.CHEST,x,y);this.map=map;this.level=Utils.randomRangeInt(minLevel,maxLevel);this.setDrops();this.area=area;this.spawnDelay=3e4},handleRespawn:function(){var self=this;this.droppedItem=false;if(this.area&&this.area instanceof ChestArea){this.area.respawnChest(this,this.spawnDelay)}},setDrops:function(){this.drops={};var dropLevel=Math.ceil(this.level/10)*10;for(var itemId in ItemData.Kinds){var item=ItemData.Kinds[itemId];if(!item)continue;if(item.typemod=="attack"||item.typemod=="defense"){switch(dropLevel){case item.modifier+10:this.drops[itemId]=20;break;case item.modifier:this.drops[itemId]=10;break;case item.modifier-10:this.drops[itemId]=5;break;case item.modifier-20:this.drops[itemId]=2;break}}if(item.typemod=="craft"){switch(dropLevel){case item.modifier+10:this.drops[itemId]=400;break;case item.modifier:this.drops[itemId]=200;break;case item.modifier-10:this.drops[itemId]=100;break;case item.modifier-20:this.drops[itemId]=50;break}}}}});module.exports=Chest},{"./item":28}],26:[function(require,module,exports){var Messages=require("../message");module.exports=Entity=cls.Class.extend({init:function(id,type,kind,x,y,map){var self=this;this.type=type;this.id=id;this.kind=kind;this.map=map;this.mapIndex=map.index;this.shadowOffsetY=0;this.isLoaded=false;this.isHighlighted=false;this.visible=true;this.isFading=false;this.prevX=0;this.prevY=0;this.prevOrientation=null;this.name="";this.nameOffsetY=-10;this.isCritical=false;this.isHeal=false;this.shadowOffsetY=0;this.setPosition(Number(x),Number(y));this.orientation=Utils.randomOrientation()},setName:function(name){this.name=name},setPosition:function(x,y){var ts=G_TILESIZE;this.x=x;this.y=y;var gx=x>>4;var gy=y>>4;if(typeof this.gx==="undefined")this.gx=gx;if(typeof this.gy==="undefined")this.gy=gy;if(x%ts===0)this.gx=gx;if(y%ts===0)this.gy=gy;var spx=~~(gx/G_SPATIAL_SIZE);var spy=~~(gy/G_SPATIAL_SIZE);if(!this.hasOwnProperty("spx"))this.spx=spx;if(!this.hasOwnProperty("spy"))this.spy=spy;if(!this.hasOwnProperty("spatialMap"))this.spatialMap=this.map;var sameMap=this.spatialMap===this.map;if(!sameMap){var spatial=this.spatialMap.entities.spatial[this.spy][this.spx];Utils.removeFromArray(spatial,this)}else{if(this.spx!==spx||this.spy!==spy){var spatial=this.map.entities.spatial[this.spy][this.spx];Utils.removeFromArray(spatial,this)}else{var spatial=this.map.entities.spatial[spy][spx];if(!spatial.includes(this))spatial.push(this)}}this.spx=spx;this.spy=spy;this.spatialMap=this.map},ready:function(f){this.ready_func=f},clean:function(){},log_info:function(message){console.info("["+this.id+"] "+message)},log_error:function(message){console.error("["+this.id+"] "+message)},getDistanceToEntity:function(entity){var distX=Math.abs(entity.x-this.x),distY=Math.abs(entity.y-this.y);return distX>distY?distX:distY},isAdjacent:function(entity){var adjacent=false;if(entity){adjacent=this.getDistanceToEntity(entity)>1?false:true}return adjacent},isAdjacentNonDiagonal:function(entity){var result=false;if(this.isAdjacent(entity)&&!(this.x!==entity.x&&this.y!==entity.y)){result=true}return result},isDiagonallyAdjacent:function(entity){return this.isAdjacent(entity)&&!this.isAdjacentNonDiagonal(entity)},forEachAdjacentNonDiagonalPosition:function(callback){callback(this.x-1,this.y,Types.Orientations.LEFT);callback(this.x,this.y-1,Types.Orientations.UP);callback(this.x+1,this.y,Types.Orientations.RIGHT);callback(this.x,this.y+1,Types.Orientations.DOWN)},_getBaseState:function(){return[parseInt(this.id,10),parseInt(this.type),parseInt(this.kind),this.name,parseInt(this.map.index),parseInt(this.x),parseInt(this.y),parseInt(this.orientation||0)]},getMapIndex:function(){return this.map.index},getState:function(){return this._getBaseState()},spawn:function(){return new Messages.Spawn(this)},despawn:function(){return new Messages.Despawn(this)},getPositionNextTo:function(entity){var pos=null;if(entity){pos={};var r=Utils.random(4);pos.x=entity.x;pos.y=entity.y;if(r===0){pos.y-=16}if(r===1){pos.y+=16}if(r===2){pos.x-=16}if(r===3){pos.x+=16}}return pos},setRandomOrientation:function(){r=Utils.random(4);if(r===0)this.orientation=Types.Orientations.LEFT;if(r===1)this.orientation=Types.Orientations.RIGHT;if(r===2)this.orientation=Types.Orientations.UP;if(r===3)this.orientation=Types.Orientations.DOWN},isWithinDist:function(x,y,dist){dist=dist||G_TILESIZE;var dx=Math.abs(this.x-x);var dy=Math.abs(this.y-y);return dx<=dist&&dy<=dist},isWithinDistEntity:function(entity,dist){return this.isWithinDist(entity.x,entity.y,dist)},isNextTooEntity:function(entity){return this.isWithinDist(entity.x,entity.y,G_TILESIZE)},isNextTooPosition:function(x,y){return this.isWithinDist(x,y,G_TILESIZE)},isOverEntity:function(entity){return this.isWithinDist(entity.x,entity.y,G_TILESIZE>>1)},isOverPosition:function(x,y){return this.isWithinDist(x,y,G_TILESIZE>>1)},isOverlappingEntity:function(entity){return this.isWithinDist(entity.x,entity.y,G_TILESIZE-1)},getSpriteName:function(spriteNum){return AppearanceData.getSpriteByID(spriteNum)},destroy:function(){}});module.exports=Entity},{"../message":49}],27:[function(require,module,exports){var Entity=require("./entity"),Messages=require("../message"),Timer=require("../timer"),Transition=require("../transition");module.exports=EntityMoving=Entity.extend({init:function(id,type,kind,x,y,map){var self=this;this._super(id,type,kind,x,y,map);this.nextX=-1;this.nextY=-1;this.prevX=-1;this.prevY=-1;this.moveSpeed=100;this.setMoveRate(this.moveSpeed);this.walkSpeed=150;this.idleSpeed=Utils.randomInt(750,1e3);this.followingMode=false;this.engagingPC=false;this.step=0;this.orientation=this.setRandomOrientation();this.movement=new Transition;this.path=null;this.newDestination=null;this.adjacentTiles={};this.moveCooldown=null;this.freeze=false},setOrientation:function(orientation){if(orientation){this.orientation=orientation||0}},idle:function(orientation){this.setOrientation(orientation)},walk:function(orientation){this.setOrientation(orientation)},getOrientationTo:function(character){if(this.x<character.x){return Types.Orientations.RIGHT}else if(this.x>character.x){return Types.Orientations.LEFT}else if(this.y>character.y){return Types.Orientations.UP}else{return Types.Orientations.DOWN}},isFacing:function(x,y){var dx=this.x-x;var dy=this.y-y;switch(this.orientation){case 1:return dy>0;case 2:return dy<0;case 3:return dx>0;case 4:return dx<0}return false},isFacingEntity:function(entity){return this.isFacing(entity.x,entity.y)},getOrientationTo:function(object){return this.getOrientation([this.x,this.y],[object.x,object.y])},getOrientation:function(p1,p2){var x=Math.abs(p1[0]-p2[0]);var y=Math.abs(p1[1]-p2[1]);if(x>y){if(p1[0]>p2[0])return Types.Orientations.LEFT;else return Types.Orientations.RIGHT}else if(y>x){if(p1[1]>p2[1])return Types.Orientations.UP;else return Types.Orientations.DOWN}return Types.Orientations.NONE},isInReach:function(x,y,o,r,rs){var o=o||this.orientation;var ts=G_TILESIZE;var rs=rs||ts>>1;var r=r||ts+rs;var a=rs,b=rs;switch(o){case Types.Orientations.UP:case Types.Orientations.DOWN:b=r;break;case Types.Orientations.LEFT:case Types.Orientations.RIGHT:a=r;break;case Types.Orientations.NONE:return false}return Math.abs(this.x-x)<=a&&Math.abs(this.y-y)<=b},lookAt:function(x,y){this.orientation=this.getOrientationTo([x,y]);this.idle(this.orientation);return this.orientation},lookAtEntity:function(entity){if(entity){this.orientation=this.getOrientationTo(entity)}return this.orientation},lookAtTile:function(x,y){var tsh=G_TILESIZE>>1;var pos=Utils.getGridPosition(x,y);pos=Utils.getPositionFromGrid(pos.gx,pos.gy);this.lookAt(pos.x+tsh,pos.y+tsh)},moveTo_:function(x,y,callback){return this._moveTo(x,y,callback)},_moveTo:function(x,y,callback){this.destination={x:x,y:y};this.adjacentTiles={};if(this.isMovingPath()){this.continueTo(x,y)}else{var path=this.requestPathfindingTo(x,y);if(path)this.followPath(path)}},requestPathfindingTo:function(x,y){if(Array.isArray(this.path)&&this.path.length>0){return this.path}else if(this.request_path_callback){return this.request_path_callback(x,y)}else{console.info(this.id+" couldn't request pathfinding to "+x+", "+y);console.info("char x:"+this.x+",y: "+this.y+", x:"+x+"y: "+y);try{throw new Error}catch(e){console.info(e.stack)}return null}},onRequestPath:function(callback){this.request_path_callback=callback},onStartPathing:function(callback){this.start_pathing_callback=callback},onStopPathing:function(callback){this.stop_pathing_callback=callback},onAbortPathing:function(callback){this.abort_pathing_callback=callback},followPath:function(path){if(!path)return;this.path=path;this.step=0;if(this.followingMode){path.pop()}if(this.start_pathing_callback){this.start_pathing_callback(path)}},continueTo:function(x,y){this.newDestination={x:x,y:y}},go:function(x,y){if(this.isAttacking()){this.disengage()}else if(this.followingMode){this.followingMode=false;this.target=null}this.moveTo_(x,y)},follow:function(entity,dist){var found=false;var spot=this.getClosestSpot(entity,dist);if(spot&&spot.x&&spot.y)this.moveTo_(spot.x,spot.y)},getLastMove:function(){if(!this.path)return null;var lastPath=this.path[this.path.length-1];return[lastPath[0],lastPath[1]]},stopInPath:function(x,y){if(this.isMovingPath()){if(this.map.entities.pathfinder.isInPath(this.path,[x,y])){this.setPosition(x,y);this.interrupted=true;this.forceStop()}}},getSpotsAroundFrom:function(dest,adjStart,adjEnd){adjStart=adjStart||1;adjEnd=adjEnd||1;var coords=[];var start=Math.min(adjStart,adjEnd);var end=Math.max(adjStart,adjEnd);for(var i=start;i<=end;++i){coords=coords.concat(this.getSpotsAround(dest,i))}return coords},getSpotsAround:function(dest,adjDist){adjDist=adjDist||1;var d=adjDist*G_TILESIZE;var iterations=adjDist*4;var pos=[dest.x,dest.y];var x2=pos[0],y2=pos[1];var sx=this.x,sy=this.y;var points=[];var sec=2*Math.PI/iterations;var x,y,deg=0;for(var i=0;i<iterations;++i){deg+=sec;x=~~(x2+Math.sin(deg)*d);y=~~(y2+Math.cos(deg)*d);points.push([x,y])}points=points.filter((v,i,a)=>a.findIndex(v2=>v2[0]===v[0]&&v2[1]===v[1])===i);var coords=[];var p,tp,len=points.length;for(var i=0;i<len;++i){p=points[i];coords.push({d:Utils.realDistance([sx,sy],p),x:p[0],y:p[1]})}return coords},getClosestSpot:function(dest,adjStart,adjEnd){adjStart=adjStart||1;adjEnd=adjEnd||1;var coords=this.getSpotsAroundFrom(dest,adjStart,adjEnd);for(var i=coords.length-1;i>=0;--i){var coord=coords[i];if(game.mapContainer.isColliding(coord.x,coord.y))coords.splice(i,1)}coords.sort(function(a,b){return a.d-b.d});return{x:coords[0].x,y:coords[0].y}},isOverlapping:function(){var entities=this.map.entities.getCharactersAround(this,1);for(var entity of entities){if(!entity||this===entity)continue;if(this.isOverlappingEntity(entity)){return true}}return false},stop:function(){if(this.isMovingPath()){this.interrupted=true;this.moving=false}},forceStop:function(){this.movement.stop();this.orientation=0;this.moveOrientation=0;if(this.isMovingPath()){if(this.interrupted&&this.abort_pathing_callback)this.abort_pathing_callback(this.x,this.y);this.interrupted=false;this.path=null;this.newDestination=null;this.isReadyToMove=true;this.followingMode=false}},forceStopMove:function(){console.info("character - forceStopMove - called");this.movement.stop();this.moveOrientation=0;this.freeze=false;if(this.movestop_callback)this.movestop_callback()},setMoveStopCallback:function(callback){this.movestop_callback=callback},onHasMoved:function(callback){this.hasmoved_callback=callback},hasMoved:function(){this.setDirty();if(this.hasmoved_callback){this.hasmoved_callback(this)}},setMoveRate:function(rate){this.moveSpeed=rate;this.walkSpeed=~~(rate/4);this.moveCooldown=new Timer(rate);this.tick=Math.round(1e3/this.moveSpeed)},getPathIndex:function(step){if(!this.path===null||this.path.length===0)return null;if(step<0||step>=this.path.length)return null;return this.path[step]},updateMovement:function(){var p=this.path,i=this.step;if(!p||i>p.length-1)return;this.orientation=this.getOrientation([this.x,this.y],p[i]);this.walk(this.orientation)},nextStepPath:function(){if(this.step===0){this.step++;this.updateMovement()}if(this.step<this.path.length){if(this.x===this.path[this.step][0]&&this.y===this.path[this.step][1]){this.step++;this.updateMovement();return true}return false}return false},nextStep:function(){var stop=false,res=false,path,x,y;if(!this.isMovingPath()||this.freeze){this.interrupted=true;stop=true}if(!stop){res=this.nextStepPath();if(this.step>=this.path.length){stop=true}if(this.step_callback){this.step_callback()}}if(this.hasChangedItsPath()){this.setPosition(this.x,this.y);x=this.newDestination.x;y=this.newDestination.y;path=this.requestPathfindingTo(x,y);this.newDestination=null;this.followPath(path);return true}if(stop){if(this.stop_pathing_callback){this.stop_pathing_callback(this.x,this.y);this.forceStop()}res=true}return res},onBeforeMove:function(callback){this.before_move_callback=callback},onBeforeStep:function(callback){this.before_step_callback=callback},onStep:function(callback){this.step_callback=callback},isMoving:function(){return this.movement.inProgress},isMovingPath:function(){return this.path&&this.path.length>0},hasNextStep:function(){return this.path&&this.path.length-1>this.step},hasChangedItsPath:function(){return!(this.newDestination===null)},isNear:function(character,distance){var dx,dy,near=false;dx=Math.abs(this.x-character.x);dy=Math.abs(this.y-character.y);if(dx<=distance*G_TILESIZE&&dy<=distance*G_TILESIZE){near=true}return near},isNextToo:function(x,y,o){var o=o||this.orientation;var ts=G_TILESIZE;return Math.abs(this.x-x)<=ts&&Math.abs(this.y-y)<=ts},movePath:function(path,orientation){this.orientation=this.getOrientationTo([path[1][0],path[1][1]]);this.walk();this.path=path;this.step=0},nextDist:function(x,y,o,dist){x=x||this.x;y=y||this.y;o=o||this.orientation;dist=dist||1;switch(o){case 1:return[x,y-dist];case 2:return[x,y+dist];case 3:return[x-dist,y];case 4:return[x+dist,y]}return[x,y]},nextMove:function(x,y,o,dist){return this.nextDist(x,y,o,1)},nextTile:function(x,y,o,dist){return this.nextDist(x,y,o,G_TILESIZE)},move:function(time,orientation,state,x,y){this.orientation=orientation;if(state===1&&orientation!==Types.Orientations.NONE){this.forceStop();this.setPosition(x,y);this.walk(orientation)}else if(state===0||state===2||orientation===Types.Orientations.NONE){this.forceStop();this.setPosition(x,y)}},canMove:function(){if(this.isDead===false&&this.moveCooldown.isOver()){return true}return false},onRemove:function(callback){this.remove_callback=callback},isWithinPath:function(coords){var tCoords=null;if(typeof coords==="Object"&&coords.x>0&&coords.y>0){tCoords=[coords.x,coords.y]}else if(Array.isArray(coords)&&coords.length===2){tCoords=[coords[0],coords[1]]}if(!tCoords)return null;if(this.path===null||this.path.length===0)return null;var pathLen=this.path.length;for(var i=0;i<pathLen;++i){if(this.path[i][0]===tCoords[0]&&this.path[i][1]===tCoords[1])return{x:tCoords[0],y:tCoords[1],step:i}}return null},setFreeze:function(ms,callback){var self=this;if(ms<=0){self.freeze=false;return}this.freeze=true;this.freeze_callback=setTimeout(function(){self.freeze=false;if(callback)callback(self)},ms)},getState:function(){return this._getBaseState()}});module.exports=EntityMoving},{"../message":49,"../timer":60,"../transition":61,"./entity":26}],28:[function(require,module,exports){var Entity=require("./entity");module.exports=Item=Entity.extend({init:function(type,id,itemRoom,x,y,map){var kind=itemRoom.itemKind;this._super(id,type,kind,x,y,map);this.isStatic=false;this.isFromChest=false;this.orientation=Types.Orientations.DOWN;this.experience=0;this.data=ItemData.Kinds[kind];this.room=itemRoom},handleDespawn:function(params){var self=this;this.blinkTimeout=setTimeout(function(){params.blinkCallback();self.despawnTimeout=setTimeout(params.despawnCallback,params.blinkingDuration)},params.beforeBlinkDelay)},destroy:function(){if(this.blinkTimeout){clearTimeout(this.blinkTimeout)}if(this.despawnTimeout){clearTimeout(this.despawnTimeout)}if(this.isStatic){this.scheduleRespawn(3e4)}},scheduleRespawn:function(delay){var self=this;setTimeout(function(){if(self.respawnCallback){self.respawnCallback()}},delay)},onRespawn:function(callback){this.respawnCallback=callback},getState:function(){return[parseInt(this.id,10),parseInt(this.type),parseInt(this.room.itemKind),this.data&&this.data.hasOwnProperty("name")?this.data.name:"",parseInt(this.map.index),parseInt(this.x),parseInt(this.y),parseInt(this.orientation),parseInt(this.room.itemNumber)]},getName:function(){return this.data.name},toString:function(){return this.room.itemKind+" "+this.room.itemNumber+" "+this.room.itemDurability+" "+this.room.itemDurabilityMax+" "+this.room.itemExperience+" "+this.x+" "+this.y}})},{"./entity":26}],29:[function(require,module,exports){var Character=require("./character"),Messages=require("../message"),MobArea=require("../area/mobarea");module.exports=Mob=Character.extend({init:function(id,kind,x,y,map,mobArea){this._super(id,Types.EntityTypes.MOB,kind,x,y,map);this.world=this.map.entities.world;this.data=MobData.Kinds[this.kind];if(this.data.level>0)this.level=this.data.level;else{if(mobArea)this.level=Utils.randomRangeInt(Math.max(this.data.minLevel,mobArea.minLevel),Math.min(this.data.maxLevel,mobArea.maxLevel));else this.level=Utils.randomRangeInt(this.data.minLevel,this.data.maxLevel)}this.level=this.level;var tx=Number(x),ty=Number(y);this.spawnX=tx;this.spawnY=ty;this.stats={};this.stats.attack=this.data.attack*this.level;this.stats.defense=this.data.defense*this.level;this.stats.hp=Math.max(this.data.hp*this.level-40,1);this.stats.hpMax=this.stats.hp;this.stats.ep=this.data.ep*this.level;this.stats.epMax=this.stats.ep;this.stats.xp=this.data.xp*this.level;this.stats.mod={attack:0,defense:0,damage:0,health:0};this.hatelist=[];this.hateCount=0;this.respawnTimeout=null;this.returnTimeout=null;this.isDead=false;this.aggroRange=this.data.aggroRange;this.attackRange=this.data.attackRange;this.isAggressive=this.data.isAggressive;this.moveSpeed=this.data.moveSpeed;this.setMoveRate(this.moveSpeed);this.setAttackRate(this.data.attackRate);this.setAggroRate(this.data.reactionDelay>>2);this.setMoveAI(Utils.randomRangeInt(50,150));this.setItemLoot();this.drops={};this.questDrops={};this.setDrops();this.spawnDelay=this.data.respawn;this.canCall=true;this.orientation=Utils.randomOrientation();this.isReturning=false;this.target=null;this.droppedItem=false;this.isBlocking=false;this.freeze=false;this.aiState=mobState.IDLE;this.effects={};this.activeEffects=[];this.damageCount={};this.dealtCount={};this.creatureMulti=1},createBoss:function(multi){this.creatureMulti=multi;this.stats.hp*=multi;this.stats.hpMax*=multi;this.spawnDelay*=multi;this.resetHP();for(var kind in this.drops){if(ItemTypes.isEquipment(kind))this.drops[kind]*=multi}},getXP:function(){return this.data.xp*this.data.attackMod*this.data.defenseMod*this.data.attackRateMod*this.data.hpMod*this.level},setMoveAI:function(duration){this.moveAICooldown=new Timer(duration)},canMoveAI:function(){return this.moveAICooldown.isOver()},resetMoveAI:function(time){this.moveAICooldown.lastTime=time},setAggroRate:function(duration){this.aggroCooldown=new Timer(duration)},canAggro:function(){return this.aggroCooldown.isOver()},resetAggro:function(time){this.aggroCooldown.lastTime=time},onKilled:function(callback){this.on_killed_callback=callback},onDamage:function(attacker,hpMod,epMod,crit,effects){var hp=this.stats.hp;var dmgRatio=hpMod/this.stats.hpMax;log.info("dmgRatio: "+dmgRatio);var hpDiff=this.stats.hp;this._super(attacker,hpMod,epMod,crit,effects);hpDiff=hpDiff-this.stats.hp;if(hpDiff>0){console.info("onDamage hpDiff:"+hpDiff);this.onHitByEntity(attacker,hpDiff)}if(this.stats.hp<=0){this.die(attacker)}},destroy:function(){this.isDead=true;this.endEffects();this.forgetEveryone();this.clearTarget();this.resetBars();this.resetPosition();this.handleRespawn();this.damageCount={};this.dealtCount={}},onHitEntity:function(target,dmg){if(!this.dealtCount.hasOwnProperty(target.id))this.dealtCount[target.id]=0;this.dealtCount[target.id]+=dmg},onHitByEntity:function(target,dmg){if(!this.damageCount.hasOwnProperty(target.id))this.damageCount[target.id]=0;this.damageCount[target.id]+=dmg},resetBars:function(){this.stats.hp=this.stats.hpMax;this.stats.ep=this.stats.epMax},hates:function(entity){return _.any(this.hatelist,function(obj){return obj.entity===entity})},increaseHateFor:function(entity,points){if(this.hates(entity)){_.detect(this.hatelist,function(obj){return obj.entity===entity}).hate+=points}else{this.hatelist.push({entity:entity,hate:points})}if(this.returnTimeout){clearTimeout(this.returnTimeout);this.returnTimeout=null}},getMostHated:function(hateRank){var i,playerId,sorted=_.sortBy(this.hatelist,function(obj){return obj.hate}),size=_.size(this.hatelist);if(sorted&&sorted[0]){return sorted[0].entity}return null},forgetPlayer:function(playerId){this.hatelist=_.reject(this.hatelist,function(obj){return obj.entity.id===playerId});if(this.hatelist.length===0){this.returnToSpawn()}},forgetEveryone:function(){this.hatelist=[];this.damageCount={};this.dealtCount={};this.clearAttackerRefs();this.removeAttackers()},handleRespawn:function(){var self=this;if(this.area&&this.area instanceof MobArea){this.area.respawnMob(self,this.spawnDelay)}else{setTimeout(function(){if(self.respawnCallback){self.respawnCallback()}},this.spawnDelay)}},onRespawn:function(callback){this.respawnCallback=callback},respawn:function(){this.spawnX=this.x;this.spawnY=this.y;this.isDead=false;this.droppedItem=false;this.invincible=false;this.resetBehaviour();this.activeEffects=[];this.map.entities.sendNeighbours(this,new Messages.Spawn(this))},resetBehaviour:function(){this.disengage();this.forceStop();this.forgetEveryone();this.setAiState(mobState.IDLE);this.freeze=false},resetPosition:function(){this.setPosition(this.spawnX,this.spawnY)},returnToSpawn:function(){var self=this;if(this.aiState===mobState.RETURNING)return;this.setAiState(mobState.RETURNING);this.forceStop();if(this.hasTarget())this.clearTarget();this.forgetEveryone();this.invincible=true;this.freeze=false;if(this.x===this.spawnX&&this.y===this.spawnY){this.returnedToSpawn();return}this.go(this.spawnX,this.spawnY);console.warn("returnToSpawn - Path: "+JSON.stringify(this.path));if(!this.path||this.path.length===0){try{throw new Error}catch(err){console.error(err.stack)}this.returnedToSpawn()}else{var pathTicks=this.map.entities.pathfinder.getPathTicks(this.path,this.spawnX,this.spawnY);var delay=Math.max(0,~~(pathTicks/(this.tick/G_FRAME_INTERVAL_EXACT)));console.info("returnToSpawn.delay = "+delay);console.info("id="+this.id+",x="+this.spawnX+",y="+this.spawnY);setTimeout(function(){console.info("st - id="+self.id+",x="+self.spawnX+",y="+self.spawnY);self.returnedToSpawn()},delay)}},onMove:function(callback){this.moveCallback=callback},move:function(x,y){this.setPosition(x,y);this.orientation=Utils.getOrientationFromLastMove(this);if(this.moveCallback){this.moveCallback(this)}},distanceToPos:function(x,y){return Utils.distanceTo(this.x,this.y,x,y)},setItemLoot:function(){this.loot={};this.lootTotal=0;for(var lootId in ItemLootData.ItemLoot){var loot=ItemLootData.ItemLoot[lootId];var chance=~~(1e3/loot.rarity*loot.rarity);if(chance>0)this.loot[lootId]=chance;this.lootTotal+=this.loot[lootId]}this.lootTotal=~~this.lootTotal},setDrops:function(){var dropLevel=Math.ceil(this.level/10)*10;for(var kind in ItemData.Kinds){var item=ItemData.Kinds[kind];if(!item||item.legacy===1)continue;var diff=item.level-this.level;if(ItemTypes.isEquipment(kind)){if(diff>=0&&diff<5)this.drops[kind]=1;if(diff>=-5&&diff<0)this.drops[kind]=2;if(diff>=-10&&diff<-5)this.drops[kind]=5}}if(this.level>=15&&this.level<25)this.drops[310]=250;if(this.level>=25&&this.level<35)this.drops[311]=250;if(this.level>=35&&this.level<45)this.drops[312]=250;if(this.level>=45)this.drops[313]=250;if(this.level<20)this.drops[34]=250;else this.drops[36]=250},Speech:function(key,value){return null},getState:function(){return this._getBaseState().concat([this.level,this.stats.hp,this.stats.hpMax])},setAiState:function(state){this.aiState=state},die:function(attacker){var self=this;console.info("Entity is dead");this.map.entities.sendBroadcast(this.despawn());_.each(this.attackers,function(attacker){if(self.on_killed_callback){self.on_killed_callback(attacker,self.damageCount[attacker.id])}attacker.onKillEntity(self,self.damageCount[attacker.id],self.dealtCount[attacker.id])});this._super(attacker);this.destroy()},onKillEntity:function(attacker){},baseCrit:function(){var modDiff=0;var statDiff=this.stats.attack+this.stats.mod.attack;var chance=~~Utils.clamp(5,500,~~(statDiff+modDiff));return chance},baseCritDef:function(){var modDiff=0;var statDiff=this.stats.defense+this.stats.mod.defense;var chance=~~Utils.clamp(5,500,~~(statDiff+modDiff));return chance},baseDamage:function(){var dealt,absorbed,dmg;dealt=~~(this.level*12);dealt+=(this.stats.attack+this.stats.mod.attack)*(6-Math.min(3,this.level*.1));dmg=~~dealt;return dmg},baseDamageDef:function(){var dealt,absorbed,dmg;dealt=~~(this.level*2);dealt+=(this.stats.defense+this.stats.mod.defense)*2;dmg=~~dealt;return dmg},canReach:function(entity){var o=this.orientation;this.lookAtEntity(entity);var res=this._super(entity);this.orientation=o;return res},dropGold:function(){return Utils.randomRangeInt(this.level*2,this.level*3)*this.creatureMulti},returnedToSpawn:function(){console.info("mob.returnedToSpawn");this.resetHP();this.resetPosition();this.resetBehaviour();this.invincible=false},handleMobHate:function(tEntity,hatePoints){console.info("handleMobHate");if(tEntity&&tEntity instanceof Player){this.increaseHateFor(tEntity,hatePoints);if(this.stats.hp>0){var hEntity=this.getMostHated();if(hEntity)this.createAttackLink(hEntity)}}},aggroPlayer:function(player,dmg){dmg=dmg||1;this.resetAggro(0);this.attackingMode=true;this.handleMobHate(player,1);this.setAiState(mobState.AGGRO);this.attackTimer=Date.now();this.freeze=false},endEffects:function(){for(var skilleffect of this.activeEffects){skilleffect.endEffects()}this.activeEffects=[]},goRoam:function(pos){this.go(pos.x,pos.y);if(this.path){this.aiState=mobState.ROAMING;this.spawnX=pos.x;this.spawnY=pos.y}},canRoam:function(){return!this.hasTarget()&&!this.isDead&&!this.isReturning&&!this.isMoving()&&this.aiState===mobState.IDLE}});module.exports=Mob},{"../area/mobarea":6,"../message":49,"./character":24}],30:[function(require,module,exports){var Entity=require("./entity");var Utils=require("../utils");var Messages=require("../message");var Node=Entity.extend({init:function(id,kind,x,y,map,level,type){this._super(id,Types.EntityTypes.NODE,kind,x,y,map);this.stats={};this.level=level;this.setDrops();this.spawnDelay=6e4;this.spriteName="nodeset"+kind;this.animName="node"+type},getState:function(){var arr=this._getBaseState();return arr.concat([this.level,this.spriteName,this.animName,this.weaponType])},onDeath:function(callback){this.death_callback=callback},die:function(){this.isDead=true;this.map.entities.sendNeighbours(this,new Messages.Despawn(this));this.handleRespawn();if(this.death_callback){this.death_callback()}},setDrops:function(){this.drops={};if(this.kind===2){if(this.level===1)this.drops[301]=2e3;if(this.level===2)this.drops[302]=2e3;if(this.level===3)this.drops[303]=2e3;else this.drops[304]=2e3}},respawn:function(){this.isDead=false;this.map.entities.sendNeighbours(this,new Messages.Spawn(this))},handleRespawn:function(){var self=this;if(this.area&&this.area instanceof Area){this.area.respawn(this,this.spawnDelay)}else{setTimeout(function(){self.respawn();if(self.respawnCallback){self.respawnCallback()}},this.spawnDelay)}}});module.exports=Node},{"../message":49,"../utils":66,"./entity":26}],31:[function(require,module,exports){var Character=require("./character"),Messages=require("../message"),EntityQuests=require("../entityquests");var NPCnames=require("../../shared/data/npc_names.json");var NpcMove=Character.extend({init:function(id,kind,x,y,map){x+=8;y+=8;this._super(id,Types.EntityTypes.NPCMOVE,kind,x,y,map);this.armor=0;this.weapon=0;this.gender=kind%2;this.setMoveRate(350);this.name=NPCnames[kind%NPCnames.length];var callbacks=this.map.entities.world.npcMoveCallback;callbacks.setCallbacks(this);this.entityQuests=new EntityQuests(this);this.npcQuestId=this.kind;if(QuestData.NpcData.hasOwnProperty(this.kind)){var qData=QuestData.NpcData[this.kind];if(qData&&qData.length>0){var newQuest=null;var pQuest=null;for(var q of qData){this.entityQuests.quests[q.id]=q}}}},getState:function(){return this._getBaseState().concat(this.npcQuestId)},talk:function(player){var self=this;var self_player=player;var res=false;player.quests.forQuestsType(QuestType.GETITEMKIND,function(q){if(q.npcQuestId===self.npcQuestId){if(self_player.quests.questAboutItemComplete(q,null))res=true}});if(res)return;if(Object.keys(this.entityQuests.quests).length===0){this.entityQuests.dynamicQuests(player)}else{var newQid=-1;if(this.entityQuests.hasQuest(player)){return}var newQid=this.entityQuests.getNextQuestId(player);if(!newQid){this.entityQuests.sendNoQuest(player);return}var langcode="QUESTS_"+newQid;var msg=new Messages.Dialogue(this,langcode);player.sendPlayer(msg)}},randomMove:function(){if(!this.hasTarget()&&!this.isDead&&!this.isMoving()){var canRoam=Utils.randomRangeInt(0,100)===1;if(!canRoam||this.map.entities.getPlayerAroundCount(this,20)===0)return;var pos=this.map.entities.getRandomPosition(this,2);if(pos&&!(pos.x===this.x&&pos.y===this.y)){this.go(pos.x,pos.y)}}},checkMove:function(time){if(this.isDead)return;if(!this.freeze&&this.isMoving()&&this.canMove()){this.nextStep()}}});module.exports=NpcMove},{"../../shared/data/npc_names.json":343,"../entityquests":34,"../message":49,"./character":24}],32:[function(require,module,exports){var Entity=require("./entity"),Player=require("./player"),Utils=require("../utils"),Messages=require("../message");var NpcStatic=Entity.extend({init:function(id,kind,x,y,map){x+=8;y+=8;this._super(id,Types.EntityTypes.NPCSTATIC,kind,x,y,map);this.map=map},talk:function(player){console.info("talk");console.info("kind: "+this.kind);if(this.kind===44){console.info("THIS IS FOR COLLECTING ITEMS NPC.");if(player.questStatus){for(let[key,questStatus]of Object.entries(player.questStatus)){console.info("questStatus"+JSON.stringify(questStatus));if(questStatus.type==1&&questStatus.count<=questStatus.objectCount){player.questAboutItem(questStatus,null)}}}return}for(var quest in player.quests){if(quest.npcKind===this.kind){return}}}});module.exports=NpcStatic},{"../message":49,"../utils":66,"./entity":26,"./player":33}],33:[function(require,module,exports){var Character=require("./character"),Messages=require("../message"),Formulas=require("../formulas"),Bank=require("../items/bank"),Equipment=require("../items/equipment"),Inventory=require("../items/inventory"),SkillHandler=require("../skillhandler"),SkillEffectHandler=require("../effecthandler"),PacketHandler=require("../packets/packethandler"),PlayerQuests=require("../playerquests");Quest=require("../quest");module.exports=Player=Character.extend({init:function(world,user,connection){var self=this;this.user=user;this.world=world;this.server=world;this.connection=connection;this.map=this.world.maps[0];this._super(connection.id,Types.EntityTypes.PLAYER,1,0,0,this.map,0);this.mapStatus=0;this.mapIndex=0;this.gold=new Array(2);this.skillSlots=[];this.hasLoggedIn=false;this.hasEnteredGame=false;this.isDead=false;this.inventory=null;this.bank=null;this.equipment=null;this.itemStore=new Array(3);this.exp={base:0,attack:0,defense:0,move:0};this.level={base:0,attack:0,defense:0,move:0};this.stats={attack:0,defense:0,health:0,energy:0,luck:0,free:0,hp:0,hpMax:0,ep:0,epMax:0};this.stats.mod={attack:0,defense:0,damage:0,health:0};this.cooltimeTimeout=null;this.consumeTimeout=null;this.skillHandler=new SkillHandler(this);this.moveSpeed=500;this.setMoveRate(this.moveSpeed);this.consumeTime=new Timer(5e3);this.attackedTime=new Timer(1e3);this.attackQueue=[];this.moveQueue=[];this.stopQueue=[];this.attackSkill=[];this.attackTimer=0;this.idleTimer=new Timer(3e5);this.world.playerCallback.setCallbacks(this);this.quests=new PlayerQuests(this);this.onWelcomeReady=false;this.tut={};this.tut.move=false;this.tut.portal=false;this.tut.attack=false;this.tut.attack2=false;this.tut.buy=false;this.tut.buy2=false;this.tut.equip=false;this.tut.stats=false;this.spawnsList={};this.lastAction=Date.now();this.knownIds=[];this.sx=0;this.sy=0;this.ex=-1;this.ey=-1;this.moveOrientation=0;this.savedAll=false;this.savedSection=0;this.achievements=[];this.pStats=[];this.sprites=[];this.colors=[];this.shortcuts={};this.loaded=0;this.activeEffects=[];this.levels={}},start:function(connection){this.worldHandler=connection.worldHandler;this.connection=connection;this.id=connection.id;this.packetHandler=new PacketHandler(this.user,this,connection,this.world,this.map);this.packetHandler.loadedPlayer=true;this.server.connect_callback(this);this.sendPlayerToClient()},destroy:function(){var self=this},getState:function(){var basestate=this._getBaseState();var sprite1=this.getSprite(0),sprite2=this.getSprite(1);var state=[this.level,this.stats.hp,this.stats.hpMax,0,sprite1,sprite2,0,0];return basestate.concat(state)},send:function(message){this.connection.send(message)},resetBars:function(){var hp=this.stats.hp;var ep=this.stats.ep;var hpDiff=this.stats.hpMax-hp;var epDiff=this.stats.epMax-ep;this.modHealthBy(hpDiff);this.modEnergyBy(epDiff)},onKillEntity:function(entity,damage,dealt){damage=damage||0;dealt=dealt||0;var ratio=damage/entity.stats.hpMax;var xp=~~(entity.getXP()*ratio);var diff=10;var div=1/diff;var mod=1+div+Utils.clamp(-diff,diff,entity.level-this.level)*div;var xp=~~(xp*mod);this.incExp(xp);this.incWeaponExp(xp);var weaponSlot=4;var armorDamage=Math.min(5,Math.ceil(dealt/300));log.warn("armorDamage:"+armorDamage);for(var it in this.equipment.rooms){if(it===weaponSlot)continue;if(!this.equipment.rooms[it])continue;if(armorDamage>0){if(this.equipment.degradeItem(it,1))this.equipment.addExperience(it,armorDamage)}}this.armorDamage=0;var weaponDamage=Math.min(5,Math.ceil(damage/2e3));if(weaponDamage>0){if(this.equipment.degradeItem(weaponSlot,1))this.equipment.addExperience(weaponSlot,weaponDamage)}this.weaponDamage=0},onDamage:function(attacker,hpMod,epMod,crit,effects){var hpDiff=this.stats.hp;this._super(attacker,hpMod,epMod,crit,effects);hpDiff=hpDiff-this.stats.hp;attacker.onHitEntity(this,hpDiff);if(this.stats.hp<=0){_.each(this.attackers,function(attacker){if(attacker.hasOwnProperty("knownIds"))delete attacker.knownIds[this.id]});this.die(attacker)}},incExp:function(gotexp){var incExp=parseInt(gotexp);incExp=Math.ceil(incExp*this.getExpBonus());this.exp.base=parseInt(this.exp.base)+parseInt(incExp);this.sendPlayer(new Messages.Stat(1,this.exp.base,incExp));var origLevel=this.level;this.level=Types.getLevel(this.exp.base);if(origLevel!==this.level){this.levelUp(origLevel)}return incExp},incAttackExp:function(gotexp){var incExp=parseInt(gotexp);incExp=Math.ceil(incExp*this.getExpBonus()*.25);this.exp.attack=parseInt(this.exp.attack)+parseInt(incExp);var origLevel=this.levels.attack;this.levels.attack=Types.getAttackLevel(this.exp.attack);if(origLevel!==this.levels.attack){this.sendPlayer(new Messages.LevelUp(2,this.levels.attack,this.exp.attack))}return incExp},incDefenseExp:function(gotexp){var incExp=parseInt(gotexp);incExp=Math.ceil(incExp*this.getExpBonus());this.exp.defense=parseInt(this.exp.defense)+parseInt(incExp);var origLevel=this.stats.defense;this.levels.defense=Types.getDefenseLevel(this.exp.defense);if(origLevel!==this.levels.defense){this.sendPlayer(new Messages.LevelUp(3,this.levels.defense,this.exp.defense))}return incExp},incMoveExp:function(gotexp){var incExp=parseInt(gotexp);incExp=Math.ceil(incExp*this.getExpBonus());this.exp.move=parseInt(this.exp.move)+parseInt(incExp);var origLevel=this.levels.move;this.levels.move=Types.getMoveLevel(this.exp.move);if(origLevel!==this.levels.move){this.sendPlayer(new Messages.LevelUp(4,this.levels.move,this.exp.move))}return incExp},incWeaponExp:function(gotexp){var incExp=parseInt(gotexp);incExp=Math.ceil(incExp*this.getExpBonus()*.25);var type=this.getWeaponType();if(!this.exp.hasOwnProperty(type))return null;var xp=parseInt(this.exp[type]);var plvl=Types.getWeaponLevel(xp);xp=xp+incExp;var clvl=Types.getWeaponLevel(xp);this.exp[type]=xp;if(plvl!==clvl){var types={10:"sword",11:"bow",12:"hammer",13:"axe"};this.sendPlayer(new Messages.LevelUp(types[type],clvl,xp))}return incExp},getExpBonus:function(){var self=this;var bonus=1;if(this.party){this.party.forEachPlayer(function(player){if(self.isInScreen([player.x,player.y])){bonus+=.15}})}return bonus},levelUp:function(prevLevel){for(var i=prevLevel+1;i<=this.level;++i){if(i<10){this.stats.attack+=2;this.stats.defense+=2;this.stats.health+=2;this.stats.energy+=2;this.stats.luck+=2}else{this.stats.free+=5}}this.setHPMax();this.setEPMax();this.sendPlayer(new Messages.StatInfo(this));this.resetBars();this.sendPlayer(new Messages.ChangePoints(this,0,0));this.sendPlayer(new Messages.LevelUp(1,this.level,this.exp.base))},sendPlayerToClient:function(){var self=this;console.info("sendMessage");var i=0;var sendMessage=[Types.Messages.WC_PLAYER,0,Date.now(),self.id,self.name,self.mapIndex,self.x,self.y,self.stats.hp,self.stats.ep,self.exp.base,self.exp.attack,self.exp.defense,self.exp.move,self.exp.sword,self.exp.bow,self.exp.hammer,self.exp.axe,self.exp.logging,self.exp.mining,self.colors[0],self.colors[1],self.gold[0],self.gold[1],self.user.gems,self.stats.attack,self.stats.defense,self.stats.health,self.stats.energy,self.stats.luck,self.stats.free];console.info("sendMessage - Equipment");sendMessage.push(Object.keys(self.equipment.rooms).length);for(var equipIndex in self.equipment.rooms){var item=self.equipment.rooms[equipIndex];sendMessage=sendMessage.concat(item.toArray())}self.setRange();sendMessage.push(self.getSprite(0));sendMessage.push(self.getSprite(1));console.info("sendMessage - Inventory");sendMessage.push(Object.keys(self.inventory.rooms).length);for(var invIndex in self.inventory.rooms){var item=self.inventory.rooms[invIndex];sendMessage=sendMessage.concat(item.toArray())}console.info("sendMessage - Bank");sendMessage.push(Object.keys(self.bank.rooms).length);for(var bankIndex in self.bank.rooms){var item=self.bank.rooms[bankIndex];sendMessage=sendMessage.concat(item.toArray())}var quests=self.quests.quests.filter(function(q){return q.status!==QuestStatus.COMPLETE});sendMessage.push(quests.length);for(var questIndex=0;questIndex<quests.length;++questIndex){var q=quests[questIndex];console.info(JSON.stringify(q));sendMessage=sendMessage.concat(q.toClient())}var achievements=self.achievements;sendMessage.push(achievements.length);for(var achieveIndex=0;achieveIndex<achievements.length;++achieveIndex){var achievement=achievements[achieveIndex];console.info(JSON.stringify(achievement));sendMessage=sendMessage.concat(achievement.toClient(achievement))}self.effectHandler=new SkillEffectHandler(self);sendMessage.push(self.skills.length);for(var i=0;i<self.skills.length;++i){sendMessage.push(parseInt(self.skills[i].skillXP))}var len=Object.keys(self.shortcuts).length;sendMessage.push(len);var sc;for(var id in self.shortcuts){sc=self.shortcuts[id];if(sc){sendMessage.push(parseInt(sc[0]));sendMessage.push(parseInt(sc[1]));sendMessage.push(parseInt(sc[2]))}}if(self.world.enter_callback){self.world.enter_callback(self);self.connection.sendUTF8(sendMessage.join(","));self.hasEnteredGame=true}},fillPlayerInfo:function(db_player){var self=this;self.mapIndex=parseInt(db_player.map[0]);self.map=self.server.maps[self.mapIndex];self.x=parseInt(db_player.map[1]);self.y=parseInt(db_player.map[2]);self.orientation=parseInt(db_player.map[3]);if(db_player.sprites.length===2){db_player.sprites[2]=151;db_player.sprites[3]=50}self.sprites=db_player.sprites.parseInt();self.colors=db_player.colors;self.exp.base=parseInt(db_player.exps[0]);self.exp.attack=parseInt(db_player.exps[1]);self.exp.defense=parseInt(db_player.exps[2]);self.exp.move=parseInt(db_player.exps[3]);if(db_player.exps.length>=8){self.exp.sword=parseInt(db_player.exps[4]);self.exp.bow=parseInt(db_player.exps[5]);self.exp.hammer=parseInt(db_player.exps[6]);self.exp.axe=parseInt(db_player.exps[7])}else{self.exp.sword=0;self.exp.bow=0;self.exp.hammer=0;self.exp.axe=0}if(db_player.exps.length===10){self.exp.logging=parseInt(db_player.exps[8]);self.exp.mining=parseInt(db_player.exps[9])}else{self.exp.logging=0;self.exp.mining=0}self.level=Types.getLevel(self.exp.base);self.levels.attack=Types.getAttackLevel(self.exp.attack);self.levels.defense=Types.getDefenseLevel(self.exp.defense);self.levels.move=Types.getMoveLevel(self.exp.move);self.gold[0]=parseInt(db_player.gold[0]);self.gold[1]=parseInt(db_player.gold[1]);self.isDead=false;self.pStats=db_player.pStats.parseInt();db_player.stats=db_player.stats.parseInt();var isValidStats=function(lvl,stats){var total=0;if(lvl<10)total=lvl*10;else total=9*10+5*(lvl-9);var statTotal=stats.reduce(function(a,b){return a+b},0);return total===statTotal};var lvl=parseInt(self.level);if(!isValidStats(lvl,db_player.stats)){if(lvl<10){self.stats.attack=lvl*2;self.stats.defense=lvl*2;self.stats.health=lvl*2;self.stats.energy=lvl*2;self.stats.luck=lvl*2;self.stats.free=0}else{self.stats.attack=18;self.stats.defense=18;self.stats.health=18;self.stats.energy=18;self.stats.luck=18;self.stats.free=(lvl-9)*5}}else{if(lvl<10){self.stats.attack=lvl*2;self.stats.defense=lvl*2;self.stats.health=lvl*2;self.stats.energy=lvl*2;self.stats.luck=lvl*2;self.stats.free=0}else{self.stats.attack=db_player.stats[0];self.stats.defense=db_player.stats[1];self.stats.health=db_player.stats[2];self.stats.energy=db_player.stats[3];self.stats.luck=db_player.stats[4];self.stats.free=db_player.stats[5]}}if(Array.isArray(db_player.completeQuests)){self.quests.completeQuests={}}else{for(var id in db_player.completeQuests){if(!Number(id))delete db_player.completeQuests[id]}self.quests.completeQuests=db_player.completeQuests}self.setHP();self.setEP();self.setPointsMax();self.resetBars();self.setMoveRate(500);if(db_player.skills.length===1){for(var i=0;i<SkillData.Skills.length;++i)db_player.skills[i]=0}self.skillHandler.setSkills(self,db_player.skills);if(Array.isArray()){for(var shortcut of db_player.shortcuts){if(shortcut)self.shortcuts[shortcut[0]]=shortcut}}else{for(var sid in db_player.shortcuts){var shortcut=db_player.shortcuts[sid];if(shortcut)self.shortcuts[sid]=shortcut}}self.attackTimer=Date.now()},setPointsMax:function(){this.stats.hpMax=this.stats.hp;this.stats.epMax=this.stats.ep},tutChat:function(text,delay,check){var self=this;var tutCheck=check;setTimeout(function(){if(self.map&&self.map.entities&&self.mapStatus>=2&&self.tut[tutCheck]===false){self.sendPlayer(new Messages.Notify("TUTORIAL",text));self.tut[tutCheck]=true}},delay*5e3)},handleInventoryEat:function(item,slot){var self=this;var kind=item.itemKind;if(!this.consumeTime.isOver())return;var amount;var itemData=ItemTypes.KindData[kind];if(itemData.typemod==="health"){amount=itemData.modifier;if(!this.hasFullHealth()){this.modHealthBy(amount)}}else if(itemData.typemod==="healthpercent"){amount=~~(this.stats.hpMax*itemData.modifier/100);if(!this.hasFullHealth()){this.modHealthBy(amount)}}if(itemData.typemod==="energy"){amount=itemData.modifier;if(!this.hasFullEnergy()){this.modEnergyBy(amount)}}this.inventory.takeOutItems(slot,1)},modHealthBy:function(hp){if(this.isDead)return;var msg=this._super(hp);this.sendChangePoints(hp,0);return msg},modEnergyBy:function(ep){var msg=this._super(ep);this.sendChangePoints(0,ep);return msg},sendChangePoints:function(health,energy){this.map.entities.sendNeighbours(this,new Messages.ChangePoints(this,health,energy))},getHPMax:function(){var hp=300+this.stats.health*100;return hp},getEPMax:function(){var ep=500+this.stats.energy*100;return ep},getWeapon:function(){return this.equipment.getWeapon()},getWeaponLevel:function(){var weapon=this.getWeapon();if(!weapon)return 0;var weaponData=ItemTypes.KindData[weapon.itemKind];return Types.getWeaponLevel(this.exp[weaponData.type])},baseCrit:function(){var itemDiff=this.level*2;var item=this.getWeapon();if(item){itemDiff=3*ItemTypes.getData(item.itemKind).modifier+item.itemNumber*2}var statDiff=this.stats.attack+this.stats.luck*2;var chance=Utils.clamp(0,500,~~(statDiff+itemDiff));console.info("player - baseCrit: "+chance);return chance},baseCritDef:function(){var itemDiff=this.level*2;for(var id in this.equipment.rooms){if(id===4)continue;var item=this.equipment.rooms[id];if(item){itemDiff+=3*ItemTypes.getData(item.itemKind).modifier+item.itemNumber*2}}var statDiff=this.stats.defense+this.stats.luck*2;var chance=Utils.clamp(0,500,~~(statDiff+itemDiff));console.info("player - baseCritDef: "+chance);return chance},baseDamage:function(defender){var dealt,dmg;var weapon=this.getWeapon();var level=this.level;dealt=~~(weapon?ItemTypes.getData(weapon.itemKind).modifier*3+weapon.itemNumber*2:level);var power=this.levels.attack/50+1;power*=this.getWeaponLevel()/50+1;if(weapon){dealt=~~(dealt*(weapon.itemDurability/weapon.itemDurabilityMax*.5+.5))}var mods=this.stats.mod&&this.stats.mod.attack?this.stats.mod.attack:0;dealt+=~~(this.stats.attack*3+mods)+this.stats.luck;var noobLvl=12;var noobMulti=1+Math.max(0,(noobLvl-this.level)*(1/this.level));var min=~~(level*power*noobMulti*4);var max=~~(min*1.15);dmg=Utils.randomRangeInt(min,max)+dealt;if(this.stats.mod&&this.stats.mod.damage)dmg+=this.stats.mod.damage;if(defender&&defender instanceof Mob){var type=this.getWeaponType();if(type){var mod=defender.data.modDamage[type];dmg=~~(dmg*mod)}}min=~~(min+dealt);max=~~((max+dealt)*3);return dmg},baseDamageDef:function(defender){var dealt=0,dmg=0;var level=this.level+3;console.info("baseDamageDef:");dealt=level;for(var id in this.equipment.rooms){var item=this.equipment.rooms[id];if(item){var eq_multi=id===1?4:2;var def=ItemTypes.getData(item.itemKind).modifier*eq_multi+item.itemNumber*eq_multi;dealt+=~~(def*(item.itemDurability/item.itemDurabilityMax*.5+.5))}}console.info("dealt="+dealt);var power=this.levels.defense/50+1;console.info("power="+power);var min=~~(level*power);var max=~~(min*2);console.info("dealtrange="+dealt);var mods=this.mod?this.stats.mod.defense:0;dealt+=~~(this.stats.defense*4+mods)+this.stats.luck;console.info("dealtstats="+dealt);dmg=Utils.randomRangeInt(min,max)+dealt;min=~~(min+dealt);max=~~((max+dealt)*1.75);return dmg},modifyGold:function(gold,type){type=type||0;if(this.gold[type]+gold<0)return false;this.gold[type]+=parseInt(gold);this.sendPlayer(new Messages.Gold(this));if(gold===0){}else if(gold>0)this.sendPlayer(new Messages.Notify("CHAT","GOLD_ADDED",[gold]));else{gold*=-1;this.sendPlayer(new Messages.Notify("CHAT","GOLD_REMOVED",[gold]))}return true},modifyGems:function(diff){diff=parseInt(diff);if(this.user.gems-diff<0){this.connection.send(new Messages.Notify("SHOP","SHOP_NOGEMS").serialize());return false}this.user.gems+=diff;this.connection.send(new Messages.Gold(this).serialize());return true},saveSection:function(){console.info("SAVING SECTION: "+this.savedSection);if(++this.savedSection===6){console.info("SAVED PLAYER!!!!!: "+this.name);this.savedSection=0}},sendToUserServer:function(msg){if(this.world)this.world.send(msg.serialize());else{console.warn("Player, sendToUserServer called without world being set. "+JSON.stringify(msg))}},save:function(update){console.info("Player - save, name:"+this.name);if(this.worldHandler)this.worldHandler.savePlayer(this,update);else{console.warn("Player, save called without worldHandler being set. ")}},isArcher:function(){var weapon=this.getWeapon();if(weapon&&ItemTypes.isArcherWeapon(weapon.itemKind)){return true}return false},setRange:function(){this.setAttackRange(1);if(this.isArcher()){this.setAttackRange(10)}},setHP:function(val){this._super(val)},setEP:function(val){this._super(val)},movePath:function(data,path){var x=path[0][0],y=path[0][1],x2=path[path.length-1][0],y2=path[path.length-1][1],time=data[0],interrupted=data[1];this.idleTimer.restart();console.info("set path");if(this.keyMove){this.move(this.orientation,0,this.ex,this.ey)}this.sx=this.x;this.sy=this.y;this.ex=this.x2;this.ey=this.y2;this.forceStop();this.path=this.fullpath=path;this.step=0;this.interrupted=interrupted;this.startMovePathTime=time},move:function(nm){var p=self=this;if(!nm)return;var time=nm[0],state=nm[1],o=nm[2],x=nm[3],y=nm[4];console.info("nm:"+JSON.stringify(nm));if(this.isMovingPath()){return}this.idleTimer.restart();if(this.moving_callback){clearTimeout(this.moving_callback);this.moving_callback=null}if(state===3){this.setPosition(x,y);this.forceStop();return}if(state==1){var delay=0;console.warn("delay="+delay);this.sx=this.x;this.sy=this.y;this.ex=-1;this.ey=-1;this.startMoveTime=time;console.warn("time:"+time+",now:"+Date.now()+",diff:"+(Date.now()-time));var execMove=function(){if(self.movement.inProgress){self.forceStop()}self.moving_timeout=null;self.startMoving=true;self.moveOrientation=o;self.keyMove=true;return};if(delay<=0)execMove();else this.moving_timeout=setTimeout(execMove,delay);this.nextMove=null}if(state===0){console.info("move - x: "+x+", y: "+y);this.ex=x;this.ey=y;var a=x===this.x&&y===this.y;var b=this.sx===x&&this.sy===y;console.info("move: x="+x+",y="+y);console.info("move: this.x="+this.x+",this.y="+this.y);console.info("move: this.sx="+this.sx+",this.sy="+this.sy);if(a||b){clearTimeout(this.moving_timeout);this.setPosition(x,y);this.forceStop();return}var path=[[this.sx,this.sy],[x,y]];if(!this.map.entities.pathfinder.isValidPath(this.map.grid,path)){console.warn("INVALID PATH.");console.warn("invalidPath: "+JSON.stringify(path));this.resetMove(this.x,this.y);return}if(this.map.entities.pathfinder.isPathTicksTooFast(this,path,this.startMoveTime)){this.resetMove(this.sx,this.sy);return}else{this.setPosition(x,y)}this.forceStopMove();this.keyMove=false;this.nextMove=null}},getStoredItem:function(type,slot,count){var store=this.itemStore[type];var rooms=store.rooms;if(slot<0||slot>=rooms.length)return null;var item=rooms[slot];if(!item)return;var count2=rooms[slot].itemNumber;if(ItemTypes.isLootItem(item.itemKind)||ItemTypes.isConsumableItem(item.itemKind)){if(count>0&&count2>0&&count2<count)item=store.takeOutItems(slot,count2)}return item},swapItem:function(slot,slot2){console.info(JSON.stringify(slot));console.info(JSON.stringify(slot2));var store1=this.itemStore[slot[0]];var store2=this.itemStore[slot2[0]];var room1=store1.rooms;var rs1=room1[slot[1]];if(!rs1)return;if(slot2[0]===2&&rs1){slot2[1]=store2.getItemTypeIndex(rs1)}var room2=store2.rooms;var rs2=null;if(slot2[1]>=0)rs2=room2[slot2[1]];if(rs1===rs2)return;var splitItem=function(slot,slot2,rs1){if(slot[2]>0&&slot[2]<rs1.itemNumber&&ItemTypes.isStackedItem(rs1.itemKind)){rs1.itemNumber-=slot[2];store1.setItem(slot[1],rs1);var rs2=Object.assign(new ItemRoom,rs1);rs2.itemNumber=slot[2];store2.setItem(slot2[1],rs2);return true}return false};if(rs2){if(!this.inventory.combineItem(rs1,rs2)){var tmp=rs2;if(store2.checkItem(slot2[1],rs1)&&store1.checkItem(slot[1],rs2)){store2.setItem(slot2[1],rs1);store1.setItem(slot[1],rs2)}}}else if(slot2[1]>=0){if(!splitItem(slot,slot2,rs1)){if(store2.setItem(slot2[1],rs1))store1.setItem(slot[1],null)}}else{if(store2.putItem(rs1)!==-1)store1.setItem(slot[1],null)}if(slot&&slot[0]===2&&slot[1]===4||slot2&&slot2[0]===2&&slot2[1]===4){this.broadcastSprites()}},broadcastSprites:function(){var s1=this.getSprite(0);this.setSprite(0,s1);var s2=this.getSprite(1);this.setSprite(1,s2);this.packetHandler.broadcast(new Messages.setSprite(this,s1,s2),false)},handleStoreEmpty:function(slot,item){var kind=item.itemKind;var store=this.itemStore[slot[0]];var index=slot[1];var count=slot[2];if(slot[0]===2){console.error("handleStoreEmpty - Cannot empty equipment store.");return}var itemRoom=store.rooms[slot[1]];var newItemRoom=Object.assign(new ItemRoom,itemRoom);var item=this.map.entities.createItem(newItemRoom,this.x,this.y);count=Utils.clamp(1,itemRoom.itemNumber,count);if(!ItemTypes.isEquippable(kind)){item.room.itemNumber=count;store.takeOutItems(index,count)}else{store.makeEmptyItem(index)}this.map.entities.sendNeighbours(this,item.spawn());this.knownIds.push(item.id);this.server.handleItemDespawn(item)},sendCurrentMove:function(){var msg=new Messages.Move(this,this.moveOrientation,0,this.x,this.y);this.map.entities.sendNeighbours(this,msg)},dropGold:function(){var level=this.level;var count=Math.ceil(Math.random()*level*5+level);count=Math.min(count,this.gold[0]);this.modifyGold(-count);return count},respawn:function(){this.isDead=false;this.freeze=false;this.hasEnteredGame=true;this.resetBars()},setPosition:function(x,y){this._super(x,y);if(this.holdingBlock){var ts=G_TILESIZE;var posArray=[[x,y],[x,y-ts],[x,y+ts],[x-ts,y],[x+ts,y]];var pos=posArray[this.orientation];this.holdingBlock.setPosition(pos[0],pos[1])}},isInScreen:function(pos){return~~(Math.abs(this.x-pos[0])/G_TILESIZE)<=~~(G_SCREEN_WIDTH/2)&&~~(Math.abs(this.y-pos[1])/G_TILESIZE)<=~~(G_SCREEN_HEIGHT/2)},hasWeaponType:function(type){type=type||"any";if(type==="any")return true;var weapon=this.equipment.getWeapon();if(!weapon)return false;if(type){return this.getWeaponType()===type}return ItemTypes.isHarvestWeapon(weapon.itemKind)},getWeaponType:function(){var weapon=this.equipment.getWeapon();if(!weapon)return null;return ItemTypes.getType(weapon.itemKind)},setSprite:function(type,id){if(type===0){if(this.isArcher())this.sprites[2]=id;else this.sprites[0]=id}else if(type===1){if(this.isArcher())this.sprites[3]=id;else this.sprites[1]=id}},getSprite:function(type){var item=null;if(type===1){item=this.equipment.getWeapon();if(item){return ItemTypes.getSpriteCode(item.itemKind)}else{if(this.isArcher())return 50;else return 0}}else if(type===0){if(this.isArcher())return this.sprites[2];else return this.sprites[0]}},_harvest:function(x,y,callback,duration){var p=this;var valid=p._checkHarvest(x,y);if(!valid){p._abortHarvest(x,y);return}var px=p.x,py=p.y;var type=p.getWeaponType();p.isHarvesting=true;var exp=this.exp.logging;if(type==="hammer")exp=this.exp.mining;var durationMod=Utils.clamp(.1,1,1-Types.getSkillLevel(exp)/20);duration=~~(duration*durationMod);clearTimeout(p.harvestTimeout);p.harvestTimeout=setTimeout(function(){var complete=true;if(!p.isHarvesting)complete=false;if(!(p.x===px&&p.y===py))complete=false;if(!p.hasWeaponType(type))complete=false;if(!complete){p._abortHarvest(x,y);return}if(callback)callback(p);p.map.entities.sendNeighbours(p,new Messages.Harvest(p,2,x,y))},duration);p.map.entities.sendNeighbours(p,new Messages.Harvest(p,1,x,y),p);p.sendPlayer(new Messages.Harvest(p,1,x,y,duration))},_checkHarvest:function(x,y){var p=this;if(!p.isNextTooPosition(x,y))return false;if(!p.hasWeaponType())return false;return true},onHarvestEntity:function(entity){var self=this;var res=true;var type=entity.weaponType;if(!this.hasWeaponType(type)){this.sendPlayer(new Messages.Notify("CHAT","HARVEST_WRONG_TYPE",type));res=false}var x=entity.x,y=entity.y;if(!res){this._abortHarvest(x,y);return}var duration=5e3+entity.level*1e3;this._harvest(x,y,function(p){p.server.taskHandler.processEvent(p,PlayerEvent(EventType.USE_NODE,entity,1));if(type==="hammer")p.exp.mining+=10;entity.die();var item=p.world.loot.getDrop(p,entity,false);if(item&&item instanceof Item){item.x=x;item.y=y;p.world.loot.handleItemDespawn(item)}return},duration)},_abortHarvest:function(x,y){var p=this;p.map.entities.sendNeighbours(p,new Messages.Harvest(p,2,x,y));p.sendPlayer(new Messages.Notify("CHAT","HARVEST_INVALID"))},onHarvest:function(x,y){var p=this;var gp=Utils.getGridPosition(x,y);time=p.map.entities.harvest[gp.gx+"_"+gp.gy];var res=true;var type=p.getWeaponType();if(!type){res=false}if(!this.map.isHarvestTile(gp,type)){p.sendPlayer(new Messages.Notify("CHAT","HARVEST_WRONG_TYPE",type));res=false}if(time&&Date.now()-time<6e4){res=false}if(!res){this._abortHarvest(x,y);return}var duration=6e3;p._harvest(x,y,function(p){p.server.taskHandler.processEvent(p,PlayerEvent(EventType.HARVEST,p,1));if(p.getWeaponType()==="axe")p.exp.logging+=10;p.map.entities.harvest[gp.gx+"_"+gp.gy]=Date.now();if(p.inventory.hasRoom()){var kind;if(p.getWeaponType()==="axe")kind=320;var item=new ItemRoom([kind,1,0,0]);if(self.inventory.putItem(item)===-1)return;var data=ItemTypes.getData(item.itemKind);p.sendPlayer(new Messages.Notify("CHAT","HARVEST_ADDED",data.name))}},duration)},resetMove:function(x,y){this.fixMove(x,y);this.sendCurrentMove()},fixMove:function(x,y){this.forceStop();this.setPosition(x,y);this.sx=x;this.sy=y;this.ex=-1;this.ey=-1},sendPlayer:function(msg){this.map.entities.sendToPlayer(this,msg)},sendToPlayer:function(player,msg){this.map.entities.sendToPlayer(player,msg)},onKilled:function(callback){this.on_killed_callback=callback},onTeleport:function(callback){this.on_teleport_callback=callback},handleTeleport:function(){if(this.on_teleport_callback)this.on_teleport_callback()},hasMoveThrottled:function(delay){if(Date.now()-this.lastMoveThrottle<delay)return true;this.lastMoveThrottle=Date.now();return false},getXP:function(){return 20*this.level},setMap:function(map){this.map.entities.removeSpatial(this);this.packetHandler.setMap(map);this.map=map}})},{"../effecthandler":23,"../formulas":36,"../items/bank":37,"../items/equipment":39,"../items/inventory":40,"../message":49,"../packets/packethandler":51,"../playerquests":56,"../quest":58,"../skillhandler":59,"./character":24}],34:[function(require,module,exports){var Quest=require("./quest");var Messages=require("./message");module.exports=EntityQuests=cls.Class.extend({init:function(entity){this.entity=entity;this.questsCount=0;this.quests={}},acceptQuest:function(player,questId){if(!this.quests.hasOwnProperty(questId))return;var quest=this.quests[questId];pQuest=player.quests.getQuestById(parseInt(questId));if(pQuest){if(pQuest.status<QuestStatus.COMPLETE){pQuest.status=QuestStatus.INPROGRESS;player.quests.progressQuest(pQuest);return}}pQuest=Object.assign(new Quest,quest);pQuest.data=quest.data;player.quests.foundQuest(pQuest)},rejectQuest:function(player,questId){},giveReward:function(player,quest){var pquest=player.quests.completeQuests[quest.id];if(!pquest)return false;if(!pquest.hasOwnProperty("reward")){var count=player.inventory.hasRoomCount();if(quest.reward.length>0&&count<quest.reward.length){player.sendPlayer(new Messages.Notify("INVENTORY","INVENTORY_FULL"));return false}var msg=new Messages.Dialogue(this.entity,"QUESTS_REWARD",[this.entity.name]);player.sendPlayer(msg);if(quest.gold>0)player.modifyGold(parseInt(quest.gold));for(var reward of quest.reward){var item=new ItemRoom([parseInt(reward.itemKind),parseInt(reward.itemNumber)||1,parseInt(reward.itemDurability)||null,parseInt(reward.itemDurabilityMax)||null,parseInt(reward.itemExperience)||0]);player.inventory.putItem(item);var msg=new Messages.Notify("CHAT","ITEM_ADDED",[ItemData.Kinds[item.itemKind].name]);player.sendPlayer(msg)}pquest.reward=1;return true}return false},hasQuest:function(player){for(var quest of player.quests.quests){if(this.entity.npcQuestId===quest.npcQuestId){player.quests.progressQuest(quest);return true}}for(var id in this.quests){var quest=this.quests[id];if(player.quests.hasNpcCompleteQuest(quest.npcQuestId)){if(this.giveReward(player,quest)){return true}}}return false},getNextQuestId:function(player){for(var qid in this.quests){if(player.quests.completeQuests[qid])continue;var pq=player.quests.getQuestById(qid);if(pq)continue;return qid}return null},sendNoQuest:function(player){var entity=this.entity;var msg=new Messages.Dialogue(entity,"QUESTS_NONE",[entity.nextNpcDir,entity.nextNpcName,entity.name]);player.sendPlayer(msg)},dynamicQuests:function(player){if(this.hasQuest(player))return;this.createQuest(player);return},getMobObject:function(){var entities=self.map.entities.getMobsAround(this.entity,35);if(entities.length===0)return;var entitycount=Utils.GetGroupCountArray(entities,"kind");console.warn("entitycount="+JSON.stringify(entitycount));if(entitycount.length===0)return null;log.info("entitycount="+JSON.stringify(entitycount));entitycount.sort(function(a,b){return b[1]-a[1]});log.info("entitycount="+JSON.stringify(entitycount));var kind=parseInt(entitycount[0][0]);entities=entities.filter(function(entity){return entity.kind===kind});var minLevel=Utils.minProp(entities,"level").level;var mobCount=parseInt(entitycount[0][1]);if(mobCount<=0)return null;if(!MobData.Kinds[kind])return null;return getQuestObject([Types.EntityTypes.MOB,kind,mobCount,0,minLevel,100])},createQuest:function(player){var qTypes=[1,2];var questType=qTypes[Utils.randomInt(qTypes.length-1)];var pLvl=player.level;if(questType===QuestType.GETITEMKIND){this.createQuestItemKind(player)}if(questType===QuestType.KILLMOBKIND){this.createQuestKillMobKind(player)}},createQuestItemKind:function(player){console.info("GETITEMKIND");var itemKind=Utils.randomInt(ItemLootData.ItemLoot.length-1);var id="02"+Utils.pad(this.entity.kind,6)+Utils.pad(this.questsCount++,4);var quest=player.quests.getQuestById(id);if(!quest){var mobObject=this.getMobObject();if(!mobObject)return;mobObject.count=0;var itemCount=Utils.randomRangeInt(1,5);var itemChance=30*itemCount/(player.level+2);var itemObject=getQuestObject([Types.EntityTypes.ITEMLOOT,itemKind,itemCount,itemChance]);quest=new Quest([id,QuestType.GETITEMKIND,this.entity.npcQuestId,0,0,0,0,mobObject,itemObject]);player.quests.foundQuest(quest)}else{quest.status=QuestStatus.INPROGRESS;player.quests.questAboutItem(quest)}},createQuestKillMobKind:function(player){console.info("KILLMOBKIND");var id="01"+Utils.pad(this.entity.kind,6)+Utils.pad(this.questsCount++,4);var quest=player.quests.getQuestById(id);if(!quest){var mobObject=this.getMobObject();if(!mobObject)return;var lw=5;var lh=Math.max(player.level-10,10);mobObject.count=Utils.clamp(lw,lh,mobObject.count/2);mobObject.count=Math.ceil(mobObject.count/5)*5;quest=new Quest([id,QuestType.KILLMOBKIND,this.entity.npcQuestId,0,0,0,0,mobObject]);player.quests.foundQuest(quest)}else{quest.status=QuestStatus.INPROGRESS;player.quests.progressQuest(quest)}}})},{"./message":49,"./quest":58}],35:[function(require,module,exports){var _=require("underscore");var itemKindMax=999;var itemNumberMax=100;var itemDurabilityMax=1e3;var itemExperienceMax=9999999;var itemPriceMax=99999999;var itemStoreMax=96;var itemInventoryMax=50;var itemBankMax=96;var itemEquipmentMax=5;var itemStoreTypeMax=2;var craftIdMax=99;var craftItemCount=100;var auctionEntriesMax=9999;var auctionActionMax=3;var achievementIndexMax=99;var achievementRankMax=10;var achievementCountMax=999999;var skillsXPMax=999999999;var mapsCountMax=10;var mapCoordsMax=16384;var orientationsMax=4;var entityIdMax=99999;var mapStatusMax=3;var questCountMax=999;var questIdMax=999999999999999;var questTypeMax=9;var questNpcIdMax=100;var questCountMax=99;var questStatusMax=5;var questStrDataLen=32;var questObjectTypeMax=9;var questObjectKindMax=999;var questObjectCountMax=999;var questObjectChanceMax=2e3;var questObjectLevelMax=999;var entityTypeNPCMin=5;var entityTypeNPCMax=6;var shortcutIndexMax=8;var shortcutTypeMax=2;var shortcutTypeIdMax=999;var usernameLenMin=2;var usernameLenMax=16;var userHashLenMin=120;var userHashLenMax=120;var playerHashLenMax=128;var playerNameLenMin=2;var playerNameLenMax=16;var playerColorsMaxLen=6;var playerSpritesMax=999;var playerPVPStatsMax=999999;var playerXpMax=999999999;var playerSkillXpMax=999999999;var playerStatPointsMax=1e3;var playerStatFreePointsMax=6e3;var playerGoldMax=999999999;var playerGemMax=99999;var playerLooksTotal=177;var playerLooksTotalCost=1e4;var playerStatMax=5;var playerSkillMax=50;var playerPartyMax=6;var playerShortcutsMax=7;var playerShortcutsType=2;var worldNameLenMin=2;var worldNameLenMax=16;var worldUsersCountMin=2;var worldUsersCountMax=1e3;var userServerPasswordLenMin=10;var userServerPasswordLenMax=128;var maxWorldCount=10;var maxPlayersPerUser=20;var worldKeyLenMin=2;var worldKeyLenMax=16;var serverAddressLenMin=7;var serverAddressLenMax=15;var serverPortMin=1024;var serverPortMax=65535;var serverProtocolLenMin=2;var serverProtocolLenMax=2;var userBansTotal=1e3;var banDateMin=173e10;var banDateMax=18e11;var serverDateMin=173e10;var serverDateMax=18e11;var maxChatLength=256;var isTypeValid=function(fmt,msg){if(Array.isArray(fmt)){var res=_isTypeValid(fmt[0],msg);if(!res){return false}if(fmt[0]==="no"||fmt[0]==="so"){return true}var cfn=fmt[0]==="n"&&msg>=fmt[1]&&msg<=fmt[2];if(cfn){return true}var cfs=fmt[0]==="s"&&msg.length>=fmt[1]&&msg.length<=fmt[2];if(cfs){return true}var cfa=fmt[0]==="array"&&msg.length>=fmt[1]&&msg.length<=fmt[2];if(cfa){return true}var cfo=fmt[0]==="object"&&Object.keys(msg).length>=fmt[1]&&Object.keys(msg).length<=fmt[2];if(cfo){return true}}else{return _isTypeValid(fmt,msg)}};var _isTypeValid=function(fmt,msg){if(fmt==="n"&&_.isNumber(Number(msg))){return true}if(fmt==="s"&&_.isString(msg)){return true}if(fmt==="no"&&(_.isNull(msg)||_.isNumber(Number(msg)))){return true}if(fmt==="so"&&(_.isNull(msg)||_.isString(msg))){return true}if(fmt==="array"&&Array.isArray(msg)){return true}if(fmt==="object"&&typeof msg==="object"){return true}console.info("isType not type or invalid.");console.info("fmt:"+fmt);console.info("msg:"+JSON.stringify(msg));return false};(function(){FormatChecker=Class.extend({init:function(){this.formats={};this.formats[Types.Messages.BI_SYNCTIME]=[["n",serverDateMin,serverDateMax]],this.formats[Types.Messages.CW_CREATE_USER]=[["s",usernameLenMin,usernameLenMax],["s",userHashLenMin,userHashLenMax]],this.formats[Types.Messages.CW_LOGIN_USER]=[["s",usernameLenMin,usernameLenMax],["s",userHashLenMin,userHashLenMax]],this.formats[Types.Messages.CW_REMOVE_USER]=[["s",usernameLenMin,usernameLenMax],["s",userHashLenMin,userHashLenMax]],this.formats[Types.Messages.CW_CREATE_PLAYER]=[["n",0,maxPlayersPerUser],["s",playerNameLenMin,playerNameLenMax]],this.formats[Types.Messages.CW_LOGIN_PLAYER]=[["s",playerNameLenMin,playerNameLenMax],["s",0,playerHashLenMax]],this.formats[Types.Messages.CW_APPEARANCEUNLOCK]=[["n",0,playerLooksTotal],["n",0,playerGemMax]],this.formats[Types.Messages.CW_ATTACK]=[["n",serverDateMin,serverDateMax],["n",0,entityIdMax],["n",0,orientationsMax],["n",-1,playerSkillMax]],this.formats[Types.Messages.CW_AUCTIONBUY]=[["n",0,auctionEntriesMax],["n",0,auctionActionMax]],this.formats[Types.Messages.CW_AUCTIONDELETE]=[["n",0,auctionEntriesMax],["n",0,auctionActionMax]],this.formats[Types.Messages.CW_AUCTIONOPEN]=[["n",0,auctionActionMax]],this.formats[Types.Messages.CW_AUCTIONSELL]=[["n",0,itemInventoryMax],["n",0,itemPriceMax]],this.formats[Types.Messages.CW_BANKRETRIEVE]=[["n",0,itemBankMax]],this.formats[Types.Messages.CW_BANKSTORE]=[["n",0,itemInventoryMax]],this.formats[Types.Messages.CW_CHAT]=[["s",1,maxChatLength]],this.formats[Types.Messages.CW_COLOR_TINT]=[["n",0,1],["s",playerColorsMaxLen,playerColorsMaxLen]],this.formats[Types.Messages.CW_BLOCK_MODIFY]=[["n",0,1],["n",0,entityIdMax],["n",0,mapCoordsMax],["n",0,mapCoordsMax]],this.formats[Types.Messages.CW_LOOKUPDATE]=[["n",0,1],["n",0,playerSpritesMax]],this.formats[Types.Messages.CW_LOOT]=[["n",0,entityIdMax],["n",0,mapCoordsMax],["n",0,mapCoordsMax]],this.formats[Types.Messages.CW_MOVE]=[["n",serverDateMin,serverDateMax],["n",0,entityIdMax],["n",0,2],["n",0,orientationsMax],["n",0,mapCoordsMax],["n",0,mapCoordsMax]],this.formats[Types.Messages.CW_GOLD]=[["n",0,1],["n",0,playerGoldMax],["n",0,1]],this.formats[Types.Messages.CW_STATADD]=[["n",1,playerStatMax],["n",1,1]],this.formats[Types.Messages.CW_STOREBUY]=[["n",1,3],["n",0,itemKindMax],["n",0,itemNumberMax]],this.formats[Types.Messages.CW_CRAFT]=[["n",0,craftIdMax],["n",0,craftItemCount]],this.formats[Types.Messages.CW_STORE_MODITEM]=[["n",0,2],["n",0,2],["n",0,itemInventoryMax]],this.formats[Types.Messages.CW_STORESELL]=[["n",0,itemStoreTypeMax],["n",0,itemInventoryMax]],this.formats[Types.Messages.CW_TALKTONPC]=[["n",entityTypeNPCMin,entityTypeNPCMax],["n",0,entityIdMax]],this.formats[Types.Messages.CW_TELEPORT_MAP]=[["n",0,mapStatusMax],["n",0,1],["n",-1,mapCoordsMax],["n",-1,mapCoordsMax]],this.formats[Types.Messages.CW_SKILL]=[["n",0,playerSkillMax],["n",0,entityIdMax]],this.formats[Types.Messages.CW_SHORTCUT]=[["n",0,playerShortcutsMax],["n",0,playerShortcutsType],["n",0,itemKindMax]],this.formats[Types.Messages.CW_PARTY]=[["n",0,4],["so",0,playerPartyMax],["no",0,3]],this.formats[Types.Messages.CW_HARVEST]=[["n",0,mapCoordsMax],["n",0,mapCoordsMax]],this.formats[Types.Messages.CW_USE_NODE]=[["n",0,entityIdMax]],this.formats[Types.Messages.CW_QUEST]=[["n",0,entityIdMax],["n",0,questIdMax],["n",0,questTypeMax]],this.formats[Types.Messages.CW_MOVEPATH]=[["n",serverDateMin,serverDateMax],["n",0,entityIdMax],["n",0,orientationsMax],["n",0,1],["array",2,16,[["n",0,mapCoordsMax],["n",0,mapCoordsMax]]]],this.formats[Types.Messages.CW_WHO]=[["array",0,999,[["n",0,entityIdMax]]]];this.formats[Types.Messages.CW_REQUEST]=[["n",0,3]]},checkFormatData:function(fmt,msg){var tfmt=Array.isArray(fmt)?fmt[0]:fmt;var t=isTypeValid(tfmt,msg);if(!t){console.info("isType not type or invalid.");return false}var cfa=fmt[0]==="array";if(cfa){console.info("format is Array and in length.");if(fmt[3]){for(var i=0;i<msg.length;++i){var res=this.checkFormat(fmt[3],[msg[i]],true);if(!res)return false}}}var cfo=fmt[0]==="object";if(cfo){console.info("format is Object and in keys range.");if(fmt[3]){for(var id in msg[i]){var res=this.checkFormat(fmt[3],msg[i][id]);if(!res)return false}}}return true},checkFormat:function(format,message,ignoreLength){var self=this;var ignoreLength=ignoreLength||false;if(format){console.info("message:"+message);console.info("format:"+format);if(!ignoreLength&&message.length!==format.length){console.info("checkFormat - length incorrect. fmt:"+JSON.stringify(message)+", msg:"+JSON.stringify(format));return false}var fmt=Array.isArray(format[0])?format[0][0]:format[0];if(fmt==="array"&&Array.isArray(message)&&message.length===0){return Array.isArray(fmt)?fmt[1]===0:true}if(fmt==="object"&&typeof message==="object"&&Object.keys(message).length===0){return Array.isArray(fmt)?fmt[1]===0:true}for(var i=0,n=format.length;i<n;i+=1){var res=this.checkFormatData(format[i],message[i]);if(!res)return false}return true}else{console.error("Unknown message type. ");console.warn("message: "+JSON.stringify(message));console.warn("format: "+JSON.stringify(format));return false}},check:function(msg){var self=this;console.info("msg:"+JSON.stringify(msg));var message=msg.slice(0);var type=message.shift();var format=this.formats[type];console.info("msg: "+JSON.stringify(message));console.info("type: "+type);if(format){console.info("checkFormat type:"+type);var res=this.checkFormat(format,message,true);return res}else if(type===Types.Messages.CW_ITEMSLOT){console.info("type CW_ITEMSLOT");var format=[["n",0,2],["n",0,2],["n",-1,this.inventoryMax],["n",0,this.itemCountMax]];if(message.len===7){format=format.concat([["no",0,2],["no",-1,this.inventoryMax],["no",0,this.itemCountMax]])}return this.checkFormat(format,message,true)}else{try{throw new Error}catch(err){console.info(err.stack)}console.error("Unknown message type: "+type);console.warn("msg="+JSON.stringify(msg));return false}}});var checker=new FormatChecker;exports.check=checker.check.bind(checker)})()},{underscore:310}],36:[function(require,module,exports){var Formulas={};Formulas.crit=function(attacker,defender){var chance=Utils.randomRangeInt(0,200)<=Utils.clamp(5,195,~~(25+attacker.baseCrit()-defender.baseCritDef()));return chance};Formulas.getAttackPower=function(attacker){var attackPower=1;if(attacker.attackTimer){var delay=Date.now()-attacker.attackTimer;attackPower=~~(Utils.clamp(ATTACK_INTERVAL,ATTACK_MAX,delay)/ATTACK_INTERVAL)}return attackPower};Formulas.dmgAOE=function(attacker){var attackPower=Formulas.getAttackPower(attacker);var attacker_damage=~~(attacker.baseDamage()/2);console.info("attacker baseDamage="+attacker_damage);var dmg=~~(attacker_damage*attackPower);if(attacker instanceof Player&&dmg>0)attacker.incAttackExp(dmg);return~~dmg};Formulas.dmg=function(attacker,defender){var attackPower=Formulas.getAttackPower(attacker);var attacker_damage=attacker.baseDamage(defender);var defender_defense=defender.baseDamageDef(attacker);console.info("attacker baseDamage="+attacker_damage);console.info("defender baseDamageDef="+defender_defense);var dmg=~~(attacker_damage*attackPower);var defensePower=2/3*Math.pow(1.5,attackPower);var def=~~(defender_defense*defensePower);dmg=~~(dmg-def);if(attacker instanceof Mob)dmg=~~Math.pow(dmg,.9);dmg=Utils.clamp(1,5e3,dmg);if(attacker instanceof Player&&dmg>0)attacker.incAttackExp(dmg);if(defender instanceof Player&&dmg>0)defender.incDefenseExp(dmg);return~~dmg};Formulas.pickPocket=function(source,target,chance){if(target.level-source.level+~~Utils.randomRange(0,100)<=chance)return true;return false};Formulas.mindControl=function(source,target){if(target.level<=source.level&&~~Utils.randomRange(0,~~(target.level*50/source.level))===0)return true;return false};Formulas.hp=function(entityLevel){return 100+entityLevel*40};Formulas.energy=function(entityLevel){return 100+entityLevel*30};Formulas.getExpArray=function(){};if(!(typeof exports==="undefined")){module.exports=Formulas}},{}],37:[function(require,module,exports){var ItemRoomStore=require("./itemroomstore");var Messages=require("../message");module.exports=Bank=ItemRoomStore.extend({init:function(owner,number,items){this._super(owner,number,items);this.typeIndex=1;this.maxNumber=96;this.fullMessage=new Messages.Notify("BANK","BANK_FULL")}})},{"../message":49,"./itemroomstore":42}],38:[function(require,module,exports){var cls=require("../lib/class");module.exports=BaseItem=cls.Class.extend({init:function(arr){if(Array.isArray(arr))this.set(arr)},assign:function(item){this.set([Number(item.itemKind),Number(item.itemNumber),Number(item.itemDurability),Number(item.itemDurabilityMax),Number(item.itemExperience)])},set:function(arr){var itemKind=Number(arr[0]);this.itemKind=itemKind;this.itemNumber=Number(arr[1]);this.itemDurability=arr[2]?Number(arr[2]):ItemTypes.isConsumableItem(itemKind)||ItemTypes.isCraftItem(itemKind)?0:900;this.itemDurabilityMax=arr[3]?Number(arr[3]):ItemTypes.isConsumableItem(itemKind)||ItemTypes.isCraftItem(itemKind)?0:900;this.itemExperience=Number(arr[4])||0},addNumber:function(number){this.itemNumber+=Number(number)},save:function(){return this.toArray().join(",")},toArray:function(){var cols=[this.itemKind,this.itemNumber,this.itemDurability,this.itemDurabilityMax,this.itemExperience];return cols}})},{"../lib/class":44}],39:[function(require,module,exports){var ItemRoom=require("./itemroom"),Messages=require("../message");module.exports=Equipment=cls.Class.extend({init:function(owner,number,items){this.owner=owner;this.number=number;this.maxNumber=5;this.weaponSlot=4;this.rooms={};console.info("number="+number);console.info("itemSlots="+JSON.stringify(items));if(items){for(var i=0;i<items.length;i++){var index=items[i].slot;this.rooms[index]=items[i]}}},makeEmptyItem:function(index){this.rooms[index]=null;delete this.rooms[index];this.setItem(index,null)},getItemIndex:function(itemKind){for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind===itemKind){return i}}return-1},putItem:function(item){return-1},combineItem:function(item,item2){return false},checkItem:function(index,item){if(!item)return true;var kind=item.itemKind;var data=ItemData.Kinds[kind];if(!ItemTypes.isEquipment(kind))return false;if(index==0&&!(data.type==="helm"&&this.canEquip(item,data.level)))return false;if(index==1&&!(data.type==="chest"&&this.canEquip(item,data.level)))return false;if(index==2&&!(data.type==="gloves"&&this.canEquip(item,data.level)))return false;if(index==3&&!(data.type==="boots"&&this.canEquip(item,data.level)))return false;if(index==4&&!(ItemTypes.isWeapon(kind)&&this.canEquip(item,ItemTypes.getWeaponLevel(kind))))return false;return true},setItem:function(index,item){this._setItem(index,item)},getItemTypeIndex:function(item){if(item){var kind=item.itemKind;var data=ItemData.Kinds[kind];if(data.type==="helm")return 0;else if(data.type==="chest")return 1;else if(data.type==="gloves")return 2;else if(data.type==="boots")return 3;else if(ItemTypes.isWeapon(kind))return 4}return-1},_setItem:function(index,item){if(item&&this.rooms[index]===item)return false;var player=this.owner;if(!item){this.rooms[index]=null;item={slot:index,itemKind:-1}}else{if(!this.checkItem(index,item))return false;this.rooms[index]=item;item.slot=index}player.sendPlayer(new Messages.ItemSlot(2,[item]));return true},canEquip:function(item,level){var player=this.owner;var kind=item.itemKind;if(level>player.level){player.sendPlayer(new Messages.Notify("EQUIP","EQUIPMENT_LEVEL",[level]));return false}return true},save:function(){},degradeItem:function(slot,adjustment){var item=this.rooms[slot];if(!item)return;item.itemDurability-=adjustment;item.itemDurability=Math.max(0,item.itemDurability);if(item.itemDurability===0&&item.itemDurabilityMax<=30){this.makeEmptyEquipment(slot);return false}this.owner.sendPlayer(new Messages.ItemSlot(2,[item]));return true},addExperience:function(slot,adjustment){var item=this.rooms[slot];if(!item)return;item.itemExperience+=adjustment;var oldItemNumber=item.itemNumber;var newItemNumber=ItemTypes.getItemLevel(item.itemExperience);if(oldItemNumber<newItemNumber){item.itemNumber++;this.owner.sendPlayer(new Messages.ItemLevelUp(slot,item))}item.slot=slot;this.owner.sendPlayer(new Messages.ItemSlot(2,[item]))},toString:function(){var i=0;var itemString=""+this.maxNumber+",";for(var i in this.rooms){var item=this.rooms[i];if(!item)continue;itemString+=item.toArray().join(",")}return itemString},toStringJSON:function(){var itemString="[";var isItems=false;for(var i=0;i<this.maxNumber;i++){var item=this.rooms[i];if(!item)continue;itemString+="["+item.toArray().join(",")+"],";isItems=true}itemString=itemString.slice(0,-1);itemString+="]";if(!isItems)return"[]";return itemString},getWeapon:function(){return this.rooms[4]},getArmor:function(){return this.rooms[1]}})},{"../message":49,"./itemroom":41}],40:[function(require,module,exports){var ItemRoomStore=require("./itemroomstore");var Messages=require("../message");module.exports=Inventory=ItemRoomStore.extend({init:function(owner,number,items){this._super(owner,number,items);this.typeIndex=0;this.maxNumber=50;this.fullMessage=new Messages.Notify("INVENTORY","INVENTORY_FULL")}})},{"../message":49,"./itemroomstore":42}],41:[function(require,module,exports){var BaseItem=require("./baseitem");module.exports=ItemRoom=BaseItem.extend({init:function(arr){this.slot=-1;this._super(arr)},toRedis:function(){return this.toArray().join(",")},toArray:function(){var cols=[parseInt(this.slot)].concat(this._super());return cols},toArrayNoSlot:function(){var arr=this.toArray();arr.shift();return arr}})},{"./baseitem":38}],42:[function(require,module,exports){var cls=require("../lib/class"),ItemRoom=require("./itemroom"),Messages=require("../message");module.exports=ItemStore=cls.Class.extend({init:function(owner,number,items){this.owner=owner;this.number=number;this.typeIndex=0;this.maxNumber=50;this.maxStack=100;this.fullMessage=new Messages.Notify("ITEMSTORE","ITEMSTORE_FULL");this.rooms={};console.info("number="+number);if(items){for(var i=0;i<items.length;i++){this.rooms[items[i].slot]=items[i]}}},hasItem:function(itemKind){return this.hasItems(itemKind,1)},hasItems:function(itemKind,itemCount){var a=0;for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind===itemKind){a+=this.rooms[i].itemNumber;if(a>=itemCount)return true}}return false},hasItemCount:function(itemKind){var a=0;for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind===itemKind){a+=this.rooms[i].itemNumber}}return a},hasRoomCount:function(start,end){start=start||0;end=end||this.maxNumber;return this.maxNumber-Object.keys(this.rooms).length},hasRoom:function(start,end){start=start||0;end=end||this.maxNumber;return Object.keys(this.rooms).length<this.maxNumber},makeEmptyItem:function(index){this.rooms[index]=null;delete this.rooms[index];this.setItem(index,null)},getItemCount:function(itemKind){for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind===itemKind){return this.rooms[i].itemNumber}}return 0},getItemIndex:function(itemKind){for(var i in this.rooms){if(this.rooms[i]&&this.rooms[i].itemKind===itemKind){return i}}return-1},getEmptyIndex:function(start,end){start=start||0;end=end||this.maxNumber;for(var index=start;index<end;index++){if(!this.rooms[index]){return index}}return-1},putItem:function(item){var kind=item.itemKind;var consume=ItemTypes.isConsumableItem(kind);var loot=ItemTypes.isLootItem(kind);var craft=ItemTypes.isCraftItem(kind);if(consume||loot||craft){for(var i in this.rooms){if(this.combineItem(item,this.rooms[i]))return i}}return this._putItem(item)},combineItem:function(item,item2){console.info(JSON.stringify(item));console.info(JSON.stringify(item2));if(!item||!item2)return false;if(item.itemKind!==item2.itemKind)return false;if(ItemTypes.isEquippable(item.itemKind)||ItemTypes.isEquippable(item2.itemKind)){return false}if(item.itemNumber===this.maxStack)return false;if(item2.itemNumber===this.maxStack)return false;var res=false;var slot=item.slot;var slot2=item2.slot;var maxStack=this.maxStack;if(item2.itemNumber<maxStack){item2.itemNumber+=item.itemNumber;if(item2.itemNumber>maxStack){item.itemNumber=item2.itemNumber-maxStack;item2.itemNumber=Math.min(item2.itemNumber,maxStack);if(item.slot===-1)slot=this.getEmptyIndex()}else{item=null}res=true}if(item2.itemNumber<=0){item2=null}this.setItem(slot,item);this.setItem(slot2,item2);return res},_putItem:function(item){i=this.getEmptyIndex();if(i<0){if(this.owner instanceof Player)this.owner.sendPlayer(this.fullMessage);return-1}else{this.setItem(i,item);return i}},checkItem:function(index,item){return item},setItem:function(index,item){if(!item){this.rooms[index]=null;item={slot:index,itemKind:-1}}else{if(!this.checkItem(index,item))return false;this.rooms[index]=item;item.slot=index}this.owner.sendPlayer(new Messages.ItemSlot(this.typeIndex,[item]));return true},save:function(){},removeItemKind:function(kind,number){var j=number;for(var i in this.rooms){var r=this.rooms[i];if(!r)continue;if(r.itemKind===kind){if(r.itemNumber>j){r.itemNumber-=j;this.setItem(i,r);return true}else{j-=r.itemNumber;r=null}this.setItem(i,r)}}return false},takeOutItems:function(index,number){var item=this.rooms[index];if(!item)return null;if(number>item.itemNumber)return null;if(ItemTypes.isEquippable(item.itemKind)){this.setItem(index,null);return item}item.itemNumber-=number;if(item.itemNumber===0)item=null;this.setItem(index,item);return item},getRandomItemNumber:function(){var item=null;var itemNums=[];for(var i in this.rooms){item=this.rooms[i];if(item&&item.itemKind>0)itemNums.push(id)}var rand=Utils.randomRange(0,itemNums.length-1);return itemNums.length>0?itemNums[rand]:-1},toString:function(){var i=0;var itemString=""+this.maxNumber+",";for(var i in this.rooms){var item=this.rooms[i];if(!item)continue;itemString+=item.toArray().join(",")}return itemString},toStringJSON:function(){var item=null;var items=[];for(var i in this.rooms){item=this.rooms[i];if(!item)continue;items.push(item.toArray())}return JSON.stringify(items)}})},{"../lib/class":44,"../message":49,"./itemroom":41}],43:[function(require,module,exports){var Utils=require(".././utils");module.exports=AStar=function(){
/**
     * Advanced A* (A-Star) algorithm for a path finder.
     * This does pixel based path finding, for map grids and is an advance
     * on the original authors code.
     *
     * @originalAuthor  Andrea Giammarchi
     * @revisedAuthor  Langerz82
     * @license Mit Style License.
     */
var asGridCellSize=16;var gGrid=null;function diagonalSuccessors($N,$S,$E,$W,N,S,E,W,grid,rows,cols,result,i){if($N){$E&&!grid[N][E]&&(result[i++]={x:E,y:N});$W&&!grid[N][W]&&(result[i++]={x:W,y:N})}if($S){$E&&!grid[S][E]&&(result[i++]={x:E,y:S});$W&&!grid[S][W]&&(result[i++]={x:W,y:S})}return result}function diagonalSuccessorsFree($N,$S,$E,$W,N,S,E,W,grid,rows,cols,result,i){$N=N>-1;$S=S<rows;$E=E<cols;$W=W>-1;if($E){$N&&!grid[N][E]&&(result[i++]={x:E,y:N});$S&&!grid[S][E]&&(result[i++]={x:E,y:S})}if($W){$N&&!grid[N][W]&&(result[i++]={x:W,y:N});$S&&!grid[S][W]&&(result[i++]={x:W,y:S})}return result}function nothingToDo($N,$S,$E,$W,N,S,E,W,grid,rows,cols,result,i){return result}function grids(coord){return gGrid[~~coord[0]][~~coord[1]]}function successors(find,x,y,grid,rows,cols){x=~~x+.5;y=~~y+.5;var N=y-1,S=y+1,E=x+1,W=x-1,$N=N>0&&!grids([N,x]),$S=S<rows&&!grids([S,x]),$E=E<cols&&!grids([y,E]),$W=W>0&&!grids([y,W]),result=[],i=0;$N&&(result[i++]={x:x,y:N});$E&&(result[i++]={x:E,y:y});$S&&(result[i++]={x:x,y:S});$W&&(result[i++]={x:W,y:y});return find($N,$S,$E,$W,N,S,E,W,grid,rows,cols,result,i)}function diagonal(start,end,f1,f2){return f2(f1(start.x-end.x),f1(start.y-end.y))}function euclidean(start,end,f1,f2){var x=start.x-end.x,y=start.y-end.y;return f2(x*x+y*y)}function manhattan(start,end,f1,f2){return f1(start.x-end.x)+f1(start.y-end.y)}function getDir(n1,n2){if(n1.x<n2.x)return 1;if(n1.x>n2.x)return 2;if(n1.y<n2.y)return 3;if(n1.y>n2.y)return 4;return 0}function AStar(grid,start,end,f){gGrid=grid;var cols=grid[0].length,rows=grid.length,limit=cols*rows,f1=Math.abs,f2=Math.max,list={},result=[],open=[{x:~~start[0],y:~~start[1],f:0,g:0,v:start[0]+start[1]*cols}],length=1,adj,distance,find,i,j,max,min,current,next,endnode={x:~~end[0],y:~~end[1],v:~~end[0]+~~end[1]*cols};switch(f){case"Diagonal":find=diagonalSuccessors;case"DiagonalFree":distance=diagonal;break;case"Euclidean":find=diagonalSuccessors;case"EuclideanFree":f2=Math.sqrt;distance=euclidean;break;default:distance=manhattan;find=nothingToDo;break}find||(find=diagonalSuccessorsFree);do{max=limit;min=0;for(i=0;i<length;++i){if((f=open[i].f)<max){max=f;min=i}}current=open.splice(min,1)[0];if(current.v!==endnode.v){--length;next=successors(find,current.x,current.y,grid,rows,cols);for(i=0,j=next.length;i<j;++i){adj=next[i];adj.p=current;adj.f=adj.g=0;adj.v=~~adj.x+~~adj.y*cols;if(!(adj.v in list)){var extra=0;if(current){adj.dir=getDir(adj,current);if(typeof current.dir!=="undefined"&&current.dir!=adj.dir)extra=10}adj.g=current.g+distance(adj,current,f1,f2)+extra;adj.f=adj.g+distance(adj,endnode,f1,f2);open[length++]=adj;list[adj.v]=1}}}else{i=length=0;do{result[i++]=[current.x,current.y]}while(current=current.p);var fn=function(node,result){result.shift();result.unshift([node[0],node[1]]);var it2=null;for(var it of result){if(it2){if(~~it2[0]===~~it[0])it[0]=it2[0];else if(~~it2[1]===~~it[1])it[1]=it2[1];else{break}}it2=it}};fn(end,result);result.reverse();fn(start,result)}}while(length);if(result.length>2){for(var i=2;i<result.length;++i){var n1=result[i-2];var n2=result[i];var tx=Math.abs(n1[0]-n2[0]);var ty=Math.abs(n1[1]-n2[1]);if(tx>0&&ty===0||tx===0&&ty>0){result.splice(--i,1)}}}return result}return{AStar:AStar}}();return AStar},{".././utils":66}],44:[function(require,module,exports){var initializing=false,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Class=function(){};Class.extend=function(prop){var _super=this.prototype;initializing=true;var prototype=new this;initializing=false;for(var name in prop){prototype[name]=typeof prop[name]==="function"&&typeof _super[name]==="function"&&fnTest.test(prop[name])?function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret}}(name,prop[name]):prop[name]}Class=function(){if(!initializing&&this.init)this.init.apply(this,arguments)};Class.prototype=prototype;Class.constructor=Class;Class.extend=arguments.callee;return Class};if(!(typeof exports==="undefined")){exports.Class=Class}},{}],45:[function(require,module,exports){(function(__dirname){(function(){require("./common");require("./data/data");var Log=require("log");var fs=require("fs");var util=require("util");var crypto=require("crypto");var BISON=require("bison");var useBison=false;var WS=require("./ws");var ProductionConfig=require("./productionconfig");var UserHandler=require("./user/userhandler");var WorldHandler=require("./user/worldhandler");var UserMessages=require("./user/usermessage");var _=require("underscore");var readline=require("readline").createInterface({input:process.stdin,output:process.stdout});let packageName="com.retrorpgonline2";let IO_STATES={MSG_BUYPRODUCT:1,MSG_ERRORPRODUCT:2};G_LATENCY=75;G_ROUNDTRIP=G_LATENCY*2;G_TILESIZE=16;G_FRAME_INTERVALS=2;G_FRAME_INTERVAL_EXACT=1e3/60;G_FRAME_INTERVAL=~~G_FRAME_INTERVAL_EXACT;G_UPDATE_INTERVAL=~~(G_FRAME_INTERVAL*G_FRAME_INTERVALS);G_INTERVAL=G_UPDATE_INTERVAL*G_FRAME_INTERVALS;G_SPATIAL_SIZE=32;G_SCREEN_WIDTH=34;G_SCREEN_HEIGHT=18;ATTACK_INTERVAL=1e3;ATTACK_MAX=3e3;PLAYER_SAVE_INTERVAL=18e5;mobState={IDLE:1,ROAMING:2,AGGRO:3,CHASING:4,ATTACKING:5,RETURNING:6,STUCK:7};SAVING_SERVER=false;AUCTION_SAVED=false;PLAYERS_SAVED=false;LOOKS_SAVED=false;IS_EXITING=false;var userHandler=null;server=null;world=null;users={};hashes={};var Main={};userHandlerPackets=[];module.exports=Main;var log_file=fs.createWriteStream(__dirname+"/../console.log",{flags:"w"});var log_stdout=process.stdout;function main(config){log=new Log(Log.INFO||Log.DEBUG||Log.ERROR);console.isEnabled=true;Object.defineProperty(log,"log",{value:undefined,writable:true,enumerable:true});Object.defineProperty(log,"info",{value:undefined,writable:true,enumerable:true});Object.defineProperty(log,"warn",{value:undefined,writable:true,enumerable:true});Object.defineProperty(log,"error",{value:undefined,writable:true,enumerable:true});var self=this;log.log=function(d){var txt="LOG: "+util.format(d)+"\n";console.info(txt)};log.info=function(d){var txt="INFO: "+util.format(d)+"\n";console.info(txt)};log.warn=function(d){var txt="WARN: "+util.format(d)+"\n";console.warn(txt)};log.error=function(d){var txt="ERROR: "+util.format(d)+"\n";console.error(txt)};var production_config=new ProductionConfig(config);if(production_config.inProduction()){_.extend(config,production_config.getProductionSettings())}var worldId=config.world_id;MainConfig=config;var ws=require("./ws");var WorldServer=require("./worldserver");server=new ws.WebsocketServer(config);var lastTotalPlayers=0;var self=this;console.info("Initializing RRO2 GameServer - World "+worldId);world=new WorldServer("world"+i,config.nb_players_per_world,server);world.run();world.name=config.world_name;server.onStart(function(server){console.info("server - onInit called.");if(!server.userConn){server.userConn=new WS.userConnection(99999,server.userConn,server);var connect=config.protocol+"://"+config.user_address+":"+config.user_port;server.userConn.connect(connect)}server.userConn.onConnectUser(function(conn){gConnection=conn;console.info("onConnectUser - Connected");this.send([GameTypes.UserMessages.WU_CONNECT_WORLD]);console.info("server.enterWorld");userHandler=new UserHandler(main,server,world,conn);server.userHandler=userHandler;world.userHandler=userHandler;userHandler.sendWorldInfo(config)})});server.start();server.onConnect(function(conn){var current_date=(new Date).valueOf().toString();var random=Math.random().toString();var hash=crypto.createHash("sha1").update(current_date+random).digest("hex");conn.hash=hash;console.warn("onConnect: hash="+hash);console.info(JSON.stringify(config));console.info("version sent");console.info(GameTypes.Messages.WC_VERSION);conn.sendUTF8(GameTypes.Messages.WC_VERSION+","+config.version+","+conn.hash);var wh=new WorldHandler(server,conn);wh.userConnection=server.userHandler.connection;conn.worldHandler=wh});server.enterWorld=function(conn){console.info("server.enterWorld")};server.onError(function(){console.error(Array.prototype.join.call(arguments,", "))});server.onRequestStatus(function(){return JSON.stringify(getWorldDistribution(worlds))});process.on("uncaughtException",function(e){console.info(JSON.stringify(e));console.error("uncaughtException: "+e.stack)});server._ioServer.on("connection",socket=>{console.log("connected")});server._ioServer.on("disconnect",function(){console.log("disconnected")});server._ioServer.on("msg",message=>{console.log("msg="+JSON.stringify(message))});var signalHandler=function(){main.closeServer()};process.on("SIGINT",signalHandler);process.on("SIGTERM",signalHandler);process.on("SIGQUIT",signalHandler);process.on("SIGHUP",signalHandler);var cmdPrompt=function(){if(process.platform==="win32"){readline.on("SIGINT",function(){process.emit("SIGINT")})}if(!IS_EXITING&&readline){readline.question("Command:",function(line){getInput(line);setTimeout(cmdPrompt,100)})}};cmdPrompt()}function modgems(args){var playerName=args[0];var gems=args[1];var player=world.getPlayerByName(playerName);if(player&&player.user)player.user.modifyGems(gems)}function modgold(args){var playerName=args[0];var gold=args[1];var player=world.getPlayerByName(playerName);if(player)player.modifyGold(gold)}function banplayer(args){var playerName=args[0];var duration=parseInt(args[1]);if(!duration){console.info("banplayer - provide how many days banned.");return}world.ban.banplayer(playerName,duration)}function banuser(args){var username=args[0];var duration=parseInt(args[1]);if(!duration){console.info("banuser - provide how many days banned.");return}world.ban.banuser(username,duration)}function notify(args){world.notifyWorld(args.join(" "))}function getInput(cmd){args=cmd.split(" ");cmdarg=args[0];args.shift();console.info("cmd: "+cmd);switch(cmdarg){case"notify":case"say":case"announce":notify(args);break;case"banplayer":banplayer(args);break;case"banuser":banuser(args);break;case"modgems":modgems(args);break;case"modgold":modgold(args);break;case"exit":case"quit":case"q":case"x":main.closeServer();break;case"s":case"save":main.saveServer();break;case"forcequit":main.closeServer();break;case"reloadauction":reloadAuction();break;default:console.info("Unknown command.")}}function reloadAuction(){_.each(worlds,function(world){world.auction.load()})}function getWorldDistribution(worlds){var distribution=[];_.each(worlds,function(world){distribution.push(world.playerCount)});return distribution}function getConfigFile(path,callback){fs.readFile(path,"utf8",function(err,json_string){if(err){callback(null)}else{callback(JSON.parse(json_string))}})}var defaultConfigPath="./config.json";var customConfigPath="./config_local.json";process.argv.forEach(function(val,index,array){if(index===2){customConfigPath=val}});main.checkSaved=function(){console.info("Main - checkSaved!");var allSaved=setInterval(function(){if(world.isSaved()){clearInterval(allSaved);main.safe_exit()}},500)};main.safe_exit=function(){server.close();process.exit()};main.saveServer=function(){console.info("Main - saveServer!");if(world&&userHandler){world.userHandler=userHandler;world.save()}else{process.exit(1)}};main.closeServer=function(){console.info("Main - closeServer!");IS_EXITING=true;main.saveServer();readline.close();main.checkSaved()};getConfigFile(defaultConfigPath,function(defaultConfig){getConfigFile(customConfigPath,function(localConfig){if(localConfig){main(localConfig)}else if(defaultConfig){main(defaultConfig)}else{console.error("Server cannot start without any configuration file.");process.exit(1)}})})}).call(this)}).call(this,require("path").join(__dirname,"js"))},{"./common":10,"./data/data":12,"./productionconfig":57,"./user/userhandler":63,"./user/usermessage":64,"./user/worldhandler":65,"./worldserver":73,"./ws":74,bison:78,crypto:undefined,fs:undefined,log:192,path:undefined,readline:undefined,underscore:310,util:undefined}],46:[function(require,module,exports){var fs=require("fs");var path=require("path");var file=require("../../shared/js/file");var Checkpoint=require("../area/checkpoint");var Area=require("../area/area");var MapArea=require("../area/maparea");var Map=cls.Class.extend({init:function(world,id,name,filepath,filenameCollision){this.id=this.index=id;this.world=world;console.info("filepath: "+filepath+",filenameCollision: "+filenameCollision);var self=this;this.name=name;this.isLoaded=false;var filenameCollision=filenameCollision;file.exists(filepath,function(exists){if(!exists){console.error(filepath+" doesn't exist.");return}fs.readFile(filepath,function(err,file){var json=JSON.parse(file);self.initMap(json,filenameCollision);delete json})});this.tilesize=G_TILESIZE},initMap:function(thismap,filenameCollision){this.width=thismap.width;this.height=thismap.height;this.chunkWidth=thismap.chunkWidth;this.chunkHeight=thismap.chunkHeight;this.chunkIndexes=thismap.chunkIndexes;this.collisions=thismap.collisions;this.chestAreas=thismap.chestAreas;this.staticChests=thismap.staticChests;this.staticEntities=thismap.staticEntities;this.spawnEntities=thismap.entities;this.generateCollisions=true;this.zoneWidth=thismap.chunkWidth;this.zoneHeight=thismap.chunkHeight;this.groupWidth=Math.ceil(this.width/this.zoneWidth);this.groupHeight=Math.ceil(this.height/this.zoneHeight);this.initConnectedGroups(thismap.doors);this.loadTileGrid(thismap.data);this.loadCollisionGrid(thismap.collision);this.mapMobAreas=thismap.mobAreas;this.initCheckpoints(thismap.checkpoints);this.doors=this._getDoors(thismap);this.isLoaded=true;this.ready=true;this.readyFunc(this)},ready:function(f){this.readyFunc=f},tileIndexToGridPosition:function(tileNum){var x=0;var y=0;x=tileNum%this.width;y=Math.floor(tileNum/this.width);return{x:x*G_TILESIZE,y:y*G_TILESIZE}},GridPositionToTileIndex:function(x,y){return y*this.width+x+1},loadTileGrid:function(tiles){this.tile=new Array(this.height);for(var i=0;i<this.height;++i){var arr=tiles.slice(i*this.width,(i+1)*this.width);this.tile[i]=arr}},loadCollisionGrid:function(collisions){this.grid=new Array(this.height);for(var i=0;i<this.height;++i){var arr=collisions.slice(i*this.width,(i+1)*this.width);this.grid[i]=arr}},GroupIdToGroupPosition:function(id){var posArray=id.split("-");return pos(parseInt(posArray[0],10),parseInt(posArray[1],10))},forEachGroup:function(callback){var width=this.groupWidth;var height=this.groupHeight;for(var x=0;x<width;x+=1){for(var y=0;y<height;y+=1){callback(x+"-"+y)}}},getGroupIdFromPosition:function(x,y){var w=this.zoneWidth;var h=this.zoneHeight;var gx=Math.floor(x/w);var gy=Math.floor(y/h);return gx+"-"+gy},getAdjacentGroupPositions:function(id){var self=this;var position=this.GroupIdToGroupPosition(id);var x=position.x;var y=position.y;var list=[pos(x-1,y-1),pos(x,y-1),pos(x+1,y-1),pos(x-1,y),pos(x,y),pos(x+1,y),pos(x-1,y+1),pos(x,y+1),pos(x+1,y+1)];_.each(this.connectedGroups[id],function(position){if(!_.any(list,function(groupPos){return equalPositions(groupPos,position)})){list.push(position)}});return _.reject(list,function(pos){return pos.x<0||pos.y<0||pos.x>=self.groupWidth||pos.y>=self.groupHeight})},forEachAdjacentGroup:function(groupId,callback){if(groupId){_.each(this.getAdjacentGroupPositions(groupId),function(pos){callback(pos.x+"-"+pos.y)})}},initConnectedGroups:function(doors){var self=this;this.connectedGroups={};_.each(doors,function(door){var groupId=self.getGroupIdFromPosition(door.x,door.y);var connectedGroupId=self.getGroupIdFromPosition(door.tx,door.ty);var connectedPosition=self.GroupIdToGroupPosition(connectedGroupId);if(groupId in self.connectedGroups){self.connectedGroups[groupId].push(connectedPosition)}else{self.connectedGroups[groupId]=[connectedPosition]}})},initMobAreas:function(){var maList=this.mapMobAreas;var self=this;this.mobAreas={};_.each(maList,function(ma){var mobarea=new MobArea(self,ma.id,ma.count,ma.minLevel,ma.maxLevel,ma.x,ma.y,ma.w,ma.h,ma.include,ma.exclude,ma.definite,false,-1,ma.level);self.mobAreas[ma.id]=mobarea;mobarea.addMobs();mobarea.spawnMobs()})},initCheckpoints:function(cpList){var self=this;this.checkpoints={};this.startingAreas=[];_.each(cpList,function(cp){var checkpoint=new Checkpoint(self,cp.id,cp.x,cp.y,cp.w,cp.h);self.checkpoints[checkpoint.id]=checkpoint;if(cp.s===1){self.startingAreas.push(checkpoint)}})},getCheckpoint:function(id){return this.checkpoints[id]},getRandomStartingPosition:function(area){var nbAreas=_.size(this.startingAreas);var i=Utils.randomInt(nbAreas-1);if(!area)area=this.startingAreas[i];if(this.index===1){var area=new Area(this,0,512,512,30,30,true,-1);var areaPos=area._getRandomPositionInsideArea.bind(area,100);var pos=this.entities.spaceEntityRandomApart(3,areaPos);console.info("getRandomStartingPosition - x:"+pos.x+",y:"+pos.y);return pos}if(area){var areaPos=area._getRandomPositionInsideArea.bind(area,100);return this.entities.spaceEntityRandomApart(3,areaPos)}else{return null}},isColliding:function(x,y){var x1=~~(x>>4),y1=~~(y>>4),x2=~~(x1+.5),y2=~~(y1+.5);var pos=[x1,y1];var c=pos;if(this.isOutOfBounds(c[0],c[1])){return true}if(this.isCollidingGrid(c[0],c[1])){return true}return false},isCollidingGrid:function(x,y){return this.grid[y][x]===1},isOutOfBounds:function(x,y){return!_.isNumber(x)||!_.isNumber(y)||(x<0||x>=this.width||y<0||y>=this.height)},isValidPosition:function(x,y){return _.isNumber(x)&&_.isNumber(y)&&!this.isOutOfBounds(x,y)&&!this.isColliding(x,y)},getRandomPositionCollide:function(collide){collide=collide||[0,0,0,0];var self=this;var pos={};var tries=0;do{pos.x=Utils.randomRangeInt(0-collide[0],self.width-1-collide[2]);pos.y=Utils.randomRangeInt(0-collide[1],self.height-1-collide[3]);if(self.isValidPosition(pos.x,pos.y))break}while(tries++<25);if(tries>=25){pos.x=-1;pos.y=-1;console.log("getRandomPosition()-tries="+tries)}return pos},getRandomPositionArea:function(x1,x2,y1,y2){var pos={};var ts=G_TILESIZE;x1=Utils.clamp(0,this.width*ts,x1);x2=Utils.clamp(0,this.width*ts,x2);y1=Utils.clamp(0,this.height*ts,y1);y2=Utils.clamp(0,this.height*ts,y2);var tries=0;do{pos.x=Utils.randomRangeInt(x1,x2);pos.y=Utils.randomRangeInt(y1,y2);if(!this.isColliding(pos.x,pos.y))break}while(tries++<20);if(tries>=20){pos.x=-1;pos.y=-1;console.log("getRandomPosition()-tries="+tries)}return pos},getRandomPosition:function(){var self=this;var pos={};var tries=0;do{pos.x=Utils.randomRangeInt(0,self.width*G_TILESIZE);pos.y=Utils.randomRangeInt(0,self.height*G_TILESIZE);if(self.isColliding(pos.x,pos.y))break}while(tries++<20);if(tries>=20){pos.x=-1;pos.y=-1;console.log("getRandomPosition()-tries="+tries)}return pos},_getDoors:function(map){var self=this;console.info(JSON.stringify(map.doors));var doors=[];_.each(map.doors,function(door){door.width=door.width?door.width:1;door.height=door.height?door.height:1;console.info("door.tmap="+door.tmap);var area=new MapArea(map,false,door.x,door.y,door.width,door.height,-1);area.minLevel=door.tminLevel||0,area.maxLevel=door.tmaxLevel||200,area.map=door.tmap?door.tmap:1,area.portal=door.p===1,area.quest=door.tq,area.admin=door.a;switch(door.to){case"u":area.orientation=Types.Orientations.UP;break;case"d":area.orientation=Types.Orientations.DOWN;break;case"l":area.orientation=Types.Orientations.LEFT;break;case"r":area.orientation=Types.Orientations.RIGHT;break;default:area.orientation=Types.Orientations.DOWN}doors.push(area)});console.info("return doors");return doors},isDoor:function(x,y){return _.detect(this.doors,function(door){return door.contains({x:x,y:y})!==null})},getDoor:function(entity){return _.detect(this.doors,function(door){return door.contains(entity)})},getSubCoordinate:function(x,y){x=x%(this.chunkWidth*this.tilesize);y=y%(this.chunkHeight*this.tilesize);return[x,y]},getSubIndex:function(x,y){return~~(y/(this.chunkHeight*this.tilesize)*this.chunkHeight+x/(this.chunkWidth*this.tilesize))},isHarvestTile:function(pos,type){console.info("isHarvestTile");if(this.isOutOfBounds(pos.gx,pos.gy))return false;var tiles=this.getTiles(pos.gx,pos.gy);console.info("tiles: "+JSON.stringify(tiles));if(!tiles||tiles.length===0)return false;log.info("tiles="+JSON.stringify(tiles));var types={};types.axe=[678,679,698,699,855,875,274,275,294,295];if(!types.hasOwnProperty(type))return false;var res=false;if(Array.isArray(tiles)){res=types[type].some(function(tile){return tiles.includes(tile)})}else{res=types[type].includes(tiles)}return res},getTiles:function(gx,gy){return this.tile[gy][gx]}});var pos=function(x,y){return{x:x,y:y}};var equalPositions=function(pos1,pos2){return pos1.x===pos2.x&&pos2.y===pos2.y};module.exports=Map},{"../../shared/js/file":348,"../area/area":1,"../area/checkpoint":2,"../area/maparea":5,fs:undefined,path:undefined}],47:[function(require,module,exports){var Chest=require("../entity/chest");var NpcStatic=require("../entity/npcstatic");var NpcMove=require("../entity/npcmove");var Messages=require("../message");var MobAI=require("../mobai");var MapEntities=cls.Class.extend({init:function(id,server,map){var self=this;self.id=id;self.map=map;self.server=server;self.world=server;self.entities={};self.players={};self.characters={};self.npcplayers={};self.mobs={};self.items={};self.equipping={};self.hurt={};self.npcs={};self.chests={};self.blocks={};self.spatial=[];var spatialWidth=Math.ceil(self.map.width/G_SPATIAL_SIZE);var spatialHeight=Math.ceil(self.map.height/G_SPATIAL_SIZE);for(var i=0,j=0;i<spatialHeight;i++){self.spatial[i]=[];for(j=0;j<spatialWidth;j++){self.spatial[i][j]=[]}}self.packets={};self.mobAreas=[];self.groups={};self.pathfinder=null;self.pathingGrid=null;self.zoneGroupsReady=false;self.maxPackets=10;self.entityCount=0;this.mobAI=null;this.cellsize=G_TILESIZE;this.harvest={}},getSpatialEntities:function(arr){var x1=~~(Math.max(arr[0],0)/G_SPATIAL_SIZE);var y1=~~(Math.max(arr[1],0)/G_SPATIAL_SIZE);var x2=~~(Math.min(arr[2],this.map.width-1)/G_SPATIAL_SIZE);var y2=~~(Math.min(arr[3],this.map.height-1)/G_SPATIAL_SIZE);var res=[];var l1=this.spatial.length;var l2=0;for(var j=y1,i=0;j<=y2;++j){l2=this.spatial[j].length;for(i=x1;i<=x2;++i){for(var entity of this.spatial[j][i]){if(!entity)continue;res.push(entity)}}}return res},mapready:function(){this.initPathFinder();this.initPathingGrid();this.mobAI=new MobAI(this.server,this.map)},initPathFinder:function(){this.pathfinder=new Pathfinder(this.map.width,this.map.height)},spawnNpcs:function(count){var npc;for(var i=0;i<count;++i){npc=this._createNpc("Npc"+i)}},_createNpc:function(name){var self=this;pos=this.spaceEntityRandomApart(2,function(){return self.map.getRandomPosition()});var npc=new NpcMove(++this.entityCount,0,pos.x*16,pos.y*16,self.map);self.addNpcMove(npc);return npc},initPathingGrid:function(){var map=this.map,self=this;console.info("pathinggrid height:"+map.height+", width:"+map.width);var grid=new Uint8Array(map.height);for(var i=0,j=0;i<map.height;++i){grid[i]=new Uint8Array(map.width);for(j=0;j<map.width;++j){if(map.grid[i][j])grid[i][j]=1;else grid[i][j]=0}}self.entitygrid=grid.slice(0);console.info("Initialized the pathing grid with static colliding cells.")},processWho:function(player){var self=this;var screens=[];var ids=player.knownIds;ids=ids.parseInt();var pgx=~~(player.x/G_TILESIZE);var pgy=~~(player.y/G_TILESIZE);var entities=this.getSpatialEntities([pgx-64,pgy-32,pgx+64,pgy+32]);for(var entity of entities){if(entity&&!(entity===player)&&self.isOffset(player,entity))screens.push(entity.id)}var screenIds=ids&&ids.length>0?_.difference(screens,ids):screens;_.each(screenIds,function(id){var entity=self.getEntityById(id);if(entity&&!(entity===player)){player.knownIds.push(entity.id);self.sendToPlayer(player,entity.spawn());if(entity.path){var msg=new Messages.MovePath(entity,entity.path);self.sendToPlayer(player,msg)}}})},isOffset:function(entity,entity2,extra,cameraHalfX,cameraHalfY){extra=(extra||0)*G_TILESIZE;cameraHalfX=(cameraHalfX||32)*G_TILESIZE;cameraHalfY=(cameraHalfY||18)*G_TILESIZE;var minX=Math.max(0,entity.x-cameraHalfX-extra);var minY=Math.max(0,entity.y-cameraHalfX-extra);var maxX=Math.min(this.map.width*G_TILESIZE,entity.x+cameraHalfX+extra);var maxY=Math.min(this.map.height*G_TILESIZE,entity.y+cameraHalfX+extra);if(entity2.y>=minY&&entity2.y<=maxY&&entity2.x>=minX&&entity2.x<=maxX){return true}else{return false}},processPackets:function(){var self=this;if(self.packets.length>0)console.info(JSON.stringify(self.packets));Utils.forEach(this.packets,(packet,id)=>{len=packet.length;if(len>0&&typeof packet!=="undefined"&&packet!==null){var player=self.getEntityById(id);var conn=self.server.socket.getConnection(id);if(player&&player.map&&player.mapStatus>=2&&conn!==null&&typeof conn!=="undefined"){var packets=[];for(var i=0;i<self.maxPackets;++i){if(packet.length===0)break;packets.push(packet.shift())}conn.send(packets)}else{conn=null}}})},sendToPlayer:function(player,message){if(!message)return;var self=this;if(player&&player.id in self.packets){self.packets[player.id].push(message.serialize())}this.processPackets()},sendBroadcast:function(message,ignoredPlayer){if(!message)return;Utils.forEach(this.packets,function(packet,id){if(id!==ignoredPlayer){packet.push(message.serialize())}});this.processPackets()},sendNeighbours:function(entity,message,ignoredPlayer,areaLength){var self=this;areaLength=areaLength||48;var players=self.getPlayerAround(entity,areaLength);players.push(entity);for(var player of players){if(self.packets.hasOwnProperty(player.id)&&!ignoredPlayer||ignoredPlayer&&player!==ignoredPlayer){self.packets[player.id].push(message.serialize())}}this.processPackets()},isMobsOnSameTile:function(mob){var X=mob.x,Y=mob.y,result=false,X2=0,Y2=0;if(mob.path&&mob.path.length>0){X=mob.path[mob.path.length-1][0];Y=mob.path[mob.path.length-1][1]}_.each(self.mobs,function(entity){if(entity.isMoving()){X2=entity.path[entity.path.length-1][0];Y2=entity.path[entity.path.length-1][1]}else{X2=entity.x;Y2=entity.y}if(entity.id!==mob.id&&X===X2&&Y===Y2){result=true}});return result},getFreeAdjacentNonDiagonalPosition:function(entity){var self=this,result=null;entity.forEachAdjacentNonDiagonalPosition(function(x,y,orientation){if(!result&&!self.map.isColliding(x,y)&&!self.isCharacterAt(x,y)){result={x:x,y:y,o:orientation}}});return result},getFreeFutureAdjacentNonDiagonalPosition:function(entity){var self=this,result=[];entity.forEachFutureAdjacentNonDiagonalPosition(function(x,y,orientation){if(!self.map.isColliding(x,y)&&!self.isMobAt(x,y)){result.push({x:x,y:y,o:orientation})}});return result},getRandomPosition:function(entity,threshold){var pos=[];var valid=false;var tries=10;var attempts=0;threshold*=G_TILESIZE;while(attempts++<tries&&(pos.y!==entity.y&&pos.x!==entity.x)){var r1=Utils.randomRangeInt(-threshold,threshold);var r2=Utils.randomRangeInt(-threshold,threshold);pos[0]=entity.x+r1;pos[1]=entity.y+r2;valid=!this.map.isColliding(pos[0],pos[1]);if(valid&&!(pos[0]==-1&&pos[1]==-1))return{x:pos[0],y:pos[1]}}console.info("getRandomPosition - failed");return null},spawnEntities:function(map){var self=this;_.each(self.map.spawnEntities,function(npcData){if(npcData.type==Types.EntityTypes.NPCMOVE){var npc=self.addNpcMove(npcData.id,npcData.x*G_TILESIZE,npcData.y*G_TILESIZE);if(npcData.name)npc.name=npcData.name;if(npcData.scriptQuests)npc.scriptQuests=npcData.scriptQuests}if(npcData.type==Types.EntityTypes.NPCSTATIC){var npc=self.addNpcStatic(npcData.id,npcData.x*G_TILESIZE,npcData.y*G_TILESIZE);if(npcData.name)npc.name=npcData.name;if(npcData.scriptQuests)npc.scriptQuests=npcData.scriptQuests}});console.info(JSON.stringify(self.map.staticEntities));_.each(self.map.staticEntities,function(kind,tid){var pos=map.tileIndexToGridPosition(tid);console.info("kind:"+kind);if(NpcData.isNpc(kind)){console.info("npc:"+kind+",x:"+pos.x+",y:"+pos.y);self.addNpcStatic(kind,pos.x,pos.y)}})},addEntity:function(entity){this.entities[entity.id]=entity;if(entity instanceof Character)this.characters[entity.id]=entity},addPlayer:function(player){console.info("addPlayer - player id: "+player.id);this.addEntity(player);this.players[player.id]=player;this.packets[player.id]=[]},addChest:function(chest){this.addEntity(chest);this.chests[chest.id]=chest},addBlock:function(block){this.addEntity(block);this.blocks[block.id]=block;return block},addMob:function(kind,x,y,area){var mob=new Mob(++this.entityCount,kind,x,y,this.map,area);mob.mobAI=this.mobAI;this.addEntity(mob);this.mobs[mob.id]=mob;this.world.mobCallback.setCallbacks(mob);return mob},addNpcStatic:function(kind,x,y){var npc=new NpcStatic(++this.entityCount,kind,x,y,this.map);this.addEntity(npc);this.npcs[npc.id]=npc;return npc},addNpcMove:function(kind,x,y){var npc=new NpcMove(++this.entityCount,kind,x,y,this.map);this.addEntity(npc);this.npcplayers[npc.id]=npc;return npc},addItem:function(item){var self=this;self.addEntity(item);self.items[item.id]=item;return item},removeSpatial:function(entity){if(entity.spatialMap){var spatial=this.spatial[entity.spy][entity.spx];Utils.removeFromArray(spatial,entity)}},removeEntity:function(entity){this.removeSpatial(entity);if(entity.id in this.mobs)delete this.mobs[entity.id];if(entity.id in this.items)delete this.items[entity.id];if(entity.id in this.players)delete this.players[entity.id];if(entity.id in this.chests)delete this.chests[entity.id];if(entity.id in this.blocks)delete this.blocks[entity.id];if(entity.id in this.characters)delete this.characters[entity.id];if(entity.id in this.entities)delete this.entities[entity.id];entity.destroy()},removePlayer:function(player){console.info("removePlayer-called");var self=this;if(player instanceof Player)this.sendBroadcast(player.despawn());console.info("deleting player traces..");self.removeEntity(player);delete self.packets[player.id];player=null},removeNpcPlayer:function(player){console.info("removePlayer-called");this.sendBroadcast(player.despawn(0));this.removeEntity(player);delete this.npcplayers[player.id]},createItem:function(itemRoom,x,y){var id=++this.entityCount;var item=null;var type=Types.EntityTypes.ITEM;if(!ItemTypes.isEquippable(itemRoom.itemKind))type=Types.EntityTypes.ITEMLOOT;item=new Item(type,id,itemRoom,x,y,this.map);this.addItem(item);return item},addStaticItem:function(map,item){var self=this;item.isStatic=true;item.onRespawn(self.addStaticItem.bind(self,item));return self.addItem(item)},getEntityById:function(id){var self=this;if(self.entities.hasOwnProperty(id))return self.entities[id]},getPlayerByName:function(name){for(var id in this.players){var p=this.players[id];if(p.name===name)return p}return null},setModifyGoldByName:function(name,mod){var player=this.getPlayerByName(name);if(player)player.modifyGold(mod)},getEntitiesByPosition:function(x,y){entities=[];this.forEachEntity(function(e){if(e.x===x&&e.y===y)entities.push(e)});return entities},isCharacterAt:function(x,y){return this.entitygrid[y][x]===1},isMobAt:function(x,y){var result=false;this.forEachMob(function(mob){var X=mob.x,Y=mob.y;if(mob.path&&mob.path.length>0){X=mob.path[mob.path.length-1][0];Y=mob.path[mob.path.length-1][1]}if(x===X&&y===Y)result=true});return result},forEachEntity:function(callback){Utils.forEach(this.entities,function(entity){callback(entity)})},forEachPlayer:function(callback){Utils.forEach(this.players,function(entity){callback(entity)})},forEachMob:function(callback){Utils.forEach(this.mobs,function(entity){callback(entity)})},forEachCharacter:function(callback){Utils.forEach(this.entities,function(entity){if(entity instanceof Character)callback(entity)})},forEachNpcPlayer:function(callback){Utils.forEach(this.npcplayers,function(entity){if(entity instanceof Character)callback(entity)})},getEntitySpatialCount:function(entity,range,conditional){range*=G_TILESIZE;var x=entity.x;var y=entity.y;var r=range>>1;var count=0;var def_conditional=function(e1,e2){return e1!==e2};conditional=conditional||def_conditional;var group=this.getSpatialEntities([x-r,y-r,x+r,y+r]);for(var e2 of group){if(conditional(e1,e2))count++}return count},getEntityAroundSpatial:function(entity,range,conditional){range*=G_TILESIZE;var r=range>>1;var x=entity.x;var y=entity.y;var entities=[];var def_conditional=function(e1,e2){return e1!==e2};conditional=conditional||def_conditional;var e2;var group=this.getSpatialEntities([x-r,y-r,x+r,y+r]);for(var e2 of group){if(conditional(entity,e2)){entities.push(e2)}}return entities},getEntityCount:function(group,e1,range,conditional){range*=G_TILESIZE;conditional=conditional||function(e1,e2){return e1!==e2};var compare=function(e1,e2){return Math.abs(e2.x-e1.x)<=range&&Math.abs(e2.y-e1.y)<=range&&conditional(e1,e2)};var count=0;if(Array.isArray(group)){for(var e2 of group){if(compare(e1,e2))count++}}else{Utils.forEach(group,function(e2){if(compare(e1,e2))count++})}return count},getEntityAround:function(group,e1,range,conditional){range*=G_TILESIZE;var entities=[];conditional=conditional||function(e1,e2){return e1!==e2};var compare=function(e1,e2){return Math.abs(e2.x-e1.x)<=range&&Math.abs(e2.y-e1.y)<=range&&conditional(e1,e2)};if(Array.isArray(group)){for(var e2 of group){if(compare(e1,e2))entities.push(e2)}}else{Utils.forEach(group,function(e2){if(compare(e1,e2))entities.push(e2)})}return entities},getEachEntityAround:function(x,y,s){var x=~~(x/G_TILESIZE);var y=~~(y/G_TILESIZE);var entities=this.getSpatialEntities([x-s,y-s,x+s,y+s]);return this.getEntityAround(entities,{x:x,y:y},s)},getEntitiesAround:function(entity,range){var x=~~(entity.x/G_TILESIZE);var y=~~(entity.y/G_TILESIZE);var r=range*G_TILESIZE>>1;var entities=this.getSpatialEntities([x-r,y-r,x+r,y+r]);return this.getEntityAround(entities,entity,r)},getCharactersAround:function(entity,range){return this.getEntityAround(this.getEntitiesAround(entity,range),entity,range,function(e1,e2){return e1!==e2&&e2 instanceof Character})},getMobsAround:function(entity,range){return this.getEntityAround(this.mobs,entity,range)},getPlayerAround:function(entity,range){return this.getEntityAround(this.players,entity,range)},getAroundCount:function(entities,entity,range){return this.getEntityCount(entities,entity,range)},getEntityAroundCount:function(entity,range){return this.getEntityCount(this.getEntitiesAround(entity,range),entity,range)},getPlayerAroundCount:function(entity,range){return this.getEntityCount(this.players,entity,range)},getPartyAround:function(entity,range){return this.getEntityAround(entity.party.players,entity,range)},itemDespawn:function(item){this.sendNeighbours(item,new Messages.Despawn(item));this.removeEntity(item)},handleEmptyChestArea:function(area){var self=this;if(area){self.handleItemDespawn(chest)}},tryAddingMobToChestArea:function(mob){var self=this;_.each(self.chestAreas,function(area){if(area.contains(mob))area.addToArea(mob)})},findPath:function(character,x,y,ignoreList){var self=this,path=[];if(this.pathfinder&&character){var grid=self.map.grid;var path=null;var pS=[character.x,character.y];var ts=G_TILESIZE;if(this.map.isColliding(character.x,character.y)){console.warn("findPath - isColliding start.");return null}var pE=[x,y];if(this.map.isColliding(x,y)){console.warn("findPath - isColliding end.");return null}if(pS[0]===pE[0]&&pS[1]===pE[1]){try{throw new Error}catch(err){console.info(err.stack)}console.warn("findPath - path coordinates are the same.");return null}var shortGrid=this.pathfinder.getShortGrid(grid,pS,pE,3);var sgrid=shortGrid.crop;var spS=shortGrid.substart;var spE=shortGrid.subend;var subpath=null;subpath=this.pathfinder.findDirectPath(sgrid,spS,spE);if(subpath){var res=this.pathfinder.getFullFromShortPath(subpath,shortGrid.minX,shortGrid.minY);console.info("findPath - res:"+JSON.stringify(res));return res}if(!path){path=this.pathfinder.findShortPath(sgrid,shortGrid.minX,shortGrid.minY,spS,spE);console.info("findPath - shortPath:"+JSON.stringify(path))}if(!path){console.warn("findPath - DANGER - findPath LONGGG");path=this.pathfinder.findPath(grid,pS,pE,false);console.info("findPath - longPath:"+JSON.stringify(path))}if(!path){console.error("findPath - Error while finding the path to "+x+", "+y+" for "+character.id);return null}return path}return null},spaceEntityRandomApart:function(dist,callback_func,entities,entity,threshold){entities=entities||this.entities;threshold=threshold||50;var pos=null;var count=1;var param=entity&&entity.collision?entity.collision:null;var iter=0;while(count>0&&iter<threshold){if(callback_func){pos=callback_func(param);count=pos?this.getAroundCount(entities,pos,dist):0}iter++}return pos},isGridPositionEmpty:function(x,y){console.info("isGridPositionEmpty: x="+x+",y="+y);if(this.map.isColliding(x,y))return false;var pos={x:x,y:y};var entities=this.getEntitiesAround(pos,1);if(entities.length===0)return true;for(var entity of entities){if(entity.isOverPosition(pos))return false}return true}});module.exports=MapEntities},{"../entity/chest":25,"../entity/npcmove":31,"../entity/npcstatic":32,"../message":49,"../mobai":50}],48:[function(require,module,exports){var Map=require("./map");var MapEntities=require("./mapentities");var MobArea=require("../area/mobarea");var EntityArea=require("../area/entityarea");var NpcMove=require("../entity/npcmove");var Node=require("../entity/node");var Mob=require("../entity/mob");module.exports=MapManager=cls.Class.extend({init:function(server){var self=this;this.server=server;this.maps={};this.mapCount=0;this.id=0;this.mapInstances={};this.loaded=false;this.maps[0]=new Map(server,0,"map0","./maps/map0.json","");this.maps[0].ready(function(){var map=self.maps[0];map.entities=new MapEntities(self.id,self.server,map,self.server.database);map.entities.mapready();map.entities.spawnEntities(map);map.enterCallback=function(player){var pos=map.getRandomStartingPosition();return pos};self.MapsReady()});self.maps[1]=new Map(server,1,"map1","./maps/map1.json","");self.maps[1].ready(function(){var map=self.maps[1];map.entities=new MapEntities(self.id,self.server,map,self.server.database);map.entities.mapready();map.mobArea=[];var mobArea=new MobArea(map,0,25,0,1,512,512,40,40,[1],null,null,true,-1,null,null);map.mobArea.push(mobArea);mobArea.addMobs();mobArea.spawnMobs();var npc=map.entities.addNpcMove(0,510*G_TILESIZE,510*G_TILESIZE);npc.name="Old Man";npc.scriptQuests=false;var prevNpc=npc;var x=0;var y=0;var a=512;var b=512;var j=0;var j_max=0;var id=0;var offset=40;var strDir="EAST";loop:for(var i=0;i<40;i++){if(id>=50)break loop;j_max+=i%2==0?1:0;var dir=i%4;for(var j=1;j<=j_max;j++){x=0;y=0;switch(dir){case 0:strDir="EAST";x=offset;break;case 1:strDir="SOUTH";y=offset;break;case 2:strDir="WEST";x=-offset;break;case 3:strDir="NORTH";y=-offset;break}a+=x;b+=y;id+=1;mobArea=new MobArea(map,id,15,1+id,1+id,a,b,40,40,null,null,null,true,-1,null);map.mobArea.push(mobArea);mobArea.addMobs();mobArea.spawnMobs();mobArea=new MobArea(map,id,5,2+id,2+id,a,b,20,20,null,null,null,true,-1,null);map.mobArea.push(mobArea);mobArea.addMobs();mobArea.spawnMobs();mobArea=new MobArea(map,id,1,3+id,3+id,a,b,10,10,null,null,null,true,-1,null);map.mobArea.push(mobArea);mobArea.addMobs();mobArea.spawnMobs();for(var mob of mobArea.entities){mob.createBoss(5)}var area=new EntityArea(map,0,a,b,20,20,true,-1);var pos=area._getRandomPositionInsideArea(30);var npc=map.entities.addNpcMove(id,pos.x,pos.y);var area2=new EntityArea(map,0,a,b,20,20,true,-1);prevNpc.nextNpcName=npc.name;prevNpc.nextNpcDir=strDir;prevNpc=npc;if(id>0){var level=1;if(id===9){for(var k=0;k<6;++k){var pos=map.entities.spaceEntityRandomApart(2,area2._getRandomPositionInsideArea.bind(area2,100));var node=new Node(++map.entities.entityCount,3,pos.x,pos.y,map,level,level);node.name="node1";node.weaponType="any";area.addToArea(node);map.entities.addEntity(node)}}else if(id===6){level=2;for(var k=0;k<6;++k){var pos=map.entities.spaceEntityRandomApart(2,area2._getRandomPositionInsideArea.bind(area2,100));var node=new Node(++map.entities.entityCount,3,pos.x,pos.y,map,level,level);node.name="node2";node.weaponType="any";area.addToArea(node);map.entities.addEntity(node)}}else if(id>10){level=Utils.clamp(1,4,~~(id/10)+1);for(var k=0;k<10;++k){var pos=map.entities.spaceEntityRandomApart(2,area2._getRandomPositionInsideArea.bind(area2,100));var node=new Node(++map.entities.entityCount,2,pos.x,pos.y,map,level,level);node.name="node"+level;node.weaponType="hammer";area.addToArea(node);map.entities.addEntity(node)}}}}}map.enterCallback=function(player){var pos=map.getRandomStartingPosition();return pos};self.MapsReady()})},MapsReady:function(){this.mapCount++;console.info("mapCount="+this.mapCount);if(this.isMapsReady()&&!this.loaded){console.info("maps ready");this.readyFunc();this.loaded=true}},isMapsReady:function(){console.info("Maps Length: "+Object.keys(this.maps).length);return this.mapCount===Object.keys(this.maps).length},onMapsReady:function(readyFunc){this.readyFunc=readyFunc}})},{"../area/entityarea":4,"../area/mobarea":6,"../entity/mob":29,"../entity/node":30,"../entity/npcmove":31,"./map":46,"./mapentities":47}],49:[function(require,module,exports){var _=require("underscore");var cls=require("./lib/class");var Messages={};module.exports=Messages;var Message=cls.Class.extend({});Messages.SyncTime=Message.extend({init:function(localtime){this.localtime=localtime},serialize:function(){return[Types.Messages.BI_SYNCTIME,this.localtime,Date.now()]}});Messages.Spawn=Message.extend({init:function(entity){this.entity=entity},serialize:function(){var spawn=[Types.Messages.WC_SPAWN];return spawn.concat(this.entity.getState())}});Messages.Despawn=Message.extend({init:function(entity){this.id=entity.id;this.mapIndex=entity.map.index;this.x=entity.x;this.y=entity.y},serialize:function(){return[Types.Messages.WC_DESPAWN,this.id,this.mapIndex,this.x,this.y]}});Messages.Move=Message.extend({init:function(entity,orientation,state,x,y){this.time=Date.now(),this.entity=entity,this.orientation=orientation;this.state=state;this.x=x||this.entity.x;this.y=y||this.entity.y},serialize:function(){return[Types.Messages.WC_MOVE,this.time,this.entity.map.index,this.entity.id,parseInt(this.orientation),this.state,this.entity.moveSpeed,this.x,this.y]}});Messages.MovePath=Message.extend({init:function(entity,path){this.time=Date.now(),this.entity=entity,this.path=path,this.orientation=entity.orientation},serialize:function(){return[Types.Messages.WC_MOVEPATH,this.time,this.entity.map.index,this.entity.id,parseInt(this.orientation),this.entity.interrupted=this.entity.interrupted?1:0,this.entity.moveSpeed].concat(this.path)}});Messages.ChangePoints=Message.extend({init:function(entity,modhp,modep){this.id=entity.id;this.hp=entity.stats.hp;this.hpMax=entity.stats.hpMax;this.ep=entity.stats.ep||0;this.epMax=entity.stats.epMax||0;this.modhp=modhp;this.modep=modep},serialize:function(){return[Types.Messages.WC_CHANGEPOINTS,this.id,this.hp,this.hpMax,this.modhp,this.ep,this.epMax,this.modep]}});Messages.Error=Message.extend({init:function(message){this.message=message},serialize:function(){return[Types.Messages.WC_ERROR,this.message]}});Messages.Notify=Message.extend({init:function(group,message,vars){this.group=group;this.message=message;this.vars=vars||[]},serialize:function(){var arr=[Types.Messages.WC_NOTIFY,this.group,this.message];return arr.concat(this.vars)}});Messages.Dialogue=Message.extend({init:function(npc,langcode,vars){this.id=npc.id;this.langcode=langcode;this.vars=vars||[]},serialize:function(){return[Types.Messages.WC_DIALOGUE,this.id,this.langcode].concat(this.vars)}});Messages.Quest=Message.extend({init:function(quest){this.quest=quest},serialize:function(){var arr=this.quest.toClient();return[Types.Messages.WC_QUEST].concat(arr)}});Messages.Achievement=Message.extend({init:function(achievement){this.achievement=achievement},serialize:function(){var arr=this.achievement.toClient(this.achievement);return[Types.Messages.WC_ACHIEVEMENT].concat(arr)}});Messages.Log=Message.extend({init:function(message){this.message=message;this.message.unshift(Types.Messages.WC_LOG)},serialize:function(){return this.message}});Messages.SkillLoad=Message.extend({init:function(index,exp){this.index=index;this.exp=exp},serialize:function(){return[Types.Messages.WC_SKILLLOAD,this.index,this.exp]}});Messages.SkillEffects=Message.extend({init:function(player,effects){this.id=player.id;this.effects=effects},serialize:function(){return[Types.Messages.WC_SKILLEFFECTS,this.id].concat(this.effects)}});Messages.SkillXP=Message.extend({init:function(skillXPs){this.skillXPs=skillXPs},serialize:function(){var arr=[Types.Messages.WC_SKILLXP];arr.push(skillXPs.length);arr.concat(skillXPs);return arr}});Messages.Chat=Message.extend({init:function(player,group,message){this.playerId=player.id;this.group=group;this.message=message},serialize:function(){return[Types.Messages.WC_CHAT,this.playerId,this.group,this.message]}});Messages.TeleportMap=Message.extend({init:function(entity,subIndex,status){this.entity=entity,this.subIndex=subIndex,this.status=status},serialize:function(){return[Types.Messages.WC_TELEPORT_MAP,this.entity.getMapIndex(),this.subIndex,this.status,this.entity.x,this.entity.y]}});Messages.Damage=Message.extend({init:function(data){var attacker=data[0];var target=data[1];this.entity1=attacker;this.entity2=target;this.hpMod=data[2];this.hp=target.stats.hp;this.hpMax=target.stats.hpMax;this.epMod=data[3];this.ep=target.stats.ep||0;this.epMax=target.stats.epMax||0;this.crit=data[4]?1:0;this.effects=data[5]},serialize:function(){var arr=[Types.Messages.WC_DAMAGE,this.entity1.id,this.entity2.id,this.entity1.orientation,this.hpMod,this.hp,this.hpMax,this.epMod,this.ep,this.epMax,this.crit];if(Array.isArray(this.effects)&&this.effects.length>0)arr.concat(this.effects);return arr}});Messages.StatInfo=Message.extend({init:function(player){this.player=player},serialize:function(){var stats=this.player.stats;var data=[Types.Messages.WC_STATINFO,stats.attack,stats.defense,stats.health,stats.energy,stats.luck,stats.free,stats.hp,stats.hpMax,stats.ep,stats.epMax];return data}});Messages.UpdateLook=Message.extend({init:function(player){this.player=player},serialize:function(){return[Types.Messages.WC_LOOKUPDATE,this.player.id,this.player.sprites[0],this.player.sprites[1],this.player.colors[0],this.player.colors[1]]}});Messages.AppearanceList=Message.extend({init:function(user,looks){this.looks=Utils.BinArrayToBase64(user.looks);this.prices=looks.prices},serialize:function(){return[Types.Messages.WC_APPEARANCE,this.looks].concat(this.prices)}});Messages.ItemSlot=Message.extend({init:function(type,items){this.type=type;this.items=items},serialize:function(){var msg=[Types.Messages.WC_ITEMSLOT,this.type,this.items.length];for(var item of this.items){var arr=null;if(item.itemKind===-1)arr=[item.slot,item.itemKind];else{arr=item.toArray()}msg=msg.concat(arr)}return msg}});Messages.ItemLevelUp=Message.extend({init:function(index,item){this.index=index;this.item=item},serialize:function(){if(this.item){return[Types.Messages.WC_ITEMLEVELUP,this.index,this.item.itemNumber,this.item.itemExperience]}}});Messages.Stat=Message.extend({init:function(type,value,change){this.type=type;this.value=value;this.change=change},serialize:function(){return[Types.Messages.WC_STAT,this.type,this.value,this.change]}});Messages.LevelUp=Message.extend({init:function(type,level,exp){this.type=type;this.level=level;this.exp=exp},serialize:function(){return[Types.Messages.WC_LEVELUP,this.type,this.level,this.exp]}});Messages.List=Message.extend({init:function(ids){this.ids=ids},serialize:function(){var list=this.ids;list.unshift(Types.Messages.WC_LIST);return list}});Messages.AuctionOpen=Message.extend({init:function(itemData){this.itemData=itemData},serialize:function(){return this.itemData}});Messages.Speech=Message.extend({init:function(entity,kind,value){this.entityid=entity.id;this.kind=kind;this.value=value},serialize:function(){return[Types.Messages.WC_SPEECH,this.entityid,this.kind,this.value]}});Messages.Gold=Message.extend({init:function(player){this.invgold=player.gold[0];this.bankgold=player.gold[1];this.gems=player.user.gems},serialize:function(){return[Types.Messages.WC_GOLD,this.invgold,this.bankgold,this.gems]}});Messages.BlockModify=Message.extend({init:function(entity,id,state){this.entity=entity;this.id=id;this.state=state},serialize:function(){var spawn=[Types.Messages.WC_SPAWN,this.id,this.state];return spawn.concat(this.entity.getState())}});Messages.PartyInvite=Message.extend({init:function(id){this.id=id},serialize:function(){return[Types.Messages.WC_PARTY,2,this.id]}});Messages.Party=Message.extend({init:function(members){this.members=members},serialize:function(){return[Types.Messages.WC_PARTY,1].concat(this.members)}});Messages.PlayerInfo=Message.extend({init:function(player){this.player=player},serialize:function(){return[Types.Messages.WC_PLAYERINFO,this.player.exp.base,this.player.exp.attack,this.player.exp.defense,this.player.exp.sword,this.player.exp.bow,this.player.exp.hammer,this.player.exp.axe,this.player.exp.logging,this.player.exp.mining]}});Messages.setSprite=Message.extend({init:function(entity,sprite1,sprite2,animName){this.id=entity.id;this.sprite1=sprite1;this.sprite2=sprite2;this.animName=animName},serialize:function(){var arr=[Types.Messages.WC_SET_SPRITE,this.id,this.sprite1];if(typeof this.sprite2!=="undefined")arr.push(this.sprite2);if(typeof this.animName!=="undefined")arr.push(this.animName);return arr}});Messages.setAnimation=Message.extend({init:function(entity,animation){this.id=entity.id;this.animation=animation},serialize:function(){return[Types.Messages.WC_SET_ANIMATION,this.id,this.animation]}});Messages.Harvest=Message.extend({init:function(player,action,gx,gy,duration){this.duration=duration||0;this.id=player.id;this.action=action;this.gx=gx;this.gy=gy},serialize:function(){var arr=[Types.Messages.WC_HARVEST,this.id,this.action,this.gx,this.gy];if(this.duration>0)arr.push(this.duration);return arr}})},{"./lib/class":44,underscore:310}],50:[function(require,module,exports){var Messages=require("./message"),_=require("underscore"),Utils=require("./utils"),Formulas=require("./formulas");module.exports=MobAI=Class.extend({init:function(ws,map){this.world=this.server=this.worldServer=ws;this.map=map},checkHitAggro:function(mob,sEntity){if(mob.isStunned||mob.isAttacking())return;if(mob.aiState!==mobState.IDLE)return;if(mob.hasTarget())return;if(mob.isAttackedBy(sEntity))this.aggroPlayer(mob,sEntity);return},checkAggro:function(mob){if(mob.isStunned||mob.isAttacking()||!mob.isAggressive){return}if(mob.aiState!==mobState.IDLE){return}if(mob.hasTarget()){return}if(!mob.canMoveAI())return;var players=this.map.entities.getPlayerAround(mob,mob.aggroRange);var level=mob.level*2;for(var player of players){if(!player.isAlive()){continue}if(level>=player.level){mob.aggroPlayer(player)}}},checkHit:function(mob){var self=this;if(mob.aiState!==mobState.ATTACKING)return;if(mob.isStunned||!mob.target||mob.freeze)return;if(!mob.canReach(mob.target)){mob.setAiState(mobState.CHASING);return}if(mob.canAttack()){console.info("mob - Is Attacking");this.handleHurt(mob)}},update:function(){var mobs=this.map.entities.mobs;for(var mobId in mobs){var mob=mobs[mobId];if(!mob.isAlive()||mob.freeze)continue;if(mob.aiState===mobState.RETURNING)return;if(mob.canAggro())this.checkAggro(mob);if(mob.hasTarget()){this.checkChase(mob);this.checkHit(mob)}}},checkChase:function(mob){var target=mob.target;if(mob.freeze){return}if(!target.isAlive()){mob.returnToSpawn();return}if(mob.aiState===mobState.IDLE){mob.setAiState(mobState.AGGRO)}if(!(mob.aiState===mobState.AGGRO||mob.aiState===mobState.CHASING)){return}if(!mob.canReach(target)){if(mob.isMovingPath()){return}if(!target.isMoving()&&mob.ptx===mob.target.x&&mob.pty===mob.target.y){return}if(mob.isMoving()&&target.isMoving()){console.info(mob.id+" monster and target is moving so abort.");return}if(mob.canMoveAI()){if(this.checkReturn(mob))return;mob.setMoveAI(Utils.randomRangeInt(25,50));mob.ptx=target.x;mob.pty=target.y;mob.followAttack(target);if(mob.path){mob.setAiState(mobState.CHASING);return}else{mob.returnToSpawn();return}}}else{if(!mob.isMovingPath()){if(mob.isOverlapping()){mob.forceStop();mob.follow(mob.target);if(mob.path)return}mob.forceStop();console.info(mob.id+" within range");mob.setAiState(mobState.ATTACKING)}}},handleHurt:function(mob){if(!mob||!mob.target||mob.freeze)return;if(mob.target.isInvincible){return}console.info("handleHurt.");if(mob.target.stats.hp>0){mob.lookAt(mob.target);console.info("handleHurt - mob");var dmg=Formulas.dmg(mob,mob.target,mob.attackTimer);var canCrit=Formulas.crit(mob,mob.target);mob.criticalHit=false;if(canCrit){dmg*=2;mob.criticalHit=true}console.info("handleHurt");this.server.handleDamage(mob.target,mob,-dmg,mob.criticalHit);mob.attackTimer=Date.now();if(!mob.target.isAlive()){mob.returnToSpawn()}}},checkReturn:function(entity){if(entity.aiState!==mobState.CHASING&&entity.aiState!==mobState.STUCK&&entity.aiState!==mobState.ROAMING){return false}var et=entity.target;if(et&&!et.isAlive()){entity.returnToSpawn();return true}if(entity.distanceToPos(entity.spawnX,entity.spawnY)>=16*G_TILESIZE||et&&entity.distanceToPos(et.x,et.y)>=12*G_TILESIZE){console.info("RETURN TO SPAWN!");entity.returnToSpawn();return true}return false},Roaming:function(player){var dist=5*G_TILESIZE;var mobs=this.map.entities.getMobsAround(player,32);for(var mob of mobs){if(!mob)continue;var rand=Utils.randomInt(10)===0;if(!rand)continue;if(mob.canRoam()){var area=mob.area;var pos=mob.map.entities.spaceEntityRandomApart(2,area._getRandomPositionForEntity.bind(area,mob,dist),mobs);if(!pos)continue;if(!(pos.x===mob.x&&pos.y===mob.y)){mob.goRoam(pos)}}}}})},{"./formulas":36,"./message":49,"./utils":66,underscore:310}],51:[function(require,module,exports){var Character=require("../entity/character"),Chest=require("../entity/chest"),Mob=require("../entity/mob"),Node=require("../entity/node"),Messages=require("../message"),Formulas=require("../formulas"),formatCheck=require("../format").check,SkillHandler=require("../skillhandler"),PartyHandler=require("./partyhandler"),ShopHandler=require("./shophandler");module.exports=PacketHandler=Class.extend({init:function(user,player,connection,worldServer,map){this.user=user;this.player=player;this.connection=connection;this.world=this.server=worldServer;this.map=player.map;this.entities=player.map.entities;this.partyHandler=new PartyHandler(this);this.shopHandler=new ShopHandler(this);var self=this;this.connection.listen(function(message){console.info("recv="+JSON.stringify(message));var action=parseInt(message[0]);if(action)if(!formatCheck(message)){self.connection.close("Invalid "+Types.getMessageTypeAsString(action)+" message format: "+message);return}message.shift();self.user.lastPacketTime=Date.now();switch(action){case Types.Messages.BI_SYNCTIME:self.handleSyncTime(message);break;case Types.Messages.CW_REQUEST:self.handleRequest(message);break;case Types.Messages.CW_WHO:self.handleWho(message);break;case Types.Messages.CW_CHAT:self.handleChat(message);break;case Types.Messages.CW_MOVE:self.handleMoveEntity(message);break;case Types.Messages.CW_MOVEPATH:self.handleMovePath(message);break;case Types.Messages.CW_ATTACK:self.handleAttack(message);break;case Types.Messages.CW_ITEMSLOT:self.handleItemSlot(message);break;case Types.Messages.CW_STORESELL:self.shopHandler.handleStoreSell(message);break;case Types.Messages.CW_STOREBUY:self.shopHandler.handleStoreBuy(message);break;case Types.Messages.CW_CRAFT:self.shopHandler.handleCraft(message);break;case Types.Messages.CW_APPEARANCEUNLOCK:self.handleAppearanceUnlock(message);break;case Types.Messages.CW_LOOKUPDATE:self.handleLookUpdate(message);break;case Types.Messages.CW_AUCTIONSELL:self.shopHandler.handleAuctionSell(message);break;case Types.Messages.CW_AUCTIONBUY:self.shopHandler.handleAuctionBuy(message);break;case Types.Messages.CW_AUCTIONOPEN:self.shopHandler.handleAuctionOpen(message);break;case Types.Messages.CW_AUCTIONDELETE:self.shopHandler.handleAuctionDelete(message);break;case Types.Messages.CW_STORE_MODITEM:self.shopHandler.handleStoreModItem(message);break;case Types.Messages.CW_CHARACTERINFO:self.handleCharacterinfo(message);break;case Types.Messages.CW_TELEPORT_MAP:self.handleTeleportMap(message);break;case Types.Messages.CW_LOOT:self.handleLoot(message);break;case Types.Messages.CW_TALKTONPC:self.handleTalkToNPC(message);break;case Types.Messages.CW_QUEST:self.handleQuest(message);break;case Types.Messages.CW_GOLD:self.handleGold(message);break;case Types.Messages.CW_STATADD:self.handleStatAdd(message);break;case Types.Messages.CW_SKILL:self.handleSkill(message);break;case Types.Messages.CW_SHORTCUT:self.handleShortcut(message);break;case Types.Messages.CW_BLOCK_MODIFY:self.handleBlock(message);break;case Types.Messages.CW_PARTY:self.partyHandler.handleParty(message);break;case Types.Messages.CW_HARVEST:self.handleHarvest(message);break;case Types.Messages.CW_USE_NODE:self.handleUseNode(message);break;default:if(self.message_callback)self.player.message_callback(message);break}});this.connection.onClose(function(){console.info("Player: "+self.player.name+" has exited the world.");self.player.save();console.info("REMOVING PLAYER FROM WORLD.");if(self.exit_callback){console.info("exit callback.");self.exit_callback(self.player)}console.info("onClose - called");clearTimeout(this.disconnectTimeout);this.close("onClose")})},setMap:function(map){this.map=map;this.entities=map.entities},timeout:function(){this.connection.sendUTF8("timeout");this.connection.close("Player was idle for too long")},broadcast:function(message,ignoreSelf){if(this.broadcast_callback){this.broadcast_callback(message,ignoreSelf===undefined?true:ignoreSelf)}},onExit:function(callback){console.info("packetHandler, onExit.");this.exit_callback=callback},onMove:function(callback){this.move_callback=callback},onMessage:function(callback){this.message_callback=callback},onBroadcast:function(callback){this.broadcast_callback=callback},send:function(message){this.connection.send(message)},sendPlayer:function(message){this.player.sendPlayer(message)},sendToPlayer:function(player,message){this.player.sendToPlayer(player,message)},handleCharacterInfo:function(message){this.sendPlayer(new Messages.CharacterInfo(this.player))},handleSyncTime:function(message){console.info("handleSyncTime");var clientTime=parseInt(message[0]);this.send([Types.Messages.BI_SYNCTIME,clientTime,Date.now()])},handleChat:function(message){var msg=Utils.sanitize(message[0]);console.info("Chat: "+this.player.name+": "+msg);if((new Date).getTime()>this.player.chatBanEndTime){this.send([Types.Messages.WC_NOTIFY,"CHAT","CHATMUTED"]);return}if(msg&&(msg!==""||msg!==" ")){msg=msg.substr(0,256);var command=msg.split(" ",3);switch(command[0]){case"/w":this.send([Types.Messages.WC_NOTIFY,"CHAT","CHATMUTED"]);break;default:this.server.sendWorld(new Messages.Chat(this.player,msg));break}}},handleQuest:function(msg){console.info("handleQuest");var npcId=parseInt(msg[0]);var questId=parseInt(msg[1]);var status=parseInt(msg[2]);var npc=this.entities.getEntityById(npcId);if(!this.player.isInScreen(npc)){console.info("player not close enough to NPC!");return}if(status===1)npc.entityQuests.acceptQuest(this.player,questId);else{npc.entityQuests.rejectQuest(this.player,questId)}},handleTalkToNPC:function(message){console.info("handleTalkToNPC");var type=parseInt(message[0]);var npcId=parseInt(message[1]);var npc=this.entities.getEntityById(npcId);if(!this.player.isInScreen(npc)){console.info("player not close enough to NPC!");return}if(npc)npc.talk(this.player)},handleAppearanceUnlock:function(message){var appearanceIndex=parseInt(message[0]);var priceClient=parseInt(message[1]);if(appearanceIndex<0||appearanceIndex>=AppearanceData.Data.length)return;var itemData=AppearanceData.Data[appearanceIndex];if(!itemData)return;if(!(itemData.type==="armorarcher"||itemData.type==="armor"))return;var price=this.server.looks.prices[appearanceIndex];if(price!==priceClient){this.sendPlayer(new Messages.Notify("SHOP","SHOP_MISMATCH",[itemData.name]));this.server.looks.sendLooks(this.player);return}var gemCount=0;if(appearanceIndex>=0){gemCount=this.player.user.gems;console.info("gemCount="+gemCount);if(gemCount>=price){this.player.user.looks[appearanceIndex]=1;this.player.modifyGems(-price);this.server.looks.prices[appearanceIndex]+=100;this.sendPlayer(new Messages.Notify("SHOP","SHOP_SOLD",[itemData.name]));this.server.looks.sendLooks(this.player)}else{this.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGEMS"))}}},handleLookUpdate:function(message){var type=parseInt(message[0]),id=parseInt(message[1]);var p=this.player;if(id<0||id>=AppearanceData.Data.length)return;if(type<0||type>1)return;var itemData=AppearanceData.Data[id];if(!itemData)return;if(!(itemData.type==="armorarcher"||itemData.type==="armor"))return;var appearance=this.player.user.looks[id];if(appearance===1){if(type===0){p.setSprite(0,id)}}p.broadcastSprites()},handleItemSlot:function(msg){var self=this;var action=parseInt(msg[0]);if(this.player.isDead)return;var slot=[Number(msg[1]),Number(msg[2]),Number(msg[3])];if(slot[0]===2&&slot[1]>this.player.equipment.maxNumber)return;var item=null;if(slot[1]>=0)item=this.player.getStoredItem(slot[0],slot[1],slot[2]);var slot2=null;if(msg.length===6){slot2=[Number(msg[4]),Number(msg[5])];if(slot[0]===slot2[0]&&slot[1]===slot2[1])return}if(action===0){this.player.handleInventoryEat(item,slot[1])}else if(action===1){this.player.swapItem(slot,slot2)}else if(action===2){this.player.handleStoreEmpty(slot,item)}},handleLoot:function(message){console.info("handleLoot");item=this.entities.getEntityById(parseInt(message[0]));if(!item){console.info("no item.");return}var x=parseInt(message[1]),y=parseInt(message[2]);if(!this.player.isWithinDist(x,y,24)){console.info("Player is not close enough to item.");return}console.info("item="+item.toString());if(item.enemyDrop)console.info("enemyDrop");if(item instanceof Item){if(this.player.inventory.putItem(item.room)>=0){this.server.taskHandler.processEvent(this.player,PlayerEvent(EventType.LOOTITEM,item,1));this.broadcast(item.despawn(),false);this.entities.removeEntity(item)}}},handleAttack:function(message){console.info("handleAttack");var self=this;var time=parseInt(message[0]);var p=this.player;if(p.isDead)return;if(p.movement.inProgress){p.attackQueue.push(message)}else{self.handleHitEntity(p,message)}},processAttack:function(){var self=this;var p=this.player;if(p.movement.inProgress){for(var msg of p.attackQueue){console.info("processAttack, handle hit");self.handleHitEntity(p,msg)}}this.player.attackQueue=[]},handleHitEntity:function(sEntity,message){var self=this;console.info("handleHitEntity");console.info("message: "+JSON.stringify(message));var targetId=parseInt(message[1]),orientation=parseInt(message[2]),skillId=parseInt(message[3]);if(targetId<0){console.warn("invalid targetId");return}var tEntity=this.entities.getEntityById(targetId);if(!tEntity){console.warn("invalid entity");return}var attackTime=Date.now()-sEntity.attackTimer;if(attackTime<ATTACK_INTERVAL){console.warn("attack interval");return}if(tEntity instanceof Player&&sEntity instanceof Player&&(sEntity.level<20||tEntity.level<20||Math.abs(sEntity.level-tEntity.level)>10)){console.warn("pvp invalid diff");return}if(tEntity.aiState===mobState.RETURNING)return;if(tEntity.invincible){this.sendPlayer(new Messages.Notify("CHAT","COMBAT_TARGETINVINCIBLE"));console.warn("target invincible");return}if(this.map.isColliding(sEntity.x,sEntity.y)){console.warn("char.isColliding("+sEntity.id+","+sEntity.x+","+sEntity.y+")");return}if(skillId>=0){this.handleSkill([skillId,targetId,tEntity.x,tEntity.y])}sEntity.setOrientation(orientation);sEntity.engage(tEntity);if(sEntity===this.player){if(!sEntity.canReach(tEntity)){console.info("Player not close enough!");console.info("p.x:"+sEntity.x+",p.y:"+sEntity.y);console.info("e.x:"+tEntity.x+",e.y:"+tEntity.y);console.info("dx:"+Math.abs(sEntity.x-tEntity.x)+",dy:"+Math.abs(sEntity.y-tEntity.y));return}if(!sEntity.attackedTime.isOver()){console.warn("attackedTime is not over.");return}sEntity.isHarvesting=false;sEntity.lastAction=Date.now()}sEntity.isBlocking=false;sEntity.attackedTime.duration=500;sEntity.hasAttacked=true;var fnDamage=function(sEntity,tEntity,damageObj){if(sEntity instanceof Player&&tEntity instanceof Mob){tEntity.mobAI.checkHitAggro(tEntity,sEntity)}self.dealDamage(sEntity,tEntity,damageObj.damage,damageObj.crit)};if(sEntity.effectHandler){sEntity.effectHandler.interval("beforehit",0)}var damageObj=this.calcDamage(sEntity,tEntity,null,0);var addDamage=0;if(sEntity.effectHandler){sEntity.effectHandler.interval("onhit",damageObj.damage);for(var skillEffect of sEntity.activeEffects){var data=skillEffect.data;if(data.skillType==="attack"&&data.targetType==="enemy_aoe"){var damageObjAOE=this.calcDamageAOE(sEntity,null,0);for(var target of skillEffect.targets){if(target===tEntity)continue;else fnDamage(sEntity,target,damageObjAOE)}}}}fnDamage(sEntity,tEntity,damageObj);if(sEntity.attackTimer)sEntity.attackTimer=Date.now();if(sEntity.effectHandler){sEntity.effectHandler.interval("afterhit",0)}},calcDamageAOE:function(sEntity,skill,attackType){var damageObj={damage:0,crit:0,dot:0};damageObj.damage=Math.round(Formulas.dmgAOE(sEntity));return damageObj},calcDamage:function(sEntity,tEntity,skill,attackType){var damageObj={damage:0,crit:0,dot:0};damageObj.damage=Math.round(Formulas.dmg(sEntity,tEntity));if(damageObj.damage===0)return damageObj;var canCrit=Formulas.crit(sEntity,tEntity);if(canCrit){damageObj.damage*=2;damageObj.crit=1}return damageObj},dealDamage:function(sEntity,tEntity,dmg,crit){if(!tEntity)return;if(tEntity instanceof Mob)tEntity.aggroPlayer(sEntity);this.server.handleDamage(tEntity,sEntity,-dmg,crit);if(sEntity instanceof Player)sEntity.weaponDamage+=dmg;console.info("DAMAGE OCCURED "+dmg);if(tEntity instanceof Player){if(tEntity.isDead){if(sEntity===self.player)self.player.map.entities.sendBroadcast(new Messages.Notify("CHAT","COMBAT_PLAYERKILLED",[sEntity.name,tEntity.name]));sEntity.pStats.pk++;tEntity.pStats.pd++}}},handleShortcut:function(message){var slot=parseInt(message[0]);var type=parseInt(message[1]);var shortcutId=parseInt(message[2]);if(slot<0||slot>7)return;if(type===2){if(shortcutId<0||shortcutId>=SkillData.Skills.length)return}this.player.shortcuts[slot]=[slot,type,shortcutId]},handleSkill:function(message){var skillId=parseInt(message[0]),targetId=parseInt(message[1]),x=parseInt(message[2]),y=parseInt(message[3]),p=this.player;if(p.isDead)return;if(skillId<0||skillId>=p.skills.length)return;var skill=p.skills[skillId];var target;if(targetId){target=this.entities.getEntityById(targetId);if(!target)return}if(!skill.isReady())return;p.effectHandler.cast(skillId,target,x,y);this.handleSkillEffects(p,target)},handleSkillEffects:function(source,target){var effects=[];if(!source.effects)return;for(let[k,v]of Object.entries(source.effects)){if(v===1)effects.push(parseInt(k))}this.sendToPlayer(source,new Messages.SkillEffects(source,effects));effects=[];if(!target)return;for(let[k,v]of Object.entries(target.effects)){if(v===1)effects.push(parseInt(k))}this.sendToPlayer(source,new Messages.SkillEffects(target,effects))},handleMoveEntity:function(message){console.info("handleMoveEntity");var time=parseInt(message[0]),entityId=parseInt(message[1]),state=parseInt(message[2]),orientation=parseInt(message[3]),x=parseInt(message[4])||-1,y=parseInt(message[5])||-1;var p=this.player;if(entityId!==p.id)return;if(state==1&&p.hasMoveThrottled(G_LATENCY)){console.error("moveThrottled");return}if(p.map.isColliding(x,y)){console.warn("char.isColliding("+p.id+","+x+","+y+")");return}if(state===2){if(p.isMovingPath()&&p.fullpath){p.abort_pathing_callback(x,y);p.forceStop()}return}var arr=[time,state,orientation,x,y];if(state){p.move([time,false,p.orientation,x,y]);if(!p.checkStartMove(x,y))return}p.move(arr);var msg=new Messages.Move(p,orientation,state,x,y);p.map.entities.sendNeighbours(p,msg,p);if(this.move_callback)this.move_callback()},handleMovePath:function(message){console.info("handleMovePath");console.info("message="+JSON.stringify(message));var time=parseInt(message.shift()),entityId=parseInt(message.shift()),orientation=parseInt(message.shift()),interrupted=parseInt(message.shift())===0?false:true;var path=message[0];var p=this.player;if(entityId!==p.id)return;if(path&&p.hasMoveThrottled(G_LATENCY))return;console.info(JSON.stringify(path));var x=path[0][0],y=path[0][1];if(!p.checkStartMove(x,y))return;if(p.mapStatus<2)return;if(!this.entities.pathfinder.checkValidPath(path)){console.warn("handleMovePath: checkValidPath false.");p.resetMove(p.x,p.y);return}if(!this.entities.pathfinder.isValidPath(p.map.grid,path)){console.warn("handleMovePath: no valid path.");p.resetMove(p.x,p.y);return}p.movePath([time,interrupted],path);var msg=new Messages.MovePath(p,path);p.map.entities.sendNeighbours(p,msg)},handleTeleportMap:function(msg){console.info("handleTeleportMap");var self=this;var mapId=parseInt(msg[0]),status=parseInt(msg[1]);console.info("status="+status);var x=parseInt(msg[2]),y=parseInt(msg[3]);var p=this.player;if(status<=0){x=-1;y=-1}var mapInstanceId=null;var mapName=null;if(mapId<0||mapId>=self.server.maps.length){console.info("Map non-index");return}var map=self.server.maps[mapId];if(!(map&&map.ready)){console.info("Map non-existant or not ready");return}console.warn("mapIndex: p.map.mapIndex:"+map.index);if(status===0){p.forceStop();p.mapStatus=0;p.clearTarget();p.handleTeleport();this.entities.removePlayer(p);var finishTeleportMaps=function(mapId){p.setMap(map);var pos={x:p.x,y:p.y};console.info("handleTeleportMap - x: "+x+",y:"+y);console.warn("mapIndex: p.map.mapIndex:"+map.index);if(typeof p.prevPosX==="undefined"&&typeof p.prevPosY==="undefined"){p.prevPosX=p.x;p.prevPosY=p.y;pos=self.map.getRandomStartingPosition()}else if(p.map.index===0){p.prevPosX=p.x;p.prevPosY=p.y;pos=self.map.getRandomStartingPosition()}else if(p.map.index===1){if(p.hasOwnProperty("prevPosX")&&p.hasOwnProperty("prevPosY"))pos={x:p.prevPosX,y:p.prevPosY};else pos=self.map.getRandomStartingPosition()}else{pos=self.map.getRandomStartingPosition()}self.entities.addPlayer(p);p.ex=p.sx=pos.x;p.ey=p.sy=pos.y;p.setPosition(pos.x,pos.y);p.move([Date.now(),3,1,pos.x,pos.y]);console.info("trying to send.");self.send([Types.Messages.WC_TELEPORT_MAP,mapId,1,p.x,p.y])};pos=map.enterCallback(p);finishTeleportMaps(mapId)}else if(status===1){p.mapStatus=2;self.handleSpawnMap(mapId,p.x,p.y);self.send([Types.Messages.WC_TELEPORT_MAP,mapId,2,p.x,p.y])}},handleSpawnMap:function(mapId,x,y){var p=this.player;p.knownIds=[];p.setPosition(x,y);this.entities.processWho(p);p.map.entities.sendNeighbours(p,new Messages.Spawn(p),p)},handleStatAdd:function(message){var self=this;var attribute=parseInt(message[0]),points=parseInt(message[1]);var p=this.player;if(points<0||points>p.stats.free)return;if(attribute<=0||attribute>4)return;var alterBars=false;switch(attribute){case 1:p.stats.attack+=points;break;case 2:p.stats.defense+=points;break;case 3:p.stats.health+=points;alterBars=true;break;case 4:p.stats.luck+=points;break}p.stats.free-=points;if(alterBars){p.setHPMax();p.setEPMax()}this.sendPlayer(new Messages.StatInfo(p))},handleGold:function(message){var type=parseInt(message[0]),gold=parseInt(message[1]),type2=parseInt(message[2]);if(gold<0)return;if(gold>9999999){this.sendPlayer(new Messages.Notify("GOLD","MAX_TRANSFER"));return}if(gold>this.player.gold[type]){this.sendPlayer(new Messages.Notify("GOLD","INSUFFICIENT_GOLD"));return}if(type===0&&type2===1){if(this.player.modifyGold(-gold,0))this.player.modifyGold(gold,1)}if(type===1&&type2===0){if(this.player.modifyGold(-gold,1))this.player.modifyGold(gold,0)}},handleBlock:function(msg){var type=parseInt(msg[0]),id=parseInt(msg[1]),x=parseInt(msg[2]),y=parseInt(msg[3]);var p=this.player;var block=this.map.entities.getEntityById(id);if(!block||!(block instanceof Block))return;if(!p.isNextTooEntity(block))return;if(type===0){p.holdingBlock=block}else if(type===1){x=Utils.roundTo(x,G_TILESIZE);y=Utils.roundTo(y,G_TILESIZE);if(this.map.isColliding(x,y))return;block.setPosition(x,y);block.update(this.player);p.holdingBlock=null}var msg=new Messages.BlockModify(block,p.id,type);p.map.entities.sendNeighbours(p,msg,p)},handleRequest:function(msg){var type=parseInt(msg);switch(type){case 0:this.handleAppearanceList(msg);break;case 1:this.handleRevive(msg);break;case 2:this.handlePlayerInfo(msg);break;case 3:this.entities.processWho(this.player);break}},handleAppearanceList:function(msg){this.server.looks.sendLooks(this.player)},handleRevive:function(msg){var p=this.player;if(p.isDead===true){console.info("handled Revive!!");p.respawn();p.map.entities.sendNeighbours(p,new Messages.Spawn(p),p);var msg=new Messages.Move(p,p.orientation,2,p.x,p.y);this.sendPlayer(msg)}},handlePlayerInfo:function(msg){this.sendPlayer(new Messages.PlayerInfo(this.player))},handleWho:function(message){var ids=[];if(message.length>0)ids=message;for(var id of ids)this.player.knownIds.splice(this.player.knownIds.indexOf(id),1)},handleHarvest:function(msg){var x=parseInt(msg[0]),y=parseInt(msg[1]);this.player.onHarvest(x,y)},handleUseNode:function(msg){var id=parseInt(msg[0]);var entity=this.entities.getEntityById(id);this.player.onHarvestEntity(entity)}})},{"../entity/character":24,"../entity/chest":25,"../entity/mob":29,"../entity/node":30,"../format":35,"../formulas":36,"../message":49,"../skillhandler":59,"./partyhandler":52,"./shophandler":53}],52:[function(require,module,exports){var Messages=require("../message.js");module.exports=PartyHandler=Class.extend({init:function(packetHandler){this.ph=packetHandler;this.world=this.ph.world;this.player=this.ph.player},getPlayer:function(name){name=name.toLowerCase();var player=this.world.getPlayerByName(name);if(!player){this.player.sendPlayer(new Messages.Notify("CHAT","NO_PLAYER_EXIST",[name]));return null}return player},handleParty:function(msg){var partyType=msg.shift();switch(partyType){case 1:this.handleInvite(msg);break;case 2:this.handleKick(msg);break;case 3:this.handleLeader(msg);break;case 4:this.handleLeave(msg);break}},handleInvite:function(msg){var name=msg[0];var player2=this.getPlayer(name);if(!player2){return}var status=msg[1];var curParty=this.player.party;if(this.player===player2)return;if(status===0){if(curParty&&curParty.players.length>=5){this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_MAX_PLAYERS"));return}if((!curParty||curParty.leader)&&player2 instanceof Player){this.player.sendToPlayer(player2,new Messages.PartyInvite(this.player.id));this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_PLAYER_INVITE_SENT",[player2.name]))}}else if(status===1){if(player2.party){player2.party.removeName(player2)}if(curParty){if(curParty.players.length>=5){this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_MAX_PLAYERS"));return}curParty.addName(player2)}else{if(this.world&&this.world.party)this.world.party.addParty(player2,this.player);else{console.warn("no world or no world party.")}}if(player2){this.player.sendToPlayer(player2,new Messages.Notify("CHAT","PARTY_PLAYER_JOINED",[this.player.name]));this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_PLAYER_ADDED",[player2.name]))}}else if(status===2){this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_YOU_REJECTED_INVITE",[player2.name]));this.player.sendToPlayer(player2,new Messages.Notify("CHAT","PARTY_THEY_REJECTED_INVITE",[player2.name]))}},handleKick:function(msg){var name=msg[0];var player2=this.getPlayer(name);if(!player2){return}if(this.player===player2)return;var party=this.player.party;if(!party){this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_CANNOT_KICK"));return}if(this.player===party.leader){party.removeName(player2);if(player2 instanceof Player)this.player.sendToPlayer(player2,new Messages.Notify("CHAT","PARTY_PLAYER_KICKED"));this.handlePartyAbandoned(party)}else{this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_CANNOT_KICK"))}},handleLeader:function(msg){var name=msg[0];var player2=this.getPlayer(name);if(!player2){return}if(this.player===player2)return;var party=this.player.party;if(!party){this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_NOT_LEADER"));return}if(this.player===party.leader){party.setLeader(player2.name);this.player.sendToPlayer(player2,new Messages.Notify("CHAT","PARTY_YOU_LEADER"));this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_PLAYER_LEADER",[party.leader.name]))}else{this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_IS_LEADER",[party.leader.name]))}party.sendMembersName()},handleLeave:function(msg){var party=this.player.party;var leader=party?party.leader:null;if(leader===null)return;if(!party){this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_NOT_IN"));return}party.removeName(this.player);this.handleAbandoned(party);this.player.sendToPlayer(leader,new Messages.Notify("CHAT","PARTY_PLAYER_LEFT",[this.player.name]));if(this.player!==leader)this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_YOU_LEFT",[leader.name]))},handleAbandoned:function(party){if(party.players.length!==1)return;this.player.sendPlayer(new Messages.Notify("CHAT","PARTY_ALL_LEFT"));this.player.sendPlayer(new Messages.Party([]));if(this.player!==party.players[0]&&party.players[0]instanceof Player){this.player.sendToPlayer(party.players[0],new Messages.Notify("CHAT","PARTY_ALL_LEFT"));this.player.sendToPlayer(party.players[0],new Messages.Party([]))}if(this.world&&this.world.party)this.world.party.removeParty(party);else{console.warn("no world or no world party.")}}})},{"../message.js":49}],53:[function(require,module,exports){var Messages=require("../message.js");module.exports=ShopHandler=Class.extend({init:function(packetHandler){this.ph=packetHandler;this.world=this.ph.world;this.player=this.ph.player},handleStoreSell:function(message){var type=parseInt(message[0]);var itemIndex=parseInt(message[1]);var item=this.player.itemStore[0].rooms[itemIndex];if(!item)return;var kind=item.itemKind;if(ItemTypes.isConsumableItem(kind)||ItemTypes.isLootItem(kind))return;var price=ItemTypes.getEnchantSellPrice(item);if(price<0)return;var itemKind=item.itemKind;this.player.inventory.makeEmptyItem(itemIndex);this.player.modifyGold(price);var itemName=ItemTypes.KindData[itemKind].name;this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_SOLD",[itemName]))},handleAuctionSell:function(message){var itemIndex=parseInt(message[0]),price=parseInt(message[1]);if(price<0||itemIndex<0||itemIndex>=this.player.inventory.maxNumber)return;var item=this.player.inventory.rooms[itemIndex];console.info(JSON.stringify(item));var kind=item.itemKind;if(ItemTypes.isConsumableItem(kind)||ItemTypes.isLootItem(kind))return;if(kind){this.world.auction.add(this.player,item,price,itemIndex);this.world.auction.list(this.player,0);this.player.inventory.setItem(itemIndex,null)}},handleAuctionOpen:function(message){var type=parseInt(message[0]);if(type>=0&&type<=3)this.world.auction.list(this.player,type)},handleAuctionBuy:function(message){var auctionIndex=parseInt(message[0]),type=parseInt(message[1]);if(auctionIndex<0||auctionIndex>=this.world.auction.auctions.length)return;if(type<0||type>3)return;var auctions=this.world.auction;var auction=this.world.auction.auctions[auctionIndex];if(!auction)return;if(auction.playerName===this.player.name)return;var price=auction.price;if(price<0)return;var goldCount=this.player.gold[0];if(goldCount<price){this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGOLD"));return}if(!this.player.inventory.hasRoom()){this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_NOSPACE"));return}var itemKind=auction.item.itemKind;if(auctions.putItem(this.player,auction.item)){this.player.modifyGold(-price);var itemName=ItemTypes.KindData[itemKind].name;this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_SOLD",[itemName]));var auctionPlayer=this.world.getPlayerByName(auction.playerName);if(auctionPlayer){auctionPlayer.modifyGold(price)}else{if(this.world.userHandler)this.world.userHandler.sendPlayerGold(auction.playerName,price);else{console.warn("packetHander handleAuctionBuy: no world userHandler.")}}this.world.auction.remove(auctionIndex);this.world.auction.list(this.player,type)}},handleAuctionDelete:function(message){var auctionIndex=parseInt(message[0]),type=parseInt(message[1]);if(auctionIndex<0||auctionIndex>=this.world.auction.auctions.length)return;if(type<0||type>3)return;var auctions=this.world.auction;var auction=auctions.auctions[auctionIndex];if(!auction)return;if(auction.playerName!==this.player.name){return}if(!this.player.inventory.hasRoom()){this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_NOSPACE"));return}var itemKind=auction.item.itemKind;if(auctions.putItem(this.player,auction.item)){var itemName=ItemTypes.KindData[itemKind].name;this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_REMOVED",[itemName]));this.world.auction.remove(auctionIndex);this.world.auction.list(this.player,type)}},handleStoreModItem:function(msg){var modType=parseInt(msg[0]),type=parseInt(msg[1]),itemIndex=parseInt(msg[2]);if(type===0||type===2){var itemStore=this.player.itemStore[type];if(itemIndex<0&&itemIndex>=itemStore.maxNumber)return;var item=this.player.itemStore[type].rooms[itemIndex];if(modType===0)this._repairItem(type,item,itemIndex);if(modType===1)this._enchantItem(type,item,itemIndex)}},_repairItem:function(type,item,index){var itemKind=null,price=0;if(!(item&&item.itemKind))return;if(!ItemTypes.isEquipment(item.itemKind))return;if(item.itemDurability===item.itemDurabilityMax)return;price=~~ItemTypes.getRepairPrice(item);if(price<=0)return;goldCount=this.player.gold[0];if(goldCount<price){this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGOLD"));return}item.itemDurabilityMax-=50;item.itemDurability=item.itemDurabilityMax;if(item.itemDurabilityMax<=0){item=null;this.player.itemStore[type].makeEmptyItem(index)}else{console.info("itemNumber="+item.itemNumber);this.player.modifyGold(-price)}item.slot=index;this.player.sendPlayer(new Messages.ItemSlot(type,[item]));var itemName=ItemTypes.KindData[item.itemKind].name;this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_REPAIRED",[itemName]))},_enchantItem:function(type,item,index){var itemKind=null,price=0;if(!(item&&item.itemKind))return;if(!ItemTypes.isEquipment(item.itemKind))return;price=ItemTypes.getEnchantPrice(item);if(price<=0)return;goldCount=this.player.gold[0];if(goldCount<price){this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGOLD"));return}item.itemExperience=ItemTypes.itemExpForLevel[item.itemNumber-1];item.itemNumber++;item.slot=index;this.player.sendPlayer(new Messages.ItemSlot(type,[item]));console.info("itemNumber="+item.itemNumber);this.player.modifyGold(-price);var itemName=ItemTypes.KindData[item.itemKind].name;this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_ENCHANTED",[itemName]))},handleStoreBuy:function(message){var itemType=parseInt(message[0]),itemKind=parseInt(message[1]),itemCount=parseInt(message[2]),itemName=null,price=0,goldCount=0,buyCount=0;if(!itemKind||itemCount<=0){return}if(itemKind<0||itemKind>=ItemTypes.KindData.length)return;var itemData=ItemTypes.KindData[itemKind];var itemName=itemData.name;price=ItemTypes.getBuyPrice(itemKind);if(price>0){if(ItemTypes.Store.isBuyMultiple(itemKind)){itemCount=itemData.buycount}goldCount=this.player.gold[0];if(goldCount<price){this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGOLD"));return}var consume=ItemTypes.isConsumableItem(itemKind);if(consume||!consume&&this.player.inventory.hasRoom()){var item=new ItemRoom([itemKind,itemCount,0,0,0]);var res=this.player.inventory.putItem(item);if(res===-1)return;this.player.modifyGold(-price);this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_BUY",[itemName]))}else{this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_NOSPACE"))}}},handleCraft:function(message){var craftId=parseInt(message[0]),itemCount=parseInt(message[1]),itemName=null,price=0,goldCount=0,buyCount=0;if(itemCount<=0){return}if(craftId<0||craftId>=ItemData.CraftData.length)return;var craftData=ItemData.CraftData[craftId];var itemKind=Number(craftData.o);if(!ItemTypes.KindData.hasOwnProperty(itemKind)){console.error("handleCraft - itemData not found for kind: "+itemKind);return}var itemData=ItemTypes.KindData[itemKind];var itemName=itemData.name;price=ItemTypes.getCraftPrice(itemKind);if(price<0)return;if(ItemTypes.Store.isBuyMultiple(itemKind)){itemCount=itemCount<itemData.buycount?itemCount:itemData.buycount}else{itemCount=1}price=price*itemCount;goldCount=this.player.gold[0];if(goldCount<price){this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_NOGOLD"));return}if(itemData.craft.length===0)return;for(var it of craftData.i){if(!this.player.inventory.hasItems(it[0],it[1]*itemCount)){this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_NOCRAFTITEMS"));return}}if(!this.player.inventory.hasRoom()){this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_NOSPACE"));return}this.player.modifyGold(-price);for(var it of craftData.i){this.player.inventory.removeItemKind(it[0],it[1]*itemCount)}var durability=0;if(ItemTypes.isWeapon()||ItemTypes.isArmor())durability=900;var item=new ItemRoom([itemKind,itemCount,durability,durability]);if(this.player.inventory.putItem(item)===-1)return;this.player.sendPlayer(new Messages.Notify("SHOP","SHOP_BUY",[itemName]))}})},{"../message.js":49}],54:[function(require,module,exports){var astar=require("./lib/astar");var Utils=require("./utils");module.exports=Pathfinder=Class.extend({init:function(width,height){this.width=width;this.height=height;this.grid=null;this.blankGrid=[];this.initBlankGrid_();this.ignored=[];this.included=[]},initBlankGrid_:function(){},isPathTicksTooFast:function(entity,path,startTime,tolerance){tolerance=tolerance||G_FRAME_INTERVAL*2;console.info("pathFinder - isPathTicksTooFast:");var elapsed=Date.now()-startTime;var elapsedTicks=~~(elapsed*(entity.tick/G_FRAME_INTERVAL_EXACT));elapsedTicks=Math.max(elapsedTicks,0);var actualTicks=this.getPathTicks(path,entity.x,entity.y);if(actualTicks>elapsedTicks+tolerance){console.warn("SPEED HACK DETECTED. playerTicks - actualTicks: "+actualTicks+", elapsedTicks:"+elapsedTicks+", tolerance:"+tolerance);return true}return false},getPathTicks:function(path,x,y){count=0;var n2=null;for(var n1 of path){if(n2){if(x==n1[0]&&x==n2[0]&&y>=Math.min(n1[1],n2[1])&&y<=Math.max(n1[1],n2[1])){count+=Math.abs(n2[1]-y);break}if(y==n1[1]&&y==n2[1]&&x>=Math.min(n1[0],n2[0])&&x<=Math.max(n1[0],n2[0])){count+=Math.abs(n2[0]-x);break}else{count+=Math.abs(n1[0]-n2[0])+Math.abs(n1[1]-n2[1])}}n2=n1}return count},getPathTicks2:function(path){var node2;var total=0;for(var node1 of path){if(node2){total+=Math.abs(node1[0]-node2[0])+Math.abs(node1[1]-node2[1])}node2=node1}return total},getPathUntil:function(path,dist){if(dist<0)return null;var totalDist=this.getPathTicks2(path);var subDist=totalDist-dist;var node2;var newPath=[];var subTotal=0;for(var node1 of path){if(node2){var dx=Math.abs(node1[0]-node2[0]);var dy=Math.abs(node1[1]-node2[1]);var dist=dx+dy;subTotal+=dist;if(subTotal===subDist){newPath.push(node1);break}else if(subTotal>subDist){var node3=node1;var tdiff=subTotal-subDist;if(dx>0)node3[0]+=node1[0]-node2[0]<0?tdiff:-tdiff;if(dy>0)node3[1]+=node1[1]-node2[1]<0?tdiff:-tdiff;newPath.push(node3);break}}node2=node1;newPath.push(node1)}return newPath},isInPath:function(path,node){var tmpPath=path.map(function(arr){return arr.slice()});var node1=tmpPath.shift();for(var node2 of tmpPath){if(node1[0]===node2[0]&&node1[1]>=node[1]&&node2[1]<=node[1]||node1[1]===node2[1]&&node1[0]>=node[0]&&node2[0]<=node[0])return true;node1=node2}return false},checkValidPath:function(path){var pnode=null;if(!Array.isArray(path)||path.length<2)return false;for(var node of path){if(pnode){if(pnode[0]===node[0]||pnode[0]===node[1]||pnode[1]===node[0]||pnode[1]===node[1]){pnode=node;continue}return false}pnode=node}return true},isValidPath:function(grid,path,isGridPath){var ts=G_TILESIZE,ly=grid.length,lx=grid[0].length;var c1to2on3=function(n1,n2,n3,axis_x){n1=Math.floor(n1),n2=Math.floor(n2),n3=Math.floor(n3);var i1=Math.min(n1,n2),i2=Math.max(n1,n2);if(axis_x){for(var i=i1;i<i2;i++){if(grid[n3][i]){return false}}}else{for(var i=i1;i<i2;i++){if(grid[i][n3]){return false}}}return true};var xf=function(x1,x2,y){return c1to2on3(x1,x2,y,true)};var yf=function(y1,y2,x){return c1to2on3(y1,y2,x,false)};var path2=[];for(var i=0;i<path.length;i++)path2[i]=path[i].slice();if(!isGridPath){for(var coord of path2){coord[0]/=ts;coord[1]/=ts}}var pCoord=null;for(var coord of path2){if(coord[1]<0||coord[1]>=ly)return false;if(coord[0]<0||coord[0]>=lx)return false;if(pCoord){if(coord[0]!=pCoord[0]&&coord[1]!=pCoord[1])return false;if(Math.abs(coord[0]-pCoord[0])>0){if(!xf(pCoord[0],coord[0],coord[1]))return false}else if(Math.abs(coord[1]-pCoord[1])>0){if(!yf(pCoord[1],coord[1],coord[0]))return false}}pCoord=coord}return true},getShortGrid:function(grid,start,end,gridEdges){var ts=G_TILESIZE;start=[start[0]/ts,start[1]/ts];end=[end[0]/ts,end[1]/ts];var minX=Math.max(Math.min(Math.floor(start[0]),Math.floor(end[0]))-gridEdges,0);var maxX=Math.min(Math.max(Math.ceil(start[0]),Math.ceil(end[0]))+gridEdges,grid[0].length-1);var minY=Math.max(Math.min(Math.floor(start[1]),Math.floor(end[1]))-gridEdges,0);var maxY=Math.min(Math.max(Math.ceil(start[1]),Math.ceil(end[1]))+gridEdges,grid.length-1);start=[start[0]-minX,start[1]-minY];end=[end[0]-minX,end[1]-minY];maxX=Math.min(grid[0].length-1,maxX);maxY=Math.min(grid.length-1,maxY);var crop=new Array(maxY-minY);for(var j=0,i=minY;i<=maxY;++i){crop[j++]=grid[i].slice(minX,maxX)}return{crop:crop,minX:minX,minY:minY,substart:start,subend:end}},findNeighbourPath:function(start,end){var ts=G_TILESIZE;if(Math.abs(start[0]-end[0])<=ts&&Math.abs(start[1]-end[1])===0||Math.abs(start[1]-end[1])<=ts&&Math.abs(start[0]-end[0])===0)return[[start[0],start[1]],[end[0],end[1]]];return null},getFullFromShortPath:function(subpath,offsetX,offsetY){var ts=G_TILESIZE;if(subpath&&subpath.length>0){var path=[];var len=subpath.length;for(var j=0;j<len;++j){subpath[j][0]=(subpath[j][0]+offsetX)*ts;subpath[j][1]=(subpath[j][1]+offsetY)*ts}console.info(JSON.stringify(subpath));return subpath}return null},findDirectPath:function(grid,start,end){var dx=Math.abs(Math.floor(start[0])-Math.floor(end[0]));var dy=Math.abs(Math.floor(start[1])-Math.floor(end[1]));var mp=[start,end];if(dx===0||dy===0){if(this.isValidPath(grid,mp)){log.info("validpath-fdp1:"+JSON.stringify(mp));return mp}}mp=[start,[start[0],end[1]],end];log.info("mp:"+JSON.stringify(mp));if(this.isValidPath(grid,mp)){log.info("validpath-fdp2:"+JSON.stringify(mp));return mp}mp=[start,[end[0],start[1]],end];log.info("mp:"+JSON.stringify(mp));if(this.isValidPath(grid,mp)){log.info("validpath-fdp3:"+JSON.stringify(mp));return mp}return null},findShortPath:function(crop,offsetX,offsetY,start,end){var subpath=AStar.AStar(crop,start,end);return this.getFullFromShortPath(subpath,offsetX,offsetY)},findPath:function(grid,start,end,findIncomplete){var path;this.grid=grid;this.applyIgnoreList_(this.grid,true);this.applyIncludeList_(this.grid,true);path=AStar.AStar(this.grid,start,end);return path},findIncompletePath_:function(start,end){var perfect,x,y,incomplete=[];perfect=AStar.AStar(this.blankGrid,start,end);for(var i=perfect.length-1;i>0;i-=1){x=perfect[i][0];y=perfect[i][1];if(this.grid[y][x]===0){incomplete=AStar(this.grid,start,[x,y]);break}}return incomplete},ignoreEntity:function(entity){if(entity){this.ignored.push(entity)}},includeEntity:function(entity){if(entity){this.included.push(entity)}},applyIgnoreList_:function(grid,ignored){var self=this,x,y;_.each(this.ignored,function(entity){x=entity.isMoving()?entity.nextGridX:entity.gx;y=entity.isMoving()?entity.nextGridY:entity.gy;if(x>=0&&y>=0){grid[y][x]=ignored?0:1}})},applyIncludeList_:function(grid,included){var self=this,x,y;_.each(this.included,function(entity){x=entity.isMoving()?entity.path.length>0?entity.path[entity.path.length-1][0]:entity.nextGridX:entity.gx;y=entity.isMoving()?entity.path.length>0?entity.path[entity.path.length-1][1]:entity.nextGridY:entity.gy;if(x>=0&&y>=0){grid[y][x]=included?1:0}})},clearIgnoreList:function(grid){this.applyIgnoreList_(grid,false);this.ignored=[]},clearIncludeList:function(grid){this.applyIncludeList_(grid,false);this.ignored=[]}})},{"./lib/astar":43,"./utils":66}],55:[function(require,module,exports){var Messages=require("./message.js");module.exports=PlayerGroup=Class.extend({init:function(leader,group,allowOnce){this.players=[];this.allowOnce=allowOnce;this.group=group;this.world=leader.world;this.addName(leader.name);this.setLeader(leader.name)},containsName:function(playerName){return this.players.includes(playerName)},setLeader:function(playerName){this.leader=playerName;var index=this.players.indexOf(this.leader);if(index!=0)Utils.SwapElements(this.players,0,index)},addName:function(playerName){if(playerName){if(this.players.length===0){this.leader=playerName}if(!this.containsName(playerName)){this.players.push(playerName)}var player=this.getPlayer(playerName);if(player){if(this.allowOnce&&player[this.group]){player[this.group].removeName(playerName)}player[this.group]=this}}this.sendMembersName()},getPlayer:function(playerName){if(playerName){var player=this.world.getPlayerByName(playerName);if(player)return player}return null},sendPlayers:function(msg,sendOwner){var self=this;this.forEachName(function(playerName){if(sendOwner&&this.leader===playerName)return;if(playerName){var player=self.getPlayer(playerName);if(player)player.sendPlayer(msg)}})},forEachName:function(callback){var length=this.players.length;for(var i=0;i<length;++i){if(callback)callback(this.players[i])}},forEachPlayer:function(callback){var length=this.players.length;for(var i=0;i<length;++i){if(callback){var player=this.getPlayer(this.players[i]);if(player)callback(player)}}},removeName:function(playerName){if(playerName===this.leader)this.leader=this.players[0];if(playerName){if(this.containsName(playerName)){var player=this.getPlayer(playerName);if(player){player[this.group]=null}this.players.splice(this.players.indexOf(playerName),1)}this.sendMembersName()}},setMemberMessage:function(msg){this.memberMessage=msg},sendMembersName:function(){if(this.memberMessage)this.sendPlayers(new this.memberMessage(this.players),true)}})},{"./message.js":49}],56:[function(require,module,exports){var Messages=require("./message");module.exports=PlayerQuests=cls.Class.extend({init:function(player){this.player=player;this.quests=[];this.completeQuests={}},questAboutKill:function(mob,quest){var mobKind=mob.kind,mobLevel=mob.level;var a=quest.count<quest.object.count;var b=quest.type===QuestType.KILLMOBKIND&&a&&mobKind===quest.object.kind;var c=quest.type===QuestType.KILLMOBS&&a;var d=mob.level>=quest.object.level[0]&&mob.level<=quest.object.level[1];if((b||c)&&d){console.info("_questAboutKill - conditions met.");quest.data1+=~~(mob.stats.xp/1.5);if(++quest.count===quest.object.count){this.completeQuest(quest,quest.data1)}else{this.progressQuest(quest)}}},questAboutItemCheck:function(target,quest){var lootKind=quest.object2.kind+1e3;if(quest.object2.type===Types.EntityTypes.ITEMLOOT&&quest.object.type===Types.EntityTypes.MOB&&quest.object.kind===target.kind&&quest.status!=QuestStatus.COMPLETE&&(quest.count<quest.object2.count||this.player.inventory.hasItemCount(lootKind)<quest.object2.count)){target.questDrops[lootKind]=parseInt(quest.object2.chance*10);quest.object2.chance+=1}},questAboutUseNode:function(quest){quest.count++;if(quest.count>=quest.object.count){quest.count=quest.object.count;var xp=quest.object.count*10*this.player.level;this.completeQuest(quest,xp)}else{this.progressQuest(quest)}},questAboutItem:function(quest){console.info(JSON.stringify(quest));var kind=quest.object2.kind+1e3;var countItems=this.player.inventory.hasItemCount(kind);quest.count=countItems;this.progressQuest(quest)},questAboutFind:function(quest){if(quest.count++>=quest.object.count&&quest.status===QuestStatus.INPROGRESS){quest.count=quest.object.count;var xp=quest.object.count*10*this.player.level;this.completeQuest(quest,xp)}},questAboutItemComplete:function(quest,callback){if(quest.count>=quest.object2.count&&quest.status==QuestStatus.INPROGRESS){var kind=quest.object2.kind+1e3;if(!this.player.inventory.hasItemCount(kind))return;this.player.inventory.removeItemKind(kind,quest.object2.count);var xp=quest.object2.count*20*this.player.level;this.completeQuest(quest,xp);if(callback)callback(quest);return true}return false},sendQuest:function(quest){this.player.sendPlayer(new Messages.Quest(quest))},progressQuest:function(quest){quest.status=QuestStatus.INPROGRESS;this.sendQuest(quest)},completeQuest:function(quest,xp){if(xp>0){var multiplier=quest.data?quest.data.expMultiplier:1;this.player.incExp(xp*multiplier)}quest.status=QuestStatus.COMPLETE;this.sendQuest(quest);this.completeQuests[quest.id]={npcid:quest.npcQuestId};this.removeQuest(quest)},removeQuest:function(quest){this.quests.splice(this.quests.indexOf(quest),1);quest=null},foundQuest:function(quest){this.quests.push(quest);quest.status=QuestStatus.STARTED;this.sendQuest(quest)},hasNpcCompleteQuest:function(npcQuestId){var cq=this.completeQuests;for(var qid in cq){var q=cq[qid];if(q.hasOwnProperty("npcid")&&q.npcid===npcQuestId)return true}return false},getQuestById:function(id){return this.quests.find(function(q){return q.id===id})},hasQuest:function(id){return this.getQuestById(id)!=null},forQuestsType:function(type,callback){for(var q of this.quests){if(q.type===type&&callback)callback(q)}}})},{"./message":49}],57:[function(require,module,exports){var cls=require("./lib/class");var ProductionConfig={};ProductionConfig=cls.Class.extend({init:function(config){this.config=config;try{this.production=require("../production_hosts/"+config.production+".js")}catch(err){this.production=null}},inProduction:function(){if(this.production!==null){return this.production.isActive()}return false},getProductionSettings:function(){if(this.inProduction()){return this.production}}});module.exports=ProductionConfig},{"./lib/class":44}],58:[function(require,module,exports){var cls=require("./lib/class");module.exports=getQuestObject=function(arr){var self={};self.toArray=function(obj){return[obj.type,obj.kind,obj.count,obj.chance,obj.level[0],obj.level[1]]};self.toClient=function(obj){return[obj.type,obj.kind,obj.count]};self.type=parseInt(arr[0]);self.kind=parseInt(arr[1])||0;self.count=parseInt(arr[2])||0;self.chance=parseInt(arr[3])||0;if(arr.length===4)self.level=[0,99];if(arr.length===5)self.level=[parseInt(arr[4]),99];if(arr.length===6)self.level=[parseInt(arr[4]),parseInt(arr[5])];return self};module.exports=Quest=cls.Class.extend({init:function(qArray){if(!qArray)return;this.id=parseInt(qArray[0]);this.type=parseInt(qArray[1]);this.npcQuestId=parseInt(qArray[2]);this.count=parseInt(qArray[3])||0;this.status=parseInt(qArray[4])||0;this.data1=parseInt(qArray[5])||0;this.data2=parseInt(qArray[6])||0;this.object=qArray[7]||null;this.object2=qArray[8]||null},assign:function(quest){this.id=parseInt(quest.id);this.type=parseInt(quest.type);this.npcQuestId=parseInt(quest.npcQuestId);this.count=parseInt(quest.count);this.status=parseInt(quest.status);this.data1=parseInt(quest.data1);this.data2=parseInt(quest.data2);this.object=quest.object;this.object2=quest.object2},toArray:function(){var cols=[parseInt(this.id),parseInt(this.type),parseInt(this.npcQuestId),parseInt(this.count),parseInt(this.status),parseInt(this.data1),parseInt(this.data2)];if(this.object){cols=cols.concat(this.object.toArray(this.object))}if(this.object2){cols=cols.concat(this.object2.toArray(this.object2))}return cols},toClient:function(){var cols=[this.id,this.type,this.npcQuestId,this.count,this.status,this.data1,this.data2];if(this.object){cols=cols.concat(this.object.toClient(this.object))}else{cols=cols.concat([0,0,0])}if(this.object2){cols=cols.concat(this.object2.toClient(this.object2))}else{cols=cols.concat([0,0,0])}return cols},toString:function(){return this.toArray().join(",")}})},{"./lib/class":44}],59:[function(require,module,exports){var Messages=require("./message.js");module.exports=SkillHandler=cls.Class.extend({init:function(player){player.skills=[];this.player=player;this.skills=this.player.skills},clear:function(){},setSkills:function(player,skills){for(var i=0;i<skills.length;++i){var skill=new Skill(player,i,skills[i]);player.skills[i]=skill}},setSkill:function(index,exp){var skill=player.skills[index];skill.skillXP=exp;skill.skillLevel=Types.getSkillLevel(exp)},setXPs:function(){var skillXPs=[];for(var i=0;i<this.skills.length;++i){var skill=this.skills[i];var xp=parseInt(skill.tempXP);if(xp>0){skill.xp(xp);skillXPs.push(i,skill.skillXP);skill.tempXP=0}}if(skillXPs.length>0)this.player.sendPlayer(new Messages.SkillXP(skillXPs))}});Skill=cls.Class.extend({init:function(player,skillIndex,skillXP){this.player=player;console.info("skillIndex:"+skillIndex);this.skillData=SkillData.Skills[skillIndex];this.skillIndex=skillIndex;this.skillLevel=Types.getSkillLevel(skillXP);this.skillXP=parseInt(skillXP);this.tempXP=0;if(this.skillData.recharge>0){this.skillCooldown=new Timer(this.skillData.recharge);this.skillCooldown.lastTime=0}},getSkill:function(){return this.skillData},isReady:function(){return this.skillCooldown.isOver()},xp:function(amount){if(amount===0)return;console.info("amount="+amount);this.skillXP+=parseInt(amount);var skillLevel=Types.getSkillLevel(this.skillXP,this.skillLevel);if(skillLevel!=this.skillLevel){this.skillLevel=skillLevel;this.player.effectHandler.skillEffects[this.skillIndex].level=skillLevel;this.player.sendPlayer(new Messages.SkillLoad(this.skillIndex,this.skillXP))}}})},{"./message.js":49}],60:[function(require,module,exports){var cls=require("./lib/class");module.exports=Timer=cls.Class.extend({init:function(duration,startTime){this.restart(startTime);this.duration=duration},restart:function(startTime){this.lastTime=startTime||Date.now()},isOver:function(time){var over=false;if(isNaN(time)||time===null||time===0){time=Date.now()}if(time-this.lastTime>this.duration){over=true;this.lastTime=time}return over}})},{"./lib/class":44}],61:[function(require,module,exports){module.exports=Transition=Class.extend({init:function(object){this.startValue=0;this.endValue=0;this.duration=0;this.inProgress=false;this.modValue=0;this.object=object},start:function(updateFunction,stopFunction,modValue){this.updateFunction=updateFunction;this.stopFunction=stopFunction;this.modValue=modValue;this.inProgress=true},step:function(){if(this.inProgress){var inc=this.modValue;if(inc===0)return;var j=0;if(this.updateFunction){var itCount=Math.abs(inc);var start=0;var mod=inc>0?1:-1;for(var it=0;it<itCount;++it){if(this.updateFunction(this.object,mod)){this.stop(this.object);return}}}}},stop:function(){if(this.stopFunction)this.stopFunction(this.object);this.inProgress=false}})},{}],62:[function(require,module,exports){var Messages=require("./message"),_=require("underscore"),Utils=require("./utils");module.exports=Updater=Class.extend({init:function(ws,map){var self=this;this.ws=ws;this.server=ws;this.map=map;this.time=Date.now();this.whoDist=8*G_TILESIZE;this.charPathXF=function(c,m){var x=c.x+m;c.setPosition(x,c.y);return c.nextStep()};this.charPathYF=function(c,m){var y=c.y+m;c.setPosition(c.x,y);return c.nextStep()};this.playerPathXF=function(c,m){var x=c.x+m;c.setPosition(x,c.y);if(x%self.whoDist===0)c.map.entities.processWho(c);return c.nextStep()};this.playerPathYF=function(c,m){var y=c.y+m;c.setPosition(c.x,y);if(y%self.whoDist===0)c.map.entities.processWho(c);return c.nextStep()};this.playerKeyXF=function(c,m){var x=c.x+m;if((c.startMoving||x%G_TILESIZE===0)&&self.checkCollide(c,x,c.y)){c.forceStopMove();return true}c.startMoving=false;c.setPosition(x,c.y);if(x%self.whoDist===0)c.map.entities.processWho(c);if(c.checkStopDanger(c,c.orientation)){c.forceStopMove();return true}return false};this.playerKeyYF=function(c,m){var y=c.y+m;if((c.startMoving||y%G_TILESIZE===0)&&self.checkCollide(c,c.x,y)){c.forceStopMove();return true}c.startMoving=false;c.setPosition(c.x,y);if(y%self.whoDist===0)c.map.entities.processWho(c);if(c.checkStopDanger(c,c.orientation)){c.forceStopMove();return true}return false}},update:function(){var self=this,m=null;this.time=Date.now();var characters=this.map.entities.characters;for(var entityId in characters){if(!characters.hasOwnProperty(entityId))continue;var entity=characters[entityId];if(!entity)continue;if(entity.isDead||entity.isStunned){continue}if(entity instanceof Player){this.updatePlayerKeyMovement(entity);if(entity.path)this.updatePlayerPathMovement(entity);entity.neighboursUpdated=false}else{if(entity.path)this.updateCharacterPathMovement(entity)}m=entity.movement;if(m&&m.inProgress){m.step(this.time)}}},checkCollide:function(c,x,y){if(c instanceof Player){if(c.map.isColliding(x,y))return true;if(c.holdingBlock){pos=c.nextTile();if(c.map.isColliding(pos[0],pos[1]))return true}return false}},moveCharacter:function(char,axis,x,y){if(this.checkCollide(char,axis,x,y)){c.setPosition(c.x,c.y);console.warn("char.isColliding("+char.id+","+x+","+y+")");return false}return true},updateCharacterPathMovement:function(c){var self=this;var tick=c.tick*G_FRAME_INTERVALS;var o=c.orientation;if(c.isDead||c.freeze||c.isStunned){return}var canMove=c.movement.inProgress===false&&c.isMovingPath();if(canMove){if(o===Types.Orientations.LEFT){c.movement.start(self.charPathXF,null,-tick)}else if(o===Types.Orientations.RIGHT){c.movement.start(self.charPathXF,null,tick)}else if(o===Types.Orientations.UP){c.movement.start(self.charPathYF,null,-tick)}else if(o===Types.Orientations.DOWN){c.movement.start(self.charPathYF,null,tick)}}},updatePlayerPathMovement:function(c){var self=this;var tick=c.tick*G_FRAME_INTERVALS;var o=c.orientation;if(c.isDead||c.freeze||c.isStunned){return}var canMove=c.movement.inProgress===false&&c.isMovingPath();if(canMove){if(o===Types.Orientations.LEFT){c.movement.start(self.playerPathXF,null,-tick)}else if(o===Types.Orientations.RIGHT){c.movement.start(self.playerPathXF,null,tick)}else if(o===Types.Orientations.UP){c.movement.start(self.playerPathYF,null,-tick)}else if(o===Types.Orientations.DOWN){c.movement.start(self.playerPathYF,null,tick)}}},updatePlayerKeyMovement:function(c){var self=this;var tick=c.tick*G_FRAME_INTERVALS;var o=c.moveOrientation;if(c.freeze||c.isMovingPath()){return}var canMove=c.movement.inProgress===false&&o>0;if(canMove){if(o===Types.Orientations.LEFT){c.movement.start(self.playerKeyXF,null,-tick)}else if(o===Types.Orientations.RIGHT){c.movement.start(self.playerKeyXF,null,tick)}else if(o===Types.Orientations.UP){c.movement.start(self.playerKeyYF,null,-tick)}else if(o===Types.Orientations.DOWN){c.movement.start(self.playerKeyYF,null,tick)}}}})},{"./message":49,"./utils":66,underscore:310}],63:[function(require,module,exports){var UserMessages=require("./usermessage");module.exports=UserHandler=cls.Class.extend({init:function(main,server,world,connection){var self=this;this.main=main;this.server=server;this.world=world;this.connection=connection;this.connection.listen(function(message){console.info("recv="+JSON.stringify(message));var action=parseInt(message[0]);message.shift();switch(action){case Types.UserMessages.UW_LOAD_PLAYER_DATA:self.handleLoadPlayerData(message);return;case Types.UserMessages.UW_LOAD_PLAYER_AUCTIONS:self.handleLoadPlayerAuctions(message);return;case Types.UserMessages.UW_LOAD_PLAYER_LOOKS:self.handleLoadPlayerLooks(message);return;case Types.UserMessages.UW_LOAD_USER_BANS:self.handleLoadUserBans(message);return;case Types.UserMessages.UW_WORLD_SAVE:self.handleWorldSave(message);return;case Types.UserMessages.UW_WORLD_CLOSE:self.handleWorldClose(message);return}});this.sendOldPackets()},sendOldPackets:function(){for(var msg of userHandlerPackets){this.connection.send(msg.serialize())}userHandlerPackets=[]},onExit:function(){},send:function(message){this.connection.send(message)},handleWorldSave:function(msg){console.info("handleWorldSave.");this.main.saveServer()},handleWorldClose:function(msg){console.info("handleWorldClose.");this.main.safe_exit()},handleLoadPlayerAuctions:function(msg){console.info("handleLoadPlayerAuctions: "+JSON.stringify(msg));if(!msg)return;this.world.auction.load(msg)},handleLoadPlayerLooks:function(msg){console.info("handleLoadPlayerLooks: "+JSON.stringify(msg));if(!msg)return;this.world.looks.load(msg)},handleLoadUserBans:function(msg){console.info("handleLoadUserBans: "+JSON.stringify(msg));if(!msg)return;if(this.world.ban)this.world.ban.loadBans(msg);else{console.warn("world ban not loaded.")}},handleLoadPlayerData:function(msg){console.info("userHandler, handleLoadPlayerData.");var playerName=msg[0];var data=msg[1];var username=data[0][1];if(this.world.ban.isUserBanned(username)){console.info("USER IS BANNED.");return}console.info("handleLoadPlayerData data: "+JSON.stringify(data));this.handleLoadUserInfo(playerName,data[0]);this.handleLoadPlayerInfo(data[1]);this.handleLoadPlayerQuests(data[2]);this.handleLoadPlayerAchievements(data[3]);this.handleLoadPlayerItems(0,data[4]);this.handleLoadPlayerItems(1,data[5]);this.handleLoadPlayerItems(2,data[6]);var player=this.player;console.info("player hash: "+player.hash);hashes[player.hash]=player;this.player=null;this.send([Types.UserMessages.WU_PLAYER_LOADED,MainConfig.protocol,MainConfig.address,MainConfig.port])},handleLoadUserInfo:function(playerName,msg){console.info("handleLoadUserInfo: "+JSON.stringify(msg));var username=msg[0],hash=msg[1],gems=parseInt(msg[2]),looks=msg[3];var conn=this.connection;var user={};user.hashChallenge=conn.hash;user.world=this.world;user.conn=conn;user.userHandler=this;this.server.enterWorld(conn);user.gems=gems;var len=AppearanceData.Data.length;user.looks=Utils.Base64ToBinArray(looks,len);user.name=username;player=new Player(this.world,user,conn);player.name=playerName;player.hash=hash;player.loaded=0;player.worldHandler=user.worldHandler;this.player=player;this.loadedPlayer=true},handleLoadPlayerInfo:function(msg){console.info("handleLoadPlayerInfo: "+JSON.stringify(msg));var player=this.player;var data_player={name:msg[0],map:msg[1].split(","),stats:msg[2].split(","),exps:msg[3].split(","),gold:msg[4].split(","),skills:msg[5].split(","),pStats:msg[6].split(","),sprites:msg[7].split(","),colors:msg[8].split(","),shortcuts:msg[9],completeQuests:msg[10]};console.info("shortcuts: "+JSON.stringify(data_player.shortcuts));console.info("completeQuests: "+JSON.stringify(data_player.completeQuests));if(data_player.shortcuts){data_player.shortcuts=JSON.parse(data_player.shortcuts)}if(data_player.completeQuests){data_player.completeQuests=JSON.parse(data_player.completeQuests)}player.fillPlayerInfo(data_player)},handleLoadPlayerQuests:function(msg){console.info("handleLoadPlayerQuests: "+JSON.stringify(msg));var player=this.player;console.info("msg="+msg);try{dataJSON=JSON.parse(msg);for(var i=0;i<dataJSON.length;i++){var questData=dataJSON[i].split(",");if(questData){console.info(JSON.stringify(questData));var quest=new Quest(questData.splice(0,7));if(questData.length>0)quest.object=getQuestObject(questData.splice(0,6));if(questData.length>0)quest.object2=getQuestObject(questData.splice(0,6));quest.data=QuestData.Data.hasOwnProperty(quest.id)?QuestData.Data[quest.id]:null;player.quests.quests.push(quest)}}}catch(err){console.warn(err.stack)}},handleLoadPlayerAchievements:function(msg){console.info("handleLoadPlayerAchievements: "+JSON.stringify(msg));var player=this.player;var achievements=getInitAchievements();var rec=msg.split(",");var len=~~(rec.length/3);for(var i=0;i<len;++i){var achievement=getSavedAchievement(rec.splice(0,3));player.achievements.push(achievement)}for(var i=len;i<achievements.length;++i){player.achievements.push(achievements[i])}},handleLoadPlayerItems:function(type,msg){console.info("handleLoadPlayerItems: "+JSON.stringify(msg));var player=this.player;var items=[];console.info("getItems - data="+msg);dataJSON=JSON.parse(msg);for(var itemData of dataJSON){if(itemData){var item=new ItemRoom([parseInt(itemData[1]),parseInt(itemData[2]),parseInt(itemData[3]),parseInt(itemData[4]),parseInt(itemData[5])]);item.slot=parseInt(itemData[0]);items.push(item)}}var storeType=null;if(type===0){player.inventory=new Inventory(player,50,items);storeType=player.inventory}else if(type===1){player.bank=new Bank(player,96,items);storeType=player.bank}else if(type===2){player.equipment=new Equipment(player,5,items);storeType=player.equipment;player.equipment.setItem=function(index,item){var res=player.equipment._setItem(index,item);player.setRange();return res}}player.itemStore[type]=storeType},sendToUserServer:function(msg){if(this.connection)this.connection.send(msg.serialize());else{userHandlerPackets.push(msg);console.info("userHandler: sendToUserServer called without connection being set: "+JSON.stringify(msg.serialize()))}},sendWorldInfo:function(config){var msg=new UserMessages.ServerInfo(config,0);this.sendToUserServer(msg)},sendWorldPlayerCount:function(count,maxCount){this.sendToUserServer(new UserMessages.UpdatePlayerCount(count,maxCount))},sendAuctionsData:function(data){this.sendToUserServer(new UserMessages.SavePlayerAuctions(data))},sendLooksData:function(data){this.sendToUserServer(new UserMessages.SavePlayerLooks(data))},sendBansData:function(data){this.sendToUserServer(new UserMessages.SaveUserBans(data))},sendPlayerGold:function(name,gold){this.sendToUserServer(new UserMessages.SendPlayerGold(name,gold))},sendPlayerLogout:function(player){this.sendToUserServer(new UserMessages.playerLoggedIn(0,player.user.name,player.name))},sendPlayersList:function(data){console.info("userHandler - sendPlayersList: "+JSON.stringify(data));this.sendToUserServer(new UserMessages.SavePlayersList(data))}})},{"./usermessage":64}],64:[function(require,module,exports){var UserMessages={};module.exports=UserMessages;var Message=cls.Class.extend({});UserMessages.UpdatePlayerCount=Message.extend({init:function(count,maxCount){this.count=count;this.maxCount=maxCount},serialize:function(){return[Types.UserMessages.WU_UPDATE_PLAYER_COUNT,this.count,this.maxCount]}});UserMessages.SendPlayerGold=Message.extend({init:function(name,gold){this.name=name;this.gold=gold},serialize:function(){return[Types.UserMessages.WU_ADD_PLAYER_GOLD,this.name,this.gold]}});UserMessages.SavePlayerAuctions=Message.extend({init:function(data){this.data=data},serialize:function(){return[Types.UserMessages.WU_SAVE_PLAYER_AUCTIONS].concat(this.data)}});UserMessages.SavePlayerLooks=Message.extend({init:function(data){this.data=data},serialize:function(){return[Types.UserMessages.WU_SAVE_PLAYER_LOOKS].concat(this.data)}});UserMessages.SaveUserBans=Message.extend({init:function(data){this.data=data},serialize:function(){return[Types.UserMessages.WU_SAVE_USER_BANS,this.data]}});UserMessages.ServerInfo=Message.extend({init:function(config,count){this.config=config;this.count=count||0},serialize:function(){return[Types.UserMessages.WU_GAMESERVER_INFO,this.config.world_name,this.count,this.config.nb_players_per_world,this.config.address,this.config.port,this.config.user_password,this.config.world_key]}});UserMessages.SavePlayersList=Message.extend({init:function(data){this.data=data},serialize:function(){return[Types.UserMessages.WU_SAVE_PLAYERS_LIST,this.data]}});UserMessages.playerLoggedIn=Message.extend({init:function(status,username,playerName){this.status=status;this.username=username;this.playerName=playerName},serialize:function(){return[Types.UserMessages.WU_PLAYER_LOGGED_IN,this.status,this.username,this.playerName]}});UserMessages.SavePlayerData=Message.extend({init:function(playerName,playerData,update){this.playerName=playerName;this.playerData=playerData;this.update=update},serialize:function(){return[Types.UserMessages.WU_SAVE_PLAYER_DATA,this.playerName,this.playerData,this.update?1:0]}})},{}],65:[function(require,module,exports){var formatCheck=require("../format").check,UserMessages=require("./usermessage"),Messages=require("../message");module.exports=WorldHandler=cls.Class.extend({init:function(main,connection){var self=this;this.main=main;this.connection=connection;this.playerSaveData={};this.connection.listen(function(message){console.info("recv="+JSON.stringify(message));var action=parseInt(message[0]);if(action)if(!formatCheck(message)){self.connection.close("Invalid "+Types.getMessageTypeAsString(action)+" message format: "+message);return}message.shift();if(action===Types.Messages.CW_LOGIN_PLAYER){self.handleLoginPlayer(message);return}})},onExit:function(){},sendPlayer:function(message){this.connection.send(message)},sendPlayerMessage:function(msg){this.connection.send(msg.serialize())},handleLoginPlayer:function(msg){console.info("worldHandler, handleLoginPlayer: "+JSON.stringify(msg));var playerName=msg[0],playerHash=msg[1];var player=null;if(hashes.hasOwnProperty(playerHash))player=hashes[playerHash];if(!player){console.info("player hash does not exist.");this.connection.disconnect();return}var username=player.user.name;if(users.hasOwnProperty(username)){console.info("player user is already logged in.");this.sendPlayerMessage(new Messages.Error("user already logged in."));this.connection.disconnect();return}users[username]=playerName;if(player.world&&player.world.ban){if(player.world.ban.isUserBanned(username)){console.info("player user is banned from server.");this.sendPlayerMessage(new Messages.Error("user is banned."));this.connection.disconnect();return}}else{console.warn("handleLoginPlayer: world or world ban not set");return}player.start(this.connection);this.sendToUserServer(new UserMessages.playerLoggedIn(1,player.user.name,playerName))},loadPlayerDataUserInfo:function(player,callback){var user=player.user;var data=[user.name,user.hash,Number(user.gems),Utils.BinArrayToBase64(user.looks)];if(callback)callback(user.name,data)},loadPlayerDataInfo:function(player,callback){var stats=[player.stats.attack,player.stats.defense,player.stats.health,player.stats.energy,player.stats.luck,player.stats.free];var exps=[Utils.NaN2Zero(player.exp.base),Utils.NaN2Zero(player.exp.attack),Utils.NaN2Zero(player.exp.defense),Utils.NaN2Zero(player.exp.move),Utils.NaN2Zero(player.exp.sword),Utils.NaN2Zero(player.exp.bow),Utils.NaN2Zero(player.exp.hammer),Utils.NaN2Zero(player.exp.axe),Utils.NaN2Zero(player.exp.logging),Utils.NaN2Zero(player.exp.mining)];var map=[player.map.index,player.x,player.y,player.orientation];var skillexps=[];for(var i=0;i<player.skills.length;++i)skillexps[i]=player.skills[i].skillXP;var hexLooks=Utils.BinArrayToBase64(player.user.looks);var data=[player.name,map.join(","),stats.join(","),exps.join(","),player.gold.join(","),skillexps.join(","),player.pStats.join(","),player.sprites.join(","),player.colors.join(","),JSON.stringify(player.shortcuts),JSON.stringify(player.quests.completeQuests)];if(callback)callback(player.name,data)},loadPlayerDataQuests:function(player,callback){var quests=[];for(var quest of player.quests.quests){if(!quest||quest.status===QuestStatus.COMPLETE||_.isEmpty(quest))continue;quests.push(quest.toArray().join(","))}if(callback)callback(player.name,quests)},loadPlayerDataAchievements:function(player,callback){var data="";for(var achievement of player.achievements){data+=achievement.toRedis(achievement).join(",")+","}data=data.slice(0,-1);if(callback)callback(player.name,data)},loadPlayerDataItems:function(player,type,callback){if(callback)callback(player.name,type,player.itemStore[type].toStringJSON())},sendToUserServer:function(msg){if(this.userConnection)this.userConnection.send(msg.serialize());else console.info("worldHandler: sendToUserServer called without userConnection being set: "+JSON.stringify(msg.serialize()))},savePlayer:function(player,update){console.info("worldHandler - savePlayer, name:"+player.name);var self=this;var username=player.user.name;var playerName=player.name;var checkLoadDataFull=function(index,data){var objData=self.playerSaveData[playerName];objData.count++;objData.data[index]=data;if(objData.count===7){var msg=new UserMessages.SavePlayerData(playerName,objData.data,update);self.sendToUserServer(msg);delete self.playerSaveData[playerName]}else{self.playerSaveData[playerName]=objData}};this.loadPlayerDataUserInfo(player,function(userName,data){var objData={};objData.data=new Array(7);objData.count=0;self.playerSaveData[playerName]=objData;checkLoadDataFull(0,data);self.loadPlayerDataInfo(player,function(pn,data){checkLoadDataFull(1,data)});self.loadPlayerDataQuests(player,function(pn,data){checkLoadDataFull(2,data)});self.loadPlayerDataAchievements(player,function(pn,data){checkLoadDataFull(3,data)});self.loadPlayerDataItems(player,0,function(pn,type,data){checkLoadDataFull(4,data)});self.loadPlayerDataItems(player,1,function(pn,type,data){checkLoadDataFull(5,data)});self.loadPlayerDataItems(player,2,function(pn,type,data){checkLoadDataFull(6,data)})})}})},{"../format":35,"../message":49,"./usermessage":64}],66:[function(require,module,exports){var Utils={},sanitizer=require("sanitizer");Utils.sanitize=function(string){return sanitizer.escape(sanitizer.sanitize(string))};Utils.random=function(range){return Math.floor(Math.random()*range)};Utils.randomRange=function(min,max){return min+Math.random()*(max-min)};Utils.randomInt=function(val){return Math.floor(Math.random()*(val+1))};Utils.randomRangeInt=function(min,max){return min+Math.floor(Math.random()*(max-min+1))};Utils.percentToBool=function(percent){if(Math.random()<percent*.01){return true}else{return false}};Utils.ratioToBool=function(ratio){if(Math.random()<ratio){return true}else{return false}};Utils.clamp=function(min,max,value){if(value<min){return min}else if(value>max){return max}else{return value}};Utils.randomOrientation=function(){var o,r=Utils.random(4);if(r===0)o=Types.Orientations.LEFT;if(r===1)o=Types.Orientations.RIGHT;if(r===2)o=Types.Orientations.UP;if(r===3)o=Types.Orientations.DOWN;return o};Utils.getOrientationString=function(r){var o="NONE";if(r===1)o="UP";else if(r===2)o="DOWN";else if(r===3)o="LEFT";else if(r===4)o="RIGHT";return o};Utils.getOrientationFromLastMove=function(entity){if(!entity.path||entity.path.length===0)return Utils.randomOrientation();var x2=entity.path[entity.path.length-1][0];var y2=entity.path[entity.path.length-1][1];if(entity.path.length===1){var x=entity.x;var y=entity.y}else{var x=entity.path[entity.path.length-2][0];var y=entity.path[entity.path.length-2][1]}if(x2>x)return Types.Orientations.RIGHT;else if(x2<x)return Types.Orientations.LEFT;else if(y2>y)return Types.Orientations.DOWN;else if(y2<y)return Types.Orientations.UP};Utils.randomPositionNextTo=function(entity){var a=entity.x,b=entity.y,r=Utils.random(4);if(r===0)--a;if(r===1)++a;if(r===2)--b;if(r===3)++b;return{x:a,y:b}};Utils.Mixin=function(target,source){if(source){for(var key,keys=Object.keys(source),l=keys.length;l--;){key=keys[l];if(source.hasOwnProperty(key)){target[key]=source[key]}}}return target};Utils.distanceTo=function(x,y,x2,y2){var distX=Math.abs(x-x2);var distY=Math.abs(y-y2);return distX>distY?distX:distY};Utils.manhattenDistance=function(pos1,pos2){return Math.abs(pos1.x-pos2.x)+Math.abs(pos1.y-pos2.y)},Utils.realDistance=function(p1,p2){return~~Math.pow(Math.pow(p2[0]-p1[0],2)+Math.pow(p2[1]-p1[1],2),.5)},Utils.NaN2Zero=function(num){if(isNaN(num*1)){return 0}else{return num*1}};Utils.trueFalse=function(bool){return bool==="true"?true:false};Utils.utilSleep=function(ms){return new Promise(resolve=>setTimeout(resolve,ms))};Utils.removeDoubleQuotes=function(val){return val.toString().replace(/^"(.+(?="$))"$/,"$1")};Utils.max=function(array,colIndex){Math.max.apply(Math,array.map(function(v){return v[colIndex]}))};Utils.min=function(array,colIndex){Math.min.apply(Math,array.map(function(v){return v[colIndex]}))};Utils.array_values=function(input){var tmp_arr=[],key="";for(key in input)tmp_arr[tmp_arr.length]=input[key];return tmp_arr};Utils.arraysEqual=function(a,b){if(a===b)return true;if(a===null||b===null)return false;if(a.length!=b.length)return false;for(var i=0;i<a.length;++i){if(a[i]!==b[i])return false}return true};Utils.setEquipmentBonus=function(kind){if(ItemTypes.isWeapon(kind)||ItemTypes.isArcherWeapon(kind)||ItemTypes.isArmor(kind)){var probability=Utils.random(1024);var bonus=0;for(var i=1;i<=1024;i*=2){if(probability<i){return Math.max(10-bonus,1)}++bonus}}return 1};Utils.pad=function(val,size){var s=val+"";while(s.length<size)s="0"+s;return s};Utils.checkInputName=function(name){if(name===null)return false;else if(name==="")return false;else if(name===" ")return false;for(var i=0;i<name.length;i++){var c=name.charCodeAt(i);if(!(44032<=c&&c<=55203||12593<=c&&c<=12686||97<=c&&c<=122||65<=c&&c<=90||48<=c&&c<=57)){return false}}return true};if(!Array.prototype.last){Object.defineProperty(Array.prototype,"last",{value:function(){return this[this.length-1]}})}if(!Array.prototype.parseInt){Object.defineProperty(Array.prototype,"parseInt",{value:function(){return this.map(function(x){return parseInt(x,10)})}})}ArrayParseInt=function(){return this.map(function(x){return parseInt(x,10)})};if(!String.prototype.reverse){String.prototype.reverse=function(){return this.split("").reverse().join("")}}Utils.ceilGrid=function(val){return~~(val+.5)};if(!Number.prototype.ceilGrid){Number.prototype.ceilGrid=function(){return~~(this+.5)}}Utils.minProp=function(arr,prop){return arr.reduce(function(prev,curr){return prev[prop]<curr[prop]?prev:curr})};Utils.maxProp=function(arr,prop){return arr.reduce(function(prev,curr){return prev[prop]>curr[prop]?prev:curr})};Utils.Sleep=function(ms){return new Promise(resolve=>setTimeout(resolve,ms))};var groupBy=function(xs,key){return xs.reduce(function(rv,x){(rv[x[key]]=rv[x[key]]||[]).push(x);return rv},{})};Utils.GetGroupCountArray=function(groupArray,field){var group=groupBy(groupArray,field);var array=[];for(var rec in group){array.push([rec,group[rec].length])}console.info(JSON.stringify(array));array.sort(function(a,b){return a[1]-b[1]});return array};Utils.roundTo=function(val,nearest){return Math.round(val/nearest)*nearest};Utils.floorTo=function(val,nearest){return Math.floor(val/nearest)*nearest};Utils.ceilTo=function(val,nearest){return Math.ceil(val/nearest)*nearest};Utils.btoa=function(val){return Buffer.from(val,"base64").toString("utf8")};Utils.getGridPosition=function(x,y){return{gx:x>>4,gy:y>>4}};Utils.getPositionFromGrid=function(gx,gy){return{x:gx<<4,y:gy<<4}};Utils.forEach=function(obj,fn){var prop=null;for(var key in obj){if(obj.hasOwnProperty(key)){if(obj[key]&&fn&&fn(obj[key],key))return true}}return false};Utils.removeFromArray=function(arr,element){var index=arr.indexOf(element);if(index>=0)arr.splice(index,1)};Utils.getLockDelay=function(time){return 0};Utils.BinArrayToBase64=function(uint8array){var len=Math.ceil(uint8array.length/32);var tarr=[];for(var i=0;i<len;i++){var num=uint8array.slice(i*32,i*32+32).join("");tarr.push(parseInt(num,2))}var base64=tarr.toString("base64");return base64};Utils.Base64ToBinArray=function(base64,limit){var data=base64.toString("binary");var arr=data.split(",");var uint8array=new Uint8Array(arr.length*32);for(var i=0;i<arr.length;++i){var dec=parseInt(arr[i]);var bin=dec.toString(2);var l=bin.length;var index=(i+1)*32-l;for(var j=0;j<l;++j)uint8array[index+j]=bin[j]}return uint8array.slice(0,limit)};Utils.SwapElements=function(arr,i1,i2){[arr[i1],arr[i2]]=[arr[i2],arr[i1]]};Utils.getNumShortHand=function(val,fixed){if(fixed===null)fixed=2;if(val<=1e3)return val;if(val<=1e6)return(val/1e3).toFixed(fixed)+"K";if(val<=1e9)return(val/1e6).toFixed(fixed)+"M";if(val<=1e12)return(val/1e9).toFixed(fixed)+"B";else return(val/1e12).toFixed(fixed)+"T"};Utils.Percent=function(val,fixed){if(fixed===null)fixed=0;return Number(val*100).toFixed(fixed)+"%"};Utils.objectToArray=function(object){var arr=[];for(var key in object){var obj=object[key];if(obj)arr.push(obj)}return arr};module.exports=Utils},{sanitizer:212}],67:[function(require,module,exports){var BaseItem=require("../items/baseitem"),Messages=require("../message");module.exports=AuctionRecord=cls.Class.extend({init:function(playerName,price,item){this.playerName=playerName;this.price=price;this.item=item},save:function(){return[this.playerName,this.price].join(",")+","+this.item.toArrayNoSlot().join(",")},toArray:function(){var cols=[this.playerName,this.price];cols=cols.concat(this.item.toArray());return cols}});module.exports=Auction=cls.Class.extend({init:function(){this.auctions=[]},load:function(data){var self=this;console.info("auction - load: "+JSON.stringify(data));if(Array.isArray(data)&&data.length===0)return;auctions=[];for(var rec of data){var sData=rec.split(",");var record=new AuctionRecord(sData[0],parseInt(sData[1]),new ItemRoom([parseInt(sData[2]),parseInt(sData[3]),parseInt(sData[4]),parseInt(sData[5]),parseInt(sData[6])]));auctions.push(record)}if(auctions)this.auctions=auctions},save:function(world){console.info("auction - save: "+JSON.stringify(this.auctions));var data=[];for(var auction of this.auctions){if(auction)data.push(auction.save())}if(world.userHandler){world.userHandler.sendAuctionsData(data);return true}else{console.info("save: world.userHandler not set.")}return false},add:function(player,item,price,invIndex){var auction=new AuctionRecord(player.name,price,item);this.auctions.push(auction);player.inventory.setItem(invIndex,null);player.sendPlayer(new Messages.Notify("AUCTION","AUCTION_ADDED"))},remove:function(index){this.auctions[index]=null},putItem:function(player,item){return player.inventory.putItem(item)>=0},list:function(player,type){var msg=[Types.Messages.WC_AUCTIONOPEN,type,0];var recCount=0;for(var auction of this.auctions){if(!auction){continue}var kind=auction.item.itemKind;var pc=player.name===auction.playerName;if(type===1&&!pc&&ItemTypes.isArmor(kind)||type===2&&!pc&&ItemTypes.isWeapon(kind)||type===0&&pc){msg.push(this.auctions.indexOf(auction));msg=msg.concat(auction.toArray());++recCount}}msg[2]=recCount;player.sendPlayer(new Messages.AuctionOpen(msg))}})},{"../items/baseitem":38,"../message":49}],68:[function(require,module,exports){module.exports=BanManager=Class.extend({init:function(world){this.world=world;this.userBans={}},saveBans:function(){var now=Date.now();var data=[];for(var username in this.userBans){var banTime=this.userBans[username];if(banTime<now)continue;var rec=username+","+banTime;data.push(rec)}return data},loadBans:function(msg){var now=Date.now();for(var rec of msg){var ban=rec.split(",");if(now>ban[1])continue;this.userBans[ban[0]]=ban[1]}},isUserBanned:function(username){if(this.userBans.hasOwnProperty(username)&&this.userBans[username]>Date.now()){return true}return false},banplayer:function(name,duration){name=name.toLowerCase();var player=this.world.getPlayerByName(name);if(!player){console.info("worldServer, banplayer: player not in world.");return}var username=player.user.name;this.banuser(username,duration)},banuser:function(username,duration){duration*=86400*1e3;this.userBans[username]=Date.now()+duration},save:function(){if(this.world.userHandler){var data=this.saveBans();this.world.userHandler.sendBansData(data);return true}else{console.info("worldserver, save: userHandler not set")}return false}})},{}],69:[function(require,module,exports){var Messages=require("../message");module.exports=Looks=cls.Class.extend({init:function(){this.prices=[];this.reset()},reset:function(){console.info("LOOKS INIT");var length=AppearanceData.Data.length;for(var i=0;i<length;i++){this.prices.push(500)}this.prices[0]=0;this.prices[50]=0;this.prices[77]=0;this.prices[151]=0},load:function(data){var self=this;if(!data)this.reset();this.prices=data.parseInt()},save:function(world){console.info("LOOKS SAVED");if(!this.prices)return true;data=this.prices.join(",");if(world.userHandler){world.userHandler.sendLooksData(data);return true}return false},modPrice:function(index,modPrice){this.prices[index]+=modPrice},pricesToString:function(){return this.prices.join(",")},sendLooks:function(player){player.sendPlayer(new Messages.AppearanceList(player.user,this))}})},{"../message":49}],70:[function(require,module,exports){module.exports=LootManager=Class.extend({init:function(world){this.world=world},handleDropItem:function(entity,attacker){var itemLoot=this.getLootItem(attacker,entity,0);if(itemLoot&&itemLoot instanceof Item){console.info("LOOT ITEM SENT!");itemLoot.x=entity.x;itemLoot.y=entity.y;this.handleItemDespawn(itemLoot);return}var item=this.getDroppedOrStolenItem(attacker,entity,0);if(item&&item instanceof Item){item.x=entity.x;item.y=entity.y;this.handleItemDespawn(item);return}},handleItemDespawn:function(item){if(item){item.handleDespawn({beforeBlinkDelay:2e4,blinkCallback:function(){},blinkingDuration:1e4,despawnCallback:function(){item.map.entities.itemDespawn(item)}})}},getLootItem:function(source,target,stolen){var self=this;var itemId2=null;if(!target instanceof Mob)return;var v=Utils.randomRangeInt(0,1e3);var itemId2;var drops=target.questDrops;for(var d in drops){var count=drops[d];if(v>=0&&v<count){itemId2=d;break}v-=count}if(itemId2){var itemRoom=new ItemRoom([parseInt(itemId2),1,0,0,0]);var lootItem=target.map.entities.createItem(itemRoom,target.x,target.y,1);lootItem.count=1;lootItem.experience=0;target.map.entities.sendNeighbours(target,lootItem.spawn());return target.map.entities.addItem(lootItem)}return null},getPlayerDrop:function(source,target,stolen){var itemIndex=target.inventory.getRandomItemNumber();if(itemIndex===-1)return;item=target.inventory.rooms[itemIndex];var count=1;if(ItemTypes.isConsumableItem(item.itemKind)){count=Math.floor((Math.random()*target.level+2)/2);if(count>item.itemNumber)count=item.itemNumber}var item2;if(stolen){item2=Object.assign(new ItemRoom,item);item2.itemNumber=count;source.sendPlayer(new Messages.Notify("CHAT","ITEM_ADDED",[ItemData.Kinds[item.itemKind].name]))}else{item2=target.map.entities.addItem(target.map.entities.createItem(type,item,target.x,target.y,count))}target.inventory.takeOutItems(itemIndex,count);return item2},getDrop:function(source,target,stolen){if(target.droppedItem===true)return;target.droppedItem=true;var drops=target.drops;var v=Utils.random(1e3);var itemId2;for(var itemId in drops){var count=drops[itemId];if(v>=0&&v<count){itemId2=itemId;break}v-=count}if(!itemId2)return null;var itemRoom;if(ItemTypes.isEquippable(itemId2)){var count=Utils.setEquipmentBonus(itemId2);itemRoom=new ItemRoom([itemId2,count,0,0,900,900]);itemRoom.itemExperience=ItemTypes.itemExpForLevel[count-1]}else{itemRoom=new ItemRoom([itemId2,1,0,0,0,0])}var item=target.map.entities.createItem(itemRoom,target.x,target.y,1);if(stolen){if(source instanceof Player)source.sendPlayer(new Messages.Notify("CHAT","ITEM_ADDED",[ItemData.Kinds[item.itemKind].name]));return itemRoom}else{if(target.data&&target.data.dropBonus)item.count+=target.data.dropBonus;target.map.entities.sendNeighbours(target,item.spawn());item.enemyDrop=true;return target.map.entities.addItem(item)}},getGoldDrop:function(source,target,stolen){var count=target.dropGold();if(source instanceof Player){var targetLevel=0;targetLevel=target.level;var diff=targetLevel-source.level;var bonusLevel=Utils.clamp(.1,1.9,1+diff*.05);count*=bonusLevel;count=~~count}if(source instanceof Player){source.modifyGold(count)}},getDroppedOrStolenItem:function(source,target,stolen){var self=this;var item=null;if(source instanceof Player&&target instanceof Player){this.getGoldDrop(source,target,stolen);return this.getPlayerDrop(source,target,stolen)}else if(target instanceof Mob){this.getGoldDrop(source,target,stolen);return this.getDrop(source,target,stolen)}return null}})},{}],71:[function(require,module,exports){var PlayerGroup=require("../playergroup");var Message=require("../message");module.exports=PartyManager=Class.extend({init:function(world){this.world=world;this.party=[]},addParty:function(player1,player2){var party=new PlayerGroup(player1,"party",true);party.setMemberMessage(Message.Party);party.addName(player2.name);this.party.push(party);return party},removeParty:function(party){this.party.splice(this.party.indexOf(party),1);party=null},removePlayer:function(player){if(player.hasOwnProperty("party")&&player.party){var party=player.party;party.removeName(player.name);player.packetHandler.partyHandler.handlePartyAbandoned(party)}}})},{"../message":49,"../playergroup":55}],72:[function(require,module,exports){var EntityMoving=require("../entity/entitymoving"),Messages=require("../message"),AchievementJson=require("../../shared/data/achievements.json");module.exports.getAchievementObject=getAchievementObject=function(arr){var self={};self.toArray=function(obj){return[obj.index,obj.data.type,obj.rank,obj.data.objectType,obj.data.objectKind,obj.count,obj.data.objectCount[obj.rank]]};self.toClient=function(obj){return obj.toArray(obj)};self.toRedis=function(obj){return[obj.index,obj.rank,obj.count]};if(!arr)return self;self.index=parseInt(arr[0]);self.rank=parseInt(arr[1]);self.count=parseInt(arr[2]);self.data=arr[3];return self};module.exports.getSavedAchievement=getSavedAchievement=function(arr){data=[arr[0],arr[1],arr[2],AchievementJson[arr[0]]];var achievement=Object.assign(getAchievementObject(data),null);return achievement};module.exports.getInitAchievements=getInitAchievements=function(){var achievements=[];var len=AchievementJson.length;for(var i=0;i<len;++i){data=[i,0,0,AchievementJson[i]];var achievement=Object.assign(getAchievementObject(data),null);achievements.push(achievement)}log.info("achievements: "+JSON.stringify(achievements));return achievements};module.exports.PlayerEvent=PlayerEvent=function(eventType,object,count){var playerEvent={};playerEvent.eventType=eventType;playerEvent.object=object;playerEvent.count=count;return playerEvent};module.exports=TaskHandler=cls.Class.extend({init:function(){var i=0;this.data=AchievementJson},processEvent:function(player,playerEvent){var quests=player.quests;switch(playerEvent.eventType){case EventType.KILLMOB:var target=playerEvent.object;target.questDrops={};quests.forQuestsType(QuestType.KILLMOBKIND,function(quest){quests.questAboutKill(target,quest)});quests.forQuestsType(QuestType.GETITEMKIND,function(quest){quests.questAboutItemCheck(target,quest)});break;case EventType.LOOTITEM:quests.forQuestsType(QuestType.GETITEMKIND,function(quest){if(quest.object2.kind===playerEvent.object.kind-1e3){quests.questAboutItem(quest)}});break;case EventType.USE_NODE:quests.forQuestsType(QuestType.USENODE,function(quest){if(quest.object.kind===playerEvent.object.kind&&quest.data1===playerEvent.object.level)quests.questAboutUseNode(quest)});break}for(var achievement of player.achievements){this.processAchievement(player,playerEvent,achievement,function(achievement,event){return achievement.data.type===EventType.KILLMOB&&(achievement.data.objectKind===0||achievement.data.objectKind===event.object.kind)},2);this.processAchievement(player,playerEvent,achievement,function(achievement,event){return achievement.data.type===EventType.LOOTITEM&&event.object.hasOwnProperty("enemyDrop")},5);this.processAchievement(player,playerEvent,achievement,function(achievement,event){return achievement.data.type===EventType.DAMAGE},.02);this.processAchievement(player,playerEvent,achievement,function(achievement,event){if(achievement.data.type===EventType.USE_NODE){var wtype=event.object.weaponType;return player.hasWeaponType(wtype)&&wtype===achievement.data.data1}return false},5);this.processAchievement(player,playerEvent,achievement,function(achievement,event){if(achievement.data.type===EventType.HARVEST){var wtype=event.object.weaponType;return player.hasWeaponType(wtype)&&wtype==="axe"}return false},5);this.processAchievement(player,playerEvent,achievement,function(achievement,event){if(achievement.data.type===EventType.USE_NODE){var wtype=event.object.weaponType;return player.hasWeaponType(wtype)&&wtype===achievement.data.data1}return false},5)}},processAchievement:function(player,event,achievement,condition,expMultiplier){if(event.eventType!==achievement.data.type)return;if(!condition(achievement,event))return;var ti=player.achievements.indexOf(achievement);if(ti<0||ti>=achievement.data.objectCount.length)return;var count=event.count;var objectCount=achievement.data.objectCount[achievement.rank];var rankCount=achievement.data.objectCount.length;if(achievement.count+count<objectCount){achievement.count+=count}else{if(achievement.rank===rankCount-1&&achievement.count===objectCount){return}while(count>0){objectCount=achievement.data.objectCount[achievement.rank];var prevCount=achievement.count;var diff=achievement.count+count;achievement.count=Math.min(diff,objectCount);count-=objectCount-prevCount;player.sendPlayer(new Messages.Achievement(achievement));var xp=~~(objectCount*expMultiplier);var chatAchievement="ACHIEVEMENTS_"+ti+"_COMPLETE";var objectCountFmt=Utils.getNumShortHand(objectCount,0);player.incExp(xp);player.sendPlayer(new Messages.Notify("CHAT",chatAchievement,[objectCountFmt,xp]));if(achievement.rank===rankCount-1&&achievement.count===objectCount){return}achievement.rank++;if(count<objectCount){achievement.count=count;count=0}}}player.sendPlayer(new Messages.Achievement(achievement))}})},{"../../shared/data/achievements.json":332,"../entity/entitymoving":27,"../message":49}],73:[function(require,module,exports){var cls=require("./lib/class"),_=require("underscore"),Log=require("log"),Entity=require("./entity/entity"),Character=require("./entity/character"),NpcStatic=require("./entity/npcstatic"),NpcMove=require("./entity/npcmove"),Player=require("./entity/player"),Item=require("./entity/item"),Chest=require("./entity/chest"),Mob=require("./entity/mob"),Node=require("./entity/node"),MapManager=require("./map/mapmanager"),Messages=require("./message"),util=require("util"),Pathfinder=require("./pathfinder"),Updater=require("./updater"),MobCallback=require("./callbacks/mobcallback"),NpcMoveCallback=require("./callbacks/npcmovecallback"),PlayerCallback=require("./callbacks/playercallback"),Auction=require("./world/auction"),Looks=require("./world/looks"),TaskHandler=require("./world/taskhandler"),BanManager=require("./world/banmanager"),PartyManager=require("./world/partymanager"),LootManager=require("./world/lootmanager");module.exports=World=cls.Class.extend({init:function(id,maxPlayers,socket){var self=this;self.id=id;self.maxPlayers=maxPlayers;self.socket=socket;self.mapManager=new MapManager(self);self.taskHandler=new TaskHandler;self.maps=self.mapManager.maps;self.players=[];self.objPlayers={};self.ban=new BanManager(self);self.party=new PartyManager(self);self.loot=new LootManager(self);self.mobCallback=new MobCallback;self.playerCallback=new PlayerCallback;self.npcMoveCallback=new NpcMoveCallback;self.itemCount=0;self.uselessDebugging=false;self.mapManager.onMapsReady(function(){console.info("ALL MAPS LOADED BITCHES!");self.maps=self.mapManager.maps;Utils.forEach(self.maps,function(map,k){map.updater=new Updater(self,map)})});self.auction=new Auction;self.looks=new Looks;self.lastUpdateTime=Date.now();self.PLAYERS_SAVED=false;self.AUCTIONS_SAVED=false;self.LOOKS_SAVED=false;self.BANS_SAVED=false;self.onPlayerConnect(function(player){console.info("worldServer - onPlayerConnect.");if(self.players.indexOf(player)<0){self.players.push(player);self.userHandler.sendWorldPlayerCount(self.players.length,self.maxPlayers)}self.objPlayers[player.name.toLowerCase()]=player});self.onPlayerRemoved(function(player){console.info("worldServer - onPlayerRemoved.");delete self.objPlayers[player.name.toLowerCase()];var index=self.players.indexOf(player);self.players.splice(index,1);self.userHandler.sendPlayerLogout(player);self.userHandler.sendWorldPlayerCount(self.players.length,self.maxPlayers)});self.onPlayerEnter(function(player){player.map=self.maps[1];player.map.entities.addPlayer(player);console.info("Player: "+player.name+" has entered the "+player.map.name+" map.");player.map.entities.sendBroadcast(new Messages.Notify("MAP","MAP_ENTERED",[player.name,player.map.name]),true);player.packetHandler.onBroadcast(function(message,ignoreSelf){player.map.entities.sendBroadcast(message,ignoreSelf?player.id:null)});player.packetHandler.onExit(function(player){console.info("worldServer, packetHandler.onExit.");self.party.removePlayer(player);if(self.removed_callback)self.removed_callback(player);delete users[player.user.name];player.map.entities.removePlayer(player);player=null});if(self.added_callback)self.added_callback()});self.onRegenTick(function(){var fnPlayer=function(player){if(player instanceof Player){if(player.isAlive()&&!player.hasFullHealth()&&!player.isAttacked()){var packet=player.modHealthBy(Math.floor(player.stats.hpMax/8))}}};self.forEachMap(function(map){map.entities.forEachPlayer(fnPlayer)})});self.notify=NotifyData.Notifications;Utils.forEach(self.notify,function(notify){notify.lastTime=Date.now()-self._idleStart});setInterval(function(){Utils.forEach(self.notify,function(notify){if(Date.now()-notify.lastTime>=notify.interval*6e4){self.sendWorld(new Messages.Notify("NOTICE",notify.textid));notify.lastTime=Date.now()}})},6e4)},notifyWorld:function(msg){this.sendWorld(new Messages.Notify("GLOBAL",msg))},stop:function(){this.save()},isSaved:function(){return this.PLAYERS_SAVED&&this.AUCTIONS_SAVED&&this.LOOKS_SAVED&&this.BANS_SAVED},savePlayers:function(update){if(this.userHandler){var playerNameList=[];Utils.forEach(this.players,function(p){playerNameList.push(p.name)});this.userHandler.sendPlayersList(playerNameList)}else{console.warn("worldServer save: no user server connection aborting save.");return false}Utils.forEach(this.players,function(p){if(update)p.save(update);else p.connection.disconnect()});return true},setSaves:function(setSave){this.PLAYERS_SAVED=setSave;this.AUCTIONS_SAVED=setSave;this.LOOKS_SAVED=setSave;this.BANS_SAVED=setSave},save:function(update){if(this.savePlayers(update))this.PLAYERS_SAVED=true;if(this.auction.save(this))this.AUCTIONS_SAVED=true;if(this.looks.save(this))this.LOOKS_SAVED=true;if(this.ban.save()){this.BANS_SAVED=true}if(update){this.setSaves(false)}},update:function(){var self=this;this.lastUpdateTime=Date.now();self.forEachMap(function(map){if(map.updater&&Object.keys(map.entities.players).length>0){map.updater.update()}})},forEachMap:function(callback){Utils.forEach(this.maps,function(map){if(map&&map.ready&&map.isLoaded&&map.entities&&callback)callback(map)})},run:function(){var self=this;setInterval(function(){self.update()},G_UPDATE_INTERVAL);var processPackets=function(){self.forEachMap(function(map){if(map.updater&&Object.keys(map.entities.players).length>0){map.entities.processPackets()}})};setInterval(processPackets,16);setInterval(function(){self.forEachMap(function(map){if(Object.keys(map.entities.players).length>0){map.entities.mobAI.update()}})},256);setInterval(function(){for(var p of self.players){if(p.user&&Date.now()-p.user.lastPacketTime>=3e5){p.connection.close("idle timeout")}}},6e4);setInterval(function(){if(self.regen_callback){self.regen_callback()}},1e4);setInterval(function(){self.forEachMap(function(map){var players=map.entities.players;Utils.forEach(players,function(p){map.entities.mobAI.Roaming(p)})})},1e3);setInterval(function(){self.save(true)},6e5)},loggedInPlayer:function(name){return typeof this.getPlayerByName(name)==="object"},getPlayerByName:function(name){return this.objPlayers[name.toLowerCase()]},handleDamage:function(entity,attacker,damage,crit){if(entity.effects){console.info("entity.effects: "+JSON.stringify(entity.effects));var effects=[];Utils.forEach(entity.effects,function(v,k){if(v===1)effects.push(parseInt(k))})}var hpMod=-damage;var epMod=0;console.info("effects: "+JSON.stringify(effects));console.info("DAMAGE: "+damage);console.info("CRIT: "+crit);entity.onDamage(attacker,hpMod,epMod,crit,effects)},onPlayerConnect:function(callback){this.connect_callback=callback},onPlayerEnter:function(callback){this.enter_callback=callback},onPlayerRemoved:function(callback){this.removed_callback=callback},onRegenTick:function(callback){this.regen_callback=callback},sendWorld:function(message){var self=this;self.forEachMap(function(map){map.entities.sendBroadcast(message)})}})},{"./callbacks/mobcallback":7,"./callbacks/npcmovecallback":8,"./callbacks/playercallback":9,"./entity/character":24,"./entity/chest":25,"./entity/entity":26,"./entity/item":28,"./entity/mob":29,"./entity/node":30,"./entity/npcmove":31,"./entity/npcstatic":32,"./entity/player":33,"./lib/class":44,"./map/mapmanager":48,"./message":49,"./pathfinder":54,"./updater":62,"./world/auction":67,"./world/banmanager":68,"./world/looks":69,"./world/lootmanager":70,"./world/partymanager":71,"./world/taskhandler":72,log:192,underscore:310,util:undefined}],74:[function(require,module,exports){var _=require("underscore");var BISON=require("bison");var useBison=false;var cls=require("./lib/class");var http=require("http");var https=require("https");const{Server:Server}=require("socket.io");var url=require("url");var Utils=require("./utils");var WS={};var zlib=require("zlib");var connect=require("connect");var fs=require("fs");var io_client=require("socket.io-client");module.exports=WS;var sServer=cls.Class.extend({init:function(){},start:function(){if(this.startCallback)this.startCallback(this)},onStart:function(callback){this.startCallback=callback},onConnect:function(callback){this.connectionCallback=callback},onError:function(callback){this.errorCallback=callback},broadcast:function(message){throw"Not implemented"},forEachConnection:function(callback){_.each(this._connections,callback)},addConnection:function(connection){this._connections[connection.id]=connection},removeConnection:function(id){delete this._connections[id]},getConnection:function(id){return this._connections[id]},onClose:function(callback){this._close_callback=callback},close:function(){if(this._close_callback)this._close_callback(this)}});var Connection=cls.Class.extend({init:function(id,connection,server){this._connection=connection;this._server=server;this.id=id},onClose:function(callback){this.closeCallback=callback},listen:function(callback){this.listenCallback=callback},broadcast:function(message){throw"Not implemented"},send:function(message){throw"Not implemented"},sendUTF8:function(data){throw"Not implemented"},close:function(logError){console.info("Closing connection to "+this._connection.remoteAddress+". "+logError);this._connection.conn.close()}});WS.WebsocketServer=sServer.extend({_connections:{},_counter:0,init:function(config){var self=this;this._super();var app={};if(config.https_cert!=""){app.cert=fs.readFileSync(config.https_cert)}if(config.https_key!=""){app.key=fs.readFileSync(config.https_key)}var protocol=http;if(config.protocol==="https")protocol=https;var client_connect=function(socket){console.info("Client socket connected from "+socket.conn.remoteAddress);socket.remoteAddress=socket.conn.remoteAddress;var c=new WS.socketioConnection(self._createId(),socket,self);if(self.connectionCallback){self.connectionCallback(c)}self.addConnection(c)};this._protoServer=protocol.createServer(app);this._protoServer.listen(config.port,config.ip,function serverOnlyListening(){console.info("Server (only) is listening on port "+config.port)});this._ioServer=new Server(this._protoServer,{cors:{origin:"*"}});this._ioServer.on("connection",function webSocketListener(socket){client_connect(socket)});this._ioServer.on("connect_error",function(err){console.error(err)});this.onClose(function(self){this._protoServer.close()})},_createId:function(){return 5e4+this._counter++},broadcast:function(message){this.forEachConnection(function(connection){connection.send(message)})},onRequestStatus:function(statusCallback){this.statusCallback=statusCallback}});WS.socketioConnection=Connection.extend({init:function(id,connection,server){var self=this;this._super(id,connection,server);var fnOnMessage=function(msg){console.info("m="+msg);var flag=msg.charAt(0);if(flag==="2"){var buffer=Buffer.from(flag,"base64");zlib.gunzip(buffer,(err,buffer)=>{if(err)console.log(err.toString());else{if(self.listenCallback){if(useBison){self.listenCallback(BISON.decode(buffer))}else{self.listenCallback(JSON.parse(buffer))}}}})}else{if(self.listenCallback){if(useBison){self.listenCallback(BISON.decode(msg.substr(1)))}else{self.listenCallback(JSON.parse(msg.substr(1)))}}}};this._connection.on("message",fnOnMessage);this._connection.on("disconnect",function(){console.info("Client closed socket "+self._connection.conn.remoteAddress);if(self.closeCallback){self.closeCallback()}delete self._server.removeConnection(self.id)})},send:function(message){console.info("send="+message);var self=this;var data;if(useBison){data=BISON.encode(message)}else{data=JSON.stringify(message)}if(data.length>=2048){zlib.gzip(data,{level:1},(err,buffer)=>{buffer=new Buffer(buffer).toString("base64");self.sendUTF8("z|"+buffer)})}else{self.sendUTF8("1"+data)}},sendUTF8:function(data){this._connection.send(data)},disconnect:function(){this._connection.disconnect()}});WS.userConnection=Connection.extend({init:function(id,connection,server){var self=this;this._super(id,connection,server);this.fnOnMessage=function(msg){console.info("m="+msg);var flag=msg.charAt(0);if(flag==="2"){var buffer=Buffer.from(flag,"base64");zlib.gunzip(buffer,(err,buffer)=>{if(err)console.log(err.toString());else{if(self.listenCallback){if(useBison){self.listenCallback(BISON.decode(buffer))}else{self.listenCallback(JSON.parse(buffer))}}}})}else{if(self.listenCallback){if(useBison){self.listenCallback(BISON.decode(msg.substr(1)))}else{self.listenCallback(JSON.parse(msg.substr(1)))}}}}},connect:function(connectString){var self=this;this._connection=io_client.connect(connectString,{reconnect:true,rejectUnauthorized:false});this._connection.on("connect_error",function(err){console.info("Failed to establish a connection to the servers, or lost     connection");console.info(JSON.stringify(err))});this._connection.on("message",this.fnOnMessage);this._connection.on("connect",function(socket){console.info("CONNECTED! YAYYYY");self._connection.off("message").on("message",self.fnOnMessage);if(self.connectionUserCallback)self.connectionUserCallback(self)});var fnDisconnect=function(){try{throw new Error}catch(e){console.error(e.stack)}console.info("USER CONNECTION CLOSED.");if(self.closeCallback){self.closeCallback()}self.disconnect()};this._connection.on("disconnect",fnDisconnect)},onConnectUser:function(callback){this.connectionUserCallback=callback},send:function(message){console.info("send="+message);var self=this;var data;if(useBison){data=BISON.encode(message)}else{data=JSON.stringify(message)}if(data.length>=2048){zlib.gzip(data,{level:1},(err,buffer)=>{buffer=new Buffer(buffer).toString("base64");self.sendUTF8("2"+buffer)})}else{self.sendUTF8("1"+data)}},disconnect:function(){console.info("USER CONNECTION - DISCONNECT.");this._connection.disconnect()},sendUTF8:function(data){if(this._connection){this._connection.emit("message",data)}else{console.error("this connection not set.");try{throw new Error}catch(e){console.warn(e.stack)}}}})},{"./lib/class":44,"./utils":66,bison:78,connect:79,fs:undefined,http:undefined,https:undefined,"socket.io":285,"socket.io-client":267,underscore:310,url:undefined,zlib:undefined}],75:[function(require,module,exports){exports.Emitter=Emitter;function Emitter(obj){if(obj)return mixin(obj)}function mixin(obj){for(var key in Emitter.prototype){obj[key]=Emitter.prototype[key]}return obj}Emitter.prototype.on=Emitter.prototype.addEventListener=function(event,fn){this._callbacks=this._callbacks||{};(this._callbacks["$"+event]=this._callbacks["$"+event]||[]).push(fn);return this};Emitter.prototype.once=function(event,fn){function on(){this.off(event,on);fn.apply(this,arguments)}on.fn=fn;this.on(event,on);return this};Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(event,fn){this._callbacks=this._callbacks||{};if(0==arguments.length){this._callbacks={};return this}var callbacks=this._callbacks["$"+event];if(!callbacks)return this;if(1==arguments.length){delete this._callbacks["$"+event];return this}var cb;for(var i=0;i<callbacks.length;i++){cb=callbacks[i];if(cb===fn||cb.fn===fn){callbacks.splice(i,1);break}}if(callbacks.length===0){delete this._callbacks["$"+event]}return this};Emitter.prototype.emit=function(event){this._callbacks=this._callbacks||{};var args=new Array(arguments.length-1),callbacks=this._callbacks["$"+event];for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}if(callbacks){callbacks=callbacks.slice(0);for(var i=0,len=callbacks.length;i<len;++i){callbacks[i].apply(this,args)}}return this};Emitter.prototype.emitReserved=Emitter.prototype.emit;Emitter.prototype.listeners=function(event){this._callbacks=this._callbacks||{};return this._callbacks["$"+event]||[]};Emitter.prototype.hasListeners=function(event){return!!this.listeners(event).length}},{}],76:[function(require,module,exports){
/*!
 * accepts
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var Negotiator=require("negotiator");var mime=require("mime-types");module.exports=Accepts;function Accepts(req){if(!(this instanceof Accepts)){return new Accepts(req)}this.headers=req.headers;this.negotiator=new Negotiator(req)}Accepts.prototype.type=Accepts.prototype.types=function(types_){var types=types_;if(types&&!Array.isArray(types)){types=new Array(arguments.length);for(var i=0;i<types.length;i++){types[i]=arguments[i]}}if(!types||types.length===0){return this.negotiator.mediaTypes()}if(!this.headers.accept){return types[0]}var mimes=types.map(extToMime);var accepts=this.negotiator.mediaTypes(mimes.filter(validMime));var first=accepts[0];return first?types[mimes.indexOf(first)]:false};Accepts.prototype.encoding=Accepts.prototype.encodings=function(encodings_){var encodings=encodings_;if(encodings&&!Array.isArray(encodings)){encodings=new Array(arguments.length);for(var i=0;i<encodings.length;i++){encodings[i]=arguments[i]}}if(!encodings||encodings.length===0){return this.negotiator.encodings()}return this.negotiator.encodings(encodings)[0]||false};Accepts.prototype.charset=Accepts.prototype.charsets=function(charsets_){var charsets=charsets_;if(charsets&&!Array.isArray(charsets)){charsets=new Array(arguments.length);for(var i=0;i<charsets.length;i++){charsets[i]=arguments[i]}}if(!charsets||charsets.length===0){return this.negotiator.charsets()}return this.negotiator.charsets(charsets)[0]||false};Accepts.prototype.lang=Accepts.prototype.langs=Accepts.prototype.language=Accepts.prototype.languages=function(languages_){var languages=languages_;if(languages&&!Array.isArray(languages)){languages=new Array(arguments.length);for(var i=0;i<languages.length;i++){languages[i]=arguments[i]}}if(!languages||languages.length===0){return this.negotiator.languages()}return this.negotiator.languages(languages)[0]||false};function extToMime(type){return type.indexOf("/")===-1?mime.lookup(type):type}function validMime(type){return typeof type==="string"}},{"mime-types":201,negotiator:203}],77:[function(require,module,exports){
/*!
 * base64id v0.1.0
 */
var crypto=require("crypto");var Base64Id=function(){};Base64Id.prototype.getRandomBytes=function(bytes){var BUFFER_SIZE=4096;var self=this;bytes=bytes||12;if(bytes>BUFFER_SIZE){return crypto.randomBytes(bytes)}var bytesInBuffer=parseInt(BUFFER_SIZE/bytes);var threshold=parseInt(bytesInBuffer*.85);if(!threshold){return crypto.randomBytes(bytes)}if(this.bytesBufferIndex==null){this.bytesBufferIndex=-1}if(this.bytesBufferIndex==bytesInBuffer){this.bytesBuffer=null;this.bytesBufferIndex=-1}if(this.bytesBufferIndex==-1||this.bytesBufferIndex>threshold){if(!this.isGeneratingBytes){this.isGeneratingBytes=true;crypto.randomBytes(BUFFER_SIZE,function(err,bytes){self.bytesBuffer=bytes;self.bytesBufferIndex=0;self.isGeneratingBytes=false})}if(this.bytesBufferIndex==-1){return crypto.randomBytes(bytes)}}var result=this.bytesBuffer.slice(bytes*this.bytesBufferIndex,bytes*(this.bytesBufferIndex+1));this.bytesBufferIndex++;return result};Base64Id.prototype.generateId=function(){var rand=Buffer.alloc(15);if(!rand.writeInt32BE){return Math.abs(Math.random()*Math.random()*Date.now()|0).toString()+Math.abs(Math.random()*Math.random()*Date.now()|0).toString()}this.sequenceNumber=this.sequenceNumber+1|0;rand.writeInt32BE(this.sequenceNumber,11);if(crypto.randomBytes){this.getRandomBytes(12).copy(rand)}else{[0,4,8].forEach(function(i){rand.writeInt32BE(Math.random()*Math.pow(2,32)|0,i)})}return rand.toString("base64").replace(/\//g,"_").replace(/\+/g,"-")};exports=module.exports=new Base64Id},{crypto:undefined}],78:[function(require,module,exports){(function(undefined){var chr=String.fromCharCode;var tok=new Array(65536);for(var i=0;i<65536;i++){tok[i]=chr(i)}var enc="";function _encode(data,top){if(typeof data==="number"){var m=data|0;if(m!==data){var add=0,r=(data-m)*100;if(r<0){add=(r+1|0)-r;r=add>=1&&add<=1.5?r|0:r-1|0}else{add=r|0;r=r-add>=.5?r+1|0:add}add=0;if(data<0){m=0-m;r=0-r;add=1}if(m<65536){if(m===0){enc+=tok[13+add]+tok[r+128]}else{enc+=tok[13+add]+tok[r]+tok[m]}}else{enc+=tok[15+add]+tok[m>>16&65535]+tok[m&65535]+tok[r]}}else{var add=0;if(data<=0){data=0-data;add=1}else{data--}if(data<116){enc+=tok[17+data+add*116]}else if(data<65536){enc+=tok[1+add]+tok[data]}else{enc+=tok[3+add]+tok[data>>16&65535]+tok[data&65535]}}}else if(typeof data==="string"){var l=data.length;enc+=tok[7];while(l>=65535){l-=65535;enc+=tok[65535]}enc+=tok[l]+data}else if(data===true){enc+=tok[5]}else if(data===false){enc+=tok[6]}else if(data===null){enc+=tok[0]}else if(data instanceof Array){enc+=tok[8];for(var i=0,l=data.length;i<l;i++){_encode(data[i],false)}if(!top){enc+=tok[9]}}else if(data instanceof Object){enc+=tok[10];for(var e in data){enc+=tok[17+e.length]+e;_encode(data[e],false)}if(!top){enc+=tok[11]}}}function encode(data){enc="";_encode(data,true);return enc}function decode(data){var p=0,l=data.length;var stack=[],dec=undefined,f=null,t=0,i=-1;var dict=false,set=false;var key="",e=null,r=0;while(p<l){t=data.charCodeAt(p++);f=stack[i];if(dict&&set&&t>16){key=data.substring(p,p+t-17);p+=t-17;set=false}else if(t===8||t===10){e=t===8?new Array:new Object;set=dict=t===10;dec!==undefined?f instanceof Array?f.push(e):f[key]=e:dec=e;stack.push(e);i++}else if(t===11||t===9){stack.pop();set=dict=!(stack[--i]instanceof Array)}else if(t>16){t=t-17;t=t>115?0-t+116:t+1;f instanceof Array?f.push(t):f[key]=t;set=true}else if(t>0&&t<5){if(((t-1)/2|0)===0){e=data.charCodeAt(p);p++}else{e=(data.charCodeAt(p)<<16)+data.charCodeAt(p+1);p+=2}e=t%2?e+1:0-e;f instanceof Array?f.push(e):f[key]=e;set=true}else if(t>12&&t<17){if(((t-13)/2|0)===0){r=data.charCodeAt(p);if(r>127){e=0;r-=128;p++}else{e=data.charCodeAt(p+1);p+=2}}else{e=(data.charCodeAt(p)<<16)+data.charCodeAt(p+1);r=data.charCodeAt(p+2);p+=3}e=t%2?e+r*.01:0-(e+r*.01);f instanceof Array?f.push(e):f[key]=e;set=true}else if(t>4&&t<7){f instanceof Array?f.push(t===5):f[key]=t===5;set=true}else if(t===0){f instanceof Array?f.push(null):f[key]=null;set=true}else if(t===7){e=0;while(data.charCodeAt(p)===65535){e+=65535;p++}e+=data.charCodeAt(p++);f instanceof Array?f.push(data.substr(p,e)):f[key]=data.substr(p,e);p+=e;set=true}}return dec}if(typeof window==="undefined"){exports.encode=encode;exports.decode=decode}else{window.BISON={encode:encode,decode:decode}}})()},{}],79:[function(require,module,exports){
/*!
 * connect
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var debug=require("debug")("connect:dispatcher");var EventEmitter=require("events").EventEmitter;var finalhandler=require("finalhandler");var http=require("http");var merge=require("utils-merge");var parseUrl=require("parseurl");module.exports=createServer;var env=process.env.NODE_ENV||"development";var proto={};var defer=typeof setImmediate==="function"?setImmediate:function(fn){process.nextTick(fn.bind.apply(fn,arguments))};function createServer(){function app(req,res,next){app.handle(req,res,next)}merge(app,proto);merge(app,EventEmitter.prototype);app.route="/";app.stack=[];return app}proto.use=function use(route,fn){var handle=fn;var path=route;if(typeof route!=="string"){handle=route;path="/"}if(typeof handle.handle==="function"){var server=handle;server.route=path;handle=function(req,res,next){server.handle(req,res,next)}}if(handle instanceof http.Server){handle=handle.listeners("request")[0]}if(path[path.length-1]==="/"){path=path.slice(0,-1)}debug("use %s %s",path||"/",handle.name||"anonymous");this.stack.push({route:path,handle:handle});return this};proto.handle=function handle(req,res,out){var index=0;var protohost=getProtohost(req.url)||"";var removed="";var slashAdded=false;var stack=this.stack;var done=out||finalhandler(req,res,{env:env,onerror:logerror});req.originalUrl=req.originalUrl||req.url;function next(err){if(slashAdded){req.url=req.url.substr(1);slashAdded=false}if(removed.length!==0){req.url=protohost+removed+req.url.substr(protohost.length);removed=""}var layer=stack[index++];if(!layer){defer(done,err);return}var path=parseUrl(req).pathname||"/";var route=layer.route;if(path.toLowerCase().substr(0,route.length)!==route.toLowerCase()){return next(err)}var c=path.length>route.length&&path[route.length];if(c&&c!=="/"&&c!=="."){return next(err)}if(route.length!==0&&route!=="/"){removed=route;req.url=protohost+req.url.substr(protohost.length+removed.length);if(!protohost&&req.url[0]!=="/"){req.url="/"+req.url;slashAdded=true}}call(layer.handle,route,err,req,res,next)}next()};proto.listen=function listen(){var server=http.createServer(this);return server.listen.apply(server,arguments)};function call(handle,route,err,req,res,next){var arity=handle.length;var error=err;var hasError=Boolean(err);debug("%s %s : %s",handle.name||"<anonymous>",route,req.originalUrl);try{if(hasError&&arity===4){handle(err,req,res,next);return}else if(!hasError&&arity<4){handle(req,res,next);return}}catch(e){error=e}next(error)}function logerror(err){if(env!=="test")console.error(err.stack||err.toString())}function getProtohost(url){if(url.length===0||url[0]==="/"){return undefined}var fqdnIndex=url.indexOf("://");return fqdnIndex!==-1&&url.lastIndexOf("?",fqdnIndex)===-1?url.substr(0,url.indexOf("/",3+fqdnIndex)):undefined}},{debug:82,events:undefined,finalhandler:181,http:undefined,parseurl:209,"utils-merge":315}],80:[function(require,module,exports){exports=module.exports=require("./debug");exports.log=log;exports.formatArgs=formatArgs;exports.save=save;exports.load=load;exports.useColors=useColors;exports.storage="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:localstorage();exports.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"];function useColors(){if(typeof window!=="undefined"&&window.process&&window.process.type==="renderer"){return true}return typeof document!=="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!=="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}exports.formatters.j=function(v){try{return JSON.stringify(v)}catch(err){return"[UnexpectedJSONParseError]: "+err.message}};function formatArgs(args){var useColors=this.useColors;args[0]=(useColors?"%c":"")+this.namespace+(useColors?" %c":" ")+args[0]+(useColors?"%c ":" ")+"+"+exports.humanize(this.diff);if(!useColors)return;var c="color: "+this.color;args.splice(1,0,c,"color: inherit");var index=0;var lastC=0;args[0].replace(/%[a-zA-Z%]/g,function(match){if("%%"===match)return;index++;if("%c"===match){lastC=index}});args.splice(lastC,0,c)}function log(){return"object"===typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function save(namespaces){try{if(null==namespaces){exports.storage.removeItem("debug")}else{exports.storage.debug=namespaces}}catch(e){}}function load(){var r;try{r=exports.storage.debug}catch(e){}if(!r&&typeof process!=="undefined"&&"env"in process){r=process.env.DEBUG}return r}exports.enable(load());function localstorage(){try{return window.localStorage}catch(e){}}},{"./debug":81}],81:[function(require,module,exports){exports=module.exports=createDebug.debug=createDebug["default"]=createDebug;exports.coerce=coerce;exports.disable=disable;exports.enable=enable;exports.enabled=enabled;exports.humanize=require("ms");exports.names=[];exports.skips=[];exports.formatters={};var prevTime;function selectColor(namespace){var hash=0,i;for(i in namespace){hash=(hash<<5)-hash+namespace.charCodeAt(i);hash|=0}return exports.colors[Math.abs(hash)%exports.colors.length]}function createDebug(namespace){function debug(){if(!debug.enabled)return;var self=debug;var curr=+new Date;var ms=curr-(prevTime||curr);self.diff=ms;self.prev=prevTime;self.curr=curr;prevTime=curr;var args=new Array(arguments.length);for(var i=0;i<args.length;i++){args[i]=arguments[i]}args[0]=exports.coerce(args[0]);if("string"!==typeof args[0]){args.unshift("%O")}var index=0;args[0]=args[0].replace(/%([a-zA-Z%])/g,function(match,format){if(match==="%%")return match;index++;var formatter=exports.formatters[format];if("function"===typeof formatter){var val=args[index];match=formatter.call(self,val);args.splice(index,1);index--}return match});exports.formatArgs.call(self,args);var logFn=debug.log||exports.log||console.log.bind(console);logFn.apply(self,args)}debug.namespace=namespace;debug.enabled=exports.enabled(namespace);debug.useColors=exports.useColors();debug.color=selectColor(namespace);if("function"===typeof exports.init){exports.init(debug)}return debug}function enable(namespaces){exports.save(namespaces);exports.names=[];exports.skips=[];var split=(typeof namespaces==="string"?namespaces:"").split(/[\s,]+/);var len=split.length;for(var i=0;i<len;i++){if(!split[i])continue;namespaces=split[i].replace(/\*/g,".*?");if(namespaces[0]==="-"){exports.skips.push(new RegExp("^"+namespaces.substr(1)+"$"))}else{exports.names.push(new RegExp("^"+namespaces+"$"))}}}function disable(){exports.enable("")}function enabled(name){var i,len;for(i=0,len=exports.skips.length;i<len;i++){if(exports.skips[i].test(name)){return false}}for(i=0,len=exports.names.length;i<len;i++){if(exports.names[i].test(name)){return true}}return false}function coerce(val){if(val instanceof Error)return val.stack||val.message;return val}},{ms:84}],82:[function(require,module,exports){if(typeof process!=="undefined"&&process.type==="renderer"){module.exports=require("./browser.js")}else{module.exports=require("./node.js")}},{"./browser.js":80,"./node.js":83}],83:[function(require,module,exports){var tty=require("tty");var util=require("util");exports=module.exports=require("./debug");exports.init=init;exports.log=log;exports.formatArgs=formatArgs;exports.save=save;exports.load=load;exports.useColors=useColors;exports.colors=[6,2,3,4,5,1];exports.inspectOpts=Object.keys(process.env).filter(function(key){return/^debug_/i.test(key)}).reduce(function(obj,key){var prop=key.substring(6).toLowerCase().replace(/_([a-z])/g,function(_,k){return k.toUpperCase()});var val=process.env[key];if(/^(yes|on|true|enabled)$/i.test(val))val=true;else if(/^(no|off|false|disabled)$/i.test(val))val=false;else if(val==="null")val=null;else val=Number(val);obj[prop]=val;return obj},{});var fd=parseInt(process.env.DEBUG_FD,10)||2;if(1!==fd&&2!==fd){util.deprecate(function(){},"except for stderr(2) and stdout(1), any other usage of DEBUG_FD is deprecated. Override debug.log if you want to use a different log function (https://git.io/debug_fd)")()}var stream=1===fd?process.stdout:2===fd?process.stderr:createWritableStdioStream(fd);function useColors(){return"colors"in exports.inspectOpts?Boolean(exports.inspectOpts.colors):tty.isatty(fd)}exports.formatters.o=function(v){this.inspectOpts.colors=this.useColors;return util.inspect(v,this.inspectOpts).split("\n").map(function(str){return str.trim()}).join(" ")};exports.formatters.O=function(v){this.inspectOpts.colors=this.useColors;return util.inspect(v,this.inspectOpts)};function formatArgs(args){var name=this.namespace;var useColors=this.useColors;if(useColors){var c=this.color;var prefix="  [3"+c+";1m"+name+" "+"[0m";args[0]=prefix+args[0].split("\n").join("\n"+prefix);args.push("[3"+c+"m+"+exports.humanize(this.diff)+"[0m")}else{args[0]=(new Date).toUTCString()+" "+name+" "+args[0]}}function log(){return stream.write(util.format.apply(util,arguments)+"\n")}function save(namespaces){if(null==namespaces){delete process.env.DEBUG}else{process.env.DEBUG=namespaces}}function load(){return process.env.DEBUG}function createWritableStdioStream(fd){var stream;var tty_wrap=process.binding("tty_wrap");switch(tty_wrap.guessHandleType(fd)){case"TTY":stream=new tty.WriteStream(fd);stream._type="tty";if(stream._handle&&stream._handle.unref){stream._handle.unref()}break;case"FILE":var fs=require("fs");stream=new fs.SyncWriteStream(fd,{autoClose:false});stream._type="fs";break;case"PIPE":case"TCP":var net=require("net");stream=new net.Socket({fd:fd,readable:false,writable:true});stream.readable=false;stream.read=null;stream._type="pipe";if(stream._handle&&stream._handle.unref){stream._handle.unref()}break;default:throw new Error("Implement me. Unknown stream file type!")}stream.fd=fd;stream._isStdio=true;return stream}function init(debug){debug.inspectOpts={};var keys=Object.keys(exports.inspectOpts);for(var i=0;i<keys.length;i++){debug.inspectOpts[keys[i]]=exports.inspectOpts[keys[i]]}}exports.enable(load())},{"./debug":81,fs:undefined,net:undefined,tty:undefined,util:undefined}],84:[function(require,module,exports){var s=1e3;var m=s*60;var h=m*60;var d=h*24;var y=d*365.25;module.exports=function(val,options){options=options||{};var type=typeof val;if(type==="string"&&val.length>0){return parse(val)}else if(type==="number"&&isNaN(val)===false){return options.long?fmtLong(val):fmtShort(val)}throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(val))};function parse(str){str=String(str);if(str.length>100){return}var match=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(str);if(!match){return}var n=parseFloat(match[1]);var type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"yrs":case"yr":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"hrs":case"hr":case"h":return n*h;case"minutes":case"minute":case"mins":case"min":case"m":return n*m;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return undefined}}function fmtShort(ms){if(ms>=d){return Math.round(ms/d)+"d"}if(ms>=h){return Math.round(ms/h)+"h"}if(ms>=m){return Math.round(ms/m)+"m"}if(ms>=s){return Math.round(ms/s)+"s"}return ms+"ms"}function fmtLong(ms){return plural(ms,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms"}function plural(ms,n,name){if(ms<n){return}if(ms<n*1.5){return Math.floor(ms/n)+" "+name}return Math.ceil(ms/n)+" "+name+"s"}},{}],85:[function(require,module,exports){(function(){"use strict";var assign=require("object-assign");var vary=require("vary");var defaults={origin:"*",methods:"GET,HEAD,PUT,PATCH,POST,DELETE",preflightContinue:false,optionsSuccessStatus:204};function isString(s){return typeof s==="string"||s instanceof String}function isOriginAllowed(origin,allowedOrigin){if(Array.isArray(allowedOrigin)){for(var i=0;i<allowedOrigin.length;++i){if(isOriginAllowed(origin,allowedOrigin[i])){return true}}return false}else if(isString(allowedOrigin)){return origin===allowedOrigin}else if(allowedOrigin instanceof RegExp){return allowedOrigin.test(origin)}else{return!!allowedOrigin}}function configureOrigin(options,req){var requestOrigin=req.headers.origin,headers=[],isAllowed;if(!options.origin||options.origin==="*"){headers.push([{key:"Access-Control-Allow-Origin",value:"*"}])}else if(isString(options.origin)){headers.push([{key:"Access-Control-Allow-Origin",value:options.origin}]);headers.push([{key:"Vary",value:"Origin"}])}else{isAllowed=isOriginAllowed(requestOrigin,options.origin);headers.push([{key:"Access-Control-Allow-Origin",value:isAllowed?requestOrigin:false}]);headers.push([{key:"Vary",value:"Origin"}])}return headers}function configureMethods(options){var methods=options.methods;if(methods.join){methods=options.methods.join(",")}return{key:"Access-Control-Allow-Methods",value:methods}}function configureCredentials(options){if(options.credentials===true){return{key:"Access-Control-Allow-Credentials",value:"true"}}return null}function configureAllowedHeaders(options,req){var allowedHeaders=options.allowedHeaders||options.headers;var headers=[];if(!allowedHeaders){allowedHeaders=req.headers["access-control-request-headers"];headers.push([{key:"Vary",value:"Access-Control-Request-Headers"}])}else if(allowedHeaders.join){allowedHeaders=allowedHeaders.join(",")}if(allowedHeaders&&allowedHeaders.length){headers.push([{key:"Access-Control-Allow-Headers",value:allowedHeaders}])}return headers}function configureExposedHeaders(options){var headers=options.exposedHeaders;if(!headers){return null}else if(headers.join){headers=headers.join(",")}if(headers&&headers.length){return{key:"Access-Control-Expose-Headers",value:headers}}return null}function configureMaxAge(options){var maxAge=(typeof options.maxAge==="number"||options.maxAge)&&options.maxAge.toString();if(maxAge&&maxAge.length){return{key:"Access-Control-Max-Age",value:maxAge}}return null}function applyHeaders(headers,res){for(var i=0,n=headers.length;i<n;i++){var header=headers[i];if(header){if(Array.isArray(header)){applyHeaders(header,res)}else if(header.key==="Vary"&&header.value){vary(res,header.value)}else if(header.value){res.setHeader(header.key,header.value)}}}}function cors(options,req,res,next){var headers=[],method=req.method&&req.method.toUpperCase&&req.method.toUpperCase();if(method==="OPTIONS"){headers.push(configureOrigin(options,req));headers.push(configureCredentials(options,req));headers.push(configureMethods(options,req));headers.push(configureAllowedHeaders(options,req));headers.push(configureMaxAge(options,req));headers.push(configureExposedHeaders(options,req));applyHeaders(headers,res);if(options.preflightContinue){next()}else{res.statusCode=options.optionsSuccessStatus;res.setHeader("Content-Length","0");res.end()}}else{headers.push(configureOrigin(options,req));headers.push(configureCredentials(options,req));headers.push(configureExposedHeaders(options,req));applyHeaders(headers,res);next()}}function middlewareWrapper(o){var optionsCallback=null;if(typeof o==="function"){optionsCallback=o}else{optionsCallback=function(req,cb){cb(null,o)}}return function corsMiddleware(req,res,next){optionsCallback(req,function(err,options){if(err){next(err)}else{var corsOptions=assign({},defaults,options);var originCallback=null;if(corsOptions.origin&&typeof corsOptions.origin==="function"){originCallback=corsOptions.origin}else if(corsOptions.origin){originCallback=function(origin,cb){cb(null,corsOptions.origin)}}if(originCallback){originCallback(req.headers.origin,function(err2,origin){if(err2||!origin){next(err2)}else{corsOptions.origin=origin;cors(corsOptions,req,res,next)}})}else{next()}}})}}module.exports=middlewareWrapper})()},{"object-assign":208,vary:316}],86:[function(require,module,exports){"use strict";var isValue=require("type/value/is"),isPlainFunction=require("type/plain-function/is"),assign=require("es5-ext/object/assign"),normalizeOpts=require("es5-ext/object/normalize-options"),contains=require("es5-ext/string/#/contains");var d=module.exports=function(dscr,value){var c,e,w,options,desc;if(arguments.length<2||typeof dscr!=="string"){options=value;value=dscr;dscr=null}else{options=arguments[2]}if(isValue(dscr)){c=contains.call(dscr,"c");e=contains.call(dscr,"e");w=contains.call(dscr,"w")}else{c=w=true;e=false}desc={value:value,configurable:c,enumerable:e,writable:w};return!options?desc:assign(normalizeOpts(options),desc)};d.gs=function(dscr,get,set){var c,e,options,desc;if(typeof dscr!=="string"){options=set;set=get;get=dscr;dscr=null}else{options=arguments[3]}if(!isValue(get)){get=undefined}else if(!isPlainFunction(get)){options=get;get=set=undefined}else if(!isValue(set)){set=undefined}else if(!isPlainFunction(set)){options=set;set=undefined}if(isValue(dscr)){c=contains.call(dscr,"c");e=contains.call(dscr,"e")}else{c=true;e=false}desc={get:get,set:set,configurable:c,enumerable:e};return!options?desc:assign(normalizeOpts(options),desc)}},{"es5-ext/object/assign":146,"es5-ext/object/normalize-options":157,"es5-ext/string/#/contains":164,"type/plain-function/is":304,"type/value/is":309}],87:[function(require,module,exports){"use strict";var isPlainFunction=require("type/plain-function/is"),ensureValue=require("type/value/ensure"),isValue=require("type/value/is"),map=require("es5-ext/object/map"),contains=require("es5-ext/string/#/contains");var call=Function.prototype.call,defineProperty=Object.defineProperty,getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor,getPrototypeOf=Object.getPrototypeOf,hasOwnProperty=Object.prototype.hasOwnProperty,cacheDesc={configurable:false,enumerable:false,writable:false,value:null},define;define=function(name,options){var value,dgs,cacheName,desc,writable=false,resolvable,flat;options=Object(ensureValue(options));cacheName=options.cacheName;flat=options.flat;if(!isValue(cacheName))cacheName=name;delete options.cacheName;value=options.value;resolvable=isPlainFunction(value);delete options.value;dgs={configurable:Boolean(options.configurable),enumerable:Boolean(options.enumerable)};if(name!==cacheName){dgs.get=function(){if(hasOwnProperty.call(this,cacheName))return this[cacheName];cacheDesc.value=resolvable?call.call(value,this,options):value;cacheDesc.writable=writable;defineProperty(this,cacheName,cacheDesc);cacheDesc.value=null;if(desc)defineProperty(this,name,desc);return this[cacheName]}}else if(!flat){dgs.get=function self(){var ownDesc;if(hasOwnProperty.call(this,name)){ownDesc=getOwnPropertyDescriptor(this,name);if(ownDesc){if(ownDesc.hasOwnProperty("value"))return ownDesc.value;if(typeof ownDesc.get==="function"&&ownDesc.get!==self){return ownDesc.get.call(this)}return value}}desc.value=resolvable?call.call(value,this,options):value;defineProperty(this,name,desc);desc.value=null;return this[name]}}else{dgs.get=function self(){var base=this,ownDesc;if(hasOwnProperty.call(this,name)){ownDesc=getOwnPropertyDescriptor(this,name);if(ownDesc.hasOwnProperty("value"))return ownDesc.value;if(typeof ownDesc.get==="function"&&ownDesc.get!==self){return ownDesc.get.call(this)}}while(!hasOwnProperty.call(base,name))base=getPrototypeOf(base);desc.value=resolvable?call.call(value,base,options):value;defineProperty(base,name,desc);desc.value=null;return base[name]}}dgs.set=function(value){if(hasOwnProperty.call(this,name)){throw new TypeError("Cannot assign to lazy defined '"+name+"' property of "+this)}dgs.get.call(this);this[cacheName]=value};if(options.desc){desc={configurable:contains.call(options.desc,"c"),enumerable:contains.call(options.desc,"e")};if(cacheName===name){desc.writable=contains.call(options.desc,"w");desc.value=null}else{writable=contains.call(options.desc,"w");desc.get=dgs.get;desc.set=dgs.set}delete options.desc}else if(cacheName===name){desc={configurable:Boolean(options.configurable),enumerable:Boolean(options.enumerable),writable:Boolean(options.writable),value:null}}delete options.configurable;delete options.enumerable;delete options.writable;return dgs};module.exports=function(props){return map(props,function(desc,name){return define(name,desc)})}},{"es5-ext/object/map":156,"es5-ext/string/#/contains":164,"type/plain-function/is":304,"type/value/ensure":308,"type/value/is":309}],88:[function(require,module,exports){
/*!
 * ee-first
 * Copyright(c) 2014 Jonathan Ong
 * MIT Licensed
 */
"use strict";module.exports=first;function first(stuff,done){if(!Array.isArray(stuff))throw new TypeError("arg must be an array of [ee, events...] arrays");var cleanups=[];for(var i=0;i<stuff.length;i++){var arr=stuff[i];if(!Array.isArray(arr)||arr.length<2)throw new TypeError("each array member must be [ee, events...]");var ee=arr[0];for(var j=1;j<arr.length;j++){var event=arr[j];var fn=listener(event,callback);ee.on(event,fn);cleanups.push({ee:ee,event:event,fn:fn})}}function callback(){cleanup();done.apply(null,arguments)}function cleanup(){var x;for(var i=0;i<cleanups.length;i++){x=cleanups[i];x.ee.removeListener(x.event,x.fn)}}function thunk(fn){done=fn}thunk.cancel=cleanup;return thunk}function listener(event,done){return function onevent(arg1){var args=new Array(arguments.length);var ee=this;var err=event==="error"?arg1:null;for(var i=0;i<args.length;i++){args[i]=arguments[i]}done(err,ee,event,args)}}},{}],89:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.hasCORS=void 0;let value=false;try{value=typeof XMLHttpRequest!=="undefined"&&"withCredentials"in new XMLHttpRequest}catch(err){}exports.hasCORS=value},{}],90:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.encode=encode;exports.decode=decode;function encode(obj){let str="";for(let i in obj){if(obj.hasOwnProperty(i)){if(str.length)str+="&";str+=encodeURIComponent(i)+"="+encodeURIComponent(obj[i])}}return str}function decode(qs){let qry={};let pairs=qs.split("&");for(let i=0,l=pairs.length;i<l;i++){let pair=pairs[i].split("=");qry[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1])}return qry}},{}],91:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.parse=parse;const re=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;const parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function parse(str){if(str.length>8e3){throw"URI too long"}const src=str,b=str.indexOf("["),e=str.indexOf("]");if(b!=-1&&e!=-1){str=str.substring(0,b)+str.substring(b,e).replace(/:/g,";")+str.substring(e,str.length)}let m=re.exec(str||""),uri={},i=14;while(i--){uri[parts[i]]=m[i]||""}if(b!=-1&&e!=-1){uri.source=src;uri.host=uri.host.substring(1,uri.host.length-1).replace(/;/g,":");uri.authority=uri.authority.replace("[","").replace("]","").replace(/;/g,":");uri.ipv6uri=true}uri.pathNames=pathNames(uri,uri["path"]);uri.queryKey=queryKey(uri,uri["query"]);return uri}function pathNames(obj,path){const regx=/\/{2,9}/g,names=path.replace(regx,"/").split("/");if(path.slice(0,1)=="/"||path.length===0){names.splice(0,1)}if(path.slice(-1)=="/"){names.splice(names.length-1,1)}return names}function queryKey(uri,query){const data={};query.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function($0,$1,$2){if($1){data[$1]=$2}});return data}},{}],92:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.CookieJar=exports.defaultBinaryType=exports.globalThisShim=exports.nextTick=void 0;exports.createCookieJar=createCookieJar;exports.parse=parse;exports.nextTick=process.nextTick;exports.globalThisShim=global;exports.defaultBinaryType="nodebuffer";function createCookieJar(){return new CookieJar}function parse(setCookieString){const parts=setCookieString.split("; ");const i=parts[0].indexOf("=");if(i===-1){return}const name=parts[0].substring(0,i).trim();if(!name.length){return}let value=parts[0].substring(i+1).trim();if(value.charCodeAt(0)===34){value=value.slice(1,-1)}const cookie={name:name,value:value};for(let j=1;j<parts.length;j++){const subParts=parts[j].split("=");if(subParts.length!==2){continue}const key=subParts[0].trim();const value=subParts[1].trim();switch(key){case"Expires":cookie.expires=new Date(value);break;case"Max-Age":const expiration=new Date;expiration.setUTCSeconds(expiration.getUTCSeconds()+parseInt(value,10));cookie.expires=expiration;break;default:}}return cookie}class CookieJar{constructor(){this._cookies=new Map}parseCookies(values){if(!values){return}values.forEach(value=>{const parsed=parse(value);if(parsed){this._cookies.set(parsed.name,parsed)}})}get cookies(){const now=Date.now();this._cookies.forEach((cookie,name)=>{var _a;if(((_a=cookie.expires)===null||_a===void 0?void 0:_a.getTime())<now){this._cookies.delete(name)}});return this._cookies.entries()}addCookies(xhr){const cookies=[];for(const[name,cookie]of this.cookies){cookies.push(`${name}=${cookie.value}`)}if(cookies.length){xhr.setDisableHeaderCheck(true);xhr.setRequestHeader("cookie",cookies.join("; "))}}appendCookies(headers){for(const[name,cookie]of this.cookies){headers.append("cookie",`${name}=${cookie.value}`)}}}exports.CookieJar=CookieJar},{}],93:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.WebTransport=exports.WebSocket=exports.NodeWebSocket=exports.XHR=exports.NodeXHR=exports.Fetch=exports.nextTick=exports.parse=exports.installTimerFunctions=exports.transports=exports.TransportError=exports.Transport=exports.protocol=exports.SocketWithUpgrade=exports.SocketWithoutUpgrade=exports.Socket=void 0;const socket_js_1=require("./socket.js");Object.defineProperty(exports,"Socket",{enumerable:true,get:function(){return socket_js_1.Socket}});var socket_js_2=require("./socket.js");Object.defineProperty(exports,"SocketWithoutUpgrade",{enumerable:true,get:function(){return socket_js_2.SocketWithoutUpgrade}});Object.defineProperty(exports,"SocketWithUpgrade",{enumerable:true,get:function(){return socket_js_2.SocketWithUpgrade}});exports.protocol=socket_js_1.Socket.protocol;var transport_js_1=require("./transport.js");Object.defineProperty(exports,"Transport",{enumerable:true,get:function(){return transport_js_1.Transport}});Object.defineProperty(exports,"TransportError",{enumerable:true,get:function(){return transport_js_1.TransportError}});var index_js_1=require("./transports/index.js");Object.defineProperty(exports,"transports",{enumerable:true,get:function(){return index_js_1.transports}});var util_js_1=require("./util.js");Object.defineProperty(exports,"installTimerFunctions",{enumerable:true,get:function(){return util_js_1.installTimerFunctions}});var parseuri_js_1=require("./contrib/parseuri.js");Object.defineProperty(exports,"parse",{enumerable:true,get:function(){return parseuri_js_1.parse}});var globals_node_js_1=require("./globals.node.js");Object.defineProperty(exports,"nextTick",{enumerable:true,get:function(){return globals_node_js_1.nextTick}});var polling_fetch_js_1=require("./transports/polling-fetch.js");Object.defineProperty(exports,"Fetch",{enumerable:true,get:function(){return polling_fetch_js_1.Fetch}});var polling_xhr_node_js_1=require("./transports/polling-xhr.node.js");Object.defineProperty(exports,"NodeXHR",{enumerable:true,get:function(){return polling_xhr_node_js_1.XHR}});var polling_xhr_js_1=require("./transports/polling-xhr.js");Object.defineProperty(exports,"XHR",{enumerable:true,get:function(){return polling_xhr_js_1.XHR}});var websocket_node_js_1=require("./transports/websocket.node.js");Object.defineProperty(exports,"NodeWebSocket",{enumerable:true,get:function(){return websocket_node_js_1.WS}});var websocket_js_1=require("./transports/websocket.js");Object.defineProperty(exports,"WebSocket",{enumerable:true,get:function(){return websocket_js_1.WS}});var webtransport_js_1=require("./transports/webtransport.js");Object.defineProperty(exports,"WebTransport",{enumerable:true,get:function(){return webtransport_js_1.WT}})},{"./contrib/parseuri.js":91,"./globals.node.js":92,"./socket.js":94,"./transport.js":95,"./transports/index.js":96,"./transports/polling-fetch.js":97,"./transports/polling-xhr.js":98,"./transports/polling-xhr.node.js":99,"./transports/websocket.js":101,"./transports/websocket.node.js":102,"./transports/webtransport.js":103,"./util.js":104}],94:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.Socket=exports.SocketWithUpgrade=exports.SocketWithoutUpgrade=void 0;const index_js_1=require("./transports/index.js");const util_js_1=require("./util.js");const parseqs_js_1=require("./contrib/parseqs.js");const parseuri_js_1=require("./contrib/parseuri.js");const component_emitter_1=require("@socket.io/component-emitter");const engine_io_parser_1=require("engine.io-parser");const globals_node_js_1=require("./globals.node.js");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("engine.io-client:socket");const withEventListeners=typeof addEventListener==="function"&&typeof removeEventListener==="function";const OFFLINE_EVENT_LISTENERS=[];if(withEventListeners){addEventListener("offline",()=>{debug("closing %d connection(s) because the network was lost",OFFLINE_EVENT_LISTENERS.length);OFFLINE_EVENT_LISTENERS.forEach(listener=>listener())},false)}class SocketWithoutUpgrade extends component_emitter_1.Emitter{constructor(uri,opts){super();this.binaryType=globals_node_js_1.defaultBinaryType;this.writeBuffer=[];this._prevBufferLen=0;this._pingInterval=-1;this._pingTimeout=-1;this._maxPayload=-1;this._pingTimeoutTime=Infinity;if(uri&&"object"===typeof uri){opts=uri;uri=null}if(uri){const parsedUri=(0,parseuri_js_1.parse)(uri);opts.hostname=parsedUri.host;opts.secure=parsedUri.protocol==="https"||parsedUri.protocol==="wss";opts.port=parsedUri.port;if(parsedUri.query)opts.query=parsedUri.query}else if(opts.host){opts.hostname=(0,parseuri_js_1.parse)(opts.host).host}(0,util_js_1.installTimerFunctions)(this,opts);this.secure=null!=opts.secure?opts.secure:typeof location!=="undefined"&&"https:"===location.protocol;if(opts.hostname&&!opts.port){opts.port=this.secure?"443":"80"}this.hostname=opts.hostname||(typeof location!=="undefined"?location.hostname:"localhost");this.port=opts.port||(typeof location!=="undefined"&&location.port?location.port:this.secure?"443":"80");this.transports=[];this._transportsByName={};opts.transports.forEach(t=>{const transportName=t.prototype.name;this.transports.push(transportName);this._transportsByName[transportName]=t});this.opts=Object.assign({path:"/engine.io",agent:false,withCredentials:false,upgrade:true,timestampParam:"t",rememberUpgrade:false,addTrailingSlash:true,rejectUnauthorized:true,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:false},opts);this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":"");if(typeof this.opts.query==="string"){this.opts.query=(0,parseqs_js_1.decode)(this.opts.query)}if(withEventListeners){if(this.opts.closeOnBeforeunload){this._beforeunloadEventListener=()=>{if(this.transport){this.transport.removeAllListeners();this.transport.close()}};addEventListener("beforeunload",this._beforeunloadEventListener,false)}if(this.hostname!=="localhost"){debug("adding listener for the 'offline' event");this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})};OFFLINE_EVENT_LISTENERS.push(this._offlineEventListener)}}if(this.opts.withCredentials){this._cookieJar=(0,globals_node_js_1.createCookieJar)()}this._open()}createTransport(name){debug('creating transport "%s"',name);const query=Object.assign({},this.opts.query);query.EIO=engine_io_parser_1.protocol;query.transport=name;if(this.id)query.sid=this.id;const opts=Object.assign({},this.opts,{query:query,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[name]);debug("options: %j",opts);return new this._transportsByName[name](opts)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const transportName=this.opts.rememberUpgrade&&SocketWithoutUpgrade.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const transport=this.createTransport(transportName);transport.open();this.setTransport(transport)}setTransport(transport){debug("setting transport %s",transport.name);if(this.transport){debug("clearing existing transport %s",this.transport.name);this.transport.removeAllListeners()}this.transport=transport;transport.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",reason=>this._onClose("transport close",reason))}onOpen(){debug("socket open");this.readyState="open";SocketWithoutUpgrade.priorWebsocketSuccess="websocket"===this.transport.name;this.emitReserved("open");this.flush()}_onPacket(packet){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){debug('socket receive: type "%s", data "%s"',packet.type,packet.data);this.emitReserved("packet",packet);this.emitReserved("heartbeat");switch(packet.type){case"open":this.onHandshake(JSON.parse(packet.data));break;case"ping":this._sendPacket("pong");this.emitReserved("ping");this.emitReserved("pong");this._resetPingTimeout();break;case"error":const err=new Error("server error");err.code=packet.data;this._onError(err);break;case"message":this.emitReserved("data",packet.data);this.emitReserved("message",packet.data);break}}else{debug('packet received with socket readyState "%s"',this.readyState)}}onHandshake(data){this.emitReserved("handshake",data);this.id=data.sid;this.transport.query.sid=data.sid;this._pingInterval=data.pingInterval;this._pingTimeout=data.pingTimeout;this._maxPayload=data.maxPayload;this.onOpen();if("closed"===this.readyState)return;this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const delay=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+delay;this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},delay);if(this.opts.autoUnref){this._pingTimeoutTimer.unref()}}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen);this._prevBufferLen=0;if(0===this.writeBuffer.length){this.emitReserved("drain")}else{this.flush()}}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const packets=this._getWritablePackets();debug("flushing %d packets in socket",packets.length);this.transport.send(packets);this._prevBufferLen=packets.length;this.emitReserved("flush")}}_getWritablePackets(){const shouldCheckPayloadSize=this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1;if(!shouldCheckPayloadSize){return this.writeBuffer}let payloadSize=1;for(let i=0;i<this.writeBuffer.length;i++){const data=this.writeBuffer[i].data;if(data){payloadSize+=(0,util_js_1.byteLength)(data)}if(i>0&&payloadSize>this._maxPayload){debug("only send %d out of %d packets",i,this.writeBuffer.length);return this.writeBuffer.slice(0,i)}payloadSize+=2}debug("payload size is %d (max: %d)",payloadSize,this._maxPayload);return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return true;const hasExpired=Date.now()>this._pingTimeoutTime;if(hasExpired){debug("throttled timer detected, scheduling connection close");this._pingTimeoutTime=0;(0,globals_node_js_1.nextTick)(()=>{this._onClose("ping timeout")},this.setTimeoutFn)}return hasExpired}write(msg,options,fn){this._sendPacket("message",msg,options,fn);return this}send(msg,options,fn){this._sendPacket("message",msg,options,fn);return this}_sendPacket(type,data,options,fn){if("function"===typeof data){fn=data;data=undefined}if("function"===typeof options){fn=options;options=null}if("closing"===this.readyState||"closed"===this.readyState){return}options=options||{};options.compress=false!==options.compress;const packet={type:type,data:data,options:options};this.emitReserved("packetCreate",packet);this.writeBuffer.push(packet);if(fn)this.once("flush",fn);this.flush()}close(){const close=()=>{this._onClose("forced close");debug("socket closing - telling transport to close");this.transport.close()};const cleanupAndClose=()=>{this.off("upgrade",cleanupAndClose);this.off("upgradeError",cleanupAndClose);close()};const waitForUpgrade=()=>{this.once("upgrade",cleanupAndClose);this.once("upgradeError",cleanupAndClose)};if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";if(this.writeBuffer.length){this.once("drain",()=>{if(this.upgrading){waitForUpgrade()}else{close()}})}else if(this.upgrading){waitForUpgrade()}else{close()}}return this}_onError(err){debug("socket error %j",err);SocketWithoutUpgrade.priorWebsocketSuccess=false;if(this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening"){debug("trying next transport");this.transports.shift();return this._open()}this.emitReserved("error",err);this._onClose("transport error",err)}_onClose(reason,description){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){debug('socket close with reason: "%s"',reason);this.clearTimeoutFn(this._pingTimeoutTimer);this.transport.removeAllListeners("close");this.transport.close();this.transport.removeAllListeners();if(withEventListeners){if(this._beforeunloadEventListener){removeEventListener("beforeunload",this._beforeunloadEventListener,false)}if(this._offlineEventListener){const i=OFFLINE_EVENT_LISTENERS.indexOf(this._offlineEventListener);if(i!==-1){debug("removing listener for the 'offline' event");OFFLINE_EVENT_LISTENERS.splice(i,1)}}}this.readyState="closed";this.id=null;this.emitReserved("close",reason,description);this.writeBuffer=[];this._prevBufferLen=0}}}exports.SocketWithoutUpgrade=SocketWithoutUpgrade;SocketWithoutUpgrade.protocol=engine_io_parser_1.protocol;class SocketWithUpgrade extends SocketWithoutUpgrade{constructor(){super(...arguments);this._upgrades=[]}onOpen(){super.onOpen();if("open"===this.readyState&&this.opts.upgrade){debug("starting upgrade probes");for(let i=0;i<this._upgrades.length;i++){this._probe(this._upgrades[i])}}}_probe(name){debug('probing transport "%s"',name);let transport=this.createTransport(name);let failed=false;SocketWithoutUpgrade.priorWebsocketSuccess=false;const onTransportOpen=()=>{if(failed)return;debug('probe transport "%s" opened',name);transport.send([{type:"ping",data:"probe"}]);transport.once("packet",msg=>{if(failed)return;if("pong"===msg.type&&"probe"===msg.data){debug('probe transport "%s" pong',name);this.upgrading=true;this.emitReserved("upgrading",transport);if(!transport)return;SocketWithoutUpgrade.priorWebsocketSuccess="websocket"===transport.name;debug('pausing current transport "%s"',this.transport.name);this.transport.pause(()=>{if(failed)return;if("closed"===this.readyState)return;debug("changing transport and sending upgrade packet");cleanup();this.setTransport(transport);transport.send([{type:"upgrade"}]);this.emitReserved("upgrade",transport);transport=null;this.upgrading=false;this.flush()})}else{debug('probe transport "%s" failed',name);const err=new Error("probe error");err.transport=transport.name;this.emitReserved("upgradeError",err)}})};function freezeTransport(){if(failed)return;failed=true;cleanup();transport.close();transport=null}const onerror=err=>{const error=new Error("probe error: "+err);error.transport=transport.name;freezeTransport();debug('probe transport "%s" failed because of error: %s',name,err);this.emitReserved("upgradeError",error)};function onTransportClose(){onerror("transport closed")}function onclose(){onerror("socket closed")}function onupgrade(to){if(transport&&to.name!==transport.name){debug('"%s" works - aborting "%s"',to.name,transport.name);freezeTransport()}}const cleanup=()=>{transport.removeListener("open",onTransportOpen);transport.removeListener("error",onerror);transport.removeListener("close",onTransportClose);this.off("close",onclose);this.off("upgrading",onupgrade)};transport.once("open",onTransportOpen);transport.once("error",onerror);transport.once("close",onTransportClose);this.once("close",onclose);this.once("upgrading",onupgrade);if(this._upgrades.indexOf("webtransport")!==-1&&name!=="webtransport"){this.setTimeoutFn(()=>{if(!failed){transport.open()}},200)}else{transport.open()}}onHandshake(data){this._upgrades=this._filterUpgrades(data.upgrades);super.onHandshake(data)}_filterUpgrades(upgrades){const filteredUpgrades=[];for(let i=0;i<upgrades.length;i++){if(~this.transports.indexOf(upgrades[i]))filteredUpgrades.push(upgrades[i])}return filteredUpgrades}}exports.SocketWithUpgrade=SocketWithUpgrade;class Socket extends SocketWithUpgrade{constructor(uri,opts={}){const o=typeof uri==="object"?uri:opts;if(!o.transports||o.transports&&typeof o.transports[0]==="string"){o.transports=(o.transports||["polling","websocket","webtransport"]).map(transportName=>index_js_1.transports[transportName]).filter(t=>!!t)}super(uri,o)}}exports.Socket=Socket},{"./contrib/parseqs.js":90,"./contrib/parseuri.js":91,"./globals.node.js":92,"./transports/index.js":96,"./util.js":104,"@socket.io/component-emitter":75,debug:107,"engine.io-parser":112}],95:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.Transport=exports.TransportError=void 0;const engine_io_parser_1=require("engine.io-parser");const component_emitter_1=require("@socket.io/component-emitter");const util_js_1=require("./util.js");const parseqs_js_1=require("./contrib/parseqs.js");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("engine.io-client:transport");class TransportError extends Error{constructor(reason,description,context){super(reason);this.description=description;this.context=context;this.type="TransportError"}}exports.TransportError=TransportError;class Transport extends component_emitter_1.Emitter{constructor(opts){super();this.writable=false;(0,util_js_1.installTimerFunctions)(this,opts);this.opts=opts;this.query=opts.query;this.socket=opts.socket;this.supportsBinary=!opts.forceBase64}onError(reason,description,context){super.emitReserved("error",new TransportError(reason,description,context));return this}open(){this.readyState="opening";this.doOpen();return this}close(){if(this.readyState==="opening"||this.readyState==="open"){this.doClose();this.onClose()}return this}send(packets){if(this.readyState==="open"){this.write(packets)}else{debug("transport is not open, discarding packets")}}onOpen(){this.readyState="open";this.writable=true;super.emitReserved("open")}onData(data){const packet=(0,engine_io_parser_1.decodePacket)(data,this.socket.binaryType);this.onPacket(packet)}onPacket(packet){super.emitReserved("packet",packet)}onClose(details){this.readyState="closed";super.emitReserved("close",details)}pause(onPause){}createUri(schema,query={}){return schema+"://"+this._hostname()+this._port()+this.opts.path+this._query(query)}_hostname(){const hostname=this.opts.hostname;return hostname.indexOf(":")===-1?hostname:"["+hostname+"]"}_port(){if(this.opts.port&&(this.opts.secure&&Number(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)){return":"+this.opts.port}else{return""}}_query(query){const encodedQuery=(0,parseqs_js_1.encode)(query);return encodedQuery.length?"?"+encodedQuery:""}}exports.Transport=Transport},{"./contrib/parseqs.js":90,"./util.js":104,"@socket.io/component-emitter":75,debug:107,"engine.io-parser":112}],96:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.transports=void 0;const polling_xhr_node_js_1=require("./polling-xhr.node.js");const websocket_node_js_1=require("./websocket.node.js");const webtransport_js_1=require("./webtransport.js");exports.transports={websocket:websocket_node_js_1.WS,webtransport:webtransport_js_1.WT,polling:polling_xhr_node_js_1.XHR}},{"./polling-xhr.node.js":99,"./websocket.node.js":102,"./webtransport.js":103}],97:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Fetch=void 0;const polling_js_1=require("./polling.js");class Fetch extends polling_js_1.Polling{doPoll(){this._fetch().then(res=>{if(!res.ok){return this.onError("fetch read error",res.status,res)}res.text().then(data=>this.onData(data))}).catch(err=>{this.onError("fetch read error",err)})}doWrite(data,callback){this._fetch(data).then(res=>{if(!res.ok){return this.onError("fetch write error",res.status,res)}callback()}).catch(err=>{this.onError("fetch write error",err)})}_fetch(data){var _a;const isPost=data!==undefined;const headers=new Headers(this.opts.extraHeaders);if(isPost){headers.set("content-type","text/plain;charset=UTF-8")}(_a=this.socket._cookieJar)===null||_a===void 0?void 0:_a.appendCookies(headers);return fetch(this.uri(),{method:isPost?"POST":"GET",body:isPost?data:null,headers:headers,credentials:this.opts.withCredentials?"include":"omit"}).then(res=>{var _a;(_a=this.socket._cookieJar)===null||_a===void 0?void 0:_a.parseCookies(res.headers.getSetCookie());return res})}}exports.Fetch=Fetch},{"./polling.js":100}],98:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.XHR=exports.Request=exports.BaseXHR=void 0;const polling_js_1=require("./polling.js");const component_emitter_1=require("@socket.io/component-emitter");const util_js_1=require("../util.js");const globals_node_js_1=require("../globals.node.js");const has_cors_js_1=require("../contrib/has-cors.js");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("engine.io-client:polling");function empty(){}class BaseXHR extends polling_js_1.Polling{constructor(opts){super(opts);if(typeof location!=="undefined"){const isSSL="https:"===location.protocol;let port=location.port;if(!port){port=isSSL?"443":"80"}this.xd=typeof location!=="undefined"&&opts.hostname!==location.hostname||port!==opts.port}}doWrite(data,fn){const req=this.request({method:"POST",data:data});req.on("success",fn);req.on("error",(xhrStatus,context)=>{this.onError("xhr post error",xhrStatus,context)})}doPoll(){debug("xhr poll");const req=this.request();req.on("data",this.onData.bind(this));req.on("error",(xhrStatus,context)=>{this.onError("xhr poll error",xhrStatus,context)});this.pollXhr=req}}exports.BaseXHR=BaseXHR;class Request extends component_emitter_1.Emitter{constructor(createRequest,uri,opts){super();this.createRequest=createRequest;(0,util_js_1.installTimerFunctions)(this,opts);this._opts=opts;this._method=opts.method||"GET";this._uri=uri;this._data=undefined!==opts.data?opts.data:null;this._create()}_create(){var _a;const opts=(0,util_js_1.pick)(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");opts.xdomain=!!this._opts.xd;const xhr=this._xhr=this.createRequest(opts);try{debug("xhr open %s: %s",this._method,this._uri);xhr.open(this._method,this._uri,true);try{if(this._opts.extraHeaders){xhr.setDisableHeaderCheck&&xhr.setDisableHeaderCheck(true);for(let i in this._opts.extraHeaders){if(this._opts.extraHeaders.hasOwnProperty(i)){xhr.setRequestHeader(i,this._opts.extraHeaders[i])}}}}catch(e){}if("POST"===this._method){try{xhr.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}}try{xhr.setRequestHeader("Accept","*/*")}catch(e){}(_a=this._opts.cookieJar)===null||_a===void 0?void 0:_a.addCookies(xhr);if("withCredentials"in xhr){xhr.withCredentials=this._opts.withCredentials}if(this._opts.requestTimeout){xhr.timeout=this._opts.requestTimeout}xhr.onreadystatechange=()=>{var _a;if(xhr.readyState===3){(_a=this._opts.cookieJar)===null||_a===void 0?void 0:_a.parseCookies(xhr.getResponseHeader("set-cookie"))}if(4!==xhr.readyState)return;if(200===xhr.status||1223===xhr.status){this._onLoad()}else{this.setTimeoutFn(()=>{this._onError(typeof xhr.status==="number"?xhr.status:0)},0)}};debug("xhr data %s",this._data);xhr.send(this._data)}catch(e){this.setTimeoutFn(()=>{this._onError(e)},0);return}if(typeof document!=="undefined"){this._index=Request.requestsCount++;Request.requests[this._index]=this}}_onError(err){this.emitReserved("error",err,this._xhr);this._cleanup(true)}_cleanup(fromError){if("undefined"===typeof this._xhr||null===this._xhr){return}this._xhr.onreadystatechange=empty;if(fromError){try{this._xhr.abort()}catch(e){}}if(typeof document!=="undefined"){delete Request.requests[this._index]}this._xhr=null}_onLoad(){const data=this._xhr.responseText;if(data!==null){this.emitReserved("data",data);this.emitReserved("success");this._cleanup()}}abort(){this._cleanup()}}exports.Request=Request;Request.requestsCount=0;Request.requests={};if(typeof document!=="undefined"){if(typeof attachEvent==="function"){attachEvent("onunload",unloadHandler)}else if(typeof addEventListener==="function"){const terminationEvent="onpagehide"in globals_node_js_1.globalThisShim?"pagehide":"unload";addEventListener(terminationEvent,unloadHandler,false)}}function unloadHandler(){for(let i in Request.requests){if(Request.requests.hasOwnProperty(i)){Request.requests[i].abort()}}}const hasXHR2=function(){const xhr=newRequest({xdomain:false});return xhr&&xhr.responseType!==null}();class XHR extends BaseXHR{constructor(opts){super(opts);const forceBase64=opts&&opts.forceBase64;this.supportsBinary=hasXHR2&&!forceBase64}request(opts={}){Object.assign(opts,{xd:this.xd},this.opts);return new Request(newRequest,this.uri(),opts)}}exports.XHR=XHR;function newRequest(opts){const xdomain=opts.xdomain;try{if("undefined"!==typeof XMLHttpRequest&&(!xdomain||has_cors_js_1.hasCORS)){return new XMLHttpRequest}}catch(e){}if(!xdomain){try{return new(globals_node_js_1.globalThisShim[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}}},{"../contrib/has-cors.js":89,"../globals.node.js":92,"../util.js":104,"./polling.js":100,"@socket.io/component-emitter":75,debug:107}],99:[function(require,module,exports){"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||("get"in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k]}}}Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k]});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:true,value:v})}:function(o,v){o["default"]=v});var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(k!=="default"&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);__setModuleDefault(result,mod);return result};Object.defineProperty(exports,"__esModule",{value:true});exports.XHR=void 0;const XMLHttpRequestModule=__importStar(require("xmlhttprequest-ssl"));const polling_xhr_js_1=require("./polling-xhr.js");const XMLHttpRequest=XMLHttpRequestModule.default||XMLHttpRequestModule;class XHR extends polling_xhr_js_1.BaseXHR{request(opts={}){var _a;Object.assign(opts,{xd:this.xd,cookieJar:(_a=this.socket)===null||_a===void 0?void 0:_a._cookieJar},this.opts);return new polling_xhr_js_1.Request(opts=>new XMLHttpRequest(opts),this.uri(),opts)}}exports.XHR=XHR},{"./polling-xhr.js":98,"xmlhttprequest-ssl":331}],100:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.Polling=void 0;const transport_js_1=require("../transport.js");const util_js_1=require("../util.js");const engine_io_parser_1=require("engine.io-parser");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("engine.io-client:polling");class Polling extends transport_js_1.Transport{constructor(){super(...arguments);this._polling=false}get name(){return"polling"}doOpen(){this._poll()}pause(onPause){this.readyState="pausing";const pause=()=>{debug("paused");this.readyState="paused";onPause()};if(this._polling||!this.writable){let total=0;if(this._polling){debug("we are currently polling - waiting to pause");total++;this.once("pollComplete",function(){debug("pre-pause polling complete");--total||pause()})}if(!this.writable){debug("we are currently writing - waiting to pause");total++;this.once("drain",function(){debug("pre-pause writing complete");--total||pause()})}}else{pause()}}_poll(){debug("polling");this._polling=true;this.doPoll();this.emitReserved("poll")}onData(data){debug("polling got data %s",data);const callback=packet=>{if("opening"===this.readyState&&packet.type==="open"){this.onOpen()}if("close"===packet.type){this.onClose({description:"transport closed by the server"});return false}this.onPacket(packet)};(0,engine_io_parser_1.decodePayload)(data,this.socket.binaryType).forEach(callback);if("closed"!==this.readyState){this._polling=false;this.emitReserved("pollComplete");if("open"===this.readyState){this._poll()}else{debug('ignoring poll - transport state "%s"',this.readyState)}}}doClose(){const close=()=>{debug("writing close packet");this.write([{type:"close"}])};if("open"===this.readyState){debug("transport open - closing");close()}else{debug("transport not open - deferring close");this.once("open",close)}}write(packets){this.writable=false;(0,engine_io_parser_1.encodePayload)(packets,data=>{this.doWrite(data,()=>{this.writable=true;this.emitReserved("drain")})})}uri(){const schema=this.opts.secure?"https":"http";const query=this.query||{};if(false!==this.opts.timestampRequests){query[this.opts.timestampParam]=(0,util_js_1.randomString)()}if(!this.supportsBinary&&!query.sid){query.b64=1}return this.createUri(schema,query)}}exports.Polling=Polling},{"../transport.js":95,"../util.js":104,debug:107,"engine.io-parser":112}],101:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.WS=exports.BaseWS=void 0;const transport_js_1=require("../transport.js");const util_js_1=require("../util.js");const engine_io_parser_1=require("engine.io-parser");const globals_node_js_1=require("../globals.node.js");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("engine.io-client:websocket");const isReactNative=typeof navigator!=="undefined"&&typeof navigator.product==="string"&&navigator.product.toLowerCase()==="reactnative";class BaseWS extends transport_js_1.Transport{get name(){return"websocket"}doOpen(){const uri=this.uri();const protocols=this.opts.protocols;const opts=isReactNative?{}:(0,util_js_1.pick)(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");if(this.opts.extraHeaders){opts.headers=this.opts.extraHeaders}try{this.ws=this.createSocket(uri,protocols,opts)}catch(err){return this.emitReserved("error",err)}this.ws.binaryType=this.socket.binaryType;this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{if(this.opts.autoUnref){this.ws._socket.unref()}this.onOpen()};this.ws.onclose=closeEvent=>this.onClose({description:"websocket connection closed",context:closeEvent});this.ws.onmessage=ev=>this.onData(ev.data);this.ws.onerror=e=>this.onError("websocket error",e)}write(packets){this.writable=false;for(let i=0;i<packets.length;i++){const packet=packets[i];const lastPacket=i===packets.length-1;(0,engine_io_parser_1.encodePacket)(packet,this.supportsBinary,data=>{try{this.doWrite(packet,data)}catch(e){debug("websocket closed before onclose event")}if(lastPacket){(0,globals_node_js_1.nextTick)(()=>{this.writable=true;this.emitReserved("drain")},this.setTimeoutFn)}})}}doClose(){if(typeof this.ws!=="undefined"){this.ws.onerror=()=>{};this.ws.close();this.ws=null}}uri(){const schema=this.opts.secure?"wss":"ws";const query=this.query||{};if(this.opts.timestampRequests){query[this.opts.timestampParam]=(0,util_js_1.randomString)()}if(!this.supportsBinary){query.b64=1}return this.createUri(schema,query)}}exports.BaseWS=BaseWS;const WebSocketCtor=globals_node_js_1.globalThisShim.WebSocket||globals_node_js_1.globalThisShim.MozWebSocket;class WS extends BaseWS{createSocket(uri,protocols,opts){return!isReactNative?protocols?new WebSocketCtor(uri,protocols):new WebSocketCtor(uri):new WebSocketCtor(uri,protocols,opts)}doWrite(_packet,data){this.ws.send(data)}}exports.WS=WS},{"../globals.node.js":92,"../transport.js":95,"../util.js":104,debug:107,"engine.io-parser":112}],102:[function(require,module,exports){"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||("get"in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k]}}}Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k]});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:true,value:v})}:function(o,v){o["default"]=v});var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(k!=="default"&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);__setModuleDefault(result,mod);return result};Object.defineProperty(exports,"__esModule",{value:true});exports.WS=void 0;const ws=__importStar(require("ws"));const websocket_js_1=require("./websocket.js");class WS extends websocket_js_1.BaseWS{createSocket(uri,protocols,opts){var _a;if((_a=this.socket)===null||_a===void 0?void 0:_a._cookieJar){opts.headers=opts.headers||{};opts.headers.cookie=typeof opts.headers.cookie==="string"?[opts.headers.cookie]:opts.headers.cookie||[];for(const[name,cookie]of this.socket._cookieJar.cookies){opts.headers.cookie.push(`${name}=${cookie.value}`)}}return new ws.WebSocket(uri,protocols,opts)}doWrite(packet,data){const opts={};if(packet.options){opts.compress=packet.options.compress}if(this.opts.perMessageDeflate){const len="string"===typeof data?Buffer.byteLength(data):data.length;if(len<this.opts.perMessageDeflate.threshold){opts.compress=false}}this.ws.send(data,opts)}}exports.WS=WS},{"./websocket.js":101,ws:317}],103:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.WT=void 0;const transport_js_1=require("../transport.js");const globals_node_js_1=require("../globals.node.js");const engine_io_parser_1=require("engine.io-parser");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("engine.io-client:webtransport");class WT extends transport_js_1.Transport{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(err){return this.emitReserved("error",err)}this._transport.closed.then(()=>{debug("transport closed gracefully");this.onClose()}).catch(err=>{debug("transport closed due to %s",err);this.onError("webtransport error",err)});this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(stream=>{const decoderStream=(0,engine_io_parser_1.createPacketDecoderStream)(Number.MAX_SAFE_INTEGER,this.socket.binaryType);const reader=stream.readable.pipeThrough(decoderStream).getReader();const encoderStream=(0,engine_io_parser_1.createPacketEncoderStream)();encoderStream.readable.pipeTo(stream.writable);this._writer=encoderStream.writable.getWriter();const read=()=>{reader.read().then(({done:done,value:value})=>{if(done){debug("session is closed");return}debug("received chunk: %o",value);this.onPacket(value);read()}).catch(err=>{debug("an error occurred while reading: %s",err)})};read();const packet={type:"open"};if(this.query.sid){packet.data=`{"sid":"${this.query.sid}"}`}this._writer.write(packet).then(()=>this.onOpen())})})}write(packets){this.writable=false;for(let i=0;i<packets.length;i++){const packet=packets[i];const lastPacket=i===packets.length-1;this._writer.write(packet).then(()=>{if(lastPacket){(0,globals_node_js_1.nextTick)(()=>{this.writable=true;this.emitReserved("drain")},this.setTimeoutFn)}})}}doClose(){var _a;(_a=this._transport)===null||_a===void 0?void 0:_a.close()}}exports.WT=WT},{"../globals.node.js":92,"../transport.js":95,debug:107,"engine.io-parser":112}],104:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.pick=pick;exports.installTimerFunctions=installTimerFunctions;exports.byteLength=byteLength;exports.randomString=randomString;const globals_node_js_1=require("./globals.node.js");function pick(obj,...attr){return attr.reduce((acc,k)=>{if(obj.hasOwnProperty(k)){acc[k]=obj[k]}return acc},{})}const NATIVE_SET_TIMEOUT=globals_node_js_1.globalThisShim.setTimeout;const NATIVE_CLEAR_TIMEOUT=globals_node_js_1.globalThisShim.clearTimeout;function installTimerFunctions(obj,opts){if(opts.useNativeTimers){obj.setTimeoutFn=NATIVE_SET_TIMEOUT.bind(globals_node_js_1.globalThisShim);obj.clearTimeoutFn=NATIVE_CLEAR_TIMEOUT.bind(globals_node_js_1.globalThisShim)}else{obj.setTimeoutFn=globals_node_js_1.globalThisShim.setTimeout.bind(globals_node_js_1.globalThisShim);obj.clearTimeoutFn=globals_node_js_1.globalThisShim.clearTimeout.bind(globals_node_js_1.globalThisShim)}}const BASE64_OVERHEAD=1.33;function byteLength(obj){if(typeof obj==="string"){return utf8Length(obj)}return Math.ceil((obj.byteLength||obj.size)*BASE64_OVERHEAD)}function utf8Length(str){let c=0,length=0;for(let i=0,l=str.length;i<l;i++){c=str.charCodeAt(i);if(c<128){length+=1}else if(c<2048){length+=2}else if(c<55296||c>=57344){length+=3}else{i++;length+=4}}return length}function randomString(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}},{"./globals.node.js":92}],105:[function(require,module,exports){exports.formatArgs=formatArgs;exports.save=save;exports.load=load;exports.useColors=useColors;exports.storage=localstorage();exports.destroy=(()=>{let warned=false;return()=>{if(!warned){warned=true;console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}}})();exports.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function useColors(){if(typeof window!=="undefined"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)){return true}if(typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)){return false}let m;return typeof document!=="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!=="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!=="undefined"&&navigator.userAgent&&(m=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(m[1],10)>=31||typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function formatArgs(args){args[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+args[0]+(this.useColors?"%c ":" ")+"+"+module.exports.humanize(this.diff);if(!this.useColors){return}const c="color: "+this.color;args.splice(1,0,c,"color: inherit");let index=0;let lastC=0;args[0].replace(/%[a-zA-Z%]/g,match=>{if(match==="%%"){return}index++;if(match==="%c"){lastC=index}});args.splice(lastC,0,c)}exports.log=console.debug||console.log||(()=>{});function save(namespaces){try{if(namespaces){exports.storage.setItem("debug",namespaces)}else{exports.storage.removeItem("debug")}}catch(error){}}function load(){let r;try{r=exports.storage.getItem("debug")}catch(error){}if(!r&&typeof process!=="undefined"&&"env"in process){r=process.env.DEBUG}return r}function localstorage(){try{return localStorage}catch(error){}}module.exports=require("./common")(exports);const{formatters:formatters}=module.exports;formatters.j=function(v){try{return JSON.stringify(v)}catch(error){return"[UnexpectedJSONParseError]: "+error.message}}},{"./common":106}],106:[function(require,module,exports){function setup(env){createDebug.debug=createDebug;createDebug.default=createDebug;createDebug.coerce=coerce;createDebug.disable=disable;createDebug.enable=enable;createDebug.enabled=enabled;createDebug.humanize=require("ms");createDebug.destroy=destroy;Object.keys(env).forEach(key=>{createDebug[key]=env[key]});createDebug.names=[];createDebug.skips=[];createDebug.formatters={};function selectColor(namespace){let hash=0;for(let i=0;i<namespace.length;i++){hash=(hash<<5)-hash+namespace.charCodeAt(i);hash|=0}return createDebug.colors[Math.abs(hash)%createDebug.colors.length]}createDebug.selectColor=selectColor;function createDebug(namespace){let prevTime;let enableOverride=null;let namespacesCache;let enabledCache;function debug(...args){if(!debug.enabled){return}const self=debug;const curr=Number(new Date);const ms=curr-(prevTime||curr);self.diff=ms;self.prev=prevTime;self.curr=curr;prevTime=curr;args[0]=createDebug.coerce(args[0]);if(typeof args[0]!=="string"){args.unshift("%O")}let index=0;args[0]=args[0].replace(/%([a-zA-Z%])/g,(match,format)=>{if(match==="%%"){return"%"}index++;const formatter=createDebug.formatters[format];if(typeof formatter==="function"){const val=args[index];match=formatter.call(self,val);args.splice(index,1);index--}return match});createDebug.formatArgs.call(self,args);const logFn=self.log||createDebug.log;logFn.apply(self,args)}debug.namespace=namespace;debug.useColors=createDebug.useColors();debug.color=createDebug.selectColor(namespace);debug.extend=extend;debug.destroy=createDebug.destroy;Object.defineProperty(debug,"enabled",{enumerable:true,configurable:false,get:()=>{if(enableOverride!==null){return enableOverride}if(namespacesCache!==createDebug.namespaces){namespacesCache=createDebug.namespaces;enabledCache=createDebug.enabled(namespace)}return enabledCache},set:v=>{enableOverride=v}});if(typeof createDebug.init==="function"){createDebug.init(debug)}return debug}function extend(namespace,delimiter){const newDebug=createDebug(this.namespace+(typeof delimiter==="undefined"?":":delimiter)+namespace);newDebug.log=this.log;return newDebug}function enable(namespaces){createDebug.save(namespaces);createDebug.namespaces=namespaces;createDebug.names=[];createDebug.skips=[];let i;const split=(typeof namespaces==="string"?namespaces:"").split(/[\s,]+/);const len=split.length;for(i=0;i<len;i++){if(!split[i]){continue}namespaces=split[i].replace(/\*/g,".*?");if(namespaces[0]==="-"){createDebug.skips.push(new RegExp("^"+namespaces.slice(1)+"$"))}else{createDebug.names.push(new RegExp("^"+namespaces+"$"))}}}function disable(){const namespaces=[...createDebug.names.map(toNamespace),...createDebug.skips.map(toNamespace).map(namespace=>"-"+namespace)].join(",");createDebug.enable("");return namespaces}function enabled(name){if(name[name.length-1]==="*"){return true}let i;let len;for(i=0,len=createDebug.skips.length;i<len;i++){if(createDebug.skips[i].test(name)){return false}}for(i=0,len=createDebug.names.length;i<len;i++){if(createDebug.names[i].test(name)){return true}}return false}function toNamespace(regexp){return regexp.toString().substring(2,regexp.toString().length-2).replace(/\.\*\?$/,"*")}function coerce(val){if(val instanceof Error){return val.stack||val.message}return val}function destroy(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}createDebug.enable(createDebug.load());return createDebug}module.exports=setup},{ms:202}],107:[function(require,module,exports){if(typeof process==="undefined"||process.type==="renderer"||process.browser===true||process.__nwjs){module.exports=require("./browser.js")}else{module.exports=require("./node.js")}},{"./browser.js":105,"./node.js":108}],108:[function(require,module,exports){const tty=require("tty");const util=require("util");exports.init=init;exports.log=log;exports.formatArgs=formatArgs;exports.save=save;exports.load=load;exports.useColors=useColors;exports.destroy=util.deprecate(()=>{},"Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.");exports.colors=[6,2,3,4,5,1];try{const supportsColor=require("supports-color");if(supportsColor&&(supportsColor.stderr||supportsColor).level>=2){exports.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221]}}catch(error){}exports.inspectOpts=Object.keys(process.env).filter(key=>/^debug_/i.test(key)).reduce((obj,key)=>{const prop=key.substring(6).toLowerCase().replace(/_([a-z])/g,(_,k)=>k.toUpperCase());let val=process.env[key];if(/^(yes|on|true|enabled)$/i.test(val)){val=true}else if(/^(no|off|false|disabled)$/i.test(val)){val=false}else if(val==="null"){val=null}else{val=Number(val)}obj[prop]=val;return obj},{});function useColors(){return"colors"in exports.inspectOpts?Boolean(exports.inspectOpts.colors):tty.isatty(process.stderr.fd)}function formatArgs(args){const{namespace:name,useColors:useColors}=this;if(useColors){const c=this.color;const colorCode="[3"+(c<8?c:"8;5;"+c);const prefix=`  ${colorCode};1m${name} [0m`;args[0]=prefix+args[0].split("\n").join("\n"+prefix);args.push(colorCode+"m+"+module.exports.humanize(this.diff)+"[0m")}else{args[0]=getDate()+name+" "+args[0]}}function getDate(){if(exports.inspectOpts.hideDate){return""}return(new Date).toISOString()+" "}function log(...args){return process.stderr.write(util.formatWithOptions(exports.inspectOpts,...args)+"\n")}function save(namespaces){if(namespaces){process.env.DEBUG=namespaces}else{delete process.env.DEBUG}}function load(){return process.env.DEBUG}function init(debug){debug.inspectOpts={};const keys=Object.keys(exports.inspectOpts);for(let i=0;i<keys.length;i++){debug.inspectOpts[keys[i]]=exports.inspectOpts[keys[i]]}}module.exports=require("./common")(exports);const{formatters:formatters}=module.exports;formatters.o=function(v){this.inspectOpts.colors=this.useColors;return util.inspect(v,this.inspectOpts).split("\n").map(str=>str.trim()).join(" ")};formatters.O=function(v){this.inspectOpts.colors=this.useColors;return util.inspect(v,this.inspectOpts)}},{"./common":106,"supports-color":297,tty:undefined,util:undefined}],109:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.ERROR_PACKET=exports.PACKET_TYPES_REVERSE=exports.PACKET_TYPES=void 0;const PACKET_TYPES=Object.create(null);exports.PACKET_TYPES=PACKET_TYPES;PACKET_TYPES["open"]="0";PACKET_TYPES["close"]="1";PACKET_TYPES["ping"]="2";PACKET_TYPES["pong"]="3";PACKET_TYPES["message"]="4";PACKET_TYPES["upgrade"]="5";PACKET_TYPES["noop"]="6";const PACKET_TYPES_REVERSE=Object.create(null);exports.PACKET_TYPES_REVERSE=PACKET_TYPES_REVERSE;Object.keys(PACKET_TYPES).forEach(key=>{PACKET_TYPES_REVERSE[PACKET_TYPES[key]]=key});const ERROR_PACKET={type:"error",data:"parser error"};exports.ERROR_PACKET=ERROR_PACKET},{}],110:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.decodePacket=void 0;const commons_js_1=require("./commons.js");const decodePacket=(encodedPacket,binaryType)=>{if(typeof encodedPacket!=="string"){return{type:"message",data:mapBinary(encodedPacket,binaryType)}}const type=encodedPacket.charAt(0);if(type==="b"){const buffer=Buffer.from(encodedPacket.substring(1),"base64");return{type:"message",data:mapBinary(buffer,binaryType)}}if(!commons_js_1.PACKET_TYPES_REVERSE[type]){return commons_js_1.ERROR_PACKET}return encodedPacket.length>1?{type:commons_js_1.PACKET_TYPES_REVERSE[type],data:encodedPacket.substring(1)}:{type:commons_js_1.PACKET_TYPES_REVERSE[type]}};exports.decodePacket=decodePacket;const mapBinary=(data,binaryType)=>{switch(binaryType){case"arraybuffer":if(data instanceof ArrayBuffer){return data}else if(Buffer.isBuffer(data)){return data.buffer.slice(data.byteOffset,data.byteOffset+data.byteLength)}else{return data.buffer}case"nodebuffer":default:if(Buffer.isBuffer(data)){return data}else{return Buffer.from(data)}}}},{"./commons.js":109}],111:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.encodePacket=void 0;exports.encodePacketToBinary=encodePacketToBinary;const commons_js_1=require("./commons.js");const encodePacket=({type:type,data:data},supportsBinary,callback)=>{if(data instanceof ArrayBuffer||ArrayBuffer.isView(data)){return callback(supportsBinary?data:"b"+toBuffer(data,true).toString("base64"))}return callback(commons_js_1.PACKET_TYPES[type]+(data||""))};exports.encodePacket=encodePacket;const toBuffer=(data,forceBufferConversion)=>{if(Buffer.isBuffer(data)||data instanceof Uint8Array&&!forceBufferConversion){return data}else if(data instanceof ArrayBuffer){return Buffer.from(data)}else{return Buffer.from(data.buffer,data.byteOffset,data.byteLength)}};let TEXT_ENCODER;function encodePacketToBinary(packet,callback){if(packet.data instanceof ArrayBuffer||ArrayBuffer.isView(packet.data)){return callback(toBuffer(packet.data,false))}(0,exports.encodePacket)(packet,true,encoded=>{if(!TEXT_ENCODER){TEXT_ENCODER=new TextEncoder}callback(TEXT_ENCODER.encode(encoded))})}},{"./commons.js":109}],112:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.decodePayload=exports.decodePacket=exports.encodePayload=exports.encodePacket=exports.protocol=void 0;exports.createPacketEncoderStream=createPacketEncoderStream;exports.createPacketDecoderStream=createPacketDecoderStream;const encodePacket_js_1=require("./encodePacket.js");Object.defineProperty(exports,"encodePacket",{enumerable:true,get:function(){return encodePacket_js_1.encodePacket}});const decodePacket_js_1=require("./decodePacket.js");Object.defineProperty(exports,"decodePacket",{enumerable:true,get:function(){return decodePacket_js_1.decodePacket}});const commons_js_1=require("./commons.js");const SEPARATOR=String.fromCharCode(30);const encodePayload=(packets,callback)=>{const length=packets.length;const encodedPackets=new Array(length);let count=0;packets.forEach((packet,i)=>{(0,encodePacket_js_1.encodePacket)(packet,false,encodedPacket=>{encodedPackets[i]=encodedPacket;if(++count===length){callback(encodedPackets.join(SEPARATOR))}})})};exports.encodePayload=encodePayload;const decodePayload=(encodedPayload,binaryType)=>{const encodedPackets=encodedPayload.split(SEPARATOR);const packets=[];for(let i=0;i<encodedPackets.length;i++){const decodedPacket=(0,decodePacket_js_1.decodePacket)(encodedPackets[i],binaryType);packets.push(decodedPacket);if(decodedPacket.type==="error"){break}}return packets};exports.decodePayload=decodePayload;function createPacketEncoderStream(){return new TransformStream({transform(packet,controller){(0,encodePacket_js_1.encodePacketToBinary)(packet,encodedPacket=>{const payloadLength=encodedPacket.length;let header;if(payloadLength<126){header=new Uint8Array(1);new DataView(header.buffer).setUint8(0,payloadLength)}else if(payloadLength<65536){header=new Uint8Array(3);const view=new DataView(header.buffer);view.setUint8(0,126);view.setUint16(1,payloadLength)}else{header=new Uint8Array(9);const view=new DataView(header.buffer);view.setUint8(0,127);view.setBigUint64(1,BigInt(payloadLength))}if(packet.data&&typeof packet.data!=="string"){header[0]|=128}controller.enqueue(header);controller.enqueue(encodedPacket)})}})}let TEXT_DECODER;function totalLength(chunks){return chunks.reduce((acc,chunk)=>acc+chunk.length,0)}function concatChunks(chunks,size){if(chunks[0].length===size){return chunks.shift()}const buffer=new Uint8Array(size);let j=0;for(let i=0;i<size;i++){buffer[i]=chunks[0][j++];if(j===chunks[0].length){chunks.shift();j=0}}if(chunks.length&&j<chunks[0].length){chunks[0]=chunks[0].slice(j)}return buffer}function createPacketDecoderStream(maxPayload,binaryType){if(!TEXT_DECODER){TEXT_DECODER=new TextDecoder}const chunks=[];let state=0;let expectedLength=-1;let isBinary=false;return new TransformStream({transform(chunk,controller){chunks.push(chunk);while(true){if(state===0){if(totalLength(chunks)<1){break}const header=concatChunks(chunks,1);isBinary=(header[0]&128)===128;expectedLength=header[0]&127;if(expectedLength<126){state=3}else if(expectedLength===126){state=1}else{state=2}}else if(state===1){if(totalLength(chunks)<2){break}const headerArray=concatChunks(chunks,2);expectedLength=new DataView(headerArray.buffer,headerArray.byteOffset,headerArray.length).getUint16(0);state=3}else if(state===2){if(totalLength(chunks)<8){break}const headerArray=concatChunks(chunks,8);const view=new DataView(headerArray.buffer,headerArray.byteOffset,headerArray.length);const n=view.getUint32(0);if(n>Math.pow(2,53-32)-1){controller.enqueue(commons_js_1.ERROR_PACKET);break}expectedLength=n*Math.pow(2,32)+view.getUint32(4);state=3}else{if(totalLength(chunks)<expectedLength){break}const data=concatChunks(chunks,expectedLength);controller.enqueue((0,decodePacket_js_1.decodePacket)(isBinary?data:TEXT_DECODER.decode(data),binaryType));state=0}if(expectedLength===0||expectedLength>maxPayload){controller.enqueue(commons_js_1.ERROR_PACKET);break}}}})}exports.protocol=4},{"./commons.js":109,"./decodePacket.js":110,"./encodePacket.js":111}],113:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.protocol=exports.Transport=exports.Socket=exports.uServer=exports.parser=exports.transports=exports.Server=void 0;exports.listen=listen;exports.attach=attach;const http_1=require("http");const server_1=require("./server");Object.defineProperty(exports,"Server",{enumerable:true,get:function(){return server_1.Server}});const index_1=require("./transports/index");exports.transports=index_1.default;const parser=require("engine.io-parser");exports.parser=parser;var userver_1=require("./userver");Object.defineProperty(exports,"uServer",{enumerable:true,get:function(){return userver_1.uServer}});var socket_1=require("./socket");Object.defineProperty(exports,"Socket",{enumerable:true,get:function(){return socket_1.Socket}});var transport_1=require("./transport");Object.defineProperty(exports,"Transport",{enumerable:true,get:function(){return transport_1.Transport}});exports.protocol=parser.protocol;function listen(port,options,fn){if("function"===typeof options){fn=options;options={}}const server=(0,http_1.createServer)(function(req,res){res.writeHead(501);res.end("Not Implemented")});const engine=attach(server,options);engine.httpServer=server;server.listen(port,fn);return engine}function attach(server,options){const engine=new server_1.Server(options);engine.attach(server,options);return engine}},{"./server":116,"./socket":117,"./transport":118,"./transports/index":122,"./userver":127,"engine.io-parser":112,http:undefined}],114:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.packets=exports.protocol=void 0;exports.encodePacket=encodePacket;exports.encodeBase64Packet=encodeBase64Packet;exports.decodePacket=decodePacket;exports.decodeBase64Packet=decodeBase64Packet;exports.encodePayload=encodePayload;exports.decodePayload=decodePayload;exports.encodePayloadAsBinary=encodePayloadAsBinary;exports.decodePayloadAsBinary=decodePayloadAsBinary;var utf8=require("./utf8");exports.protocol=3;const hasBinary=packets=>{for(const packet of packets){if(packet.data instanceof ArrayBuffer||ArrayBuffer.isView(packet.data)){return true}}return false};exports.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6};var packetslist=Object.keys(exports.packets);var err={type:"error",data:"parser error"};const EMPTY_BUFFER=Buffer.concat([]);function encodePacket(packet,supportsBinary,utf8encode,callback){if(typeof supportsBinary==="function"){callback=supportsBinary;supportsBinary=null}if(typeof utf8encode==="function"){callback=utf8encode;utf8encode=null}if(Buffer.isBuffer(packet.data)){return encodeBuffer(packet,supportsBinary,callback)}else if(packet.data&&(packet.data.buffer||packet.data)instanceof ArrayBuffer){return encodeBuffer({type:packet.type,data:arrayBufferToBuffer(packet.data)},supportsBinary,callback)}var encoded=exports.packets[packet.type];if(undefined!==packet.data){encoded+=utf8encode?utf8.encode(String(packet.data),{strict:false}):String(packet.data)}return callback(""+encoded)}function encodeBuffer(packet,supportsBinary,callback){if(!supportsBinary){return encodeBase64Packet(packet,callback)}var data=packet.data;var typeBuffer=Buffer.allocUnsafe(1);typeBuffer[0]=exports.packets[packet.type];return callback(Buffer.concat([typeBuffer,data]))}function encodeBase64Packet(packet,callback){var data=Buffer.isBuffer(packet.data)?packet.data:arrayBufferToBuffer(packet.data);var message="b"+exports.packets[packet.type];message+=data.toString("base64");return callback(message)}function decodePacket(data,binaryType,utf8decode){if(data===undefined){return err}var type;if(typeof data==="string"){type=data.charAt(0);if(type==="b"){return decodeBase64Packet(data.slice(1),binaryType)}if(utf8decode){data=tryDecode(data);if(data===false){return err}}if(Number(type)!=type||!packetslist[type]){return err}if(data.length>1){return{type:packetslist[type],data:data.slice(1)}}else{return{type:packetslist[type]}}}if(binaryType==="arraybuffer"){var intArray=new Uint8Array(data);type=intArray[0];return{type:packetslist[type],data:intArray.buffer.slice(1)}}if(data instanceof ArrayBuffer){data=arrayBufferToBuffer(data)}type=data[0];return{type:packetslist[type],data:data.slice(1)}}function tryDecode(data){try{data=utf8.decode(data,{strict:false})}catch(e){return false}return data}function decodeBase64Packet(msg,binaryType){var type=packetslist[msg.charAt(0)];var data=Buffer.from(msg.slice(1),"base64");if(binaryType==="arraybuffer"){var abv=new Uint8Array(data.length);for(var i=0;i<abv.length;i++){abv[i]=data[i]}data=abv.buffer}return{type:type,data:data}}function encodePayload(packets,supportsBinary,callback){if(typeof supportsBinary==="function"){callback=supportsBinary;supportsBinary=null}if(supportsBinary&&hasBinary(packets)){return encodePayloadAsBinary(packets,callback)}if(!packets.length){return callback("0:")}function encodeOne(packet,doneCallback){encodePacket(packet,supportsBinary,false,function(message){doneCallback(null,setLengthHeader(message))})}map(packets,encodeOne,function(err,results){return callback(results.join(""))})}function setLengthHeader(message){return message.length+":"+message}function map(ary,each,done){const results=new Array(ary.length);let count=0;for(let i=0;i<ary.length;i++){each(ary[i],(error,msg)=>{results[i]=msg;if(++count===ary.length){done(null,results)}})}}function decodePayload(data,binaryType,callback){if(typeof data!=="string"){return decodePayloadAsBinary(data,binaryType,callback)}if(typeof binaryType==="function"){callback=binaryType;binaryType=null}if(data===""){return callback(err,0,1)}var length="",n,msg,packet;for(var i=0,l=data.length;i<l;i++){var chr=data.charAt(i);if(chr!==":"){length+=chr;continue}if(length===""||length!=(n=Number(length))){return callback(err,0,1)}msg=data.slice(i+1,i+1+n);if(length!=msg.length){return callback(err,0,1)}if(msg.length){packet=decodePacket(msg,binaryType,false);if(err.type===packet.type&&err.data===packet.data){return callback(err,0,1)}var more=callback(packet,i+n,l);if(false===more)return}i+=n;length=""}if(length!==""){return callback(err,0,1)}}function bufferToString(buffer){var str="";for(var i=0,l=buffer.length;i<l;i++){str+=String.fromCharCode(buffer[i])}return str}function stringToBuffer(string){var buf=Buffer.allocUnsafe(string.length);for(var i=0,l=string.length;i<l;i++){buf.writeUInt8(string.charCodeAt(i),i)}return buf}function arrayBufferToBuffer(data){var length=data.byteLength||data.length;var offset=data.byteOffset||0;return Buffer.from(data.buffer||data,offset,length)}function encodePayloadAsBinary(packets,callback){if(!packets.length){return callback(EMPTY_BUFFER)}map(packets,encodeOneBinaryPacket,function(err,results){return callback(Buffer.concat(results))})}function encodeOneBinaryPacket(p,doneCallback){function onBinaryPacketEncode(packet){var encodingLength=""+packet.length;var sizeBuffer;if(typeof packet==="string"){sizeBuffer=Buffer.allocUnsafe(encodingLength.length+2);sizeBuffer[0]=0;for(var i=0;i<encodingLength.length;i++){sizeBuffer[i+1]=parseInt(encodingLength[i],10)}sizeBuffer[sizeBuffer.length-1]=255;return doneCallback(null,Buffer.concat([sizeBuffer,stringToBuffer(packet)]))}sizeBuffer=Buffer.allocUnsafe(encodingLength.length+2);sizeBuffer[0]=1;for(var i=0;i<encodingLength.length;i++){sizeBuffer[i+1]=parseInt(encodingLength[i],10)}sizeBuffer[sizeBuffer.length-1]=255;doneCallback(null,Buffer.concat([sizeBuffer,packet]))}encodePacket(p,true,true,onBinaryPacketEncode)}function decodePayloadAsBinary(data,binaryType,callback){if(typeof binaryType==="function"){callback=binaryType;binaryType=null}var bufferTail=data;var buffers=[];var i;while(bufferTail.length>0){var strLen="";var isString=bufferTail[0]===0;for(i=1;;i++){if(bufferTail[i]===255)break;if(strLen.length>310){return callback(err,0,1)}strLen+=""+bufferTail[i]}bufferTail=bufferTail.slice(strLen.length+1);var msgLength=parseInt(strLen,10);var msg=bufferTail.slice(1,msgLength+1);if(isString)msg=bufferToString(msg);buffers.push(msg);bufferTail=bufferTail.slice(msgLength+1)}var total=buffers.length;for(i=0;i<total;i++){var buffer=buffers[i];callback(decodePacket(buffer,binaryType,true),i,total)}}},{"./utf8":115}],115:[function(require,module,exports){
/*! https://mths.be/utf8js v2.1.2 by @mathias */
var stringFromCharCode=String.fromCharCode;function ucs2decode(string){var output=[];var counter=0;var length=string.length;var value;var extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){extra=string.charCodeAt(counter++);if((extra&64512)==56320){output.push(((value&1023)<<10)+(extra&1023)+65536)}else{output.push(value);counter--}}else{output.push(value)}}return output}function ucs2encode(array){var length=array.length;var index=-1;var value;var output="";while(++index<length){value=array[index];if(value>65535){value-=65536;output+=stringFromCharCode(value>>>10&1023|55296);value=56320|value&1023}output+=stringFromCharCode(value)}return output}function checkScalarValue(codePoint,strict){if(codePoint>=55296&&codePoint<=57343){if(strict){throw Error("Lone surrogate U+"+codePoint.toString(16).toUpperCase()+" is not a scalar value")}return false}return true}function createByte(codePoint,shift){return stringFromCharCode(codePoint>>shift&63|128)}function encodeCodePoint(codePoint,strict){if((codePoint&4294967168)==0){return stringFromCharCode(codePoint)}var symbol="";if((codePoint&4294965248)==0){symbol=stringFromCharCode(codePoint>>6&31|192)}else if((codePoint&4294901760)==0){if(!checkScalarValue(codePoint,strict)){codePoint=65533}symbol=stringFromCharCode(codePoint>>12&15|224);symbol+=createByte(codePoint,6)}else if((codePoint&4292870144)==0){symbol=stringFromCharCode(codePoint>>18&7|240);symbol+=createByte(codePoint,12);symbol+=createByte(codePoint,6)}symbol+=stringFromCharCode(codePoint&63|128);return symbol}function utf8encode(string,opts){opts=opts||{};var strict=false!==opts.strict;var codePoints=ucs2decode(string);var length=codePoints.length;var index=-1;var codePoint;var byteString="";while(++index<length){codePoint=codePoints[index];byteString+=encodeCodePoint(codePoint,strict)}return byteString}function readContinuationByte(){if(byteIndex>=byteCount){throw Error("Invalid byte index")}var continuationByte=byteArray[byteIndex]&255;byteIndex++;if((continuationByte&192)==128){return continuationByte&63}throw Error("Invalid continuation byte")}function decodeSymbol(strict){var byte1;var byte2;var byte3;var byte4;var codePoint;if(byteIndex>byteCount){throw Error("Invalid byte index")}if(byteIndex==byteCount){return false}byte1=byteArray[byteIndex]&255;byteIndex++;if((byte1&128)==0){return byte1}if((byte1&224)==192){byte2=readContinuationByte();codePoint=(byte1&31)<<6|byte2;if(codePoint>=128){return codePoint}else{throw Error("Invalid continuation byte")}}if((byte1&240)==224){byte2=readContinuationByte();byte3=readContinuationByte();codePoint=(byte1&15)<<12|byte2<<6|byte3;if(codePoint>=2048){return checkScalarValue(codePoint,strict)?codePoint:65533}else{throw Error("Invalid continuation byte")}}if((byte1&248)==240){byte2=readContinuationByte();byte3=readContinuationByte();byte4=readContinuationByte();codePoint=(byte1&7)<<18|byte2<<12|byte3<<6|byte4;if(codePoint>=65536&&codePoint<=1114111){return codePoint}}throw Error("Invalid UTF-8 detected")}var byteArray;var byteCount;var byteIndex;function utf8decode(byteString,opts){opts=opts||{};var strict=false!==opts.strict;byteArray=ucs2decode(byteString);byteCount=byteArray.length;byteIndex=0;var codePoints=[];var tmp;while((tmp=decodeSymbol(strict))!==false){codePoints.push(tmp)}return ucs2encode(codePoints)}module.exports={version:"2.1.2",encode:utf8encode,decode:utf8decode}},{}],116:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Server=exports.BaseServer=void 0;const qs=require("querystring");const url_1=require("url");const base64id=require("base64id");const transports_1=require("./transports");const events_1=require("events");const socket_1=require("./socket");const debug_1=require("debug");const cookie_1=require("cookie");const ws_1=require("ws");const webtransport_1=require("./transports/webtransport");const engine_io_parser_1=require("engine.io-parser");const debug=(0,debug_1.default)("engine");const kResponseHeaders=Symbol("responseHeaders");function parseSessionId(data){try{const parsed=JSON.parse(data);if(typeof parsed.sid==="string"){return parsed.sid}}catch(e){}}class BaseServer extends events_1.EventEmitter{constructor(opts={}){super();this.middlewares=[];this.clients={};this.clientsCount=0;this.opts=Object.assign({wsEngine:ws_1.Server,pingTimeout:2e4,pingInterval:25e3,upgradeTimeout:1e4,maxHttpBufferSize:1e6,transports:["polling","websocket"],allowUpgrades:true,httpCompression:{threshold:1024},cors:false,allowEIO3:false},opts);if(opts.cookie){this.opts.cookie=Object.assign({name:"io",path:"/",httpOnly:opts.cookie.path!==false,sameSite:"lax"},opts.cookie)}if(this.opts.cors){this.use(require("cors")(this.opts.cors))}if(opts.perMessageDeflate){this.opts.perMessageDeflate=Object.assign({threshold:1024},opts.perMessageDeflate)}this.init()}_computePath(options){let path=(options.path||"/engine.io").replace(/\/$/,"");if(options.addTrailingSlash!==false){path+="/"}return path}upgrades(transport){if(!this.opts.allowUpgrades)return[];return transports_1.default[transport].upgradesTo||[]}verify(req,upgrade,fn){const transport=req._query.transport;if(!~this.opts.transports.indexOf(transport)||transport==="webtransport"){debug('unknown transport "%s"',transport);return fn(Server.errors.UNKNOWN_TRANSPORT,{transport:transport})}const isOriginInvalid=checkInvalidHeaderChar(req.headers.origin);if(isOriginInvalid){const origin=req.headers.origin;req.headers.origin=null;debug("origin header invalid");return fn(Server.errors.BAD_REQUEST,{name:"INVALID_ORIGIN",origin:origin})}const sid=req._query.sid;if(sid){if(!this.clients.hasOwnProperty(sid)){debug('unknown sid "%s"',sid);return fn(Server.errors.UNKNOWN_SID,{sid:sid})}const previousTransport=this.clients[sid].transport.name;if(!upgrade&&previousTransport!==transport){debug("bad request: unexpected transport without upgrade");return fn(Server.errors.BAD_REQUEST,{name:"TRANSPORT_MISMATCH",transport:transport,previousTransport:previousTransport})}}else{if("GET"!==req.method){return fn(Server.errors.BAD_HANDSHAKE_METHOD,{method:req.method})}if(transport==="websocket"&&!upgrade){debug("invalid transport upgrade");return fn(Server.errors.BAD_REQUEST,{name:"TRANSPORT_HANDSHAKE_ERROR"})}if(!this.opts.allowRequest)return fn();return this.opts.allowRequest(req,(message,success)=>{if(!success){return fn(Server.errors.FORBIDDEN,{message:message})}fn()})}fn()}use(fn){this.middlewares.push(fn)}_applyMiddlewares(req,res,callback){if(this.middlewares.length===0){debug("no middleware to apply, skipping");return callback()}const apply=i=>{debug("applying middleware n%d",i+1);this.middlewares[i](req,res,err=>{if(err){return callback(err)}if(i+1<this.middlewares.length){apply(i+1)}else{callback()}})};apply(0)}close(){debug("closing all open clients");for(let i in this.clients){if(this.clients.hasOwnProperty(i)){this.clients[i].close(true)}}this.cleanup();return this}generateId(req){return base64id.generateId()}async handshake(transportName,req,closeConnection){const protocol=req._query.EIO==="4"?4:3;if(protocol===3&&!this.opts.allowEIO3){debug("unsupported protocol version");this.emit("connection_error",{req:req,code:Server.errors.UNSUPPORTED_PROTOCOL_VERSION,message:Server.errorMessages[Server.errors.UNSUPPORTED_PROTOCOL_VERSION],context:{protocol:protocol}});closeConnection(Server.errors.UNSUPPORTED_PROTOCOL_VERSION);return}let id;try{id=await this.generateId(req)}catch(e){debug("error while generating an id");this.emit("connection_error",{req:req,code:Server.errors.BAD_REQUEST,message:Server.errorMessages[Server.errors.BAD_REQUEST],context:{name:"ID_GENERATION_ERROR",error:e}});closeConnection(Server.errors.BAD_REQUEST);return}debug('handshaking client "%s"',id);try{var transport=this.createTransport(transportName,req);if("polling"===transportName){transport.maxHttpBufferSize=this.opts.maxHttpBufferSize;transport.httpCompression=this.opts.httpCompression}else if("websocket"===transportName){transport.perMessageDeflate=this.opts.perMessageDeflate}}catch(e){debug('error handshaking to transport "%s"',transportName);this.emit("connection_error",{req:req,code:Server.errors.BAD_REQUEST,message:Server.errorMessages[Server.errors.BAD_REQUEST],context:{name:"TRANSPORT_HANDSHAKE_ERROR",error:e}});closeConnection(Server.errors.BAD_REQUEST);return}const socket=new socket_1.Socket(id,this,transport,req,protocol);transport.on("headers",(headers,req)=>{const isInitialRequest=!req._query.sid;if(isInitialRequest){if(this.opts.cookie){headers["Set-Cookie"]=[(0,cookie_1.serialize)(this.opts.cookie.name,id,this.opts.cookie)]}this.emit("initial_headers",headers,req)}this.emit("headers",headers,req)});transport.onRequest(req);this.clients[id]=socket;this.clientsCount++;socket.once("close",()=>{delete this.clients[id];this.clientsCount--});this.emit("connection",socket);return transport}async onWebTransportSession(session){const timeout=setTimeout(()=>{debug("the client failed to establish a bidirectional stream in the given period");session.close()},this.opts.upgradeTimeout);const streamReader=session.incomingBidirectionalStreams.getReader();const result=await streamReader.read();if(result.done){debug("session is closed");return}const stream=result.value;const transformStream=(0,engine_io_parser_1.createPacketDecoderStream)(this.opts.maxHttpBufferSize,"nodebuffer");const reader=stream.readable.pipeThrough(transformStream).getReader();const{value:value,done:done}=await reader.read();if(done){debug("stream is closed");return}clearTimeout(timeout);if(value.type!=="open"){debug("invalid WebTransport handshake");return session.close()}if(value.data===undefined){const transport=new webtransport_1.WebTransport(session,stream,reader);const id=base64id.generateId();debug('handshaking client "%s" (WebTransport)',id);const socket=new socket_1.Socket(id,this,transport,null,4);this.clients[id]=socket;this.clientsCount++;socket.once("close",()=>{delete this.clients[id];this.clientsCount--});this.emit("connection",socket);return}const sid=parseSessionId(value.data);if(!sid){debug("invalid WebTransport handshake");return session.close()}const client=this.clients[sid];if(!client){debug("upgrade attempt for closed client");session.close()}else if(client.upgrading){debug("transport has already been trying to upgrade");session.close()}else if(client.upgraded){debug("transport had already been upgraded");session.close()}else{debug("upgrading existing transport");const transport=new webtransport_1.WebTransport(session,stream,reader);client._maybeUpgrade(transport)}}}exports.BaseServer=BaseServer;BaseServer.errors={UNKNOWN_TRANSPORT:0,UNKNOWN_SID:1,BAD_HANDSHAKE_METHOD:2,BAD_REQUEST:3,FORBIDDEN:4,UNSUPPORTED_PROTOCOL_VERSION:5};BaseServer.errorMessages={0:"Transport unknown",1:"Session ID unknown",2:"Bad handshake method",3:"Bad request",4:"Forbidden",5:"Unsupported protocol version"};class WebSocketResponse{constructor(req,socket){this.req=req;this.socket=socket;req[kResponseHeaders]={}}setHeader(name,value){this.req[kResponseHeaders][name]=value}getHeader(name){return this.req[kResponseHeaders][name]}removeHeader(name){delete this.req[kResponseHeaders][name]}write(){}writeHead(){}end(){this.socket.destroy()}}class Server extends BaseServer{init(){if(!~this.opts.transports.indexOf("websocket"))return;if(this.ws)this.ws.close();this.ws=new this.opts.wsEngine({noServer:true,clientTracking:false,perMessageDeflate:this.opts.perMessageDeflate,maxPayload:this.opts.maxHttpBufferSize});if(typeof this.ws.on==="function"){this.ws.on("headers",(headersArray,req)=>{const additionalHeaders=req[kResponseHeaders]||{};delete req[kResponseHeaders];const isInitialRequest=!req._query.sid;if(isInitialRequest){this.emit("initial_headers",additionalHeaders,req)}this.emit("headers",additionalHeaders,req);debug("writing headers: %j",additionalHeaders);Object.keys(additionalHeaders).forEach(key=>{headersArray.push(`${key}: ${additionalHeaders[key]}`)})})}}cleanup(){if(this.ws){debug("closing webSocketServer");this.ws.close()}}prepare(req){if(!req._query){req._query=~req.url.indexOf("?")?qs.parse((0,url_1.parse)(req.url).query):{}}}createTransport(transportName,req){return new transports_1.default[transportName](req)}handleRequest(req,res){debug('handling "%s" http request "%s"',req.method,req.url);this.prepare(req);req.res=res;const callback=(errorCode,errorContext)=>{if(errorCode!==undefined){this.emit("connection_error",{req:req,code:errorCode,message:Server.errorMessages[errorCode],context:errorContext});abortRequest(res,errorCode,errorContext);return}if(req._query.sid){debug("setting new request for existing client");this.clients[req._query.sid].transport.onRequest(req)}else{const closeConnection=(errorCode,errorContext)=>abortRequest(res,errorCode,errorContext);this.handshake(req._query.transport,req,closeConnection)}};this._applyMiddlewares(req,res,err=>{if(err){callback(Server.errors.BAD_REQUEST,{name:"MIDDLEWARE_FAILURE"})}else{this.verify(req,false,callback)}})}handleUpgrade(req,socket,upgradeHead){this.prepare(req);const res=new WebSocketResponse(req,socket);const callback=(errorCode,errorContext)=>{if(errorCode!==undefined){this.emit("connection_error",{req:req,code:errorCode,message:Server.errorMessages[errorCode],context:errorContext});abortUpgrade(socket,errorCode,errorContext);return}const head=Buffer.from(upgradeHead);upgradeHead=null;res.writeHead();this.ws.handleUpgrade(req,socket,head,websocket=>{this.onWebSocket(req,socket,websocket)})};this._applyMiddlewares(req,res,err=>{if(err){callback(Server.errors.BAD_REQUEST,{name:"MIDDLEWARE_FAILURE"})}else{this.verify(req,true,callback)}})}onWebSocket(req,socket,websocket){websocket.on("error",onUpgradeError);if(transports_1.default[req._query.transport]!==undefined&&!transports_1.default[req._query.transport].prototype.handlesUpgrades){debug("transport doesnt handle upgraded requests");websocket.close();return}const id=req._query.sid;req.websocket=websocket;if(id){const client=this.clients[id];if(!client){debug("upgrade attempt for closed client");websocket.close()}else if(client.upgrading){debug("transport has already been trying to upgrade");websocket.close()}else if(client.upgraded){debug("transport had already been upgraded");websocket.close()}else{debug("upgrading existing transport");websocket.removeListener("error",onUpgradeError);const transport=this.createTransport(req._query.transport,req);transport.perMessageDeflate=this.opts.perMessageDeflate;client._maybeUpgrade(transport)}}else{const closeConnection=(errorCode,errorContext)=>abortUpgrade(socket,errorCode,errorContext);this.handshake(req._query.transport,req,closeConnection)}function onUpgradeError(){debug("websocket error before upgrade")}}attach(server,options={}){const path=this._computePath(options);const destroyUpgradeTimeout=options.destroyUpgradeTimeout||1e3;function check(req){return path===req.url.slice(0,path.length)}const listeners=server.listeners("request").slice(0);server.removeAllListeners("request");server.on("close",this.close.bind(this));server.on("listening",this.init.bind(this));server.on("request",(req,res)=>{if(check(req)){debug('intercepting request for path "%s"',path);this.handleRequest(req,res)}else{let i=0;const l=listeners.length;for(;i<l;i++){listeners[i].call(server,req,res)}}});if(~this.opts.transports.indexOf("websocket")){server.on("upgrade",(req,socket,head)=>{if(check(req)){this.handleUpgrade(req,socket,head)}else if(false!==options.destroyUpgrade){setTimeout(function(){if(socket.writable&&socket.bytesWritten<=0){socket.on("error",e=>{debug("error while destroying upgrade: %s",e.message)});return socket.end()}},destroyUpgradeTimeout)}})}}}exports.Server=Server;function abortRequest(res,errorCode,errorContext){const statusCode=errorCode===Server.errors.FORBIDDEN?403:400;const message=errorContext&&errorContext.message?errorContext.message:Server.errorMessages[errorCode];res.writeHead(statusCode,{"Content-Type":"application/json"});res.end(JSON.stringify({code:errorCode,message:message}))}function abortUpgrade(socket,errorCode,errorContext={}){socket.on("error",()=>{debug("ignoring error from closed connection")});if(socket.writable){const message=errorContext.message||Server.errorMessages[errorCode];const length=Buffer.byteLength(message);socket.write("HTTP/1.1 400 Bad Request\r\n"+"Connection: close\r\n"+"Content-type: text/html\r\n"+"Content-Length: "+length+"\r\n"+"\r\n"+message)}socket.destroy()}const validHdrChars=[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];function checkInvalidHeaderChar(val){val+="";if(val.length<1)return false;if(!validHdrChars[val.charCodeAt(0)]){debug('invalid header, index 0, char "%s"',val.charCodeAt(0));return true}if(val.length<2)return false;if(!validHdrChars[val.charCodeAt(1)]){debug('invalid header, index 1, char "%s"',val.charCodeAt(1));return true}if(val.length<3)return false;if(!validHdrChars[val.charCodeAt(2)]){debug('invalid header, index 2, char "%s"',val.charCodeAt(2));return true}if(val.length<4)return false;if(!validHdrChars[val.charCodeAt(3)]){debug('invalid header, index 3, char "%s"',val.charCodeAt(3));return true}for(let i=4;i<val.length;++i){if(!validHdrChars[val.charCodeAt(i)]){debug('invalid header, index "%i", char "%s"',i,val.charCodeAt(i));return true}}return false}},{"./socket":117,"./transports":122,"./transports/webtransport":126,base64id:77,cookie:128,cors:85,debug:131,"engine.io-parser":112,events:undefined,querystring:undefined,url:undefined,ws:317}],117:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Socket=void 0;const events_1=require("events");const debug_1=require("debug");const timers_1=require("timers");const debug=(0,debug_1.default)("engine:socket");class Socket extends events_1.EventEmitter{get readyState(){return this._readyState}set readyState(state){debug("readyState updated from %s to %s",this._readyState,state);this._readyState=state}constructor(id,server,transport,req,protocol){super();this._readyState="opening";this.upgrading=false;this.upgraded=false;this.writeBuffer=[];this.packetsFn=[];this.sentCallbackFn=[];this.cleanupFn=[];this.id=id;this.server=server;this.request=req;this.protocol=protocol;if(req){if(req.websocket&&req.websocket._socket){this.remoteAddress=req.websocket._socket.remoteAddress}else{this.remoteAddress=req.connection.remoteAddress}}else{}this.pingTimeoutTimer=null;this.pingIntervalTimer=null;this.setTransport(transport);this.onOpen()}onOpen(){this.readyState="open";this.transport.sid=this.id;this.sendPacket("open",JSON.stringify({sid:this.id,upgrades:this.getAvailableUpgrades(),pingInterval:this.server.opts.pingInterval,pingTimeout:this.server.opts.pingTimeout,maxPayload:this.server.opts.maxHttpBufferSize}));if(this.server.opts.initialPacket){this.sendPacket("message",this.server.opts.initialPacket)}this.emit("open");if(this.protocol===3){this.resetPingTimeout()}else{this.schedulePing()}}onPacket(packet){if("open"!==this.readyState){return debug("packet received with closed socket")}debug(`received packet ${packet.type}`);this.emit("packet",packet);switch(packet.type){case"ping":if(this.transport.protocol!==3){this.onError(new Error("invalid heartbeat direction"));return}debug("got ping");this.pingTimeoutTimer.refresh();this.sendPacket("pong");this.emit("heartbeat");break;case"pong":if(this.transport.protocol===3){this.onError(new Error("invalid heartbeat direction"));return}debug("got pong");(0,timers_1.clearTimeout)(this.pingTimeoutTimer);this.pingIntervalTimer.refresh();this.emit("heartbeat");break;case"error":this.onClose("parse error");break;case"message":this.emit("data",packet.data);this.emit("message",packet.data);break}}onError(err){debug("transport error");this.onClose("transport error",err)}schedulePing(){this.pingIntervalTimer=(0,timers_1.setTimeout)(()=>{debug("writing ping packet - expecting pong within %sms",this.server.opts.pingTimeout);this.sendPacket("ping");this.resetPingTimeout()},this.server.opts.pingInterval)}resetPingTimeout(){(0,timers_1.clearTimeout)(this.pingTimeoutTimer);this.pingTimeoutTimer=(0,timers_1.setTimeout)(()=>{if(this.readyState==="closed")return;this.onClose("ping timeout")},this.protocol===3?this.server.opts.pingInterval+this.server.opts.pingTimeout:this.server.opts.pingTimeout)}setTransport(transport){const onError=this.onError.bind(this);const onReady=()=>this.flush();const onPacket=this.onPacket.bind(this);const onDrain=this.onDrain.bind(this);const onClose=this.onClose.bind(this,"transport close");this.transport=transport;this.transport.once("error",onError);this.transport.on("ready",onReady);this.transport.on("packet",onPacket);this.transport.on("drain",onDrain);this.transport.once("close",onClose);this.cleanupFn.push(function(){transport.removeListener("error",onError);transport.removeListener("ready",onReady);transport.removeListener("packet",onPacket);transport.removeListener("drain",onDrain);transport.removeListener("close",onClose)})}onDrain(){if(this.sentCallbackFn.length>0){debug("executing batch send callback");const seqFn=this.sentCallbackFn.shift();if(seqFn){for(let i=0;i<seqFn.length;i++){seqFn[i](this.transport)}}}}_maybeUpgrade(transport){debug('might upgrade socket transport from "%s" to "%s"',this.transport.name,transport.name);this.upgrading=true;const upgradeTimeoutTimer=(0,timers_1.setTimeout)(()=>{debug("client did not complete upgrade - closing transport");cleanup();if("open"===transport.readyState){transport.close()}},this.server.opts.upgradeTimeout);let checkIntervalTimer;const onPacket=packet=>{if("ping"===packet.type&&"probe"===packet.data){debug("got probe ping packet, sending pong");transport.send([{type:"pong",data:"probe"}]);this.emit("upgrading",transport);clearInterval(checkIntervalTimer);checkIntervalTimer=setInterval(check,100)}else if("upgrade"===packet.type&&this.readyState!=="closed"){debug("got upgrade packet - upgrading");cleanup();this.transport.discard();this.upgraded=true;this.clearTransport();this.setTransport(transport);this.emit("upgrade",transport);this.flush();if(this.readyState==="closing"){transport.close(()=>{this.onClose("forced close")})}}else{cleanup();transport.close()}};const check=()=>{if("polling"===this.transport.name&&this.transport.writable){debug("writing a noop packet to polling for fast upgrade");this.transport.send([{type:"noop"}])}};const cleanup=()=>{this.upgrading=false;clearInterval(checkIntervalTimer);(0,timers_1.clearTimeout)(upgradeTimeoutTimer);transport.removeListener("packet",onPacket);transport.removeListener("close",onTransportClose);transport.removeListener("error",onError);this.removeListener("close",onClose)};const onError=err=>{debug("client did not complete upgrade - %s",err);cleanup();transport.close();transport=null};const onTransportClose=()=>{onError("transport closed")};const onClose=()=>{onError("socket closed")};transport.on("packet",onPacket);transport.once("close",onTransportClose);transport.once("error",onError);this.once("close",onClose)}clearTransport(){let cleanup;const toCleanUp=this.cleanupFn.length;for(let i=0;i<toCleanUp;i++){cleanup=this.cleanupFn.shift();cleanup()}this.transport.on("error",function(){debug("error triggered by discarded transport")});this.transport.close();(0,timers_1.clearTimeout)(this.pingTimeoutTimer)}onClose(reason,description){if("closed"!==this.readyState){this.readyState="closed";(0,timers_1.clearTimeout)(this.pingIntervalTimer);(0,timers_1.clearTimeout)(this.pingTimeoutTimer);process.nextTick(()=>{this.writeBuffer=[]});this.packetsFn=[];this.sentCallbackFn=[];this.clearTransport();this.emit("close",reason,description)}}send(data,options,callback){this.sendPacket("message",data,options,callback);return this}write(data,options,callback){this.sendPacket("message",data,options,callback);return this}sendPacket(type,data,options={},callback){if("function"===typeof options){callback=options;options={}}if("closing"!==this.readyState&&"closed"!==this.readyState){debug('sending packet "%s" (%s)',type,data);options.compress=options.compress!==false;const packet={type:type,options:options};if(data)packet.data=data;this.emit("packetCreate",packet);this.writeBuffer.push(packet);if("function"===typeof callback)this.packetsFn.push(callback);this.flush()}}flush(){if("closed"!==this.readyState&&this.transport.writable&&this.writeBuffer.length){debug("flushing buffer to transport");this.emit("flush",this.writeBuffer);this.server.emit("flush",this,this.writeBuffer);const wbuf=this.writeBuffer;this.writeBuffer=[];if(this.packetsFn.length){this.sentCallbackFn.push(this.packetsFn);this.packetsFn=[]}else{this.sentCallbackFn.push(null)}this.transport.send(wbuf);this.emit("drain");this.server.emit("drain",this)}}getAvailableUpgrades(){const availableUpgrades=[];const allUpgrades=this.server.upgrades(this.transport.name);for(let i=0;i<allUpgrades.length;++i){const upg=allUpgrades[i];if(this.server.opts.transports.indexOf(upg)!==-1){availableUpgrades.push(upg)}}return availableUpgrades}close(discard){if(discard&&(this.readyState==="open"||this.readyState==="closing")){return this.closeTransport(discard)}if("open"!==this.readyState)return;this.readyState="closing";if(this.writeBuffer.length){debug("there are %d remaining packets in the buffer, waiting for the 'drain' event",this.writeBuffer.length);this.once("drain",()=>{debug("all packets have been sent, closing the transport");this.closeTransport(discard)});return}debug("the buffer is empty, closing the transport right away");this.closeTransport(discard)}closeTransport(discard){debug("closing the transport (discard? %s)",!!discard);if(discard)this.transport.discard();this.transport.close(this.onClose.bind(this,"forced close"))}}exports.Socket=Socket},{debug:131,events:undefined,timers:undefined}],118:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Transport=void 0;const events_1=require("events");const parser_v4=require("engine.io-parser");const parser_v3=require("./parser-v3/index");const debug_1=require("debug");const debug=(0,debug_1.default)("engine:transport");function noop(){}class Transport extends events_1.EventEmitter{get readyState(){return this._readyState}set readyState(state){debug("readyState updated from %s to %s (%s)",this._readyState,state,this.name);this._readyState=state}constructor(req){super();this.writable=false;this._readyState="open";this.discarded=false;this.protocol=req._query.EIO==="4"?4:3;this.parser=this.protocol===4?parser_v4:parser_v3;this.supportsBinary=!(req._query&&req._query.b64)}discard(){this.discarded=true}onRequest(req){}close(fn){if("closed"===this.readyState||"closing"===this.readyState)return;this.readyState="closing";this.doClose(fn||noop)}onError(msg,desc){if(this.listeners("error").length){const err=new Error(msg);err.type="TransportError";err.description=desc;this.emit("error",err)}else{debug("ignored transport error %s (%s)",msg,desc)}}onPacket(packet){this.emit("packet",packet)}onData(data){this.onPacket(this.parser.decodePacket(data))}onClose(){this.readyState="closed";this.emit("close")}}exports.Transport=Transport},{"./parser-v3/index":114,debug:131,"engine.io-parser":112,events:undefined}],119:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const polling_1=require("./polling");const websocket_1=require("./websocket");exports.default={polling:polling_1.Polling,websocket:websocket_1.WebSocket}},{"./polling":120,"./websocket":121}],120:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Polling=void 0;const transport_1=require("../transport");const zlib_1=require("zlib");const accepts=require("accepts");const debug_1=require("debug");const debug=(0,debug_1.default)("engine:polling");const compressionMethods={gzip:zlib_1.createGzip,deflate:zlib_1.createDeflate};class Polling extends transport_1.Transport{constructor(req){super(req);this.closeTimeout=30*1e3}get name(){return"polling"}onRequest(req){const res=req.res;req.res=null;if(req.getMethod()==="get"){this.onPollRequest(req,res)}else if(req.getMethod()==="post"){this.onDataRequest(req,res)}else{res.writeStatus("500 Internal Server Error");res.end()}}onPollRequest(req,res){if(this.req){debug("request overlap");this.onError("overlap from client");res.writeStatus("500 Internal Server Error");res.end();return}debug("setting request");this.req=req;this.res=res;const onClose=()=>{this.writable=false;this.onError("poll connection closed prematurely")};const cleanup=()=>{this.req=this.res=null};req.cleanup=cleanup;res.onAborted(onClose);this.writable=true;this.emit("ready");if(this.writable&&this.shouldClose){debug("triggering empty send to append close packet");this.send([{type:"noop"}])}}onDataRequest(req,res){if(this.dataReq){this.onError("data request overlap from client");res.writeStatus("500 Internal Server Error");res.end();return}const expectedContentLength=Number(req.headers["content-length"]);if(!expectedContentLength){this.onError("content-length header required");res.writeStatus("411 Length Required").end();return}if(expectedContentLength>this.maxHttpBufferSize){this.onError("payload too large");res.writeStatus("413 Payload Too Large").end();return}const isBinary="application/octet-stream"===req.headers["content-type"];if(isBinary&&this.protocol===4){return this.onError("invalid content")}this.dataReq=req;this.dataRes=res;let buffer;let offset=0;const headers={"Content-Type":"text/html"};this.headers(req,headers);for(let key in headers){res.writeHeader(key,String(headers[key]))}const onEnd=buffer=>{this.onData(buffer.toString());this.onDataRequestCleanup();res.cork(()=>{res.end("ok")})};res.onAborted(()=>{this.onDataRequestCleanup();this.onError("data request connection closed prematurely")});res.onData((arrayBuffer,isLast)=>{const totalLength=offset+arrayBuffer.byteLength;if(totalLength>expectedContentLength){this.onError("content-length mismatch");res.close();return}if(!buffer){if(isLast){onEnd(Buffer.from(arrayBuffer));return}buffer=Buffer.allocUnsafe(expectedContentLength)}Buffer.from(arrayBuffer).copy(buffer,offset);if(isLast){if(totalLength!=expectedContentLength){this.onError("content-length mismatch");res.writeStatus("400 Content-Length Mismatch").end();this.onDataRequestCleanup();return}onEnd(buffer);return}offset=totalLength})}onDataRequestCleanup(){this.dataReq=this.dataRes=null}onData(data){debug('received "%s"',data);const callback=packet=>{if("close"===packet.type){debug("got xhr close packet");this.onClose();return false}this.onPacket(packet)};if(this.protocol===3){this.parser.decodePayload(data,callback)}else{this.parser.decodePayload(data).forEach(callback)}}onClose(){if(this.writable){this.send([{type:"noop"}])}super.onClose()}send(packets){this.writable=false;if(this.shouldClose){debug("appending close packet to payload");packets.push({type:"close"});this.shouldClose();this.shouldClose=null}const doWrite=data=>{const compress=packets.some(packet=>packet.options&&packet.options.compress);this.write(data,{compress:compress})};if(this.protocol===3){this.parser.encodePayload(packets,this.supportsBinary,doWrite)}else{this.parser.encodePayload(packets,doWrite)}}write(data,options){debug('writing "%s"',data);this.doWrite(data,options,()=>{this.req.cleanup();this.emit("drain")})}doWrite(data,options,callback){const isString=typeof data==="string";const contentType=isString?"text/plain; charset=UTF-8":"application/octet-stream";const headers={"Content-Type":contentType};const respond=data=>{this.headers(this.req,headers);this.res.cork(()=>{Object.keys(headers).forEach(key=>{this.res.writeHeader(key,String(headers[key]))});this.res.end(data)});callback()};if(!this.httpCompression||!options.compress){respond(data);return}const len=isString?Buffer.byteLength(data):data.length;if(len<this.httpCompression.threshold){respond(data);return}const encoding=accepts(this.req).encodings(["gzip","deflate"]);if(!encoding){respond(data);return}this.compress(data,encoding,(err,data)=>{if(err){this.res.writeStatus("500 Internal Server Error");this.res.end();callback(err);return}headers["Content-Encoding"]=encoding;respond(data)})}compress(data,encoding,callback){debug("compressing");const buffers=[];let nread=0;compressionMethods[encoding](this.httpCompression).on("error",callback).on("data",function(chunk){buffers.push(chunk);nread+=chunk.length}).on("end",function(){callback(null,Buffer.concat(buffers,nread))}).end(data)}doClose(fn){debug("closing");let closeTimeoutTimer;const onClose=()=>{clearTimeout(closeTimeoutTimer);fn();this.onClose()};if(this.writable){debug("transport writable - closing right away");this.send([{type:"close"}]);onClose()}else if(this.discarded){debug("transport discarded - closing right away");onClose()}else{debug("transport not writable - buffering orderly close");this.shouldClose=onClose;closeTimeoutTimer=setTimeout(onClose,this.closeTimeout)}}headers(req,headers){headers=headers||{};const ua=req.headers["user-agent"];if(ua&&(~ua.indexOf(";MSIE")||~ua.indexOf("Trident/"))){headers["X-XSS-Protection"]="0"}headers["cache-control"]="no-store";this.emit("headers",headers,req);return headers}}exports.Polling=Polling},{"../transport":118,accepts:76,debug:131,zlib:undefined}],121:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.WebSocket=void 0;const transport_1=require("../transport");const debug_1=require("debug");const debug=(0,debug_1.default)("engine:ws");class WebSocket extends transport_1.Transport{constructor(req){super(req);this.writable=false;this.perMessageDeflate=null}get name(){return"websocket"}get handlesUpgrades(){return true}send(packets){this.writable=false;for(let i=0;i<packets.length;i++){const packet=packets[i];const isLast=i+1===packets.length;const send=data=>{const isBinary=typeof data!=="string";const compress=this.perMessageDeflate&&Buffer.byteLength(data)>this.perMessageDeflate.threshold;debug('writing "%s"',data);this.socket.send(data,isBinary,compress);if(isLast){this.emit("drain");this.writable=true;this.emit("ready")}};if(packet.options&&typeof packet.options.wsPreEncoded==="string"){send(packet.options.wsPreEncoded)}else{this.parser.encodePacket(packet,this.supportsBinary,send)}}}doClose(fn){debug("closing");fn&&fn();this.socket.end()}}exports.WebSocket=WebSocket},{"../transport":118,debug:131}],122:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const polling_1=require("./polling");const polling_jsonp_1=require("./polling-jsonp");const websocket_1=require("./websocket");const webtransport_1=require("./webtransport");exports.default={polling:polling,websocket:websocket_1.WebSocket,webtransport:webtransport_1.WebTransport};function polling(req){if("string"===typeof req._query.j){return new polling_jsonp_1.JSONP(req)}else{return new polling_1.Polling(req)}}polling.upgradesTo=["websocket","webtransport"]},{"./polling":124,"./polling-jsonp":123,"./websocket":125,"./webtransport":126}],123:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.JSONP=void 0;const polling_1=require("./polling");const qs=require("querystring");const rDoubleSlashes=/\\\\n/g;const rSlashes=/(\\)?\\n/g;class JSONP extends polling_1.Polling{constructor(req){super(req);this.head="___eio["+(req._query.j||"").replace(/[^0-9]/g,"")+"](";this.foot=");"}onData(data){data=qs.parse(data).d;if("string"===typeof data){data=data.replace(rSlashes,function(match,slashes){return slashes?match:"\n"});super.onData(data.replace(rDoubleSlashes,"\\n"))}}doWrite(data,options,callback){const js=JSON.stringify(data).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029");data=this.head+js+this.foot;super.doWrite(data,options,callback)}}exports.JSONP=JSONP},{"./polling":124,querystring:undefined}],124:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Polling=void 0;const transport_1=require("../transport");const zlib_1=require("zlib");const accepts=require("accepts");const debug_1=require("debug");const debug=(0,debug_1.default)("engine:polling");const compressionMethods={gzip:zlib_1.createGzip,deflate:zlib_1.createDeflate};class Polling extends transport_1.Transport{constructor(req){super(req);this.closeTimeout=30*1e3}get name(){return"polling"}onRequest(req){const res=req.res;req.res=null;if("GET"===req.method){this.onPollRequest(req,res)}else if("POST"===req.method){this.onDataRequest(req,res)}else{res.writeHead(500);res.end()}}onPollRequest(req,res){if(this.req){debug("request overlap");this.onError("overlap from client");res.writeHead(400);res.end();return}debug("setting request");this.req=req;this.res=res;const onClose=()=>{this.onError("poll connection closed prematurely")};const cleanup=()=>{req.removeListener("close",onClose);this.req=this.res=null};req.cleanup=cleanup;req.on("close",onClose);this.writable=true;this.emit("ready");if(this.writable&&this.shouldClose){debug("triggering empty send to append close packet");this.send([{type:"noop"}])}}onDataRequest(req,res){if(this.dataReq){this.onError("data request overlap from client");res.writeHead(400);res.end();return}const isBinary="application/octet-stream"===req.headers["content-type"];if(isBinary&&this.protocol===4){return this.onError("invalid content")}this.dataReq=req;this.dataRes=res;let chunks=isBinary?Buffer.concat([]):"";const cleanup=()=>{req.removeListener("data",onData);req.removeListener("end",onEnd);req.removeListener("close",onClose);this.dataReq=this.dataRes=chunks=null};const onClose=()=>{cleanup();this.onError("data request connection closed prematurely")};const onData=data=>{let contentLength;if(isBinary){chunks=Buffer.concat([chunks,data]);contentLength=chunks.length}else{chunks+=data;contentLength=Buffer.byteLength(chunks)}if(contentLength>this.maxHttpBufferSize){res.writeHead(413).end();cleanup()}};const onEnd=()=>{this.onData(chunks);const headers={"Content-Type":"text/html","Content-Length":"2"};res.writeHead(200,this.headers(req,headers));res.end("ok");cleanup()};req.on("close",onClose);if(!isBinary)req.setEncoding("utf8");req.on("data",onData);req.on("end",onEnd)}onData(data){debug('received "%s"',data);const callback=packet=>{if("close"===packet.type){debug("got xhr close packet");this.onClose();return false}this.onPacket(packet)};if(this.protocol===3){this.parser.decodePayload(data,callback)}else{this.parser.decodePayload(data).forEach(callback)}}onClose(){if(this.writable){this.send([{type:"noop"}])}super.onClose()}send(packets){this.writable=false;if(this.shouldClose){debug("appending close packet to payload");packets.push({type:"close"});this.shouldClose();this.shouldClose=null}const doWrite=data=>{const compress=packets.some(packet=>packet.options&&packet.options.compress);this.write(data,{compress:compress})};if(this.protocol===3){this.parser.encodePayload(packets,this.supportsBinary,doWrite)}else{this.parser.encodePayload(packets,doWrite)}}write(data,options){debug('writing "%s"',data);this.doWrite(data,options,()=>{this.req.cleanup();this.emit("drain")})}doWrite(data,options,callback){const isString=typeof data==="string";const contentType=isString?"text/plain; charset=UTF-8":"application/octet-stream";const headers={"Content-Type":contentType};const respond=data=>{headers["Content-Length"]="string"===typeof data?Buffer.byteLength(data):data.length;this.res.writeHead(200,this.headers(this.req,headers));this.res.end(data);callback()};if(!this.httpCompression||!options.compress){respond(data);return}const len=isString?Buffer.byteLength(data):data.length;if(len<this.httpCompression.threshold){respond(data);return}const encoding=accepts(this.req).encodings(["gzip","deflate"]);if(!encoding){respond(data);return}this.compress(data,encoding,(err,data)=>{if(err){this.res.writeHead(500);this.res.end();callback(err);return}headers["Content-Encoding"]=encoding;respond(data)})}compress(data,encoding,callback){debug("compressing");const buffers=[];let nread=0;compressionMethods[encoding](this.httpCompression).on("error",callback).on("data",function(chunk){buffers.push(chunk);nread+=chunk.length}).on("end",function(){callback(null,Buffer.concat(buffers,nread))}).end(data)}doClose(fn){debug("closing");let closeTimeoutTimer;if(this.dataReq){debug("aborting ongoing data request");this.dataReq.destroy()}const onClose=()=>{clearTimeout(closeTimeoutTimer);fn();this.onClose()};if(this.writable){debug("transport writable - closing right away");this.send([{type:"close"}]);onClose()}else if(this.discarded){debug("transport discarded - closing right away");onClose()}else{debug("transport not writable - buffering orderly close");this.shouldClose=onClose;closeTimeoutTimer=setTimeout(onClose,this.closeTimeout)}}headers(req,headers={}){const ua=req.headers["user-agent"];if(ua&&(~ua.indexOf(";MSIE")||~ua.indexOf("Trident/"))){headers["X-XSS-Protection"]="0"}headers["cache-control"]="no-store";this.emit("headers",headers,req);return headers}}exports.Polling=Polling},{"../transport":118,accepts:76,debug:131,zlib:undefined}],125:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.WebSocket=void 0;const transport_1=require("../transport");const debug_1=require("debug");const debug=(0,debug_1.default)("engine:ws");class WebSocket extends transport_1.Transport{constructor(req){super(req);this._doSend=data=>{this.socket.send(data,this._onSent)};this._doSendLast=data=>{this.socket.send(data,this._onSentLast)};this._onSent=err=>{if(err){this.onError("write error",err.stack)}};this._onSentLast=err=>{if(err){this.onError("write error",err.stack)}else{this.emit("drain");this.writable=true;this.emit("ready")}};this.socket=req.websocket;this.socket.on("message",(data,isBinary)=>{const message=isBinary?data:data.toString();debug('received "%s"',message);super.onData(message)});this.socket.once("close",this.onClose.bind(this));this.socket.on("error",this.onError.bind(this));this.writable=true;this.perMessageDeflate=null}get name(){return"websocket"}get handlesUpgrades(){return true}send(packets){this.writable=false;for(let i=0;i<packets.length;i++){const packet=packets[i];const isLast=i+1===packets.length;if(this._canSendPreEncodedFrame(packet)){this.socket._sender.sendFrame(packet.options.wsPreEncodedFrame,isLast?this._onSentLast:this._onSent)}else{this.parser.encodePacket(packet,this.supportsBinary,isLast?this._doSendLast:this._doSend)}}}_canSendPreEncodedFrame(packet){var _a,_b,_c;return!this.perMessageDeflate&&typeof((_b=(_a=this.socket)===null||_a===void 0?void 0:_a._sender)===null||_b===void 0?void 0:_b.sendFrame)==="function"&&((_c=packet.options)===null||_c===void 0?void 0:_c.wsPreEncodedFrame)!==undefined}doClose(fn){debug("closing");this.socket.close();fn&&fn()}}exports.WebSocket=WebSocket},{"../transport":118,debug:131}],126:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.WebTransport=void 0;const transport_1=require("../transport");const debug_1=require("debug");const engine_io_parser_1=require("engine.io-parser");const debug=(0,debug_1.default)("engine:webtransport");class WebTransport extends transport_1.Transport{constructor(session,stream,reader){super({_query:{EIO:"4"}});this.session=session;const transformStream=(0,engine_io_parser_1.createPacketEncoderStream)();transformStream.readable.pipeTo(stream.writable).catch(()=>{debug("the stream was closed")});this.writer=transformStream.writable.getWriter();(async()=>{try{while(true){const{value:value,done:done}=await reader.read();if(done){debug("session is closed");break}debug("received chunk: %o",value);this.onPacket(value)}}catch(e){debug("error while reading: %s",e.message)}})();session.closed.then(()=>this.onClose());this.writable=true}get name(){return"webtransport"}async send(packets){this.writable=false;try{for(let i=0;i<packets.length;i++){const packet=packets[i];await this.writer.write(packet)}}catch(e){debug("error while writing: %s",e.message)}this.emit("drain");this.writable=true;this.emit("ready")}doClose(fn){debug("closing WebTransport session");this.session.close();fn&&fn()}}exports.WebTransport=WebTransport},{"../transport":118,debug:131,"engine.io-parser":112}],127:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.uServer=void 0;const debug_1=require("debug");const server_1=require("./server");const transports_uws_1=require("./transports-uws");const debug=(0,debug_1.default)("engine:uws");class uServer extends server_1.BaseServer{init(){}cleanup(){}prepare(req,res){req.method=req.getMethod().toUpperCase();req.url=req.getUrl();const params=new URLSearchParams(req.getQuery());req._query=Object.fromEntries(params.entries());req.headers={};req.forEach((key,value)=>{req.headers[key]=value});req.connection={remoteAddress:Buffer.from(res.getRemoteAddressAsText()).toString()};res.onAborted(()=>{debug("response has been aborted")})}createTransport(transportName,req){return new transports_uws_1.default[transportName](req)}attach(app,options={}){const path=this._computePath(options);app.any(path,this.handleRequest.bind(this)).ws(path,{compression:options.compression,idleTimeout:options.idleTimeout,maxBackpressure:options.maxBackpressure,maxPayloadLength:this.opts.maxHttpBufferSize,upgrade:this.handleUpgrade.bind(this),open:ws=>{const transport=ws.getUserData().transport;transport.socket=ws;transport.writable=true;transport.emit("ready")},message:(ws,message,isBinary)=>{ws.getUserData().transport.onData(isBinary?message:Buffer.from(message).toString())},close:(ws,code,message)=>{ws.getUserData().transport.onClose(code,message)}})}_applyMiddlewares(req,res,callback){if(this.middlewares.length===0){return callback()}req.res=new ResponseWrapper(res);super._applyMiddlewares(req,req.res,err=>{req.res.writeHead();callback(err)})}handleRequest(res,req){debug('handling "%s" http request "%s"',req.getMethod(),req.getUrl());this.prepare(req,res);req.res=res;const callback=(errorCode,errorContext)=>{if(errorCode!==undefined){this.emit("connection_error",{req:req,code:errorCode,message:server_1.Server.errorMessages[errorCode],context:errorContext});this.abortRequest(req.res,errorCode,errorContext);return}if(req._query.sid){debug("setting new request for existing client");this.clients[req._query.sid].transport.onRequest(req)}else{const closeConnection=(errorCode,errorContext)=>this.abortRequest(res,errorCode,errorContext);this.handshake(req._query.transport,req,closeConnection)}};this._applyMiddlewares(req,res,err=>{if(err){callback(server_1.Server.errors.BAD_REQUEST,{name:"MIDDLEWARE_FAILURE"})}else{this.verify(req,false,callback)}})}handleUpgrade(res,req,context){debug("on upgrade");this.prepare(req,res);req.res=res;const callback=async(errorCode,errorContext)=>{if(errorCode!==undefined){this.emit("connection_error",{req:req,code:errorCode,message:server_1.Server.errorMessages[errorCode],context:errorContext});this.abortRequest(res,errorCode,errorContext);return}const id=req._query.sid;let transport;if(id){const client=this.clients[id];if(!client){debug("upgrade attempt for closed client");return res.close()}else if(client.upgrading){debug("transport has already been trying to upgrade");return res.close()}else if(client.upgraded){debug("transport had already been upgraded");return res.close()}else{debug("upgrading existing transport");transport=this.createTransport(req._query.transport,req);client._maybeUpgrade(transport)}}else{transport=await this.handshake(req._query.transport,req,(errorCode,errorContext)=>this.abortRequest(res,errorCode,errorContext));if(!transport){return}}req.res.writeStatus("101 Switching Protocols");res.upgrade({transport:transport},req.getHeader("sec-websocket-key"),req.getHeader("sec-websocket-protocol"),req.getHeader("sec-websocket-extensions"),context)};this._applyMiddlewares(req,res,err=>{if(err){callback(server_1.Server.errors.BAD_REQUEST,{name:"MIDDLEWARE_FAILURE"})}else{this.verify(req,true,callback)}})}abortRequest(res,errorCode,errorContext){const statusCode=errorCode===server_1.Server.errors.FORBIDDEN?"403 Forbidden":"400 Bad Request";const message=errorContext&&errorContext.message?errorContext.message:server_1.Server.errorMessages[errorCode];res.writeStatus(statusCode);res.writeHeader("Content-Type","application/json");res.end(JSON.stringify({code:errorCode,message:message}))}}exports.uServer=uServer;class ResponseWrapper{constructor(res){this.res=res;this.statusWritten=false;this.headers=[];this.isAborted=false}set statusCode(status){if(!status){return}this.writeStatus(status===200?"200 OK":"204 No Content")}writeHead(status){this.statusCode=status}setHeader(key,value){if(Array.isArray(value)){value.forEach(val=>{this.writeHeader(key,val)})}else{this.writeHeader(key,value)}}removeHeader(){}getHeader(){}writeStatus(status){if(this.isAborted)return;this.res.writeStatus(status);this.statusWritten=true;this.writeBufferedHeaders();return this}writeHeader(key,value){if(this.isAborted)return;if(key==="Content-Length"){return}if(this.statusWritten){this.res.writeHeader(key,value)}else{this.headers.push([key,value])}}writeBufferedHeaders(){this.headers.forEach(([key,value])=>{this.res.writeHeader(key,value)})}end(data){if(this.isAborted)return;this.res.cork(()=>{if(!this.statusWritten){this.writeBufferedHeaders()}this.res.end(data)})}onData(fn){if(this.isAborted)return;this.res.onData(fn)}onAborted(fn){if(this.isAborted)return;this.res.onAborted(()=>{this.isAborted=true;fn()})}cork(fn){if(this.isAborted)return;this.res.cork(fn)}}},{"./server":116,"./transports-uws":119,debug:131}],128:[function(require,module,exports){
/*!
 * cookie
 * Copyright(c) 2012-2014 Roman Shtylman
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";exports.parse=parse;exports.serialize=serialize;var __toString=Object.prototype.toString;var __hasOwnProperty=Object.prototype.hasOwnProperty;var cookieNameRegExp=/^[!#$%&'*+\-.^_`|~0-9A-Za-z]+$/;var cookieValueRegExp=/^("?)[\u0021\u0023-\u002B\u002D-\u003A\u003C-\u005B\u005D-\u007E]*\1$/;var domainValueRegExp=/^([.]?[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)([.][a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$/i;var pathValueRegExp=/^[\u0020-\u003A\u003D-\u007E]*$/;function parse(str,opt){if(typeof str!=="string"){throw new TypeError("argument str must be a string")}var obj={};var len=str.length;if(len<2)return obj;var dec=opt&&opt.decode||decode;var index=0;var eqIdx=0;var endIdx=0;do{eqIdx=str.indexOf("=",index);if(eqIdx===-1)break;endIdx=str.indexOf(";",index);if(endIdx===-1){endIdx=len}else if(eqIdx>endIdx){index=str.lastIndexOf(";",eqIdx-1)+1;continue}var keyStartIdx=startIndex(str,index,eqIdx);var keyEndIdx=endIndex(str,eqIdx,keyStartIdx);var key=str.slice(keyStartIdx,keyEndIdx);if(!__hasOwnProperty.call(obj,key)){var valStartIdx=startIndex(str,eqIdx+1,endIdx);var valEndIdx=endIndex(str,endIdx,valStartIdx);if(str.charCodeAt(valStartIdx)===34&&str.charCodeAt(valEndIdx-1)===34){valStartIdx++;valEndIdx--}var val=str.slice(valStartIdx,valEndIdx);obj[key]=tryDecode(val,dec)}index=endIdx+1}while(index<len);return obj}function startIndex(str,index,max){do{var code=str.charCodeAt(index);if(code!==32&&code!==9)return index}while(++index<max);return max}function endIndex(str,index,min){while(index>min){var code=str.charCodeAt(--index);if(code!==32&&code!==9)return index+1}return min}function serialize(name,val,opt){var enc=opt&&opt.encode||encodeURIComponent;if(typeof enc!=="function"){throw new TypeError("option encode is invalid")}if(!cookieNameRegExp.test(name)){throw new TypeError("argument name is invalid")}var value=enc(val);if(!cookieValueRegExp.test(value)){throw new TypeError("argument val is invalid")}var str=name+"="+value;if(!opt)return str;if(null!=opt.maxAge){var maxAge=Math.floor(opt.maxAge);if(!isFinite(maxAge)){throw new TypeError("option maxAge is invalid")}str+="; Max-Age="+maxAge}if(opt.domain){if(!domainValueRegExp.test(opt.domain)){throw new TypeError("option domain is invalid")}str+="; Domain="+opt.domain}if(opt.path){if(!pathValueRegExp.test(opt.path)){throw new TypeError("option path is invalid")}str+="; Path="+opt.path}if(opt.expires){var expires=opt.expires;if(!isDate(expires)||isNaN(expires.valueOf())){throw new TypeError("option expires is invalid")}str+="; Expires="+expires.toUTCString()}if(opt.httpOnly){str+="; HttpOnly"}if(opt.secure){str+="; Secure"}if(opt.partitioned){str+="; Partitioned"}if(opt.priority){var priority=typeof opt.priority==="string"?opt.priority.toLowerCase():opt.priority;switch(priority){case"low":str+="; Priority=Low";break;case"medium":str+="; Priority=Medium";break;case"high":str+="; Priority=High";break;default:throw new TypeError("option priority is invalid")}}if(opt.sameSite){var sameSite=typeof opt.sameSite==="string"?opt.sameSite.toLowerCase():opt.sameSite;switch(sameSite){case true:str+="; SameSite=Strict";break;case"lax":str+="; SameSite=Lax";break;case"strict":str+="; SameSite=Strict";break;case"none":str+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}}return str}function decode(str){return str.indexOf("%")!==-1?decodeURIComponent(str):str}function isDate(val){return __toString.call(val)==="[object Date]"}function tryDecode(str,decode){try{return decode(str)}catch(e){return str}}},{}],129:[function(require,module,exports){arguments[4][105][0].apply(exports,arguments)},{"./common":130,dup:105}],130:[function(require,module,exports){arguments[4][106][0].apply(exports,arguments)},{dup:106,ms:202}],131:[function(require,module,exports){arguments[4][107][0].apply(exports,arguments)},{"./browser.js":129,"./node.js":132,dup:107}],132:[function(require,module,exports){arguments[4][108][0].apply(exports,arguments)},{"./common":130,dup:108,"supports-color":297,tty:undefined,util:undefined}],133:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?Array.from:require("./shim")},{"./is-implemented":134,"./shim":135}],134:[function(require,module,exports){"use strict";module.exports=function(){var from=Array.from,arr,result;if(typeof from!=="function")return false;arr=["raz","dwa"];result=from(arr);return Boolean(result&&result!==arr&&result[1]==="dwa")}},{}],135:[function(require,module,exports){"use strict";var iteratorSymbol=require("es6-symbol").iterator,isArguments=require("../../function/is-arguments"),isFunction=require("../../function/is-function"),toPosInt=require("../../number/to-pos-integer"),callable=require("../../object/valid-callable"),validValue=require("../../object/valid-value"),isValue=require("../../object/is-value"),isString=require("../../string/is-string"),isArray=Array.isArray,call=Function.prototype.call,desc={configurable:true,enumerable:true,writable:true,value:null},defineProperty=Object.defineProperty;module.exports=function(arrayLike){var mapFn=arguments[1],thisArg=arguments[2],Context,i,j,arr,length,code,iterator,result,getIterator,value;arrayLike=Object(validValue(arrayLike));if(isValue(mapFn))callable(mapFn);if(!this||this===Array||!isFunction(this)){if(!mapFn){if(isArguments(arrayLike)){length=arrayLike.length;if(length!==1)return Array.apply(null,arrayLike);arr=new Array(1);arr[0]=arrayLike[0];return arr}if(isArray(arrayLike)){arr=new Array(length=arrayLike.length);for(i=0;i<length;++i)arr[i]=arrayLike[i];return arr}}arr=[]}else{Context=this}if(!isArray(arrayLike)){if((getIterator=arrayLike[iteratorSymbol])!==undefined){iterator=callable(getIterator).call(arrayLike);if(Context)arr=new Context;result=iterator.next();i=0;while(!result.done){value=mapFn?call.call(mapFn,thisArg,result.value,i):result.value;if(Context){desc.value=value;defineProperty(arr,i,desc)}else{arr[i]=value}result=iterator.next();++i}length=i}else if(isString(arrayLike)){length=arrayLike.length;if(Context)arr=new Context;for(i=0,j=0;i<length;++i){value=arrayLike[i];if(i+1<length){code=value.charCodeAt(0);if(code>=55296&&code<=56319)value+=arrayLike[++i]}value=mapFn?call.call(mapFn,thisArg,value,j):value;if(Context){desc.value=value;defineProperty(arr,j,desc)}else{arr[j]=value}++j}length=j}}if(length===undefined){length=toPosInt(arrayLike.length);if(Context)arr=new Context(length);for(i=0;i<length;++i){value=mapFn?call.call(mapFn,thisArg,arrayLike[i],i):arrayLike[i];if(Context){desc.value=value;defineProperty(arr,i,desc)}else{arr[i]=value}}}if(Context){desc.value=null;arr.length=length}return arr}},{"../../function/is-arguments":137,"../../function/is-function":138,"../../number/to-pos-integer":144,"../../object/is-value":152,"../../object/valid-callable":162,"../../object/valid-value":163,"../../string/is-string":167,"es6-symbol":168}],136:[function(require,module,exports){"use strict";module.exports=function(value){return value}},{}],137:[function(require,module,exports){"use strict";var objToString=Object.prototype.toString,id=objToString.call(function(){return arguments}());module.exports=function(value){return objToString.call(value)===id}},{}],138:[function(require,module,exports){"use strict";var objToString=Object.prototype.toString,isFunctionStringTag=RegExp.prototype.test.bind(/^[object [A-Za-z0-9]*Function]$/);module.exports=function(value){return typeof value==="function"&&isFunctionStringTag(objToString.call(value))}},{}],139:[function(require,module,exports){"use strict";module.exports=function(){}},{}],140:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?Math.sign:require("./shim")},{"./is-implemented":141,"./shim":142}],141:[function(require,module,exports){"use strict";module.exports=function(){var sign=Math.sign;if(typeof sign!=="function")return false;return sign(10)===1&&sign(-20)===-1}},{}],142:[function(require,module,exports){"use strict";module.exports=function(value){value=Number(value);if(isNaN(value)||value===0)return value;return value>0?1:-1}},{}],143:[function(require,module,exports){"use strict";var sign=require("../math/sign"),abs=Math.abs,floor=Math.floor;module.exports=function(value){if(isNaN(value))return 0;value=Number(value);if(value===0||!isFinite(value))return value;return sign(value)*floor(abs(value))}},{"../math/sign":140}],144:[function(require,module,exports){"use strict";var toInteger=require("./to-integer"),max=Math.max;module.exports=function(value){return max(0,toInteger(value))}},{"./to-integer":143}],145:[function(require,module,exports){"use strict";var callable=require("./valid-callable"),value=require("./valid-value"),bind=Function.prototype.bind,call=Function.prototype.call,keys=Object.keys,objPropertyIsEnumerable=Object.prototype.propertyIsEnumerable;module.exports=function(method,defVal){return function(obj,cb){var list,thisArg=arguments[2],compareFn=arguments[3];obj=Object(value(obj));callable(cb);list=keys(obj);if(compareFn){list.sort(typeof compareFn==="function"?bind.call(compareFn,obj):undefined)}if(typeof method!=="function")method=list[method];return call.call(method,list,function(key,index){if(!objPropertyIsEnumerable.call(obj,key))return defVal;return call.call(cb,thisArg,obj[key],key,obj,index)})}}},{"./valid-callable":162,"./valid-value":163}],146:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?Object.assign:require("./shim")},{"./is-implemented":147,"./shim":148}],147:[function(require,module,exports){"use strict";module.exports=function(){var assign=Object.assign,obj;if(typeof assign!=="function")return false;obj={foo:"raz"};assign(obj,{bar:"dwa"},{trzy:"trzy"});return obj.foo+obj.bar+obj.trzy==="razdwatrzy"}},{}],148:[function(require,module,exports){"use strict";var keys=require("../keys"),value=require("../valid-value"),max=Math.max;module.exports=function(dest,src){var error,i,length=max(arguments.length,2),assign;dest=Object(value(dest));assign=function(key){try{dest[key]=src[key]}catch(e){if(!error)error=e}};for(i=1;i<length;++i){src=arguments[i];keys(src).forEach(assign)}if(error!==undefined)throw error;return dest}},{"../keys":153,"../valid-value":163}],149:[function(require,module,exports){"use strict";var create=Object.create,shim;if(!require("./set-prototype-of/is-implemented")()){shim=require("./set-prototype-of/shim")}module.exports=function(){var nullObject,polyProps,desc;if(!shim)return create;if(shim.level!==1)return create;nullObject={};polyProps={};desc={configurable:false,enumerable:false,writable:true,value:undefined};Object.getOwnPropertyNames(Object.prototype).forEach(function(name){if(name==="__proto__"){polyProps[name]={configurable:true,enumerable:false,writable:true,value:undefined};return}polyProps[name]=desc});Object.defineProperties(nullObject,polyProps);Object.defineProperty(shim,"nullPolyfill",{configurable:false,enumerable:false,writable:false,value:nullObject});return function(prototype,props){return create(prototype===null?nullObject:prototype,props)}}()},{"./set-prototype-of/is-implemented":159,"./set-prototype-of/shim":160}],150:[function(require,module,exports){"use strict";module.exports=require("./_iterate")("forEach")},{"./_iterate":145}],151:[function(require,module,exports){"use strict";var isValue=require("./is-value");var map={function:true,object:true};module.exports=function(value){return isValue(value)&&map[typeof value]||false}},{"./is-value":152}],152:[function(require,module,exports){"use strict";var _undefined=require("../function/noop")();module.exports=function(val){return val!==_undefined&&val!==null}},{"../function/noop":139}],153:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?Object.keys:require("./shim")},{"./is-implemented":154,"./shim":155}],154:[function(require,module,exports){"use strict";module.exports=function(){try{Object.keys("primitive");return true}catch(e){return false}}},{}],155:[function(require,module,exports){"use strict";var isValue=require("../is-value");var keys=Object.keys;module.exports=function(object){return keys(isValue(object)?Object(object):object)}},{"../is-value":152}],156:[function(require,module,exports){"use strict";var callable=require("./valid-callable"),forEach=require("./for-each"),call=Function.prototype.call;module.exports=function(obj,cb){var result={},thisArg=arguments[2];callable(cb);forEach(obj,function(value,key,targetObj,index){result[key]=call.call(cb,thisArg,value,key,targetObj,index)});return result}},{"./for-each":150,"./valid-callable":162}],157:[function(require,module,exports){"use strict";var isValue=require("./is-value");var forEach=Array.prototype.forEach,create=Object.create;var process=function(src,obj){var key;for(key in src)obj[key]=src[key]};module.exports=function(opts1){var result=create(null);forEach.call(arguments,function(options){if(!isValue(options))return;process(Object(options),result)});return result}},{"./is-value":152}],158:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?Object.setPrototypeOf:require("./shim")},{"./is-implemented":159,"./shim":160}],159:[function(require,module,exports){"use strict";var create=Object.create,getPrototypeOf=Object.getPrototypeOf,plainObject={};module.exports=function(){var setPrototypeOf=Object.setPrototypeOf,customCreate=arguments[0]||create;if(typeof setPrototypeOf!=="function")return false;return getPrototypeOf(setPrototypeOf(customCreate(null),plainObject))===plainObject}},{}],160:[function(require,module,exports){"use strict";var isObject=require("../is-object"),value=require("../valid-value"),objIsPrototypeOf=Object.prototype.isPrototypeOf,defineProperty=Object.defineProperty,nullDesc={configurable:true,enumerable:false,writable:true,value:undefined},validate;validate=function(obj,prototype){value(obj);if(prototype===null||isObject(prototype))return obj;throw new TypeError("Prototype must be null or an object")};module.exports=function(status){var fn,set;if(!status)return null;if(status.level===2){if(status.set){set=status.set;fn=function(obj,prototype){set.call(validate(obj,prototype),prototype);return obj}}else{fn=function(obj,prototype){validate(obj,prototype).__proto__=prototype;return obj}}}else{fn=function self(obj,prototype){var isNullBase;validate(obj,prototype);isNullBase=objIsPrototypeOf.call(self.nullPolyfill,obj);if(isNullBase)delete self.nullPolyfill.__proto__;if(prototype===null)prototype=self.nullPolyfill;obj.__proto__=prototype;if(isNullBase)defineProperty(self.nullPolyfill,"__proto__",nullDesc);return obj}}return Object.defineProperty(fn,"level",{configurable:false,enumerable:false,writable:false,value:status.level})}(function(){var tmpObj1=Object.create(null),tmpObj2={},set,desc=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__");if(desc){try{set=desc.set;set.call(tmpObj1,tmpObj2)}catch(ignore){}if(Object.getPrototypeOf(tmpObj1)===tmpObj2)return{set:set,level:2}}tmpObj1.__proto__=tmpObj2;if(Object.getPrototypeOf(tmpObj1)===tmpObj2)return{level:2};tmpObj1={};tmpObj1.__proto__=tmpObj2;if(Object.getPrototypeOf(tmpObj1)===tmpObj2)return{level:1};return false}());require("../create")},{"../create":149,"../is-object":151,"../valid-value":163}],161:[function(require,module,exports){"use strict";var callable=require("./valid-callable"),isValue=require("./is-value"),forEach=require("./for-each"),call=Function.prototype.call,defaultCb=function(value,key){return[key,value]};module.exports=function(obj){var a=[],cb=arguments[1],thisArg=arguments[2];cb=isValue(cb)?callable(cb):defaultCb;forEach(obj,function(value,key,targetObj,index){a.push(call.call(cb,thisArg,value,key,this,index))},obj,arguments[3]);return a}},{"./for-each":150,"./is-value":152,"./valid-callable":162}],162:[function(require,module,exports){"use strict";module.exports=function(fn){if(typeof fn!=="function")throw new TypeError(fn+" is not a function");return fn}},{}],163:[function(require,module,exports){"use strict";var isValue=require("./is-value");module.exports=function(value){if(!isValue(value))throw new TypeError("Cannot use null or undefined");return value}},{"./is-value":152}],164:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?String.prototype.contains:require("./shim")},{"./is-implemented":165,"./shim":166}],165:[function(require,module,exports){"use strict";var str="razdwatrzy";module.exports=function(){if(typeof str.contains!=="function")return false;return str.contains("dwa")===true&&str.contains("foo")===false}},{}],166:[function(require,module,exports){"use strict";var indexOf=String.prototype.indexOf;module.exports=function(searchString){return indexOf.call(this,searchString,arguments[1])>-1}},{}],167:[function(require,module,exports){"use strict";var objToString=Object.prototype.toString,id=objToString.call("");module.exports=function(value){return typeof value==="string"||value&&typeof value==="object"&&(value instanceof String||objToString.call(value)===id)||false}},{}],168:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?require("ext/global-this").Symbol:require("./polyfill")},{"./is-implemented":169,"./polyfill":174,"ext/global-this":179}],169:[function(require,module,exports){"use strict";var global=require("ext/global-this"),validTypes={object:true,symbol:true};module.exports=function(){var Symbol=global.Symbol;var symbol;if(typeof Symbol!=="function")return false;symbol=Symbol("test symbol");try{String(symbol)}catch(e){return false}if(!validTypes[typeof Symbol.iterator])return false;if(!validTypes[typeof Symbol.toPrimitive])return false;if(!validTypes[typeof Symbol.toStringTag])return false;return true}},{"ext/global-this":179}],170:[function(require,module,exports){"use strict";module.exports=function(value){if(!value)return false;if(typeof value==="symbol")return true;if(!value.constructor)return false;if(value.constructor.name!=="Symbol")return false;return value[value.constructor.toStringTag]==="Symbol"}},{}],171:[function(require,module,exports){"use strict";var d=require("d");var create=Object.create,defineProperty=Object.defineProperty,objPrototype=Object.prototype;var created=create(null);module.exports=function(desc){var postfix=0,name,ie11BugWorkaround;while(created[desc+(postfix||"")])++postfix;desc+=postfix||"";created[desc]=true;name="@@"+desc;defineProperty(objPrototype,name,d.gs(null,function(value){if(ie11BugWorkaround)return;ie11BugWorkaround=true;defineProperty(this,name,d(value));ie11BugWorkaround=false}));return name}},{d:86}],172:[function(require,module,exports){"use strict";var d=require("d"),NativeSymbol=require("ext/global-this").Symbol;module.exports=function(SymbolPolyfill){return Object.defineProperties(SymbolPolyfill,{hasInstance:d("",NativeSymbol&&NativeSymbol.hasInstance||SymbolPolyfill("hasInstance")),isConcatSpreadable:d("",NativeSymbol&&NativeSymbol.isConcatSpreadable||SymbolPolyfill("isConcatSpreadable")),iterator:d("",NativeSymbol&&NativeSymbol.iterator||SymbolPolyfill("iterator")),match:d("",NativeSymbol&&NativeSymbol.match||SymbolPolyfill("match")),replace:d("",NativeSymbol&&NativeSymbol.replace||SymbolPolyfill("replace")),search:d("",NativeSymbol&&NativeSymbol.search||SymbolPolyfill("search")),species:d("",NativeSymbol&&NativeSymbol.species||SymbolPolyfill("species")),split:d("",NativeSymbol&&NativeSymbol.split||SymbolPolyfill("split")),toPrimitive:d("",NativeSymbol&&NativeSymbol.toPrimitive||SymbolPolyfill("toPrimitive")),toStringTag:d("",NativeSymbol&&NativeSymbol.toStringTag||SymbolPolyfill("toStringTag")),unscopables:d("",NativeSymbol&&NativeSymbol.unscopables||SymbolPolyfill("unscopables"))})}},{d:86,"ext/global-this":179}],173:[function(require,module,exports){"use strict";var d=require("d"),validateSymbol=require("../../../validate-symbol");var registry=Object.create(null);module.exports=function(SymbolPolyfill){return Object.defineProperties(SymbolPolyfill,{for:d(function(key){if(registry[key])return registry[key];return registry[key]=SymbolPolyfill(String(key))}),keyFor:d(function(symbol){var key;validateSymbol(symbol);for(key in registry){if(registry[key]===symbol)return key}return undefined})})}},{"../../../validate-symbol":175,d:86}],174:[function(require,module,exports){"use strict";var d=require("d"),validateSymbol=require("./validate-symbol"),NativeSymbol=require("ext/global-this").Symbol,generateName=require("./lib/private/generate-name"),setupStandardSymbols=require("./lib/private/setup/standard-symbols"),setupSymbolRegistry=require("./lib/private/setup/symbol-registry");var create=Object.create,defineProperties=Object.defineProperties,defineProperty=Object.defineProperty;var SymbolPolyfill,HiddenSymbol,isNativeSafe;if(typeof NativeSymbol==="function"){try{String(NativeSymbol());isNativeSafe=true}catch(ignore){}}else{NativeSymbol=null}HiddenSymbol=function Symbol(description){if(this instanceof HiddenSymbol)throw new TypeError("Symbol is not a constructor");return SymbolPolyfill(description)};module.exports=SymbolPolyfill=function Symbol(description){var symbol;if(this instanceof Symbol)throw new TypeError("Symbol is not a constructor");if(isNativeSafe)return NativeSymbol(description);symbol=create(HiddenSymbol.prototype);description=description===undefined?"":String(description);return defineProperties(symbol,{__description__:d("",description),__name__:d("",generateName(description))})};setupStandardSymbols(SymbolPolyfill);setupSymbolRegistry(SymbolPolyfill);defineProperties(HiddenSymbol.prototype,{constructor:d(SymbolPolyfill),toString:d("",function(){return this.__name__})});defineProperties(SymbolPolyfill.prototype,{toString:d(function(){return"Symbol ("+validateSymbol(this).__description__+")"}),valueOf:d(function(){return validateSymbol(this)})});defineProperty(SymbolPolyfill.prototype,SymbolPolyfill.toPrimitive,d("",function(){var symbol=validateSymbol(this);if(typeof symbol==="symbol")return symbol;return symbol.toString()}));defineProperty(SymbolPolyfill.prototype,SymbolPolyfill.toStringTag,d("c","Symbol"));defineProperty(HiddenSymbol.prototype,SymbolPolyfill.toStringTag,d("c",SymbolPolyfill.prototype[SymbolPolyfill.toStringTag]));defineProperty(HiddenSymbol.prototype,SymbolPolyfill.toPrimitive,d("c",SymbolPolyfill.prototype[SymbolPolyfill.toPrimitive]))},{"./lib/private/generate-name":171,"./lib/private/setup/standard-symbols":172,"./lib/private/setup/symbol-registry":173,"./validate-symbol":175,d:86,"ext/global-this":179}],175:[function(require,module,exports){"use strict";var isSymbol=require("./is-symbol");module.exports=function(value){if(!isSymbol(value))throw new TypeError(value+" is not a symbol");return value}},{"./is-symbol":170}],176:[function(require,module,exports){
/*!
 * escape-html
 * Copyright(c) 2012-2013 TJ Holowaychuk
 * Copyright(c) 2015 Andreas Lubbe
 * Copyright(c) 2015 Tiancheng "Timothy" Gu
 * MIT Licensed
 */
"use strict";var matchHtmlRegExp=/["'&<>]/;module.exports=escapeHtml;function escapeHtml(string){var str=""+string;var match=matchHtmlRegExp.exec(str);if(!match){return str}var escape;var html="";var index=0;var lastIndex=0;for(index=match.index;index<str.length;index++){switch(str.charCodeAt(index)){case 34:escape="&quot;";break;case 38:escape="&amp;";break;case 39:escape="&#39;";break;case 60:escape="&lt;";break;case 62:escape="&gt;";break;default:continue}if(lastIndex!==index){html+=str.substring(lastIndex,index)}lastIndex=index+1;html+=escape}return lastIndex!==index?html+str.substring(lastIndex,index):html}},{}],177:[function(require,module,exports){"use strict";var d=require("d"),callable=require("es5-ext/object/valid-callable"),apply=Function.prototype.apply,call=Function.prototype.call,create=Object.create,defineProperty=Object.defineProperty,defineProperties=Object.defineProperties,hasOwnProperty=Object.prototype.hasOwnProperty,descriptor={configurable:true,enumerable:false,writable:true},on,once,off,emit,methods,descriptors,base;on=function(type,listener){var data;callable(listener);if(!hasOwnProperty.call(this,"__ee__")){data=descriptor.value=create(null);defineProperty(this,"__ee__",descriptor);descriptor.value=null}else{data=this.__ee__}if(!data[type])data[type]=listener;else if(typeof data[type]==="object")data[type].push(listener);else data[type]=[data[type],listener];return this};once=function(type,listener){var once,self;callable(listener);self=this;on.call(this,type,once=function(){off.call(self,type,once);apply.call(listener,this,arguments)});once.__eeOnceListener__=listener;return this};off=function(type,listener){var data,listeners,candidate,i;callable(listener);if(!hasOwnProperty.call(this,"__ee__"))return this;data=this.__ee__;if(!data[type])return this;listeners=data[type];if(typeof listeners==="object"){for(i=0;candidate=listeners[i];++i){if(candidate===listener||candidate.__eeOnceListener__===listener){if(listeners.length===2)data[type]=listeners[i?0:1];else listeners.splice(i,1)}}}else{if(listeners===listener||listeners.__eeOnceListener__===listener){delete data[type]}}return this};emit=function(type){var i,l,listener,listeners,args;if(!hasOwnProperty.call(this,"__ee__"))return;listeners=this.__ee__[type];if(!listeners)return;if(typeof listeners==="object"){l=arguments.length;args=new Array(l-1);for(i=1;i<l;++i)args[i-1]=arguments[i];listeners=listeners.slice();for(i=0;listener=listeners[i];++i){apply.call(listener,this,args)}}else{switch(arguments.length){case 1:call.call(listeners,this);break;case 2:call.call(listeners,this,arguments[1]);break;case 3:call.call(listeners,this,arguments[1],arguments[2]);break;default:l=arguments.length;args=new Array(l-1);for(i=1;i<l;++i){args[i-1]=arguments[i]}apply.call(listeners,this,args)}}};methods={on:on,once:once,off:off,emit:emit};descriptors={on:d(on),once:d(once),off:d(off),emit:d(emit)};base=defineProperties({},descriptors);module.exports=exports=function(o){return o==null?create(base):defineProperties(Object(o),descriptors)};exports.methods=methods},{d:86,"es5-ext/object/valid-callable":162}],178:[function(require,module,exports){var naiveFallback=function(){if(typeof self==="object"&&self)return self;if(typeof window==="object"&&window)return window;throw new Error("Unable to resolve global `this`")};module.exports=function(){if(this)return this;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:true})}catch(error){return naiveFallback()}try{if(!__global__)return naiveFallback();return __global__}finally{delete Object.prototype.__global__}}()},{}],179:[function(require,module,exports){"use strict";module.exports=require("./is-implemented")()?globalThis:require("./implementation")},{"./implementation":178,"./is-implemented":180}],180:[function(require,module,exports){"use strict";module.exports=function(){if(typeof globalThis!=="object")return false;if(!globalThis)return false;return globalThis.Array===Array}},{}],181:[function(require,module,exports){
/*!
 * finalhandler
 * Copyright(c) 2014-2017 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var debug=require("debug")("finalhandler");var encodeUrl=require("encodeurl");var escapeHtml=require("escape-html");var onFinished=require("on-finished");var parseUrl=require("parseurl");var statuses=require("statuses");var unpipe=require("unpipe");var DOUBLE_SPACE_REGEXP=/\x20{2}/g;var NEWLINE_REGEXP=/\n/g;var defer=typeof setImmediate==="function"?setImmediate:function(fn){process.nextTick(fn.bind.apply(fn,arguments))};var isFinished=onFinished.isFinished;function createHtmlDocument(message){var body=escapeHtml(message).replace(NEWLINE_REGEXP,"<br>").replace(DOUBLE_SPACE_REGEXP," &nbsp;");return"<!DOCTYPE html>\n"+'<html lang="en">\n'+"<head>\n"+'<meta charset="utf-8">\n'+"<title>Error</title>\n"+"</head>\n"+"<body>\n"+"<pre>"+body+"</pre>\n"+"</body>\n"+"</html>\n"}module.exports=finalhandler;function finalhandler(req,res,options){var opts=options||{};var env=opts.env||process.env.NODE_ENV||"development";var onerror=opts.onerror;return function(err){var headers;var msg;var status;if(!err&&headersSent(res)){debug("cannot 404 after headers sent");return}if(err){status=getErrorStatusCode(err);if(status===undefined){status=getResponseStatusCode(res)}else{headers=getErrorHeaders(err)}msg=getErrorMessage(err,status,env)}else{status=404;msg="Cannot "+req.method+" "+encodeUrl(getResourceName(req))}debug("default %s",status);if(err&&onerror){defer(onerror,err,req,res)}if(headersSent(res)){debug("cannot %d after headers sent",status);req.socket.destroy();return}send(req,res,status,headers,msg)}}function getErrorHeaders(err){if(!err.headers||typeof err.headers!=="object"){return undefined}var headers=Object.create(null);var keys=Object.keys(err.headers);for(var i=0;i<keys.length;i++){var key=keys[i];headers[key]=err.headers[key]}return headers}function getErrorMessage(err,status,env){var msg;if(env!=="production"){msg=err.stack;if(!msg&&typeof err.toString==="function"){msg=err.toString()}}return msg||statuses[status]}function getErrorStatusCode(err){if(typeof err.status==="number"&&err.status>=400&&err.status<600){return err.status}if(typeof err.statusCode==="number"&&err.statusCode>=400&&err.statusCode<600){return err.statusCode}return undefined}function getResourceName(req){try{return parseUrl.original(req).pathname}catch(e){return"resource"}}function getResponseStatusCode(res){var status=res.statusCode;if(typeof status!=="number"||status<400||status>599){status=500}return status}function headersSent(res){return typeof res.headersSent!=="boolean"?Boolean(res._header):res.headersSent}function send(req,res,status,headers,message){function write(){var body=createHtmlDocument(message);res.statusCode=status;res.statusMessage=statuses[status];setHeaders(res,headers);res.setHeader("Content-Security-Policy","default-src 'none'");res.setHeader("X-Content-Type-Options","nosniff");res.setHeader("Content-Type","text/html; charset=utf-8");res.setHeader("Content-Length",Buffer.byteLength(body,"utf8"));if(req.method==="HEAD"){res.end();return}res.end(body,"utf8")}if(isFinished(req)){write();return}unpipe(req);onFinished(req,write);req.resume()}function setHeaders(res,headers){if(!headers){return}var keys=Object.keys(headers);for(var i=0;i<keys.length;i++){var key=keys[i];res.setHeader(key,headers[key])}}},{debug:184,encodeurl:186,"escape-html":176,"on-finished":188,parseurl:209,statuses:190,unpipe:314}],182:[function(require,module,exports){arguments[4][80][0].apply(exports,arguments)},{"./debug":183,dup:80}],183:[function(require,module,exports){arguments[4][81][0].apply(exports,arguments)},{dup:81,ms:187}],184:[function(require,module,exports){arguments[4][82][0].apply(exports,arguments)},{"./browser.js":182,"./node.js":185,dup:82}],185:[function(require,module,exports){arguments[4][83][0].apply(exports,arguments)},{"./debug":183,dup:83,fs:undefined,net:undefined,tty:undefined,util:undefined}],186:[function(require,module,exports){
/*!
 * encodeurl
 * Copyright(c) 2016 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";module.exports=encodeUrl;var ENCODE_CHARS_REGEXP=/(?:[^\x21\x25\x26-\x3B\x3D\x3F-\x5B\x5D\x5F\x61-\x7A\x7E]|%(?:[^0-9A-Fa-f]|[0-9A-Fa-f][^0-9A-Fa-f]|$))+/g;var UNMATCHED_SURROGATE_PAIR_REGEXP=/(^|[^\uD800-\uDBFF])[\uDC00-\uDFFF]|[\uD800-\uDBFF]([^\uDC00-\uDFFF]|$)/g;var UNMATCHED_SURROGATE_PAIR_REPLACE="$1$2";function encodeUrl(url){return String(url).replace(UNMATCHED_SURROGATE_PAIR_REGEXP,UNMATCHED_SURROGATE_PAIR_REPLACE).replace(ENCODE_CHARS_REGEXP,encodeURI)}},{}],187:[function(require,module,exports){arguments[4][84][0].apply(exports,arguments)},{dup:84}],188:[function(require,module,exports){
/*!
 * on-finished
 * Copyright(c) 2013 Jonathan Ong
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";module.exports=onFinished;module.exports.isFinished=isFinished;var first=require("ee-first");var defer=typeof setImmediate==="function"?setImmediate:function(fn){process.nextTick(fn.bind.apply(fn,arguments))};function onFinished(msg,listener){if(isFinished(msg)!==false){defer(listener,null,msg);return msg}attachListener(msg,listener);return msg}function isFinished(msg){var socket=msg.socket;if(typeof msg.finished==="boolean"){return Boolean(msg.finished||socket&&!socket.writable)}if(typeof msg.complete==="boolean"){return Boolean(msg.upgrade||!socket||!socket.readable||msg.complete&&!msg.readable)}return undefined}function attachFinishedListener(msg,callback){var eeMsg;var eeSocket;var finished=false;function onFinish(error){eeMsg.cancel();eeSocket.cancel();finished=true;callback(error)}eeMsg=eeSocket=first([[msg,"end","finish"]],onFinish);function onSocket(socket){msg.removeListener("socket",onSocket);if(finished)return;if(eeMsg!==eeSocket)return;eeSocket=first([[socket,"error","close"]],onFinish)}if(msg.socket){onSocket(msg.socket);return}msg.on("socket",onSocket);if(msg.socket===undefined){patchAssignSocket(msg,onSocket)}}function attachListener(msg,listener){var attached=msg.__onFinished;if(!attached||!attached.queue){attached=msg.__onFinished=createListener(msg);attachFinishedListener(msg,attached)}attached.queue.push(listener)}function createListener(msg){function listener(err){if(msg.__onFinished===listener)msg.__onFinished=null;if(!listener.queue)return;var queue=listener.queue;listener.queue=null;for(var i=0;i<queue.length;i++){queue[i](err,msg)}}listener.queue=[];return listener}function patchAssignSocket(res,callback){var assignSocket=res.assignSocket;if(typeof assignSocket!=="function")return;res.assignSocket=function _assignSocket(socket){assignSocket.call(this,socket);callback(socket)}}},{"ee-first":88}],189:[function(require,module,exports){module.exports={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"(Unused)",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Unordered Collection",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",509:"Bandwidth Limit Exceeded",510:"Not Extended",511:"Network Authentication Required"}},{}],190:[function(require,module,exports){
/*!
 * statuses
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2016 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var codes=require("./codes.json");module.exports=status;status.STATUS_CODES=codes;status.codes=populateStatusesMap(status,codes);status.redirect={300:true,301:true,302:true,303:true,305:true,307:true,308:true};status.empty={204:true,205:true,304:true};status.retry={502:true,503:true,504:true};function populateStatusesMap(statuses,codes){var arr=[];Object.keys(codes).forEach(function forEachCode(code){var message=codes[code];var status=Number(code);statuses[status]=message;statuses[message]=status;statuses[message.toLowerCase()]=status;arr.push(status)});return arr}function status(code){if(typeof code==="number"){if(!status[code])throw new Error("invalid status code: "+code);return code}if(typeof code!=="string"){throw new TypeError("code must be a number or string")}var n=parseInt(code,10);if(!isNaN(n)){if(!status[n])throw new Error("invalid status code: "+n);return n}n=status[code.toLowerCase()];if(!n)throw new Error('invalid status message: "'+code+'"');return n}},{"./codes.json":189}],191:[function(require,module,exports){"use strict";module.exports=(flag,argv=process.argv)=>{const prefix=flag.startsWith("-")?"":flag.length===1?"-":"--";const position=argv.indexOf(prefix+flag);const terminatorPosition=argv.indexOf("--");return position!==-1&&(terminatorPosition===-1||position<terminatorPosition)}},{}],192:[function(require,module,exports){"use strict";var loggerPrototype=require("./lib/private/logger-prototype");module.exports=loggerPrototype._createLevel("info")},{"./lib/private/logger-prototype":197}],193:[function(require,module,exports){module.exports=["error","warning","notice","info","debug"]},{}],194:[function(require,module,exports){"use strict";var uniGlobal=require("uni-global")("medikoo/log/202110");if(uniGlobal.emitter){module.exports=uniGlobal.emitter;return}var ee=require("event-emitter");module.exports=uniGlobal.emitter=ee()},{"event-emitter":177,"uni-global":311}],195:[function(require,module,exports){"use strict";module.exports=RegExp.prototype.test.bind(/^[a-z0-9-]+$/)},{}],196:[function(require,module,exports){"use strict";var noop=require("es5-ext/function/noop"),objForEach=require("es5-ext/object/for-each"),d=require("d");module.exports={isEnabled:d("ew",true),enable:d(function(){return this._setEnabledState(true)}),disable:d(function(){return this._setEnabledState(false)}),_setEnabledState:d(function(state){var cache=[];this._setEnabledStateRecursively(state,cache);var result={restore:function(){cache.forEach(function(data){if(data.hasDirectSetting)data.logger.isEnabled=!state;else delete data.logger.isEnabled});result.restore=noop}};return result}),_setEnabledStateRecursively:d(function(newState,cache){if(this.isEnabled!==newState){cache.push({logger:this,hasDirectSetting:hasOwnProperty.call(this,"isEnabled")});this.isEnabled=newState}objForEach(this._childNamespaceLoggers,function(namespacedLogger){namespacedLogger._setEnabledStateRecursively(newState,cache)})})}},{d:86,"es5-ext/function/noop":139,"es5-ext/object/for-each":150}],197:[function(require,module,exports){"use strict";var ensureString=require("type/string/ensure"),aFrom=require("es5-ext/array/from"),assign=require("es5-ext/object/assign"),setPrototypeOf=require("es5-ext/object/set-prototype-of"),d=require("d"),lazy=require("d/lazy"),levelNames=require("../../../levels"),emitter=require("../../emitter"),enableDisableProps=require("./enable-disable-props"),namespaceProps=require("./namespace-props");var levelLoggers=Object.create(null);var loggerPrototype=Object.create(Function.prototype,assign({isLevelInitialized:d("e",function(level){level=ensureString(level);if(this.level===level)return true;var logger=levelLoggers[level];if(!logger)return false;if(!this.namespace)return true;return logger.isNamespaceInitialized(this.namespace)}),getAllInitializedLevels:d("e",function(){return Object.keys(levelLoggers).filter(function(level){return this.isLevelInitialized(level)},this).map(function(level){return this._getLevelLogger(level)},this)}),_createLogger:d(function(){return setPrototypeOf(function self(msgItemIgnored){emitter.emit("log",{logger:self,messageTokens:aFrom(arguments)})},this)}),_createLevel:d(function(levelName){if(levelLoggers[levelName])return levelLoggers[levelName];var logger=loggerPrototype._createLogger();Object.defineProperties(logger,{level:d("e",levelName),levelIndex:d("e",levelNames.indexOf(levelName)),levelRoot:d("e",logger)});levelLoggers[levelName]=logger;emitter.emit("init",{logger:logger});return logger}),_getLevelLogger:d(function(newLevel){if(this.level===newLevel)return this;var levelLogger=this._createLevel(newLevel);return this.namespaceTokens.reduce(function(currentLogger,token){return currentLogger._createNamespace(token)},levelLogger)})},lazy(assign(levelNames.reduce(function(descriptors,level){descriptors[level]=d("e",function(){return this._getLevelLogger(level)},{cacheName:"_"+level});return descriptors},{}),{warn:d(function(){return this._getLevelLogger("warning")},{cacheName:"_warning"})})),namespaceProps,enableDisableProps));module.exports=loggerPrototype},{"../../../levels":193,"../../emitter":194,"./enable-disable-props":196,"./namespace-props":198,d:86,"d/lazy":87,"es5-ext/array/from":133,"es5-ext/object/assign":146,"es5-ext/object/set-prototype-of":158,"type/string/ensure":307}],198:[function(require,module,exports){"use strict";var ensureString=require("type/string/ensure"),toShortString=require("type/lib/to-short-string"),identity=require("es5-ext/function/identity"),assign=require("es5-ext/object/assign"),objToArray=require("es5-ext/object/to-array"),d=require("d"),lazy=require("d/lazy"),emitter=require("../../emitter"),isNamespaceToken=require("../is-namespace-token");module.exports=assign({get:d(function(namespace){namespace=ensureString(namespace);var namespaceTokens=namespace.split(":");namespaceTokens.forEach(function(namespaceToken){if(!isNamespaceToken(namespaceToken)){throw new TypeError(toShortString(namespace)+" is not a valid namespace string "+"(only 'a-z0-9-' chars are allowed and ':' as delimiter)")}});return namespaceTokens.reduce(function(currentLogger,token){return currentLogger._createNamespace(token)},this)}),isNamespaceInitialized:d("e",function(namespace){var namespaceTokens=ensureString(namespace).split(":");var currentLogger=this;return namespaceTokens.every(function(nsToken){return currentLogger=currentLogger._childNamespaceLoggers[nsToken]})}),getAllInitializedNamespaces:d("e",function(){return objToArray(this._childNamespaceLoggers,identity)}),_createNamespace:d(function(namespaceToken){if(this._childNamespaceLoggers[namespaceToken]){return this._childNamespaceLoggers[namespaceToken]}var logger=Object.defineProperties(this._createLogger(),{_namespaceToken:d("",namespaceToken)});this._childNamespaceLoggers[namespaceToken]=logger;emitter.emit("init",{logger:logger});return logger}),_namespaceToken:d("",null)},lazy({namespace:d("e",function(){return this.namespaceTokens.join(":")||null},{cacheName:"_namespace"}),namespaceTokens:d("e",function(){return this._namespaceToken?Object.getPrototypeOf(this).namespaceTokens.concat(this._namespaceToken):[]},{cacheName:"_namespaceTokens"}),_childNamespaceLoggers:d("",function(){return Object.create(null)},{cacheName:"__childNamespaceLoggers"})}))},{"../../emitter":194,"../is-namespace-token":195,d:86,"d/lazy":87,"es5-ext/function/identity":136,"es5-ext/object/assign":146,"es5-ext/object/to-array":161,"type/lib/to-short-string":302,"type/string/ensure":307}],199:[function(require,module,exports){module.exports={"application/1d-interleaved-parityfec":{source:"iana"},"application/3gpdash-qoe-report+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/3gpp-ims+xml":{source:"iana",compressible:true},"application/3gpphal+json":{source:"iana",compressible:true},"application/3gpphalforms+json":{source:"iana",compressible:true},"application/a2l":{source:"iana"},"application/ace+cbor":{source:"iana"},"application/activemessage":{source:"iana"},"application/activity+json":{source:"iana",compressible:true},"application/alto-costmap+json":{source:"iana",compressible:true},"application/alto-costmapfilter+json":{source:"iana",compressible:true},"application/alto-directory+json":{source:"iana",compressible:true},"application/alto-endpointcost+json":{source:"iana",compressible:true},"application/alto-endpointcostparams+json":{source:"iana",compressible:true},"application/alto-endpointprop+json":{source:"iana",compressible:true},"application/alto-endpointpropparams+json":{source:"iana",compressible:true},"application/alto-error+json":{source:"iana",compressible:true},"application/alto-networkmap+json":{source:"iana",compressible:true},"application/alto-networkmapfilter+json":{source:"iana",compressible:true},"application/alto-updatestreamcontrol+json":{source:"iana",compressible:true},"application/alto-updatestreamparams+json":{source:"iana",compressible:true},"application/aml":{source:"iana"},"application/andrew-inset":{source:"iana",extensions:["ez"]},"application/applefile":{source:"iana"},"application/applixware":{source:"apache",extensions:["aw"]},"application/at+jwt":{source:"iana"},"application/atf":{source:"iana"},"application/atfx":{source:"iana"},"application/atom+xml":{source:"iana",compressible:true,extensions:["atom"]},"application/atomcat+xml":{source:"iana",compressible:true,extensions:["atomcat"]},"application/atomdeleted+xml":{source:"iana",compressible:true,extensions:["atomdeleted"]},"application/atomicmail":{source:"iana"},"application/atomsvc+xml":{source:"iana",compressible:true,extensions:["atomsvc"]},"application/atsc-dwd+xml":{source:"iana",compressible:true,extensions:["dwd"]},"application/atsc-dynamic-event-message":{source:"iana"},"application/atsc-held+xml":{source:"iana",compressible:true,extensions:["held"]},"application/atsc-rdt+json":{source:"iana",compressible:true},"application/atsc-rsat+xml":{source:"iana",compressible:true,extensions:["rsat"]},"application/atxml":{source:"iana"},"application/auth-policy+xml":{source:"iana",compressible:true},"application/bacnet-xdd+zip":{source:"iana",compressible:false},"application/batch-smtp":{source:"iana"},"application/bdoc":{compressible:false,extensions:["bdoc"]},"application/beep+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/calendar+json":{source:"iana",compressible:true},"application/calendar+xml":{source:"iana",compressible:true,extensions:["xcs"]},"application/call-completion":{source:"iana"},"application/cals-1840":{source:"iana"},"application/captive+json":{source:"iana",compressible:true},"application/cbor":{source:"iana"},"application/cbor-seq":{source:"iana"},"application/cccex":{source:"iana"},"application/ccmp+xml":{source:"iana",compressible:true},"application/ccxml+xml":{source:"iana",compressible:true,extensions:["ccxml"]},"application/cdfx+xml":{source:"iana",compressible:true,extensions:["cdfx"]},"application/cdmi-capability":{source:"iana",extensions:["cdmia"]},"application/cdmi-container":{source:"iana",extensions:["cdmic"]},"application/cdmi-domain":{source:"iana",extensions:["cdmid"]},"application/cdmi-object":{source:"iana",extensions:["cdmio"]},"application/cdmi-queue":{source:"iana",extensions:["cdmiq"]},"application/cdni":{source:"iana"},"application/cea":{source:"iana"},"application/cea-2018+xml":{source:"iana",compressible:true},"application/cellml+xml":{source:"iana",compressible:true},"application/cfw":{source:"iana"},"application/city+json":{source:"iana",compressible:true},"application/clr":{source:"iana"},"application/clue+xml":{source:"iana",compressible:true},"application/clue_info+xml":{source:"iana",compressible:true},"application/cms":{source:"iana"},"application/cnrp+xml":{source:"iana",compressible:true},"application/coap-group+json":{source:"iana",compressible:true},"application/coap-payload":{source:"iana"},"application/commonground":{source:"iana"},"application/conference-info+xml":{source:"iana",compressible:true},"application/cose":{source:"iana"},"application/cose-key":{source:"iana"},"application/cose-key-set":{source:"iana"},"application/cpl+xml":{source:"iana",compressible:true,extensions:["cpl"]},"application/csrattrs":{source:"iana"},"application/csta+xml":{source:"iana",compressible:true},"application/cstadata+xml":{source:"iana",compressible:true},"application/csvm+json":{source:"iana",compressible:true},"application/cu-seeme":{source:"apache",extensions:["cu"]},"application/cwt":{source:"iana"},"application/cybercash":{source:"iana"},"application/dart":{compressible:true},"application/dash+xml":{source:"iana",compressible:true,extensions:["mpd"]},"application/dash-patch+xml":{source:"iana",compressible:true,extensions:["mpp"]},"application/dashdelta":{source:"iana"},"application/davmount+xml":{source:"iana",compressible:true,extensions:["davmount"]},"application/dca-rft":{source:"iana"},"application/dcd":{source:"iana"},"application/dec-dx":{source:"iana"},"application/dialog-info+xml":{source:"iana",compressible:true},"application/dicom":{source:"iana"},"application/dicom+json":{source:"iana",compressible:true},"application/dicom+xml":{source:"iana",compressible:true},"application/dii":{source:"iana"},"application/dit":{source:"iana"},"application/dns":{source:"iana"},"application/dns+json":{source:"iana",compressible:true},"application/dns-message":{source:"iana"},"application/docbook+xml":{source:"apache",compressible:true,extensions:["dbk"]},"application/dots+cbor":{source:"iana"},"application/dskpp+xml":{source:"iana",compressible:true},"application/dssc+der":{source:"iana",extensions:["dssc"]},"application/dssc+xml":{source:"iana",compressible:true,extensions:["xdssc"]},"application/dvcs":{source:"iana"},"application/ecmascript":{source:"iana",compressible:true,extensions:["es","ecma"]},"application/edi-consent":{source:"iana"},"application/edi-x12":{source:"iana",compressible:false},"application/edifact":{source:"iana",compressible:false},"application/efi":{source:"iana"},"application/elm+json":{source:"iana",charset:"UTF-8",compressible:true},"application/elm+xml":{source:"iana",compressible:true},"application/emergencycalldata.cap+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/emergencycalldata.comment+xml":{source:"iana",compressible:true},"application/emergencycalldata.control+xml":{source:"iana",compressible:true},"application/emergencycalldata.deviceinfo+xml":{source:"iana",compressible:true},"application/emergencycalldata.ecall.msd":{source:"iana"},"application/emergencycalldata.providerinfo+xml":{source:"iana",compressible:true},"application/emergencycalldata.serviceinfo+xml":{source:"iana",compressible:true},"application/emergencycalldata.subscriberinfo+xml":{source:"iana",compressible:true},"application/emergencycalldata.veds+xml":{source:"iana",compressible:true},"application/emma+xml":{source:"iana",compressible:true,extensions:["emma"]},"application/emotionml+xml":{source:"iana",compressible:true,extensions:["emotionml"]},"application/encaprtp":{source:"iana"},"application/epp+xml":{source:"iana",compressible:true},"application/epub+zip":{source:"iana",compressible:false,extensions:["epub"]},"application/eshop":{source:"iana"},"application/exi":{source:"iana",extensions:["exi"]},"application/expect-ct-report+json":{source:"iana",compressible:true},"application/express":{source:"iana",extensions:["exp"]},"application/fastinfoset":{source:"iana"},"application/fastsoap":{source:"iana"},"application/fdt+xml":{source:"iana",compressible:true,extensions:["fdt"]},"application/fhir+json":{source:"iana",charset:"UTF-8",compressible:true},"application/fhir+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/fido.trusted-apps+json":{compressible:true},"application/fits":{source:"iana"},"application/flexfec":{source:"iana"},"application/font-sfnt":{source:"iana"},"application/font-tdpfr":{source:"iana",extensions:["pfr"]},"application/font-woff":{source:"iana",compressible:false},"application/framework-attributes+xml":{source:"iana",compressible:true},"application/geo+json":{source:"iana",compressible:true,extensions:["geojson"]},"application/geo+json-seq":{source:"iana"},"application/geopackage+sqlite3":{source:"iana"},"application/geoxacml+xml":{source:"iana",compressible:true},"application/gltf-buffer":{source:"iana"},"application/gml+xml":{source:"iana",compressible:true,extensions:["gml"]},"application/gpx+xml":{source:"apache",compressible:true,extensions:["gpx"]},"application/gxf":{source:"apache",extensions:["gxf"]},"application/gzip":{source:"iana",compressible:false,extensions:["gz"]},"application/h224":{source:"iana"},"application/held+xml":{source:"iana",compressible:true},"application/hjson":{extensions:["hjson"]},"application/http":{source:"iana"},"application/hyperstudio":{source:"iana",extensions:["stk"]},"application/ibe-key-request+xml":{source:"iana",compressible:true},"application/ibe-pkg-reply+xml":{source:"iana",compressible:true},"application/ibe-pp-data":{source:"iana"},"application/iges":{source:"iana"},"application/im-iscomposing+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/index":{source:"iana"},"application/index.cmd":{source:"iana"},"application/index.obj":{source:"iana"},"application/index.response":{source:"iana"},"application/index.vnd":{source:"iana"},"application/inkml+xml":{source:"iana",compressible:true,extensions:["ink","inkml"]},"application/iotp":{source:"iana"},"application/ipfix":{source:"iana",extensions:["ipfix"]},"application/ipp":{source:"iana"},"application/isup":{source:"iana"},"application/its+xml":{source:"iana",compressible:true,extensions:["its"]},"application/java-archive":{source:"apache",compressible:false,extensions:["jar","war","ear"]},"application/java-serialized-object":{source:"apache",compressible:false,extensions:["ser"]},"application/java-vm":{source:"apache",compressible:false,extensions:["class"]},"application/javascript":{source:"iana",charset:"UTF-8",compressible:true,extensions:["js","mjs"]},"application/jf2feed+json":{source:"iana",compressible:true},"application/jose":{source:"iana"},"application/jose+json":{source:"iana",compressible:true},"application/jrd+json":{source:"iana",compressible:true},"application/jscalendar+json":{source:"iana",compressible:true},"application/json":{source:"iana",charset:"UTF-8",compressible:true,extensions:["json","map"]},"application/json-patch+json":{source:"iana",compressible:true},"application/json-seq":{source:"iana"},"application/json5":{extensions:["json5"]},"application/jsonml+json":{source:"apache",compressible:true,extensions:["jsonml"]},"application/jwk+json":{source:"iana",compressible:true},"application/jwk-set+json":{source:"iana",compressible:true},"application/jwt":{source:"iana"},"application/kpml-request+xml":{source:"iana",compressible:true},"application/kpml-response+xml":{source:"iana",compressible:true},"application/ld+json":{source:"iana",compressible:true,extensions:["jsonld"]},"application/lgr+xml":{source:"iana",compressible:true,extensions:["lgr"]},"application/link-format":{source:"iana"},"application/load-control+xml":{source:"iana",compressible:true},"application/lost+xml":{source:"iana",compressible:true,extensions:["lostxml"]},"application/lostsync+xml":{source:"iana",compressible:true},"application/lpf+zip":{source:"iana",compressible:false},"application/lxf":{source:"iana"},"application/mac-binhex40":{source:"iana",extensions:["hqx"]},"application/mac-compactpro":{source:"apache",extensions:["cpt"]},"application/macwriteii":{source:"iana"},"application/mads+xml":{source:"iana",compressible:true,extensions:["mads"]},"application/manifest+json":{source:"iana",charset:"UTF-8",compressible:true,extensions:["webmanifest"]},"application/marc":{source:"iana",extensions:["mrc"]},"application/marcxml+xml":{source:"iana",compressible:true,extensions:["mrcx"]},"application/mathematica":{source:"iana",extensions:["ma","nb","mb"]},"application/mathml+xml":{source:"iana",compressible:true,extensions:["mathml"]},"application/mathml-content+xml":{source:"iana",compressible:true},"application/mathml-presentation+xml":{source:"iana",compressible:true},"application/mbms-associated-procedure-description+xml":{source:"iana",compressible:true},"application/mbms-deregister+xml":{source:"iana",compressible:true},"application/mbms-envelope+xml":{source:"iana",compressible:true},"application/mbms-msk+xml":{source:"iana",compressible:true},"application/mbms-msk-response+xml":{source:"iana",compressible:true},"application/mbms-protection-description+xml":{source:"iana",compressible:true},"application/mbms-reception-report+xml":{source:"iana",compressible:true},"application/mbms-register+xml":{source:"iana",compressible:true},"application/mbms-register-response+xml":{source:"iana",compressible:true},"application/mbms-schedule+xml":{source:"iana",compressible:true},"application/mbms-user-service-description+xml":{source:"iana",compressible:true},"application/mbox":{source:"iana",extensions:["mbox"]},"application/media-policy-dataset+xml":{source:"iana",compressible:true,extensions:["mpf"]},"application/media_control+xml":{source:"iana",compressible:true},"application/mediaservercontrol+xml":{source:"iana",compressible:true,extensions:["mscml"]},"application/merge-patch+json":{source:"iana",compressible:true},"application/metalink+xml":{source:"apache",compressible:true,extensions:["metalink"]},"application/metalink4+xml":{source:"iana",compressible:true,extensions:["meta4"]},"application/mets+xml":{source:"iana",compressible:true,extensions:["mets"]},"application/mf4":{source:"iana"},"application/mikey":{source:"iana"},"application/mipc":{source:"iana"},"application/missing-blocks+cbor-seq":{source:"iana"},"application/mmt-aei+xml":{source:"iana",compressible:true,extensions:["maei"]},"application/mmt-usd+xml":{source:"iana",compressible:true,extensions:["musd"]},"application/mods+xml":{source:"iana",compressible:true,extensions:["mods"]},"application/moss-keys":{source:"iana"},"application/moss-signature":{source:"iana"},"application/mosskey-data":{source:"iana"},"application/mosskey-request":{source:"iana"},"application/mp21":{source:"iana",extensions:["m21","mp21"]},"application/mp4":{source:"iana",extensions:["mp4s","m4p"]},"application/mpeg4-generic":{source:"iana"},"application/mpeg4-iod":{source:"iana"},"application/mpeg4-iod-xmt":{source:"iana"},"application/mrb-consumer+xml":{source:"iana",compressible:true},"application/mrb-publish+xml":{source:"iana",compressible:true},"application/msc-ivr+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/msc-mixer+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/msword":{source:"iana",compressible:false,extensions:["doc","dot"]},"application/mud+json":{source:"iana",compressible:true},"application/multipart-core":{source:"iana"},"application/mxf":{source:"iana",extensions:["mxf"]},"application/n-quads":{source:"iana",extensions:["nq"]},"application/n-triples":{source:"iana",extensions:["nt"]},"application/nasdata":{source:"iana"},"application/news-checkgroups":{source:"iana",charset:"US-ASCII"},"application/news-groupinfo":{source:"iana",charset:"US-ASCII"},"application/news-transmission":{source:"iana"},"application/nlsml+xml":{source:"iana",compressible:true},"application/node":{source:"iana",extensions:["cjs"]},"application/nss":{source:"iana"},"application/oauth-authz-req+jwt":{source:"iana"},"application/oblivious-dns-message":{source:"iana"},"application/ocsp-request":{source:"iana"},"application/ocsp-response":{source:"iana"},"application/octet-stream":{source:"iana",compressible:false,extensions:["bin","dms","lrf","mar","so","dist","distz","pkg","bpk","dump","elc","deploy","exe","dll","deb","dmg","iso","img","msi","msp","msm","buffer"]},"application/oda":{source:"iana",extensions:["oda"]},"application/odm+xml":{source:"iana",compressible:true},"application/odx":{source:"iana"},"application/oebps-package+xml":{source:"iana",compressible:true,extensions:["opf"]},"application/ogg":{source:"iana",compressible:false,extensions:["ogx"]},"application/omdoc+xml":{source:"apache",compressible:true,extensions:["omdoc"]},"application/onenote":{source:"apache",extensions:["onetoc","onetoc2","onetmp","onepkg"]},"application/opc-nodeset+xml":{source:"iana",compressible:true},"application/oscore":{source:"iana"},"application/oxps":{source:"iana",extensions:["oxps"]},"application/p21":{source:"iana"},"application/p21+zip":{source:"iana",compressible:false},"application/p2p-overlay+xml":{source:"iana",compressible:true,extensions:["relo"]},"application/parityfec":{source:"iana"},"application/passport":{source:"iana"},"application/patch-ops-error+xml":{source:"iana",compressible:true,extensions:["xer"]},"application/pdf":{source:"iana",compressible:false,extensions:["pdf"]},"application/pdx":{source:"iana"},"application/pem-certificate-chain":{source:"iana"},"application/pgp-encrypted":{source:"iana",compressible:false,extensions:["pgp"]},"application/pgp-keys":{source:"iana",extensions:["asc"]},"application/pgp-signature":{source:"iana",extensions:["asc","sig"]},"application/pics-rules":{source:"apache",extensions:["prf"]},"application/pidf+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/pidf-diff+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/pkcs10":{source:"iana",extensions:["p10"]},"application/pkcs12":{source:"iana"},"application/pkcs7-mime":{source:"iana",extensions:["p7m","p7c"]},"application/pkcs7-signature":{source:"iana",extensions:["p7s"]},"application/pkcs8":{source:"iana",extensions:["p8"]},"application/pkcs8-encrypted":{source:"iana"},"application/pkix-attr-cert":{source:"iana",extensions:["ac"]},"application/pkix-cert":{source:"iana",extensions:["cer"]},"application/pkix-crl":{source:"iana",extensions:["crl"]},"application/pkix-pkipath":{source:"iana",extensions:["pkipath"]},"application/pkixcmp":{source:"iana",extensions:["pki"]},"application/pls+xml":{source:"iana",compressible:true,extensions:["pls"]},"application/poc-settings+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/postscript":{source:"iana",compressible:true,extensions:["ai","eps","ps"]},"application/ppsp-tracker+json":{source:"iana",compressible:true},"application/problem+json":{source:"iana",compressible:true},"application/problem+xml":{source:"iana",compressible:true},"application/provenance+xml":{source:"iana",compressible:true,extensions:["provx"]},"application/prs.alvestrand.titrax-sheet":{source:"iana"},"application/prs.cww":{source:"iana",extensions:["cww"]},"application/prs.cyn":{source:"iana",charset:"7-BIT"},"application/prs.hpub+zip":{source:"iana",compressible:false},"application/prs.nprend":{source:"iana"},"application/prs.plucker":{source:"iana"},"application/prs.rdf-xml-crypt":{source:"iana"},"application/prs.xsf+xml":{source:"iana",compressible:true},"application/pskc+xml":{source:"iana",compressible:true,extensions:["pskcxml"]},"application/pvd+json":{source:"iana",compressible:true},"application/qsig":{source:"iana"},"application/raml+yaml":{compressible:true,extensions:["raml"]},"application/raptorfec":{source:"iana"},"application/rdap+json":{source:"iana",compressible:true},"application/rdf+xml":{source:"iana",compressible:true,extensions:["rdf","owl"]},"application/reginfo+xml":{source:"iana",compressible:true,extensions:["rif"]},"application/relax-ng-compact-syntax":{source:"iana",extensions:["rnc"]},"application/remote-printing":{source:"iana"},"application/reputon+json":{source:"iana",compressible:true},"application/resource-lists+xml":{source:"iana",compressible:true,extensions:["rl"]},"application/resource-lists-diff+xml":{source:"iana",compressible:true,extensions:["rld"]},"application/rfc+xml":{source:"iana",compressible:true},"application/riscos":{source:"iana"},"application/rlmi+xml":{source:"iana",compressible:true},"application/rls-services+xml":{source:"iana",compressible:true,extensions:["rs"]},"application/route-apd+xml":{source:"iana",compressible:true,extensions:["rapd"]},"application/route-s-tsid+xml":{source:"iana",compressible:true,extensions:["sls"]},"application/route-usd+xml":{source:"iana",compressible:true,extensions:["rusd"]},"application/rpki-ghostbusters":{source:"iana",extensions:["gbr"]},"application/rpki-manifest":{source:"iana",extensions:["mft"]},"application/rpki-publication":{source:"iana"},"application/rpki-roa":{source:"iana",extensions:["roa"]},"application/rpki-updown":{source:"iana"},"application/rsd+xml":{source:"apache",compressible:true,extensions:["rsd"]},"application/rss+xml":{source:"apache",compressible:true,extensions:["rss"]},"application/rtf":{source:"iana",compressible:true,extensions:["rtf"]},"application/rtploopback":{source:"iana"},"application/rtx":{source:"iana"},"application/samlassertion+xml":{source:"iana",compressible:true},"application/samlmetadata+xml":{source:"iana",compressible:true},"application/sarif+json":{source:"iana",compressible:true},"application/sarif-external-properties+json":{source:"iana",compressible:true},"application/sbe":{source:"iana"},"application/sbml+xml":{source:"iana",compressible:true,extensions:["sbml"]},"application/scaip+xml":{source:"iana",compressible:true},"application/scim+json":{source:"iana",compressible:true},"application/scvp-cv-request":{source:"iana",extensions:["scq"]},"application/scvp-cv-response":{source:"iana",extensions:["scs"]},"application/scvp-vp-request":{source:"iana",extensions:["spq"]},"application/scvp-vp-response":{source:"iana",extensions:["spp"]},"application/sdp":{source:"iana",extensions:["sdp"]},"application/secevent+jwt":{source:"iana"},"application/senml+cbor":{source:"iana"},"application/senml+json":{source:"iana",compressible:true},"application/senml+xml":{source:"iana",compressible:true,extensions:["senmlx"]},"application/senml-etch+cbor":{source:"iana"},"application/senml-etch+json":{source:"iana",compressible:true},"application/senml-exi":{source:"iana"},"application/sensml+cbor":{source:"iana"},"application/sensml+json":{source:"iana",compressible:true},"application/sensml+xml":{source:"iana",compressible:true,extensions:["sensmlx"]},"application/sensml-exi":{source:"iana"},"application/sep+xml":{source:"iana",compressible:true},"application/sep-exi":{source:"iana"},"application/session-info":{source:"iana"},"application/set-payment":{source:"iana"},"application/set-payment-initiation":{source:"iana",extensions:["setpay"]},"application/set-registration":{source:"iana"},"application/set-registration-initiation":{source:"iana",extensions:["setreg"]},"application/sgml":{source:"iana"},"application/sgml-open-catalog":{source:"iana"},"application/shf+xml":{source:"iana",compressible:true,extensions:["shf"]},"application/sieve":{source:"iana",extensions:["siv","sieve"]},"application/simple-filter+xml":{source:"iana",compressible:true},"application/simple-message-summary":{source:"iana"},"application/simplesymbolcontainer":{source:"iana"},"application/sipc":{source:"iana"},"application/slate":{source:"iana"},"application/smil":{source:"iana"},"application/smil+xml":{source:"iana",compressible:true,extensions:["smi","smil"]},"application/smpte336m":{source:"iana"},"application/soap+fastinfoset":{source:"iana"},"application/soap+xml":{source:"iana",compressible:true},"application/sparql-query":{source:"iana",extensions:["rq"]},"application/sparql-results+xml":{source:"iana",compressible:true,extensions:["srx"]},"application/spdx+json":{source:"iana",compressible:true},"application/spirits-event+xml":{source:"iana",compressible:true},"application/sql":{source:"iana"},"application/srgs":{source:"iana",extensions:["gram"]},"application/srgs+xml":{source:"iana",compressible:true,extensions:["grxml"]},"application/sru+xml":{source:"iana",compressible:true,extensions:["sru"]},"application/ssdl+xml":{source:"apache",compressible:true,extensions:["ssdl"]},"application/ssml+xml":{source:"iana",compressible:true,extensions:["ssml"]},"application/stix+json":{source:"iana",compressible:true},"application/swid+xml":{source:"iana",compressible:true,extensions:["swidtag"]},"application/tamp-apex-update":{source:"iana"},"application/tamp-apex-update-confirm":{source:"iana"},"application/tamp-community-update":{source:"iana"},"application/tamp-community-update-confirm":{source:"iana"},"application/tamp-error":{source:"iana"},"application/tamp-sequence-adjust":{source:"iana"},"application/tamp-sequence-adjust-confirm":{source:"iana"},"application/tamp-status-query":{source:"iana"},"application/tamp-status-response":{source:"iana"},"application/tamp-update":{source:"iana"},"application/tamp-update-confirm":{source:"iana"},"application/tar":{compressible:true},"application/taxii+json":{source:"iana",compressible:true},"application/td+json":{source:"iana",compressible:true},"application/tei+xml":{source:"iana",compressible:true,extensions:["tei","teicorpus"]},"application/tetra_isi":{source:"iana"},"application/thraud+xml":{source:"iana",compressible:true,extensions:["tfi"]},"application/timestamp-query":{source:"iana"},"application/timestamp-reply":{source:"iana"},"application/timestamped-data":{source:"iana",extensions:["tsd"]},"application/tlsrpt+gzip":{source:"iana"},"application/tlsrpt+json":{source:"iana",compressible:true},"application/tnauthlist":{source:"iana"},"application/token-introspection+jwt":{source:"iana"},"application/toml":{compressible:true,extensions:["toml"]},"application/trickle-ice-sdpfrag":{source:"iana"},"application/trig":{source:"iana",extensions:["trig"]},"application/ttml+xml":{source:"iana",compressible:true,extensions:["ttml"]},"application/tve-trigger":{source:"iana"},"application/tzif":{source:"iana"},"application/tzif-leap":{source:"iana"},"application/ubjson":{compressible:false,extensions:["ubj"]},"application/ulpfec":{source:"iana"},"application/urc-grpsheet+xml":{source:"iana",compressible:true},"application/urc-ressheet+xml":{source:"iana",compressible:true,extensions:["rsheet"]},"application/urc-targetdesc+xml":{source:"iana",compressible:true,extensions:["td"]},"application/urc-uisocketdesc+xml":{source:"iana",compressible:true},"application/vcard+json":{source:"iana",compressible:true},"application/vcard+xml":{source:"iana",compressible:true},"application/vemmi":{source:"iana"},"application/vividence.scriptfile":{source:"apache"},"application/vnd.1000minds.decision-model+xml":{source:"iana",compressible:true,extensions:["1km"]},"application/vnd.3gpp-prose+xml":{source:"iana",compressible:true},"application/vnd.3gpp-prose-pc3ch+xml":{source:"iana",compressible:true},"application/vnd.3gpp-v2x-local-service-information":{source:"iana"},"application/vnd.3gpp.5gnas":{source:"iana"},"application/vnd.3gpp.access-transfer-events+xml":{source:"iana",compressible:true},"application/vnd.3gpp.bsf+xml":{source:"iana",compressible:true},"application/vnd.3gpp.gmop+xml":{source:"iana",compressible:true},"application/vnd.3gpp.gtpc":{source:"iana"},"application/vnd.3gpp.interworking-data":{source:"iana"},"application/vnd.3gpp.lpp":{source:"iana"},"application/vnd.3gpp.mc-signalling-ear":{source:"iana"},"application/vnd.3gpp.mcdata-affiliation-command+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcdata-info+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcdata-payload":{source:"iana"},"application/vnd.3gpp.mcdata-service-config+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcdata-signalling":{source:"iana"},"application/vnd.3gpp.mcdata-ue-config+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcdata-user-profile+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcptt-affiliation-command+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcptt-floor-request+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcptt-info+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcptt-location-info+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcptt-mbms-usage-info+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcptt-service-config+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcptt-signed+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcptt-ue-config+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcptt-ue-init-config+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcptt-user-profile+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcvideo-affiliation-command+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcvideo-affiliation-info+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcvideo-info+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcvideo-location-info+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcvideo-mbms-usage-info+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcvideo-service-config+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcvideo-transmission-request+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcvideo-ue-config+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mcvideo-user-profile+xml":{source:"iana",compressible:true},"application/vnd.3gpp.mid-call+xml":{source:"iana",compressible:true},"application/vnd.3gpp.ngap":{source:"iana"},"application/vnd.3gpp.pfcp":{source:"iana"},"application/vnd.3gpp.pic-bw-large":{source:"iana",extensions:["plb"]},"application/vnd.3gpp.pic-bw-small":{source:"iana",extensions:["psb"]},"application/vnd.3gpp.pic-bw-var":{source:"iana",extensions:["pvb"]},"application/vnd.3gpp.s1ap":{source:"iana"},"application/vnd.3gpp.sms":{source:"iana"},"application/vnd.3gpp.sms+xml":{source:"iana",compressible:true},"application/vnd.3gpp.srvcc-ext+xml":{source:"iana",compressible:true},"application/vnd.3gpp.srvcc-info+xml":{source:"iana",compressible:true},"application/vnd.3gpp.state-and-event-info+xml":{source:"iana",compressible:true},"application/vnd.3gpp.ussd+xml":{source:"iana",compressible:true},"application/vnd.3gpp2.bcmcsinfo+xml":{source:"iana",compressible:true},"application/vnd.3gpp2.sms":{source:"iana"},"application/vnd.3gpp2.tcap":{source:"iana",extensions:["tcap"]},"application/vnd.3lightssoftware.imagescal":{source:"iana"},"application/vnd.3m.post-it-notes":{source:"iana",extensions:["pwn"]},"application/vnd.accpac.simply.aso":{source:"iana",extensions:["aso"]},"application/vnd.accpac.simply.imp":{source:"iana",extensions:["imp"]},"application/vnd.acucobol":{source:"iana",extensions:["acu"]},"application/vnd.acucorp":{source:"iana",extensions:["atc","acutc"]},"application/vnd.adobe.air-application-installer-package+zip":{source:"apache",compressible:false,extensions:["air"]},"application/vnd.adobe.flash.movie":{source:"iana"},"application/vnd.adobe.formscentral.fcdt":{source:"iana",extensions:["fcdt"]},"application/vnd.adobe.fxp":{source:"iana",extensions:["fxp","fxpl"]},"application/vnd.adobe.partial-upload":{source:"iana"},"application/vnd.adobe.xdp+xml":{source:"iana",compressible:true,extensions:["xdp"]},"application/vnd.adobe.xfdf":{source:"iana",extensions:["xfdf"]},"application/vnd.aether.imp":{source:"iana"},"application/vnd.afpc.afplinedata":{source:"iana"},"application/vnd.afpc.afplinedata-pagedef":{source:"iana"},"application/vnd.afpc.cmoca-cmresource":{source:"iana"},"application/vnd.afpc.foca-charset":{source:"iana"},"application/vnd.afpc.foca-codedfont":{source:"iana"},"application/vnd.afpc.foca-codepage":{source:"iana"},"application/vnd.afpc.modca":{source:"iana"},"application/vnd.afpc.modca-cmtable":{source:"iana"},"application/vnd.afpc.modca-formdef":{source:"iana"},"application/vnd.afpc.modca-mediummap":{source:"iana"},"application/vnd.afpc.modca-objectcontainer":{source:"iana"},"application/vnd.afpc.modca-overlay":{source:"iana"},"application/vnd.afpc.modca-pagesegment":{source:"iana"},"application/vnd.age":{source:"iana",extensions:["age"]},"application/vnd.ah-barcode":{source:"iana"},"application/vnd.ahead.space":{source:"iana",extensions:["ahead"]},"application/vnd.airzip.filesecure.azf":{source:"iana",extensions:["azf"]},"application/vnd.airzip.filesecure.azs":{source:"iana",extensions:["azs"]},"application/vnd.amadeus+json":{source:"iana",compressible:true},"application/vnd.amazon.ebook":{source:"apache",extensions:["azw"]},"application/vnd.amazon.mobi8-ebook":{source:"iana"},"application/vnd.americandynamics.acc":{source:"iana",extensions:["acc"]},"application/vnd.amiga.ami":{source:"iana",extensions:["ami"]},"application/vnd.amundsen.maze+xml":{source:"iana",compressible:true},"application/vnd.android.ota":{source:"iana"},"application/vnd.android.package-archive":{source:"apache",compressible:false,extensions:["apk"]},"application/vnd.anki":{source:"iana"},"application/vnd.anser-web-certificate-issue-initiation":{source:"iana",extensions:["cii"]},"application/vnd.anser-web-funds-transfer-initiation":{source:"apache",extensions:["fti"]},"application/vnd.antix.game-component":{source:"iana",extensions:["atx"]},"application/vnd.apache.arrow.file":{source:"iana"},"application/vnd.apache.arrow.stream":{source:"iana"},"application/vnd.apache.thrift.binary":{source:"iana"},"application/vnd.apache.thrift.compact":{source:"iana"},"application/vnd.apache.thrift.json":{source:"iana"},"application/vnd.api+json":{source:"iana",compressible:true},"application/vnd.aplextor.warrp+json":{source:"iana",compressible:true},"application/vnd.apothekende.reservation+json":{source:"iana",compressible:true},"application/vnd.apple.installer+xml":{source:"iana",compressible:true,extensions:["mpkg"]},"application/vnd.apple.keynote":{source:"iana",extensions:["key"]},"application/vnd.apple.mpegurl":{source:"iana",extensions:["m3u8"]},"application/vnd.apple.numbers":{source:"iana",extensions:["numbers"]},"application/vnd.apple.pages":{source:"iana",extensions:["pages"]},"application/vnd.apple.pkpass":{compressible:false,extensions:["pkpass"]},"application/vnd.arastra.swi":{source:"iana"},"application/vnd.aristanetworks.swi":{source:"iana",extensions:["swi"]},"application/vnd.artisan+json":{source:"iana",compressible:true},"application/vnd.artsquare":{source:"iana"},"application/vnd.astraea-software.iota":{source:"iana",extensions:["iota"]},"application/vnd.audiograph":{source:"iana",extensions:["aep"]},"application/vnd.autopackage":{source:"iana"},"application/vnd.avalon+json":{source:"iana",compressible:true},"application/vnd.avistar+xml":{source:"iana",compressible:true},"application/vnd.balsamiq.bmml+xml":{source:"iana",compressible:true,extensions:["bmml"]},"application/vnd.balsamiq.bmpr":{source:"iana"},"application/vnd.banana-accounting":{source:"iana"},"application/vnd.bbf.usp.error":{source:"iana"},"application/vnd.bbf.usp.msg":{source:"iana"},"application/vnd.bbf.usp.msg+json":{source:"iana",compressible:true},"application/vnd.bekitzur-stech+json":{source:"iana",compressible:true},"application/vnd.bint.med-content":{source:"iana"},"application/vnd.biopax.rdf+xml":{source:"iana",compressible:true},"application/vnd.blink-idb-value-wrapper":{source:"iana"},"application/vnd.blueice.multipass":{source:"iana",extensions:["mpm"]},"application/vnd.bluetooth.ep.oob":{source:"iana"},"application/vnd.bluetooth.le.oob":{source:"iana"},"application/vnd.bmi":{source:"iana",extensions:["bmi"]},"application/vnd.bpf":{source:"iana"},"application/vnd.bpf3":{source:"iana"},"application/vnd.businessobjects":{source:"iana",extensions:["rep"]},"application/vnd.byu.uapi+json":{source:"iana",compressible:true},"application/vnd.cab-jscript":{source:"iana"},"application/vnd.canon-cpdl":{source:"iana"},"application/vnd.canon-lips":{source:"iana"},"application/vnd.capasystems-pg+json":{source:"iana",compressible:true},"application/vnd.cendio.thinlinc.clientconf":{source:"iana"},"application/vnd.century-systems.tcp_stream":{source:"iana"},"application/vnd.chemdraw+xml":{source:"iana",compressible:true,extensions:["cdxml"]},"application/vnd.chess-pgn":{source:"iana"},"application/vnd.chipnuts.karaoke-mmd":{source:"iana",extensions:["mmd"]},"application/vnd.ciedi":{source:"iana"},"application/vnd.cinderella":{source:"iana",extensions:["cdy"]},"application/vnd.cirpack.isdn-ext":{source:"iana"},"application/vnd.citationstyles.style+xml":{source:"iana",compressible:true,extensions:["csl"]},"application/vnd.claymore":{source:"iana",extensions:["cla"]},"application/vnd.cloanto.rp9":{source:"iana",extensions:["rp9"]},"application/vnd.clonk.c4group":{source:"iana",extensions:["c4g","c4d","c4f","c4p","c4u"]},"application/vnd.cluetrust.cartomobile-config":{source:"iana",extensions:["c11amc"]},"application/vnd.cluetrust.cartomobile-config-pkg":{source:"iana",extensions:["c11amz"]},"application/vnd.coffeescript":{source:"iana"},"application/vnd.collabio.xodocuments.document":{source:"iana"},"application/vnd.collabio.xodocuments.document-template":{source:"iana"},"application/vnd.collabio.xodocuments.presentation":{source:"iana"},"application/vnd.collabio.xodocuments.presentation-template":{source:"iana"},"application/vnd.collabio.xodocuments.spreadsheet":{source:"iana"},"application/vnd.collabio.xodocuments.spreadsheet-template":{source:"iana"},"application/vnd.collection+json":{source:"iana",compressible:true},"application/vnd.collection.doc+json":{source:"iana",compressible:true},"application/vnd.collection.next+json":{source:"iana",compressible:true},"application/vnd.comicbook+zip":{source:"iana",compressible:false},"application/vnd.comicbook-rar":{source:"iana"},"application/vnd.commerce-battelle":{source:"iana"},"application/vnd.commonspace":{source:"iana",extensions:["csp"]},"application/vnd.contact.cmsg":{source:"iana",extensions:["cdbcmsg"]},"application/vnd.coreos.ignition+json":{source:"iana",compressible:true},"application/vnd.cosmocaller":{source:"iana",extensions:["cmc"]},"application/vnd.crick.clicker":{source:"iana",extensions:["clkx"]},"application/vnd.crick.clicker.keyboard":{source:"iana",extensions:["clkk"]},"application/vnd.crick.clicker.palette":{source:"iana",extensions:["clkp"]},"application/vnd.crick.clicker.template":{source:"iana",extensions:["clkt"]},"application/vnd.crick.clicker.wordbank":{source:"iana",extensions:["clkw"]},"application/vnd.criticaltools.wbs+xml":{source:"iana",compressible:true,extensions:["wbs"]},"application/vnd.cryptii.pipe+json":{source:"iana",compressible:true},"application/vnd.crypto-shade-file":{source:"iana"},"application/vnd.cryptomator.encrypted":{source:"iana"},"application/vnd.cryptomator.vault":{source:"iana"},"application/vnd.ctc-posml":{source:"iana",extensions:["pml"]},"application/vnd.ctct.ws+xml":{source:"iana",compressible:true},"application/vnd.cups-pdf":{source:"iana"},"application/vnd.cups-postscript":{source:"iana"},"application/vnd.cups-ppd":{source:"iana",extensions:["ppd"]},"application/vnd.cups-raster":{source:"iana"},"application/vnd.cups-raw":{source:"iana"},"application/vnd.curl":{source:"iana"},"application/vnd.curl.car":{source:"apache",extensions:["car"]},"application/vnd.curl.pcurl":{source:"apache",extensions:["pcurl"]},"application/vnd.cyan.dean.root+xml":{source:"iana",compressible:true},"application/vnd.cybank":{source:"iana"},"application/vnd.cyclonedx+json":{source:"iana",compressible:true},"application/vnd.cyclonedx+xml":{source:"iana",compressible:true},"application/vnd.d2l.coursepackage1p0+zip":{source:"iana",compressible:false},"application/vnd.d3m-dataset":{source:"iana"},"application/vnd.d3m-problem":{source:"iana"},"application/vnd.dart":{source:"iana",compressible:true,extensions:["dart"]},"application/vnd.data-vision.rdz":{source:"iana",extensions:["rdz"]},"application/vnd.datapackage+json":{source:"iana",compressible:true},"application/vnd.dataresource+json":{source:"iana",compressible:true},"application/vnd.dbf":{source:"iana",extensions:["dbf"]},"application/vnd.debian.binary-package":{source:"iana"},"application/vnd.dece.data":{source:"iana",extensions:["uvf","uvvf","uvd","uvvd"]},"application/vnd.dece.ttml+xml":{source:"iana",compressible:true,extensions:["uvt","uvvt"]},"application/vnd.dece.unspecified":{source:"iana",extensions:["uvx","uvvx"]},"application/vnd.dece.zip":{source:"iana",extensions:["uvz","uvvz"]},"application/vnd.denovo.fcselayout-link":{source:"iana",extensions:["fe_launch"]},"application/vnd.desmume.movie":{source:"iana"},"application/vnd.dir-bi.plate-dl-nosuffix":{source:"iana"},"application/vnd.dm.delegation+xml":{source:"iana",compressible:true},"application/vnd.dna":{source:"iana",extensions:["dna"]},"application/vnd.document+json":{source:"iana",compressible:true},"application/vnd.dolby.mlp":{source:"apache",extensions:["mlp"]},"application/vnd.dolby.mobile.1":{source:"iana"},"application/vnd.dolby.mobile.2":{source:"iana"},"application/vnd.doremir.scorecloud-binary-document":{source:"iana"},"application/vnd.dpgraph":{source:"iana",extensions:["dpg"]},"application/vnd.dreamfactory":{source:"iana",extensions:["dfac"]},"application/vnd.drive+json":{source:"iana",compressible:true},"application/vnd.ds-keypoint":{source:"apache",extensions:["kpxx"]},"application/vnd.dtg.local":{source:"iana"},"application/vnd.dtg.local.flash":{source:"iana"},"application/vnd.dtg.local.html":{source:"iana"},"application/vnd.dvb.ait":{source:"iana",extensions:["ait"]},"application/vnd.dvb.dvbisl+xml":{source:"iana",compressible:true},"application/vnd.dvb.dvbj":{source:"iana"},"application/vnd.dvb.esgcontainer":{source:"iana"},"application/vnd.dvb.ipdcdftnotifaccess":{source:"iana"},"application/vnd.dvb.ipdcesgaccess":{source:"iana"},"application/vnd.dvb.ipdcesgaccess2":{source:"iana"},"application/vnd.dvb.ipdcesgpdd":{source:"iana"},"application/vnd.dvb.ipdcroaming":{source:"iana"},"application/vnd.dvb.iptv.alfec-base":{source:"iana"},"application/vnd.dvb.iptv.alfec-enhancement":{source:"iana"},"application/vnd.dvb.notif-aggregate-root+xml":{source:"iana",compressible:true},"application/vnd.dvb.notif-container+xml":{source:"iana",compressible:true},"application/vnd.dvb.notif-generic+xml":{source:"iana",compressible:true},"application/vnd.dvb.notif-ia-msglist+xml":{source:"iana",compressible:true},"application/vnd.dvb.notif-ia-registration-request+xml":{source:"iana",compressible:true},"application/vnd.dvb.notif-ia-registration-response+xml":{source:"iana",compressible:true},"application/vnd.dvb.notif-init+xml":{source:"iana",compressible:true},"application/vnd.dvb.pfr":{source:"iana"},"application/vnd.dvb.service":{source:"iana",extensions:["svc"]},"application/vnd.dxr":{source:"iana"},"application/vnd.dynageo":{source:"iana",extensions:["geo"]},"application/vnd.dzr":{source:"iana"},"application/vnd.easykaraoke.cdgdownload":{source:"iana"},"application/vnd.ecdis-update":{source:"iana"},"application/vnd.ecip.rlp":{source:"iana"},"application/vnd.eclipse.ditto+json":{source:"iana",compressible:true},"application/vnd.ecowin.chart":{source:"iana",extensions:["mag"]},"application/vnd.ecowin.filerequest":{source:"iana"},"application/vnd.ecowin.fileupdate":{source:"iana"},"application/vnd.ecowin.series":{source:"iana"},"application/vnd.ecowin.seriesrequest":{source:"iana"},"application/vnd.ecowin.seriesupdate":{source:"iana"},"application/vnd.efi.img":{source:"iana"},"application/vnd.efi.iso":{source:"iana"},"application/vnd.emclient.accessrequest+xml":{source:"iana",compressible:true},"application/vnd.enliven":{source:"iana",extensions:["nml"]},"application/vnd.enphase.envoy":{source:"iana"},"application/vnd.eprints.data+xml":{source:"iana",compressible:true},"application/vnd.epson.esf":{source:"iana",extensions:["esf"]},"application/vnd.epson.msf":{source:"iana",extensions:["msf"]},"application/vnd.epson.quickanime":{source:"iana",extensions:["qam"]},"application/vnd.epson.salt":{source:"iana",extensions:["slt"]},"application/vnd.epson.ssf":{source:"iana",extensions:["ssf"]},"application/vnd.ericsson.quickcall":{source:"iana"},"application/vnd.espass-espass+zip":{source:"iana",compressible:false},"application/vnd.eszigno3+xml":{source:"iana",compressible:true,extensions:["es3","et3"]},"application/vnd.etsi.aoc+xml":{source:"iana",compressible:true},"application/vnd.etsi.asic-e+zip":{source:"iana",compressible:false},"application/vnd.etsi.asic-s+zip":{source:"iana",compressible:false},"application/vnd.etsi.cug+xml":{source:"iana",compressible:true},"application/vnd.etsi.iptvcommand+xml":{source:"iana",compressible:true},"application/vnd.etsi.iptvdiscovery+xml":{source:"iana",compressible:true},"application/vnd.etsi.iptvprofile+xml":{source:"iana",compressible:true},"application/vnd.etsi.iptvsad-bc+xml":{source:"iana",compressible:true},"application/vnd.etsi.iptvsad-cod+xml":{source:"iana",compressible:true},"application/vnd.etsi.iptvsad-npvr+xml":{source:"iana",compressible:true},"application/vnd.etsi.iptvservice+xml":{source:"iana",compressible:true},"application/vnd.etsi.iptvsync+xml":{source:"iana",compressible:true},"application/vnd.etsi.iptvueprofile+xml":{source:"iana",compressible:true},"application/vnd.etsi.mcid+xml":{source:"iana",compressible:true},"application/vnd.etsi.mheg5":{source:"iana"},"application/vnd.etsi.overload-control-policy-dataset+xml":{source:"iana",compressible:true},"application/vnd.etsi.pstn+xml":{source:"iana",compressible:true},"application/vnd.etsi.sci+xml":{source:"iana",compressible:true},"application/vnd.etsi.simservs+xml":{source:"iana",compressible:true},"application/vnd.etsi.timestamp-token":{source:"iana"},"application/vnd.etsi.tsl+xml":{source:"iana",compressible:true},"application/vnd.etsi.tsl.der":{source:"iana"},"application/vnd.eu.kasparian.car+json":{source:"iana",compressible:true},"application/vnd.eudora.data":{source:"iana"},"application/vnd.evolv.ecig.profile":{source:"iana"},"application/vnd.evolv.ecig.settings":{source:"iana"},"application/vnd.evolv.ecig.theme":{source:"iana"},"application/vnd.exstream-empower+zip":{source:"iana",compressible:false},"application/vnd.exstream-package":{source:"iana"},"application/vnd.ezpix-album":{source:"iana",extensions:["ez2"]},"application/vnd.ezpix-package":{source:"iana",extensions:["ez3"]},"application/vnd.f-secure.mobile":{source:"iana"},"application/vnd.familysearch.gedcom+zip":{source:"iana",compressible:false},"application/vnd.fastcopy-disk-image":{source:"iana"},"application/vnd.fdf":{source:"iana",extensions:["fdf"]},"application/vnd.fdsn.mseed":{source:"iana",extensions:["mseed"]},"application/vnd.fdsn.seed":{source:"iana",extensions:["seed","dataless"]},"application/vnd.ffsns":{source:"iana"},"application/vnd.ficlab.flb+zip":{source:"iana",compressible:false},"application/vnd.filmit.zfc":{source:"iana"},"application/vnd.fints":{source:"iana"},"application/vnd.firemonkeys.cloudcell":{source:"iana"},"application/vnd.flographit":{source:"iana",extensions:["gph"]},"application/vnd.fluxtime.clip":{source:"iana",extensions:["ftc"]},"application/vnd.font-fontforge-sfd":{source:"iana"},"application/vnd.framemaker":{source:"iana",extensions:["fm","frame","maker","book"]},"application/vnd.frogans.fnc":{source:"iana",extensions:["fnc"]},"application/vnd.frogans.ltf":{source:"iana",extensions:["ltf"]},"application/vnd.fsc.weblaunch":{source:"iana",extensions:["fsc"]},"application/vnd.fujifilm.fb.docuworks":{source:"iana"},"application/vnd.fujifilm.fb.docuworks.binder":{source:"iana"},"application/vnd.fujifilm.fb.docuworks.container":{source:"iana"},"application/vnd.fujifilm.fb.jfi+xml":{source:"iana",compressible:true},"application/vnd.fujitsu.oasys":{source:"iana",extensions:["oas"]},"application/vnd.fujitsu.oasys2":{source:"iana",extensions:["oa2"]},"application/vnd.fujitsu.oasys3":{source:"iana",extensions:["oa3"]},"application/vnd.fujitsu.oasysgp":{source:"iana",extensions:["fg5"]},"application/vnd.fujitsu.oasysprs":{source:"iana",extensions:["bh2"]},"application/vnd.fujixerox.art-ex":{source:"iana"},"application/vnd.fujixerox.art4":{source:"iana"},"application/vnd.fujixerox.ddd":{source:"iana",extensions:["ddd"]},"application/vnd.fujixerox.docuworks":{source:"iana",extensions:["xdw"]},"application/vnd.fujixerox.docuworks.binder":{source:"iana",extensions:["xbd"]},"application/vnd.fujixerox.docuworks.container":{source:"iana"},"application/vnd.fujixerox.hbpl":{source:"iana"},"application/vnd.fut-misnet":{source:"iana"},"application/vnd.futoin+cbor":{source:"iana"},"application/vnd.futoin+json":{source:"iana",compressible:true},"application/vnd.fuzzysheet":{source:"iana",extensions:["fzs"]},"application/vnd.genomatix.tuxedo":{source:"iana",extensions:["txd"]},"application/vnd.gentics.grd+json":{source:"iana",compressible:true},"application/vnd.geo+json":{source:"iana",compressible:true},"application/vnd.geocube+xml":{source:"iana",compressible:true},"application/vnd.geogebra.file":{source:"iana",extensions:["ggb"]},"application/vnd.geogebra.slides":{source:"iana"},"application/vnd.geogebra.tool":{source:"iana",extensions:["ggt"]},"application/vnd.geometry-explorer":{source:"iana",extensions:["gex","gre"]},"application/vnd.geonext":{source:"iana",extensions:["gxt"]},"application/vnd.geoplan":{source:"iana",extensions:["g2w"]},"application/vnd.geospace":{source:"iana",extensions:["g3w"]},"application/vnd.gerber":{source:"iana"},"application/vnd.globalplatform.card-content-mgt":{source:"iana"},"application/vnd.globalplatform.card-content-mgt-response":{source:"iana"},"application/vnd.gmx":{source:"iana",extensions:["gmx"]},"application/vnd.google-apps.document":{compressible:false,extensions:["gdoc"]},"application/vnd.google-apps.presentation":{compressible:false,extensions:["gslides"]},"application/vnd.google-apps.spreadsheet":{compressible:false,extensions:["gsheet"]},"application/vnd.google-earth.kml+xml":{source:"iana",compressible:true,extensions:["kml"]},"application/vnd.google-earth.kmz":{source:"iana",compressible:false,extensions:["kmz"]},"application/vnd.gov.sk.e-form+xml":{source:"iana",compressible:true},"application/vnd.gov.sk.e-form+zip":{source:"iana",compressible:false},"application/vnd.gov.sk.xmldatacontainer+xml":{source:"iana",compressible:true},"application/vnd.grafeq":{source:"iana",extensions:["gqf","gqs"]},"application/vnd.gridmp":{source:"iana"},"application/vnd.groove-account":{source:"iana",extensions:["gac"]},"application/vnd.groove-help":{source:"iana",extensions:["ghf"]},"application/vnd.groove-identity-message":{source:"iana",extensions:["gim"]},"application/vnd.groove-injector":{source:"iana",extensions:["grv"]},"application/vnd.groove-tool-message":{source:"iana",extensions:["gtm"]},"application/vnd.groove-tool-template":{source:"iana",extensions:["tpl"]},"application/vnd.groove-vcard":{source:"iana",extensions:["vcg"]},"application/vnd.hal+json":{source:"iana",compressible:true},"application/vnd.hal+xml":{source:"iana",compressible:true,extensions:["hal"]},"application/vnd.handheld-entertainment+xml":{source:"iana",compressible:true,extensions:["zmm"]},"application/vnd.hbci":{source:"iana",extensions:["hbci"]},"application/vnd.hc+json":{source:"iana",compressible:true},"application/vnd.hcl-bireports":{source:"iana"},"application/vnd.hdt":{source:"iana"},"application/vnd.heroku+json":{source:"iana",compressible:true},"application/vnd.hhe.lesson-player":{source:"iana",extensions:["les"]},"application/vnd.hl7cda+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/vnd.hl7v2+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/vnd.hp-hpgl":{source:"iana",extensions:["hpgl"]},"application/vnd.hp-hpid":{source:"iana",extensions:["hpid"]},"application/vnd.hp-hps":{source:"iana",extensions:["hps"]},"application/vnd.hp-jlyt":{source:"iana",extensions:["jlt"]},"application/vnd.hp-pcl":{source:"iana",extensions:["pcl"]},"application/vnd.hp-pclxl":{source:"iana",extensions:["pclxl"]},"application/vnd.httphone":{source:"iana"},"application/vnd.hydrostatix.sof-data":{source:"iana",extensions:["sfd-hdstx"]},"application/vnd.hyper+json":{source:"iana",compressible:true},"application/vnd.hyper-item+json":{source:"iana",compressible:true},"application/vnd.hyperdrive+json":{source:"iana",compressible:true},"application/vnd.hzn-3d-crossword":{source:"iana"},"application/vnd.ibm.afplinedata":{source:"iana"},"application/vnd.ibm.electronic-media":{source:"iana"},"application/vnd.ibm.minipay":{source:"iana",extensions:["mpy"]},"application/vnd.ibm.modcap":{source:"iana",extensions:["afp","listafp","list3820"]},"application/vnd.ibm.rights-management":{source:"iana",extensions:["irm"]},"application/vnd.ibm.secure-container":{source:"iana",extensions:["sc"]},"application/vnd.iccprofile":{source:"iana",extensions:["icc","icm"]},"application/vnd.ieee.1905":{source:"iana"},"application/vnd.igloader":{source:"iana",extensions:["igl"]},"application/vnd.imagemeter.folder+zip":{source:"iana",compressible:false},"application/vnd.imagemeter.image+zip":{source:"iana",compressible:false},"application/vnd.immervision-ivp":{source:"iana",extensions:["ivp"]},"application/vnd.immervision-ivu":{source:"iana",extensions:["ivu"]},"application/vnd.ims.imsccv1p1":{source:"iana"},"application/vnd.ims.imsccv1p2":{source:"iana"},"application/vnd.ims.imsccv1p3":{source:"iana"},"application/vnd.ims.lis.v2.result+json":{source:"iana",compressible:true},"application/vnd.ims.lti.v2.toolconsumerprofile+json":{source:"iana",compressible:true},"application/vnd.ims.lti.v2.toolproxy+json":{source:"iana",compressible:true},"application/vnd.ims.lti.v2.toolproxy.id+json":{source:"iana",compressible:true},"application/vnd.ims.lti.v2.toolsettings+json":{source:"iana",compressible:true},"application/vnd.ims.lti.v2.toolsettings.simple+json":{source:"iana",compressible:true},"application/vnd.informedcontrol.rms+xml":{source:"iana",compressible:true},"application/vnd.informix-visionary":{source:"iana"},"application/vnd.infotech.project":{source:"iana"},"application/vnd.infotech.project+xml":{source:"iana",compressible:true},"application/vnd.innopath.wamp.notification":{source:"iana"},"application/vnd.insors.igm":{source:"iana",extensions:["igm"]},"application/vnd.intercon.formnet":{source:"iana",extensions:["xpw","xpx"]},"application/vnd.intergeo":{source:"iana",extensions:["i2g"]},"application/vnd.intertrust.digibox":{source:"iana"},"application/vnd.intertrust.nncp":{source:"iana"},"application/vnd.intu.qbo":{source:"iana",extensions:["qbo"]},"application/vnd.intu.qfx":{source:"iana",extensions:["qfx"]},"application/vnd.iptc.g2.catalogitem+xml":{source:"iana",compressible:true},"application/vnd.iptc.g2.conceptitem+xml":{source:"iana",compressible:true},"application/vnd.iptc.g2.knowledgeitem+xml":{source:"iana",compressible:true},"application/vnd.iptc.g2.newsitem+xml":{source:"iana",compressible:true},"application/vnd.iptc.g2.newsmessage+xml":{source:"iana",compressible:true},"application/vnd.iptc.g2.packageitem+xml":{source:"iana",compressible:true},"application/vnd.iptc.g2.planningitem+xml":{source:"iana",compressible:true},"application/vnd.ipunplugged.rcprofile":{source:"iana",extensions:["rcprofile"]},"application/vnd.irepository.package+xml":{source:"iana",compressible:true,extensions:["irp"]},"application/vnd.is-xpr":{source:"iana",extensions:["xpr"]},"application/vnd.isac.fcs":{source:"iana",extensions:["fcs"]},"application/vnd.iso11783-10+zip":{source:"iana",compressible:false},"application/vnd.jam":{source:"iana",extensions:["jam"]},"application/vnd.japannet-directory-service":{source:"iana"},"application/vnd.japannet-jpnstore-wakeup":{source:"iana"},"application/vnd.japannet-payment-wakeup":{source:"iana"},"application/vnd.japannet-registration":{source:"iana"},"application/vnd.japannet-registration-wakeup":{source:"iana"},"application/vnd.japannet-setstore-wakeup":{source:"iana"},"application/vnd.japannet-verification":{source:"iana"},"application/vnd.japannet-verification-wakeup":{source:"iana"},"application/vnd.jcp.javame.midlet-rms":{source:"iana",extensions:["rms"]},"application/vnd.jisp":{source:"iana",extensions:["jisp"]},"application/vnd.joost.joda-archive":{source:"iana",extensions:["joda"]},"application/vnd.jsk.isdn-ngn":{source:"iana"},"application/vnd.kahootz":{source:"iana",extensions:["ktz","ktr"]},"application/vnd.kde.karbon":{source:"iana",extensions:["karbon"]},"application/vnd.kde.kchart":{source:"iana",extensions:["chrt"]},"application/vnd.kde.kformula":{source:"iana",extensions:["kfo"]},"application/vnd.kde.kivio":{source:"iana",extensions:["flw"]},"application/vnd.kde.kontour":{source:"iana",extensions:["kon"]},"application/vnd.kde.kpresenter":{source:"iana",extensions:["kpr","kpt"]},"application/vnd.kde.kspread":{source:"iana",extensions:["ksp"]},"application/vnd.kde.kword":{source:"iana",extensions:["kwd","kwt"]},"application/vnd.kenameaapp":{source:"iana",extensions:["htke"]},"application/vnd.kidspiration":{source:"iana",extensions:["kia"]},"application/vnd.kinar":{source:"iana",extensions:["kne","knp"]},"application/vnd.koan":{source:"iana",extensions:["skp","skd","skt","skm"]},"application/vnd.kodak-descriptor":{source:"iana",extensions:["sse"]},"application/vnd.las":{source:"iana"},"application/vnd.las.las+json":{source:"iana",compressible:true},"application/vnd.las.las+xml":{source:"iana",compressible:true,extensions:["lasxml"]},"application/vnd.laszip":{source:"iana"},"application/vnd.leap+json":{source:"iana",compressible:true},"application/vnd.liberty-request+xml":{source:"iana",compressible:true},"application/vnd.llamagraphics.life-balance.desktop":{source:"iana",extensions:["lbd"]},"application/vnd.llamagraphics.life-balance.exchange+xml":{source:"iana",compressible:true,extensions:["lbe"]},"application/vnd.logipipe.circuit+zip":{source:"iana",compressible:false},"application/vnd.loom":{source:"iana"},"application/vnd.lotus-1-2-3":{source:"iana",extensions:["123"]},"application/vnd.lotus-approach":{source:"iana",extensions:["apr"]},"application/vnd.lotus-freelance":{source:"iana",extensions:["pre"]},"application/vnd.lotus-notes":{source:"iana",extensions:["nsf"]},"application/vnd.lotus-organizer":{source:"iana",extensions:["org"]},"application/vnd.lotus-screencam":{source:"iana",extensions:["scm"]},"application/vnd.lotus-wordpro":{source:"iana",extensions:["lwp"]},"application/vnd.macports.portpkg":{source:"iana",extensions:["portpkg"]},"application/vnd.mapbox-vector-tile":{source:"iana",extensions:["mvt"]},"application/vnd.marlin.drm.actiontoken+xml":{source:"iana",compressible:true},"application/vnd.marlin.drm.conftoken+xml":{source:"iana",compressible:true},"application/vnd.marlin.drm.license+xml":{source:"iana",compressible:true},"application/vnd.marlin.drm.mdcf":{source:"iana"},"application/vnd.mason+json":{source:"iana",compressible:true},"application/vnd.maxar.archive.3tz+zip":{source:"iana",compressible:false},"application/vnd.maxmind.maxmind-db":{source:"iana"},"application/vnd.mcd":{source:"iana",extensions:["mcd"]},"application/vnd.medcalcdata":{source:"iana",extensions:["mc1"]},"application/vnd.mediastation.cdkey":{source:"iana",extensions:["cdkey"]},"application/vnd.meridian-slingshot":{source:"iana"},"application/vnd.mfer":{source:"iana",extensions:["mwf"]},"application/vnd.mfmp":{source:"iana",extensions:["mfm"]},"application/vnd.micro+json":{source:"iana",compressible:true},"application/vnd.micrografx.flo":{source:"iana",extensions:["flo"]},"application/vnd.micrografx.igx":{source:"iana",extensions:["igx"]},"application/vnd.microsoft.portable-executable":{source:"iana"},"application/vnd.microsoft.windows.thumbnail-cache":{source:"iana"},"application/vnd.miele+json":{source:"iana",compressible:true},"application/vnd.mif":{source:"iana",extensions:["mif"]},"application/vnd.minisoft-hp3000-save":{source:"iana"},"application/vnd.mitsubishi.misty-guard.trustweb":{source:"iana"},"application/vnd.mobius.daf":{source:"iana",extensions:["daf"]},"application/vnd.mobius.dis":{source:"iana",extensions:["dis"]},"application/vnd.mobius.mbk":{source:"iana",extensions:["mbk"]},"application/vnd.mobius.mqy":{source:"iana",extensions:["mqy"]},"application/vnd.mobius.msl":{source:"iana",extensions:["msl"]},"application/vnd.mobius.plc":{source:"iana",extensions:["plc"]},"application/vnd.mobius.txf":{source:"iana",extensions:["txf"]},"application/vnd.mophun.application":{source:"iana",extensions:["mpn"]},"application/vnd.mophun.certificate":{source:"iana",extensions:["mpc"]},"application/vnd.motorola.flexsuite":{source:"iana"},"application/vnd.motorola.flexsuite.adsi":{source:"iana"},"application/vnd.motorola.flexsuite.fis":{source:"iana"},"application/vnd.motorola.flexsuite.gotap":{source:"iana"},"application/vnd.motorola.flexsuite.kmr":{source:"iana"},"application/vnd.motorola.flexsuite.ttc":{source:"iana"},"application/vnd.motorola.flexsuite.wem":{source:"iana"},"application/vnd.motorola.iprm":{source:"iana"},"application/vnd.mozilla.xul+xml":{source:"iana",compressible:true,extensions:["xul"]},"application/vnd.ms-3mfdocument":{source:"iana"},"application/vnd.ms-artgalry":{source:"iana",extensions:["cil"]},"application/vnd.ms-asf":{source:"iana"},"application/vnd.ms-cab-compressed":{source:"iana",extensions:["cab"]},"application/vnd.ms-color.iccprofile":{source:"apache"},"application/vnd.ms-excel":{source:"iana",compressible:false,extensions:["xls","xlm","xla","xlc","xlt","xlw"]},"application/vnd.ms-excel.addin.macroenabled.12":{source:"iana",extensions:["xlam"]},"application/vnd.ms-excel.sheet.binary.macroenabled.12":{source:"iana",extensions:["xlsb"]},"application/vnd.ms-excel.sheet.macroenabled.12":{source:"iana",extensions:["xlsm"]},"application/vnd.ms-excel.template.macroenabled.12":{source:"iana",extensions:["xltm"]},"application/vnd.ms-fontobject":{source:"iana",compressible:true,extensions:["eot"]},"application/vnd.ms-htmlhelp":{source:"iana",extensions:["chm"]},"application/vnd.ms-ims":{source:"iana",extensions:["ims"]},"application/vnd.ms-lrm":{source:"iana",extensions:["lrm"]},"application/vnd.ms-office.activex+xml":{source:"iana",compressible:true},"application/vnd.ms-officetheme":{source:"iana",extensions:["thmx"]},"application/vnd.ms-opentype":{source:"apache",compressible:true},"application/vnd.ms-outlook":{compressible:false,extensions:["msg"]},"application/vnd.ms-package.obfuscated-opentype":{source:"apache"},"application/vnd.ms-pki.seccat":{source:"apache",extensions:["cat"]},"application/vnd.ms-pki.stl":{source:"apache",extensions:["stl"]},"application/vnd.ms-playready.initiator+xml":{source:"iana",compressible:true},"application/vnd.ms-powerpoint":{source:"iana",compressible:false,extensions:["ppt","pps","pot"]},"application/vnd.ms-powerpoint.addin.macroenabled.12":{source:"iana",extensions:["ppam"]},"application/vnd.ms-powerpoint.presentation.macroenabled.12":{source:"iana",extensions:["pptm"]},"application/vnd.ms-powerpoint.slide.macroenabled.12":{source:"iana",extensions:["sldm"]},"application/vnd.ms-powerpoint.slideshow.macroenabled.12":{source:"iana",extensions:["ppsm"]},"application/vnd.ms-powerpoint.template.macroenabled.12":{source:"iana",extensions:["potm"]},"application/vnd.ms-printdevicecapabilities+xml":{source:"iana",compressible:true},"application/vnd.ms-printing.printticket+xml":{source:"apache",compressible:true},"application/vnd.ms-printschematicket+xml":{source:"iana",compressible:true},"application/vnd.ms-project":{source:"iana",extensions:["mpp","mpt"]},"application/vnd.ms-tnef":{source:"iana"},"application/vnd.ms-windows.devicepairing":{source:"iana"},"application/vnd.ms-windows.nwprinting.oob":{source:"iana"},"application/vnd.ms-windows.printerpairing":{source:"iana"},"application/vnd.ms-windows.wsd.oob":{source:"iana"},"application/vnd.ms-wmdrm.lic-chlg-req":{source:"iana"},"application/vnd.ms-wmdrm.lic-resp":{source:"iana"},"application/vnd.ms-wmdrm.meter-chlg-req":{source:"iana"},"application/vnd.ms-wmdrm.meter-resp":{source:"iana"},"application/vnd.ms-word.document.macroenabled.12":{source:"iana",extensions:["docm"]},"application/vnd.ms-word.template.macroenabled.12":{source:"iana",extensions:["dotm"]},"application/vnd.ms-works":{source:"iana",extensions:["wps","wks","wcm","wdb"]},"application/vnd.ms-wpl":{source:"iana",extensions:["wpl"]},"application/vnd.ms-xpsdocument":{source:"iana",compressible:false,extensions:["xps"]},"application/vnd.msa-disk-image":{source:"iana"},"application/vnd.mseq":{source:"iana",extensions:["mseq"]},"application/vnd.msign":{source:"iana"},"application/vnd.multiad.creator":{source:"iana"},"application/vnd.multiad.creator.cif":{source:"iana"},"application/vnd.music-niff":{source:"iana"},"application/vnd.musician":{source:"iana",extensions:["mus"]},"application/vnd.muvee.style":{source:"iana",extensions:["msty"]},"application/vnd.mynfc":{source:"iana",extensions:["taglet"]},"application/vnd.nacamar.ybrid+json":{source:"iana",compressible:true},"application/vnd.ncd.control":{source:"iana"},"application/vnd.ncd.reference":{source:"iana"},"application/vnd.nearst.inv+json":{source:"iana",compressible:true},"application/vnd.nebumind.line":{source:"iana"},"application/vnd.nervana":{source:"iana"},"application/vnd.netfpx":{source:"iana"},"application/vnd.neurolanguage.nlu":{source:"iana",extensions:["nlu"]},"application/vnd.nimn":{source:"iana"},"application/vnd.nintendo.nitro.rom":{source:"iana"},"application/vnd.nintendo.snes.rom":{source:"iana"},"application/vnd.nitf":{source:"iana",extensions:["ntf","nitf"]},"application/vnd.noblenet-directory":{source:"iana",extensions:["nnd"]},"application/vnd.noblenet-sealer":{source:"iana",extensions:["nns"]},"application/vnd.noblenet-web":{source:"iana",extensions:["nnw"]},"application/vnd.nokia.catalogs":{source:"iana"},"application/vnd.nokia.conml+wbxml":{source:"iana"},"application/vnd.nokia.conml+xml":{source:"iana",compressible:true},"application/vnd.nokia.iptv.config+xml":{source:"iana",compressible:true},"application/vnd.nokia.isds-radio-presets":{source:"iana"},"application/vnd.nokia.landmark+wbxml":{source:"iana"},"application/vnd.nokia.landmark+xml":{source:"iana",compressible:true},"application/vnd.nokia.landmarkcollection+xml":{source:"iana",compressible:true},"application/vnd.nokia.n-gage.ac+xml":{source:"iana",compressible:true,extensions:["ac"]},"application/vnd.nokia.n-gage.data":{source:"iana",extensions:["ngdat"]},"application/vnd.nokia.n-gage.symbian.install":{source:"iana",extensions:["n-gage"]},"application/vnd.nokia.ncd":{source:"iana"},"application/vnd.nokia.pcd+wbxml":{source:"iana"},"application/vnd.nokia.pcd+xml":{source:"iana",compressible:true},"application/vnd.nokia.radio-preset":{source:"iana",extensions:["rpst"]},"application/vnd.nokia.radio-presets":{source:"iana",extensions:["rpss"]},"application/vnd.novadigm.edm":{source:"iana",extensions:["edm"]},"application/vnd.novadigm.edx":{source:"iana",extensions:["edx"]},"application/vnd.novadigm.ext":{source:"iana",extensions:["ext"]},"application/vnd.ntt-local.content-share":{source:"iana"},"application/vnd.ntt-local.file-transfer":{source:"iana"},"application/vnd.ntt-local.ogw_remote-access":{source:"iana"},"application/vnd.ntt-local.sip-ta_remote":{source:"iana"},"application/vnd.ntt-local.sip-ta_tcp_stream":{source:"iana"},"application/vnd.oasis.opendocument.chart":{source:"iana",extensions:["odc"]},"application/vnd.oasis.opendocument.chart-template":{source:"iana",extensions:["otc"]},"application/vnd.oasis.opendocument.database":{source:"iana",extensions:["odb"]},"application/vnd.oasis.opendocument.formula":{source:"iana",extensions:["odf"]},"application/vnd.oasis.opendocument.formula-template":{source:"iana",extensions:["odft"]},"application/vnd.oasis.opendocument.graphics":{source:"iana",compressible:false,extensions:["odg"]},"application/vnd.oasis.opendocument.graphics-template":{source:"iana",extensions:["otg"]},"application/vnd.oasis.opendocument.image":{source:"iana",extensions:["odi"]},"application/vnd.oasis.opendocument.image-template":{source:"iana",extensions:["oti"]},"application/vnd.oasis.opendocument.presentation":{source:"iana",compressible:false,extensions:["odp"]},"application/vnd.oasis.opendocument.presentation-template":{source:"iana",extensions:["otp"]},"application/vnd.oasis.opendocument.spreadsheet":{source:"iana",compressible:false,extensions:["ods"]},"application/vnd.oasis.opendocument.spreadsheet-template":{source:"iana",extensions:["ots"]},"application/vnd.oasis.opendocument.text":{source:"iana",compressible:false,extensions:["odt"]},"application/vnd.oasis.opendocument.text-master":{source:"iana",extensions:["odm"]},"application/vnd.oasis.opendocument.text-template":{source:"iana",extensions:["ott"]},"application/vnd.oasis.opendocument.text-web":{source:"iana",extensions:["oth"]},"application/vnd.obn":{source:"iana"},"application/vnd.ocf+cbor":{source:"iana"},"application/vnd.oci.image.manifest.v1+json":{source:"iana",compressible:true},"application/vnd.oftn.l10n+json":{source:"iana",compressible:true},"application/vnd.oipf.contentaccessdownload+xml":{source:"iana",compressible:true},"application/vnd.oipf.contentaccessstreaming+xml":{source:"iana",compressible:true},"application/vnd.oipf.cspg-hexbinary":{source:"iana"},"application/vnd.oipf.dae.svg+xml":{source:"iana",compressible:true},"application/vnd.oipf.dae.xhtml+xml":{source:"iana",compressible:true},"application/vnd.oipf.mippvcontrolmessage+xml":{source:"iana",compressible:true},"application/vnd.oipf.pae.gem":{source:"iana"},"application/vnd.oipf.spdiscovery+xml":{source:"iana",compressible:true},"application/vnd.oipf.spdlist+xml":{source:"iana",compressible:true},"application/vnd.oipf.ueprofile+xml":{source:"iana",compressible:true},"application/vnd.oipf.userprofile+xml":{source:"iana",compressible:true},"application/vnd.olpc-sugar":{source:"iana",extensions:["xo"]},"application/vnd.oma-scws-config":{source:"iana"},"application/vnd.oma-scws-http-request":{source:"iana"},"application/vnd.oma-scws-http-response":{source:"iana"},"application/vnd.oma.bcast.associated-procedure-parameter+xml":{source:"iana",compressible:true},"application/vnd.oma.bcast.drm-trigger+xml":{source:"iana",compressible:true},"application/vnd.oma.bcast.imd+xml":{source:"iana",compressible:true},"application/vnd.oma.bcast.ltkm":{source:"iana"},"application/vnd.oma.bcast.notification+xml":{source:"iana",compressible:true},"application/vnd.oma.bcast.provisioningtrigger":{source:"iana"},"application/vnd.oma.bcast.sgboot":{source:"iana"},"application/vnd.oma.bcast.sgdd+xml":{source:"iana",compressible:true},"application/vnd.oma.bcast.sgdu":{source:"iana"},"application/vnd.oma.bcast.simple-symbol-container":{source:"iana"},"application/vnd.oma.bcast.smartcard-trigger+xml":{source:"iana",compressible:true},"application/vnd.oma.bcast.sprov+xml":{source:"iana",compressible:true},"application/vnd.oma.bcast.stkm":{source:"iana"},"application/vnd.oma.cab-address-book+xml":{source:"iana",compressible:true},"application/vnd.oma.cab-feature-handler+xml":{source:"iana",compressible:true},"application/vnd.oma.cab-pcc+xml":{source:"iana",compressible:true},"application/vnd.oma.cab-subs-invite+xml":{source:"iana",compressible:true},"application/vnd.oma.cab-user-prefs+xml":{source:"iana",compressible:true},"application/vnd.oma.dcd":{source:"iana"},"application/vnd.oma.dcdc":{source:"iana"},"application/vnd.oma.dd2+xml":{source:"iana",compressible:true,extensions:["dd2"]},"application/vnd.oma.drm.risd+xml":{source:"iana",compressible:true},"application/vnd.oma.group-usage-list+xml":{source:"iana",compressible:true},"application/vnd.oma.lwm2m+cbor":{source:"iana"},"application/vnd.oma.lwm2m+json":{source:"iana",compressible:true},"application/vnd.oma.lwm2m+tlv":{source:"iana"},"application/vnd.oma.pal+xml":{source:"iana",compressible:true},"application/vnd.oma.poc.detailed-progress-report+xml":{source:"iana",compressible:true},"application/vnd.oma.poc.final-report+xml":{source:"iana",compressible:true},"application/vnd.oma.poc.groups+xml":{source:"iana",compressible:true},"application/vnd.oma.poc.invocation-descriptor+xml":{source:"iana",compressible:true},"application/vnd.oma.poc.optimized-progress-report+xml":{source:"iana",compressible:true},"application/vnd.oma.push":{source:"iana"},"application/vnd.oma.scidm.messages+xml":{source:"iana",compressible:true},"application/vnd.oma.xcap-directory+xml":{source:"iana",compressible:true},"application/vnd.omads-email+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/vnd.omads-file+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/vnd.omads-folder+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/vnd.omaloc-supl-init":{source:"iana"},"application/vnd.onepager":{source:"iana"},"application/vnd.onepagertamp":{source:"iana"},"application/vnd.onepagertamx":{source:"iana"},"application/vnd.onepagertat":{source:"iana"},"application/vnd.onepagertatp":{source:"iana"},"application/vnd.onepagertatx":{source:"iana"},"application/vnd.openblox.game+xml":{source:"iana",compressible:true,extensions:["obgx"]},"application/vnd.openblox.game-binary":{source:"iana"},"application/vnd.openeye.oeb":{source:"iana"},"application/vnd.openofficeorg.extension":{source:"apache",extensions:["oxt"]},"application/vnd.openstreetmap.data+xml":{source:"iana",compressible:true,extensions:["osm"]},"application/vnd.opentimestamps.ots":{source:"iana"},"application/vnd.openxmlformats-officedocument.custom-properties+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.customxmlproperties+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.drawing+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.drawingml.chart+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.drawingml.chartshapes+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.drawingml.diagramcolors+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.drawingml.diagramdata+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.drawingml.diagramlayout+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.drawingml.diagramstyle+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.extended-properties+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.commentauthors+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.comments+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.handoutmaster+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.notesmaster+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.notesslide+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.presentation":{source:"iana",compressible:false,extensions:["pptx"]},"application/vnd.openxmlformats-officedocument.presentationml.presentation.main+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.presprops+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.slide":{source:"iana",extensions:["sldx"]},"application/vnd.openxmlformats-officedocument.presentationml.slide+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.slidelayout+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.slidemaster+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.slideshow":{source:"iana",extensions:["ppsx"]},"application/vnd.openxmlformats-officedocument.presentationml.slideshow.main+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.slideupdateinfo+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.tablestyles+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.tags+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.template":{source:"iana",extensions:["potx"]},"application/vnd.openxmlformats-officedocument.presentationml.template.main+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.presentationml.viewprops+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.calcchain+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.chartsheet+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.comments+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.connections+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.dialogsheet+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.externallink+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.pivotcachedefinition+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.pivotcacherecords+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.pivottable+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.querytable+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.revisionheaders+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.revisionlog+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.sharedstrings+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":{source:"iana",compressible:false,extensions:["xlsx"]},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheetmetadata+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.table+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.tablesinglecells+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.template":{source:"iana",extensions:["xltx"]},"application/vnd.openxmlformats-officedocument.spreadsheetml.template.main+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.usernames+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.volatiledependencies+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.theme+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.themeoverride+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.vmldrawing":{source:"iana"},"application/vnd.openxmlformats-officedocument.wordprocessingml.comments+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{source:"iana",compressible:false,extensions:["docx"]},"application/vnd.openxmlformats-officedocument.wordprocessingml.document.glossary+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.endnotes+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.fonttable+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.footer+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.footnotes+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.numbering+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.settings+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.template":{source:"iana",extensions:["dotx"]},"application/vnd.openxmlformats-officedocument.wordprocessingml.template.main+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-officedocument.wordprocessingml.websettings+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-package.core-properties+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-package.digital-signature-xmlsignature+xml":{source:"iana",compressible:true},"application/vnd.openxmlformats-package.relationships+xml":{source:"iana",compressible:true},"application/vnd.oracle.resource+json":{source:"iana",compressible:true},"application/vnd.orange.indata":{source:"iana"},"application/vnd.osa.netdeploy":{source:"iana"},"application/vnd.osgeo.mapguide.package":{source:"iana",extensions:["mgp"]},"application/vnd.osgi.bundle":{source:"iana"},"application/vnd.osgi.dp":{source:"iana",extensions:["dp"]},"application/vnd.osgi.subsystem":{source:"iana",extensions:["esa"]},"application/vnd.otps.ct-kip+xml":{source:"iana",compressible:true},"application/vnd.oxli.countgraph":{source:"iana"},"application/vnd.pagerduty+json":{source:"iana",compressible:true},"application/vnd.palm":{source:"iana",extensions:["pdb","pqa","oprc"]},"application/vnd.panoply":{source:"iana"},"application/vnd.paos.xml":{source:"iana"},"application/vnd.patentdive":{source:"iana"},"application/vnd.patientecommsdoc":{source:"iana"},"application/vnd.pawaafile":{source:"iana",extensions:["paw"]},"application/vnd.pcos":{source:"iana"},"application/vnd.pg.format":{source:"iana",extensions:["str"]},"application/vnd.pg.osasli":{source:"iana",extensions:["ei6"]},"application/vnd.piaccess.application-licence":{source:"iana"},"application/vnd.picsel":{source:"iana",extensions:["efif"]},"application/vnd.pmi.widget":{source:"iana",extensions:["wg"]},"application/vnd.poc.group-advertisement+xml":{source:"iana",compressible:true},"application/vnd.pocketlearn":{source:"iana",extensions:["plf"]},"application/vnd.powerbuilder6":{source:"iana",extensions:["pbd"]},"application/vnd.powerbuilder6-s":{source:"iana"},"application/vnd.powerbuilder7":{source:"iana"},"application/vnd.powerbuilder7-s":{source:"iana"},"application/vnd.powerbuilder75":{source:"iana"},"application/vnd.powerbuilder75-s":{source:"iana"},"application/vnd.preminet":{source:"iana"},"application/vnd.previewsystems.box":{source:"iana",extensions:["box"]},"application/vnd.proteus.magazine":{source:"iana",extensions:["mgz"]},"application/vnd.psfs":{source:"iana"},"application/vnd.publishare-delta-tree":{source:"iana",extensions:["qps"]},"application/vnd.pvi.ptid1":{source:"iana",extensions:["ptid"]},"application/vnd.pwg-multiplexed":{source:"iana"},"application/vnd.pwg-xhtml-print+xml":{source:"iana",compressible:true},"application/vnd.qualcomm.brew-app-res":{source:"iana"},"application/vnd.quarantainenet":{source:"iana"},"application/vnd.quark.quarkxpress":{source:"iana",extensions:["qxd","qxt","qwd","qwt","qxl","qxb"]},"application/vnd.quobject-quoxdocument":{source:"iana"},"application/vnd.radisys.moml+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-audit+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-audit-conf+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-audit-conn+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-audit-dialog+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-audit-stream+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-conf+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-dialog+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-dialog-base+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-dialog-fax-detect+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-dialog-fax-sendrecv+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-dialog-group+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-dialog-speech+xml":{source:"iana",compressible:true},"application/vnd.radisys.msml-dialog-transform+xml":{source:"iana",compressible:true},"application/vnd.rainstor.data":{source:"iana"},"application/vnd.rapid":{source:"iana"},"application/vnd.rar":{source:"iana",extensions:["rar"]},"application/vnd.realvnc.bed":{source:"iana",extensions:["bed"]},"application/vnd.recordare.musicxml":{source:"iana",extensions:["mxl"]},"application/vnd.recordare.musicxml+xml":{source:"iana",compressible:true,extensions:["musicxml"]},"application/vnd.renlearn.rlprint":{source:"iana"},"application/vnd.resilient.logic":{source:"iana"},"application/vnd.restful+json":{source:"iana",compressible:true},"application/vnd.rig.cryptonote":{source:"iana",extensions:["cryptonote"]},"application/vnd.rim.cod":{source:"apache",extensions:["cod"]},"application/vnd.rn-realmedia":{source:"apache",extensions:["rm"]},"application/vnd.rn-realmedia-vbr":{source:"apache",extensions:["rmvb"]},"application/vnd.route66.link66+xml":{source:"iana",compressible:true,extensions:["link66"]},"application/vnd.rs-274x":{source:"iana"},"application/vnd.ruckus.download":{source:"iana"},"application/vnd.s3sms":{source:"iana"},"application/vnd.sailingtracker.track":{source:"iana",extensions:["st"]},"application/vnd.sar":{source:"iana"},"application/vnd.sbm.cid":{source:"iana"},"application/vnd.sbm.mid2":{source:"iana"},"application/vnd.scribus":{source:"iana"},"application/vnd.sealed.3df":{source:"iana"},"application/vnd.sealed.csf":{source:"iana"},"application/vnd.sealed.doc":{source:"iana"},"application/vnd.sealed.eml":{source:"iana"},"application/vnd.sealed.mht":{source:"iana"},"application/vnd.sealed.net":{source:"iana"},"application/vnd.sealed.ppt":{source:"iana"},"application/vnd.sealed.tiff":{source:"iana"},"application/vnd.sealed.xls":{source:"iana"},"application/vnd.sealedmedia.softseal.html":{source:"iana"},"application/vnd.sealedmedia.softseal.pdf":{source:"iana"},"application/vnd.seemail":{source:"iana",extensions:["see"]},"application/vnd.seis+json":{source:"iana",compressible:true},"application/vnd.sema":{source:"iana",extensions:["sema"]},"application/vnd.semd":{source:"iana",extensions:["semd"]},"application/vnd.semf":{source:"iana",extensions:["semf"]},"application/vnd.shade-save-file":{source:"iana"},"application/vnd.shana.informed.formdata":{source:"iana",extensions:["ifm"]},"application/vnd.shana.informed.formtemplate":{source:"iana",extensions:["itp"]},"application/vnd.shana.informed.interchange":{source:"iana",extensions:["iif"]},"application/vnd.shana.informed.package":{source:"iana",extensions:["ipk"]},"application/vnd.shootproof+json":{source:"iana",compressible:true},"application/vnd.shopkick+json":{source:"iana",compressible:true},"application/vnd.shp":{source:"iana"},"application/vnd.shx":{source:"iana"},"application/vnd.sigrok.session":{source:"iana"},"application/vnd.simtech-mindmapper":{source:"iana",extensions:["twd","twds"]},"application/vnd.siren+json":{source:"iana",compressible:true},"application/vnd.smaf":{source:"iana",extensions:["mmf"]},"application/vnd.smart.notebook":{source:"iana"},"application/vnd.smart.teacher":{source:"iana",extensions:["teacher"]},"application/vnd.snesdev-page-table":{source:"iana"},"application/vnd.software602.filler.form+xml":{source:"iana",compressible:true,extensions:["fo"]},"application/vnd.software602.filler.form-xml-zip":{source:"iana"},"application/vnd.solent.sdkm+xml":{source:"iana",compressible:true,extensions:["sdkm","sdkd"]},"application/vnd.spotfire.dxp":{source:"iana",extensions:["dxp"]},"application/vnd.spotfire.sfs":{source:"iana",extensions:["sfs"]},"application/vnd.sqlite3":{source:"iana"},"application/vnd.sss-cod":{source:"iana"},"application/vnd.sss-dtf":{source:"iana"},"application/vnd.sss-ntf":{source:"iana"},"application/vnd.stardivision.calc":{source:"apache",extensions:["sdc"]},"application/vnd.stardivision.draw":{source:"apache",extensions:["sda"]},"application/vnd.stardivision.impress":{source:"apache",extensions:["sdd"]},"application/vnd.stardivision.math":{source:"apache",extensions:["smf"]},"application/vnd.stardivision.writer":{source:"apache",extensions:["sdw","vor"]},"application/vnd.stardivision.writer-global":{source:"apache",extensions:["sgl"]},"application/vnd.stepmania.package":{source:"iana",extensions:["smzip"]},"application/vnd.stepmania.stepchart":{source:"iana",extensions:["sm"]},"application/vnd.street-stream":{source:"iana"},"application/vnd.sun.wadl+xml":{source:"iana",compressible:true,extensions:["wadl"]},"application/vnd.sun.xml.calc":{source:"apache",extensions:["sxc"]},"application/vnd.sun.xml.calc.template":{source:"apache",extensions:["stc"]},"application/vnd.sun.xml.draw":{source:"apache",extensions:["sxd"]},"application/vnd.sun.xml.draw.template":{source:"apache",extensions:["std"]},"application/vnd.sun.xml.impress":{source:"apache",extensions:["sxi"]},"application/vnd.sun.xml.impress.template":{source:"apache",extensions:["sti"]},"application/vnd.sun.xml.math":{source:"apache",extensions:["sxm"]},"application/vnd.sun.xml.writer":{source:"apache",extensions:["sxw"]},"application/vnd.sun.xml.writer.global":{source:"apache",extensions:["sxg"]},"application/vnd.sun.xml.writer.template":{source:"apache",extensions:["stw"]},"application/vnd.sus-calendar":{source:"iana",extensions:["sus","susp"]},"application/vnd.svd":{source:"iana",extensions:["svd"]},"application/vnd.swiftview-ics":{source:"iana"},"application/vnd.sycle+xml":{source:"iana",compressible:true},"application/vnd.syft+json":{source:"iana",compressible:true},"application/vnd.symbian.install":{source:"apache",extensions:["sis","sisx"]},"application/vnd.syncml+xml":{source:"iana",charset:"UTF-8",compressible:true,extensions:["xsm"]},"application/vnd.syncml.dm+wbxml":{source:"iana",charset:"UTF-8",extensions:["bdm"]},"application/vnd.syncml.dm+xml":{source:"iana",charset:"UTF-8",compressible:true,extensions:["xdm"]},"application/vnd.syncml.dm.notification":{source:"iana"},"application/vnd.syncml.dmddf+wbxml":{source:"iana"},"application/vnd.syncml.dmddf+xml":{source:"iana",charset:"UTF-8",compressible:true,extensions:["ddf"]},"application/vnd.syncml.dmtnds+wbxml":{source:"iana"},"application/vnd.syncml.dmtnds+xml":{source:"iana",charset:"UTF-8",compressible:true},"application/vnd.syncml.ds.notification":{source:"iana"},"application/vnd.tableschema+json":{source:"iana",compressible:true},"application/vnd.tao.intent-module-archive":{source:"iana",extensions:["tao"]},"application/vnd.tcpdump.pcap":{source:"iana",extensions:["pcap","cap","dmp"]},"application/vnd.think-cell.ppttc+json":{source:"iana",compressible:true},"application/vnd.tmd.mediaflex.api+xml":{source:"iana",compressible:true},"application/vnd.tml":{source:"iana"},"application/vnd.tmobile-livetv":{source:"iana",extensions:["tmo"]},"application/vnd.tri.onesource":{source:"iana"},"application/vnd.trid.tpt":{source:"iana",extensions:["tpt"]},"application/vnd.triscape.mxs":{source:"iana",extensions:["mxs"]},"application/vnd.trueapp":{source:"iana",extensions:["tra"]},"application/vnd.truedoc":{source:"iana"},"application/vnd.ubisoft.webplayer":{source:"iana"},"application/vnd.ufdl":{source:"iana",extensions:["ufd","ufdl"]},"application/vnd.uiq.theme":{source:"iana",extensions:["utz"]},"application/vnd.umajin":{source:"iana",extensions:["umj"]},"application/vnd.unity":{source:"iana",extensions:["unityweb"]},"application/vnd.uoml+xml":{source:"iana",compressible:true,extensions:["uoml"]},"application/vnd.uplanet.alert":{source:"iana"},"application/vnd.uplanet.alert-wbxml":{source:"iana"},"application/vnd.uplanet.bearer-choice":{source:"iana"},"application/vnd.uplanet.bearer-choice-wbxml":{source:"iana"},"application/vnd.uplanet.cacheop":{source:"iana"},"application/vnd.uplanet.cacheop-wbxml":{source:"iana"},"application/vnd.uplanet.channel":{source:"iana"},"application/vnd.uplanet.channel-wbxml":{source:"iana"},"application/vnd.uplanet.list":{source:"iana"},"application/vnd.uplanet.list-wbxml":{source:"iana"},"application/vnd.uplanet.listcmd":{source:"iana"},"application/vnd.uplanet.listcmd-wbxml":{source:"iana"},"application/vnd.uplanet.signal":{source:"iana"},"application/vnd.uri-map":{source:"iana"},"application/vnd.valve.source.material":{source:"iana"},"application/vnd.vcx":{source:"iana",extensions:["vcx"]},"application/vnd.vd-study":{source:"iana"},"application/vnd.vectorworks":{source:"iana"},"application/vnd.vel+json":{source:"iana",compressible:true},"application/vnd.verimatrix.vcas":{source:"iana"},"application/vnd.veritone.aion+json":{source:"iana",compressible:true},"application/vnd.veryant.thin":{source:"iana"},"application/vnd.ves.encrypted":{source:"iana"},"application/vnd.vidsoft.vidconference":{source:"iana"},"application/vnd.visio":{source:"iana",extensions:["vsd","vst","vss","vsw"]},"application/vnd.visionary":{source:"iana",extensions:["vis"]},"application/vnd.vividence.scriptfile":{source:"iana"},"application/vnd.vsf":{source:"iana",extensions:["vsf"]},"application/vnd.wap.sic":{source:"iana"},"application/vnd.wap.slc":{source:"iana"},"application/vnd.wap.wbxml":{source:"iana",charset:"UTF-8",extensions:["wbxml"]},"application/vnd.wap.wmlc":{source:"iana",extensions:["wmlc"]},"application/vnd.wap.wmlscriptc":{source:"iana",extensions:["wmlsc"]},"application/vnd.webturbo":{source:"iana",extensions:["wtb"]},"application/vnd.wfa.dpp":{source:"iana"},"application/vnd.wfa.p2p":{source:"iana"},"application/vnd.wfa.wsc":{source:"iana"},"application/vnd.windows.devicepairing":{source:"iana"},"application/vnd.wmc":{source:"iana"},"application/vnd.wmf.bootstrap":{source:"iana"},"application/vnd.wolfram.mathematica":{source:"iana"},"application/vnd.wolfram.mathematica.package":{source:"iana"},"application/vnd.wolfram.player":{source:"iana",extensions:["nbp"]},"application/vnd.wordperfect":{source:"iana",extensions:["wpd"]},"application/vnd.wqd":{source:"iana",extensions:["wqd"]},"application/vnd.wrq-hp3000-labelled":{source:"iana"},"application/vnd.wt.stf":{source:"iana",extensions:["stf"]},"application/vnd.wv.csp+wbxml":{source:"iana"},"application/vnd.wv.csp+xml":{source:"iana",compressible:true},"application/vnd.wv.ssp+xml":{source:"iana",compressible:true},"application/vnd.xacml+json":{source:"iana",compressible:true},"application/vnd.xara":{source:"iana",extensions:["xar"]},"application/vnd.xfdl":{source:"iana",extensions:["xfdl"]},"application/vnd.xfdl.webform":{source:"iana"},"application/vnd.xmi+xml":{source:"iana",compressible:true},"application/vnd.xmpie.cpkg":{source:"iana"},"application/vnd.xmpie.dpkg":{source:"iana"},"application/vnd.xmpie.plan":{source:"iana"},"application/vnd.xmpie.ppkg":{source:"iana"},"application/vnd.xmpie.xlim":{source:"iana"},"application/vnd.yamaha.hv-dic":{source:"iana",extensions:["hvd"]},"application/vnd.yamaha.hv-script":{source:"iana",extensions:["hvs"]},"application/vnd.yamaha.hv-voice":{source:"iana",extensions:["hvp"]},"application/vnd.yamaha.openscoreformat":{source:"iana",extensions:["osf"]},"application/vnd.yamaha.openscoreformat.osfpvg+xml":{source:"iana",compressible:true,extensions:["osfpvg"]},"application/vnd.yamaha.remote-setup":{source:"iana"},"application/vnd.yamaha.smaf-audio":{source:"iana",extensions:["saf"]},"application/vnd.yamaha.smaf-phrase":{source:"iana",extensions:["spf"]},"application/vnd.yamaha.through-ngn":{source:"iana"},"application/vnd.yamaha.tunnel-udpencap":{source:"iana"},"application/vnd.yaoweme":{source:"iana"},"application/vnd.yellowriver-custom-menu":{source:"iana",extensions:["cmp"]},"application/vnd.youtube.yt":{source:"iana"},"application/vnd.zul":{source:"iana",extensions:["zir","zirz"]},"application/vnd.zzazz.deck+xml":{source:"iana",compressible:true,extensions:["zaz"]},"application/voicexml+xml":{source:"iana",compressible:true,extensions:["vxml"]},"application/voucher-cms+json":{source:"iana",compressible:true},"application/vq-rtcpxr":{source:"iana"},"application/wasm":{source:"iana",compressible:true,extensions:["wasm"]},"application/watcherinfo+xml":{source:"iana",compressible:true,extensions:["wif"]},"application/webpush-options+json":{source:"iana",compressible:true},"application/whoispp-query":{source:"iana"},"application/whoispp-response":{source:"iana"},"application/widget":{source:"iana",extensions:["wgt"]},"application/winhlp":{source:"apache",extensions:["hlp"]},"application/wita":{source:"iana"},"application/wordperfect5.1":{source:"iana"},"application/wsdl+xml":{source:"iana",compressible:true,extensions:["wsdl"]},"application/wspolicy+xml":{source:"iana",compressible:true,extensions:["wspolicy"]},"application/x-7z-compressed":{source:"apache",compressible:false,extensions:["7z"]},"application/x-abiword":{source:"apache",extensions:["abw"]},"application/x-ace-compressed":{source:"apache",extensions:["ace"]},"application/x-amf":{source:"apache"},"application/x-apple-diskimage":{source:"apache",extensions:["dmg"]},"application/x-arj":{compressible:false,extensions:["arj"]},"application/x-authorware-bin":{source:"apache",extensions:["aab","x32","u32","vox"]},"application/x-authorware-map":{source:"apache",extensions:["aam"]},"application/x-authorware-seg":{source:"apache",extensions:["aas"]},"application/x-bcpio":{source:"apache",extensions:["bcpio"]},"application/x-bdoc":{compressible:false,extensions:["bdoc"]},"application/x-bittorrent":{source:"apache",extensions:["torrent"]},"application/x-blorb":{source:"apache",extensions:["blb","blorb"]},"application/x-bzip":{source:"apache",compressible:false,extensions:["bz"]},"application/x-bzip2":{source:"apache",compressible:false,extensions:["bz2","boz"]},"application/x-cbr":{source:"apache",extensions:["cbr","cba","cbt","cbz","cb7"]},"application/x-cdlink":{source:"apache",extensions:["vcd"]},"application/x-cfs-compressed":{source:"apache",extensions:["cfs"]},"application/x-chat":{source:"apache",extensions:["chat"]},"application/x-chess-pgn":{source:"apache",extensions:["pgn"]},"application/x-chrome-extension":{extensions:["crx"]},"application/x-cocoa":{source:"nginx",extensions:["cco"]},"application/x-compress":{source:"apache"},"application/x-conference":{source:"apache",extensions:["nsc"]},"application/x-cpio":{source:"apache",extensions:["cpio"]},"application/x-csh":{source:"apache",extensions:["csh"]},"application/x-deb":{compressible:false},"application/x-debian-package":{source:"apache",extensions:["deb","udeb"]},"application/x-dgc-compressed":{source:"apache",extensions:["dgc"]},"application/x-director":{source:"apache",extensions:["dir","dcr","dxr","cst","cct","cxt","w3d","fgd","swa"]},"application/x-doom":{source:"apache",extensions:["wad"]},"application/x-dtbncx+xml":{source:"apache",compressible:true,extensions:["ncx"]},"application/x-dtbook+xml":{source:"apache",compressible:true,extensions:["dtb"]},"application/x-dtbresource+xml":{source:"apache",compressible:true,extensions:["res"]},"application/x-dvi":{source:"apache",compressible:false,extensions:["dvi"]},"application/x-envoy":{source:"apache",extensions:["evy"]},"application/x-eva":{source:"apache",extensions:["eva"]},"application/x-font-bdf":{source:"apache",extensions:["bdf"]},"application/x-font-dos":{source:"apache"},"application/x-font-framemaker":{source:"apache"},"application/x-font-ghostscript":{source:"apache",extensions:["gsf"]},"application/x-font-libgrx":{source:"apache"},"application/x-font-linux-psf":{source:"apache",extensions:["psf"]},"application/x-font-pcf":{source:"apache",extensions:["pcf"]},"application/x-font-snf":{source:"apache",extensions:["snf"]},"application/x-font-speedo":{source:"apache"},"application/x-font-sunos-news":{source:"apache"},"application/x-font-type1":{source:"apache",extensions:["pfa","pfb","pfm","afm"]},"application/x-font-vfont":{source:"apache"},"application/x-freearc":{source:"apache",extensions:["arc"]},"application/x-futuresplash":{source:"apache",extensions:["spl"]},"application/x-gca-compressed":{source:"apache",extensions:["gca"]},"application/x-glulx":{source:"apache",extensions:["ulx"]},"application/x-gnumeric":{source:"apache",extensions:["gnumeric"]},"application/x-gramps-xml":{source:"apache",extensions:["gramps"]},"application/x-gtar":{source:"apache",extensions:["gtar"]},"application/x-gzip":{source:"apache"},"application/x-hdf":{source:"apache",extensions:["hdf"]},"application/x-httpd-php":{compressible:true,extensions:["php"]},"application/x-install-instructions":{source:"apache",extensions:["install"]},"application/x-iso9660-image":{source:"apache",extensions:["iso"]},"application/x-iwork-keynote-sffkey":{extensions:["key"]},"application/x-iwork-numbers-sffnumbers":{extensions:["numbers"]},"application/x-iwork-pages-sffpages":{extensions:["pages"]},"application/x-java-archive-diff":{source:"nginx",extensions:["jardiff"]},"application/x-java-jnlp-file":{source:"apache",compressible:false,extensions:["jnlp"]},"application/x-javascript":{compressible:true},"application/x-keepass2":{extensions:["kdbx"]},"application/x-latex":{source:"apache",compressible:false,extensions:["latex"]},"application/x-lua-bytecode":{extensions:["luac"]},"application/x-lzh-compressed":{source:"apache",extensions:["lzh","lha"]},"application/x-makeself":{source:"nginx",extensions:["run"]},"application/x-mie":{source:"apache",extensions:["mie"]},"application/x-mobipocket-ebook":{source:"apache",extensions:["prc","mobi"]},"application/x-mpegurl":{compressible:false},"application/x-ms-application":{source:"apache",extensions:["application"]},"application/x-ms-shortcut":{source:"apache",extensions:["lnk"]},"application/x-ms-wmd":{source:"apache",extensions:["wmd"]},"application/x-ms-wmz":{source:"apache",extensions:["wmz"]},"application/x-ms-xbap":{source:"apache",extensions:["xbap"]},"application/x-msaccess":{source:"apache",extensions:["mdb"]},"application/x-msbinder":{source:"apache",extensions:["obd"]},"application/x-mscardfile":{source:"apache",extensions:["crd"]},"application/x-msclip":{source:"apache",extensions:["clp"]},"application/x-msdos-program":{extensions:["exe"]},"application/x-msdownload":{source:"apache",extensions:["exe","dll","com","bat","msi"]},"application/x-msmediaview":{source:"apache",extensions:["mvb","m13","m14"]},"application/x-msmetafile":{source:"apache",extensions:["wmf","wmz","emf","emz"]},"application/x-msmoney":{source:"apache",extensions:["mny"]},"application/x-mspublisher":{source:"apache",extensions:["pub"]},"application/x-msschedule":{source:"apache",extensions:["scd"]},"application/x-msterminal":{source:"apache",extensions:["trm"]},"application/x-mswrite":{source:"apache",extensions:["wri"]},"application/x-netcdf":{source:"apache",extensions:["nc","cdf"]},"application/x-ns-proxy-autoconfig":{compressible:true,extensions:["pac"]},"application/x-nzb":{source:"apache",extensions:["nzb"]},"application/x-perl":{source:"nginx",extensions:["pl","pm"]},"application/x-pilot":{source:"nginx",extensions:["prc","pdb"]},"application/x-pkcs12":{source:"apache",compressible:false,extensions:["p12","pfx"]},"application/x-pkcs7-certificates":{source:"apache",extensions:["p7b","spc"]},"application/x-pkcs7-certreqresp":{source:"apache",extensions:["p7r"]},"application/x-pki-message":{source:"iana"},"application/x-rar-compressed":{source:"apache",compressible:false,extensions:["rar"]},"application/x-redhat-package-manager":{source:"nginx",extensions:["rpm"]},"application/x-research-info-systems":{source:"apache",extensions:["ris"]},"application/x-sea":{source:"nginx",extensions:["sea"]},"application/x-sh":{source:"apache",compressible:true,extensions:["sh"]},"application/x-shar":{source:"apache",extensions:["shar"]},"application/x-shockwave-flash":{source:"apache",compressible:false,extensions:["swf"]},"application/x-silverlight-app":{source:"apache",extensions:["xap"]},"application/x-sql":{source:"apache",extensions:["sql"]},"application/x-stuffit":{source:"apache",compressible:false,extensions:["sit"]},"application/x-stuffitx":{source:"apache",extensions:["sitx"]},"application/x-subrip":{source:"apache",extensions:["srt"]},"application/x-sv4cpio":{source:"apache",extensions:["sv4cpio"]},"application/x-sv4crc":{source:"apache",extensions:["sv4crc"]},"application/x-t3vm-image":{source:"apache",extensions:["t3"]},"application/x-tads":{source:"apache",extensions:["gam"]},"application/x-tar":{source:"apache",compressible:true,extensions:["tar"]},"application/x-tcl":{source:"apache",extensions:["tcl","tk"]},"application/x-tex":{source:"apache",extensions:["tex"]},"application/x-tex-tfm":{source:"apache",extensions:["tfm"]},"application/x-texinfo":{source:"apache",extensions:["texinfo","texi"]},"application/x-tgif":{source:"apache",extensions:["obj"]},"application/x-ustar":{source:"apache",extensions:["ustar"]},"application/x-virtualbox-hdd":{compressible:true,extensions:["hdd"]},"application/x-virtualbox-ova":{compressible:true,extensions:["ova"]},"application/x-virtualbox-ovf":{compressible:true,extensions:["ovf"]},"application/x-virtualbox-vbox":{compressible:true,extensions:["vbox"]},"application/x-virtualbox-vbox-extpack":{compressible:false,extensions:["vbox-extpack"]},"application/x-virtualbox-vdi":{compressible:true,extensions:["vdi"]},"application/x-virtualbox-vhd":{compressible:true,extensions:["vhd"]},"application/x-virtualbox-vmdk":{compressible:true,extensions:["vmdk"]},"application/x-wais-source":{source:"apache",extensions:["src"]},"application/x-web-app-manifest+json":{compressible:true,extensions:["webapp"]},"application/x-www-form-urlencoded":{source:"iana",compressible:true},"application/x-x509-ca-cert":{source:"iana",extensions:["der","crt","pem"]},"application/x-x509-ca-ra-cert":{source:"iana"},"application/x-x509-next-ca-cert":{source:"iana"},"application/x-xfig":{source:"apache",extensions:["fig"]},"application/x-xliff+xml":{source:"apache",compressible:true,extensions:["xlf"]},"application/x-xpinstall":{source:"apache",compressible:false,extensions:["xpi"]},"application/x-xz":{source:"apache",extensions:["xz"]},"application/x-zmachine":{source:"apache",extensions:["z1","z2","z3","z4","z5","z6","z7","z8"]},"application/x400-bp":{source:"iana"},"application/xacml+xml":{source:"iana",compressible:true},"application/xaml+xml":{source:"apache",compressible:true,extensions:["xaml"]},"application/xcap-att+xml":{source:"iana",compressible:true,extensions:["xav"]},"application/xcap-caps+xml":{source:"iana",compressible:true,extensions:["xca"]},"application/xcap-diff+xml":{source:"iana",compressible:true,extensions:["xdf"]},"application/xcap-el+xml":{source:"iana",compressible:true,extensions:["xel"]},"application/xcap-error+xml":{source:"iana",compressible:true},"application/xcap-ns+xml":{source:"iana",compressible:true,extensions:["xns"]},"application/xcon-conference-info+xml":{source:"iana",compressible:true},"application/xcon-conference-info-diff+xml":{source:"iana",compressible:true},"application/xenc+xml":{source:"iana",compressible:true,extensions:["xenc"]},"application/xhtml+xml":{source:"iana",compressible:true,extensions:["xhtml","xht"]},"application/xhtml-voice+xml":{source:"apache",compressible:true},"application/xliff+xml":{source:"iana",compressible:true,extensions:["xlf"]},"application/xml":{source:"iana",compressible:true,extensions:["xml","xsl","xsd","rng"]},"application/xml-dtd":{source:"iana",compressible:true,extensions:["dtd"]},"application/xml-external-parsed-entity":{source:"iana"},"application/xml-patch+xml":{source:"iana",compressible:true},"application/xmpp+xml":{source:"iana",compressible:true},"application/xop+xml":{source:"iana",compressible:true,extensions:["xop"]},"application/xproc+xml":{source:"apache",compressible:true,extensions:["xpl"]},"application/xslt+xml":{source:"iana",compressible:true,extensions:["xsl","xslt"]},"application/xspf+xml":{source:"apache",compressible:true,extensions:["xspf"]},"application/xv+xml":{source:"iana",compressible:true,extensions:["mxml","xhvml","xvml","xvm"]},"application/yang":{source:"iana",extensions:["yang"]},"application/yang-data+json":{source:"iana",compressible:true},"application/yang-data+xml":{source:"iana",compressible:true},"application/yang-patch+json":{source:"iana",compressible:true},"application/yang-patch+xml":{source:"iana",compressible:true},"application/yin+xml":{source:"iana",compressible:true,extensions:["yin"]},"application/zip":{source:"iana",compressible:false,extensions:["zip"]},"application/zlib":{source:"iana"},"application/zstd":{source:"iana"},"audio/1d-interleaved-parityfec":{source:"iana"},"audio/32kadpcm":{source:"iana"},"audio/3gpp":{source:"iana",compressible:false,extensions:["3gpp"]},"audio/3gpp2":{source:"iana"},"audio/aac":{source:"iana"},"audio/ac3":{source:"iana"},"audio/adpcm":{source:"apache",extensions:["adp"]},"audio/amr":{source:"iana",extensions:["amr"]},"audio/amr-wb":{source:"iana"},"audio/amr-wb+":{source:"iana"},"audio/aptx":{source:"iana"},"audio/asc":{source:"iana"},"audio/atrac-advanced-lossless":{source:"iana"},"audio/atrac-x":{source:"iana"},"audio/atrac3":{source:"iana"},"audio/basic":{source:"iana",compressible:false,extensions:["au","snd"]},"audio/bv16":{source:"iana"},"audio/bv32":{source:"iana"},"audio/clearmode":{source:"iana"},"audio/cn":{source:"iana"},"audio/dat12":{source:"iana"},"audio/dls":{source:"iana"},"audio/dsr-es201108":{source:"iana"},"audio/dsr-es202050":{source:"iana"},"audio/dsr-es202211":{source:"iana"},"audio/dsr-es202212":{source:"iana"},"audio/dv":{source:"iana"},"audio/dvi4":{source:"iana"},"audio/eac3":{source:"iana"},"audio/encaprtp":{source:"iana"},"audio/evrc":{source:"iana"},"audio/evrc-qcp":{source:"iana"},"audio/evrc0":{source:"iana"},"audio/evrc1":{source:"iana"},"audio/evrcb":{source:"iana"},"audio/evrcb0":{source:"iana"},"audio/evrcb1":{source:"iana"},"audio/evrcnw":{source:"iana"},"audio/evrcnw0":{source:"iana"},"audio/evrcnw1":{source:"iana"},"audio/evrcwb":{source:"iana"},"audio/evrcwb0":{source:"iana"},"audio/evrcwb1":{source:"iana"},"audio/evs":{source:"iana"},"audio/flexfec":{source:"iana"},"audio/fwdred":{source:"iana"},"audio/g711-0":{source:"iana"},"audio/g719":{source:"iana"},"audio/g722":{source:"iana"},"audio/g7221":{source:"iana"},"audio/g723":{source:"iana"},"audio/g726-16":{source:"iana"},"audio/g726-24":{source:"iana"},"audio/g726-32":{source:"iana"},"audio/g726-40":{source:"iana"},"audio/g728":{source:"iana"},"audio/g729":{source:"iana"},"audio/g7291":{source:"iana"},"audio/g729d":{source:"iana"},"audio/g729e":{source:"iana"},"audio/gsm":{source:"iana"},"audio/gsm-efr":{source:"iana"},"audio/gsm-hr-08":{source:"iana"},"audio/ilbc":{source:"iana"},"audio/ip-mr_v2.5":{source:"iana"},"audio/isac":{source:"apache"},"audio/l16":{source:"iana"},"audio/l20":{source:"iana"},"audio/l24":{source:"iana",compressible:false},"audio/l8":{source:"iana"},"audio/lpc":{source:"iana"},"audio/melp":{source:"iana"},"audio/melp1200":{source:"iana"},"audio/melp2400":{source:"iana"},"audio/melp600":{source:"iana"},"audio/mhas":{source:"iana"},"audio/midi":{source:"apache",extensions:["mid","midi","kar","rmi"]},"audio/mobile-xmf":{source:"iana",extensions:["mxmf"]},"audio/mp3":{compressible:false,extensions:["mp3"]},"audio/mp4":{source:"iana",compressible:false,extensions:["m4a","mp4a"]},"audio/mp4a-latm":{source:"iana"},"audio/mpa":{source:"iana"},"audio/mpa-robust":{source:"iana"},"audio/mpeg":{source:"iana",compressible:false,extensions:["mpga","mp2","mp2a","mp3","m2a","m3a"]},"audio/mpeg4-generic":{source:"iana"},"audio/musepack":{source:"apache"},"audio/ogg":{source:"iana",compressible:false,extensions:["oga","ogg","spx","opus"]},"audio/opus":{source:"iana"},"audio/parityfec":{source:"iana"},"audio/pcma":{source:"iana"},"audio/pcma-wb":{source:"iana"},"audio/pcmu":{source:"iana"},"audio/pcmu-wb":{source:"iana"},"audio/prs.sid":{source:"iana"},"audio/qcelp":{source:"iana"},"audio/raptorfec":{source:"iana"},"audio/red":{source:"iana"},"audio/rtp-enc-aescm128":{source:"iana"},"audio/rtp-midi":{source:"iana"},"audio/rtploopback":{source:"iana"},"audio/rtx":{source:"iana"},"audio/s3m":{source:"apache",extensions:["s3m"]},"audio/scip":{source:"iana"},"audio/silk":{source:"apache",extensions:["sil"]},"audio/smv":{source:"iana"},"audio/smv-qcp":{source:"iana"},"audio/smv0":{source:"iana"},"audio/sofa":{source:"iana"},"audio/sp-midi":{source:"iana"},"audio/speex":{source:"iana"},"audio/t140c":{source:"iana"},"audio/t38":{source:"iana"},"audio/telephone-event":{source:"iana"},"audio/tetra_acelp":{source:"iana"},"audio/tetra_acelp_bb":{source:"iana"},"audio/tone":{source:"iana"},"audio/tsvcis":{source:"iana"},"audio/uemclip":{source:"iana"},"audio/ulpfec":{source:"iana"},"audio/usac":{source:"iana"},"audio/vdvi":{source:"iana"},"audio/vmr-wb":{source:"iana"},"audio/vnd.3gpp.iufp":{source:"iana"},"audio/vnd.4sb":{source:"iana"},"audio/vnd.audiokoz":{source:"iana"},"audio/vnd.celp":{source:"iana"},"audio/vnd.cisco.nse":{source:"iana"},"audio/vnd.cmles.radio-events":{source:"iana"},"audio/vnd.cns.anp1":{source:"iana"},"audio/vnd.cns.inf1":{source:"iana"},"audio/vnd.dece.audio":{source:"iana",extensions:["uva","uvva"]},"audio/vnd.digital-winds":{source:"iana",extensions:["eol"]},"audio/vnd.dlna.adts":{source:"iana"},"audio/vnd.dolby.heaac.1":{source:"iana"},"audio/vnd.dolby.heaac.2":{source:"iana"},"audio/vnd.dolby.mlp":{source:"iana"},"audio/vnd.dolby.mps":{source:"iana"},"audio/vnd.dolby.pl2":{source:"iana"},"audio/vnd.dolby.pl2x":{source:"iana"},"audio/vnd.dolby.pl2z":{source:"iana"},"audio/vnd.dolby.pulse.1":{source:"iana"},"audio/vnd.dra":{source:"iana",extensions:["dra"]},"audio/vnd.dts":{source:"iana",extensions:["dts"]},"audio/vnd.dts.hd":{source:"iana",extensions:["dtshd"]},"audio/vnd.dts.uhd":{source:"iana"},"audio/vnd.dvb.file":{source:"iana"},"audio/vnd.everad.plj":{source:"iana"},"audio/vnd.hns.audio":{source:"iana"},"audio/vnd.lucent.voice":{source:"iana",extensions:["lvp"]},"audio/vnd.ms-playready.media.pya":{source:"iana",extensions:["pya"]},"audio/vnd.nokia.mobile-xmf":{source:"iana"},"audio/vnd.nortel.vbk":{source:"iana"},"audio/vnd.nuera.ecelp4800":{source:"iana",extensions:["ecelp4800"]},"audio/vnd.nuera.ecelp7470":{source:"iana",extensions:["ecelp7470"]},"audio/vnd.nuera.ecelp9600":{source:"iana",extensions:["ecelp9600"]},"audio/vnd.octel.sbc":{source:"iana"},"audio/vnd.presonus.multitrack":{source:"iana"},"audio/vnd.qcelp":{source:"iana"},"audio/vnd.rhetorex.32kadpcm":{source:"iana"},"audio/vnd.rip":{source:"iana",extensions:["rip"]},"audio/vnd.rn-realaudio":{compressible:false},"audio/vnd.sealedmedia.softseal.mpeg":{source:"iana"},"audio/vnd.vmx.cvsd":{source:"iana"},"audio/vnd.wave":{compressible:false},"audio/vorbis":{source:"iana",compressible:false},"audio/vorbis-config":{source:"iana"},"audio/wav":{compressible:false,extensions:["wav"]},"audio/wave":{compressible:false,extensions:["wav"]},"audio/webm":{source:"apache",compressible:false,extensions:["weba"]},"audio/x-aac":{source:"apache",compressible:false,extensions:["aac"]},"audio/x-aiff":{source:"apache",extensions:["aif","aiff","aifc"]},"audio/x-caf":{source:"apache",compressible:false,extensions:["caf"]},"audio/x-flac":{source:"apache",extensions:["flac"]},"audio/x-m4a":{source:"nginx",extensions:["m4a"]},"audio/x-matroska":{source:"apache",extensions:["mka"]},"audio/x-mpegurl":{source:"apache",extensions:["m3u"]},"audio/x-ms-wax":{source:"apache",extensions:["wax"]},"audio/x-ms-wma":{source:"apache",extensions:["wma"]},"audio/x-pn-realaudio":{source:"apache",extensions:["ram","ra"]},"audio/x-pn-realaudio-plugin":{source:"apache",extensions:["rmp"]},"audio/x-realaudio":{source:"nginx",extensions:["ra"]},"audio/x-tta":{source:"apache"},"audio/x-wav":{source:"apache",extensions:["wav"]},"audio/xm":{source:"apache",extensions:["xm"]},"chemical/x-cdx":{source:"apache",extensions:["cdx"]},"chemical/x-cif":{source:"apache",extensions:["cif"]},"chemical/x-cmdf":{source:"apache",extensions:["cmdf"]},"chemical/x-cml":{source:"apache",extensions:["cml"]},"chemical/x-csml":{source:"apache",extensions:["csml"]},"chemical/x-pdb":{source:"apache"},"chemical/x-xyz":{source:"apache",extensions:["xyz"]},"font/collection":{source:"iana",extensions:["ttc"]},"font/otf":{source:"iana",compressible:true,extensions:["otf"]},"font/sfnt":{source:"iana"},"font/ttf":{source:"iana",compressible:true,extensions:["ttf"]},"font/woff":{source:"iana",extensions:["woff"]},"font/woff2":{source:"iana",extensions:["woff2"]},"image/aces":{source:"iana",extensions:["exr"]},"image/apng":{compressible:false,extensions:["apng"]},"image/avci":{source:"iana",extensions:["avci"]},"image/avcs":{source:"iana",extensions:["avcs"]},"image/avif":{source:"iana",compressible:false,extensions:["avif"]},"image/bmp":{source:"iana",compressible:true,extensions:["bmp"]},"image/cgm":{source:"iana",extensions:["cgm"]},"image/dicom-rle":{source:"iana",extensions:["drle"]},"image/emf":{source:"iana",extensions:["emf"]},"image/fits":{source:"iana",extensions:["fits"]},"image/g3fax":{source:"iana",extensions:["g3"]},"image/gif":{source:"iana",compressible:false,extensions:["gif"]},"image/heic":{source:"iana",extensions:["heic"]},"image/heic-sequence":{source:"iana",extensions:["heics"]},"image/heif":{source:"iana",extensions:["heif"]},"image/heif-sequence":{source:"iana",extensions:["heifs"]},"image/hej2k":{source:"iana",extensions:["hej2"]},"image/hsj2":{source:"iana",extensions:["hsj2"]},"image/ief":{source:"iana",extensions:["ief"]},"image/jls":{source:"iana",extensions:["jls"]},"image/jp2":{source:"iana",compressible:false,extensions:["jp2","jpg2"]},"image/jpeg":{source:"iana",compressible:false,extensions:["jpeg","jpg","jpe"]},"image/jph":{source:"iana",extensions:["jph"]},"image/jphc":{source:"iana",extensions:["jhc"]},"image/jpm":{source:"iana",compressible:false,extensions:["jpm"]},"image/jpx":{source:"iana",compressible:false,extensions:["jpx","jpf"]},"image/jxr":{source:"iana",extensions:["jxr"]},"image/jxra":{source:"iana",extensions:["jxra"]},"image/jxrs":{source:"iana",extensions:["jxrs"]},"image/jxs":{source:"iana",extensions:["jxs"]},"image/jxsc":{source:"iana",extensions:["jxsc"]},"image/jxsi":{source:"iana",extensions:["jxsi"]},"image/jxss":{source:"iana",extensions:["jxss"]},"image/ktx":{source:"iana",extensions:["ktx"]},"image/ktx2":{source:"iana",extensions:["ktx2"]},"image/naplps":{source:"iana"},"image/pjpeg":{compressible:false},"image/png":{source:"iana",compressible:false,extensions:["png"]},"image/prs.btif":{source:"iana",extensions:["btif"]},"image/prs.pti":{source:"iana",extensions:["pti"]},"image/pwg-raster":{source:"iana"},"image/sgi":{source:"apache",extensions:["sgi"]},"image/svg+xml":{source:"iana",compressible:true,extensions:["svg","svgz"]},"image/t38":{source:"iana",extensions:["t38"]},"image/tiff":{source:"iana",compressible:false,extensions:["tif","tiff"]},"image/tiff-fx":{source:"iana",extensions:["tfx"]},"image/vnd.adobe.photoshop":{source:"iana",compressible:true,extensions:["psd"]},"image/vnd.airzip.accelerator.azv":{source:"iana",extensions:["azv"]},"image/vnd.cns.inf2":{source:"iana"},"image/vnd.dece.graphic":{source:"iana",extensions:["uvi","uvvi","uvg","uvvg"]},"image/vnd.djvu":{source:"iana",extensions:["djvu","djv"]},"image/vnd.dvb.subtitle":{source:"iana",extensions:["sub"]},"image/vnd.dwg":{source:"iana",extensions:["dwg"]},"image/vnd.dxf":{source:"iana",extensions:["dxf"]},"image/vnd.fastbidsheet":{source:"iana",extensions:["fbs"]},"image/vnd.fpx":{source:"iana",extensions:["fpx"]},"image/vnd.fst":{source:"iana",extensions:["fst"]},"image/vnd.fujixerox.edmics-mmr":{source:"iana",extensions:["mmr"]},"image/vnd.fujixerox.edmics-rlc":{source:"iana",extensions:["rlc"]},"image/vnd.globalgraphics.pgb":{source:"iana"},"image/vnd.microsoft.icon":{source:"iana",compressible:true,extensions:["ico"]},"image/vnd.mix":{source:"iana"},"image/vnd.mozilla.apng":{source:"iana"},"image/vnd.ms-dds":{compressible:true,extensions:["dds"]},"image/vnd.ms-modi":{source:"iana",extensions:["mdi"]},"image/vnd.ms-photo":{source:"apache",extensions:["wdp"]},"image/vnd.net-fpx":{source:"iana",extensions:["npx"]},"image/vnd.pco.b16":{source:"iana",extensions:["b16"]},"image/vnd.radiance":{source:"iana"},"image/vnd.sealed.png":{source:"iana"},"image/vnd.sealedmedia.softseal.gif":{source:"iana"},"image/vnd.sealedmedia.softseal.jpg":{source:"iana"},"image/vnd.svf":{source:"iana"},"image/vnd.tencent.tap":{source:"iana",extensions:["tap"]},"image/vnd.valve.source.texture":{source:"iana",extensions:["vtf"]},"image/vnd.wap.wbmp":{source:"iana",extensions:["wbmp"]},"image/vnd.xiff":{source:"iana",extensions:["xif"]},"image/vnd.zbrush.pcx":{source:"iana",extensions:["pcx"]},"image/webp":{source:"apache",extensions:["webp"]},"image/wmf":{source:"iana",extensions:["wmf"]},"image/x-3ds":{source:"apache",extensions:["3ds"]},"image/x-cmu-raster":{source:"apache",extensions:["ras"]},"image/x-cmx":{source:"apache",extensions:["cmx"]},"image/x-freehand":{source:"apache",extensions:["fh","fhc","fh4","fh5","fh7"]},"image/x-icon":{source:"apache",compressible:true,extensions:["ico"]},"image/x-jng":{source:"nginx",extensions:["jng"]},"image/x-mrsid-image":{source:"apache",extensions:["sid"]},"image/x-ms-bmp":{source:"nginx",compressible:true,extensions:["bmp"]},"image/x-pcx":{source:"apache",extensions:["pcx"]},"image/x-pict":{source:"apache",extensions:["pic","pct"]},"image/x-portable-anymap":{source:"apache",extensions:["pnm"]},"image/x-portable-bitmap":{source:"apache",extensions:["pbm"]},"image/x-portable-graymap":{source:"apache",extensions:["pgm"]},"image/x-portable-pixmap":{source:"apache",extensions:["ppm"]},"image/x-rgb":{source:"apache",extensions:["rgb"]},"image/x-tga":{source:"apache",extensions:["tga"]},"image/x-xbitmap":{source:"apache",extensions:["xbm"]},"image/x-xcf":{compressible:false},"image/x-xpixmap":{source:"apache",extensions:["xpm"]},"image/x-xwindowdump":{source:"apache",extensions:["xwd"]},"message/cpim":{source:"iana"},"message/delivery-status":{source:"iana"},"message/disposition-notification":{source:"iana",extensions:["disposition-notification"]},"message/external-body":{source:"iana"},"message/feedback-report":{source:"iana"},"message/global":{source:"iana",extensions:["u8msg"]},"message/global-delivery-status":{source:"iana",extensions:["u8dsn"]},"message/global-disposition-notification":{source:"iana",extensions:["u8mdn"]},"message/global-headers":{source:"iana",extensions:["u8hdr"]},"message/http":{source:"iana",compressible:false},"message/imdn+xml":{source:"iana",compressible:true},"message/news":{source:"iana"},"message/partial":{source:"iana",compressible:false},"message/rfc822":{source:"iana",compressible:true,extensions:["eml","mime"]},"message/s-http":{source:"iana"},"message/sip":{source:"iana"},"message/sipfrag":{source:"iana"},"message/tracking-status":{source:"iana"},"message/vnd.si.simp":{source:"iana"},"message/vnd.wfa.wsc":{source:"iana",extensions:["wsc"]},"model/3mf":{source:"iana",extensions:["3mf"]},"model/e57":{source:"iana"},"model/gltf+json":{source:"iana",compressible:true,extensions:["gltf"]},"model/gltf-binary":{source:"iana",compressible:true,extensions:["glb"]},"model/iges":{source:"iana",compressible:false,extensions:["igs","iges"]},"model/mesh":{source:"iana",compressible:false,extensions:["msh","mesh","silo"]},"model/mtl":{source:"iana",extensions:["mtl"]},"model/obj":{source:"iana",extensions:["obj"]},"model/step":{source:"iana"},"model/step+xml":{source:"iana",compressible:true,extensions:["stpx"]},"model/step+zip":{source:"iana",compressible:false,extensions:["stpz"]},"model/step-xml+zip":{source:"iana",compressible:false,extensions:["stpxz"]},"model/stl":{source:"iana",extensions:["stl"]},"model/vnd.collada+xml":{source:"iana",compressible:true,extensions:["dae"]},"model/vnd.dwf":{source:"iana",extensions:["dwf"]},"model/vnd.flatland.3dml":{source:"iana"},"model/vnd.gdl":{source:"iana",extensions:["gdl"]},"model/vnd.gs-gdl":{source:"apache"},"model/vnd.gs.gdl":{source:"iana"},"model/vnd.gtw":{source:"iana",extensions:["gtw"]},"model/vnd.moml+xml":{source:"iana",compressible:true},"model/vnd.mts":{source:"iana",extensions:["mts"]},"model/vnd.opengex":{source:"iana",extensions:["ogex"]},"model/vnd.parasolid.transmit.binary":{source:"iana",extensions:["x_b"]},"model/vnd.parasolid.transmit.text":{source:"iana",extensions:["x_t"]},"model/vnd.pytha.pyox":{source:"iana"},"model/vnd.rosette.annotated-data-model":{source:"iana"},"model/vnd.sap.vds":{source:"iana",extensions:["vds"]},"model/vnd.usdz+zip":{source:"iana",compressible:false,extensions:["usdz"]},"model/vnd.valve.source.compiled-map":{source:"iana",extensions:["bsp"]},"model/vnd.vtu":{source:"iana",extensions:["vtu"]},"model/vrml":{source:"iana",compressible:false,extensions:["wrl","vrml"]},"model/x3d+binary":{source:"apache",compressible:false,extensions:["x3db","x3dbz"]},"model/x3d+fastinfoset":{source:"iana",extensions:["x3db"]},"model/x3d+vrml":{source:"apache",compressible:false,extensions:["x3dv","x3dvz"]},"model/x3d+xml":{source:"iana",compressible:true,extensions:["x3d","x3dz"]},"model/x3d-vrml":{source:"iana",extensions:["x3dv"]},"multipart/alternative":{source:"iana",compressible:false},"multipart/appledouble":{source:"iana"},"multipart/byteranges":{source:"iana"},"multipart/digest":{source:"iana"},"multipart/encrypted":{source:"iana",compressible:false},"multipart/form-data":{source:"iana",compressible:false},"multipart/header-set":{source:"iana"},"multipart/mixed":{source:"iana"},"multipart/multilingual":{source:"iana"},"multipart/parallel":{source:"iana"},"multipart/related":{source:"iana",compressible:false},"multipart/report":{source:"iana"},"multipart/signed":{source:"iana",compressible:false},"multipart/vnd.bint.med-plus":{source:"iana"},"multipart/voice-message":{source:"iana"},"multipart/x-mixed-replace":{source:"iana"},"text/1d-interleaved-parityfec":{source:"iana"},"text/cache-manifest":{source:"iana",compressible:true,extensions:["appcache","manifest"]},"text/calendar":{source:"iana",extensions:["ics","ifb"]},"text/calender":{compressible:true},"text/cmd":{compressible:true},"text/coffeescript":{extensions:["coffee","litcoffee"]},"text/cql":{source:"iana"},"text/cql-expression":{source:"iana"},"text/cql-identifier":{source:"iana"},"text/css":{source:"iana",charset:"UTF-8",compressible:true,extensions:["css"]},"text/csv":{source:"iana",compressible:true,extensions:["csv"]},"text/csv-schema":{source:"iana"},"text/directory":{source:"iana"},"text/dns":{source:"iana"},"text/ecmascript":{source:"iana"},"text/encaprtp":{source:"iana"},"text/enriched":{source:"iana"},"text/fhirpath":{source:"iana"},"text/flexfec":{source:"iana"},"text/fwdred":{source:"iana"},"text/gff3":{source:"iana"},"text/grammar-ref-list":{source:"iana"},"text/html":{source:"iana",compressible:true,extensions:["html","htm","shtml"]},"text/jade":{extensions:["jade"]},"text/javascript":{source:"iana",compressible:true},"text/jcr-cnd":{source:"iana"},"text/jsx":{compressible:true,extensions:["jsx"]},"text/less":{compressible:true,extensions:["less"]},"text/markdown":{source:"iana",compressible:true,extensions:["markdown","md"]},"text/mathml":{source:"nginx",extensions:["mml"]},"text/mdx":{compressible:true,extensions:["mdx"]},"text/mizar":{source:"iana"},"text/n3":{source:"iana",charset:"UTF-8",compressible:true,extensions:["n3"]},"text/parameters":{source:"iana",charset:"UTF-8"},"text/parityfec":{source:"iana"},"text/plain":{source:"iana",compressible:true,extensions:["txt","text","conf","def","list","log","in","ini"]},"text/provenance-notation":{source:"iana",charset:"UTF-8"},"text/prs.fallenstein.rst":{source:"iana"},"text/prs.lines.tag":{source:"iana",extensions:["dsc"]},"text/prs.prop.logic":{source:"iana"},"text/raptorfec":{source:"iana"},"text/red":{source:"iana"},"text/rfc822-headers":{source:"iana"},"text/richtext":{source:"iana",compressible:true,extensions:["rtx"]},"text/rtf":{source:"iana",compressible:true,extensions:["rtf"]},"text/rtp-enc-aescm128":{source:"iana"},"text/rtploopback":{source:"iana"},"text/rtx":{source:"iana"},"text/sgml":{source:"iana",extensions:["sgml","sgm"]},"text/shaclc":{source:"iana"},"text/shex":{source:"iana",extensions:["shex"]},"text/slim":{extensions:["slim","slm"]},"text/spdx":{source:"iana",extensions:["spdx"]},"text/strings":{source:"iana"},"text/stylus":{extensions:["stylus","styl"]},"text/t140":{source:"iana"},"text/tab-separated-values":{source:"iana",compressible:true,extensions:["tsv"]},"text/troff":{source:"iana",extensions:["t","tr","roff","man","me","ms"]},"text/turtle":{source:"iana",charset:"UTF-8",extensions:["ttl"]},"text/ulpfec":{source:"iana"},"text/uri-list":{source:"iana",compressible:true,extensions:["uri","uris","urls"]},"text/vcard":{source:"iana",compressible:true,extensions:["vcard"]},"text/vnd.a":{source:"iana"},"text/vnd.abc":{source:"iana"},"text/vnd.ascii-art":{source:"iana"},"text/vnd.curl":{source:"iana",extensions:["curl"]},"text/vnd.curl.dcurl":{source:"apache",extensions:["dcurl"]},"text/vnd.curl.mcurl":{source:"apache",extensions:["mcurl"]},"text/vnd.curl.scurl":{source:"apache",extensions:["scurl"]},"text/vnd.debian.copyright":{source:"iana",charset:"UTF-8"},"text/vnd.dmclientscript":{source:"iana"},"text/vnd.dvb.subtitle":{source:"iana",extensions:["sub"]},"text/vnd.esmertec.theme-descriptor":{source:"iana",charset:"UTF-8"},"text/vnd.familysearch.gedcom":{source:"iana",extensions:["ged"]},"text/vnd.ficlab.flt":{source:"iana"},"text/vnd.fly":{source:"iana",extensions:["fly"]},"text/vnd.fmi.flexstor":{source:"iana",extensions:["flx"]},"text/vnd.gml":{source:"iana"},"text/vnd.graphviz":{source:"iana",extensions:["gv"]},"text/vnd.hans":{source:"iana"},"text/vnd.hgl":{source:"iana"},"text/vnd.in3d.3dml":{source:"iana",extensions:["3dml"]},"text/vnd.in3d.spot":{source:"iana",extensions:["spot"]},"text/vnd.iptc.newsml":{source:"iana"},"text/vnd.iptc.nitf":{source:"iana"},"text/vnd.latex-z":{source:"iana"},"text/vnd.motorola.reflex":{source:"iana"},"text/vnd.ms-mediapackage":{source:"iana"},"text/vnd.net2phone.commcenter.command":{source:"iana"},"text/vnd.radisys.msml-basic-layout":{source:"iana"},"text/vnd.senx.warpscript":{source:"iana"},"text/vnd.si.uricatalogue":{source:"iana"},"text/vnd.sosi":{source:"iana"},"text/vnd.sun.j2me.app-descriptor":{source:"iana",charset:"UTF-8",extensions:["jad"]},"text/vnd.trolltech.linguist":{source:"iana",charset:"UTF-8"},"text/vnd.wap.si":{source:"iana"},"text/vnd.wap.sl":{source:"iana"},"text/vnd.wap.wml":{source:"iana",extensions:["wml"]},"text/vnd.wap.wmlscript":{source:"iana",extensions:["wmls"]},"text/vtt":{source:"iana",charset:"UTF-8",compressible:true,extensions:["vtt"]},"text/x-asm":{source:"apache",extensions:["s","asm"]},"text/x-c":{source:"apache",extensions:["c","cc","cxx","cpp","h","hh","dic"]},"text/x-component":{source:"nginx",extensions:["htc"]},"text/x-fortran":{source:"apache",extensions:["f","for","f77","f90"]},"text/x-gwt-rpc":{compressible:true},"text/x-handlebars-template":{extensions:["hbs"]},"text/x-java-source":{source:"apache",extensions:["java"]},"text/x-jquery-tmpl":{compressible:true},"text/x-lua":{extensions:["lua"]},"text/x-markdown":{compressible:true,extensions:["mkd"]},"text/x-nfo":{source:"apache",extensions:["nfo"]},"text/x-opml":{source:"apache",extensions:["opml"]},"text/x-org":{compressible:true,extensions:["org"]},"text/x-pascal":{source:"apache",extensions:["p","pas"]},"text/x-processing":{compressible:true,extensions:["pde"]},"text/x-sass":{extensions:["sass"]},"text/x-scss":{extensions:["scss"]},"text/x-setext":{source:"apache",extensions:["etx"]},"text/x-sfv":{source:"apache",extensions:["sfv"]},"text/x-suse-ymp":{compressible:true,extensions:["ymp"]},"text/x-uuencode":{source:"apache",extensions:["uu"]},"text/x-vcalendar":{source:"apache",extensions:["vcs"]},"text/x-vcard":{source:"apache",extensions:["vcf"]},"text/xml":{source:"iana",compressible:true,extensions:["xml"]},"text/xml-external-parsed-entity":{source:"iana"},"text/yaml":{compressible:true,extensions:["yaml","yml"]},"video/1d-interleaved-parityfec":{source:"iana"},"video/3gpp":{source:"iana",extensions:["3gp","3gpp"]},"video/3gpp-tt":{source:"iana"},"video/3gpp2":{source:"iana",extensions:["3g2"]},"video/av1":{source:"iana"},"video/bmpeg":{source:"iana"},"video/bt656":{source:"iana"},"video/celb":{source:"iana"},"video/dv":{source:"iana"},"video/encaprtp":{source:"iana"},"video/ffv1":{source:"iana"},"video/flexfec":{source:"iana"},"video/h261":{source:"iana",extensions:["h261"]},"video/h263":{source:"iana",extensions:["h263"]},"video/h263-1998":{source:"iana"},"video/h263-2000":{source:"iana"},"video/h264":{source:"iana",extensions:["h264"]},"video/h264-rcdo":{source:"iana"},"video/h264-svc":{source:"iana"},"video/h265":{source:"iana"},"video/iso.segment":{source:"iana",extensions:["m4s"]},"video/jpeg":{source:"iana",extensions:["jpgv"]},"video/jpeg2000":{source:"iana"},"video/jpm":{source:"apache",extensions:["jpm","jpgm"]},"video/jxsv":{source:"iana"},"video/mj2":{source:"iana",extensions:["mj2","mjp2"]},"video/mp1s":{source:"iana"},"video/mp2p":{source:"iana"},"video/mp2t":{source:"iana",extensions:["ts"]},"video/mp4":{source:"iana",compressible:false,extensions:["mp4","mp4v","mpg4"]},"video/mp4v-es":{source:"iana"},"video/mpeg":{source:"iana",compressible:false,extensions:["mpeg","mpg","mpe","m1v","m2v"]},"video/mpeg4-generic":{source:"iana"},"video/mpv":{source:"iana"},"video/nv":{source:"iana"},"video/ogg":{source:"iana",compressible:false,extensions:["ogv"]},"video/parityfec":{source:"iana"},"video/pointer":{source:"iana"},"video/quicktime":{source:"iana",compressible:false,extensions:["qt","mov"]},"video/raptorfec":{source:"iana"},"video/raw":{source:"iana"},"video/rtp-enc-aescm128":{source:"iana"},"video/rtploopback":{source:"iana"},"video/rtx":{source:"iana"},"video/scip":{source:"iana"},"video/smpte291":{source:"iana"},"video/smpte292m":{source:"iana"},"video/ulpfec":{source:"iana"},"video/vc1":{source:"iana"},"video/vc2":{source:"iana"},"video/vnd.cctv":{source:"iana"},"video/vnd.dece.hd":{source:"iana",extensions:["uvh","uvvh"]},"video/vnd.dece.mobile":{source:"iana",extensions:["uvm","uvvm"]},"video/vnd.dece.mp4":{source:"iana"},"video/vnd.dece.pd":{source:"iana",extensions:["uvp","uvvp"]},"video/vnd.dece.sd":{source:"iana",extensions:["uvs","uvvs"]},"video/vnd.dece.video":{source:"iana",extensions:["uvv","uvvv"]},"video/vnd.directv.mpeg":{source:"iana"},"video/vnd.directv.mpeg-tts":{source:"iana"},"video/vnd.dlna.mpeg-tts":{source:"iana"},"video/vnd.dvb.file":{source:"iana",extensions:["dvb"]},"video/vnd.fvt":{source:"iana",extensions:["fvt"]},"video/vnd.hns.video":{source:"iana"},"video/vnd.iptvforum.1dparityfec-1010":{source:"iana"},"video/vnd.iptvforum.1dparityfec-2005":{source:"iana"},"video/vnd.iptvforum.2dparityfec-1010":{source:"iana"},"video/vnd.iptvforum.2dparityfec-2005":{source:"iana"},"video/vnd.iptvforum.ttsavc":{source:"iana"},"video/vnd.iptvforum.ttsmpeg2":{source:"iana"},"video/vnd.motorola.video":{source:"iana"},"video/vnd.motorola.videop":{source:"iana"},"video/vnd.mpegurl":{source:"iana",extensions:["mxu","m4u"]},"video/vnd.ms-playready.media.pyv":{source:"iana",extensions:["pyv"]},"video/vnd.nokia.interleaved-multimedia":{source:"iana"},"video/vnd.nokia.mp4vr":{source:"iana"},"video/vnd.nokia.videovoip":{source:"iana"},"video/vnd.objectvideo":{source:"iana"},"video/vnd.radgamettools.bink":{source:"iana"},"video/vnd.radgamettools.smacker":{source:"iana"},"video/vnd.sealed.mpeg1":{source:"iana"},"video/vnd.sealed.mpeg4":{source:"iana"},"video/vnd.sealed.swf":{source:"iana"},"video/vnd.sealedmedia.softseal.mov":{source:"iana"},"video/vnd.uvvu.mp4":{source:"iana",extensions:["uvu","uvvu"]},"video/vnd.vivo":{source:"iana",extensions:["viv"]},"video/vnd.youtube.yt":{source:"iana"},"video/vp8":{source:"iana"},"video/vp9":{source:"iana"},"video/webm":{source:"apache",compressible:false,extensions:["webm"]},"video/x-f4v":{source:"apache",extensions:["f4v"]},"video/x-fli":{source:"apache",extensions:["fli"]},"video/x-flv":{source:"apache",compressible:false,extensions:["flv"]},"video/x-m4v":{source:"apache",extensions:["m4v"]},"video/x-matroska":{source:"apache",compressible:false,extensions:["mkv","mk3d","mks"]},"video/x-mng":{source:"apache",extensions:["mng"]},"video/x-ms-asf":{source:"apache",extensions:["asf","asx"]},"video/x-ms-vob":{source:"apache",extensions:["vob"]},"video/x-ms-wm":{source:"apache",extensions:["wm"]},"video/x-ms-wmv":{source:"apache",compressible:false,extensions:["wmv"]},"video/x-ms-wmx":{source:"apache",extensions:["wmx"]},"video/x-ms-wvx":{source:"apache",extensions:["wvx"]},"video/x-msvideo":{source:"apache",extensions:["avi"]},"video/x-sgi-movie":{source:"apache",extensions:["movie"]},"video/x-smv":{source:"apache",extensions:["smv"]},"x-conference/x-cooltalk":{source:"apache",extensions:["ice"]},"x-shader/x-fragment":{compressible:true},"x-shader/x-vertex":{compressible:true}}},{}],200:[function(require,module,exports){
/*!
 * mime-db
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2015-2022 Douglas Christopher Wilson
 * MIT Licensed
 */
module.exports=require("./db.json")},{"./db.json":199}],201:[function(require,module,exports){
/*!
 * mime-types
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var db=require("mime-db");var extname=require("path").extname;var EXTRACT_TYPE_REGEXP=/^\s*([^;\s]*)(?:;|\s|$)/;var TEXT_TYPE_REGEXP=/^text\//i;exports.charset=charset;exports.charsets={lookup:charset};exports.contentType=contentType;exports.extension=extension;exports.extensions=Object.create(null);exports.lookup=lookup;exports.types=Object.create(null);populateMaps(exports.extensions,exports.types);function charset(type){if(!type||typeof type!=="string"){return false}var match=EXTRACT_TYPE_REGEXP.exec(type);var mime=match&&db[match[1].toLowerCase()];if(mime&&mime.charset){return mime.charset}if(match&&TEXT_TYPE_REGEXP.test(match[1])){return"UTF-8"}return false}function contentType(str){if(!str||typeof str!=="string"){return false}var mime=str.indexOf("/")===-1?exports.lookup(str):str;if(!mime){return false}if(mime.indexOf("charset")===-1){var charset=exports.charset(mime);if(charset)mime+="; charset="+charset.toLowerCase()}return mime}function extension(type){if(!type||typeof type!=="string"){return false}var match=EXTRACT_TYPE_REGEXP.exec(type);var exts=match&&exports.extensions[match[1].toLowerCase()];if(!exts||!exts.length){return false}return exts[0]}function lookup(path){if(!path||typeof path!=="string"){return false}var extension=extname("x."+path).toLowerCase().substr(1);if(!extension){return false}return exports.types[extension]||false}function populateMaps(extensions,types){var preference=["nginx","apache",undefined,"iana"];Object.keys(db).forEach(function forEachMimeType(type){var mime=db[type];var exts=mime.extensions;if(!exts||!exts.length){return}extensions[type]=exts;for(var i=0;i<exts.length;i++){var extension=exts[i];if(types[extension]){var from=preference.indexOf(db[types[extension]].source);var to=preference.indexOf(mime.source);if(types[extension]!=="application/octet-stream"&&(from>to||from===to&&types[extension].substr(0,12)==="application/")){continue}}types[extension]=type}})}},{"mime-db":200,path:undefined}],202:[function(require,module,exports){var s=1e3;var m=s*60;var h=m*60;var d=h*24;var w=d*7;var y=d*365.25;module.exports=function(val,options){options=options||{};var type=typeof val;if(type==="string"&&val.length>0){return parse(val)}else if(type==="number"&&isFinite(val)){return options.long?fmtLong(val):fmtShort(val)}throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(val))};function parse(str){str=String(str);if(str.length>100){return}var match=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(str);if(!match){return}var n=parseFloat(match[1]);var type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"yrs":case"yr":case"y":return n*y;case"weeks":case"week":case"w":return n*w;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"hrs":case"hr":case"h":return n*h;case"minutes":case"minute":case"mins":case"min":case"m":return n*m;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return undefined}}function fmtShort(ms){var msAbs=Math.abs(ms);if(msAbs>=d){return Math.round(ms/d)+"d"}if(msAbs>=h){return Math.round(ms/h)+"h"}if(msAbs>=m){return Math.round(ms/m)+"m"}if(msAbs>=s){return Math.round(ms/s)+"s"}return ms+"ms"}function fmtLong(ms){var msAbs=Math.abs(ms);if(msAbs>=d){return plural(ms,msAbs,d,"day")}if(msAbs>=h){return plural(ms,msAbs,h,"hour")}if(msAbs>=m){return plural(ms,msAbs,m,"minute")}if(msAbs>=s){return plural(ms,msAbs,s,"second")}return ms+" ms"}function plural(ms,msAbs,n,name){var isPlural=msAbs>=n*1.5;return Math.round(ms/n)+" "+name+(isPlural?"s":"")}},{}],203:[function(require,module,exports){
/*!
 * negotiator
 * Copyright(c) 2012 Federico Romero
 * Copyright(c) 2012-2014 Isaac Z. Schlueter
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var preferredCharsets=require("./lib/charset");var preferredEncodings=require("./lib/encoding");var preferredLanguages=require("./lib/language");var preferredMediaTypes=require("./lib/mediaType");module.exports=Negotiator;module.exports.Negotiator=Negotiator;function Negotiator(request){if(!(this instanceof Negotiator)){return new Negotiator(request)}this.request=request}Negotiator.prototype.charset=function charset(available){var set=this.charsets(available);return set&&set[0]};Negotiator.prototype.charsets=function charsets(available){return preferredCharsets(this.request.headers["accept-charset"],available)};Negotiator.prototype.encoding=function encoding(available){var set=this.encodings(available);return set&&set[0]};Negotiator.prototype.encodings=function encodings(available){return preferredEncodings(this.request.headers["accept-encoding"],available)};Negotiator.prototype.language=function language(available){var set=this.languages(available);return set&&set[0]};Negotiator.prototype.languages=function languages(available){return preferredLanguages(this.request.headers["accept-language"],available)};Negotiator.prototype.mediaType=function mediaType(available){var set=this.mediaTypes(available);return set&&set[0]};Negotiator.prototype.mediaTypes=function mediaTypes(available){return preferredMediaTypes(this.request.headers.accept,available)};Negotiator.prototype.preferredCharset=Negotiator.prototype.charset;Negotiator.prototype.preferredCharsets=Negotiator.prototype.charsets;Negotiator.prototype.preferredEncoding=Negotiator.prototype.encoding;Negotiator.prototype.preferredEncodings=Negotiator.prototype.encodings;Negotiator.prototype.preferredLanguage=Negotiator.prototype.language;Negotiator.prototype.preferredLanguages=Negotiator.prototype.languages;Negotiator.prototype.preferredMediaType=Negotiator.prototype.mediaType;Negotiator.prototype.preferredMediaTypes=Negotiator.prototype.mediaTypes},{"./lib/charset":204,"./lib/encoding":205,"./lib/language":206,"./lib/mediaType":207}],204:[function(require,module,exports){"use strict";module.exports=preferredCharsets;module.exports.preferredCharsets=preferredCharsets;var simpleCharsetRegExp=/^\s*([^\s;]+)\s*(?:;(.*))?$/;function parseAcceptCharset(accept){var accepts=accept.split(",");for(var i=0,j=0;i<accepts.length;i++){var charset=parseCharset(accepts[i].trim(),i);if(charset){accepts[j++]=charset}}accepts.length=j;return accepts}function parseCharset(str,i){var match=simpleCharsetRegExp.exec(str);if(!match)return null;var charset=match[1];var q=1;if(match[2]){var params=match[2].split(";");for(var j=0;j<params.length;j++){var p=params[j].trim().split("=");if(p[0]==="q"){q=parseFloat(p[1]);break}}}return{charset:charset,q:q,i:i}}function getCharsetPriority(charset,accepted,index){var priority={o:-1,q:0,s:0};for(var i=0;i<accepted.length;i++){var spec=specify(charset,accepted[i],index);if(spec&&(priority.s-spec.s||priority.q-spec.q||priority.o-spec.o)<0){priority=spec}}return priority}function specify(charset,spec,index){var s=0;if(spec.charset.toLowerCase()===charset.toLowerCase()){s|=1}else if(spec.charset!=="*"){return null}return{i:index,o:spec.i,q:spec.q,s:s}}function preferredCharsets(accept,provided){var accepts=parseAcceptCharset(accept===undefined?"*":accept||"");if(!provided){return accepts.filter(isQuality).sort(compareSpecs).map(getFullCharset)}var priorities=provided.map(function getPriority(type,index){return getCharsetPriority(type,accepts,index)});return priorities.filter(isQuality).sort(compareSpecs).map(function getCharset(priority){return provided[priorities.indexOf(priority)]})}function compareSpecs(a,b){return b.q-a.q||b.s-a.s||a.o-b.o||a.i-b.i||0}function getFullCharset(spec){return spec.charset}function isQuality(spec){return spec.q>0}},{}],205:[function(require,module,exports){"use strict";module.exports=preferredEncodings;module.exports.preferredEncodings=preferredEncodings;var simpleEncodingRegExp=/^\s*([^\s;]+)\s*(?:;(.*))?$/;function parseAcceptEncoding(accept){var accepts=accept.split(",");var hasIdentity=false;var minQuality=1;for(var i=0,j=0;i<accepts.length;i++){var encoding=parseEncoding(accepts[i].trim(),i);if(encoding){accepts[j++]=encoding;hasIdentity=hasIdentity||specify("identity",encoding);minQuality=Math.min(minQuality,encoding.q||1)}}if(!hasIdentity){accepts[j++]={encoding:"identity",q:minQuality,i:i}}accepts.length=j;return accepts}function parseEncoding(str,i){var match=simpleEncodingRegExp.exec(str);if(!match)return null;var encoding=match[1];var q=1;if(match[2]){var params=match[2].split(";");for(var j=0;j<params.length;j++){var p=params[j].trim().split("=");if(p[0]==="q"){q=parseFloat(p[1]);break}}}return{encoding:encoding,q:q,i:i}}function getEncodingPriority(encoding,accepted,index){var priority={o:-1,q:0,s:0};for(var i=0;i<accepted.length;i++){var spec=specify(encoding,accepted[i],index);if(spec&&(priority.s-spec.s||priority.q-spec.q||priority.o-spec.o)<0){priority=spec}}return priority}function specify(encoding,spec,index){var s=0;if(spec.encoding.toLowerCase()===encoding.toLowerCase()){s|=1}else if(spec.encoding!=="*"){return null}return{i:index,o:spec.i,q:spec.q,s:s}}function preferredEncodings(accept,provided){var accepts=parseAcceptEncoding(accept||"");if(!provided){return accepts.filter(isQuality).sort(compareSpecs).map(getFullEncoding)}var priorities=provided.map(function getPriority(type,index){return getEncodingPriority(type,accepts,index)});return priorities.filter(isQuality).sort(compareSpecs).map(function getEncoding(priority){return provided[priorities.indexOf(priority)]})}function compareSpecs(a,b){return b.q-a.q||b.s-a.s||a.o-b.o||a.i-b.i||0}function getFullEncoding(spec){return spec.encoding}function isQuality(spec){return spec.q>0}},{}],206:[function(require,module,exports){"use strict";module.exports=preferredLanguages;module.exports.preferredLanguages=preferredLanguages;var simpleLanguageRegExp=/^\s*([^\s\-;]+)(?:-([^\s;]+))?\s*(?:;(.*))?$/;function parseAcceptLanguage(accept){var accepts=accept.split(",");for(var i=0,j=0;i<accepts.length;i++){var language=parseLanguage(accepts[i].trim(),i);if(language){accepts[j++]=language}}accepts.length=j;return accepts}function parseLanguage(str,i){var match=simpleLanguageRegExp.exec(str);if(!match)return null;var prefix=match[1];var suffix=match[2];var full=prefix;if(suffix)full+="-"+suffix;var q=1;if(match[3]){var params=match[3].split(";");for(var j=0;j<params.length;j++){var p=params[j].split("=");if(p[0]==="q")q=parseFloat(p[1])}}return{prefix:prefix,suffix:suffix,q:q,i:i,full:full}}function getLanguagePriority(language,accepted,index){var priority={o:-1,q:0,s:0};for(var i=0;i<accepted.length;i++){var spec=specify(language,accepted[i],index);if(spec&&(priority.s-spec.s||priority.q-spec.q||priority.o-spec.o)<0){priority=spec}}return priority}function specify(language,spec,index){var p=parseLanguage(language);if(!p)return null;var s=0;if(spec.full.toLowerCase()===p.full.toLowerCase()){s|=4}else if(spec.prefix.toLowerCase()===p.full.toLowerCase()){s|=2}else if(spec.full.toLowerCase()===p.prefix.toLowerCase()){s|=1}else if(spec.full!=="*"){return null}return{i:index,o:spec.i,q:spec.q,s:s}}function preferredLanguages(accept,provided){var accepts=parseAcceptLanguage(accept===undefined?"*":accept||"");if(!provided){return accepts.filter(isQuality).sort(compareSpecs).map(getFullLanguage)}var priorities=provided.map(function getPriority(type,index){return getLanguagePriority(type,accepts,index)});return priorities.filter(isQuality).sort(compareSpecs).map(function getLanguage(priority){return provided[priorities.indexOf(priority)]})}function compareSpecs(a,b){return b.q-a.q||b.s-a.s||a.o-b.o||a.i-b.i||0}function getFullLanguage(spec){return spec.full}function isQuality(spec){return spec.q>0}},{}],207:[function(require,module,exports){"use strict";module.exports=preferredMediaTypes;module.exports.preferredMediaTypes=preferredMediaTypes;var simpleMediaTypeRegExp=/^\s*([^\s\/;]+)\/([^;\s]+)\s*(?:;(.*))?$/;function parseAccept(accept){var accepts=splitMediaTypes(accept);for(var i=0,j=0;i<accepts.length;i++){var mediaType=parseMediaType(accepts[i].trim(),i);if(mediaType){accepts[j++]=mediaType}}accepts.length=j;return accepts}function parseMediaType(str,i){var match=simpleMediaTypeRegExp.exec(str);if(!match)return null;var params=Object.create(null);var q=1;var subtype=match[2];var type=match[1];if(match[3]){var kvps=splitParameters(match[3]).map(splitKeyValuePair);for(var j=0;j<kvps.length;j++){var pair=kvps[j];var key=pair[0].toLowerCase();var val=pair[1];var value=val&&val[0]==='"'&&val[val.length-1]==='"'?val.substr(1,val.length-2):val;if(key==="q"){q=parseFloat(value);break}params[key]=value}}return{type:type,subtype:subtype,params:params,q:q,i:i}}function getMediaTypePriority(type,accepted,index){var priority={o:-1,q:0,s:0};for(var i=0;i<accepted.length;i++){var spec=specify(type,accepted[i],index);if(spec&&(priority.s-spec.s||priority.q-spec.q||priority.o-spec.o)<0){priority=spec}}return priority}function specify(type,spec,index){var p=parseMediaType(type);var s=0;if(!p){return null}if(spec.type.toLowerCase()==p.type.toLowerCase()){s|=4}else if(spec.type!="*"){return null}if(spec.subtype.toLowerCase()==p.subtype.toLowerCase()){s|=2}else if(spec.subtype!="*"){return null}var keys=Object.keys(spec.params);if(keys.length>0){if(keys.every(function(k){return spec.params[k]=="*"||(spec.params[k]||"").toLowerCase()==(p.params[k]||"").toLowerCase()})){s|=1}else{return null}}return{i:index,o:spec.i,q:spec.q,s:s}}function preferredMediaTypes(accept,provided){var accepts=parseAccept(accept===undefined?"*/*":accept||"");if(!provided){return accepts.filter(isQuality).sort(compareSpecs).map(getFullType)}var priorities=provided.map(function getPriority(type,index){return getMediaTypePriority(type,accepts,index)});return priorities.filter(isQuality).sort(compareSpecs).map(function getType(priority){return provided[priorities.indexOf(priority)]})}function compareSpecs(a,b){return b.q-a.q||b.s-a.s||a.o-b.o||a.i-b.i||0}function getFullType(spec){return spec.type+"/"+spec.subtype}function isQuality(spec){return spec.q>0}function quoteCount(string){var count=0;var index=0;while((index=string.indexOf('"',index))!==-1){count++;index++}return count}function splitKeyValuePair(str){var index=str.indexOf("=");var key;var val;if(index===-1){key=str}else{key=str.substr(0,index);val=str.substr(index+1)}return[key,val]}function splitMediaTypes(accept){var accepts=accept.split(",");for(var i=1,j=0;i<accepts.length;i++){if(quoteCount(accepts[j])%2==0){accepts[++j]=accepts[i]}else{accepts[j]+=","+accepts[i]}}accepts.length=j+1;return accepts}function splitParameters(str){var parameters=str.split(";");for(var i=1,j=0;i<parameters.length;i++){if(quoteCount(parameters[j])%2==0){parameters[++j]=parameters[i]}else{parameters[j]+=";"+parameters[i]}}parameters.length=j+1;for(var i=0;i<parameters.length;i++){parameters[i]=parameters[i].trim()}return parameters}},{}],208:[function(require,module,exports){
/*
object-assign
(c) Sindre Sorhus
@license MIT
*/
"use strict";var getOwnPropertySymbols=Object.getOwnPropertySymbols;var hasOwnProperty=Object.prototype.hasOwnProperty;var propIsEnumerable=Object.prototype.propertyIsEnumerable;function toObject(val){if(val===null||val===undefined){throw new TypeError("Object.assign cannot be called with null or undefined")}return Object(val)}function shouldUseNative(){try{if(!Object.assign){return false}var test1=new String("abc");test1[5]="de";if(Object.getOwnPropertyNames(test1)[0]==="5"){return false}var test2={};for(var i=0;i<10;i++){test2["_"+String.fromCharCode(i)]=i}var order2=Object.getOwnPropertyNames(test2).map(function(n){return test2[n]});if(order2.join("")!=="0123456789"){return false}var test3={};"abcdefghijklmnopqrst".split("").forEach(function(letter){test3[letter]=letter});if(Object.keys(Object.assign({},test3)).join("")!=="abcdefghijklmnopqrst"){return false}return true}catch(err){return false}}module.exports=shouldUseNative()?Object.assign:function(target,source){var from;var to=toObject(target);var symbols;for(var s=1;s<arguments.length;s++){from=Object(arguments[s]);for(var key in from){if(hasOwnProperty.call(from,key)){to[key]=from[key]}}if(getOwnPropertySymbols){symbols=getOwnPropertySymbols(from);for(var i=0;i<symbols.length;i++){if(propIsEnumerable.call(from,symbols[i])){to[symbols[i]]=from[symbols[i]]}}}}return to}},{}],209:[function(require,module,exports){
/*!
 * parseurl
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2014-2017 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var url=require("url");var parse=url.parse;var Url=url.Url;module.exports=parseurl;module.exports.original=originalurl;function parseurl(req){var url=req.url;if(url===undefined){return undefined}var parsed=req._parsedUrl;if(fresh(url,parsed)){return parsed}parsed=fastparse(url);parsed._raw=url;return req._parsedUrl=parsed}function originalurl(req){var url=req.originalUrl;if(typeof url!=="string"){return parseurl(req)}var parsed=req._parsedOriginalUrl;if(fresh(url,parsed)){return parsed}parsed=fastparse(url);parsed._raw=url;return req._parsedOriginalUrl=parsed}function fastparse(str){if(typeof str!=="string"||str.charCodeAt(0)!==47){return parse(str)}var pathname=str;var query=null;var search=null;for(var i=1;i<str.length;i++){switch(str.charCodeAt(i)){case 63:if(search===null){pathname=str.substring(0,i);query=str.substring(i+1);search=str.substring(i)}break;case 9:case 10:case 12:case 13:case 32:case 35:case 160:case 65279:return parse(str)}}var url=Url!==undefined?new Url:{};url.path=str;url.href=str;url.pathname=pathname;if(search!==null){url.query=query;url.search=search}return url}function fresh(url,parsedUrl){return typeof parsedUrl==="object"&&parsedUrl!==null&&(Url===undefined||parsedUrl instanceof Url)&&parsedUrl._raw===url}},{url:undefined}],210:[function(require,module,exports){var html4={};html4.atype={NONE:0,URI:1,URI_FRAGMENT:11,SCRIPT:2,STYLE:3,ID:4,IDREF:5,IDREFS:6,GLOBAL_NAME:7,LOCAL_NAME:8,CLASSES:9,FRAME_TARGET:10};html4.ATTRIBS={"*::class":9,"*::dir":0,"*::id":4,"*::lang":0,"*::onclick":2,"*::ondblclick":2,"*::onkeydown":2,"*::onkeypress":2,"*::onkeyup":2,"*::onload":2,"*::onmousedown":2,"*::onmousemove":2,"*::onmouseout":2,"*::onmouseover":2,"*::onmouseup":2,"*::style":3,"*::title":0,"a::accesskey":0,"a::coords":0,"a::href":1,"a::hreflang":0,"a::name":7,"a::onblur":2,"a::onfocus":2,"a::rel":0,"a::rev":0,"a::shape":0,"a::tabindex":0,"a::target":10,"a::type":0,"area::accesskey":0,"area::alt":0,"area::coords":0,"area::href":1,"area::nohref":0,"area::onblur":2,"area::onfocus":2,"area::shape":0,"area::tabindex":0,"area::target":10,"bdo::dir":0,"blockquote::cite":1,"br::clear":0,"button::accesskey":0,"button::disabled":0,"button::name":8,"button::onblur":2,"button::onfocus":2,"button::tabindex":0,"button::type":0,"button::value":0,"caption::align":0,"col::align":0,"col::char":0,"col::charoff":0,"col::span":0,"col::valign":0,"col::width":0,"colgroup::align":0,"colgroup::char":0,"colgroup::charoff":0,"colgroup::span":0,"colgroup::valign":0,"colgroup::width":0,"del::cite":1,"del::datetime":0,"dir::compact":0,"div::align":0,"dl::compact":0,"font::color":0,"font::face":0,"font::size":0,"form::accept":0,"form::action":1,"form::autocomplete":0,"form::enctype":0,"form::method":0,"form::name":7,"form::onreset":2,"form::onsubmit":2,"form::target":10,"h1::align":0,"h2::align":0,"h3::align":0,"h4::align":0,"h5::align":0,"h6::align":0,"hr::align":0,"hr::noshade":0,"hr::size":0,"hr::width":0,"iframe::align":0,"iframe::frameborder":0,"iframe::height":0,"iframe::marginheight":0,"iframe::marginwidth":0,"iframe::width":0,"img::align":0,"img::alt":0,"img::border":0,"img::height":0,"img::hspace":0,"img::ismap":0,"img::name":7,"img::src":1,"img::usemap":11,"img::vspace":0,"img::width":0,"input::accept":0,"input::accesskey":0,"input::align":0,"input::alt":0,"input::autocomplete":0,"input::checked":0,"input::disabled":0,"input::ismap":0,"input::maxlength":0,"input::name":8,"input::onblur":2,"input::onchange":2,"input::onfocus":2,"input::onselect":2,"input::readonly":0,"input::size":0,"input::src":1,"input::tabindex":0,"input::type":0,"input::usemap":11,"input::value":0,"ins::cite":1,"ins::datetime":0,"label::accesskey":0,"label::for":5,"label::onblur":2,"label::onfocus":2,"legend::accesskey":0,"legend::align":0,"li::type":0,"li::value":0,"map::name":7,"menu::compact":0,"ol::compact":0,"ol::start":0,"ol::type":0,"optgroup::disabled":0,"optgroup::label":0,"option::disabled":0,"option::label":0,"option::selected":0,"option::value":0,"p::align":0,"pre::width":0,"q::cite":1,"select::disabled":0,"select::multiple":0,"select::name":8,"select::onblur":2,"select::onchange":2,"select::onfocus":2,"select::size":0,"select::tabindex":0,"table::align":0,"table::bgcolor":0,"table::border":0,"table::cellpadding":0,"table::cellspacing":0,"table::frame":0,"table::rules":0,"table::summary":0,"table::width":0,"tbody::align":0,"tbody::char":0,"tbody::charoff":0,"tbody::valign":0,"td::abbr":0,"td::align":0,"td::axis":0,"td::bgcolor":0,"td::char":0,"td::charoff":0,"td::colspan":0,"td::headers":6,"td::height":0,"td::nowrap":0,"td::rowspan":0,"td::scope":0,"td::valign":0,"td::width":0,"textarea::accesskey":0,"textarea::cols":0,"textarea::disabled":0,"textarea::name":8,"textarea::onblur":2,"textarea::onchange":2,"textarea::onfocus":2,"textarea::onselect":2,"textarea::readonly":0,"textarea::rows":0,"textarea::tabindex":0,"tfoot::align":0,"tfoot::char":0,"tfoot::charoff":0,"tfoot::valign":0,"th::abbr":0,"th::align":0,"th::axis":0,"th::bgcolor":0,"th::char":0,"th::charoff":0,"th::colspan":0,"th::headers":6,"th::height":0,"th::nowrap":0,"th::rowspan":0,"th::scope":0,"th::valign":0,"th::width":0,"thead::align":0,"thead::char":0,"thead::charoff":0,"thead::valign":0,"tr::align":0,"tr::bgcolor":0,"tr::char":0,"tr::charoff":0,"tr::valign":0,"ul::compact":0,"ul::type":0};html4.eflags={OPTIONAL_ENDTAG:1,EMPTY:2,CDATA:4,RCDATA:8,UNSAFE:16,FOLDABLE:32,SCRIPT:64,STYLE:128};html4.ELEMENTS={a:0,abbr:0,acronym:0,address:0,applet:16,area:2,b:0,base:18,basefont:18,bdo:0,big:0,blockquote:0,body:49,br:2,button:0,caption:0,center:0,cite:0,code:0,col:2,colgroup:1,dd:1,del:0,dfn:0,dir:0,div:0,dl:0,dt:1,em:0,fieldset:0,font:0,form:0,frame:18,frameset:16,h1:0,h2:0,h3:0,h4:0,h5:0,h6:0,head:49,hr:2,html:49,i:0,iframe:4,img:2,input:2,ins:0,isindex:18,kbd:0,label:0,legend:0,li:1,link:18,map:0,menu:0,meta:18,noframes:20,noscript:20,object:16,ol:0,optgroup:0,option:1,p:1,param:18,pre:0,q:0,s:0,samp:0,script:84,select:0,small:0,span:0,strike:0,strong:0,style:148,sub:0,sup:0,table:0,tbody:1,td:1,textarea:8,tfoot:1,th:1,thead:1,title:24,tr:1,tt:0,u:0,ul:0,var:0};html4.URIEFFECTS={};html4.LOADERTYPES={};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=html4}exports.URI=html4}else{if(typeof window!=="undefined"){window["html4"]=html4}}},{}],211:[function(require,module,exports){var URI=function(){function parse(uriStr){var m=(""+uriStr).match(URI_RE_);if(!m){return null}return new URI(nullIfAbsent(m[1]),nullIfAbsent(m[2]),nullIfAbsent(m[3]),nullIfAbsent(m[4]),nullIfAbsent(m[5]),nullIfAbsent(m[6]),nullIfAbsent(m[7]))}function create(scheme,credentials,domain,port,path,query,fragment){var uri=new URI(encodeIfExists2(scheme,URI_DISALLOWED_IN_SCHEME_OR_CREDENTIALS_),encodeIfExists2(credentials,URI_DISALLOWED_IN_SCHEME_OR_CREDENTIALS_),encodeIfExists(domain),port>0?port.toString():null,encodeIfExists2(path,URI_DISALLOWED_IN_PATH_),null,encodeIfExists(fragment));if(query){if("string"===typeof query){uri.setRawQuery(query.replace(/[^?&=0-9A-Za-z_\-~.%]/g,encodeOne))}else{uri.setAllParameters(query)}}return uri}function encodeIfExists(unescapedPart){if("string"==typeof unescapedPart){return encodeURIComponent(unescapedPart)}return null}function encodeIfExists2(unescapedPart,extra){if("string"==typeof unescapedPart){return encodeURI(unescapedPart).replace(extra,encodeOne)}return null}function encodeOne(ch){var n=ch.charCodeAt(0);return"%"+"0123456789ABCDEF".charAt(n>>4&15)+"0123456789ABCDEF".charAt(n&15)}function normPath(path){return path.replace(/(^|\/)\.(?:\/|$)/g,"$1").replace(/\/{2,}/g,"/")}var PARENT_DIRECTORY_HANDLER=new RegExp(""+"(/|^)"+"(?:[^./][^/]*|\\.{2,}(?:[^./][^/]*)|\\.{3,}[^/]*)"+"/\\.\\.(?:/|$)");var PARENT_DIRECTORY_HANDLER_RE=new RegExp(PARENT_DIRECTORY_HANDLER);var EXTRA_PARENT_PATHS_RE=/^(?:\.\.\/)*(?:\.\.$)?/;function collapse_dots(path){if(path===null){return null}var p=normPath(path);var r=PARENT_DIRECTORY_HANDLER_RE;for(var q;(q=p.replace(r,"$1"))!=p;p=q){}return p}function resolve(baseUri,relativeUri){var absoluteUri=baseUri.clone();var overridden=relativeUri.hasScheme();if(overridden){absoluteUri.setRawScheme(relativeUri.getRawScheme())}else{overridden=relativeUri.hasCredentials()}if(overridden){absoluteUri.setRawCredentials(relativeUri.getRawCredentials())}else{overridden=relativeUri.hasDomain()}if(overridden){absoluteUri.setRawDomain(relativeUri.getRawDomain())}else{overridden=relativeUri.hasPort()}var rawPath=relativeUri.getRawPath();var simplifiedPath=collapse_dots(rawPath);if(overridden){absoluteUri.setPort(relativeUri.getPort());simplifiedPath=simplifiedPath&&simplifiedPath.replace(EXTRA_PARENT_PATHS_RE,"")}else{overridden=!!rawPath;if(overridden){if(simplifiedPath.charCodeAt(0)!==47){var absRawPath=collapse_dots(absoluteUri.getRawPath()||"").replace(EXTRA_PARENT_PATHS_RE,"");var slash=absRawPath.lastIndexOf("/")+1;simplifiedPath=collapse_dots((slash?absRawPath.substring(0,slash):"")+collapse_dots(rawPath)).replace(EXTRA_PARENT_PATHS_RE,"")}}else{simplifiedPath=simplifiedPath&&simplifiedPath.replace(EXTRA_PARENT_PATHS_RE,"");if(simplifiedPath!==rawPath){absoluteUri.setRawPath(simplifiedPath)}}}if(overridden){absoluteUri.setRawPath(simplifiedPath)}else{overridden=relativeUri.hasQuery()}if(overridden){absoluteUri.setRawQuery(relativeUri.getRawQuery())}else{overridden=relativeUri.hasFragment()}if(overridden){absoluteUri.setRawFragment(relativeUri.getRawFragment())}return absoluteUri}function URI(rawScheme,rawCredentials,rawDomain,port,rawPath,rawQuery,rawFragment){this.scheme_=rawScheme;this.credentials_=rawCredentials;this.domain_=rawDomain;this.port_=port;this.path_=rawPath;this.query_=rawQuery;this.fragment_=rawFragment;this.paramCache_=null}URI.prototype.toString=function(){var out=[];if(null!==this.scheme_){out.push(this.scheme_,":")}if(null!==this.domain_){out.push("//");if(null!==this.credentials_){out.push(this.credentials_,"@")}out.push(this.domain_);if(null!==this.port_){out.push(":",this.port_.toString())}}if(null!==this.path_){out.push(this.path_)}if(null!==this.query_){out.push("?",this.query_)}if(null!==this.fragment_){out.push("#",this.fragment_)}return out.join("")};URI.prototype.clone=function(){return new URI(this.scheme_,this.credentials_,this.domain_,this.port_,this.path_,this.query_,this.fragment_)};URI.prototype.getScheme=function(){return this.scheme_&&decodeURIComponent(this.scheme_).toLowerCase()};URI.prototype.getRawScheme=function(){return this.scheme_};URI.prototype.setScheme=function(newScheme){this.scheme_=encodeIfExists2(newScheme,URI_DISALLOWED_IN_SCHEME_OR_CREDENTIALS_);return this};URI.prototype.setRawScheme=function(newScheme){this.scheme_=newScheme?newScheme:null;return this};URI.prototype.hasScheme=function(){return null!==this.scheme_};URI.prototype.getCredentials=function(){return this.credentials_&&decodeURIComponent(this.credentials_)};URI.prototype.getRawCredentials=function(){return this.credentials_};URI.prototype.setCredentials=function(newCredentials){this.credentials_=encodeIfExists2(newCredentials,URI_DISALLOWED_IN_SCHEME_OR_CREDENTIALS_);return this};URI.prototype.setRawCredentials=function(newCredentials){this.credentials_=newCredentials?newCredentials:null;return this};URI.prototype.hasCredentials=function(){return null!==this.credentials_};URI.prototype.getDomain=function(){return this.domain_&&decodeURIComponent(this.domain_)};URI.prototype.getRawDomain=function(){return this.domain_};URI.prototype.setDomain=function(newDomain){return this.setRawDomain(newDomain&&encodeURIComponent(newDomain))};URI.prototype.setRawDomain=function(newDomain){this.domain_=newDomain?newDomain:null;return this.setRawPath(this.path_)};URI.prototype.hasDomain=function(){return null!==this.domain_};URI.prototype.getPort=function(){return this.port_&&decodeURIComponent(this.port_)};URI.prototype.setPort=function(newPort){if(newPort){newPort=Number(newPort);if(newPort!==(newPort&65535)){throw new Error("Bad port number "+newPort)}this.port_=""+newPort}else{this.port_=null}return this};URI.prototype.hasPort=function(){return null!==this.port_};URI.prototype.getPath=function(){return this.path_&&decodeURIComponent(this.path_)};URI.prototype.getRawPath=function(){return this.path_};URI.prototype.setPath=function(newPath){return this.setRawPath(encodeIfExists2(newPath,URI_DISALLOWED_IN_PATH_))};URI.prototype.setRawPath=function(newPath){if(newPath){newPath=String(newPath);this.path_=!this.domain_||/^\//.test(newPath)?newPath:"/"+newPath}else{this.path_=null}return this};URI.prototype.hasPath=function(){return null!==this.path_};URI.prototype.getQuery=function(){return this.query_&&decodeURIComponent(this.query_).replace(/\+/g," ")};URI.prototype.getRawQuery=function(){return this.query_};URI.prototype.setQuery=function(newQuery){this.paramCache_=null;this.query_=encodeIfExists(newQuery);return this};URI.prototype.setRawQuery=function(newQuery){this.paramCache_=null;this.query_=newQuery?newQuery:null;return this};URI.prototype.hasQuery=function(){return null!==this.query_};URI.prototype.setAllParameters=function(params){if(typeof params==="object"){if(!(params instanceof Array)&&(params instanceof Object||Object.prototype.toString.call(params)!=="[object Array]")){var newParams=[];var i=-1;for(var k in params){var v=params[k];if("string"===typeof v){newParams[++i]=k;newParams[++i]=v}}params=newParams}}this.paramCache_=null;var queryBuf=[];var separator="";for(var j=0;j<params.length;){var k=params[j++];var v=params[j++];queryBuf.push(separator,encodeURIComponent(k.toString()));separator="&";if(v){queryBuf.push("=",encodeURIComponent(v.toString()))}}this.query_=queryBuf.join("");return this};URI.prototype.checkParameterCache_=function(){if(!this.paramCache_){var q=this.query_;if(!q){this.paramCache_=[]}else{var cgiParams=q.split(/[&\?]/);var out=[];var k=-1;for(var i=0;i<cgiParams.length;++i){var m=cgiParams[i].match(/^([^=]*)(?:=(.*))?$/);out[++k]=decodeURIComponent(m[1]).replace(/\+/g," ");out[++k]=decodeURIComponent(m[2]||"").replace(/\+/g," ")}this.paramCache_=out}}};URI.prototype.setParameterValues=function(key,values){if(typeof values==="string"){values=[values]}this.checkParameterCache_();var newValueIndex=0;var pc=this.paramCache_;var params=[];for(var i=0,k=0;i<pc.length;i+=2){if(key===pc[i]){if(newValueIndex<values.length){params.push(key,values[newValueIndex++])}}else{params.push(pc[i],pc[i+1])}}while(newValueIndex<values.length){params.push(key,values[newValueIndex++])}this.setAllParameters(params);return this};URI.prototype.removeParameter=function(key){return this.setParameterValues(key,[])};URI.prototype.getAllParameters=function(){this.checkParameterCache_();return this.paramCache_.slice(0,this.paramCache_.length)};URI.prototype.getParameterValues=function(paramNameUnescaped){this.checkParameterCache_();var values=[];for(var i=0;i<this.paramCache_.length;i+=2){if(paramNameUnescaped===this.paramCache_[i]){values.push(this.paramCache_[i+1])}}return values};URI.prototype.getParameterMap=function(paramNameUnescaped){this.checkParameterCache_();var paramMap={};for(var i=0;i<this.paramCache_.length;i+=2){var key=this.paramCache_[i++],value=this.paramCache_[i++];if(!(key in paramMap)){paramMap[key]=[value]}else{paramMap[key].push(value)}}return paramMap};URI.prototype.getParameterValue=function(paramNameUnescaped){this.checkParameterCache_();for(var i=0;i<this.paramCache_.length;i+=2){if(paramNameUnescaped===this.paramCache_[i]){return this.paramCache_[i+1]}}return null};URI.prototype.getFragment=function(){return this.fragment_&&decodeURIComponent(this.fragment_)};URI.prototype.getRawFragment=function(){return this.fragment_};URI.prototype.setFragment=function(newFragment){this.fragment_=newFragment?encodeURIComponent(newFragment):null;return this};URI.prototype.setRawFragment=function(newFragment){this.fragment_=newFragment?newFragment:null;return this};URI.prototype.hasFragment=function(){return null!==this.fragment_};function nullIfAbsent(matchPart){return"string"==typeof matchPart&&matchPart.length>0?matchPart:null}var URI_RE_=new RegExp("^"+"(?:"+"([^:/?#]+)"+":)?"+"(?://"+"(?:([^/?#]*)@)?"+"([^/?#:@]*)"+"(?::([0-9]+))?"+")?"+"([^?#]+)?"+"(?:\\?([^#]*))?"+"(?:#(.*))?"+"$");var URI_DISALLOWED_IN_SCHEME_OR_CREDENTIALS_=/[#\/\?@]/g;var URI_DISALLOWED_IN_PATH_=/[\#\?]/g;URI.parse=parse;URI.create=create;URI.resolve=resolve;URI.collapse_dots=collapse_dots;URI.utils={mimeTypeOf:function(uri){var uriObj=parse(uri);if(/\.html$/.test(uriObj.getPath())){return"text/html"}else{return"application/javascript"}},resolve:function(base,uri){if(base){return resolve(parse(base),parse(uri)).toString()}else{return""+uri}}};return URI}();if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=URI}exports.URI=URI}else{if(typeof window!=="undefined"){window["URI"]=URI}}},{}],212:[function(require,module,exports){var html4=require("./lib/html4.js");var URI=require("./lib/uri.js");if("I".toLowerCase()!=="i"){throw"I/i problem"}var html=function(html4){var parseCssDeclarations,sanitizeCssProperty,cssSchema;if("undefined"!==typeof window){parseCssDeclarations=window["parseCssDeclarations"];sanitizeCssProperty=window["sanitizeCssProperty"];cssSchema=window["cssSchema"]}var ENTITIES={lt:"<",LT:"<",gt:">",GT:">",amp:"&",AMP:"&",quot:'"',apos:"'",nbsp:""};var decimalEscapeRe=/^#(\d+)$/;var hexEscapeRe=/^#x([0-9A-Fa-f]+)$/;var safeEntityNameRe=/^[A-Za-z][A-za-z0-9]+$/;var entityLookupElement="undefined"!==typeof window&&window["document"]?window["document"].createElement("textarea"):null;function lookupEntity(name){if(ENTITIES.hasOwnProperty(name)){return ENTITIES[name]}var m=name.match(decimalEscapeRe);if(m){return String.fromCharCode(parseInt(m[1],10))}else if(!!(m=name.match(hexEscapeRe))){return String.fromCharCode(parseInt(m[1],16))}else if(entityLookupElement&&safeEntityNameRe.test(name)){entityLookupElement.innerHTML="&"+name+";";var text=entityLookupElement.textContent;ENTITIES[name]=text;return text}else{return"&"+name+";"}}function decodeOneEntity(_,name){return lookupEntity(name)}var nulRe=/\0/g;function stripNULs(s){return s.replace(nulRe,"")}var ENTITY_RE_1=/&(#[0-9]+|#[xX][0-9A-Fa-f]+|\w+);/g;var ENTITY_RE_2=/^(#[0-9]+|#[xX][0-9A-Fa-f]+|\w+);/;function unescapeEntities(s){if(s){return s.replace(ENTITY_RE_1,decodeOneEntity)}else{return s}}var ampRe=/&/g;var looseAmpRe=/&([^a-z#]|#(?:[^0-9x]|x(?:[^0-9a-f]|$)|$)|$)/gi;var ltRe=/[<]/g;var gtRe=/>/g;var quotRe=/\"/g;function escapeAttrib(s){if(s){return(""+s).replace(ampRe,"&amp;").replace(ltRe,"&lt;").replace(gtRe,"&gt;").replace(quotRe,"&#34;")}else{return s}}function normalizeRCData(rcdata){if(rcdata){return rcdata.replace(looseAmpRe,"&amp;$1").replace(ltRe,"&lt;").replace(gtRe,"&gt;")}else{return rcdata}}var ATTR_RE=new RegExp("^\\s*"+"([-.:\\w]+)"+"(?:"+("\\s*(=)\\s*"+"("+('(")[^"]*("|$)'+"|"+"(')[^']*('|$)"+"|"+"(?=[a-z][-\\w]*\\s*=)"+"|"+"[^\"'\\s]*")+")")+")?","i");var splitWillCapture="a,b".split(/(,)/).length===3;var EFLAGS_TEXT=html4.eflags["CDATA"]|html4.eflags["RCDATA"];function makeSaxParser(handler){var hcopy={cdata:handler.cdata||handler["cdata"],comment:handler.comment||handler["comment"],endDoc:handler.endDoc||handler["endDoc"],endTag:handler.endTag||handler["endTag"],pcdata:handler.pcdata||handler["pcdata"],rcdata:handler.rcdata||handler["rcdata"],startDoc:handler.startDoc||handler["startDoc"],startTag:handler.startTag||handler["startTag"]};return function(htmlText,param){return parse(htmlText,hcopy,param)}}var continuationMarker={};function parse(htmlText,handler,param){var m,p,tagName;var parts=htmlSplit(htmlText);var state={noMoreGT:false,noMoreEndComments:false};parseCPS(handler,parts,0,state,param)}function continuationMaker(h,parts,initial,state,param){return function(){parseCPS(h,parts,initial,state,param)}}function parseCPS(h,parts,initial,state,param){try{if(h.startDoc&&initial==0){h.startDoc(param)}var m,p,tagName;for(var pos=initial,end=parts.length;pos<end;){var current=parts[pos++];var next=parts[pos];switch(current){case"&":if(ENTITY_RE_2.test(next)){if(h.pcdata){h.pcdata("&"+next,param,continuationMarker,continuationMaker(h,parts,pos,state,param))}pos++}else{if(h.pcdata){h.pcdata("&amp;",param,continuationMarker,continuationMaker(h,parts,pos,state,param))}}break;case"</":if(m=/^([-\w:]+)[^\'\"]*/.exec(next)){if(m[0].length===next.length&&parts[pos+1]===">"){pos+=2;tagName=m[1].toLowerCase();if(h.endTag){h.endTag(tagName,param,continuationMarker,continuationMaker(h,parts,pos,state,param))}}else{pos=parseEndTag(parts,pos,h,param,continuationMarker,state)}}else{if(h.pcdata){h.pcdata("&lt;/",param,continuationMarker,continuationMaker(h,parts,pos,state,param))}}break;case"<":if(m=/^([-\w:]+)\s*\/?/.exec(next)){if(m[0].length===next.length&&parts[pos+1]===">"){pos+=2;tagName=m[1].toLowerCase();if(h.startTag){h.startTag(tagName,[],param,continuationMarker,continuationMaker(h,parts,pos,state,param))}var eflags=html4.ELEMENTS[tagName];if(eflags&EFLAGS_TEXT){var tag={name:tagName,next:pos,eflags:eflags};pos=parseText(parts,tag,h,param,continuationMarker,state)}}else{pos=parseStartTag(parts,pos,h,param,continuationMarker,state)}}else{if(h.pcdata){h.pcdata("&lt;",param,continuationMarker,continuationMaker(h,parts,pos,state,param))}}break;case"\x3c!--":if(!state.noMoreEndComments){for(p=pos+1;p<end;p++){if(parts[p]===">"&&/--$/.test(parts[p-1])){break}}if(p<end){if(h.comment){var comment=parts.slice(pos,p).join("");h.comment(comment.substr(0,comment.length-2),param,continuationMarker,continuationMaker(h,parts,p+1,state,param))}pos=p+1}else{state.noMoreEndComments=true}}if(state.noMoreEndComments){if(h.pcdata){h.pcdata("&lt;!--",param,continuationMarker,continuationMaker(h,parts,pos,state,param))}}break;case"<!":if(!/^\w/.test(next)){if(h.pcdata){h.pcdata("&lt;!",param,continuationMarker,continuationMaker(h,parts,pos,state,param))}}else{if(!state.noMoreGT){for(p=pos+1;p<end;p++){if(parts[p]===">"){break}}if(p<end){pos=p+1}else{state.noMoreGT=true}}if(state.noMoreGT){if(h.pcdata){h.pcdata("&lt;!",param,continuationMarker,continuationMaker(h,parts,pos,state,param))}}}break;case"<?":if(!state.noMoreGT){for(p=pos+1;p<end;p++){if(parts[p]===">"){break}}if(p<end){pos=p+1}else{state.noMoreGT=true}}if(state.noMoreGT){if(h.pcdata){h.pcdata("&lt;?",param,continuationMarker,continuationMaker(h,parts,pos,state,param))}}break;case">":if(h.pcdata){h.pcdata("&gt;",param,continuationMarker,continuationMaker(h,parts,pos,state,param))}break;case"":break;default:if(h.pcdata){h.pcdata(current,param,continuationMarker,continuationMaker(h,parts,pos,state,param))}break}}if(h.endDoc){h.endDoc(param)}}catch(e){if(e!==continuationMarker){throw e}}}function htmlSplit(str){var re=/(<\/|<\!--|<[!?]|[&<>])/g;str+="";if(splitWillCapture){return str.split(re)}else{var parts=[];var lastPos=0;var m;while((m=re.exec(str))!==null){parts.push(str.substring(lastPos,m.index));parts.push(m[0]);lastPos=m.index+m[0].length}parts.push(str.substring(lastPos));return parts}}function parseEndTag(parts,pos,h,param,continuationMarker,state){var tag=parseTagAndAttrs(parts,pos);if(!tag){return parts.length}if(h.endTag){h.endTag(tag.name,param,continuationMarker,continuationMaker(h,parts,pos,state,param))}return tag.next}function parseStartTag(parts,pos,h,param,continuationMarker,state){var tag=parseTagAndAttrs(parts,pos);if(!tag){return parts.length}if(h.startTag){h.startTag(tag.name,tag.attrs,param,continuationMarker,continuationMaker(h,parts,tag.next,state,param))}if(tag.eflags&EFLAGS_TEXT){return parseText(parts,tag,h,param,continuationMarker,state)}else{return tag.next}}var endTagRe={};function parseText(parts,tag,h,param,continuationMarker,state){var end=parts.length;if(!endTagRe.hasOwnProperty(tag.name)){endTagRe[tag.name]=new RegExp("^"+tag.name+"(?:[\\s\\/]|$)","i")}var re=endTagRe[tag.name];var first=tag.next;var p=tag.next+1;for(;p<end;p++){if(parts[p-1]==="</"&&re.test(parts[p])){break}}if(p<end){p-=1}var buf=parts.slice(first,p).join("");if(tag.eflags&html4.eflags["CDATA"]){if(h.cdata){h.cdata(buf,param,continuationMarker,continuationMaker(h,parts,p,state,param))}}else if(tag.eflags&html4.eflags["RCDATA"]){if(h.rcdata){h.rcdata(normalizeRCData(buf),param,continuationMarker,continuationMaker(h,parts,p,state,param))}}else{throw new Error("bug")}return p}function parseTagAndAttrs(parts,pos){var m=/^([-\w:]+)/.exec(parts[pos]);var tag={};tag.name=m[1].toLowerCase();tag.eflags=html4.ELEMENTS[tag.name];var buf=parts[pos].substr(m[0].length);var p=pos+1;var end=parts.length;for(;p<end;p++){if(parts[p]===">"){break}buf+=parts[p]}if(end<=p){return void 0}var attrs=[];while(buf!==""){m=ATTR_RE.exec(buf);if(!m){buf=buf.replace(/^[\s\S][^a-z\s]*/,"")}else if(m[4]&&!m[5]||m[6]&&!m[7]){var quote=m[4]||m[6];var sawQuote=false;var abuf=[buf,parts[p++]];for(;p<end;p++){if(sawQuote){if(parts[p]===">"){break}}else if(0<=parts[p].indexOf(quote)){sawQuote=true}abuf.push(parts[p])}if(end<=p){break}buf=abuf.join("");continue}else{var aName=m[1].toLowerCase();var aValue=m[2]?decodeValue(m[3]):"";attrs.push(aName,aValue);buf=buf.substr(m[0].length)}}tag.attrs=attrs;tag.next=p+1;return tag}function decodeValue(v){var q=v.charCodeAt(0);if(q===34||q===39){v=v.substr(1,v.length-2)}return unescapeEntities(stripNULs(v))}function makeHtmlSanitizer(tagPolicy){var stack;var ignoring;var emit=function(text,out){if(!ignoring){out.push(text)}};return makeSaxParser({startDoc:function(_){stack=[];ignoring=false},startTag:function(tagNameOrig,attribs,out){if(ignoring){return}if(!html4.ELEMENTS.hasOwnProperty(tagNameOrig)){return}var eflagsOrig=html4.ELEMENTS[tagNameOrig];if(eflagsOrig&html4.eflags["FOLDABLE"]){return}var decision=tagPolicy(tagNameOrig,attribs);if(!decision){ignoring=!(eflagsOrig&html4.eflags["EMPTY"]);return}else if(typeof decision!=="object"){throw new Error("tagPolicy did not return object (old API?)")}if("attribs"in decision){attribs=decision["attribs"]}else{throw new Error("tagPolicy gave no attribs")}var eflagsRep;var tagNameRep;if("tagName"in decision){tagNameRep=decision["tagName"];eflagsRep=html4.ELEMENTS[tagNameRep]}else{tagNameRep=tagNameOrig;eflagsRep=eflagsOrig}if(eflagsOrig&html4.eflags["OPTIONAL_ENDTAG"]){var onStack=stack[stack.length-1];if(onStack&&onStack.orig===tagNameOrig&&(onStack.rep!==tagNameRep||tagNameOrig!==tagNameRep)){out.push("</",onStack.rep,">")}}if(!(eflagsOrig&html4.eflags["EMPTY"])){stack.push({orig:tagNameOrig,rep:tagNameRep})}out.push("<",tagNameRep);for(var i=0,n=attribs.length;i<n;i+=2){var attribName=attribs[i],value=attribs[i+1];if(value!==null&&value!==void 0){out.push(" ",attribName,'="',escapeAttrib(value),'"')}}out.push(">");if(eflagsOrig&html4.eflags["EMPTY"]&&!(eflagsRep&html4.eflags["EMPTY"])){out.push("</",tagNameRep,">")}},endTag:function(tagName,out){if(ignoring){ignoring=false;return}if(!html4.ELEMENTS.hasOwnProperty(tagName)){return}var eflags=html4.ELEMENTS[tagName];if(!(eflags&(html4.eflags["EMPTY"]|html4.eflags["FOLDABLE"]))){var index;if(eflags&html4.eflags["OPTIONAL_ENDTAG"]){for(index=stack.length;--index>=0;){var stackElOrigTag=stack[index].orig;if(stackElOrigTag===tagName){break}if(!(html4.ELEMENTS[stackElOrigTag]&html4.eflags["OPTIONAL_ENDTAG"])){return}}}else{for(index=stack.length;--index>=0;){if(stack[index].orig===tagName){break}}}if(index<0){return}for(var i=stack.length;--i>index;){var stackElRepTag=stack[i].rep;if(!(html4.ELEMENTS[stackElRepTag]&html4.eflags["OPTIONAL_ENDTAG"])){out.push("</",stackElRepTag,">")}}if(index<stack.length){tagName=stack[index].rep}stack.length=index;out.push("</",tagName,">")}},pcdata:emit,rcdata:emit,cdata:emit,endDoc:function(out){for(;stack.length;stack.length--){out.push("</",stack[stack.length-1].rep,">")}}})}var ALLOWED_URI_SCHEMES=/^(?:https?|mailto)$/i;function safeUri(uri,effect,ltype,hints,naiveUriRewriter){if(!naiveUriRewriter){return null}try{var parsed=URI.parse(""+uri);if(parsed){if(!parsed.hasScheme()||ALLOWED_URI_SCHEMES.test(parsed.getScheme())){var safe=naiveUriRewriter(parsed,effect,ltype,hints);return safe?safe.toString():null}}}catch(e){return null}return null}function log(logger,tagName,attribName,oldValue,newValue){if(!attribName){logger(tagName+" removed",{change:"removed",tagName:tagName})}if(oldValue!==newValue){var changed="changed";if(oldValue&&!newValue){changed="removed"}else if(!oldValue&&newValue){changed="added"}logger(tagName+"."+attribName+" "+changed,{change:changed,tagName:tagName,attribName:attribName,oldValue:oldValue,newValue:newValue})}}function lookupAttribute(map,tagName,attribName){var attribKey;attribKey=tagName+"::"+attribName;if(map.hasOwnProperty(attribKey)){return map[attribKey]}attribKey="*::"+attribName;if(map.hasOwnProperty(attribKey)){return map[attribKey]}return void 0}function getAttributeType(tagName,attribName){return lookupAttribute(html4.ATTRIBS,tagName,attribName)}function getLoaderType(tagName,attribName){return lookupAttribute(html4.LOADERTYPES,tagName,attribName)}function getUriEffect(tagName,attribName){return lookupAttribute(html4.URIEFFECTS,tagName,attribName)}function sanitizeAttribs(tagName,attribs,opt_naiveUriRewriter,opt_nmTokenPolicy,opt_logger){for(var i=0;i<attribs.length;i+=2){var attribName=attribs[i];var value=attribs[i+1];var oldValue=value;var atype=null,attribKey;if((attribKey=tagName+"::"+attribName,html4.ATTRIBS.hasOwnProperty(attribKey))||(attribKey="*::"+attribName,html4.ATTRIBS.hasOwnProperty(attribKey))){atype=html4.ATTRIBS[attribKey]}if(atype!==null){switch(atype){case html4.atype["NONE"]:break;case html4.atype["SCRIPT"]:value=null;if(opt_logger){log(opt_logger,tagName,attribName,oldValue,value)}break;case html4.atype["STYLE"]:if("undefined"===typeof parseCssDeclarations){value=null;if(opt_logger){log(opt_logger,tagName,attribName,oldValue,value)}break}var sanitizedDeclarations=[];parseCssDeclarations(value,{declaration:function(property,tokens){var normProp=property.toLowerCase();sanitizeCssProperty(normProp,tokens,opt_naiveUriRewriter?function(url){return safeUri(url,html4.ueffects.SAME_DOCUMENT,html4.ltypes.SANDBOXED,{TYPE:"CSS",CSS_PROP:normProp},opt_naiveUriRewriter)}:null);if(tokens.length){sanitizedDeclarations.push(normProp+": "+tokens.join(" "))}}});value=sanitizedDeclarations.length>0?sanitizedDeclarations.join(" ; "):null;if(opt_logger){log(opt_logger,tagName,attribName,oldValue,value)}break;case html4.atype["ID"]:case html4.atype["IDREF"]:case html4.atype["IDREFS"]:case html4.atype["GLOBAL_NAME"]:case html4.atype["LOCAL_NAME"]:case html4.atype["CLASSES"]:value=opt_nmTokenPolicy?opt_nmTokenPolicy(value):value;if(opt_logger){log(opt_logger,tagName,attribName,oldValue,value)}break;case html4.atype["URI"]:value=safeUri(value,getUriEffect(tagName,attribName),getLoaderType(tagName,attribName),{TYPE:"MARKUP",XML_ATTR:attribName,XML_TAG:tagName},opt_naiveUriRewriter);if(opt_logger){log(opt_logger,tagName,attribName,oldValue,value)}break;case html4.atype["URI_FRAGMENT"]:if(value&&"#"===value.charAt(0)){value=value.substring(1);value=opt_nmTokenPolicy?opt_nmTokenPolicy(value):value;if(value!==null&&value!==void 0){value="#"+value}}else{value=null}if(opt_logger){log(opt_logger,tagName,attribName,oldValue,value)}break;default:value=null;if(opt_logger){log(opt_logger,tagName,attribName,oldValue,value)}break}}else{value=null;if(opt_logger){log(opt_logger,tagName,attribName,oldValue,value)}}attribs[i+1]=value}return attribs}function makeTagPolicy(opt_naiveUriRewriter,opt_nmTokenPolicy,opt_logger){return function(tagName,attribs){if(!(html4.ELEMENTS[tagName]&html4.eflags["UNSAFE"])){return{attribs:sanitizeAttribs(tagName,attribs,opt_naiveUriRewriter,opt_nmTokenPolicy,opt_logger)}}else{if(opt_logger){log(opt_logger,tagName,undefined,undefined,undefined)}}}}function sanitizeWithPolicy(inputHtml,tagPolicy){var outputArray=[];makeHtmlSanitizer(tagPolicy)(inputHtml,outputArray);return outputArray.join("")}function sanitize(inputHtml,opt_naiveUriRewriter,opt_nmTokenPolicy,opt_logger){var tagPolicy=makeTagPolicy(opt_naiveUriRewriter,opt_nmTokenPolicy,opt_logger);return sanitizeWithPolicy(inputHtml,tagPolicy)}var html={};html.escapeAttrib=html["escapeAttrib"]=escapeAttrib;html.makeHtmlSanitizer=html["makeHtmlSanitizer"]=makeHtmlSanitizer;html.makeSaxParser=html["makeSaxParser"]=makeSaxParser;html.makeTagPolicy=html["makeTagPolicy"]=makeTagPolicy;html.normalizeRCData=html["normalizeRCData"]=normalizeRCData;html.sanitize=html["sanitize"]=sanitize;html.sanitizeAttribs=html["sanitizeAttribs"]=sanitizeAttribs;html.sanitizeWithPolicy=html["sanitizeWithPolicy"]=sanitizeWithPolicy;html.unescapeEntities=html["unescapeEntities"]=unescapeEntities;return html}(html4);var html_sanitize=html["sanitize"];if(typeof window!=="undefined"){window["html"]=html;window["html_sanitize"]=html_sanitize}var Sanitizer={};Sanitizer.escapeAttrib=html.escapeAttrib;Sanitizer.makeHtmlSanitizer=html.makeHtmlSanitizer;Sanitizer.makeSaxParser=html.makeSaxParser;Sanitizer.makeTagPolicy=html.makeTagPolicy;Sanitizer.normalizeRCData=html.normalizeRCData;Sanitizer.sanitizeAttribs=html.sanitizeAttribs;Sanitizer.sanitizeWithPolicy=html.sanitizeWithPolicy;Sanitizer.unescapeEntities=html.unescapeEntities;Sanitizer.escape=html.escapeAttrib;Sanitizer.sanitize=function(inputHtml,opt_naiveUriRewriter,opt_nmTokenPolicy,opt_logger){if(typeof inputHtml==="string"){inputHtml=inputHtml.replace(/<([a-zA-Z]+)([^>]*)\/>/g,"<$1$2></$1>")}if(inputHtml){return html.sanitize(inputHtml,opt_naiveUriRewriter,opt_nmTokenPolicy,opt_logger)}else{return inputHtml}};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=Sanitizer}exports.Sanitizer=Sanitizer}else{this.Sanitizer=Sanitizer}},{"./lib/html4.js":210,"./lib/uri.js":211}],213:[function(require,module,exports){const ANY=Symbol("SemVer ANY");class Comparator{static get ANY(){return ANY}constructor(comp,options){options=parseOptions(options);if(comp instanceof Comparator){if(comp.loose===!!options.loose){return comp}else{comp=comp.value}}comp=comp.trim().split(/\s+/).join(" ");debug("comparator",comp,options);this.options=options;this.loose=!!options.loose;this.parse(comp);if(this.semver===ANY){this.value=""}else{this.value=this.operator+this.semver.version}debug("comp",this)}parse(comp){const r=this.options.loose?re[t.COMPARATORLOOSE]:re[t.COMPARATOR];const m=comp.match(r);if(!m){throw new TypeError(`Invalid comparator: ${comp}`)}this.operator=m[1]!==undefined?m[1]:"";if(this.operator==="="){this.operator=""}if(!m[2]){this.semver=ANY}else{this.semver=new SemVer(m[2],this.options.loose)}}toString(){return this.value}test(version){debug("Comparator.test",version,this.options.loose);if(this.semver===ANY||version===ANY){return true}if(typeof version==="string"){try{version=new SemVer(version,this.options)}catch(er){return false}}return cmp(version,this.operator,this.semver,this.options)}intersects(comp,options){if(!(comp instanceof Comparator)){throw new TypeError("a Comparator is required")}if(this.operator===""){if(this.value===""){return true}return new Range(comp.value,options).test(this.value)}else if(comp.operator===""){if(comp.value===""){return true}return new Range(this.value,options).test(comp.semver)}options=parseOptions(options);if(options.includePrerelease&&(this.value==="<0.0.0-0"||comp.value==="<0.0.0-0")){return false}if(!options.includePrerelease&&(this.value.startsWith("<0.0.0")||comp.value.startsWith("<0.0.0"))){return false}if(this.operator.startsWith(">")&&comp.operator.startsWith(">")){return true}if(this.operator.startsWith("<")&&comp.operator.startsWith("<")){return true}if(this.semver.version===comp.semver.version&&this.operator.includes("=")&&comp.operator.includes("=")){return true}if(cmp(this.semver,"<",comp.semver,options)&&this.operator.startsWith(">")&&comp.operator.startsWith("<")){return true}if(cmp(this.semver,">",comp.semver,options)&&this.operator.startsWith("<")&&comp.operator.startsWith(">")){return true}return false}}module.exports=Comparator;const parseOptions=require("../internal/parse-options");const{safeRe:re,t:t}=require("../internal/re");const cmp=require("../functions/cmp");const debug=require("../internal/debug");const SemVer=require("./semver");const Range=require("./range")},{"../functions/cmp":217,"../internal/debug":242,"../internal/parse-options":245,"../internal/re":246,"./range":214,"./semver":215}],214:[function(require,module,exports){const SPACE_CHARACTERS=/\s+/g;class Range{constructor(range,options){options=parseOptions(options);if(range instanceof Range){if(range.loose===!!options.loose&&range.includePrerelease===!!options.includePrerelease){return range}else{return new Range(range.raw,options)}}if(range instanceof Comparator){this.raw=range.value;this.set=[[range]];this.formatted=undefined;return this}this.options=options;this.loose=!!options.loose;this.includePrerelease=!!options.includePrerelease;this.raw=range.trim().replace(SPACE_CHARACTERS," ");this.set=this.raw.split("||").map(r=>this.parseRange(r.trim())).filter(c=>c.length);if(!this.set.length){throw new TypeError(`Invalid SemVer Range: ${this.raw}`)}if(this.set.length>1){const first=this.set[0];this.set=this.set.filter(c=>!isNullSet(c[0]));if(this.set.length===0){this.set=[first]}else if(this.set.length>1){for(const c of this.set){if(c.length===1&&isAny(c[0])){this.set=[c];break}}}}this.formatted=undefined}get range(){if(this.formatted===undefined){this.formatted="";for(let i=0;i<this.set.length;i++){if(i>0){this.formatted+="||"}const comps=this.set[i];for(let k=0;k<comps.length;k++){if(k>0){this.formatted+=" "}this.formatted+=comps[k].toString().trim()}}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(range){const memoOpts=(this.options.includePrerelease&&FLAG_INCLUDE_PRERELEASE)|(this.options.loose&&FLAG_LOOSE);const memoKey=memoOpts+":"+range;const cached=cache.get(memoKey);if(cached){return cached}const loose=this.options.loose;const hr=loose?re[t.HYPHENRANGELOOSE]:re[t.HYPHENRANGE];range=range.replace(hr,hyphenReplace(this.options.includePrerelease));debug("hyphen replace",range);range=range.replace(re[t.COMPARATORTRIM],comparatorTrimReplace);debug("comparator trim",range);range=range.replace(re[t.TILDETRIM],tildeTrimReplace);debug("tilde trim",range);range=range.replace(re[t.CARETTRIM],caretTrimReplace);debug("caret trim",range);let rangeList=range.split(" ").map(comp=>parseComparator(comp,this.options)).join(" ").split(/\s+/).map(comp=>replaceGTE0(comp,this.options));if(loose){rangeList=rangeList.filter(comp=>{debug("loose invalid filter",comp,this.options);return!!comp.match(re[t.COMPARATORLOOSE])})}debug("range list",rangeList);const rangeMap=new Map;const comparators=rangeList.map(comp=>new Comparator(comp,this.options));for(const comp of comparators){if(isNullSet(comp)){return[comp]}rangeMap.set(comp.value,comp)}if(rangeMap.size>1&&rangeMap.has("")){rangeMap.delete("")}const result=[...rangeMap.values()];cache.set(memoKey,result);return result}intersects(range,options){if(!(range instanceof Range)){throw new TypeError("a Range is required")}return this.set.some(thisComparators=>isSatisfiable(thisComparators,options)&&range.set.some(rangeComparators=>isSatisfiable(rangeComparators,options)&&thisComparators.every(thisComparator=>rangeComparators.every(rangeComparator=>thisComparator.intersects(rangeComparator,options)))))}test(version){if(!version){return false}if(typeof version==="string"){try{version=new SemVer(version,this.options)}catch(er){return false}}for(let i=0;i<this.set.length;i++){if(testSet(this.set[i],version,this.options)){return true}}return false}}module.exports=Range;const LRU=require("../internal/lrucache");const cache=new LRU;const parseOptions=require("../internal/parse-options");const Comparator=require("./comparator");const debug=require("../internal/debug");const SemVer=require("./semver");const{safeRe:re,t:t,comparatorTrimReplace:comparatorTrimReplace,tildeTrimReplace:tildeTrimReplace,caretTrimReplace:caretTrimReplace}=require("../internal/re");const{FLAG_INCLUDE_PRERELEASE:FLAG_INCLUDE_PRERELEASE,FLAG_LOOSE:FLAG_LOOSE}=require("../internal/constants");const isNullSet=c=>c.value==="<0.0.0-0";const isAny=c=>c.value==="";const isSatisfiable=(comparators,options)=>{let result=true;const remainingComparators=comparators.slice();let testComparator=remainingComparators.pop();while(result&&remainingComparators.length){result=remainingComparators.every(otherComparator=>testComparator.intersects(otherComparator,options));testComparator=remainingComparators.pop()}return result};const parseComparator=(comp,options)=>{debug("comp",comp,options);comp=replaceCarets(comp,options);debug("caret",comp);comp=replaceTildes(comp,options);debug("tildes",comp);comp=replaceXRanges(comp,options);debug("xrange",comp);comp=replaceStars(comp,options);debug("stars",comp);return comp};const isX=id=>!id||id.toLowerCase()==="x"||id==="*";const replaceTildes=(comp,options)=>comp.trim().split(/\s+/).map(c=>replaceTilde(c,options)).join(" ");const replaceTilde=(comp,options)=>{const r=options.loose?re[t.TILDELOOSE]:re[t.TILDE];return comp.replace(r,(_,M,m,p,pr)=>{debug("tilde",comp,_,M,m,p,pr);let ret;if(isX(M)){ret=""}else if(isX(m)){ret=`>=${M}.0.0 <${+M+1}.0.0-0`}else if(isX(p)){ret=`>=${M}.${m}.0 <${M}.${+m+1}.0-0`}else if(pr){debug("replaceTilde pr",pr);ret=`>=${M}.${m}.${p}-${pr} <${M}.${+m+1}.0-0`}else{ret=`>=${M}.${m}.${p} <${M}.${+m+1}.0-0`}debug("tilde return",ret);return ret})};const replaceCarets=(comp,options)=>comp.trim().split(/\s+/).map(c=>replaceCaret(c,options)).join(" ");const replaceCaret=(comp,options)=>{debug("caret",comp,options);const r=options.loose?re[t.CARETLOOSE]:re[t.CARET];const z=options.includePrerelease?"-0":"";return comp.replace(r,(_,M,m,p,pr)=>{debug("caret",comp,_,M,m,p,pr);let ret;if(isX(M)){ret=""}else if(isX(m)){ret=`>=${M}.0.0${z} <${+M+1}.0.0-0`}else if(isX(p)){if(M==="0"){ret=`>=${M}.${m}.0${z} <${M}.${+m+1}.0-0`}else{ret=`>=${M}.${m}.0${z} <${+M+1}.0.0-0`}}else if(pr){debug("replaceCaret pr",pr);if(M==="0"){if(m==="0"){ret=`>=${M}.${m}.${p}-${pr} <${M}.${m}.${+p+1}-0`}else{ret=`>=${M}.${m}.${p}-${pr} <${M}.${+m+1}.0-0`}}else{ret=`>=${M}.${m}.${p}-${pr} <${+M+1}.0.0-0`}}else{debug("no pr");if(M==="0"){if(m==="0"){ret=`>=${M}.${m}.${p}${z} <${M}.${m}.${+p+1}-0`}else{ret=`>=${M}.${m}.${p}${z} <${M}.${+m+1}.0-0`}}else{ret=`>=${M}.${m}.${p} <${+M+1}.0.0-0`}}debug("caret return",ret);return ret})};const replaceXRanges=(comp,options)=>{debug("replaceXRanges",comp,options);return comp.split(/\s+/).map(c=>replaceXRange(c,options)).join(" ")};const replaceXRange=(comp,options)=>{comp=comp.trim();const r=options.loose?re[t.XRANGELOOSE]:re[t.XRANGE];return comp.replace(r,(ret,gtlt,M,m,p,pr)=>{debug("xRange",comp,ret,gtlt,M,m,p,pr);const xM=isX(M);const xm=xM||isX(m);const xp=xm||isX(p);const anyX=xp;if(gtlt==="="&&anyX){gtlt=""}pr=options.includePrerelease?"-0":"";if(xM){if(gtlt===">"||gtlt==="<"){ret="<0.0.0-0"}else{ret="*"}}else if(gtlt&&anyX){if(xm){m=0}p=0;if(gtlt===">"){gtlt=">=";if(xm){M=+M+1;m=0;p=0}else{m=+m+1;p=0}}else if(gtlt==="<="){gtlt="<";if(xm){M=+M+1}else{m=+m+1}}if(gtlt==="<"){pr="-0"}ret=`${gtlt+M}.${m}.${p}${pr}`}else if(xm){ret=`>=${M}.0.0${pr} <${+M+1}.0.0-0`}else if(xp){ret=`>=${M}.${m}.0${pr} <${M}.${+m+1}.0-0`}debug("xRange return",ret);return ret})};const replaceStars=(comp,options)=>{debug("replaceStars",comp,options);return comp.trim().replace(re[t.STAR],"")};const replaceGTE0=(comp,options)=>{debug("replaceGTE0",comp,options);return comp.trim().replace(re[options.includePrerelease?t.GTE0PRE:t.GTE0],"")};const hyphenReplace=incPr=>($0,from,fM,fm,fp,fpr,fb,to,tM,tm,tp,tpr)=>{if(isX(fM)){from=""}else if(isX(fm)){from=`>=${fM}.0.0${incPr?"-0":""}`}else if(isX(fp)){from=`>=${fM}.${fm}.0${incPr?"-0":""}`}else if(fpr){from=`>=${from}`}else{from=`>=${from}${incPr?"-0":""}`}if(isX(tM)){to=""}else if(isX(tm)){to=`<${+tM+1}.0.0-0`}else if(isX(tp)){to=`<${tM}.${+tm+1}.0-0`}else if(tpr){to=`<=${tM}.${tm}.${tp}-${tpr}`}else if(incPr){to=`<${tM}.${tm}.${+tp+1}-0`}else{to=`<=${to}`}return`${from} ${to}`.trim()};const testSet=(set,version,options)=>{for(let i=0;i<set.length;i++){if(!set[i].test(version)){return false}}if(version.prerelease.length&&!options.includePrerelease){for(let i=0;i<set.length;i++){debug(set[i].semver);if(set[i].semver===Comparator.ANY){continue}if(set[i].semver.prerelease.length>0){const allowed=set[i].semver;if(allowed.major===version.major&&allowed.minor===version.minor&&allowed.patch===version.patch){return true}}}return false}return true}},{"../internal/constants":241,"../internal/debug":242,"../internal/lrucache":244,"../internal/parse-options":245,"../internal/re":246,"./comparator":213,"./semver":215}],215:[function(require,module,exports){const debug=require("../internal/debug");const{MAX_LENGTH:MAX_LENGTH,MAX_SAFE_INTEGER:MAX_SAFE_INTEGER}=require("../internal/constants");const{safeRe:re,t:t}=require("../internal/re");const parseOptions=require("../internal/parse-options");const{compareIdentifiers:compareIdentifiers}=require("../internal/identifiers");class SemVer{constructor(version,options){options=parseOptions(options);if(version instanceof SemVer){if(version.loose===!!options.loose&&version.includePrerelease===!!options.includePrerelease){return version}else{version=version.version}}else if(typeof version!=="string"){throw new TypeError(`Invalid version. Must be a string. Got type "${typeof version}".`)}if(version.length>MAX_LENGTH){throw new TypeError(`version is longer than ${MAX_LENGTH} characters`)}debug("SemVer",version,options);this.options=options;this.loose=!!options.loose;this.includePrerelease=!!options.includePrerelease;const m=version.trim().match(options.loose?re[t.LOOSE]:re[t.FULL]);if(!m){throw new TypeError(`Invalid Version: ${version}`)}this.raw=version;this.major=+m[1];this.minor=+m[2];this.patch=+m[3];if(this.major>MAX_SAFE_INTEGER||this.major<0){throw new TypeError("Invalid major version")}if(this.minor>MAX_SAFE_INTEGER||this.minor<0){throw new TypeError("Invalid minor version")}if(this.patch>MAX_SAFE_INTEGER||this.patch<0){throw new TypeError("Invalid patch version")}if(!m[4]){this.prerelease=[]}else{this.prerelease=m[4].split(".").map(id=>{if(/^[0-9]+$/.test(id)){const num=+id;if(num>=0&&num<MAX_SAFE_INTEGER){return num}}return id})}this.build=m[5]?m[5].split("."):[];this.format()}format(){this.version=`${this.major}.${this.minor}.${this.patch}`;if(this.prerelease.length){this.version+=`-${this.prerelease.join(".")}`}return this.version}toString(){return this.version}compare(other){debug("SemVer.compare",this.version,this.options,other);if(!(other instanceof SemVer)){if(typeof other==="string"&&other===this.version){return 0}other=new SemVer(other,this.options)}if(other.version===this.version){return 0}return this.compareMain(other)||this.comparePre(other)}compareMain(other){if(!(other instanceof SemVer)){other=new SemVer(other,this.options)}return compareIdentifiers(this.major,other.major)||compareIdentifiers(this.minor,other.minor)||compareIdentifiers(this.patch,other.patch)}comparePre(other){if(!(other instanceof SemVer)){other=new SemVer(other,this.options)}if(this.prerelease.length&&!other.prerelease.length){return-1}else if(!this.prerelease.length&&other.prerelease.length){return 1}else if(!this.prerelease.length&&!other.prerelease.length){return 0}let i=0;do{const a=this.prerelease[i];const b=other.prerelease[i];debug("prerelease compare",i,a,b);if(a===undefined&&b===undefined){return 0}else if(b===undefined){return 1}else if(a===undefined){return-1}else if(a===b){continue}else{return compareIdentifiers(a,b)}}while(++i)}compareBuild(other){if(!(other instanceof SemVer)){other=new SemVer(other,this.options)}let i=0;do{const a=this.build[i];const b=other.build[i];debug("build compare",i,a,b);if(a===undefined&&b===undefined){return 0}else if(b===undefined){return 1}else if(a===undefined){return-1}else if(a===b){continue}else{return compareIdentifiers(a,b)}}while(++i)}inc(release,identifier,identifierBase){if(release.startsWith("pre")){if(!identifier&&identifierBase===false){throw new Error("invalid increment argument: identifier is empty")}if(identifier){const match=`-${identifier}`.match(this.options.loose?re[t.PRERELEASELOOSE]:re[t.PRERELEASE]);if(!match||match[1]!==identifier){throw new Error(`invalid identifier: ${identifier}`)}}}switch(release){case"premajor":this.prerelease.length=0;this.patch=0;this.minor=0;this.major++;this.inc("pre",identifier,identifierBase);break;case"preminor":this.prerelease.length=0;this.patch=0;this.minor++;this.inc("pre",identifier,identifierBase);break;case"prepatch":this.prerelease.length=0;this.inc("patch",identifier,identifierBase);this.inc("pre",identifier,identifierBase);break;case"prerelease":if(this.prerelease.length===0){this.inc("patch",identifier,identifierBase)}this.inc("pre",identifier,identifierBase);break;case"release":if(this.prerelease.length===0){throw new Error(`version ${this.raw} is not a prerelease`)}this.prerelease.length=0;break;case"major":if(this.minor!==0||this.patch!==0||this.prerelease.length===0){this.major++}this.minor=0;this.patch=0;this.prerelease=[];break;case"minor":if(this.patch!==0||this.prerelease.length===0){this.minor++}this.patch=0;this.prerelease=[];break;case"patch":if(this.prerelease.length===0){this.patch++}this.prerelease=[];break;case"pre":{const base=Number(identifierBase)?1:0;if(this.prerelease.length===0){this.prerelease=[base]}else{let i=this.prerelease.length;while(--i>=0){if(typeof this.prerelease[i]==="number"){this.prerelease[i]++;i=-2}}if(i===-1){if(identifier===this.prerelease.join(".")&&identifierBase===false){throw new Error("invalid increment argument: identifier already exists")}this.prerelease.push(base)}}if(identifier){let prerelease=[identifier,base];if(identifierBase===false){prerelease=[identifier]}if(compareIdentifiers(this.prerelease[0],identifier)===0){if(isNaN(this.prerelease[1])){this.prerelease=prerelease}}else{this.prerelease=prerelease}}break}default:throw new Error(`invalid increment argument: ${release}`)}this.raw=this.format();if(this.build.length){this.raw+=`+${this.build.join(".")}`}return this}}module.exports=SemVer},{"../internal/constants":241,"../internal/debug":242,"../internal/identifiers":243,"../internal/parse-options":245,"../internal/re":246}],216:[function(require,module,exports){const parse=require("./parse");const clean=(version,options)=>{const s=parse(version.trim().replace(/^[=v]+/,""),options);return s?s.version:null};module.exports=clean},{"./parse":232}],217:[function(require,module,exports){const eq=require("./eq");const neq=require("./neq");const gt=require("./gt");const gte=require("./gte");const lt=require("./lt");const lte=require("./lte");const cmp=(a,op,b,loose)=>{switch(op){case"===":if(typeof a==="object"){a=a.version}if(typeof b==="object"){b=b.version}return a===b;case"!==":if(typeof a==="object"){a=a.version}if(typeof b==="object"){b=b.version}return a!==b;case"":case"=":case"==":return eq(a,b,loose);case"!=":return neq(a,b,loose);case">":return gt(a,b,loose);case">=":return gte(a,b,loose);case"<":return lt(a,b,loose);case"<=":return lte(a,b,loose);default:throw new TypeError(`Invalid operator: ${op}`)}};module.exports=cmp},{"./eq":223,"./gt":224,"./gte":225,"./lt":227,"./lte":228,"./neq":231}],218:[function(require,module,exports){const SemVer=require("../classes/semver");const parse=require("./parse");const{safeRe:re,t:t}=require("../internal/re");const coerce=(version,options)=>{if(version instanceof SemVer){return version}if(typeof version==="number"){version=String(version)}if(typeof version!=="string"){return null}options=options||{};let match=null;if(!options.rtl){match=version.match(options.includePrerelease?re[t.COERCEFULL]:re[t.COERCE])}else{const coerceRtlRegex=options.includePrerelease?re[t.COERCERTLFULL]:re[t.COERCERTL];let next;while((next=coerceRtlRegex.exec(version))&&(!match||match.index+match[0].length!==version.length)){if(!match||next.index+next[0].length!==match.index+match[0].length){match=next}coerceRtlRegex.lastIndex=next.index+next[1].length+next[2].length}coerceRtlRegex.lastIndex=-1}if(match===null){return null}const major=match[2];const minor=match[3]||"0";const patch=match[4]||"0";const prerelease=options.includePrerelease&&match[5]?`-${match[5]}`:"";const build=options.includePrerelease&&match[6]?`+${match[6]}`:"";return parse(`${major}.${minor}.${patch}${prerelease}${build}`,options)};module.exports=coerce},{"../classes/semver":215,"../internal/re":246,"./parse":232}],219:[function(require,module,exports){const SemVer=require("../classes/semver");const compareBuild=(a,b,loose)=>{const versionA=new SemVer(a,loose);const versionB=new SemVer(b,loose);return versionA.compare(versionB)||versionA.compareBuild(versionB)};module.exports=compareBuild},{"../classes/semver":215}],220:[function(require,module,exports){const compare=require("./compare");const compareLoose=(a,b)=>compare(a,b,true);module.exports=compareLoose},{"./compare":221}],221:[function(require,module,exports){const SemVer=require("../classes/semver");const compare=(a,b,loose)=>new SemVer(a,loose).compare(new SemVer(b,loose));module.exports=compare},{"../classes/semver":215}],222:[function(require,module,exports){const parse=require("./parse.js");const diff=(version1,version2)=>{const v1=parse(version1,null,true);const v2=parse(version2,null,true);const comparison=v1.compare(v2);if(comparison===0){return null}const v1Higher=comparison>0;const highVersion=v1Higher?v1:v2;const lowVersion=v1Higher?v2:v1;const highHasPre=!!highVersion.prerelease.length;const lowHasPre=!!lowVersion.prerelease.length;if(lowHasPre&&!highHasPre){if(!lowVersion.patch&&!lowVersion.minor){return"major"}if(lowVersion.compareMain(highVersion)===0){if(lowVersion.minor&&!lowVersion.patch){return"minor"}return"patch"}}const prefix=highHasPre?"pre":"";if(v1.major!==v2.major){return prefix+"major"}if(v1.minor!==v2.minor){return prefix+"minor"}if(v1.patch!==v2.patch){return prefix+"patch"}return"prerelease"};module.exports=diff},{"./parse.js":232}],223:[function(require,module,exports){const compare=require("./compare");const eq=(a,b,loose)=>compare(a,b,loose)===0;module.exports=eq},{"./compare":221}],224:[function(require,module,exports){const compare=require("./compare");const gt=(a,b,loose)=>compare(a,b,loose)>0;module.exports=gt},{"./compare":221}],225:[function(require,module,exports){const compare=require("./compare");const gte=(a,b,loose)=>compare(a,b,loose)>=0;module.exports=gte},{"./compare":221}],226:[function(require,module,exports){const SemVer=require("../classes/semver");const inc=(version,release,options,identifier,identifierBase)=>{if(typeof options==="string"){identifierBase=identifier;identifier=options;options=undefined}try{return new SemVer(version instanceof SemVer?version.version:version,options).inc(release,identifier,identifierBase).version}catch(er){return null}};module.exports=inc},{"../classes/semver":215}],227:[function(require,module,exports){const compare=require("./compare");const lt=(a,b,loose)=>compare(a,b,loose)<0;module.exports=lt},{"./compare":221}],228:[function(require,module,exports){const compare=require("./compare");const lte=(a,b,loose)=>compare(a,b,loose)<=0;module.exports=lte},{"./compare":221}],229:[function(require,module,exports){const SemVer=require("../classes/semver");const major=(a,loose)=>new SemVer(a,loose).major;module.exports=major},{"../classes/semver":215}],230:[function(require,module,exports){const SemVer=require("../classes/semver");const minor=(a,loose)=>new SemVer(a,loose).minor;module.exports=minor},{"../classes/semver":215}],231:[function(require,module,exports){const compare=require("./compare");const neq=(a,b,loose)=>compare(a,b,loose)!==0;module.exports=neq},{"./compare":221}],232:[function(require,module,exports){const SemVer=require("../classes/semver");const parse=(version,options,throwErrors=false)=>{if(version instanceof SemVer){return version}try{return new SemVer(version,options)}catch(er){if(!throwErrors){return null}throw er}};module.exports=parse},{"../classes/semver":215}],233:[function(require,module,exports){const SemVer=require("../classes/semver");const patch=(a,loose)=>new SemVer(a,loose).patch;module.exports=patch},{"../classes/semver":215}],234:[function(require,module,exports){const parse=require("./parse");const prerelease=(version,options)=>{const parsed=parse(version,options);return parsed&&parsed.prerelease.length?parsed.prerelease:null};module.exports=prerelease},{"./parse":232}],235:[function(require,module,exports){const compare=require("./compare");const rcompare=(a,b,loose)=>compare(b,a,loose);module.exports=rcompare},{"./compare":221}],236:[function(require,module,exports){const compareBuild=require("./compare-build");const rsort=(list,loose)=>list.sort((a,b)=>compareBuild(b,a,loose));module.exports=rsort},{"./compare-build":219}],237:[function(require,module,exports){const Range=require("../classes/range");const satisfies=(version,range,options)=>{try{range=new Range(range,options)}catch(er){return false}return range.test(version)};module.exports=satisfies},{"../classes/range":214}],238:[function(require,module,exports){const compareBuild=require("./compare-build");const sort=(list,loose)=>list.sort((a,b)=>compareBuild(a,b,loose));module.exports=sort},{"./compare-build":219}],239:[function(require,module,exports){const parse=require("./parse");const valid=(version,options)=>{const v=parse(version,options);return v?v.version:null};module.exports=valid},{"./parse":232}],240:[function(require,module,exports){const internalRe=require("./internal/re");const constants=require("./internal/constants");const SemVer=require("./classes/semver");const identifiers=require("./internal/identifiers");const parse=require("./functions/parse");const valid=require("./functions/valid");const clean=require("./functions/clean");const inc=require("./functions/inc");const diff=require("./functions/diff");const major=require("./functions/major");const minor=require("./functions/minor");const patch=require("./functions/patch");const prerelease=require("./functions/prerelease");const compare=require("./functions/compare");const rcompare=require("./functions/rcompare");const compareLoose=require("./functions/compare-loose");const compareBuild=require("./functions/compare-build");const sort=require("./functions/sort");const rsort=require("./functions/rsort");const gt=require("./functions/gt");const lt=require("./functions/lt");const eq=require("./functions/eq");const neq=require("./functions/neq");const gte=require("./functions/gte");const lte=require("./functions/lte");const cmp=require("./functions/cmp");const coerce=require("./functions/coerce");const Comparator=require("./classes/comparator");const Range=require("./classes/range");const satisfies=require("./functions/satisfies");const toComparators=require("./ranges/to-comparators");const maxSatisfying=require("./ranges/max-satisfying");const minSatisfying=require("./ranges/min-satisfying");const minVersion=require("./ranges/min-version");const validRange=require("./ranges/valid");const outside=require("./ranges/outside");const gtr=require("./ranges/gtr");const ltr=require("./ranges/ltr");const intersects=require("./ranges/intersects");const simplifyRange=require("./ranges/simplify");const subset=require("./ranges/subset");module.exports={parse:parse,valid:valid,clean:clean,inc:inc,diff:diff,major:major,minor:minor,patch:patch,prerelease:prerelease,compare:compare,rcompare:rcompare,compareLoose:compareLoose,compareBuild:compareBuild,sort:sort,rsort:rsort,gt:gt,lt:lt,eq:eq,neq:neq,gte:gte,lte:lte,cmp:cmp,coerce:coerce,Comparator:Comparator,Range:Range,satisfies:satisfies,toComparators:toComparators,maxSatisfying:maxSatisfying,minSatisfying:minSatisfying,minVersion:minVersion,validRange:validRange,outside:outside,gtr:gtr,ltr:ltr,intersects:intersects,simplifyRange:simplifyRange,subset:subset,SemVer:SemVer,re:internalRe.re,src:internalRe.src,tokens:internalRe.t,SEMVER_SPEC_VERSION:constants.SEMVER_SPEC_VERSION,RELEASE_TYPES:constants.RELEASE_TYPES,compareIdentifiers:identifiers.compareIdentifiers,rcompareIdentifiers:identifiers.rcompareIdentifiers}},{"./classes/comparator":213,"./classes/range":214,"./classes/semver":215,"./functions/clean":216,"./functions/cmp":217,"./functions/coerce":218,"./functions/compare":221,"./functions/compare-build":219,"./functions/compare-loose":220,"./functions/diff":222,"./functions/eq":223,"./functions/gt":224,"./functions/gte":225,"./functions/inc":226,"./functions/lt":227,"./functions/lte":228,"./functions/major":229,"./functions/minor":230,"./functions/neq":231,"./functions/parse":232,"./functions/patch":233,"./functions/prerelease":234,"./functions/rcompare":235,"./functions/rsort":236,"./functions/satisfies":237,"./functions/sort":238,"./functions/valid":239,"./internal/constants":241,"./internal/identifiers":243,"./internal/re":246,"./ranges/gtr":247,"./ranges/intersects":248,"./ranges/ltr":249,"./ranges/max-satisfying":250,"./ranges/min-satisfying":251,"./ranges/min-version":252,"./ranges/outside":253,"./ranges/simplify":254,"./ranges/subset":255,"./ranges/to-comparators":256,"./ranges/valid":257}],241:[function(require,module,exports){const SEMVER_SPEC_VERSION="2.0.0";const MAX_LENGTH=256;const MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER||9007199254740991;const MAX_SAFE_COMPONENT_LENGTH=16;const MAX_SAFE_BUILD_LENGTH=MAX_LENGTH-6;const RELEASE_TYPES=["major","premajor","minor","preminor","patch","prepatch","prerelease"];module.exports={MAX_LENGTH:MAX_LENGTH,MAX_SAFE_COMPONENT_LENGTH:MAX_SAFE_COMPONENT_LENGTH,MAX_SAFE_BUILD_LENGTH:MAX_SAFE_BUILD_LENGTH,MAX_SAFE_INTEGER:MAX_SAFE_INTEGER,RELEASE_TYPES:RELEASE_TYPES,SEMVER_SPEC_VERSION:SEMVER_SPEC_VERSION,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},{}],242:[function(require,module,exports){const debug=typeof process==="object"&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...args)=>console.error("SEMVER",...args):()=>{};module.exports=debug},{}],243:[function(require,module,exports){const numeric=/^[0-9]+$/;const compareIdentifiers=(a,b)=>{const anum=numeric.test(a);const bnum=numeric.test(b);if(anum&&bnum){a=+a;b=+b}return a===b?0:anum&&!bnum?-1:bnum&&!anum?1:a<b?-1:1};const rcompareIdentifiers=(a,b)=>compareIdentifiers(b,a);module.exports={compareIdentifiers:compareIdentifiers,rcompareIdentifiers:rcompareIdentifiers}},{}],244:[function(require,module,exports){class LRUCache{constructor(){this.max=1e3;this.map=new Map}get(key){const value=this.map.get(key);if(value===undefined){return undefined}else{this.map.delete(key);this.map.set(key,value);return value}}delete(key){return this.map.delete(key)}set(key,value){const deleted=this.delete(key);if(!deleted&&value!==undefined){if(this.map.size>=this.max){const firstKey=this.map.keys().next().value;this.delete(firstKey)}this.map.set(key,value)}return this}}module.exports=LRUCache},{}],245:[function(require,module,exports){const looseOption=Object.freeze({loose:true});const emptyOpts=Object.freeze({});const parseOptions=options=>{if(!options){return emptyOpts}if(typeof options!=="object"){return looseOption}return options};module.exports=parseOptions},{}],246:[function(require,module,exports){const{MAX_SAFE_COMPONENT_LENGTH:MAX_SAFE_COMPONENT_LENGTH,MAX_SAFE_BUILD_LENGTH:MAX_SAFE_BUILD_LENGTH,MAX_LENGTH:MAX_LENGTH}=require("./constants");const debug=require("./debug");exports=module.exports={};const re=exports.re=[];const safeRe=exports.safeRe=[];const src=exports.src=[];const t=exports.t={};let R=0;const LETTERDASHNUMBER="[a-zA-Z0-9-]";const safeRegexReplacements=[["\\s",1],["\\d",MAX_LENGTH],[LETTERDASHNUMBER,MAX_SAFE_BUILD_LENGTH]];const makeSafeRegex=value=>{for(const[token,max]of safeRegexReplacements){value=value.split(`${token}*`).join(`${token}{0,${max}}`).split(`${token}+`).join(`${token}{1,${max}}`)}return value};const createToken=(name,value,isGlobal)=>{const safe=makeSafeRegex(value);const index=R++;debug(name,index,value);t[name]=index;src[index]=value;re[index]=new RegExp(value,isGlobal?"g":undefined);safeRe[index]=new RegExp(safe,isGlobal?"g":undefined)};createToken("NUMERICIDENTIFIER","0|[1-9]\\d*");createToken("NUMERICIDENTIFIERLOOSE","\\d+");createToken("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${LETTERDASHNUMBER}*`);createToken("MAINVERSION",`(${src[t.NUMERICIDENTIFIER]})\\.`+`(${src[t.NUMERICIDENTIFIER]})\\.`+`(${src[t.NUMERICIDENTIFIER]})`);createToken("MAINVERSIONLOOSE",`(${src[t.NUMERICIDENTIFIERLOOSE]})\\.`+`(${src[t.NUMERICIDENTIFIERLOOSE]})\\.`+`(${src[t.NUMERICIDENTIFIERLOOSE]})`);createToken("PRERELEASEIDENTIFIER",`(?:${src[t.NUMERICIDENTIFIER]}|${src[t.NONNUMERICIDENTIFIER]})`);createToken("PRERELEASEIDENTIFIERLOOSE",`(?:${src[t.NUMERICIDENTIFIERLOOSE]}|${src[t.NONNUMERICIDENTIFIER]})`);createToken("PRERELEASE",`(?:-(${src[t.PRERELEASEIDENTIFIER]}(?:\\.${src[t.PRERELEASEIDENTIFIER]})*))`);createToken("PRERELEASELOOSE",`(?:-?(${src[t.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${src[t.PRERELEASEIDENTIFIERLOOSE]})*))`);createToken("BUILDIDENTIFIER",`${LETTERDASHNUMBER}+`);createToken("BUILD",`(?:\\+(${src[t.BUILDIDENTIFIER]}(?:\\.${src[t.BUILDIDENTIFIER]})*))`);createToken("FULLPLAIN",`v?${src[t.MAINVERSION]}${src[t.PRERELEASE]}?${src[t.BUILD]}?`);createToken("FULL",`^${src[t.FULLPLAIN]}$`);createToken("LOOSEPLAIN",`[v=\\s]*${src[t.MAINVERSIONLOOSE]}${src[t.PRERELEASELOOSE]}?${src[t.BUILD]}?`);createToken("LOOSE",`^${src[t.LOOSEPLAIN]}$`);createToken("GTLT","((?:<|>)?=?)");createToken("XRANGEIDENTIFIERLOOSE",`${src[t.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`);createToken("XRANGEIDENTIFIER",`${src[t.NUMERICIDENTIFIER]}|x|X|\\*`);createToken("XRANGEPLAIN",`[v=\\s]*(${src[t.XRANGEIDENTIFIER]})`+`(?:\\.(${src[t.XRANGEIDENTIFIER]})`+`(?:\\.(${src[t.XRANGEIDENTIFIER]})`+`(?:${src[t.PRERELEASE]})?${src[t.BUILD]}?`+`)?)?`);createToken("XRANGEPLAINLOOSE",`[v=\\s]*(${src[t.XRANGEIDENTIFIERLOOSE]})`+`(?:\\.(${src[t.XRANGEIDENTIFIERLOOSE]})`+`(?:\\.(${src[t.XRANGEIDENTIFIERLOOSE]})`+`(?:${src[t.PRERELEASELOOSE]})?${src[t.BUILD]}?`+`)?)?`);createToken("XRANGE",`^${src[t.GTLT]}\\s*${src[t.XRANGEPLAIN]}$`);createToken("XRANGELOOSE",`^${src[t.GTLT]}\\s*${src[t.XRANGEPLAINLOOSE]}$`);createToken("COERCEPLAIN",`${"(^|[^\\d])"+"(\\d{1,"}${MAX_SAFE_COMPONENT_LENGTH}})`+`(?:\\.(\\d{1,${MAX_SAFE_COMPONENT_LENGTH}}))?`+`(?:\\.(\\d{1,${MAX_SAFE_COMPONENT_LENGTH}}))?`);createToken("COERCE",`${src[t.COERCEPLAIN]}(?:$|[^\\d])`);createToken("COERCEFULL",src[t.COERCEPLAIN]+`(?:${src[t.PRERELEASE]})?`+`(?:${src[t.BUILD]})?`+`(?:$|[^\\d])`);createToken("COERCERTL",src[t.COERCE],true);createToken("COERCERTLFULL",src[t.COERCEFULL],true);createToken("LONETILDE","(?:~>?)");createToken("TILDETRIM",`(\\s*)${src[t.LONETILDE]}\\s+`,true);exports.tildeTrimReplace="$1~";createToken("TILDE",`^${src[t.LONETILDE]}${src[t.XRANGEPLAIN]}$`);createToken("TILDELOOSE",`^${src[t.LONETILDE]}${src[t.XRANGEPLAINLOOSE]}$`);createToken("LONECARET","(?:\\^)");createToken("CARETTRIM",`(\\s*)${src[t.LONECARET]}\\s+`,true);exports.caretTrimReplace="$1^";createToken("CARET",`^${src[t.LONECARET]}${src[t.XRANGEPLAIN]}$`);createToken("CARETLOOSE",`^${src[t.LONECARET]}${src[t.XRANGEPLAINLOOSE]}$`);createToken("COMPARATORLOOSE",`^${src[t.GTLT]}\\s*(${src[t.LOOSEPLAIN]})$|^$`);createToken("COMPARATOR",`^${src[t.GTLT]}\\s*(${src[t.FULLPLAIN]})$|^$`);createToken("COMPARATORTRIM",`(\\s*)${src[t.GTLT]}\\s*(${src[t.LOOSEPLAIN]}|${src[t.XRANGEPLAIN]})`,true);exports.comparatorTrimReplace="$1$2$3";createToken("HYPHENRANGE",`^\\s*(${src[t.XRANGEPLAIN]})`+`\\s+-\\s+`+`(${src[t.XRANGEPLAIN]})`+`\\s*$`);createToken("HYPHENRANGELOOSE",`^\\s*(${src[t.XRANGEPLAINLOOSE]})`+`\\s+-\\s+`+`(${src[t.XRANGEPLAINLOOSE]})`+`\\s*$`);createToken("STAR","(<|>)?=?\\s*\\*");createToken("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$");createToken("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},{"./constants":241,"./debug":242}],247:[function(require,module,exports){const outside=require("./outside");const gtr=(version,range,options)=>outside(version,range,">",options);module.exports=gtr},{"./outside":253}],248:[function(require,module,exports){const Range=require("../classes/range");const intersects=(r1,r2,options)=>{r1=new Range(r1,options);r2=new Range(r2,options);return r1.intersects(r2,options)};module.exports=intersects},{"../classes/range":214}],249:[function(require,module,exports){const outside=require("./outside");const ltr=(version,range,options)=>outside(version,range,"<",options);module.exports=ltr},{"./outside":253}],250:[function(require,module,exports){const SemVer=require("../classes/semver");const Range=require("../classes/range");const maxSatisfying=(versions,range,options)=>{let max=null;let maxSV=null;let rangeObj=null;try{rangeObj=new Range(range,options)}catch(er){return null}versions.forEach(v=>{if(rangeObj.test(v)){if(!max||maxSV.compare(v)===-1){max=v;maxSV=new SemVer(max,options)}}});return max};module.exports=maxSatisfying},{"../classes/range":214,"../classes/semver":215}],251:[function(require,module,exports){const SemVer=require("../classes/semver");const Range=require("../classes/range");const minSatisfying=(versions,range,options)=>{let min=null;let minSV=null;let rangeObj=null;try{rangeObj=new Range(range,options)}catch(er){return null}versions.forEach(v=>{if(rangeObj.test(v)){if(!min||minSV.compare(v)===1){min=v;minSV=new SemVer(min,options)}}});return min};module.exports=minSatisfying},{"../classes/range":214,"../classes/semver":215}],252:[function(require,module,exports){const SemVer=require("../classes/semver");const Range=require("../classes/range");const gt=require("../functions/gt");const minVersion=(range,loose)=>{range=new Range(range,loose);let minver=new SemVer("0.0.0");if(range.test(minver)){return minver}minver=new SemVer("0.0.0-0");if(range.test(minver)){return minver}minver=null;for(let i=0;i<range.set.length;++i){const comparators=range.set[i];let setMin=null;comparators.forEach(comparator=>{const compver=new SemVer(comparator.semver.version);switch(comparator.operator){case">":if(compver.prerelease.length===0){compver.patch++}else{compver.prerelease.push(0)}compver.raw=compver.format();case"":case">=":if(!setMin||gt(compver,setMin)){setMin=compver}break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${comparator.operator}`)}});if(setMin&&(!minver||gt(minver,setMin))){minver=setMin}}if(minver&&range.test(minver)){return minver}return null};module.exports=minVersion},{"../classes/range":214,"../classes/semver":215,"../functions/gt":224}],253:[function(require,module,exports){const SemVer=require("../classes/semver");const Comparator=require("../classes/comparator");const{ANY:ANY}=Comparator;const Range=require("../classes/range");const satisfies=require("../functions/satisfies");const gt=require("../functions/gt");const lt=require("../functions/lt");const lte=require("../functions/lte");const gte=require("../functions/gte");const outside=(version,range,hilo,options)=>{version=new SemVer(version,options);range=new Range(range,options);let gtfn,ltefn,ltfn,comp,ecomp;switch(hilo){case">":gtfn=gt;ltefn=lte;ltfn=lt;comp=">";ecomp=">=";break;case"<":gtfn=lt;ltefn=gte;ltfn=gt;comp="<";ecomp="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(satisfies(version,range,options)){return false}for(let i=0;i<range.set.length;++i){const comparators=range.set[i];let high=null;let low=null;comparators.forEach(comparator=>{if(comparator.semver===ANY){comparator=new Comparator(">=0.0.0")}high=high||comparator;low=low||comparator;if(gtfn(comparator.semver,high.semver,options)){high=comparator}else if(ltfn(comparator.semver,low.semver,options)){low=comparator}});if(high.operator===comp||high.operator===ecomp){return false}if((!low.operator||low.operator===comp)&&ltefn(version,low.semver)){return false}else if(low.operator===ecomp&&ltfn(version,low.semver)){return false}}return true};module.exports=outside},{"../classes/comparator":213,"../classes/range":214,"../classes/semver":215,"../functions/gt":224,"../functions/gte":225,"../functions/lt":227,"../functions/lte":228,"../functions/satisfies":237}],254:[function(require,module,exports){const satisfies=require("../functions/satisfies.js");const compare=require("../functions/compare.js");module.exports=(versions,range,options)=>{const set=[];let first=null;let prev=null;const v=versions.sort((a,b)=>compare(a,b,options));for(const version of v){const included=satisfies(version,range,options);if(included){prev=version;if(!first){first=version}}else{if(prev){set.push([first,prev])}prev=null;first=null}}if(first){set.push([first,null])}const ranges=[];for(const[min,max]of set){if(min===max){ranges.push(min)}else if(!max&&min===v[0]){ranges.push("*")}else if(!max){ranges.push(`>=${min}`)}else if(min===v[0]){ranges.push(`<=${max}`)}else{ranges.push(`${min} - ${max}`)}}const simplified=ranges.join(" || ");const original=typeof range.raw==="string"?range.raw:String(range);return simplified.length<original.length?simplified:range}},{"../functions/compare.js":221,"../functions/satisfies.js":237}],255:[function(require,module,exports){const Range=require("../classes/range.js");const Comparator=require("../classes/comparator.js");const{ANY:ANY}=Comparator;const satisfies=require("../functions/satisfies.js");const compare=require("../functions/compare.js");const subset=(sub,dom,options={})=>{if(sub===dom){return true}sub=new Range(sub,options);dom=new Range(dom,options);let sawNonNull=false;OUTER:for(const simpleSub of sub.set){for(const simpleDom of dom.set){const isSub=simpleSubset(simpleSub,simpleDom,options);sawNonNull=sawNonNull||isSub!==null;if(isSub){continue OUTER}}if(sawNonNull){return false}}return true};const minimumVersionWithPreRelease=[new Comparator(">=0.0.0-0")];const minimumVersion=[new Comparator(">=0.0.0")];const simpleSubset=(sub,dom,options)=>{if(sub===dom){return true}if(sub.length===1&&sub[0].semver===ANY){if(dom.length===1&&dom[0].semver===ANY){return true}else if(options.includePrerelease){sub=minimumVersionWithPreRelease}else{sub=minimumVersion}}if(dom.length===1&&dom[0].semver===ANY){if(options.includePrerelease){return true}else{dom=minimumVersion}}const eqSet=new Set;let gt,lt;for(const c of sub){if(c.operator===">"||c.operator===">="){gt=higherGT(gt,c,options)}else if(c.operator==="<"||c.operator==="<="){lt=lowerLT(lt,c,options)}else{eqSet.add(c.semver)}}if(eqSet.size>1){return null}let gtltComp;if(gt&&lt){gtltComp=compare(gt.semver,lt.semver,options);if(gtltComp>0){return null}else if(gtltComp===0&&(gt.operator!==">="||lt.operator!=="<=")){return null}}for(const eq of eqSet){if(gt&&!satisfies(eq,String(gt),options)){return null}if(lt&&!satisfies(eq,String(lt),options)){return null}for(const c of dom){if(!satisfies(eq,String(c),options)){return false}}return true}let higher,lower;let hasDomLT,hasDomGT;let needDomLTPre=lt&&!options.includePrerelease&&lt.semver.prerelease.length?lt.semver:false;let needDomGTPre=gt&&!options.includePrerelease&&gt.semver.prerelease.length?gt.semver:false;if(needDomLTPre&&needDomLTPre.prerelease.length===1&&lt.operator==="<"&&needDomLTPre.prerelease[0]===0){needDomLTPre=false}for(const c of dom){hasDomGT=hasDomGT||c.operator===">"||c.operator===">=";hasDomLT=hasDomLT||c.operator==="<"||c.operator==="<=";if(gt){if(needDomGTPre){if(c.semver.prerelease&&c.semver.prerelease.length&&c.semver.major===needDomGTPre.major&&c.semver.minor===needDomGTPre.minor&&c.semver.patch===needDomGTPre.patch){needDomGTPre=false}}if(c.operator===">"||c.operator===">="){higher=higherGT(gt,c,options);if(higher===c&&higher!==gt){return false}}else if(gt.operator===">="&&!satisfies(gt.semver,String(c),options)){return false}}if(lt){if(needDomLTPre){if(c.semver.prerelease&&c.semver.prerelease.length&&c.semver.major===needDomLTPre.major&&c.semver.minor===needDomLTPre.minor&&c.semver.patch===needDomLTPre.patch){needDomLTPre=false}}if(c.operator==="<"||c.operator==="<="){lower=lowerLT(lt,c,options);if(lower===c&&lower!==lt){return false}}else if(lt.operator==="<="&&!satisfies(lt.semver,String(c),options)){return false}}if(!c.operator&&(lt||gt)&&gtltComp!==0){return false}}if(gt&&hasDomLT&&!lt&&gtltComp!==0){return false}if(lt&&hasDomGT&&!gt&&gtltComp!==0){return false}if(needDomGTPre||needDomLTPre){return false}return true};const higherGT=(a,b,options)=>{if(!a){return b}const comp=compare(a.semver,b.semver,options);return comp>0?a:comp<0?b:b.operator===">"&&a.operator===">="?b:a};const lowerLT=(a,b,options)=>{if(!a){return b}const comp=compare(a.semver,b.semver,options);return comp<0?a:comp>0?b:b.operator==="<"&&a.operator==="<="?b:a};module.exports=subset},{"../classes/comparator.js":213,"../classes/range.js":214,"../functions/compare.js":221,"../functions/satisfies.js":237}],256:[function(require,module,exports){const Range=require("../classes/range");const toComparators=(range,options)=>new Range(range,options).set.map(comp=>comp.map(c=>c.value).join(" ").trim().split(" "));module.exports=toComparators},{"../classes/range":214}],257:[function(require,module,exports){const Range=require("../classes/range");const validRange=(range,options)=>{try{return new Range(range,options).range||"*"}catch(er){return null}};module.exports=validRange},{"../classes/range":214}],258:[function(require,module,exports){"use strict";var __rest=this&&this.__rest||function(s,e){var t={};for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0)t[p]=s[p];if(s!=null&&typeof Object.getOwnPropertySymbols==="function")for(var i=0,p=Object.getOwnPropertySymbols(s);i<p.length;i++){if(e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i]))t[p[i]]=s[p[i]]}return t};Object.defineProperty(exports,"__esModule",{value:true});exports.ClusterAdapterWithHeartbeat=exports.ClusterAdapter=exports.MessageType=void 0;const in_memory_adapter_1=require("./in-memory-adapter");const debug_1=require("debug");const crypto_1=require("crypto");const debug=(0,debug_1.debug)("socket.io-adapter");const EMITTER_UID="emitter";const DEFAULT_TIMEOUT=5e3;function randomId(){return(0,crypto_1.randomBytes)(8).toString("hex")}var MessageType;(function(MessageType){MessageType[MessageType["INITIAL_HEARTBEAT"]=1]="INITIAL_HEARTBEAT";MessageType[MessageType["HEARTBEAT"]=2]="HEARTBEAT";MessageType[MessageType["BROADCAST"]=3]="BROADCAST";MessageType[MessageType["SOCKETS_JOIN"]=4]="SOCKETS_JOIN";MessageType[MessageType["SOCKETS_LEAVE"]=5]="SOCKETS_LEAVE";MessageType[MessageType["DISCONNECT_SOCKETS"]=6]="DISCONNECT_SOCKETS";MessageType[MessageType["FETCH_SOCKETS"]=7]="FETCH_SOCKETS";MessageType[MessageType["FETCH_SOCKETS_RESPONSE"]=8]="FETCH_SOCKETS_RESPONSE";MessageType[MessageType["SERVER_SIDE_EMIT"]=9]="SERVER_SIDE_EMIT";MessageType[MessageType["SERVER_SIDE_EMIT_RESPONSE"]=10]="SERVER_SIDE_EMIT_RESPONSE";MessageType[MessageType["BROADCAST_CLIENT_COUNT"]=11]="BROADCAST_CLIENT_COUNT";MessageType[MessageType["BROADCAST_ACK"]=12]="BROADCAST_ACK";MessageType[MessageType["ADAPTER_CLOSE"]=13]="ADAPTER_CLOSE"})(MessageType=exports.MessageType||(exports.MessageType={}));function encodeOptions(opts){return{rooms:[...opts.rooms],except:[...opts.except],flags:opts.flags}}function decodeOptions(opts){return{rooms:new Set(opts.rooms),except:new Set(opts.except),flags:opts.flags}}class ClusterAdapter extends in_memory_adapter_1.Adapter{constructor(nsp){super(nsp);this.requests=new Map;this.ackRequests=new Map;this.uid=randomId()}onMessage(message,offset){if(message.uid===this.uid){return debug("[%s] ignore message from self",this.uid)}debug("[%s] new event of type %d from %s",this.uid,message.type,message.uid);switch(message.type){case MessageType.BROADCAST:{const withAck=message.data.requestId!==undefined;if(withAck){super.broadcastWithAck(message.data.packet,decodeOptions(message.data.opts),clientCount=>{debug("[%s] waiting for %d client acknowledgements",this.uid,clientCount);this.publishResponse(message.uid,{type:MessageType.BROADCAST_CLIENT_COUNT,data:{requestId:message.data.requestId,clientCount:clientCount}})},arg=>{debug("[%s] received acknowledgement with value %j",this.uid,arg);this.publishResponse(message.uid,{type:MessageType.BROADCAST_ACK,data:{requestId:message.data.requestId,packet:arg}})})}else{const packet=message.data.packet;const opts=decodeOptions(message.data.opts);this.addOffsetIfNecessary(packet,opts,offset);super.broadcast(packet,opts)}break}case MessageType.SOCKETS_JOIN:super.addSockets(decodeOptions(message.data.opts),message.data.rooms);break;case MessageType.SOCKETS_LEAVE:super.delSockets(decodeOptions(message.data.opts),message.data.rooms);break;case MessageType.DISCONNECT_SOCKETS:super.disconnectSockets(decodeOptions(message.data.opts),message.data.close);break;case MessageType.FETCH_SOCKETS:{debug("[%s] calling fetchSockets with opts %j",this.uid,message.data.opts);super.fetchSockets(decodeOptions(message.data.opts)).then(localSockets=>{this.publishResponse(message.uid,{type:MessageType.FETCH_SOCKETS_RESPONSE,data:{requestId:message.data.requestId,sockets:localSockets.map(socket=>{const _a=socket.handshake,{sessionStore:sessionStore}=_a,handshake=__rest(_a,["sessionStore"]);return{id:socket.id,handshake:handshake,rooms:[...socket.rooms],data:socket.data}})}})});break}case MessageType.SERVER_SIDE_EMIT:{const packet=message.data.packet;const withAck=message.data.requestId!==undefined;if(!withAck){this.nsp._onServerSideEmit(packet);return}let called=false;const callback=arg=>{if(called){return}called=true;debug("[%s] calling acknowledgement with %j",this.uid,arg);this.publishResponse(message.uid,{type:MessageType.SERVER_SIDE_EMIT_RESPONSE,data:{requestId:message.data.requestId,packet:arg}})};this.nsp._onServerSideEmit([...packet,callback]);break}case MessageType.BROADCAST_CLIENT_COUNT:case MessageType.BROADCAST_ACK:case MessageType.FETCH_SOCKETS_RESPONSE:case MessageType.SERVER_SIDE_EMIT_RESPONSE:this.onResponse(message);break;default:debug("[%s] unknown message type: %s",this.uid,message.type)}}onResponse(response){var _a,_b;const requestId=response.data.requestId;debug("[%s] received response %s to request %s",this.uid,response.type,requestId);switch(response.type){case MessageType.BROADCAST_CLIENT_COUNT:{(_a=this.ackRequests.get(requestId))===null||_a===void 0?void 0:_a.clientCountCallback(response.data.clientCount);break}case MessageType.BROADCAST_ACK:{(_b=this.ackRequests.get(requestId))===null||_b===void 0?void 0:_b.ack(response.data.packet);break}case MessageType.FETCH_SOCKETS_RESPONSE:{const request=this.requests.get(requestId);if(!request){return}request.current++;response.data.sockets.forEach(socket=>request.responses.push(socket));if(request.current===request.expected){clearTimeout(request.timeout);request.resolve(request.responses);this.requests.delete(requestId)}break}case MessageType.SERVER_SIDE_EMIT_RESPONSE:{const request=this.requests.get(requestId);if(!request){return}request.current++;request.responses.push(response.data.packet);if(request.current===request.expected){clearTimeout(request.timeout);request.resolve(null,request.responses);this.requests.delete(requestId)}break}default:debug("[%s] unknown response type: %s",this.uid,response.type)}}async broadcast(packet,opts){var _a;const onlyLocal=(_a=opts.flags)===null||_a===void 0?void 0:_a.local;if(!onlyLocal){try{const offset=await this.publishAndReturnOffset({type:MessageType.BROADCAST,data:{packet:packet,opts:encodeOptions(opts)}});this.addOffsetIfNecessary(packet,opts,offset)}catch(e){return debug("[%s] error while broadcasting message: %s",this.uid,e.message)}}super.broadcast(packet,opts)}addOffsetIfNecessary(packet,opts,offset){var _a;if(!this.nsp.server.opts.connectionStateRecovery){return}const isEventPacket=packet.type===2;const withoutAcknowledgement=packet.id===undefined;const notVolatile=((_a=opts.flags)===null||_a===void 0?void 0:_a.volatile)===undefined;if(isEventPacket&&withoutAcknowledgement&&notVolatile){packet.data.push(offset)}}broadcastWithAck(packet,opts,clientCountCallback,ack){var _a;const onlyLocal=(_a=opts===null||opts===void 0?void 0:opts.flags)===null||_a===void 0?void 0:_a.local;if(!onlyLocal){const requestId=randomId();this.ackRequests.set(requestId,{clientCountCallback:clientCountCallback,ack:ack});this.publish({type:MessageType.BROADCAST,data:{packet:packet,requestId:requestId,opts:encodeOptions(opts)}});setTimeout(()=>{this.ackRequests.delete(requestId)},opts.flags.timeout)}super.broadcastWithAck(packet,opts,clientCountCallback,ack)}async addSockets(opts,rooms){var _a;const onlyLocal=(_a=opts.flags)===null||_a===void 0?void 0:_a.local;if(!onlyLocal){try{await this.publishAndReturnOffset({type:MessageType.SOCKETS_JOIN,data:{opts:encodeOptions(opts),rooms:rooms}})}catch(e){debug("[%s] error while publishing message: %s",this.uid,e.message)}}super.addSockets(opts,rooms)}async delSockets(opts,rooms){var _a;const onlyLocal=(_a=opts.flags)===null||_a===void 0?void 0:_a.local;if(!onlyLocal){try{await this.publishAndReturnOffset({type:MessageType.SOCKETS_LEAVE,data:{opts:encodeOptions(opts),rooms:rooms}})}catch(e){debug("[%s] error while publishing message: %s",this.uid,e.message)}}super.delSockets(opts,rooms)}async disconnectSockets(opts,close){var _a;const onlyLocal=(_a=opts.flags)===null||_a===void 0?void 0:_a.local;if(!onlyLocal){try{await this.publishAndReturnOffset({type:MessageType.DISCONNECT_SOCKETS,data:{opts:encodeOptions(opts),close:close}})}catch(e){debug("[%s] error while publishing message: %s",this.uid,e.message)}}super.disconnectSockets(opts,close)}async fetchSockets(opts){var _a;const[localSockets,serverCount]=await Promise.all([super.fetchSockets(opts),this.serverCount()]);const expectedResponseCount=serverCount-1;if(((_a=opts.flags)===null||_a===void 0?void 0:_a.local)||expectedResponseCount<=0){return localSockets}const requestId=randomId();return new Promise((resolve,reject)=>{const timeout=setTimeout(()=>{const storedRequest=this.requests.get(requestId);if(storedRequest){reject(new Error(`timeout reached: only ${storedRequest.current} responses received out of ${storedRequest.expected}`));this.requests.delete(requestId)}},opts.flags.timeout||DEFAULT_TIMEOUT);const storedRequest={type:MessageType.FETCH_SOCKETS,resolve:resolve,timeout:timeout,current:0,expected:expectedResponseCount,responses:localSockets};this.requests.set(requestId,storedRequest);this.publish({type:MessageType.FETCH_SOCKETS,data:{opts:encodeOptions(opts),requestId:requestId}})})}async serverSideEmit(packet){const withAck=typeof packet[packet.length-1]==="function";if(!withAck){return this.publish({type:MessageType.SERVER_SIDE_EMIT,data:{packet:packet}})}const ack=packet.pop();const expectedResponseCount=await this.serverCount()-1;debug('[%s] waiting for %d responses to "serverSideEmit" request',this.uid,expectedResponseCount);if(expectedResponseCount<=0){return ack(null,[])}const requestId=randomId();const timeout=setTimeout(()=>{const storedRequest=this.requests.get(requestId);if(storedRequest){ack(new Error(`timeout reached: only ${storedRequest.current} responses received out of ${storedRequest.expected}`),storedRequest.responses);this.requests.delete(requestId)}},DEFAULT_TIMEOUT);const storedRequest={type:MessageType.SERVER_SIDE_EMIT,resolve:ack,timeout:timeout,current:0,expected:expectedResponseCount,responses:[]};this.requests.set(requestId,storedRequest);this.publish({type:MessageType.SERVER_SIDE_EMIT,data:{requestId:requestId,packet:packet}})}publish(message){this.publishAndReturnOffset(message).catch(err=>{debug("[%s] error while publishing message: %s",this.uid,err)})}publishAndReturnOffset(message){message.uid=this.uid;message.nsp=this.nsp.name;return this.doPublish(message)}publishResponse(requesterUid,response){response.uid=this.uid;response.nsp=this.nsp.name;this.doPublishResponse(requesterUid,response).catch(err=>{debug("[%s] error while publishing response: %s",this.uid,err)})}}exports.ClusterAdapter=ClusterAdapter;class ClusterAdapterWithHeartbeat extends ClusterAdapter{constructor(nsp,opts){super(nsp);this.nodesMap=new Map;this.customRequests=new Map;this._opts=Object.assign({heartbeatInterval:5e3,heartbeatTimeout:1e4},opts);this.cleanupTimer=setInterval(()=>{const now=Date.now();this.nodesMap.forEach((lastSeen,uid)=>{const nodeSeemsDown=now-lastSeen>this._opts.heartbeatTimeout;if(nodeSeemsDown){debug("[%s] node %s seems down",this.uid,uid);this.removeNode(uid)}})},1e3)}init(){this.publish({type:MessageType.INITIAL_HEARTBEAT})}scheduleHeartbeat(){if(this.heartbeatTimer){this.heartbeatTimer.refresh()}else{this.heartbeatTimer=setTimeout(()=>{this.publish({type:MessageType.HEARTBEAT})},this._opts.heartbeatInterval)}}close(){this.publish({type:MessageType.ADAPTER_CLOSE});clearTimeout(this.heartbeatTimer);if(this.cleanupTimer){clearInterval(this.cleanupTimer)}}onMessage(message,offset){if(message.uid===this.uid){return debug("[%s] ignore message from self",this.uid)}if(message.uid&&message.uid!==EMITTER_UID){this.nodesMap.set(message.uid,Date.now())}debug("[%s] new event of type %d from %s",this.uid,message.type,message.uid);switch(message.type){case MessageType.INITIAL_HEARTBEAT:this.publish({type:MessageType.HEARTBEAT});break;case MessageType.HEARTBEAT:break;case MessageType.ADAPTER_CLOSE:this.removeNode(message.uid);break;default:super.onMessage(message,offset)}}serverCount(){return Promise.resolve(1+this.nodesMap.size)}publish(message){this.scheduleHeartbeat();return super.publish(message)}async serverSideEmit(packet){const withAck=typeof packet[packet.length-1]==="function";if(!withAck){return this.publish({type:MessageType.SERVER_SIDE_EMIT,data:{packet:packet}})}const ack=packet.pop();const expectedResponseCount=this.nodesMap.size;debug('[%s] waiting for %d responses to "serverSideEmit" request',this.uid,expectedResponseCount);if(expectedResponseCount<=0){return ack(null,[])}const requestId=randomId();const timeout=setTimeout(()=>{const storedRequest=this.customRequests.get(requestId);if(storedRequest){ack(new Error(`timeout reached: missing ${storedRequest.missingUids.size} responses`),storedRequest.responses);this.customRequests.delete(requestId)}},DEFAULT_TIMEOUT);const storedRequest={type:MessageType.SERVER_SIDE_EMIT,resolve:ack,timeout:timeout,missingUids:new Set([...this.nodesMap.keys()]),responses:[]};this.customRequests.set(requestId,storedRequest);this.publish({type:MessageType.SERVER_SIDE_EMIT,data:{requestId:requestId,packet:packet}})}async fetchSockets(opts){var _a;const[localSockets,serverCount]=await Promise.all([super.fetchSockets({rooms:opts.rooms,except:opts.except,flags:{local:true}}),this.serverCount()]);const expectedResponseCount=serverCount-1;if(((_a=opts.flags)===null||_a===void 0?void 0:_a.local)||expectedResponseCount<=0){return localSockets}const requestId=randomId();return new Promise((resolve,reject)=>{const timeout=setTimeout(()=>{const storedRequest=this.customRequests.get(requestId);if(storedRequest){reject(new Error(`timeout reached: missing ${storedRequest.missingUids.size} responses`));this.customRequests.delete(requestId)}},opts.flags.timeout||DEFAULT_TIMEOUT);const storedRequest={type:MessageType.FETCH_SOCKETS,resolve:resolve,timeout:timeout,missingUids:new Set([...this.nodesMap.keys()]),responses:localSockets};this.customRequests.set(requestId,storedRequest);this.publish({type:MessageType.FETCH_SOCKETS,data:{opts:encodeOptions(opts),requestId:requestId}})})}onResponse(response){const requestId=response.data.requestId;debug("[%s] received response %s to request %s",this.uid,response.type,requestId);switch(response.type){case MessageType.FETCH_SOCKETS_RESPONSE:{const request=this.customRequests.get(requestId);if(!request){return}response.data.sockets.forEach(socket=>request.responses.push(socket));request.missingUids.delete(response.uid);if(request.missingUids.size===0){clearTimeout(request.timeout);request.resolve(request.responses);this.customRequests.delete(requestId)}break}case MessageType.SERVER_SIDE_EMIT_RESPONSE:{const request=this.customRequests.get(requestId);if(!request){return}request.responses.push(response.data.packet);request.missingUids.delete(response.uid);if(request.missingUids.size===0){clearTimeout(request.timeout);request.resolve(null,request.responses);this.customRequests.delete(requestId)}break}default:super.onResponse(response)}}removeNode(uid){this.customRequests.forEach((request,requestId)=>{request.missingUids.delete(uid);if(request.missingUids.size===0){clearTimeout(request.timeout);if(request.type===MessageType.FETCH_SOCKETS){request.resolve(request.responses)}else if(request.type===MessageType.SERVER_SIDE_EMIT){request.resolve(null,request.responses)}this.customRequests.delete(requestId)}});this.nodesMap.delete(uid)}}exports.ClusterAdapterWithHeartbeat=ClusterAdapterWithHeartbeat},{"./in-memory-adapter":260,crypto:undefined,debug:264}],259:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.yeast=exports.decode=exports.encode=void 0;const alphabet="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),length=64,map={};let seed=0,i=0,prev;function encode(num){let encoded="";do{encoded=alphabet[num%length]+encoded;num=Math.floor(num/length)}while(num>0);return encoded}exports.encode=encode;function decode(str){let decoded=0;for(i=0;i<str.length;i++){decoded=decoded*length+map[str.charAt(i)]}return decoded}exports.decode=decode;function yeast(){const now=encode(+new Date);if(now!==prev)return seed=0,prev=now;return now+"."+encode(seed++)}exports.yeast=yeast;for(;i<length;i++)map[alphabet[i]]=i},{}],260:[function(require,module,exports){"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:true});exports.SessionAwareAdapter=exports.Adapter=void 0;const events_1=require("events");const yeast_1=require("./contrib/yeast");const WebSocket=require("ws");const canPreComputeFrame=typeof((_a=WebSocket===null||WebSocket===void 0?void 0:WebSocket.Sender)===null||_a===void 0?void 0:_a.frame)==="function";class Adapter extends events_1.EventEmitter{constructor(nsp){super();this.nsp=nsp;this.rooms=new Map;this.sids=new Map;this.encoder=nsp.server.encoder}init(){}close(){}serverCount(){return Promise.resolve(1)}addAll(id,rooms){if(!this.sids.has(id)){this.sids.set(id,new Set)}for(const room of rooms){this.sids.get(id).add(room);if(!this.rooms.has(room)){this.rooms.set(room,new Set);this.emit("create-room",room)}if(!this.rooms.get(room).has(id)){this.rooms.get(room).add(id);this.emit("join-room",room,id)}}}del(id,room){if(this.sids.has(id)){this.sids.get(id).delete(room)}this._del(room,id)}_del(room,id){const _room=this.rooms.get(room);if(_room!=null){const deleted=_room.delete(id);if(deleted){this.emit("leave-room",room,id)}if(_room.size===0&&this.rooms.delete(room)){this.emit("delete-room",room)}}}delAll(id){if(!this.sids.has(id)){return}for(const room of this.sids.get(id)){this._del(room,id)}this.sids.delete(id)}broadcast(packet,opts){const flags=opts.flags||{};const packetOpts={preEncoded:true,volatile:flags.volatile,compress:flags.compress};packet.nsp=this.nsp.name;const encodedPackets=this._encode(packet,packetOpts);this.apply(opts,socket=>{if(typeof socket.notifyOutgoingListeners==="function"){socket.notifyOutgoingListeners(packet)}socket.client.writeToEngine(encodedPackets,packetOpts)})}broadcastWithAck(packet,opts,clientCountCallback,ack){const flags=opts.flags||{};const packetOpts={preEncoded:true,volatile:flags.volatile,compress:flags.compress};packet.nsp=this.nsp.name;packet.id=this.nsp._ids++;const encodedPackets=this._encode(packet,packetOpts);let clientCount=0;this.apply(opts,socket=>{clientCount++;socket.acks.set(packet.id,ack);if(typeof socket.notifyOutgoingListeners==="function"){socket.notifyOutgoingListeners(packet)}socket.client.writeToEngine(encodedPackets,packetOpts)});clientCountCallback(clientCount)}_encode(packet,packetOpts){const encodedPackets=this.encoder.encode(packet);if(canPreComputeFrame&&encodedPackets.length===1&&typeof encodedPackets[0]==="string"){const data=Buffer.from("4"+encodedPackets[0]);packetOpts.wsPreEncodedFrame=WebSocket.Sender.frame(data,{readOnly:false,mask:false,rsv1:false,opcode:1,fin:true})}return encodedPackets}sockets(rooms){const sids=new Set;this.apply({rooms:rooms},socket=>{sids.add(socket.id)});return Promise.resolve(sids)}socketRooms(id){return this.sids.get(id)}fetchSockets(opts){const sockets=[];this.apply(opts,socket=>{sockets.push(socket)});return Promise.resolve(sockets)}addSockets(opts,rooms){this.apply(opts,socket=>{socket.join(rooms)})}delSockets(opts,rooms){this.apply(opts,socket=>{rooms.forEach(room=>socket.leave(room))})}disconnectSockets(opts,close){this.apply(opts,socket=>{socket.disconnect(close)})}apply(opts,callback){const rooms=opts.rooms;const except=this.computeExceptSids(opts.except);if(rooms.size){const ids=new Set;for(const room of rooms){if(!this.rooms.has(room))continue;for(const id of this.rooms.get(room)){if(ids.has(id)||except.has(id))continue;const socket=this.nsp.sockets.get(id);if(socket){callback(socket);ids.add(id)}}}}else{for(const[id]of this.sids){if(except.has(id))continue;const socket=this.nsp.sockets.get(id);if(socket)callback(socket)}}}computeExceptSids(exceptRooms){const exceptSids=new Set;if(exceptRooms&&exceptRooms.size>0){for(const room of exceptRooms){if(this.rooms.has(room)){this.rooms.get(room).forEach(sid=>exceptSids.add(sid))}}}return exceptSids}serverSideEmit(packet){console.warn("this adapter does not support the serverSideEmit() functionality")}persistSession(session){}restoreSession(pid,offset){return null}}exports.Adapter=Adapter;class SessionAwareAdapter extends Adapter{constructor(nsp){super(nsp);this.nsp=nsp;this.sessions=new Map;this.packets=[];this.maxDisconnectionDuration=nsp.server.opts.connectionStateRecovery.maxDisconnectionDuration;const timer=setInterval(()=>{const threshold=Date.now()-this.maxDisconnectionDuration;this.sessions.forEach((session,sessionId)=>{const hasExpired=session.disconnectedAt<threshold;if(hasExpired){this.sessions.delete(sessionId)}});for(let i=this.packets.length-1;i>=0;i--){const hasExpired=this.packets[i].emittedAt<threshold;if(hasExpired){this.packets.splice(0,i+1);break}}},60*1e3);timer.unref()}persistSession(session){session.disconnectedAt=Date.now();this.sessions.set(session.pid,session)}restoreSession(pid,offset){const session=this.sessions.get(pid);if(!session){return null}const hasExpired=session.disconnectedAt+this.maxDisconnectionDuration<Date.now();if(hasExpired){this.sessions.delete(pid);return null}const index=this.packets.findIndex(packet=>packet.id===offset);if(index===-1){return null}const missedPackets=[];for(let i=index+1;i<this.packets.length;i++){const packet=this.packets[i];if(shouldIncludePacket(session.rooms,packet.opts)){missedPackets.push(packet.data)}}return Promise.resolve(Object.assign(Object.assign({},session),{missedPackets:missedPackets}))}broadcast(packet,opts){var _a;const isEventPacket=packet.type===2;const withoutAcknowledgement=packet.id===undefined;const notVolatile=((_a=opts.flags)===null||_a===void 0?void 0:_a.volatile)===undefined;if(isEventPacket&&withoutAcknowledgement&&notVolatile){const id=(0,yeast_1.yeast)();packet.data.push(id);this.packets.push({id:id,opts:opts,data:packet.data,emittedAt:Date.now()})}super.broadcast(packet,opts)}}exports.SessionAwareAdapter=SessionAwareAdapter;function shouldIncludePacket(sessionRooms,opts){const included=opts.rooms.size===0||sessionRooms.some(room=>opts.rooms.has(room));const notExcluded=sessionRooms.every(room=>!opts.except.has(room));return included&&notExcluded}},{"./contrib/yeast":259,events:undefined,ws:317}],261:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.MessageType=exports.ClusterAdapterWithHeartbeat=exports.ClusterAdapter=exports.SessionAwareAdapter=exports.Adapter=void 0;var in_memory_adapter_1=require("./in-memory-adapter");Object.defineProperty(exports,"Adapter",{enumerable:true,get:function(){return in_memory_adapter_1.Adapter}});Object.defineProperty(exports,"SessionAwareAdapter",{enumerable:true,get:function(){return in_memory_adapter_1.SessionAwareAdapter}});var cluster_adapter_1=require("./cluster-adapter");Object.defineProperty(exports,"ClusterAdapter",{enumerable:true,get:function(){return cluster_adapter_1.ClusterAdapter}});Object.defineProperty(exports,"ClusterAdapterWithHeartbeat",{enumerable:true,get:function(){return cluster_adapter_1.ClusterAdapterWithHeartbeat}});Object.defineProperty(exports,"MessageType",{enumerable:true,get:function(){return cluster_adapter_1.MessageType}})},{"./cluster-adapter":258,"./in-memory-adapter":260}],262:[function(require,module,exports){arguments[4][105][0].apply(exports,arguments)},{"./common":263,dup:105}],263:[function(require,module,exports){arguments[4][106][0].apply(exports,arguments)},{dup:106,ms:202}],264:[function(require,module,exports){arguments[4][107][0].apply(exports,arguments)},{"./browser.js":262,"./node.js":265,dup:107}],265:[function(require,module,exports){arguments[4][108][0].apply(exports,arguments)},{"./common":263,dup:108,"supports-color":297,tty:undefined,util:undefined}],266:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Backoff=Backoff;function Backoff(opts){opts=opts||{};this.ms=opts.min||100;this.max=opts.max||1e4;this.factor=opts.factor||2;this.jitter=opts.jitter>0&&opts.jitter<=1?opts.jitter:0;this.attempts=0}Backoff.prototype.duration=function(){var ms=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var rand=Math.random();var deviation=Math.floor(rand*this.jitter*ms);ms=(Math.floor(rand*10)&1)==0?ms-deviation:ms+deviation}return Math.min(ms,this.max)|0};Backoff.prototype.reset=function(){this.attempts=0};Backoff.prototype.setMin=function(min){this.ms=min};Backoff.prototype.setMax=function(max){this.max=max};Backoff.prototype.setJitter=function(jitter){this.jitter=jitter}},{}],267:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.WebTransport=exports.WebSocket=exports.NodeWebSocket=exports.XHR=exports.NodeXHR=exports.Fetch=exports.Socket=exports.Manager=exports.protocol=void 0;exports.io=lookup;exports.connect=lookup;exports.default=lookup;const url_js_1=require("./url.js");const manager_js_1=require("./manager.js");Object.defineProperty(exports,"Manager",{enumerable:true,get:function(){return manager_js_1.Manager}});const socket_js_1=require("./socket.js");Object.defineProperty(exports,"Socket",{enumerable:true,get:function(){return socket_js_1.Socket}});const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("socket.io-client");const cache={};function lookup(uri,opts){if(typeof uri==="object"){opts=uri;uri=undefined}opts=opts||{};const parsed=(0,url_js_1.url)(uri,opts.path||"/socket.io");const source=parsed.source;const id=parsed.id;const path=parsed.path;const sameNamespace=cache[id]&&path in cache[id]["nsps"];const newConnection=opts.forceNew||opts["force new connection"]||false===opts.multiplex||sameNamespace;let io;if(newConnection){debug("ignoring socket cache for %s",source);io=new manager_js_1.Manager(source,opts)}else{if(!cache[id]){debug("new io instance for %s",source);cache[id]=new manager_js_1.Manager(source,opts)}io=cache[id]}if(parsed.query&&!opts.query){opts.query=parsed.queryKey}return io.socket(parsed.path,opts)}Object.assign(lookup,{Manager:manager_js_1.Manager,Socket:socket_js_1.Socket,io:lookup,connect:lookup});var socket_io_parser_1=require("socket.io-parser");Object.defineProperty(exports,"protocol",{enumerable:true,get:function(){return socket_io_parser_1.protocol}});var engine_io_client_1=require("engine.io-client");Object.defineProperty(exports,"Fetch",{enumerable:true,get:function(){return engine_io_client_1.Fetch}});Object.defineProperty(exports,"NodeXHR",{enumerable:true,get:function(){return engine_io_client_1.NodeXHR}});Object.defineProperty(exports,"XHR",{enumerable:true,get:function(){return engine_io_client_1.XHR}});Object.defineProperty(exports,"NodeWebSocket",{enumerable:true,get:function(){return engine_io_client_1.NodeWebSocket}});Object.defineProperty(exports,"WebSocket",{enumerable:true,get:function(){return engine_io_client_1.WebSocket}});Object.defineProperty(exports,"WebTransport",{enumerable:true,get:function(){return engine_io_client_1.WebTransport}});module.exports=lookup},{"./manager.js":268,"./socket.js":270,"./url.js":271,debug:274,"engine.io-client":93,"socket.io-parser":277}],268:[function(require,module,exports){"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||("get"in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k]}}}Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k]});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:true,value:v})}:function(o,v){o["default"]=v});var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(k!=="default"&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);__setModuleDefault(result,mod);return result};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.Manager=void 0;const engine_io_client_1=require("engine.io-client");const socket_js_1=require("./socket.js");const parser=__importStar(require("socket.io-parser"));const on_js_1=require("./on.js");const backo2_js_1=require("./contrib/backo2.js");const component_emitter_1=require("@socket.io/component-emitter");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("socket.io-client:manager");class Manager extends component_emitter_1.Emitter{constructor(uri,opts){var _a;super();this.nsps={};this.subs=[];if(uri&&"object"===typeof uri){opts=uri;uri=undefined}opts=opts||{};opts.path=opts.path||"/socket.io";this.opts=opts;(0,engine_io_client_1.installTimerFunctions)(this,opts);this.reconnection(opts.reconnection!==false);this.reconnectionAttempts(opts.reconnectionAttempts||Infinity);this.reconnectionDelay(opts.reconnectionDelay||1e3);this.reconnectionDelayMax(opts.reconnectionDelayMax||5e3);this.randomizationFactor((_a=opts.randomizationFactor)!==null&&_a!==void 0?_a:.5);this.backoff=new backo2_js_1.Backoff({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()});this.timeout(null==opts.timeout?2e4:opts.timeout);this._readyState="closed";this.uri=uri;const _parser=opts.parser||parser;this.encoder=new _parser.Encoder;this.decoder=new _parser.Decoder;this._autoConnect=opts.autoConnect!==false;if(this._autoConnect)this.open()}reconnection(v){if(!arguments.length)return this._reconnection;this._reconnection=!!v;if(!v){this.skipReconnect=true}return this}reconnectionAttempts(v){if(v===undefined)return this._reconnectionAttempts;this._reconnectionAttempts=v;return this}reconnectionDelay(v){var _a;if(v===undefined)return this._reconnectionDelay;this._reconnectionDelay=v;(_a=this.backoff)===null||_a===void 0?void 0:_a.setMin(v);return this}randomizationFactor(v){var _a;if(v===undefined)return this._randomizationFactor;this._randomizationFactor=v;(_a=this.backoff)===null||_a===void 0?void 0:_a.setJitter(v);return this}reconnectionDelayMax(v){var _a;if(v===undefined)return this._reconnectionDelayMax;this._reconnectionDelayMax=v;(_a=this.backoff)===null||_a===void 0?void 0:_a.setMax(v);return this}timeout(v){if(!arguments.length)return this._timeout;this._timeout=v;return this}maybeReconnectOnOpen(){if(!this._reconnecting&&this._reconnection&&this.backoff.attempts===0){this.reconnect()}}open(fn){debug("readyState %s",this._readyState);if(~this._readyState.indexOf("open"))return this;debug("opening %s",this.uri);this.engine=new engine_io_client_1.Socket(this.uri,this.opts);const socket=this.engine;const self=this;this._readyState="opening";this.skipReconnect=false;const openSubDestroy=(0,on_js_1.on)(socket,"open",function(){self.onopen();fn&&fn()});const onError=err=>{debug("error");this.cleanup();this._readyState="closed";this.emitReserved("error",err);if(fn){fn(err)}else{this.maybeReconnectOnOpen()}};const errorSub=(0,on_js_1.on)(socket,"error",onError);if(false!==this._timeout){const timeout=this._timeout;debug("connect attempt will timeout after %d",timeout);const timer=this.setTimeoutFn(()=>{debug("connect attempt timed out after %d",timeout);openSubDestroy();onError(new Error("timeout"));socket.close()},timeout);if(this.opts.autoUnref){timer.unref()}this.subs.push(()=>{this.clearTimeoutFn(timer)})}this.subs.push(openSubDestroy);this.subs.push(errorSub);return this}connect(fn){return this.open(fn)}onopen(){debug("open");this.cleanup();this._readyState="open";this.emitReserved("open");const socket=this.engine;this.subs.push((0,on_js_1.on)(socket,"ping",this.onping.bind(this)),(0,on_js_1.on)(socket,"data",this.ondata.bind(this)),(0,on_js_1.on)(socket,"error",this.onerror.bind(this)),(0,on_js_1.on)(socket,"close",this.onclose.bind(this)),(0,on_js_1.on)(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(data){try{this.decoder.add(data)}catch(e){this.onclose("parse error",e)}}ondecoded(packet){(0,engine_io_client_1.nextTick)(()=>{this.emitReserved("packet",packet)},this.setTimeoutFn)}onerror(err){debug("error",err);this.emitReserved("error",err)}socket(nsp,opts){let socket=this.nsps[nsp];if(!socket){socket=new socket_js_1.Socket(this,nsp,opts);this.nsps[nsp]=socket}else if(this._autoConnect&&!socket.active){socket.connect()}return socket}_destroy(socket){const nsps=Object.keys(this.nsps);for(const nsp of nsps){const socket=this.nsps[nsp];if(socket.active){debug("socket %s is still active, skipping close",nsp);return}}this._close()}_packet(packet){debug("writing packet %j",packet);const encodedPackets=this.encoder.encode(packet);for(let i=0;i<encodedPackets.length;i++){this.engine.write(encodedPackets[i],packet.options)}}cleanup(){debug("cleanup");this.subs.forEach(subDestroy=>subDestroy());this.subs.length=0;this.decoder.destroy()}_close(){debug("disconnect");this.skipReconnect=true;this._reconnecting=false;this.onclose("forced close")}disconnect(){return this._close()}onclose(reason,description){var _a;debug("closed due to %s",reason);this.cleanup();(_a=this.engine)===null||_a===void 0?void 0:_a.close();this.backoff.reset();this._readyState="closed";this.emitReserved("close",reason,description);if(this._reconnection&&!this.skipReconnect){this.reconnect()}}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const self=this;if(this.backoff.attempts>=this._reconnectionAttempts){debug("reconnect failed");this.backoff.reset();this.emitReserved("reconnect_failed");this._reconnecting=false}else{const delay=this.backoff.duration();debug("will wait %dms before reconnect attempt",delay);this._reconnecting=true;const timer=this.setTimeoutFn(()=>{if(self.skipReconnect)return;debug("attempting reconnect");this.emitReserved("reconnect_attempt",self.backoff.attempts);if(self.skipReconnect)return;self.open(err=>{if(err){debug("reconnect attempt error");self._reconnecting=false;self.reconnect();this.emitReserved("reconnect_error",err)}else{debug("reconnect success");self.onreconnect()}})},delay);if(this.opts.autoUnref){timer.unref()}this.subs.push(()=>{this.clearTimeoutFn(timer)})}}onreconnect(){const attempt=this.backoff.attempts;this._reconnecting=false;this.backoff.reset();this.emitReserved("reconnect",attempt)}}exports.Manager=Manager},{"./contrib/backo2.js":266,"./on.js":269,"./socket.js":270,"@socket.io/component-emitter":75,debug:274,"engine.io-client":93,"socket.io-parser":277}],269:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.on=on;function on(obj,ev,fn){obj.on(ev,fn);return function subDestroy(){obj.off(ev,fn)}}},{}],270:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.Socket=void 0;const socket_io_parser_1=require("socket.io-parser");const on_js_1=require("./on.js");const component_emitter_1=require("@socket.io/component-emitter");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("socket.io-client:socket");const RESERVED_EVENTS=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Socket extends component_emitter_1.Emitter{constructor(io,nsp,opts){super();this.connected=false;this.recovered=false;this.receiveBuffer=[];this.sendBuffer=[];this._queue=[];this._queueSeq=0;this.ids=0;this.acks={};this.flags={};this.io=io;this.nsp=nsp;if(opts&&opts.auth){this.auth=opts.auth}this._opts=Object.assign({},opts);if(this.io._autoConnect)this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const io=this.io;this.subs=[(0,on_js_1.on)(io,"open",this.onopen.bind(this)),(0,on_js_1.on)(io,"packet",this.onpacket.bind(this)),(0,on_js_1.on)(io,"error",this.onerror.bind(this)),(0,on_js_1.on)(io,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){if(this.connected)return this;this.subEvents();if(!this.io["_reconnecting"])this.io.open();if("open"===this.io._readyState)this.onopen();return this}open(){return this.connect()}send(...args){args.unshift("message");this.emit.apply(this,args);return this}emit(ev,...args){var _a,_b,_c;if(RESERVED_EVENTS.hasOwnProperty(ev)){throw new Error('"'+ev.toString()+'" is a reserved event name')}args.unshift(ev);if(this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile){this._addToQueue(args);return this}const packet={type:socket_io_parser_1.PacketType.EVENT,data:args};packet.options={};packet.options.compress=this.flags.compress!==false;if("function"===typeof args[args.length-1]){const id=this.ids++;debug("emitting packet with ack id %d",id);const ack=args.pop();this._registerAckCallback(id,ack);packet.id=id}const isTransportWritable=(_b=(_a=this.io.engine)===null||_a===void 0?void 0:_a.transport)===null||_b===void 0?void 0:_b.writable;const isConnected=this.connected&&!((_c=this.io.engine)===null||_c===void 0?void 0:_c._hasPingExpired());const discardPacket=this.flags.volatile&&!isTransportWritable;if(discardPacket){debug("discard packet as the transport is not currently writable")}else if(isConnected){this.notifyOutgoingListeners(packet);this.packet(packet)}else{this.sendBuffer.push(packet)}this.flags={};return this}_registerAckCallback(id,ack){var _a;const timeout=(_a=this.flags.timeout)!==null&&_a!==void 0?_a:this._opts.ackTimeout;if(timeout===undefined){this.acks[id]=ack;return}const timer=this.io.setTimeoutFn(()=>{delete this.acks[id];for(let i=0;i<this.sendBuffer.length;i++){if(this.sendBuffer[i].id===id){debug("removing packet with ack id %d from the buffer",id);this.sendBuffer.splice(i,1)}}debug("event with ack id %d has timed out after %d ms",id,timeout);ack.call(this,new Error("operation has timed out"))},timeout);const fn=(...args)=>{this.io.clearTimeoutFn(timer);ack.apply(this,args)};fn.withError=true;this.acks[id]=fn}emitWithAck(ev,...args){return new Promise((resolve,reject)=>{const fn=(arg1,arg2)=>arg1?reject(arg1):resolve(arg2);fn.withError=true;args.push(fn);this.emit(ev,...args)})}_addToQueue(args){let ack;if(typeof args[args.length-1]==="function"){ack=args.pop()}const packet={id:this._queueSeq++,tryCount:0,pending:false,args:args,flags:Object.assign({fromQueue:true},this.flags)};args.push((err,...responseArgs)=>{if(packet!==this._queue[0]){return}const hasError=err!==null;if(hasError){if(packet.tryCount>this._opts.retries){debug("packet [%d] is discarded after %d tries",packet.id,packet.tryCount);this._queue.shift();if(ack){ack(err)}}}else{debug("packet [%d] was successfully sent",packet.id);this._queue.shift();if(ack){ack(null,...responseArgs)}}packet.pending=false;return this._drainQueue()});this._queue.push(packet);this._drainQueue()}_drainQueue(force=false){debug("draining queue");if(!this.connected||this._queue.length===0){return}const packet=this._queue[0];if(packet.pending&&!force){debug("packet [%d] has already been sent and is waiting for an ack",packet.id);return}packet.pending=true;packet.tryCount++;debug("sending packet [%d] (try n%d)",packet.id,packet.tryCount);this.flags=packet.flags;this.emit.apply(this,packet.args)}packet(packet){packet.nsp=this.nsp;this.io._packet(packet)}onopen(){debug("transport is open - connecting");if(typeof this.auth=="function"){this.auth(data=>{this._sendConnectPacket(data)})}else{this._sendConnectPacket(this.auth)}}_sendConnectPacket(data){this.packet({type:socket_io_parser_1.PacketType.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},data):data})}onerror(err){if(!this.connected){this.emitReserved("connect_error",err)}}onclose(reason,description){debug("close (%s)",reason);this.connected=false;delete this.id;this.emitReserved("disconnect",reason,description);this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(id=>{const isBuffered=this.sendBuffer.some(packet=>String(packet.id)===id);if(!isBuffered){const ack=this.acks[id];delete this.acks[id];if(ack.withError){ack.call(this,new Error("socket has been disconnected"))}}})}onpacket(packet){const sameNamespace=packet.nsp===this.nsp;if(!sameNamespace)return;switch(packet.type){case socket_io_parser_1.PacketType.CONNECT:if(packet.data&&packet.data.sid){this.onconnect(packet.data.sid,packet.data.pid)}else{this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"))}break;case socket_io_parser_1.PacketType.EVENT:case socket_io_parser_1.PacketType.BINARY_EVENT:this.onevent(packet);break;case socket_io_parser_1.PacketType.ACK:case socket_io_parser_1.PacketType.BINARY_ACK:this.onack(packet);break;case socket_io_parser_1.PacketType.DISCONNECT:this.ondisconnect();break;case socket_io_parser_1.PacketType.CONNECT_ERROR:this.destroy();const err=new Error(packet.data.message);err.data=packet.data.data;this.emitReserved("connect_error",err);break}}onevent(packet){const args=packet.data||[];debug("emitting event %j",args);if(null!=packet.id){debug("attaching ack callback to event");args.push(this.ack(packet.id))}if(this.connected){this.emitEvent(args)}else{this.receiveBuffer.push(Object.freeze(args))}}emitEvent(args){if(this._anyListeners&&this._anyListeners.length){const listeners=this._anyListeners.slice();for(const listener of listeners){listener.apply(this,args)}}super.emit.apply(this,args);if(this._pid&&args.length&&typeof args[args.length-1]==="string"){this._lastOffset=args[args.length-1]}}ack(id){const self=this;let sent=false;return function(...args){if(sent)return;sent=true;debug("sending ack %j",args);self.packet({type:socket_io_parser_1.PacketType.ACK,id:id,data:args})}}onack(packet){const ack=this.acks[packet.id];if(typeof ack!=="function"){debug("bad ack %s",packet.id);return}delete this.acks[packet.id];debug("calling ack %s with %j",packet.id,packet.data);if(ack.withError){packet.data.unshift(null)}ack.apply(this,packet.data)}onconnect(id,pid){debug("socket connected with id %s",id);this.id=id;this.recovered=pid&&this._pid===pid;this._pid=pid;this.connected=true;this.emitBuffered();this.emitReserved("connect");this._drainQueue(true)}emitBuffered(){this.receiveBuffer.forEach(args=>this.emitEvent(args));this.receiveBuffer=[];this.sendBuffer.forEach(packet=>{this.notifyOutgoingListeners(packet);this.packet(packet)});this.sendBuffer=[]}ondisconnect(){debug("server disconnect (%s)",this.nsp);this.destroy();this.onclose("io server disconnect")}destroy(){if(this.subs){this.subs.forEach(subDestroy=>subDestroy());this.subs=undefined}this.io["_destroy"](this)}disconnect(){if(this.connected){debug("performing disconnect (%s)",this.nsp);this.packet({type:socket_io_parser_1.PacketType.DISCONNECT})}this.destroy();if(this.connected){this.onclose("io client disconnect")}return this}close(){return this.disconnect()}compress(compress){this.flags.compress=compress;return this}get volatile(){this.flags.volatile=true;return this}timeout(timeout){this.flags.timeout=timeout;return this}onAny(listener){this._anyListeners=this._anyListeners||[];this._anyListeners.push(listener);return this}prependAny(listener){this._anyListeners=this._anyListeners||[];this._anyListeners.unshift(listener);return this}offAny(listener){if(!this._anyListeners){return this}if(listener){const listeners=this._anyListeners;for(let i=0;i<listeners.length;i++){if(listener===listeners[i]){listeners.splice(i,1);return this}}}else{this._anyListeners=[]}return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(listener){this._anyOutgoingListeners=this._anyOutgoingListeners||[];this._anyOutgoingListeners.push(listener);return this}prependAnyOutgoing(listener){this._anyOutgoingListeners=this._anyOutgoingListeners||[];this._anyOutgoingListeners.unshift(listener);return this}offAnyOutgoing(listener){if(!this._anyOutgoingListeners){return this}if(listener){const listeners=this._anyOutgoingListeners;for(let i=0;i<listeners.length;i++){if(listener===listeners[i]){listeners.splice(i,1);return this}}}else{this._anyOutgoingListeners=[]}return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(packet){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const listeners=this._anyOutgoingListeners.slice();for(const listener of listeners){listener.apply(this,packet.data)}}}}exports.Socket=Socket},{"./on.js":269,"@socket.io/component-emitter":75,debug:274,"socket.io-parser":277}],271:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.url=url;const engine_io_client_1=require("engine.io-client");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("socket.io-client:url");function url(uri,path="",loc){let obj=uri;loc=loc||typeof location!=="undefined"&&location;if(null==uri)uri=loc.protocol+"//"+loc.host;if(typeof uri==="string"){if("/"===uri.charAt(0)){if("/"===uri.charAt(1)){uri=loc.protocol+uri}else{uri=loc.host+uri}}if(!/^(https?|wss?):\/\//.test(uri)){debug("protocol-less url %s",uri);if("undefined"!==typeof loc){uri=loc.protocol+"//"+uri}else{uri="https://"+uri}}debug("parse %s",uri);obj=(0,engine_io_client_1.parse)(uri)}if(!obj.port){if(/^(http|ws)$/.test(obj.protocol)){obj.port="80"}else if(/^(http|ws)s$/.test(obj.protocol)){obj.port="443"}}obj.path=obj.path||"/";const ipv6=obj.host.indexOf(":")!==-1;const host=ipv6?"["+obj.host+"]":obj.host;obj.id=obj.protocol+"://"+host+":"+obj.port+path;obj.href=obj.protocol+"://"+host+(loc&&loc.port===obj.port?"":":"+obj.port);return obj}},{debug:274,"engine.io-client":93}],272:[function(require,module,exports){arguments[4][105][0].apply(exports,arguments)},{"./common":273,dup:105}],273:[function(require,module,exports){arguments[4][106][0].apply(exports,arguments)},{dup:106,ms:202}],274:[function(require,module,exports){arguments[4][107][0].apply(exports,arguments)},{"./browser.js":272,"./node.js":275,dup:107}],275:[function(require,module,exports){arguments[4][108][0].apply(exports,arguments)},{"./common":273,dup:108,"supports-color":297,tty:undefined,util:undefined}],276:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.reconstructPacket=exports.deconstructPacket=void 0;const is_binary_js_1=require("./is-binary.js");function deconstructPacket(packet){const buffers=[];const packetData=packet.data;const pack=packet;pack.data=_deconstructPacket(packetData,buffers);pack.attachments=buffers.length;return{packet:pack,buffers:buffers}}exports.deconstructPacket=deconstructPacket;function _deconstructPacket(data,buffers){if(!data)return data;if((0,is_binary_js_1.isBinary)(data)){const placeholder={_placeholder:true,num:buffers.length};buffers.push(data);return placeholder}else if(Array.isArray(data)){const newData=new Array(data.length);for(let i=0;i<data.length;i++){newData[i]=_deconstructPacket(data[i],buffers)}return newData}else if(typeof data==="object"&&!(data instanceof Date)){const newData={};for(const key in data){if(Object.prototype.hasOwnProperty.call(data,key)){newData[key]=_deconstructPacket(data[key],buffers)}}return newData}return data}function reconstructPacket(packet,buffers){packet.data=_reconstructPacket(packet.data,buffers);delete packet.attachments;return packet}exports.reconstructPacket=reconstructPacket;function _reconstructPacket(data,buffers){if(!data)return data;if(data&&data._placeholder===true){const isIndexValid=typeof data.num==="number"&&data.num>=0&&data.num<buffers.length;if(isIndexValid){return buffers[data.num]}else{throw new Error("illegal attachments")}}else if(Array.isArray(data)){for(let i=0;i<data.length;i++){data[i]=_reconstructPacket(data[i],buffers)}}else if(typeof data==="object"){for(const key in data){if(Object.prototype.hasOwnProperty.call(data,key)){data[key]=_reconstructPacket(data[key],buffers)}}}return data}},{"./is-binary.js":278}],277:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Decoder=exports.Encoder=exports.PacketType=exports.protocol=void 0;const component_emitter_1=require("@socket.io/component-emitter");const binary_js_1=require("./binary.js");const is_binary_js_1=require("./is-binary.js");const debug_1=require("debug");const debug=(0,debug_1.default)("socket.io-parser");const RESERVED_EVENTS=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];exports.protocol=5;var PacketType;(function(PacketType){PacketType[PacketType["CONNECT"]=0]="CONNECT";PacketType[PacketType["DISCONNECT"]=1]="DISCONNECT";PacketType[PacketType["EVENT"]=2]="EVENT";PacketType[PacketType["ACK"]=3]="ACK";PacketType[PacketType["CONNECT_ERROR"]=4]="CONNECT_ERROR";PacketType[PacketType["BINARY_EVENT"]=5]="BINARY_EVENT";PacketType[PacketType["BINARY_ACK"]=6]="BINARY_ACK"})(PacketType=exports.PacketType||(exports.PacketType={}));class Encoder{constructor(replacer){this.replacer=replacer}encode(obj){debug("encoding packet %j",obj);if(obj.type===PacketType.EVENT||obj.type===PacketType.ACK){if((0,is_binary_js_1.hasBinary)(obj)){return this.encodeAsBinary({type:obj.type===PacketType.EVENT?PacketType.BINARY_EVENT:PacketType.BINARY_ACK,nsp:obj.nsp,data:obj.data,id:obj.id})}}return[this.encodeAsString(obj)]}encodeAsString(obj){let str=""+obj.type;if(obj.type===PacketType.BINARY_EVENT||obj.type===PacketType.BINARY_ACK){str+=obj.attachments+"-"}if(obj.nsp&&"/"!==obj.nsp){str+=obj.nsp+","}if(null!=obj.id){str+=obj.id}if(null!=obj.data){str+=JSON.stringify(obj.data,this.replacer)}debug("encoded %j as %s",obj,str);return str}encodeAsBinary(obj){const deconstruction=(0,binary_js_1.deconstructPacket)(obj);const pack=this.encodeAsString(deconstruction.packet);const buffers=deconstruction.buffers;buffers.unshift(pack);return buffers}}exports.Encoder=Encoder;function isObject(value){return Object.prototype.toString.call(value)==="[object Object]"}class Decoder extends component_emitter_1.Emitter{constructor(reviver){super();this.reviver=reviver}add(obj){let packet;if(typeof obj==="string"){if(this.reconstructor){throw new Error("got plaintext data when reconstructing a packet")}packet=this.decodeString(obj);const isBinaryEvent=packet.type===PacketType.BINARY_EVENT;if(isBinaryEvent||packet.type===PacketType.BINARY_ACK){packet.type=isBinaryEvent?PacketType.EVENT:PacketType.ACK;this.reconstructor=new BinaryReconstructor(packet);if(packet.attachments===0){super.emitReserved("decoded",packet)}}else{super.emitReserved("decoded",packet)}}else if((0,is_binary_js_1.isBinary)(obj)||obj.base64){if(!this.reconstructor){throw new Error("got binary data when not reconstructing a packet")}else{packet=this.reconstructor.takeBinaryData(obj);if(packet){this.reconstructor=null;super.emitReserved("decoded",packet)}}}else{throw new Error("Unknown type: "+obj)}}decodeString(str){let i=0;const p={type:Number(str.charAt(0))};if(PacketType[p.type]===undefined){throw new Error("unknown packet type "+p.type)}if(p.type===PacketType.BINARY_EVENT||p.type===PacketType.BINARY_ACK){const start=i+1;while(str.charAt(++i)!=="-"&&i!=str.length){}const buf=str.substring(start,i);if(buf!=Number(buf)||str.charAt(i)!=="-"){throw new Error("Illegal attachments")}p.attachments=Number(buf)}if("/"===str.charAt(i+1)){const start=i+1;while(++i){const c=str.charAt(i);if(","===c)break;if(i===str.length)break}p.nsp=str.substring(start,i)}else{p.nsp="/"}const next=str.charAt(i+1);if(""!==next&&Number(next)==next){const start=i+1;while(++i){const c=str.charAt(i);if(null==c||Number(c)!=c){--i;break}if(i===str.length)break}p.id=Number(str.substring(start,i+1))}if(str.charAt(++i)){const payload=this.tryParse(str.substr(i));if(Decoder.isPayloadValid(p.type,payload)){p.data=payload}else{throw new Error("invalid payload")}}debug("decoded %s as %j",str,p);return p}tryParse(str){try{return JSON.parse(str,this.reviver)}catch(e){return false}}static isPayloadValid(type,payload){switch(type){case PacketType.CONNECT:return isObject(payload);case PacketType.DISCONNECT:return payload===undefined;case PacketType.CONNECT_ERROR:return typeof payload==="string"||isObject(payload);case PacketType.EVENT:case PacketType.BINARY_EVENT:return Array.isArray(payload)&&(typeof payload[0]==="number"||typeof payload[0]==="string"&&RESERVED_EVENTS.indexOf(payload[0])===-1);case PacketType.ACK:case PacketType.BINARY_ACK:return Array.isArray(payload)}}destroy(){if(this.reconstructor){this.reconstructor.finishedReconstruction();this.reconstructor=null}}}exports.Decoder=Decoder;class BinaryReconstructor{constructor(packet){this.packet=packet;this.buffers=[];this.reconPack=packet}takeBinaryData(binData){this.buffers.push(binData);if(this.buffers.length===this.reconPack.attachments){const packet=(0,binary_js_1.reconstructPacket)(this.reconPack,this.buffers);this.finishedReconstruction();return packet}return null}finishedReconstruction(){this.reconPack=null;this.buffers=[]}}},{"./binary.js":276,"./is-binary.js":278,"@socket.io/component-emitter":75,debug:281}],278:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.hasBinary=exports.isBinary=void 0;const withNativeArrayBuffer=typeof ArrayBuffer==="function";const isView=obj=>typeof ArrayBuffer.isView==="function"?ArrayBuffer.isView(obj):obj.buffer instanceof ArrayBuffer;const toString=Object.prototype.toString;const withNativeBlob=typeof Blob==="function"||typeof Blob!=="undefined"&&toString.call(Blob)==="[object BlobConstructor]";const withNativeFile=typeof File==="function"||typeof File!=="undefined"&&toString.call(File)==="[object FileConstructor]";function isBinary(obj){return withNativeArrayBuffer&&(obj instanceof ArrayBuffer||isView(obj))||withNativeBlob&&obj instanceof Blob||withNativeFile&&obj instanceof File}exports.isBinary=isBinary;function hasBinary(obj,toJSON){if(!obj||typeof obj!=="object"){return false}if(Array.isArray(obj)){for(let i=0,l=obj.length;i<l;i++){if(hasBinary(obj[i])){return true}}return false}if(isBinary(obj)){return true}if(obj.toJSON&&typeof obj.toJSON==="function"&&arguments.length===1){return hasBinary(obj.toJSON(),true)}for(const key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)&&hasBinary(obj[key])){return true}}return false}exports.hasBinary=hasBinary},{}],279:[function(require,module,exports){arguments[4][105][0].apply(exports,arguments)},{"./common":280,dup:105}],280:[function(require,module,exports){arguments[4][106][0].apply(exports,arguments)},{dup:106,ms:202}],281:[function(require,module,exports){arguments[4][107][0].apply(exports,arguments)},{"./browser.js":279,"./node.js":282,dup:107}],282:[function(require,module,exports){arguments[4][108][0].apply(exports,arguments)},{"./common":280,dup:108,"supports-color":297,tty:undefined,util:undefined}],283:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.RemoteSocket=exports.BroadcastOperator=void 0;const socket_types_1=require("./socket-types");const socket_io_parser_1=require("socket.io-parser");class BroadcastOperator{constructor(adapter,rooms=new Set,exceptRooms=new Set,flags={}){this.adapter=adapter;this.rooms=rooms;this.exceptRooms=exceptRooms;this.flags=flags}to(room){const rooms=new Set(this.rooms);if(Array.isArray(room)){room.forEach(r=>rooms.add(r))}else{rooms.add(room)}return new BroadcastOperator(this.adapter,rooms,this.exceptRooms,this.flags)}in(room){return this.to(room)}except(room){const exceptRooms=new Set(this.exceptRooms);if(Array.isArray(room)){room.forEach(r=>exceptRooms.add(r))}else{exceptRooms.add(room)}return new BroadcastOperator(this.adapter,this.rooms,exceptRooms,this.flags)}compress(compress){const flags=Object.assign({},this.flags,{compress:compress});return new BroadcastOperator(this.adapter,this.rooms,this.exceptRooms,flags)}get volatile(){const flags=Object.assign({},this.flags,{volatile:true});return new BroadcastOperator(this.adapter,this.rooms,this.exceptRooms,flags)}get local(){const flags=Object.assign({},this.flags,{local:true});return new BroadcastOperator(this.adapter,this.rooms,this.exceptRooms,flags)}timeout(timeout){const flags=Object.assign({},this.flags,{timeout:timeout});return new BroadcastOperator(this.adapter,this.rooms,this.exceptRooms,flags)}emit(ev,...args){if(socket_types_1.RESERVED_EVENTS.has(ev)){throw new Error(`"${String(ev)}" is a reserved event name`)}const data=[ev,...args];const packet={type:socket_io_parser_1.PacketType.EVENT,data:data};const withAck=typeof data[data.length-1]==="function";if(!withAck){this.adapter.broadcast(packet,{rooms:this.rooms,except:this.exceptRooms,flags:this.flags});return true}const ack=data.pop();let timedOut=false;let responses=[];const timer=setTimeout(()=>{timedOut=true;ack.apply(this,[new Error("operation has timed out"),this.flags.expectSingleResponse?null:responses])},this.flags.timeout);let expectedServerCount=-1;let actualServerCount=0;let expectedClientCount=0;const checkCompleteness=()=>{if(!timedOut&&expectedServerCount===actualServerCount&&responses.length===expectedClientCount){clearTimeout(timer);ack.apply(this,[null,this.flags.expectSingleResponse?responses[0]:responses])}};this.adapter.broadcastWithAck(packet,{rooms:this.rooms,except:this.exceptRooms,flags:this.flags},clientCount=>{expectedClientCount+=clientCount;actualServerCount++;checkCompleteness()},clientResponse=>{responses.push(clientResponse);checkCompleteness()});this.adapter.serverCount().then(serverCount=>{expectedServerCount=serverCount;checkCompleteness()});return true}emitWithAck(ev,...args){return new Promise((resolve,reject)=>{args.push((err,responses)=>{if(err){err.responses=responses;return reject(err)}else{return resolve(responses)}});this.emit(ev,...args)})}allSockets(){if(!this.adapter){throw new Error("No adapter for this namespace, are you trying to get the list of clients of a dynamic namespace?")}return this.adapter.sockets(this.rooms)}fetchSockets(){return this.adapter.fetchSockets({rooms:this.rooms,except:this.exceptRooms,flags:this.flags}).then(sockets=>sockets.map(socket=>{if(socket.server){return socket}else{return new RemoteSocket(this.adapter,socket)}}))}socketsJoin(room){this.adapter.addSockets({rooms:this.rooms,except:this.exceptRooms,flags:this.flags},Array.isArray(room)?room:[room])}socketsLeave(room){this.adapter.delSockets({rooms:this.rooms,except:this.exceptRooms,flags:this.flags},Array.isArray(room)?room:[room])}disconnectSockets(close=false){this.adapter.disconnectSockets({rooms:this.rooms,except:this.exceptRooms,flags:this.flags},close)}}exports.BroadcastOperator=BroadcastOperator;class RemoteSocket{constructor(adapter,details){this.id=details.id;this.handshake=details.handshake;this.rooms=new Set(details.rooms);this.data=details.data;this.operator=new BroadcastOperator(adapter,new Set([this.id]),new Set,{expectSingleResponse:true})}timeout(timeout){return this.operator.timeout(timeout)}emit(ev,...args){return this.operator.emit(ev,...args)}join(room){return this.operator.socketsJoin(room)}leave(room){return this.operator.socketsLeave(room)}disconnect(close=false){this.operator.disconnectSockets(close);return this}}exports.RemoteSocket=RemoteSocket},{"./socket-types":288,"socket.io-parser":277}],284:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Client=void 0;const socket_io_parser_1=require("socket.io-parser");const debugModule=require("debug");const url=require("url");const debug=debugModule("socket.io:client");class Client{constructor(server,conn){this.sockets=new Map;this.nsps=new Map;this.server=server;this.conn=conn;this.encoder=server.encoder;this.decoder=new server._parser.Decoder;this.id=conn.id;this.setup()}get request(){return this.conn.request}setup(){this.onclose=this.onclose.bind(this);this.ondata=this.ondata.bind(this);this.onerror=this.onerror.bind(this);this.ondecoded=this.ondecoded.bind(this);this.decoder.on("decoded",this.ondecoded);this.conn.on("data",this.ondata);this.conn.on("error",this.onerror);this.conn.on("close",this.onclose);this.connectTimeout=setTimeout(()=>{if(this.nsps.size===0){debug("no namespace joined yet, close the client");this.close()}else{debug("the client has already joined a namespace, nothing to do")}},this.server._connectTimeout)}connect(name,auth={}){if(this.server._nsps.has(name)){debug("connecting to namespace %s",name);return this.doConnect(name,auth)}this.server._checkNamespace(name,auth,dynamicNspName=>{if(dynamicNspName){this.doConnect(name,auth)}else{debug("creation of namespace %s was denied",name);this._packet({type:socket_io_parser_1.PacketType.CONNECT_ERROR,nsp:name,data:{message:"Invalid namespace"}})}})}doConnect(name,auth){const nsp=this.server.of(name);nsp._add(this,auth,socket=>{this.sockets.set(socket.id,socket);this.nsps.set(nsp.name,socket);if(this.connectTimeout){clearTimeout(this.connectTimeout);this.connectTimeout=undefined}})}_disconnect(){for(const socket of this.sockets.values()){socket.disconnect()}this.sockets.clear();this.close()}_remove(socket){if(this.sockets.has(socket.id)){const nsp=this.sockets.get(socket.id).nsp.name;this.sockets.delete(socket.id);this.nsps.delete(nsp)}else{debug("ignoring remove for %s",socket.id)}}close(){if("open"===this.conn.readyState){debug("forcing transport close");this.conn.close();this.onclose("forced server close")}}_packet(packet,opts={}){if(this.conn.readyState!=="open"){debug("ignoring packet write %j",packet);return}const encodedPackets=opts.preEncoded?packet:this.encoder.encode(packet);this.writeToEngine(encodedPackets,opts)}writeToEngine(encodedPackets,opts){if(opts.volatile&&!this.conn.transport.writable){debug("volatile packet is discarded since the transport is not currently writable");return}const packets=Array.isArray(encodedPackets)?encodedPackets:[encodedPackets];for(const encodedPacket of packets){this.conn.write(encodedPacket,opts)}}ondata(data){try{this.decoder.add(data)}catch(e){debug("invalid packet format");this.onerror(e)}}ondecoded(packet){let namespace;let authPayload;if(this.conn.protocol===3){const parsed=url.parse(packet.nsp,true);namespace=parsed.pathname;authPayload=parsed.query}else{namespace=packet.nsp;authPayload=packet.data}const socket=this.nsps.get(namespace);if(!socket&&packet.type===socket_io_parser_1.PacketType.CONNECT){this.connect(namespace,authPayload)}else if(socket&&packet.type!==socket_io_parser_1.PacketType.CONNECT&&packet.type!==socket_io_parser_1.PacketType.CONNECT_ERROR){process.nextTick(function(){socket._onpacket(packet)})}else{debug("invalid state (packet type: %s)",packet.type);this.close()}}onerror(err){for(const socket of this.sockets.values()){socket._onerror(err)}this.conn.close()}onclose(reason,description){debug("client close with reason %s",reason);this.destroy();for(const socket of this.sockets.values()){socket._onclose(reason,description)}this.sockets.clear();this.decoder.destroy()}destroy(){this.conn.removeListener("data",this.ondata);this.conn.removeListener("error",this.onerror);this.conn.removeListener("close",this.onclose);this.decoder.removeListener("decoded",this.ondecoded);if(this.connectTimeout){clearTimeout(this.connectTimeout);this.connectTimeout=undefined}}}exports.Client=Client},{debug:294,"socket.io-parser":277,url:undefined}],285:[function(require,module,exports){(function(__dirname){(function(){"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||("get"in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k]}}}Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k]});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:true,value:v})}:function(o,v){o["default"]=v});var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(k!=="default"&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);__setModuleDefault(result,mod);return result};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.Namespace=exports.Socket=exports.Server=void 0;const http=require("http");const fs_1=require("fs");const zlib_1=require("zlib");const accepts=require("accepts");const stream_1=require("stream");const path=require("path");const engine_io_1=require("engine.io");const client_1=require("./client");const events_1=require("events");const namespace_1=require("./namespace");Object.defineProperty(exports,"Namespace",{enumerable:true,get:function(){return namespace_1.Namespace}});const parent_namespace_1=require("./parent-namespace");const socket_io_adapter_1=require("socket.io-adapter");const parser=__importStar(require("socket.io-parser"));const debug_1=__importDefault(require("debug"));const socket_1=require("./socket");Object.defineProperty(exports,"Socket",{enumerable:true,get:function(){return socket_1.Socket}});const typed_events_1=require("./typed-events");const uws_1=require("./uws");const cors_1=__importDefault(require("cors"));const debug=(0,debug_1.default)("socket.io:server");const clientVersion=require("../package.json").version;const dotMapRegex=/\.map/;class Server extends typed_events_1.StrictEventEmitter{constructor(srv,opts={}){super();this._nsps=new Map;this.parentNsps=new Map;this.parentNamespacesFromRegExp=new Map;if("object"===typeof srv&&srv instanceof Object&&!srv.listen){opts=srv;srv=undefined}this.path(opts.path||"/socket.io");this.connectTimeout(opts.connectTimeout||45e3);this.serveClient(false!==opts.serveClient);this._parser=opts.parser||parser;this.encoder=new this._parser.Encoder;this.opts=opts;if(opts.connectionStateRecovery){opts.connectionStateRecovery=Object.assign({maxDisconnectionDuration:2*60*1e3,skipMiddlewares:true},opts.connectionStateRecovery);this.adapter(opts.adapter||socket_io_adapter_1.SessionAwareAdapter)}else{this.adapter(opts.adapter||socket_io_adapter_1.Adapter)}opts.cleanupEmptyChildNamespaces=!!opts.cleanupEmptyChildNamespaces;this.sockets=this.of("/");if(srv||typeof srv=="number")this.attach(srv);if(this.opts.cors){this._corsMiddleware=(0,cors_1.default)(this.opts.cors)}}get _opts(){return this.opts}serveClient(v){if(!arguments.length)return this._serveClient;this._serveClient=v;return this}_checkNamespace(name,auth,fn){if(this.parentNsps.size===0)return fn(false);const keysIterator=this.parentNsps.keys();const run=()=>{const nextFn=keysIterator.next();if(nextFn.done){return fn(false)}nextFn.value(name,auth,(err,allow)=>{if(err||!allow){return run()}if(this._nsps.has(name)){debug("dynamic namespace %s already exists",name);return fn(this._nsps.get(name))}const namespace=this.parentNsps.get(nextFn.value).createChild(name);debug("dynamic namespace %s was created",name);fn(namespace)})};run()}path(v){if(!arguments.length)return this._path;this._path=v.replace(/\/$/,"");const escapedPath=this._path.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");this.clientPathRegex=new RegExp("^"+escapedPath+"/socket\\.io(\\.msgpack|\\.esm)?(\\.min)?\\.js(\\.map)?(?:\\?|$)");return this}connectTimeout(v){if(v===undefined)return this._connectTimeout;this._connectTimeout=v;return this}adapter(v){if(!arguments.length)return this._adapter;this._adapter=v;for(const nsp of this._nsps.values()){nsp._initAdapter()}return this}listen(srv,opts={}){return this.attach(srv,opts)}attach(srv,opts={}){if("function"==typeof srv){const msg="You are trying to attach socket.io to an express "+"request handler function. Please pass a http.Server instance.";throw new Error(msg)}if(Number(srv)==srv){srv=Number(srv)}if("number"==typeof srv){debug("creating http server and binding to %d",srv);const port=srv;srv=http.createServer((req,res)=>{res.writeHead(404);res.end()});srv.listen(port)}Object.assign(opts,this.opts);opts.path=opts.path||this._path;this.initEngine(srv,opts);return this}attachApp(app,opts={}){Object.assign(opts,this.opts);opts.path=opts.path||this._path;debug("creating uWebSockets.js-based engine with opts %j",opts);const engine=new engine_io_1.uServer(opts);engine.attach(app,opts);this.bind(engine);if(this._serveClient){app.get(`${this._path}/*`,(res,req)=>{if(!this.clientPathRegex.test(req.getUrl())){req.setYield(true);return}const filename=req.getUrl().replace(this._path,"").replace(/\?.*$/,"").replace(/^\//,"");const isMap=dotMapRegex.test(filename);const type=isMap?"map":"source";const expectedEtag='"'+clientVersion+'"';const weakEtag="W/"+expectedEtag;const etag=req.getHeader("if-none-match");if(etag){if(expectedEtag===etag||weakEtag===etag){debug("serve client %s 304",type);res.writeStatus("304 Not Modified");res.end();return}}debug("serve client %s",type);res.writeHeader("cache-control","public, max-age=0");res.writeHeader("content-type","application/"+(isMap?"json":"javascript")+"; charset=utf-8");res.writeHeader("etag",expectedEtag);const filepath=path.join(__dirname,"../client-dist/",filename);(0,uws_1.serveFile)(res,filepath)})}(0,uws_1.patchAdapter)(app)}initEngine(srv,opts){debug("creating engine.io instance with opts %j",opts);this.eio=(0,engine_io_1.attach)(srv,opts);if(this._serveClient)this.attachServe(srv);this.httpServer=srv;this.bind(this.eio)}attachServe(srv){debug("attaching client serving req handler");const evs=srv.listeners("request").slice(0);srv.removeAllListeners("request");srv.on("request",(req,res)=>{if(this.clientPathRegex.test(req.url)){if(this._corsMiddleware){this._corsMiddleware(req,res,()=>{this.serve(req,res)})}else{this.serve(req,res)}}else{for(let i=0;i<evs.length;i++){evs[i].call(srv,req,res)}}})}serve(req,res){const filename=req.url.replace(this._path,"").replace(/\?.*$/,"");const isMap=dotMapRegex.test(filename);const type=isMap?"map":"source";const expectedEtag='"'+clientVersion+'"';const weakEtag="W/"+expectedEtag;const etag=req.headers["if-none-match"];if(etag){if(expectedEtag===etag||weakEtag===etag){debug("serve client %s 304",type);res.writeHead(304);res.end();return}}debug("serve client %s",type);res.setHeader("Cache-Control","public, max-age=0");res.setHeader("Content-Type","application/"+(isMap?"json":"javascript")+"; charset=utf-8");res.setHeader("ETag",expectedEtag);Server.sendFile(filename,req,res)}static sendFile(filename,req,res){const readStream=(0,fs_1.createReadStream)(path.join(__dirname,"../client-dist/",filename));const encoding=accepts(req).encodings(["br","gzip","deflate"]);const onError=err=>{if(err){res.end()}};switch(encoding){case"br":res.writeHead(200,{"content-encoding":"br"});(0,stream_1.pipeline)(readStream,(0,zlib_1.createBrotliCompress)(),res,onError);break;case"gzip":res.writeHead(200,{"content-encoding":"gzip"});(0,stream_1.pipeline)(readStream,(0,zlib_1.createGzip)(),res,onError);break;case"deflate":res.writeHead(200,{"content-encoding":"deflate"});(0,stream_1.pipeline)(readStream,(0,zlib_1.createDeflate)(),res,onError);break;default:res.writeHead(200);(0,stream_1.pipeline)(readStream,res,onError)}}bind(engine){this.engine=engine;this.engine.on("connection",this.onconnection.bind(this));return this}onconnection(conn){debug("incoming connection with id %s",conn.id);const client=new client_1.Client(this,conn);if(conn.protocol===3){client.connect("/")}return this}of(name,fn){if(typeof name==="function"||name instanceof RegExp){const parentNsp=new parent_namespace_1.ParentNamespace(this);debug("initializing parent namespace %s",parentNsp.name);if(typeof name==="function"){this.parentNsps.set(name,parentNsp)}else{this.parentNsps.set((nsp,conn,next)=>next(null,name.test(nsp)),parentNsp);this.parentNamespacesFromRegExp.set(name,parentNsp)}if(fn){parentNsp.on("connect",fn)}return parentNsp}if(String(name)[0]!=="/")name="/"+name;let nsp=this._nsps.get(name);if(!nsp){for(const[regex,parentNamespace]of this.parentNamespacesFromRegExp){if(regex.test(name)){debug("attaching namespace %s to parent namespace %s",name,regex);return parentNamespace.createChild(name)}}debug("initializing namespace %s",name);nsp=new namespace_1.Namespace(this,name);this._nsps.set(name,nsp);if(name!=="/"){this.sockets.emitReserved("new_namespace",nsp)}}if(fn)nsp.on("connect",fn);return nsp}async close(fn){await Promise.allSettled([...this._nsps.values()].map(async nsp=>{nsp.sockets.forEach(socket=>{socket._onclose("server shutting down")});await nsp.adapter.close()}));this.engine.close();(0,uws_1.restoreAdapter)();if(this.httpServer){this.httpServer.close(fn)}else{fn&&fn()}}use(fn){this.sockets.use(fn);return this}to(room){return this.sockets.to(room)}in(room){return this.sockets.in(room)}except(room){return this.sockets.except(room)}send(...args){this.sockets.emit("message",...args);return this}write(...args){this.sockets.emit("message",...args);return this}serverSideEmit(ev,...args){return this.sockets.serverSideEmit(ev,...args)}serverSideEmitWithAck(ev,...args){return this.sockets.serverSideEmitWithAck(ev,...args)}allSockets(){return this.sockets.allSockets()}compress(compress){return this.sockets.compress(compress)}get volatile(){return this.sockets.volatile}get local(){return this.sockets.local}timeout(timeout){return this.sockets.timeout(timeout)}fetchSockets(){return this.sockets.fetchSockets()}socketsJoin(room){return this.sockets.socketsJoin(room)}socketsLeave(room){return this.sockets.socketsLeave(room)}disconnectSockets(close=false){return this.sockets.disconnectSockets(close)}}exports.Server=Server;const emitterMethods=Object.keys(events_1.EventEmitter.prototype).filter(function(key){return typeof events_1.EventEmitter.prototype[key]==="function"});emitterMethods.forEach(function(fn){Server.prototype[fn]=function(){return this.sockets[fn].apply(this.sockets,arguments)}});module.exports=(srv,opts)=>new Server(srv,opts);module.exports.Server=Server;module.exports.Namespace=namespace_1.Namespace;module.exports.Socket=socket_1.Socket}).call(this)}).call(this,require("path").join(__dirname,"node_modules","socket.io","dist"))},{"../package.json":296,"./client":284,"./namespace":286,"./parent-namespace":287,"./socket":289,"./typed-events":290,"./uws":291,accepts:76,cors:85,debug:294,"engine.io":113,events:undefined,fs:undefined,http:undefined,path:undefined,"socket.io-adapter":261,"socket.io-parser":277,stream:undefined,zlib:undefined}],286:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.Namespace=exports.RESERVED_EVENTS=void 0;const socket_1=require("./socket");const typed_events_1=require("./typed-events");const debug_1=__importDefault(require("debug"));const broadcast_operator_1=require("./broadcast-operator");const debug=(0,debug_1.default)("socket.io:namespace");exports.RESERVED_EVENTS=new Set(["connect","connection","new_namespace"]);class Namespace extends typed_events_1.StrictEventEmitter{constructor(server,name){super();this.sockets=new Map;this._preConnectSockets=new Map;this._fns=[];this._ids=0;this.server=server;this.name=name;this._initAdapter()}_initAdapter(){this.adapter=new(this.server.adapter())(this)}use(fn){this._fns.push(fn);return this}run(socket,fn){if(!this._fns.length)return fn();const fns=this._fns.slice(0);function run(i){fns[i](socket,err=>{if(err)return fn(err);if(!fns[i+1])return fn();run(i+1)})}run(0)}to(room){return new broadcast_operator_1.BroadcastOperator(this.adapter).to(room)}in(room){return new broadcast_operator_1.BroadcastOperator(this.adapter).in(room)}except(room){return new broadcast_operator_1.BroadcastOperator(this.adapter).except(room)}async _add(client,auth,fn){var _a;debug("adding socket to nsp %s",this.name);const socket=await this._createSocket(client,auth);this._preConnectSockets.set(socket.id,socket);if(((_a=this.server.opts.connectionStateRecovery)===null||_a===void 0?void 0:_a.skipMiddlewares)&&socket.recovered&&client.conn.readyState==="open"){return this._doConnect(socket,fn)}this.run(socket,err=>{process.nextTick(()=>{if("open"!==client.conn.readyState){debug("next called after client was closed - ignoring socket");socket._cleanup();return}if(err){debug("middleware error, sending CONNECT_ERROR packet to the client");socket._cleanup();if(client.conn.protocol===3){return socket._error(err.data||err.message)}else{return socket._error({message:err.message,data:err.data})}}this._doConnect(socket,fn)})})}async _createSocket(client,auth){const sessionId=auth.pid;const offset=auth.offset;if(this.server.opts.connectionStateRecovery&&typeof sessionId==="string"&&typeof offset==="string"){let session;try{session=await this.adapter.restoreSession(sessionId,offset)}catch(e){debug("error while restoring session: %s",e)}if(session){debug("connection state recovered for sid %s",session.sid);return new socket_1.Socket(this,client,auth,session)}}return new socket_1.Socket(this,client,auth)}_doConnect(socket,fn){this._preConnectSockets.delete(socket.id);this.sockets.set(socket.id,socket);socket._onconnect();if(fn)fn(socket);this.emitReserved("connect",socket);this.emitReserved("connection",socket)}_remove(socket){this.sockets.delete(socket.id)||this._preConnectSockets.delete(socket.id)}emit(ev,...args){return new broadcast_operator_1.BroadcastOperator(this.adapter).emit(ev,...args)}send(...args){this.emit("message",...args);return this}write(...args){this.emit("message",...args);return this}serverSideEmit(ev,...args){if(exports.RESERVED_EVENTS.has(ev)){throw new Error(`"${String(ev)}" is a reserved event name`)}args.unshift(ev);this.adapter.serverSideEmit(args);return true}serverSideEmitWithAck(ev,...args){return new Promise((resolve,reject)=>{args.push((err,responses)=>{if(err){err.responses=responses;return reject(err)}else{return resolve(responses)}});this.serverSideEmit(ev,...args)})}_onServerSideEmit(args){super.emitUntyped.apply(this,args)}allSockets(){return new broadcast_operator_1.BroadcastOperator(this.adapter).allSockets()}compress(compress){return new broadcast_operator_1.BroadcastOperator(this.adapter).compress(compress)}get volatile(){return new broadcast_operator_1.BroadcastOperator(this.adapter).volatile}get local(){return new broadcast_operator_1.BroadcastOperator(this.adapter).local}timeout(timeout){return new broadcast_operator_1.BroadcastOperator(this.adapter).timeout(timeout)}fetchSockets(){return new broadcast_operator_1.BroadcastOperator(this.adapter).fetchSockets()}socketsJoin(room){return new broadcast_operator_1.BroadcastOperator(this.adapter).socketsJoin(room)}socketsLeave(room){return new broadcast_operator_1.BroadcastOperator(this.adapter).socketsLeave(room)}disconnectSockets(close=false){return new broadcast_operator_1.BroadcastOperator(this.adapter).disconnectSockets(close)}}exports.Namespace=Namespace},{"./broadcast-operator":283,"./socket":289,"./typed-events":290,debug:294}],287:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.ParentNamespace=void 0;const namespace_1=require("./namespace");const socket_io_adapter_1=require("socket.io-adapter");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("socket.io:parent-namespace");class ParentNamespace extends namespace_1.Namespace{constructor(server){super(server,"/_"+ParentNamespace.count++);this.children=new Set}_initAdapter(){this.adapter=new ParentBroadcastAdapter(this)}emit(ev,...args){this.children.forEach(nsp=>{nsp.emit(ev,...args)});return true}createChild(name){debug("creating child namespace %s",name);const namespace=new namespace_1.Namespace(this.server,name);this["_fns"].forEach(fn=>namespace.use(fn));this.listeners("connect").forEach(listener=>namespace.on("connect",listener));this.listeners("connection").forEach(listener=>namespace.on("connection",listener));this.children.add(namespace);if(this.server._opts.cleanupEmptyChildNamespaces){const remove=namespace._remove;namespace._remove=socket=>{remove.call(namespace,socket);if(namespace.sockets.size===0){debug("closing child namespace %s",name);namespace.adapter.close();this.server._nsps.delete(namespace.name);this.children.delete(namespace)}}}this.server._nsps.set(name,namespace);this.server.sockets.emitReserved("new_namespace",namespace);return namespace}fetchSockets(){throw new Error("fetchSockets() is not supported on parent namespaces")}}exports.ParentNamespace=ParentNamespace;ParentNamespace.count=0;class ParentBroadcastAdapter extends socket_io_adapter_1.Adapter{broadcast(packet,opts){this.nsp.children.forEach(nsp=>{nsp.adapter.broadcast(packet,opts)})}}},{"./namespace":286,debug:294,"socket.io-adapter":261}],288:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.RESERVED_EVENTS=void 0;exports.RESERVED_EVENTS=new Set(["connect","connect_error","disconnect","disconnecting","newListener","removeListener"])},{}],289:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.Socket=void 0;const socket_io_parser_1=require("socket.io-parser");const debug_1=__importDefault(require("debug"));const typed_events_1=require("./typed-events");const base64id_1=__importDefault(require("base64id"));const broadcast_operator_1=require("./broadcast-operator");const socket_types_1=require("./socket-types");const debug=(0,debug_1.default)("socket.io:socket");const RECOVERABLE_DISCONNECT_REASONS=new Set(["transport error","transport close","forced close","ping timeout","server shutting down","forced server close"]);function noop(){}class Socket extends typed_events_1.StrictEventEmitter{constructor(nsp,client,auth,previousSession){super();this.nsp=nsp;this.client=client;this.recovered=false;this.data={};this.connected=false;this.acks=new Map;this.fns=[];this.flags={};this.server=nsp.server;this.adapter=this.nsp.adapter;if(previousSession){this.id=previousSession.sid;this.pid=previousSession.pid;previousSession.rooms.forEach(room=>this.join(room));this.data=previousSession.data;previousSession.missedPackets.forEach(packet=>{this.packet({type:socket_io_parser_1.PacketType.EVENT,data:packet})});this.recovered=true}else{if(client.conn.protocol===3){this.id=nsp.name!=="/"?nsp.name+"#"+client.id:client.id}else{this.id=base64id_1.default.generateId()}if(this.server._opts.connectionStateRecovery){this.pid=base64id_1.default.generateId()}}this.handshake=this.buildHandshake(auth);this.on("error",noop)}buildHandshake(auth){var _a,_b,_c,_d;return{headers:((_a=this.request)===null||_a===void 0?void 0:_a.headers)||{},time:new Date+"",address:this.conn.remoteAddress,xdomain:!!((_b=this.request)===null||_b===void 0?void 0:_b.headers.origin),secure:!this.request||!!this.request.connection.encrypted,issued:+new Date,url:(_c=this.request)===null||_c===void 0?void 0:_c.url,query:((_d=this.request)===null||_d===void 0?void 0:_d._query)||{},auth:auth}}emit(ev,...args){if(socket_types_1.RESERVED_EVENTS.has(ev)){throw new Error(`"${String(ev)}" is a reserved event name`)}const data=[ev,...args];const packet={type:socket_io_parser_1.PacketType.EVENT,data:data};if(typeof data[data.length-1]==="function"){const id=this.nsp._ids++;debug("emitting packet with ack id %d",id);this.registerAckCallback(id,data.pop());packet.id=id}const flags=Object.assign({},this.flags);this.flags={};if(this.nsp.server.opts.connectionStateRecovery){this.adapter.broadcast(packet,{rooms:new Set([this.id]),except:new Set,flags:flags})}else{this.notifyOutgoingListeners(packet);this.packet(packet,flags)}return true}emitWithAck(ev,...args){const withErr=this.flags.timeout!==undefined;return new Promise((resolve,reject)=>{args.push((arg1,arg2)=>{if(withErr){return arg1?reject(arg1):resolve(arg2)}else{return resolve(arg1)}});this.emit(ev,...args)})}registerAckCallback(id,ack){const timeout=this.flags.timeout;if(timeout===undefined){this.acks.set(id,ack);return}const timer=setTimeout(()=>{debug("event with ack id %d has timed out after %d ms",id,timeout);this.acks.delete(id);ack.call(this,new Error("operation has timed out"))},timeout);this.acks.set(id,(...args)=>{clearTimeout(timer);ack.apply(this,[null,...args])})}to(room){return this.newBroadcastOperator().to(room)}in(room){return this.newBroadcastOperator().in(room)}except(room){return this.newBroadcastOperator().except(room)}send(...args){this.emit("message",...args);return this}write(...args){this.emit("message",...args);return this}packet(packet,opts={}){packet.nsp=this.nsp.name;opts.compress=false!==opts.compress;this.client._packet(packet,opts)}join(rooms){debug("join room %s",rooms);return this.adapter.addAll(this.id,new Set(Array.isArray(rooms)?rooms:[rooms]))}leave(room){debug("leave room %s",room);return this.adapter.del(this.id,room)}leaveAll(){this.adapter.delAll(this.id)}_onconnect(){debug("socket connected - writing packet");this.connected=true;this.join(this.id);if(this.conn.protocol===3){this.packet({type:socket_io_parser_1.PacketType.CONNECT})}else{this.packet({type:socket_io_parser_1.PacketType.CONNECT,data:{sid:this.id,pid:this.pid}})}}_onpacket(packet){debug("got packet %j",packet);switch(packet.type){case socket_io_parser_1.PacketType.EVENT:this.onevent(packet);break;case socket_io_parser_1.PacketType.BINARY_EVENT:this.onevent(packet);break;case socket_io_parser_1.PacketType.ACK:this.onack(packet);break;case socket_io_parser_1.PacketType.BINARY_ACK:this.onack(packet);break;case socket_io_parser_1.PacketType.DISCONNECT:this.ondisconnect();break}}onevent(packet){const args=packet.data||[];debug("emitting event %j",args);if(null!=packet.id){debug("attaching ack callback to event");args.push(this.ack(packet.id))}if(this._anyListeners&&this._anyListeners.length){const listeners=this._anyListeners.slice();for(const listener of listeners){listener.apply(this,args)}}this.dispatch(args)}ack(id){const self=this;let sent=false;return function(){if(sent)return;const args=Array.prototype.slice.call(arguments);debug("sending ack %j",args);self.packet({id:id,type:socket_io_parser_1.PacketType.ACK,data:args});sent=true}}onack(packet){const ack=this.acks.get(packet.id);if("function"==typeof ack){debug("calling ack %s with %j",packet.id,packet.data);ack.apply(this,packet.data);this.acks.delete(packet.id)}else{debug("bad ack %s",packet.id)}}ondisconnect(){debug("got disconnect packet");this._onclose("client namespace disconnect")}_onerror(err){this.emitReserved("error",err)}_onclose(reason,description){if(!this.connected)return this;debug("closing socket - reason %s",reason);this.emitReserved("disconnecting",reason,description);if(this.server._opts.connectionStateRecovery&&RECOVERABLE_DISCONNECT_REASONS.has(reason)){debug("connection state recovery is enabled for sid %s",this.id);this.adapter.persistSession({sid:this.id,pid:this.pid,rooms:[...this.rooms],data:this.data})}this._cleanup();this.client._remove(this);this.connected=false;this.emitReserved("disconnect",reason,description);return}_cleanup(){this.leaveAll();this.nsp._remove(this);this.join=noop}_error(err){this.packet({type:socket_io_parser_1.PacketType.CONNECT_ERROR,data:err})}disconnect(close=false){if(!this.connected)return this;if(close){this.client._disconnect()}else{this.packet({type:socket_io_parser_1.PacketType.DISCONNECT});this._onclose("server namespace disconnect")}return this}compress(compress){this.flags.compress=compress;return this}get volatile(){this.flags.volatile=true;return this}get broadcast(){return this.newBroadcastOperator()}get local(){return this.newBroadcastOperator().local}timeout(timeout){this.flags.timeout=timeout;return this}dispatch(event){debug("dispatching an event %j",event);this.run(event,err=>{process.nextTick(()=>{if(err){return this._onerror(err)}if(this.connected){super.emitUntyped.apply(this,event)}else{debug("ignore packet received after disconnection")}})})}use(fn){this.fns.push(fn);return this}run(event,fn){if(!this.fns.length)return fn();const fns=this.fns.slice(0);function run(i){fns[i](event,err=>{if(err)return fn(err);if(!fns[i+1])return fn();run(i+1)})}run(0)}get disconnected(){return!this.connected}get request(){return this.client.request}get conn(){return this.client.conn}get rooms(){return this.adapter.socketRooms(this.id)||new Set}onAny(listener){this._anyListeners=this._anyListeners||[];this._anyListeners.push(listener);return this}prependAny(listener){this._anyListeners=this._anyListeners||[];this._anyListeners.unshift(listener);return this}offAny(listener){if(!this._anyListeners){return this}if(listener){const listeners=this._anyListeners;for(let i=0;i<listeners.length;i++){if(listener===listeners[i]){listeners.splice(i,1);return this}}}else{this._anyListeners=[]}return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(listener){this._anyOutgoingListeners=this._anyOutgoingListeners||[];this._anyOutgoingListeners.push(listener);return this}prependAnyOutgoing(listener){this._anyOutgoingListeners=this._anyOutgoingListeners||[];this._anyOutgoingListeners.unshift(listener);return this}offAnyOutgoing(listener){if(!this._anyOutgoingListeners){return this}if(listener){const listeners=this._anyOutgoingListeners;for(let i=0;i<listeners.length;i++){if(listener===listeners[i]){listeners.splice(i,1);return this}}}else{this._anyOutgoingListeners=[]}return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(packet){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const listeners=this._anyOutgoingListeners.slice();for(const listener of listeners){listener.apply(this,packet.data)}}}newBroadcastOperator(){const flags=Object.assign({},this.flags);this.flags={};return new broadcast_operator_1.BroadcastOperator(this.adapter,new Set,new Set([this.id]),flags)}}exports.Socket=Socket},{"./broadcast-operator":283,"./socket-types":288,"./typed-events":290,base64id:77,debug:294,"socket.io-parser":277}],290:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.StrictEventEmitter=void 0;const events_1=require("events");class StrictEventEmitter extends events_1.EventEmitter{on(ev,listener){return super.on(ev,listener)}once(ev,listener){return super.once(ev,listener)}emit(ev,...args){return super.emit(ev,...args)}emitReserved(ev,...args){return super.emit(ev,...args)}emitUntyped(ev,...args){return super.emit(ev,...args)}listeners(event){return super.listeners(event)}}exports.StrictEventEmitter=StrictEventEmitter},{events:undefined}],291:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.patchAdapter=patchAdapter;exports.restoreAdapter=restoreAdapter;exports.serveFile=serveFile;const socket_io_adapter_1=require("socket.io-adapter");const fs_1=require("fs");const debug_1=__importDefault(require("debug"));const debug=(0,debug_1.default)("socket.io:adapter-uws");const SEPARATOR="";const{addAll:addAll,del:del,broadcast:broadcast}=socket_io_adapter_1.Adapter.prototype;function patchAdapter(app){socket_io_adapter_1.Adapter.prototype.addAll=function(id,rooms){const isNew=!this.sids.has(id);addAll.call(this,id,rooms);const socket=this.nsp.sockets.get(id)||this.nsp._preConnectSockets.get(id);if(!socket){return}if(socket.conn.transport.name==="websocket"){subscribe(this.nsp.name,socket,isNew,rooms);return}if(isNew){socket.conn.on("upgrade",()=>{const rooms=this.sids.get(id);if(rooms){subscribe(this.nsp.name,socket,isNew,rooms)}})}};socket_io_adapter_1.Adapter.prototype.del=function(id,room){del.call(this,id,room);const socket=this.nsp.sockets.get(id)||this.nsp._preConnectSockets.get(id);if(socket&&socket.conn.transport.name==="websocket"){const sessionId=socket.conn.id;const websocket=socket.conn.transport.socket;const topic=`${this.nsp.name}${SEPARATOR}${room}`;debug("unsubscribe connection %s from topic %s",sessionId,topic);websocket.unsubscribe(topic)}};socket_io_adapter_1.Adapter.prototype.broadcast=function(packet,opts){const useFastPublish=opts.rooms.size<=1&&opts.except.size===0;if(!useFastPublish){broadcast.call(this,packet,opts);return}const flags=opts.flags||{};const basePacketOpts={preEncoded:true,volatile:flags.volatile,compress:flags.compress};packet.nsp=this.nsp.name;const encodedPackets=this.encoder.encode(packet);const topic=opts.rooms.size===0?this.nsp.name:`${this.nsp.name}${SEPARATOR}${opts.rooms.keys().next().value}`;debug("fast publish to %s",topic);encodedPackets.forEach(encodedPacket=>{const isBinary=typeof encodedPacket!=="string";app.publish(topic,isBinary?encodedPacket:"4"+encodedPacket,isBinary)});this.apply(opts,socket=>{if(socket.conn.transport.name!=="websocket"){socket.client.writeToEngine(encodedPackets,basePacketOpts)}})}}function subscribe(namespaceName,socket,isNew,rooms){const sessionId=socket.conn.id;const websocket=socket.conn.transport.socket;if(isNew){debug("subscribe connection %s to topic %s",sessionId,namespaceName);websocket.subscribe(namespaceName)}rooms.forEach(room=>{const topic=`${namespaceName}${SEPARATOR}${room}`;debug("subscribe connection %s to topic %s",sessionId,topic);websocket.subscribe(topic)})}function restoreAdapter(){socket_io_adapter_1.Adapter.prototype.addAll=addAll;socket_io_adapter_1.Adapter.prototype.del=del;socket_io_adapter_1.Adapter.prototype.broadcast=broadcast}const toArrayBuffer=buffer=>{const{buffer:arrayBuffer,byteOffset:byteOffset,byteLength:byteLength}=buffer;return arrayBuffer.slice(byteOffset,byteOffset+byteLength)};function serveFile(res,filepath){const{size:size}=(0,fs_1.statSync)(filepath);const readStream=(0,fs_1.createReadStream)(filepath);const destroyReadStream=()=>!readStream.destroyed&&readStream.destroy();const onError=error=>{destroyReadStream();throw error};const onDataChunk=chunk=>{const arrayBufferChunk=toArrayBuffer(chunk);res.cork(()=>{const lastOffset=res.getWriteOffset();const[ok,done]=res.tryEnd(arrayBufferChunk,size);if(!done&&!ok){readStream.pause();res.onWritable(offset=>{const[ok,done]=res.tryEnd(arrayBufferChunk.slice(offset-lastOffset),size);if(!done&&ok){readStream.resume()}return ok})}})};res.onAborted(destroyReadStream);readStream.on("data",onDataChunk).on("error",onError).on("end",destroyReadStream)}},{debug:294,fs:undefined,"socket.io-adapter":261}],292:[function(require,module,exports){arguments[4][105][0].apply(exports,arguments)},{"./common":293,dup:105}],293:[function(require,module,exports){arguments[4][106][0].apply(exports,arguments)},{dup:106,ms:202}],294:[function(require,module,exports){arguments[4][107][0].apply(exports,arguments)},{"./browser.js":292,"./node.js":295,dup:107}],295:[function(require,module,exports){arguments[4][108][0].apply(exports,arguments)},{"./common":293,dup:108,"supports-color":297,tty:undefined,util:undefined}],296:[function(require,module,exports){module.exports={name:"socket.io",version:"4.8.1",description:"node.js realtime framework server",keywords:["realtime","framework","websocket","tcp","events","socket","io"],files:["dist/","client-dist/","wrapper.mjs","!**/*.tsbuildinfo"],directories:{doc:"docs/",example:"example/",lib:"lib/",test:"test/"},type:"commonjs",main:"./dist/index.js",exports:{types:"./dist/index.d.ts",import:"./wrapper.mjs",require:"./dist/index.js"},types:"./dist/index.d.ts",license:"MIT",homepage:"https://github.com/socketio/socket.io/tree/main/packages/socket.io#readme",repository:{type:"git",url:"git+https://github.com/socketio/socket.io.git"},bugs:{url:"https://github.com/socketio/socket.io/issues"},scripts:{compile:"rimraf ./dist && tsc",test:"npm run format:check && npm run compile && npm run test:types && npm run test:unit","test:types":"tsd","test:unit":"nyc mocha --require ts-node/register --reporter spec --slow 200 --bail --timeout 10000 test/index.ts","format:check":'prettier --check "lib/**/*.ts" "test/**/*.ts"',"format:fix":'prettier --write "lib/**/*.ts" "test/**/*.ts"',prepack:"npm run compile"},dependencies:{accepts:"~1.3.4",base64id:"~2.0.0",cors:"~2.8.5",debug:"~4.3.2","engine.io":"~6.6.0","socket.io-adapter":"~2.5.2","socket.io-parser":"~4.2.4"},contributors:[{name:"Guillermo Rauch",email:"rauchg@gmail.com"},{name:"Arnout Kazemier",email:"info@3rd-eden.com"},{name:"Vladimir Dronnikov",email:"dronnikov@gmail.com"},{name:"Einar Otto Stangvik",email:"einaros@gmail.com"}],engines:{node:">=10.2.0"},tsd:{directory:"test"}}},{}],297:[function(require,module,exports){"use strict";const os=require("os");const tty=require("tty");const hasFlag=require("has-flag");const{env:env}=process;let flagForceColor;if(hasFlag("no-color")||hasFlag("no-colors")||hasFlag("color=false")||hasFlag("color=never")){flagForceColor=0}else if(hasFlag("color")||hasFlag("colors")||hasFlag("color=true")||hasFlag("color=always")){flagForceColor=1}function envForceColor(){if("FORCE_COLOR"in env){if(env.FORCE_COLOR==="true"){return 1}if(env.FORCE_COLOR==="false"){return 0}return env.FORCE_COLOR.length===0?1:Math.min(Number.parseInt(env.FORCE_COLOR,10),3)}}function translateLevel(level){if(level===0){return false}return{level:level,hasBasic:true,has256:level>=2,has16m:level>=3}}function supportsColor(haveStream,{streamIsTTY:streamIsTTY,sniffFlags:sniffFlags=true}={}){const noFlagForceColor=envForceColor();if(noFlagForceColor!==undefined){flagForceColor=noFlagForceColor}const forceColor=sniffFlags?flagForceColor:noFlagForceColor;if(forceColor===0){return 0}if(sniffFlags){if(hasFlag("color=16m")||hasFlag("color=full")||hasFlag("color=truecolor")){return 3}if(hasFlag("color=256")){return 2}}if(haveStream&&!streamIsTTY&&forceColor===undefined){return 0}const min=forceColor||0;if(env.TERM==="dumb"){return min}if(process.platform==="win32"){const osRelease=os.release().split(".");if(Number(osRelease[0])>=10&&Number(osRelease[2])>=10586){return Number(osRelease[2])>=14931?3:2}return 1}if("CI"in env){if(["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE","DRONE"].some(sign=>sign in env)||env.CI_NAME==="codeship"){return 1}return min}if("TEAMCITY_VERSION"in env){return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(env.TEAMCITY_VERSION)?1:0}if(env.COLORTERM==="truecolor"){return 3}if("TERM_PROGRAM"in env){const version=Number.parseInt((env.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(env.TERM_PROGRAM){case"iTerm.app":return version>=3?3:2;case"Apple_Terminal":return 2}}if(/-256(color)?$/i.test(env.TERM)){return 2}if(/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(env.TERM)){return 1}if("COLORTERM"in env){return 1}return min}function getSupportLevel(stream,options={}){const level=supportsColor(stream,{streamIsTTY:stream&&stream.isTTY,...options});return translateLevel(level)}module.exports={supportsColor:getSupportLevel,stdout:getSupportLevel({isTTY:tty.isatty(1)}),stderr:getSupportLevel({isTTY:tty.isatty(2)})}},{"has-flag":191,os:undefined,tty:undefined}],298:[function(require,module,exports){"use strict";var isPrototype=require("../prototype/is");module.exports=function(value){if(typeof value!=="function")return false;if(!hasOwnProperty.call(value,"length"))return false;try{if(typeof value.length!=="number")return false;if(typeof value.call!=="function")return false;if(typeof value.apply!=="function")return false}catch(error){return false}return!isPrototype(value)}},{"../prototype/is":305}],299:[function(require,module,exports){"use strict";var stringCoerce=require("../string/coerce"),toShortString=require("./to-short-string");module.exports=function(errorMessage,value,inputOptions){if(inputOptions&&inputOptions.errorMessage){errorMessage=stringCoerce(inputOptions.errorMessage)}var valueInsertIndex=errorMessage.indexOf("%v");var valueToken=valueInsertIndex>-1?toShortString(value):null;if(inputOptions&&inputOptions.name){var nameInsertIndex=errorMessage.indexOf("%n");if(nameInsertIndex>-1){if(valueInsertIndex>-1){var firstToken,secondToken,firstInsertIndex,secondInsertIndex;if(nameInsertIndex>valueInsertIndex){firstToken=valueToken;firstInsertIndex=valueInsertIndex;secondToken=inputOptions.name;secondInsertIndex=nameInsertIndex}else{firstToken=inputOptions.name;firstInsertIndex=nameInsertIndex;secondToken=valueToken;secondInsertIndex=valueInsertIndex}return errorMessage.slice(0,firstInsertIndex)+firstToken+errorMessage.slice(firstInsertIndex+2,secondInsertIndex)+secondToken+errorMessage.slice(secondInsertIndex+2)}return errorMessage.slice(0,nameInsertIndex)+inputOptions.name+errorMessage.slice(nameInsertIndex+2)}}if(valueInsertIndex>-1){return errorMessage.slice(0,valueInsertIndex)+valueToken+errorMessage.slice(valueInsertIndex+2)}return errorMessage}},{"../string/coerce":306,"./to-short-string":302}],300:[function(require,module,exports){"use strict";var isValue=require("../value/is"),resolveErrorMessage=require("./resolve-error-message");module.exports=function(value,defaultMessage,inputOptions){if(inputOptions&&!isValue(value)){if("default"in inputOptions)return inputOptions["default"];if(inputOptions.isOptional)return null}var ErrorConstructor=inputOptions&&inputOptions.Error||TypeError;var error=new ErrorConstructor(resolveErrorMessage(defaultMessage,value,inputOptions));if(inputOptions&&inputOptions.errorCode)error.code=inputOptions.errorCode;throw error}},{"../value/is":309,"./resolve-error-message":299}],301:[function(require,module,exports){"use strict";module.exports=function(value){try{return value.toString()}catch(error){try{return String(value)}catch(error2){return null}}}},{}],302:[function(require,module,exports){"use strict";var safeToString=require("./safe-to-string");var reNewLine=/[\n\r\u2028\u2029]/g;module.exports=function(value){var string=safeToString(value);if(string===null)return"<Non-coercible to string value>";if(string.length>100)string=string.slice(0,99)+"";string=string.replace(reNewLine,function(char){switch(char){case"\n":return"\\n";case"\r":return"\\r";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:throw new Error("Unexpected character")}});return string}},{"./safe-to-string":301}],303:[function(require,module,exports){"use strict";var isValue=require("../value/is");var possibleTypes={object:true,function:true,undefined:true};module.exports=function(value){if(!isValue(value))return false;return hasOwnProperty.call(possibleTypes,typeof value)}},{"../value/is":309}],304:[function(require,module,exports){"use strict";var isFunction=require("../function/is");var classRe=/^\s*class[\s{/}]/,functionToString=Function.prototype.toString;module.exports=function(value){if(!isFunction(value))return false;if(classRe.test(functionToString.call(value)))return false;return true}},{"../function/is":298}],305:[function(require,module,exports){"use strict";var isObject=require("../object/is");module.exports=function(value){if(!isObject(value))return false;try{if(!value.constructor)return false;return value.constructor.prototype===value}catch(error){return false}}},{"../object/is":303}],306:[function(require,module,exports){"use strict";var isValue=require("../value/is"),isObject=require("../object/is");var objectToString=Object.prototype.toString;module.exports=function(value){if(!isValue(value))return null;if(isObject(value)){var valueToString=value.toString;if(typeof valueToString!=="function")return null;if(valueToString===objectToString)return null}try{return""+value}catch(error){return null}}},{"../object/is":303,"../value/is":309}],307:[function(require,module,exports){"use strict";var resolveException=require("../lib/resolve-exception"),coerce=require("./coerce");module.exports=function(value){var coerced=coerce(value);if(coerced!==null)return coerced;var options=arguments[1];var errorMessage=options&&options.name?"Expected a string for %n, received %v":"%v is not a string";return resolveException(value,errorMessage,options)}},{"../lib/resolve-exception":300,"./coerce":306}],308:[function(require,module,exports){"use strict";var resolveException=require("../lib/resolve-exception"),is=require("./is");module.exports=function(value){if(is(value))return value;var options=arguments[1];var errorMessage=options&&options.name?"Expected a value for %n, received %v":"Cannot use %v";return resolveException(value,errorMessage,options)}},{"../lib/resolve-exception":300,"./is":309}],309:[function(require,module,exports){"use strict";var _undefined=void 0;module.exports=function(value){return value!==_undefined&&value!==null}},{}],310:[function(require,module,exports){(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define("underscore",factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,function(){var current=global._;var exports=global._=factory();exports.noConflict=function(){global._=current;return exports}}())})(this,function(){var VERSION="1.13.7";var root=typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global||Function("return this")()||{};var ArrayProto=Array.prototype,ObjProto=Object.prototype;var SymbolProto=typeof Symbol!=="undefined"?Symbol.prototype:null;var push=ArrayProto.push,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var supportsArrayBuffer=typeof ArrayBuffer!=="undefined",supportsDataView=typeof DataView!=="undefined";var nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeCreate=Object.create,nativeIsView=supportsArrayBuffer&&ArrayBuffer.isView;var _isNaN=isNaN,_isFinite=isFinite;var hasEnumBug=!{toString:null}.propertyIsEnumerable("toString");var nonEnumerableProps=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];var MAX_ARRAY_INDEX=Math.pow(2,53)-1;function restArguments(func,startIndex){startIndex=startIndex==null?func.length-1:+startIndex;return function(){var length=Math.max(arguments.length-startIndex,0),rest=Array(length),index=0;for(;index<length;index++){rest[index]=arguments[index+startIndex]}switch(startIndex){case 0:return func.call(this,rest);case 1:return func.call(this,arguments[0],rest);case 2:return func.call(this,arguments[0],arguments[1],rest)}var args=Array(startIndex+1);for(index=0;index<startIndex;index++){args[index]=arguments[index]}args[startIndex]=rest;return func.apply(this,args)}}function isObject(obj){var type=typeof obj;return type==="function"||type==="object"&&!!obj}function isNull(obj){return obj===null}function isUndefined(obj){return obj===void 0}function isBoolean(obj){return obj===true||obj===false||toString.call(obj)==="[object Boolean]"}function isElement(obj){return!!(obj&&obj.nodeType===1)}function tagTester(name){var tag="[object "+name+"]";return function(obj){return toString.call(obj)===tag}}var isString=tagTester("String");var isNumber=tagTester("Number");var isDate=tagTester("Date");var isRegExp=tagTester("RegExp");var isError=tagTester("Error");var isSymbol=tagTester("Symbol");var isArrayBuffer=tagTester("ArrayBuffer");var isFunction=tagTester("Function");var nodelist=root.document&&root.document.childNodes;if(typeof/./!="function"&&typeof Int8Array!="object"&&typeof nodelist!="function"){isFunction=function(obj){return typeof obj=="function"||false}}var isFunction$1=isFunction;var hasObjectTag=tagTester("Object");var hasDataViewBug=supportsDataView&&(!/\[native code\]/.test(String(DataView))||hasObjectTag(new DataView(new ArrayBuffer(8)))),isIE11=typeof Map!=="undefined"&&hasObjectTag(new Map);var isDataView=tagTester("DataView");function alternateIsDataView(obj){return obj!=null&&isFunction$1(obj.getInt8)&&isArrayBuffer(obj.buffer)}var isDataView$1=hasDataViewBug?alternateIsDataView:isDataView;var isArray=nativeIsArray||tagTester("Array");function has$1(obj,key){return obj!=null&&hasOwnProperty.call(obj,key)}var isArguments=tagTester("Arguments");(function(){if(!isArguments(arguments)){isArguments=function(obj){return has$1(obj,"callee")}}})();var isArguments$1=isArguments;function isFinite$1(obj){return!isSymbol(obj)&&_isFinite(obj)&&!isNaN(parseFloat(obj))}function isNaN$1(obj){return isNumber(obj)&&_isNaN(obj)}function constant(value){return function(){return value}}function createSizePropertyCheck(getSizeProperty){return function(collection){var sizeProperty=getSizeProperty(collection);return typeof sizeProperty=="number"&&sizeProperty>=0&&sizeProperty<=MAX_ARRAY_INDEX}}function shallowProperty(key){return function(obj){return obj==null?void 0:obj[key]}}var getByteLength=shallowProperty("byteLength");var isBufferLike=createSizePropertyCheck(getByteLength);var typedArrayPattern=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;function isTypedArray(obj){return nativeIsView?nativeIsView(obj)&&!isDataView$1(obj):isBufferLike(obj)&&typedArrayPattern.test(toString.call(obj))}var isTypedArray$1=supportsArrayBuffer?isTypedArray:constant(false);var getLength=shallowProperty("length");function emulatedSet(keys){var hash={};for(var l=keys.length,i=0;i<l;++i)hash[keys[i]]=true;return{contains:function(key){return hash[key]===true},push:function(key){hash[key]=true;return keys.push(key)}}}function collectNonEnumProps(obj,keys){keys=emulatedSet(keys);var nonEnumIdx=nonEnumerableProps.length;var constructor=obj.constructor;var proto=isFunction$1(constructor)&&constructor.prototype||ObjProto;var prop="constructor";if(has$1(obj,prop)&&!keys.contains(prop))keys.push(prop);while(nonEnumIdx--){prop=nonEnumerableProps[nonEnumIdx];if(prop in obj&&obj[prop]!==proto[prop]&&!keys.contains(prop)){keys.push(prop)}}}function keys(obj){if(!isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)if(has$1(obj,key))keys.push(key);if(hasEnumBug)collectNonEnumProps(obj,keys);return keys}function isEmpty(obj){if(obj==null)return true;var length=getLength(obj);if(typeof length=="number"&&(isArray(obj)||isString(obj)||isArguments$1(obj)))return length===0;return getLength(keys(obj))===0}function isMatch(object,attrs){var _keys=keys(attrs),length=_keys.length;if(object==null)return!length;var obj=Object(object);for(var i=0;i<length;i++){var key=_keys[i];if(attrs[key]!==obj[key]||!(key in obj))return false}return true}function _$1(obj){if(obj instanceof _$1)return obj;if(!(this instanceof _$1))return new _$1(obj);this._wrapped=obj}_$1.VERSION=VERSION;_$1.prototype.value=function(){return this._wrapped};_$1.prototype.valueOf=_$1.prototype.toJSON=_$1.prototype.value;_$1.prototype.toString=function(){return String(this._wrapped)};function toBufferView(bufferSource){return new Uint8Array(bufferSource.buffer||bufferSource,bufferSource.byteOffset||0,getByteLength(bufferSource))}var tagDataView="[object DataView]";function eq(a,b,aStack,bStack){if(a===b)return a!==0||1/a===1/b;if(a==null||b==null)return false;if(a!==a)return b!==b;var type=typeof a;if(type!=="function"&&type!=="object"&&typeof b!="object")return false;return deepEq(a,b,aStack,bStack)}function deepEq(a,b,aStack,bStack){if(a instanceof _$1)a=a._wrapped;if(b instanceof _$1)b=b._wrapped;var className=toString.call(a);if(className!==toString.call(b))return false;if(hasDataViewBug&&className=="[object Object]"&&isDataView$1(a)){if(!isDataView$1(b))return false;className=tagDataView}switch(className){case"[object RegExp]":case"[object String]":return""+a===""+b;case"[object Number]":if(+a!==+a)return+b!==+b;return+a===0?1/+a===1/b:+a===+b;case"[object Date]":case"[object Boolean]":return+a===+b;case"[object Symbol]":return SymbolProto.valueOf.call(a)===SymbolProto.valueOf.call(b);case"[object ArrayBuffer]":case tagDataView:return deepEq(toBufferView(a),toBufferView(b),aStack,bStack)}var areArrays=className==="[object Array]";if(!areArrays&&isTypedArray$1(a)){var byteLength=getByteLength(a);if(byteLength!==getByteLength(b))return false;if(a.buffer===b.buffer&&a.byteOffset===b.byteOffset)return true;areArrays=true}if(!areArrays){if(typeof a!="object"||typeof b!="object")return false;var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(isFunction$1(aCtor)&&aCtor instanceof aCtor&&isFunction$1(bCtor)&&bCtor instanceof bCtor)&&("constructor"in a&&"constructor"in b)){return false}}aStack=aStack||[];bStack=bStack||[];var length=aStack.length;while(length--){if(aStack[length]===a)return bStack[length]===b}aStack.push(a);bStack.push(b);if(areArrays){length=a.length;if(length!==b.length)return false;while(length--){if(!eq(a[length],b[length],aStack,bStack))return false}}else{var _keys=keys(a),key;length=_keys.length;if(keys(b).length!==length)return false;while(length--){key=_keys[length];if(!(has$1(b,key)&&eq(a[key],b[key],aStack,bStack)))return false}}aStack.pop();bStack.pop();return true}function isEqual(a,b){return eq(a,b)}function allKeys(obj){if(!isObject(obj))return[];var keys=[];for(var key in obj)keys.push(key);if(hasEnumBug)collectNonEnumProps(obj,keys);return keys}function ie11fingerprint(methods){var length=getLength(methods);return function(obj){if(obj==null)return false;var keys=allKeys(obj);if(getLength(keys))return false;for(var i=0;i<length;i++){if(!isFunction$1(obj[methods[i]]))return false}return methods!==weakMapMethods||!isFunction$1(obj[forEachName])}}var forEachName="forEach",hasName="has",commonInit=["clear","delete"],mapTail=["get",hasName,"set"];var mapMethods=commonInit.concat(forEachName,mapTail),weakMapMethods=commonInit.concat(mapTail),setMethods=["add"].concat(commonInit,forEachName,hasName);var isMap=isIE11?ie11fingerprint(mapMethods):tagTester("Map");var isWeakMap=isIE11?ie11fingerprint(weakMapMethods):tagTester("WeakMap");var isSet=isIE11?ie11fingerprint(setMethods):tagTester("Set");var isWeakSet=tagTester("WeakSet");function values(obj){var _keys=keys(obj);var length=_keys.length;var values=Array(length);for(var i=0;i<length;i++){values[i]=obj[_keys[i]]}return values}function pairs(obj){var _keys=keys(obj);var length=_keys.length;var pairs=Array(length);for(var i=0;i<length;i++){pairs[i]=[_keys[i],obj[_keys[i]]]}return pairs}function invert(obj){var result={};var _keys=keys(obj);for(var i=0,length=_keys.length;i<length;i++){result[obj[_keys[i]]]=_keys[i]}return result}function functions(obj){var names=[];for(var key in obj){if(isFunction$1(obj[key]))names.push(key)}return names.sort()}function createAssigner(keysFunc,defaults){return function(obj){var length=arguments.length;if(defaults)obj=Object(obj);if(length<2||obj==null)return obj;for(var index=1;index<length;index++){var source=arguments[index],keys=keysFunc(source),l=keys.length;for(var i=0;i<l;i++){var key=keys[i];if(!defaults||obj[key]===void 0)obj[key]=source[key]}}return obj}}var extend=createAssigner(allKeys);var extendOwn=createAssigner(keys);var defaults=createAssigner(allKeys,true);function ctor(){return function(){}}function baseCreate(prototype){if(!isObject(prototype))return{};if(nativeCreate)return nativeCreate(prototype);var Ctor=ctor();Ctor.prototype=prototype;var result=new Ctor;Ctor.prototype=null;return result}function create(prototype,props){var result=baseCreate(prototype);if(props)extendOwn(result,props);return result}function clone(obj){if(!isObject(obj))return obj;return isArray(obj)?obj.slice():extend({},obj)}function tap(obj,interceptor){interceptor(obj);return obj}function toPath$1(path){return isArray(path)?path:[path]}_$1.toPath=toPath$1;function toPath(path){return _$1.toPath(path)}function deepGet(obj,path){var length=path.length;for(var i=0;i<length;i++){if(obj==null)return void 0;obj=obj[path[i]]}return length?obj:void 0}function get(object,path,defaultValue){var value=deepGet(object,toPath(path));return isUndefined(value)?defaultValue:value}function has(obj,path){path=toPath(path);var length=path.length;for(var i=0;i<length;i++){var key=path[i];if(!has$1(obj,key))return false;obj=obj[key]}return!!length}function identity(value){return value}function matcher(attrs){attrs=extendOwn({},attrs);return function(obj){return isMatch(obj,attrs)}}function property(path){path=toPath(path);return function(obj){return deepGet(obj,path)}}function optimizeCb(func,context,argCount){if(context===void 0)return func;switch(argCount==null?3:argCount){case 1:return function(value){return func.call(context,value)};case 3:return function(value,index,collection){return func.call(context,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(context,accumulator,value,index,collection)}}return function(){return func.apply(context,arguments)}}function baseIteratee(value,context,argCount){if(value==null)return identity;if(isFunction$1(value))return optimizeCb(value,context,argCount);if(isObject(value)&&!isArray(value))return matcher(value);return property(value)}function iteratee(value,context){return baseIteratee(value,context,Infinity)}_$1.iteratee=iteratee;function cb(value,context,argCount){if(_$1.iteratee!==iteratee)return _$1.iteratee(value,context);return baseIteratee(value,context,argCount)}function mapObject(obj,iteratee,context){iteratee=cb(iteratee,context);var _keys=keys(obj),length=_keys.length,results={};for(var index=0;index<length;index++){var currentKey=_keys[index];results[currentKey]=iteratee(obj[currentKey],currentKey,obj)}return results}function noop(){}function propertyOf(obj){if(obj==null)return noop;return function(path){return get(obj,path)}}function times(n,iteratee,context){var accum=Array(Math.max(0,n));iteratee=optimizeCb(iteratee,context,1);for(var i=0;i<n;i++)accum[i]=iteratee(i);return accum}function random(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))}var now=Date.now||function(){return(new Date).getTime()};function createEscaper(map){var escaper=function(match){return map[match]};var source="(?:"+keys(map).join("|")+")";var testRegexp=RegExp(source);var replaceRegexp=RegExp(source,"g");return function(string){string=string==null?"":""+string;return testRegexp.test(string)?string.replace(replaceRegexp,escaper):string}}var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};var _escape=createEscaper(escapeMap);var unescapeMap=invert(escapeMap);var _unescape=createEscaper(unescapeMap);var templateSettings=_$1.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"};var escapeRegExp=/\\|'|\r|\n|\u2028|\u2029/g;function escapeChar(match){return"\\"+escapes[match]}var bareIdentifier=/^\s*(\w|\$)+\s*$/;function template(text,settings,oldSettings){if(!settings&&oldSettings)settings=oldSettings;settings=defaults({},settings,_$1.templateSettings);var matcher=RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escapeRegExp,escapeChar);index=offset+match.length;if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}else if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}else if(evaluate){source+="';\n"+evaluate+"\n__p+='"}return match});source+="';\n";var argument=settings.variable;if(argument){if(!bareIdentifier.test(argument))throw new Error("variable is not a bare identifier: "+argument)}else{source="with(obj||{}){\n"+source+"}\n";argument="obj"}source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";var render;try{render=new Function(argument,"_",source)}catch(e){e.source=source;throw e}var template=function(data){return render.call(this,data,_$1)};template.source="function("+argument+"){\n"+source+"}";return template}function result(obj,path,fallback){path=toPath(path);var length=path.length;if(!length){return isFunction$1(fallback)?fallback.call(obj):fallback}for(var i=0;i<length;i++){var prop=obj==null?void 0:obj[path[i]];if(prop===void 0){prop=fallback;i=length}obj=isFunction$1(prop)?prop.call(obj):prop}return obj}var idCounter=0;function uniqueId(prefix){var id=++idCounter+"";return prefix?prefix+id:id}function chain(obj){var instance=_$1(obj);instance._chain=true;return instance}function executeBound(sourceFunc,boundFunc,context,callingContext,args){if(!(callingContext instanceof boundFunc))return sourceFunc.apply(context,args);var self=baseCreate(sourceFunc.prototype);var result=sourceFunc.apply(self,args);if(isObject(result))return result;return self}var partial=restArguments(function(func,boundArgs){var placeholder=partial.placeholder;var bound=function(){var position=0,length=boundArgs.length;var args=Array(length);for(var i=0;i<length;i++){args[i]=boundArgs[i]===placeholder?arguments[position++]:boundArgs[i]}while(position<arguments.length)args.push(arguments[position++]);return executeBound(func,bound,this,this,args)};return bound});partial.placeholder=_$1;var bind=restArguments(function(func,context,args){if(!isFunction$1(func))throw new TypeError("Bind must be called on a function");var bound=restArguments(function(callArgs){return executeBound(func,bound,context,this,args.concat(callArgs))});return bound});var isArrayLike=createSizePropertyCheck(getLength);function flatten$1(input,depth,strict,output){output=output||[];if(!depth&&depth!==0){depth=Infinity}else if(depth<=0){return output.concat(input)}var idx=output.length;for(var i=0,length=getLength(input);i<length;i++){var value=input[i];if(isArrayLike(value)&&(isArray(value)||isArguments$1(value))){if(depth>1){flatten$1(value,depth-1,strict,output);idx=output.length}else{var j=0,len=value.length;while(j<len)output[idx++]=value[j++]}}else if(!strict){output[idx++]=value}}return output}var bindAll=restArguments(function(obj,keys){keys=flatten$1(keys,false,false);var index=keys.length;if(index<1)throw new Error("bindAll must be passed function names");while(index--){var key=keys[index];obj[key]=bind(obj[key],obj)}return obj});function memoize(func,hasher){var memoize=function(key){var cache=memoize.cache;var address=""+(hasher?hasher.apply(this,arguments):key);if(!has$1(cache,address))cache[address]=func.apply(this,arguments);return cache[address]};memoize.cache={};return memoize}var delay=restArguments(function(func,wait,args){return setTimeout(function(){return func.apply(null,args)},wait)});var defer=partial(delay,_$1,1);function throttle(func,wait,options){var timeout,context,args,result;var previous=0;if(!options)options={};var later=function(){previous=options.leading===false?0:now();timeout=null;result=func.apply(context,args);if(!timeout)context=args=null};var throttled=function(){var _now=now();if(!previous&&options.leading===false)previous=_now;var remaining=wait-(_now-previous);context=this;args=arguments;if(remaining<=0||remaining>wait){if(timeout){clearTimeout(timeout);timeout=null}previous=_now;result=func.apply(context,args);if(!timeout)context=args=null}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result};throttled.cancel=function(){clearTimeout(timeout);previous=0;timeout=context=args=null};return throttled}function debounce(func,wait,immediate){var timeout,previous,args,result,context;var later=function(){var passed=now()-previous;if(wait>passed){timeout=setTimeout(later,wait-passed)}else{timeout=null;if(!immediate)result=func.apply(context,args);if(!timeout)args=context=null}};var debounced=restArguments(function(_args){context=this;args=_args;previous=now();if(!timeout){timeout=setTimeout(later,wait);if(immediate)result=func.apply(context,args)}return result});debounced.cancel=function(){clearTimeout(timeout);timeout=args=context=null};return debounced}function wrap(func,wrapper){return partial(wrapper,func)}function negate(predicate){return function(){return!predicate.apply(this,arguments)}}function compose(){var args=arguments;var start=args.length-1;return function(){var i=start;var result=args[start].apply(this,arguments);while(i--)result=args[i].call(this,result);return result}}function after(times,func){return function(){if(--times<1){return func.apply(this,arguments)}}}function before(times,func){var memo;return function(){if(--times>0){memo=func.apply(this,arguments)}if(times<=1)func=null;return memo}}var once=partial(before,2);function findKey(obj,predicate,context){predicate=cb(predicate,context);var _keys=keys(obj),key;for(var i=0,length=_keys.length;i<length;i++){key=_keys[i];if(predicate(obj[key],key,obj))return key}}function createPredicateIndexFinder(dir){return function(array,predicate,context){predicate=cb(predicate,context);var length=getLength(array);var index=dir>0?0:length-1;for(;index>=0&&index<length;index+=dir){if(predicate(array[index],index,array))return index}return-1}}var findIndex=createPredicateIndexFinder(1);var findLastIndex=createPredicateIndexFinder(-1);function sortedIndex(array,obj,iteratee,context){iteratee=cb(iteratee,context,1);var value=iteratee(obj);var low=0,high=getLength(array);while(low<high){var mid=Math.floor((low+high)/2);if(iteratee(array[mid])<value)low=mid+1;else high=mid}return low}function createIndexFinder(dir,predicateFind,sortedIndex){return function(array,item,idx){var i=0,length=getLength(array);if(typeof idx=="number"){if(dir>0){i=idx>=0?idx:Math.max(idx+length,i)}else{length=idx>=0?Math.min(idx+1,length):idx+length+1}}else if(sortedIndex&&idx&&length){idx=sortedIndex(array,item);return array[idx]===item?idx:-1}if(item!==item){idx=predicateFind(slice.call(array,i,length),isNaN$1);return idx>=0?idx+i:-1}for(idx=dir>0?i:length-1;idx>=0&&idx<length;idx+=dir){if(array[idx]===item)return idx}return-1}}var indexOf=createIndexFinder(1,findIndex,sortedIndex);var lastIndexOf=createIndexFinder(-1,findLastIndex);function find(obj,predicate,context){var keyFinder=isArrayLike(obj)?findIndex:findKey;var key=keyFinder(obj,predicate,context);if(key!==void 0&&key!==-1)return obj[key]}function findWhere(obj,attrs){return find(obj,matcher(attrs))}function each(obj,iteratee,context){iteratee=optimizeCb(iteratee,context);var i,length;if(isArrayLike(obj)){for(i=0,length=obj.length;i<length;i++){iteratee(obj[i],i,obj)}}else{var _keys=keys(obj);for(i=0,length=_keys.length;i<length;i++){iteratee(obj[_keys[i]],_keys[i],obj)}}return obj}function map(obj,iteratee,context){iteratee=cb(iteratee,context);var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length,results=Array(length);for(var index=0;index<length;index++){var currentKey=_keys?_keys[index]:index;results[index]=iteratee(obj[currentKey],currentKey,obj)}return results}function createReduce(dir){var reducer=function(obj,iteratee,memo,initial){var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length,index=dir>0?0:length-1;if(!initial){memo=obj[_keys?_keys[index]:index];index+=dir}for(;index>=0&&index<length;index+=dir){var currentKey=_keys?_keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo};return function(obj,iteratee,memo,context){var initial=arguments.length>=3;return reducer(obj,optimizeCb(iteratee,context,4),memo,initial)}}var reduce=createReduce(1);var reduceRight=createReduce(-1);function filter(obj,predicate,context){var results=[];predicate=cb(predicate,context);each(obj,function(value,index,list){if(predicate(value,index,list))results.push(value)});return results}function reject(obj,predicate,context){return filter(obj,negate(cb(predicate)),context)}function every(obj,predicate,context){predicate=cb(predicate,context);var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length;for(var index=0;index<length;index++){var currentKey=_keys?_keys[index]:index;if(!predicate(obj[currentKey],currentKey,obj))return false}return true}function some(obj,predicate,context){predicate=cb(predicate,context);var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length;for(var index=0;index<length;index++){var currentKey=_keys?_keys[index]:index;if(predicate(obj[currentKey],currentKey,obj))return true}return false}function contains(obj,item,fromIndex,guard){if(!isArrayLike(obj))obj=values(obj);if(typeof fromIndex!="number"||guard)fromIndex=0;return indexOf(obj,item,fromIndex)>=0}var invoke=restArguments(function(obj,path,args){var contextPath,func;if(isFunction$1(path)){func=path}else{path=toPath(path);contextPath=path.slice(0,-1);path=path[path.length-1]}return map(obj,function(context){var method=func;if(!method){if(contextPath&&contextPath.length){context=deepGet(context,contextPath)}if(context==null)return void 0;method=context[path]}return method==null?method:method.apply(context,args)})});function pluck(obj,key){return map(obj,property(key))}function where(obj,attrs){return filter(obj,matcher(attrs))}function max(obj,iteratee,context){var result=-Infinity,lastComputed=-Infinity,value,computed;if(iteratee==null||typeof iteratee=="number"&&typeof obj[0]!="object"&&obj!=null){obj=isArrayLike(obj)?obj:values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value!=null&&value>result){result=value}}}else{iteratee=cb(iteratee,context);each(obj,function(v,index,list){computed=iteratee(v,index,list);if(computed>lastComputed||computed===-Infinity&&result===-Infinity){result=v;lastComputed=computed}})}return result}function min(obj,iteratee,context){var result=Infinity,lastComputed=Infinity,value,computed;if(iteratee==null||typeof iteratee=="number"&&typeof obj[0]!="object"&&obj!=null){obj=isArrayLike(obj)?obj:values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value!=null&&value<result){result=value}}}else{iteratee=cb(iteratee,context);each(obj,function(v,index,list){computed=iteratee(v,index,list);if(computed<lastComputed||computed===Infinity&&result===Infinity){result=v;lastComputed=computed}})}return result}var reStrSymbol=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function toArray(obj){if(!obj)return[];if(isArray(obj))return slice.call(obj);if(isString(obj)){return obj.match(reStrSymbol)}if(isArrayLike(obj))return map(obj,identity);return values(obj)}function sample(obj,n,guard){if(n==null||guard){if(!isArrayLike(obj))obj=values(obj);return obj[random(obj.length-1)]}var sample=toArray(obj);var length=getLength(sample);n=Math.max(Math.min(n,length),0);var last=length-1;for(var index=0;index<n;index++){var rand=random(index,last);var temp=sample[index];sample[index]=sample[rand];sample[rand]=temp}return sample.slice(0,n)}function shuffle(obj){return sample(obj,Infinity)}function sortBy(obj,iteratee,context){var index=0;iteratee=cb(iteratee,context);return pluck(map(obj,function(value,key,list){return{value:value,index:index++,criteria:iteratee(value,key,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index-right.index}),"value")}function group(behavior,partition){return function(obj,iteratee,context){var result=partition?[[],[]]:{};iteratee=cb(iteratee,context);each(obj,function(value,index){var key=iteratee(value,index,obj);behavior(result,value,key)});return result}}var groupBy=group(function(result,value,key){if(has$1(result,key))result[key].push(value);else result[key]=[value]});var indexBy=group(function(result,value,key){result[key]=value});var countBy=group(function(result,value,key){if(has$1(result,key))result[key]++;else result[key]=1});var partition=group(function(result,value,pass){result[pass?0:1].push(value)},true);function size(obj){if(obj==null)return 0;return isArrayLike(obj)?obj.length:keys(obj).length}function keyInObj(value,key,obj){return key in obj}var pick=restArguments(function(obj,keys){var result={},iteratee=keys[0];if(obj==null)return result;if(isFunction$1(iteratee)){if(keys.length>1)iteratee=optimizeCb(iteratee,keys[1]);keys=allKeys(obj)}else{iteratee=keyInObj;keys=flatten$1(keys,false,false);obj=Object(obj)}for(var i=0,length=keys.length;i<length;i++){var key=keys[i];var value=obj[key];if(iteratee(value,key,obj))result[key]=value}return result});var omit=restArguments(function(obj,keys){var iteratee=keys[0],context;if(isFunction$1(iteratee)){iteratee=negate(iteratee);if(keys.length>1)context=keys[1]}else{keys=map(flatten$1(keys,false,false),String);iteratee=function(value,key){return!contains(keys,key)}}return pick(obj,iteratee,context)});function initial(array,n,guard){return slice.call(array,0,Math.max(0,array.length-(n==null||guard?1:n)))}function first(array,n,guard){if(array==null||array.length<1)return n==null||guard?void 0:[];if(n==null||guard)return array[0];return initial(array,array.length-n)}function rest(array,n,guard){return slice.call(array,n==null||guard?1:n)}function last(array,n,guard){if(array==null||array.length<1)return n==null||guard?void 0:[];if(n==null||guard)return array[array.length-1];return rest(array,Math.max(0,array.length-n))}function compact(array){return filter(array,Boolean)}function flatten(array,depth){return flatten$1(array,depth,false)}var difference=restArguments(function(array,rest){rest=flatten$1(rest,true,true);return filter(array,function(value){return!contains(rest,value)})});var without=restArguments(function(array,otherArrays){return difference(array,otherArrays)});function uniq(array,isSorted,iteratee,context){if(!isBoolean(isSorted)){context=iteratee;iteratee=isSorted;isSorted=false}if(iteratee!=null)iteratee=cb(iteratee,context);var result=[];var seen=[];for(var i=0,length=getLength(array);i<length;i++){var value=array[i],computed=iteratee?iteratee(value,i,array):value;if(isSorted&&!iteratee){if(!i||seen!==computed)result.push(value);seen=computed}else if(iteratee){if(!contains(seen,computed)){seen.push(computed);result.push(value)}}else if(!contains(result,value)){result.push(value)}}return result}var union=restArguments(function(arrays){return uniq(flatten$1(arrays,true,true))});function intersection(array){var result=[];var argsLength=arguments.length;for(var i=0,length=getLength(array);i<length;i++){var item=array[i];if(contains(result,item))continue;var j;for(j=1;j<argsLength;j++){if(!contains(arguments[j],item))break}if(j===argsLength)result.push(item)}return result}function unzip(array){var length=array&&max(array,getLength).length||0;var result=Array(length);for(var index=0;index<length;index++){result[index]=pluck(array,index)}return result}var zip=restArguments(unzip);function object(list,values){var result={};for(var i=0,length=getLength(list);i<length;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result}function range(start,stop,step){if(stop==null){stop=start||0;start=0}if(!step){step=stop<start?-1:1}var length=Math.max(Math.ceil((stop-start)/step),0);var range=Array(length);for(var idx=0;idx<length;idx++,start+=step){range[idx]=start}return range}function chunk(array,count){if(count==null||count<1)return[];var result=[];var i=0,length=array.length;while(i<length){result.push(slice.call(array,i,i+=count))}return result}function chainResult(instance,obj){return instance._chain?_$1(obj).chain():obj}function mixin(obj){each(functions(obj),function(name){var func=_$1[name]=obj[name];_$1.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return chainResult(this,func.apply(_$1,args))}});return _$1}each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_$1.prototype[name]=function(){var obj=this._wrapped;if(obj!=null){method.apply(obj,arguments);if((name==="shift"||name==="splice")&&obj.length===0){delete obj[0]}}return chainResult(this,obj)}});each(["concat","join","slice"],function(name){var method=ArrayProto[name];_$1.prototype[name]=function(){var obj=this._wrapped;if(obj!=null)obj=method.apply(obj,arguments);return chainResult(this,obj)}});var allExports={__proto__:null,VERSION:VERSION,restArguments:restArguments,isObject:isObject,isNull:isNull,isUndefined:isUndefined,isBoolean:isBoolean,isElement:isElement,isString:isString,isNumber:isNumber,isDate:isDate,isRegExp:isRegExp,isError:isError,isSymbol:isSymbol,isArrayBuffer:isArrayBuffer,isDataView:isDataView$1,isArray:isArray,isFunction:isFunction$1,isArguments:isArguments$1,isFinite:isFinite$1,isNaN:isNaN$1,isTypedArray:isTypedArray$1,isEmpty:isEmpty,isMatch:isMatch,isEqual:isEqual,isMap:isMap,isWeakMap:isWeakMap,isSet:isSet,isWeakSet:isWeakSet,keys:keys,allKeys:allKeys,values:values,pairs:pairs,invert:invert,functions:functions,methods:functions,extend:extend,extendOwn:extendOwn,assign:extendOwn,defaults:defaults,create:create,clone:clone,tap:tap,get:get,has:has,mapObject:mapObject,identity:identity,constant:constant,noop:noop,toPath:toPath$1,property:property,propertyOf:propertyOf,matcher:matcher,matches:matcher,times:times,random:random,now:now,escape:_escape,unescape:_unescape,templateSettings:templateSettings,template:template,result:result,uniqueId:uniqueId,chain:chain,iteratee:iteratee,partial:partial,bind:bind,bindAll:bindAll,memoize:memoize,delay:delay,defer:defer,throttle:throttle,debounce:debounce,wrap:wrap,negate:negate,compose:compose,after:after,before:before,once:once,findKey:findKey,findIndex:findIndex,findLastIndex:findLastIndex,sortedIndex:sortedIndex,indexOf:indexOf,lastIndexOf:lastIndexOf,find:find,detect:find,findWhere:findWhere,each:each,forEach:each,map:map,collect:map,reduce:reduce,foldl:reduce,inject:reduce,reduceRight:reduceRight,foldr:reduceRight,filter:filter,select:filter,reject:reject,every:every,all:every,some:some,any:some,contains:contains,includes:contains,include:contains,invoke:invoke,pluck:pluck,where:where,max:max,min:min,shuffle:shuffle,sample:sample,sortBy:sortBy,groupBy:groupBy,indexBy:indexBy,countBy:countBy,partition:partition,toArray:toArray,size:size,pick:pick,omit:omit,first:first,head:first,take:first,initial:initial,last:last,rest:rest,tail:rest,drop:rest,compact:compact,flatten:flatten,without:without,uniq:uniq,unique:uniq,union:union,intersection:intersection,difference:difference,unzip:unzip,transpose:unzip,zip:zip,object:object,range:range,chunk:chunk,mixin:mixin,default:_$1};var _=mixin(allExports);_._=_;return _})},{}],311:[function(require,module,exports){"use strict";var ensureString=require("type/string/ensure"),uniGlobal=require("./lib/uni-global");var objHasOwnProperty=Object.prototype.hasOwnProperty;module.exports=function(key){key=ensureString(key,{name:"key"});if(objHasOwnProperty.call(uniGlobal,key))return uniGlobal[key];var value=Object.create?Object.create(null):{};uniGlobal[key]=value;return value}},{"./lib/uni-global":313,"type/string/ensure":307}],312:[function(require,module,exports){"use strict";if(!Object.defineProperty||!Object.create)module.exports="3";else if(typeof Symbol==="function"&&Symbol["for"])module.exports="2015+";else module.exports="5"},{}],313:[function(require,module,exports){"use strict";var esEnvType=require("./es-env-type");switch(esEnvType){case"3":if(EvalError.$ug202109){module.exports=EvalError.$ug202109;return}module.exports=EvalError.$ug202109={};return;case"5":if(EvalError.$uniGlobal202109){module.exports=EvalError.$uniGlobal202109;return}Object.defineProperty(EvalError,"$uniGlobal202109",{value:module.exports=Object.create(null)});return;case"2015+":var uniGlobalSymbol=Symbol["for"]("$uniGlobal202109");if(EvalError[uniGlobalSymbol]){module.exports=EvalError[uniGlobalSymbol];return}Object.defineProperty(EvalError,uniGlobalSymbol,{value:module.exports=Object.create(null)});return;default:throw new Error("Unrecognized environment type: "+esEnvType)}},{"./es-env-type":312}],314:[function(require,module,exports){
/*!
 * unpipe
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";module.exports=unpipe;function hasPipeDataListeners(stream){var listeners=stream.listeners("data");for(var i=0;i<listeners.length;i++){if(listeners[i].name==="ondata"){return true}}return false}function unpipe(stream){if(!stream){throw new TypeError("argument stream is required")}if(typeof stream.unpipe==="function"){stream.unpipe();return}if(!hasPipeDataListeners(stream)){return}var listener;var listeners=stream.listeners("close");for(var i=0;i<listeners.length;i++){listener=listeners[i];if(listener.name!=="cleanup"&&listener.name!=="onclose"){continue}listener.call(stream)}}},{}],315:[function(require,module,exports){exports=module.exports=function(a,b){if(a&&b){for(var key in b){a[key]=b[key]}}return a}},{}],316:[function(require,module,exports){
/*!
 * vary
 * Copyright(c) 2014-2017 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";module.exports=vary;module.exports.append=append;var FIELD_NAME_REGEXP=/^[!#$%&'*+\-.^_`|~0-9A-Za-z]+$/;function append(header,field){if(typeof header!=="string"){throw new TypeError("header argument is required")}if(!field){throw new TypeError("field argument is required")}var fields=!Array.isArray(field)?parse(String(field)):field;for(var j=0;j<fields.length;j++){if(!FIELD_NAME_REGEXP.test(fields[j])){throw new TypeError("field argument contains an invalid header name")}}if(header==="*"){return header}var val=header;var vals=parse(header.toLowerCase());if(fields.indexOf("*")!==-1||vals.indexOf("*")!==-1){return"*"}for(var i=0;i<fields.length;i++){var fld=fields[i].toLowerCase();if(vals.indexOf(fld)===-1){vals.push(fld);val=val?val+", "+fields[i]:fields[i]}}return val}function parse(header){var end=0;var list=[];var start=0;for(var i=0,len=header.length;i<len;i++){switch(header.charCodeAt(i)){case 32:if(start===end){start=end=i+1}break;case 44:list.push(header.substring(start,end));start=end=i+1;break;default:end=i+1;break}}list.push(header.substring(start,end));return list}function vary(res,field){if(!res||!res.getHeader||!res.setHeader){throw new TypeError("res argument is required")}var val=res.getHeader("Vary")||"";var header=Array.isArray(val)?val.join(", "):String(val);if(val=append(header,field)){res.setHeader("Vary",val)}}},{}],317:[function(require,module,exports){"use strict";const WebSocket=require("./lib/websocket");WebSocket.createWebSocketStream=require("./lib/stream");WebSocket.Server=require("./lib/websocket-server");WebSocket.Receiver=require("./lib/receiver");WebSocket.Sender=require("./lib/sender");WebSocket.WebSocket=WebSocket;WebSocket.WebSocketServer=WebSocket.Server;module.exports=WebSocket},{"./lib/receiver":324,"./lib/sender":325,"./lib/stream":326,"./lib/websocket":330,"./lib/websocket-server":329}],318:[function(require,module,exports){"use strict";const{EMPTY_BUFFER:EMPTY_BUFFER}=require("./constants");const FastBuffer=Buffer[Symbol.species];function concat(list,totalLength){if(list.length===0)return EMPTY_BUFFER;if(list.length===1)return list[0];const target=Buffer.allocUnsafe(totalLength);let offset=0;for(let i=0;i<list.length;i++){const buf=list[i];target.set(buf,offset);offset+=buf.length}if(offset<totalLength){return new FastBuffer(target.buffer,target.byteOffset,offset)}return target}function _mask(source,mask,output,offset,length){for(let i=0;i<length;i++){output[offset+i]=source[i]^mask[i&3]}}function _unmask(buffer,mask){for(let i=0;i<buffer.length;i++){buffer[i]^=mask[i&3]}}function toArrayBuffer(buf){if(buf.length===buf.buffer.byteLength){return buf.buffer}return buf.buffer.slice(buf.byteOffset,buf.byteOffset+buf.length)}function toBuffer(data){toBuffer.readOnly=true;if(Buffer.isBuffer(data))return data;let buf;if(data instanceof ArrayBuffer){buf=new FastBuffer(data)}else if(ArrayBuffer.isView(data)){buf=new FastBuffer(data.buffer,data.byteOffset,data.byteLength)}else{buf=Buffer.from(data);toBuffer.readOnly=false}return buf}module.exports={concat:concat,mask:_mask,toArrayBuffer:toArrayBuffer,toBuffer:toBuffer,unmask:_unmask};if(!process.env.WS_NO_BUFFER_UTIL){try{const bufferUtil=require("bufferutil");module.exports.mask=function(source,mask,output,offset,length){if(length<48)_mask(source,mask,output,offset,length);else bufferUtil.mask(source,mask,output,offset,length)};module.exports.unmask=function(buffer,mask){if(buffer.length<32)_unmask(buffer,mask);else bufferUtil.unmask(buffer,mask)}}catch(e){}}},{"./constants":319,bufferutil:undefined}],319:[function(require,module,exports){"use strict";module.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}},{}],320:[function(require,module,exports){"use strict";const{kForOnEventAttribute:kForOnEventAttribute,kListener:kListener}=require("./constants");const kCode=Symbol("kCode");const kData=Symbol("kData");const kError=Symbol("kError");const kMessage=Symbol("kMessage");const kReason=Symbol("kReason");const kTarget=Symbol("kTarget");const kType=Symbol("kType");const kWasClean=Symbol("kWasClean");class Event{constructor(type){this[kTarget]=null;this[kType]=type}get target(){return this[kTarget]}get type(){return this[kType]}}Object.defineProperty(Event.prototype,"target",{enumerable:true});Object.defineProperty(Event.prototype,"type",{enumerable:true});class CloseEvent extends Event{constructor(type,options={}){super(type);this[kCode]=options.code===undefined?0:options.code;this[kReason]=options.reason===undefined?"":options.reason;this[kWasClean]=options.wasClean===undefined?false:options.wasClean}get code(){return this[kCode]}get reason(){return this[kReason]}get wasClean(){return this[kWasClean]}}Object.defineProperty(CloseEvent.prototype,"code",{enumerable:true});Object.defineProperty(CloseEvent.prototype,"reason",{enumerable:true});Object.defineProperty(CloseEvent.prototype,"wasClean",{enumerable:true});class ErrorEvent extends Event{constructor(type,options={}){super(type);this[kError]=options.error===undefined?null:options.error;this[kMessage]=options.message===undefined?"":options.message}get error(){return this[kError]}get message(){return this[kMessage]}}Object.defineProperty(ErrorEvent.prototype,"error",{enumerable:true});Object.defineProperty(ErrorEvent.prototype,"message",{enumerable:true});class MessageEvent extends Event{constructor(type,options={}){super(type);this[kData]=options.data===undefined?null:options.data}get data(){return this[kData]}}Object.defineProperty(MessageEvent.prototype,"data",{enumerable:true});const EventTarget={addEventListener(type,handler,options={}){for(const listener of this.listeners(type)){if(!options[kForOnEventAttribute]&&listener[kListener]===handler&&!listener[kForOnEventAttribute]){return}}let wrapper;if(type==="message"){wrapper=function onMessage(data,isBinary){const event=new MessageEvent("message",{data:isBinary?data:data.toString()});event[kTarget]=this;callListener(handler,this,event)}}else if(type==="close"){wrapper=function onClose(code,message){const event=new CloseEvent("close",{code:code,reason:message.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});event[kTarget]=this;callListener(handler,this,event)}}else if(type==="error"){wrapper=function onError(error){const event=new ErrorEvent("error",{error:error,message:error.message});event[kTarget]=this;callListener(handler,this,event)}}else if(type==="open"){wrapper=function onOpen(){const event=new Event("open");event[kTarget]=this;callListener(handler,this,event)}}else{return}wrapper[kForOnEventAttribute]=!!options[kForOnEventAttribute];wrapper[kListener]=handler;if(options.once){this.once(type,wrapper)}else{this.on(type,wrapper)}},removeEventListener(type,handler){for(const listener of this.listeners(type)){if(listener[kListener]===handler&&!listener[kForOnEventAttribute]){this.removeListener(type,listener);break}}}};module.exports={CloseEvent:CloseEvent,ErrorEvent:ErrorEvent,Event:Event,EventTarget:EventTarget,MessageEvent:MessageEvent};function callListener(listener,thisArg,event){if(typeof listener==="object"&&listener.handleEvent){listener.handleEvent.call(listener,event)}else{listener.call(thisArg,event)}}},{"./constants":319}],321:[function(require,module,exports){"use strict";const{tokenChars:tokenChars}=require("./validation");function push(dest,name,elem){if(dest[name]===undefined)dest[name]=[elem];else dest[name].push(elem)}function parse(header){const offers=Object.create(null);let params=Object.create(null);let mustUnescape=false;let isEscaping=false;let inQuotes=false;let extensionName;let paramName;let start=-1;let code=-1;let end=-1;let i=0;for(;i<header.length;i++){code=header.charCodeAt(i);if(extensionName===undefined){if(end===-1&&tokenChars[code]===1){if(start===-1)start=i}else if(i!==0&&(code===32||code===9)){if(end===-1&&start!==-1)end=i}else if(code===59||code===44){if(start===-1){throw new SyntaxError(`Unexpected character at index ${i}`)}if(end===-1)end=i;const name=header.slice(start,end);if(code===44){push(offers,name,params);params=Object.create(null)}else{extensionName=name}start=end=-1}else{throw new SyntaxError(`Unexpected character at index ${i}`)}}else if(paramName===undefined){if(end===-1&&tokenChars[code]===1){if(start===-1)start=i}else if(code===32||code===9){if(end===-1&&start!==-1)end=i}else if(code===59||code===44){if(start===-1){throw new SyntaxError(`Unexpected character at index ${i}`)}if(end===-1)end=i;push(params,header.slice(start,end),true);if(code===44){push(offers,extensionName,params);params=Object.create(null);extensionName=undefined}start=end=-1}else if(code===61&&start!==-1&&end===-1){paramName=header.slice(start,i);start=end=-1}else{throw new SyntaxError(`Unexpected character at index ${i}`)}}else{if(isEscaping){if(tokenChars[code]!==1){throw new SyntaxError(`Unexpected character at index ${i}`)}if(start===-1)start=i;else if(!mustUnescape)mustUnescape=true;isEscaping=false}else if(inQuotes){if(tokenChars[code]===1){if(start===-1)start=i}else if(code===34&&start!==-1){inQuotes=false;end=i}else if(code===92){isEscaping=true}else{throw new SyntaxError(`Unexpected character at index ${i}`)}}else if(code===34&&header.charCodeAt(i-1)===61){inQuotes=true}else if(end===-1&&tokenChars[code]===1){if(start===-1)start=i}else if(start!==-1&&(code===32||code===9)){if(end===-1)end=i}else if(code===59||code===44){if(start===-1){throw new SyntaxError(`Unexpected character at index ${i}`)}if(end===-1)end=i;let value=header.slice(start,end);if(mustUnescape){value=value.replace(/\\/g,"");mustUnescape=false}push(params,paramName,value);if(code===44){push(offers,extensionName,params);params=Object.create(null);extensionName=undefined}paramName=undefined;start=end=-1}else{throw new SyntaxError(`Unexpected character at index ${i}`)}}}if(start===-1||inQuotes||code===32||code===9){throw new SyntaxError("Unexpected end of input")}if(end===-1)end=i;const token=header.slice(start,end);if(extensionName===undefined){push(offers,token,params)}else{if(paramName===undefined){push(params,token,true)}else if(mustUnescape){push(params,paramName,token.replace(/\\/g,""))}else{push(params,paramName,token)}push(offers,extensionName,params)}return offers}function format(extensions){return Object.keys(extensions).map(extension=>{let configurations=extensions[extension];if(!Array.isArray(configurations))configurations=[configurations];return configurations.map(params=>[extension].concat(Object.keys(params).map(k=>{let values=params[k];if(!Array.isArray(values))values=[values];return values.map(v=>v===true?k:`${k}=${v}`).join("; ")})).join("; ")).join(", ")}).join(", ")}module.exports={format:format,parse:parse}},{"./validation":328}],322:[function(require,module,exports){"use strict";const kDone=Symbol("kDone");const kRun=Symbol("kRun");class Limiter{constructor(concurrency){this[kDone]=()=>{this.pending--;this[kRun]()};this.concurrency=concurrency||Infinity;this.jobs=[];this.pending=0}add(job){this.jobs.push(job);this[kRun]()}[kRun](){if(this.pending===this.concurrency)return;if(this.jobs.length){const job=this.jobs.shift();this.pending++;job(this[kDone])}}}module.exports=Limiter},{}],323:[function(require,module,exports){"use strict";const zlib=require("zlib");const bufferUtil=require("./buffer-util");const Limiter=require("./limiter");const{kStatusCode:kStatusCode}=require("./constants");const FastBuffer=Buffer[Symbol.species];const TRAILER=Buffer.from([0,0,255,255]);const kPerMessageDeflate=Symbol("permessage-deflate");const kTotalLength=Symbol("total-length");const kCallback=Symbol("callback");const kBuffers=Symbol("buffers");const kError=Symbol("error");let zlibLimiter;class PerMessageDeflate{constructor(options,isServer,maxPayload){this._maxPayload=maxPayload|0;this._options=options||{};this._threshold=this._options.threshold!==undefined?this._options.threshold:1024;this._isServer=!!isServer;this._deflate=null;this._inflate=null;this.params=null;if(!zlibLimiter){const concurrency=this._options.concurrencyLimit!==undefined?this._options.concurrencyLimit:10;zlibLimiter=new Limiter(concurrency)}}static get extensionName(){return"permessage-deflate"}offer(){const params={};if(this._options.serverNoContextTakeover){params.server_no_context_takeover=true}if(this._options.clientNoContextTakeover){params.client_no_context_takeover=true}if(this._options.serverMaxWindowBits){params.server_max_window_bits=this._options.serverMaxWindowBits}if(this._options.clientMaxWindowBits){params.client_max_window_bits=this._options.clientMaxWindowBits}else if(this._options.clientMaxWindowBits==null){params.client_max_window_bits=true}return params}accept(configurations){configurations=this.normalizeParams(configurations);this.params=this._isServer?this.acceptAsServer(configurations):this.acceptAsClient(configurations);return this.params}cleanup(){if(this._inflate){this._inflate.close();this._inflate=null}if(this._deflate){const callback=this._deflate[kCallback];this._deflate.close();this._deflate=null;if(callback){callback(new Error("The deflate stream was closed while data was being processed"))}}}acceptAsServer(offers){const opts=this._options;const accepted=offers.find(params=>{if(opts.serverNoContextTakeover===false&&params.server_no_context_takeover||params.server_max_window_bits&&(opts.serverMaxWindowBits===false||typeof opts.serverMaxWindowBits==="number"&&opts.serverMaxWindowBits>params.server_max_window_bits)||typeof opts.clientMaxWindowBits==="number"&&!params.client_max_window_bits){return false}return true});if(!accepted){throw new Error("None of the extension offers can be accepted")}if(opts.serverNoContextTakeover){accepted.server_no_context_takeover=true}if(opts.clientNoContextTakeover){accepted.client_no_context_takeover=true}if(typeof opts.serverMaxWindowBits==="number"){accepted.server_max_window_bits=opts.serverMaxWindowBits}if(typeof opts.clientMaxWindowBits==="number"){accepted.client_max_window_bits=opts.clientMaxWindowBits}else if(accepted.client_max_window_bits===true||opts.clientMaxWindowBits===false){delete accepted.client_max_window_bits}return accepted}acceptAsClient(response){const params=response[0];if(this._options.clientNoContextTakeover===false&&params.client_no_context_takeover){throw new Error('Unexpected parameter "client_no_context_takeover"')}if(!params.client_max_window_bits){if(typeof this._options.clientMaxWindowBits==="number"){params.client_max_window_bits=this._options.clientMaxWindowBits}}else if(this._options.clientMaxWindowBits===false||typeof this._options.clientMaxWindowBits==="number"&&params.client_max_window_bits>this._options.clientMaxWindowBits){throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}return params}normalizeParams(configurations){configurations.forEach(params=>{Object.keys(params).forEach(key=>{let value=params[key];if(value.length>1){throw new Error(`Parameter "${key}" must have only a single value`)}value=value[0];if(key==="client_max_window_bits"){if(value!==true){const num=+value;if(!Number.isInteger(num)||num<8||num>15){throw new TypeError(`Invalid value for parameter "${key}": ${value}`)}value=num}else if(!this._isServer){throw new TypeError(`Invalid value for parameter "${key}": ${value}`)}}else if(key==="server_max_window_bits"){const num=+value;if(!Number.isInteger(num)||num<8||num>15){throw new TypeError(`Invalid value for parameter "${key}": ${value}`)}value=num}else if(key==="client_no_context_takeover"||key==="server_no_context_takeover"){if(value!==true){throw new TypeError(`Invalid value for parameter "${key}": ${value}`)}}else{throw new Error(`Unknown parameter "${key}"`)}params[key]=value})});return configurations}decompress(data,fin,callback){zlibLimiter.add(done=>{this._decompress(data,fin,(err,result)=>{done();callback(err,result)})})}compress(data,fin,callback){zlibLimiter.add(done=>{this._compress(data,fin,(err,result)=>{done();callback(err,result)})})}_decompress(data,fin,callback){const endpoint=this._isServer?"client":"server";if(!this._inflate){const key=`${endpoint}_max_window_bits`;const windowBits=typeof this.params[key]!=="number"?zlib.Z_DEFAULT_WINDOWBITS:this.params[key];this._inflate=zlib.createInflateRaw({...this._options.zlibInflateOptions,windowBits:windowBits});this._inflate[kPerMessageDeflate]=this;this._inflate[kTotalLength]=0;this._inflate[kBuffers]=[];this._inflate.on("error",inflateOnError);this._inflate.on("data",inflateOnData)}this._inflate[kCallback]=callback;this._inflate.write(data);if(fin)this._inflate.write(TRAILER);this._inflate.flush(()=>{const err=this._inflate[kError];if(err){this._inflate.close();this._inflate=null;callback(err);return}const data=bufferUtil.concat(this._inflate[kBuffers],this._inflate[kTotalLength]);if(this._inflate._readableState.endEmitted){this._inflate.close();this._inflate=null}else{this._inflate[kTotalLength]=0;this._inflate[kBuffers]=[];if(fin&&this.params[`${endpoint}_no_context_takeover`]){this._inflate.reset()}}callback(null,data)})}_compress(data,fin,callback){const endpoint=this._isServer?"server":"client";if(!this._deflate){const key=`${endpoint}_max_window_bits`;const windowBits=typeof this.params[key]!=="number"?zlib.Z_DEFAULT_WINDOWBITS:this.params[key];this._deflate=zlib.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:windowBits});this._deflate[kTotalLength]=0;this._deflate[kBuffers]=[];this._deflate.on("data",deflateOnData)}this._deflate[kCallback]=callback;this._deflate.write(data);this._deflate.flush(zlib.Z_SYNC_FLUSH,()=>{if(!this._deflate){return}let data=bufferUtil.concat(this._deflate[kBuffers],this._deflate[kTotalLength]);if(fin){data=new FastBuffer(data.buffer,data.byteOffset,data.length-4)}this._deflate[kCallback]=null;this._deflate[kTotalLength]=0;this._deflate[kBuffers]=[];if(fin&&this.params[`${endpoint}_no_context_takeover`]){this._deflate.reset()}callback(null,data)})}}module.exports=PerMessageDeflate;function deflateOnData(chunk){this[kBuffers].push(chunk);this[kTotalLength]+=chunk.length}function inflateOnData(chunk){this[kTotalLength]+=chunk.length;if(this[kPerMessageDeflate]._maxPayload<1||this[kTotalLength]<=this[kPerMessageDeflate]._maxPayload){this[kBuffers].push(chunk);return}this[kError]=new RangeError("Max payload size exceeded");this[kError].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH";this[kError][kStatusCode]=1009;this.removeListener("data",inflateOnData);this.reset()}function inflateOnError(err){this[kPerMessageDeflate]._inflate=null;err[kStatusCode]=1007;this[kCallback](err)}},{"./buffer-util":318,"./constants":319,"./limiter":322,zlib:undefined}],324:[function(require,module,exports){"use strict";const{Writable:Writable}=require("stream");const PerMessageDeflate=require("./permessage-deflate");const{BINARY_TYPES:BINARY_TYPES,EMPTY_BUFFER:EMPTY_BUFFER,kStatusCode:kStatusCode,kWebSocket:kWebSocket}=require("./constants");const{concat:concat,toArrayBuffer:toArrayBuffer,unmask:unmask}=require("./buffer-util");const{isValidStatusCode:isValidStatusCode,isValidUTF8:isValidUTF8}=require("./validation");const FastBuffer=Buffer[Symbol.species];const GET_INFO=0;const GET_PAYLOAD_LENGTH_16=1;const GET_PAYLOAD_LENGTH_64=2;const GET_MASK=3;const GET_DATA=4;const INFLATING=5;const DEFER_EVENT=6;class Receiver extends Writable{constructor(options={}){super();this._allowSynchronousEvents=options.allowSynchronousEvents!==undefined?options.allowSynchronousEvents:true;this._binaryType=options.binaryType||BINARY_TYPES[0];this._extensions=options.extensions||{};this._isServer=!!options.isServer;this._maxPayload=options.maxPayload|0;this._skipUTF8Validation=!!options.skipUTF8Validation;this[kWebSocket]=undefined;this._bufferedBytes=0;this._buffers=[];this._compressed=false;this._payloadLength=0;this._mask=undefined;this._fragmented=0;this._masked=false;this._fin=false;this._opcode=0;this._totalPayloadLength=0;this._messageLength=0;this._fragments=[];this._errored=false;this._loop=false;this._state=GET_INFO}_write(chunk,encoding,cb){if(this._opcode===8&&this._state==GET_INFO)return cb();this._bufferedBytes+=chunk.length;this._buffers.push(chunk);this.startLoop(cb)}consume(n){this._bufferedBytes-=n;if(n===this._buffers[0].length)return this._buffers.shift();if(n<this._buffers[0].length){const buf=this._buffers[0];this._buffers[0]=new FastBuffer(buf.buffer,buf.byteOffset+n,buf.length-n);return new FastBuffer(buf.buffer,buf.byteOffset,n)}const dst=Buffer.allocUnsafe(n);do{const buf=this._buffers[0];const offset=dst.length-n;if(n>=buf.length){dst.set(this._buffers.shift(),offset)}else{dst.set(new Uint8Array(buf.buffer,buf.byteOffset,n),offset);this._buffers[0]=new FastBuffer(buf.buffer,buf.byteOffset+n,buf.length-n)}n-=buf.length}while(n>0);return dst}startLoop(cb){this._loop=true;do{switch(this._state){case GET_INFO:this.getInfo(cb);break;case GET_PAYLOAD_LENGTH_16:this.getPayloadLength16(cb);break;case GET_PAYLOAD_LENGTH_64:this.getPayloadLength64(cb);break;case GET_MASK:this.getMask();break;case GET_DATA:this.getData(cb);break;case INFLATING:case DEFER_EVENT:this._loop=false;return}}while(this._loop);if(!this._errored)cb()}getInfo(cb){if(this._bufferedBytes<2){this._loop=false;return}const buf=this.consume(2);if((buf[0]&48)!==0){const error=this.createError(RangeError,"RSV2 and RSV3 must be clear",true,1002,"WS_ERR_UNEXPECTED_RSV_2_3");cb(error);return}const compressed=(buf[0]&64)===64;if(compressed&&!this._extensions[PerMessageDeflate.extensionName]){const error=this.createError(RangeError,"RSV1 must be clear",true,1002,"WS_ERR_UNEXPECTED_RSV_1");cb(error);return}this._fin=(buf[0]&128)===128;this._opcode=buf[0]&15;this._payloadLength=buf[1]&127;if(this._opcode===0){if(compressed){const error=this.createError(RangeError,"RSV1 must be clear",true,1002,"WS_ERR_UNEXPECTED_RSV_1");cb(error);return}if(!this._fragmented){const error=this.createError(RangeError,"invalid opcode 0",true,1002,"WS_ERR_INVALID_OPCODE");cb(error);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){const error=this.createError(RangeError,`invalid opcode ${this._opcode}`,true,1002,"WS_ERR_INVALID_OPCODE");cb(error);return}this._compressed=compressed}else if(this._opcode>7&&this._opcode<11){if(!this._fin){const error=this.createError(RangeError,"FIN must be set",true,1002,"WS_ERR_EXPECTED_FIN");cb(error);return}if(compressed){const error=this.createError(RangeError,"RSV1 must be clear",true,1002,"WS_ERR_UNEXPECTED_RSV_1");cb(error);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){const error=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,true,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");cb(error);return}}else{const error=this.createError(RangeError,`invalid opcode ${this._opcode}`,true,1002,"WS_ERR_INVALID_OPCODE");cb(error);return}if(!this._fin&&!this._fragmented)this._fragmented=this._opcode;this._masked=(buf[1]&128)===128;if(this._isServer){if(!this._masked){const error=this.createError(RangeError,"MASK must be set",true,1002,"WS_ERR_EXPECTED_MASK");cb(error);return}}else if(this._masked){const error=this.createError(RangeError,"MASK must be clear",true,1002,"WS_ERR_UNEXPECTED_MASK");cb(error);return}if(this._payloadLength===126)this._state=GET_PAYLOAD_LENGTH_16;else if(this._payloadLength===127)this._state=GET_PAYLOAD_LENGTH_64;else this.haveLength(cb)}getPayloadLength16(cb){if(this._bufferedBytes<2){this._loop=false;return}this._payloadLength=this.consume(2).readUInt16BE(0);this.haveLength(cb)}getPayloadLength64(cb){if(this._bufferedBytes<8){this._loop=false;return}const buf=this.consume(8);const num=buf.readUInt32BE(0);if(num>Math.pow(2,53-32)-1){const error=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",false,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");cb(error);return}this._payloadLength=num*Math.pow(2,32)+buf.readUInt32BE(4);this.haveLength(cb)}haveLength(cb){if(this._payloadLength&&this._opcode<8){this._totalPayloadLength+=this._payloadLength;if(this._totalPayloadLength>this._maxPayload&&this._maxPayload>0){const error=this.createError(RangeError,"Max payload size exceeded",false,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");cb(error);return}}if(this._masked)this._state=GET_MASK;else this._state=GET_DATA}getMask(){if(this._bufferedBytes<4){this._loop=false;return}this._mask=this.consume(4);this._state=GET_DATA}getData(cb){let data=EMPTY_BUFFER;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=false;return}data=this.consume(this._payloadLength);if(this._masked&&(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])!==0){unmask(data,this._mask)}}if(this._opcode>7){this.controlMessage(data,cb);return}if(this._compressed){this._state=INFLATING;this.decompress(data,cb);return}if(data.length){this._messageLength=this._totalPayloadLength;this._fragments.push(data)}this.dataMessage(cb)}decompress(data,cb){const perMessageDeflate=this._extensions[PerMessageDeflate.extensionName];perMessageDeflate.decompress(data,this._fin,(err,buf)=>{if(err)return cb(err);if(buf.length){this._messageLength+=buf.length;if(this._messageLength>this._maxPayload&&this._maxPayload>0){const error=this.createError(RangeError,"Max payload size exceeded",false,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");cb(error);return}this._fragments.push(buf)}this.dataMessage(cb);if(this._state===GET_INFO)this.startLoop(cb)})}dataMessage(cb){if(!this._fin){this._state=GET_INFO;return}const messageLength=this._messageLength;const fragments=this._fragments;this._totalPayloadLength=0;this._messageLength=0;this._fragmented=0;this._fragments=[];if(this._opcode===2){let data;if(this._binaryType==="nodebuffer"){data=concat(fragments,messageLength)}else if(this._binaryType==="arraybuffer"){data=toArrayBuffer(concat(fragments,messageLength))}else{data=fragments}if(this._allowSynchronousEvents){this.emit("message",data,true);this._state=GET_INFO}else{this._state=DEFER_EVENT;setImmediate(()=>{this.emit("message",data,true);this._state=GET_INFO;this.startLoop(cb)})}}else{const buf=concat(fragments,messageLength);if(!this._skipUTF8Validation&&!isValidUTF8(buf)){const error=this.createError(Error,"invalid UTF-8 sequence",true,1007,"WS_ERR_INVALID_UTF8");cb(error);return}if(this._state===INFLATING||this._allowSynchronousEvents){this.emit("message",buf,false);this._state=GET_INFO}else{this._state=DEFER_EVENT;setImmediate(()=>{this.emit("message",buf,false);this._state=GET_INFO;this.startLoop(cb)})}}}controlMessage(data,cb){if(this._opcode===8){if(data.length===0){this._loop=false;this.emit("conclude",1005,EMPTY_BUFFER);this.end()}else{const code=data.readUInt16BE(0);if(!isValidStatusCode(code)){const error=this.createError(RangeError,`invalid status code ${code}`,true,1002,"WS_ERR_INVALID_CLOSE_CODE");cb(error);return}const buf=new FastBuffer(data.buffer,data.byteOffset+2,data.length-2);if(!this._skipUTF8Validation&&!isValidUTF8(buf)){const error=this.createError(Error,"invalid UTF-8 sequence",true,1007,"WS_ERR_INVALID_UTF8");cb(error);return}this._loop=false;this.emit("conclude",code,buf);this.end()}this._state=GET_INFO;return}if(this._allowSynchronousEvents){this.emit(this._opcode===9?"ping":"pong",data);this._state=GET_INFO}else{this._state=DEFER_EVENT;setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",data);this._state=GET_INFO;this.startLoop(cb)})}}createError(ErrorCtor,message,prefix,statusCode,errorCode){this._loop=false;this._errored=true;const err=new ErrorCtor(prefix?`Invalid WebSocket frame: ${message}`:message);Error.captureStackTrace(err,this.createError);err.code=errorCode;err[kStatusCode]=statusCode;return err}}module.exports=Receiver},{"./buffer-util":318,"./constants":319,"./permessage-deflate":323,"./validation":328,stream:undefined}],325:[function(require,module,exports){"use strict";const{Duplex:Duplex}=require("stream");const{randomFillSync:randomFillSync}=require("crypto");const PerMessageDeflate=require("./permessage-deflate");const{EMPTY_BUFFER:EMPTY_BUFFER}=require("./constants");const{isValidStatusCode:isValidStatusCode}=require("./validation");const{mask:applyMask,toBuffer:toBuffer}=require("./buffer-util");const kByteLength=Symbol("kByteLength");const maskBuffer=Buffer.alloc(4);const RANDOM_POOL_SIZE=8*1024;let randomPool;let randomPoolPointer=RANDOM_POOL_SIZE;class Sender{constructor(socket,extensions,generateMask){this._extensions=extensions||{};if(generateMask){this._generateMask=generateMask;this._maskBuffer=Buffer.alloc(4)}this._socket=socket;this._firstFragment=true;this._compress=false;this._bufferedBytes=0;this._deflating=false;this._queue=[]}static frame(data,options){let mask;let merge=false;let offset=2;let skipMasking=false;if(options.mask){mask=options.maskBuffer||maskBuffer;if(options.generateMask){options.generateMask(mask)}else{if(randomPoolPointer===RANDOM_POOL_SIZE){if(randomPool===undefined){randomPool=Buffer.alloc(RANDOM_POOL_SIZE)}randomFillSync(randomPool,0,RANDOM_POOL_SIZE);randomPoolPointer=0}mask[0]=randomPool[randomPoolPointer++];mask[1]=randomPool[randomPoolPointer++];mask[2]=randomPool[randomPoolPointer++];mask[3]=randomPool[randomPoolPointer++]}skipMasking=(mask[0]|mask[1]|mask[2]|mask[3])===0;offset=6}let dataLength;if(typeof data==="string"){if((!options.mask||skipMasking)&&options[kByteLength]!==undefined){dataLength=options[kByteLength]}else{data=Buffer.from(data);dataLength=data.length}}else{dataLength=data.length;merge=options.mask&&options.readOnly&&!skipMasking}let payloadLength=dataLength;if(dataLength>=65536){offset+=8;payloadLength=127}else if(dataLength>125){offset+=2;payloadLength=126}const target=Buffer.allocUnsafe(merge?dataLength+offset:offset);target[0]=options.fin?options.opcode|128:options.opcode;if(options.rsv1)target[0]|=64;target[1]=payloadLength;if(payloadLength===126){target.writeUInt16BE(dataLength,2)}else if(payloadLength===127){target[2]=target[3]=0;target.writeUIntBE(dataLength,4,6)}if(!options.mask)return[target,data];target[1]|=128;target[offset-4]=mask[0];target[offset-3]=mask[1];target[offset-2]=mask[2];target[offset-1]=mask[3];if(skipMasking)return[target,data];if(merge){applyMask(data,mask,target,offset,dataLength);return[target]}applyMask(data,mask,data,0,dataLength);return[target,data]}close(code,data,mask,cb){let buf;if(code===undefined){buf=EMPTY_BUFFER}else if(typeof code!=="number"||!isValidStatusCode(code)){throw new TypeError("First argument must be a valid error code number")}else if(data===undefined||!data.length){buf=Buffer.allocUnsafe(2);buf.writeUInt16BE(code,0)}else{const length=Buffer.byteLength(data);if(length>123){throw new RangeError("The message must not be greater than 123 bytes")}buf=Buffer.allocUnsafe(2+length);buf.writeUInt16BE(code,0);if(typeof data==="string"){buf.write(data,2)}else{buf.set(data,2)}}const options={[kByteLength]:buf.length,fin:true,generateMask:this._generateMask,mask:mask,maskBuffer:this._maskBuffer,opcode:8,readOnly:false,rsv1:false};if(this._deflating){this.enqueue([this.dispatch,buf,false,options,cb])}else{this.sendFrame(Sender.frame(buf,options),cb)}}ping(data,mask,cb){let byteLength;let readOnly;if(typeof data==="string"){byteLength=Buffer.byteLength(data);readOnly=false}else{data=toBuffer(data);byteLength=data.length;readOnly=toBuffer.readOnly}if(byteLength>125){throw new RangeError("The data size must not be greater than 125 bytes")}const options={[kByteLength]:byteLength,fin:true,generateMask:this._generateMask,mask:mask,maskBuffer:this._maskBuffer,opcode:9,readOnly:readOnly,rsv1:false};if(this._deflating){this.enqueue([this.dispatch,data,false,options,cb])}else{this.sendFrame(Sender.frame(data,options),cb)}}pong(data,mask,cb){let byteLength;let readOnly;if(typeof data==="string"){byteLength=Buffer.byteLength(data);readOnly=false}else{data=toBuffer(data);byteLength=data.length;readOnly=toBuffer.readOnly}if(byteLength>125){throw new RangeError("The data size must not be greater than 125 bytes")}const options={[kByteLength]:byteLength,fin:true,generateMask:this._generateMask,mask:mask,maskBuffer:this._maskBuffer,opcode:10,readOnly:readOnly,rsv1:false};if(this._deflating){this.enqueue([this.dispatch,data,false,options,cb])}else{this.sendFrame(Sender.frame(data,options),cb)}}send(data,options,cb){const perMessageDeflate=this._extensions[PerMessageDeflate.extensionName];let opcode=options.binary?2:1;let rsv1=options.compress;let byteLength;let readOnly;if(typeof data==="string"){byteLength=Buffer.byteLength(data);readOnly=false}else{data=toBuffer(data);byteLength=data.length;readOnly=toBuffer.readOnly}if(this._firstFragment){this._firstFragment=false;if(rsv1&&perMessageDeflate&&perMessageDeflate.params[perMessageDeflate._isServer?"server_no_context_takeover":"client_no_context_takeover"]){rsv1=byteLength>=perMessageDeflate._threshold}this._compress=rsv1}else{rsv1=false;opcode=0}if(options.fin)this._firstFragment=true;if(perMessageDeflate){const opts={[kByteLength]:byteLength,fin:options.fin,generateMask:this._generateMask,mask:options.mask,maskBuffer:this._maskBuffer,opcode:opcode,readOnly:readOnly,rsv1:rsv1};if(this._deflating){this.enqueue([this.dispatch,data,this._compress,opts,cb])}else{this.dispatch(data,this._compress,opts,cb)}}else{this.sendFrame(Sender.frame(data,{[kByteLength]:byteLength,fin:options.fin,generateMask:this._generateMask,mask:options.mask,maskBuffer:this._maskBuffer,opcode:opcode,readOnly:readOnly,rsv1:false}),cb)}}dispatch(data,compress,options,cb){if(!compress){this.sendFrame(Sender.frame(data,options),cb);return}const perMessageDeflate=this._extensions[PerMessageDeflate.extensionName];this._bufferedBytes+=options[kByteLength];this._deflating=true;perMessageDeflate.compress(data,options.fin,(_,buf)=>{if(this._socket.destroyed){const err=new Error("The socket was closed while data was being compressed");if(typeof cb==="function")cb(err);for(let i=0;i<this._queue.length;i++){const params=this._queue[i];const callback=params[params.length-1];if(typeof callback==="function")callback(err)}return}this._bufferedBytes-=options[kByteLength];this._deflating=false;options.readOnly=false;this.sendFrame(Sender.frame(buf,options),cb);this.dequeue()})}dequeue(){while(!this._deflating&&this._queue.length){const params=this._queue.shift();this._bufferedBytes-=params[3][kByteLength];Reflect.apply(params[0],this,params.slice(1))}}enqueue(params){this._bufferedBytes+=params[3][kByteLength];this._queue.push(params)}sendFrame(list,cb){if(list.length===2){this._socket.cork();this._socket.write(list[0]);this._socket.write(list[1],cb);this._socket.uncork()}else{this._socket.write(list[0],cb)}}}module.exports=Sender},{"./buffer-util":318,"./constants":319,"./permessage-deflate":323,"./validation":328,crypto:undefined,stream:undefined}],326:[function(require,module,exports){"use strict";const{Duplex:Duplex}=require("stream");function emitClose(stream){stream.emit("close")}function duplexOnEnd(){if(!this.destroyed&&this._writableState.finished){this.destroy()}}function duplexOnError(err){this.removeListener("error",duplexOnError);this.destroy();if(this.listenerCount("error")===0){this.emit("error",err)}}function createWebSocketStream(ws,options){let terminateOnDestroy=true;const duplex=new Duplex({...options,autoDestroy:false,emitClose:false,objectMode:false,writableObjectMode:false});ws.on("message",function message(msg,isBinary){const data=!isBinary&&duplex._readableState.objectMode?msg.toString():msg;if(!duplex.push(data))ws.pause()});ws.once("error",function error(err){if(duplex.destroyed)return;terminateOnDestroy=false;duplex.destroy(err)});ws.once("close",function close(){if(duplex.destroyed)return;duplex.push(null)});duplex._destroy=function(err,callback){if(ws.readyState===ws.CLOSED){callback(err);process.nextTick(emitClose,duplex);return}let called=false;ws.once("error",function error(err){called=true;callback(err)});ws.once("close",function close(){if(!called)callback(err);process.nextTick(emitClose,duplex)});if(terminateOnDestroy)ws.terminate()};duplex._final=function(callback){if(ws.readyState===ws.CONNECTING){ws.once("open",function open(){duplex._final(callback)});return}if(ws._socket===null)return;if(ws._socket._writableState.finished){callback();if(duplex._readableState.endEmitted)duplex.destroy()}else{ws._socket.once("finish",function finish(){callback()});ws.close()}};duplex._read=function(){if(ws.isPaused)ws.resume()};duplex._write=function(chunk,encoding,callback){if(ws.readyState===ws.CONNECTING){ws.once("open",function open(){duplex._write(chunk,encoding,callback)});return}ws.send(chunk,callback)};duplex.on("end",duplexOnEnd);duplex.on("error",duplexOnError);return duplex}module.exports=createWebSocketStream},{stream:undefined}],327:[function(require,module,exports){"use strict";const{tokenChars:tokenChars}=require("./validation");function parse(header){const protocols=new Set;let start=-1;let end=-1;let i=0;for(i;i<header.length;i++){const code=header.charCodeAt(i);if(end===-1&&tokenChars[code]===1){if(start===-1)start=i}else if(i!==0&&(code===32||code===9)){if(end===-1&&start!==-1)end=i}else if(code===44){if(start===-1){throw new SyntaxError(`Unexpected character at index ${i}`)}if(end===-1)end=i;const protocol=header.slice(start,end);if(protocols.has(protocol)){throw new SyntaxError(`The "${protocol}" subprotocol is duplicated`)}protocols.add(protocol);start=end=-1}else{throw new SyntaxError(`Unexpected character at index ${i}`)}}if(start===-1||end!==-1){throw new SyntaxError("Unexpected end of input")}const protocol=header.slice(start,i);if(protocols.has(protocol)){throw new SyntaxError(`The "${protocol}" subprotocol is duplicated`)}protocols.add(protocol);return protocols}module.exports={parse:parse}},{"./validation":328}],328:[function(require,module,exports){"use strict";const{isUtf8:isUtf8}=require("buffer");const tokenChars=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function isValidStatusCode(code){return code>=1e3&&code<=1014&&code!==1004&&code!==1005&&code!==1006||code>=3e3&&code<=4999}function _isValidUTF8(buf){const len=buf.length;let i=0;while(i<len){if((buf[i]&128)===0){i++}else if((buf[i]&224)===192){if(i+1===len||(buf[i+1]&192)!==128||(buf[i]&254)===192){return false}i+=2}else if((buf[i]&240)===224){if(i+2>=len||(buf[i+1]&192)!==128||(buf[i+2]&192)!==128||buf[i]===224&&(buf[i+1]&224)===128||buf[i]===237&&(buf[i+1]&224)===160){return false}i+=3}else if((buf[i]&248)===240){if(i+3>=len||(buf[i+1]&192)!==128||(buf[i+2]&192)!==128||(buf[i+3]&192)!==128||buf[i]===240&&(buf[i+1]&240)===128||buf[i]===244&&buf[i+1]>143||buf[i]>244){return false}i+=4}else{return false}}return true}module.exports={isValidStatusCode:isValidStatusCode,isValidUTF8:_isValidUTF8,tokenChars:tokenChars};if(isUtf8){module.exports.isValidUTF8=function(buf){return buf.length<24?_isValidUTF8(buf):isUtf8(buf)}}else if(!process.env.WS_NO_UTF_8_VALIDATE){try{const isValidUTF8=require("utf-8-validate");module.exports.isValidUTF8=function(buf){return buf.length<32?_isValidUTF8(buf):isValidUTF8(buf)}}catch(e){}}},{buffer:undefined,"utf-8-validate":undefined}],329:[function(require,module,exports){"use strict";const EventEmitter=require("events");const http=require("http");const{Duplex:Duplex}=require("stream");const{createHash:createHash}=require("crypto");const extension=require("./extension");const PerMessageDeflate=require("./permessage-deflate");const subprotocol=require("./subprotocol");const WebSocket=require("./websocket");const{GUID:GUID,kWebSocket:kWebSocket}=require("./constants");const keyRegex=/^[+/0-9A-Za-z]{22}==$/;const RUNNING=0;const CLOSING=1;const CLOSED=2;class WebSocketServer extends EventEmitter{constructor(options,callback){super();options={allowSynchronousEvents:true,autoPong:true,maxPayload:100*1024*1024,skipUTF8Validation:false,perMessageDeflate:false,handleProtocols:null,clientTracking:true,verifyClient:null,noServer:false,backlog:null,server:null,host:null,path:null,port:null,WebSocket:WebSocket,...options};if(options.port==null&&!options.server&&!options.noServer||options.port!=null&&(options.server||options.noServer)||options.server&&options.noServer){throw new TypeError('One and only one of the "port", "server", or "noServer" options '+"must be specified")}if(options.port!=null){this._server=http.createServer((req,res)=>{const body=http.STATUS_CODES[426];res.writeHead(426,{"Content-Length":body.length,"Content-Type":"text/plain"});res.end(body)});this._server.listen(options.port,options.host,options.backlog,callback)}else if(options.server){this._server=options.server}if(this._server){const emitConnection=this.emit.bind(this,"connection");this._removeListeners=addListeners(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(req,socket,head)=>{this.handleUpgrade(req,socket,head,emitConnection)}})}if(options.perMessageDeflate===true)options.perMessageDeflate={};if(options.clientTracking){this.clients=new Set;this._shouldEmitClose=false}this.options=options;this._state=RUNNING}address(){if(this.options.noServer){throw new Error('The server is operating in "noServer" mode')}if(!this._server)return null;return this._server.address()}close(cb){if(this._state===CLOSED){if(cb){this.once("close",()=>{cb(new Error("The server is not running"))})}process.nextTick(emitClose,this);return}if(cb)this.once("close",cb);if(this._state===CLOSING)return;this._state=CLOSING;if(this.options.noServer||this.options.server){if(this._server){this._removeListeners();this._removeListeners=this._server=null}if(this.clients){if(!this.clients.size){process.nextTick(emitClose,this)}else{this._shouldEmitClose=true}}else{process.nextTick(emitClose,this)}}else{const server=this._server;this._removeListeners();this._removeListeners=this._server=null;server.close(()=>{emitClose(this)})}}shouldHandle(req){if(this.options.path){const index=req.url.indexOf("?");const pathname=index!==-1?req.url.slice(0,index):req.url;if(pathname!==this.options.path)return false}return true}handleUpgrade(req,socket,head,cb){socket.on("error",socketOnError);const key=req.headers["sec-websocket-key"];const upgrade=req.headers.upgrade;const version=+req.headers["sec-websocket-version"];if(req.method!=="GET"){const message="Invalid HTTP method";abortHandshakeOrEmitwsClientError(this,req,socket,405,message);return}if(upgrade===undefined||upgrade.toLowerCase()!=="websocket"){const message="Invalid Upgrade header";abortHandshakeOrEmitwsClientError(this,req,socket,400,message);return}if(key===undefined||!keyRegex.test(key)){const message="Missing or invalid Sec-WebSocket-Key header";abortHandshakeOrEmitwsClientError(this,req,socket,400,message);return}if(version!==8&&version!==13){const message="Missing or invalid Sec-WebSocket-Version header";abortHandshakeOrEmitwsClientError(this,req,socket,400,message);return}if(!this.shouldHandle(req)){abortHandshake(socket,400);return}const secWebSocketProtocol=req.headers["sec-websocket-protocol"];let protocols=new Set;if(secWebSocketProtocol!==undefined){try{protocols=subprotocol.parse(secWebSocketProtocol)}catch(err){const message="Invalid Sec-WebSocket-Protocol header";abortHandshakeOrEmitwsClientError(this,req,socket,400,message);return}}const secWebSocketExtensions=req.headers["sec-websocket-extensions"];const extensions={};if(this.options.perMessageDeflate&&secWebSocketExtensions!==undefined){const perMessageDeflate=new PerMessageDeflate(this.options.perMessageDeflate,true,this.options.maxPayload);try{const offers=extension.parse(secWebSocketExtensions);if(offers[PerMessageDeflate.extensionName]){perMessageDeflate.accept(offers[PerMessageDeflate.extensionName]);extensions[PerMessageDeflate.extensionName]=perMessageDeflate}}catch(err){const message="Invalid or unacceptable Sec-WebSocket-Extensions header";abortHandshakeOrEmitwsClientError(this,req,socket,400,message);return}}if(this.options.verifyClient){const info={origin:req.headers[`${version===8?"sec-websocket-origin":"origin"}`],secure:!!(req.socket.authorized||req.socket.encrypted),req:req};if(this.options.verifyClient.length===2){this.options.verifyClient(info,(verified,code,message,headers)=>{if(!verified){return abortHandshake(socket,code||401,message,headers)}this.completeUpgrade(extensions,key,protocols,req,socket,head,cb)});return}if(!this.options.verifyClient(info))return abortHandshake(socket,401)}this.completeUpgrade(extensions,key,protocols,req,socket,head,cb)}completeUpgrade(extensions,key,protocols,req,socket,head,cb){if(!socket.readable||!socket.writable)return socket.destroy();if(socket[kWebSocket]){throw new Error("server.handleUpgrade() was called more than once with the same "+"socket, possibly due to a misconfiguration")}if(this._state>RUNNING)return abortHandshake(socket,503);const digest=createHash("sha1").update(key+GUID).digest("base64");const headers=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${digest}`];const ws=new this.options.WebSocket(null,undefined,this.options);if(protocols.size){const protocol=this.options.handleProtocols?this.options.handleProtocols(protocols,req):protocols.values().next().value;if(protocol){headers.push(`Sec-WebSocket-Protocol: ${protocol}`);ws._protocol=protocol}}if(extensions[PerMessageDeflate.extensionName]){const params=extensions[PerMessageDeflate.extensionName].params;const value=extension.format({[PerMessageDeflate.extensionName]:[params]});headers.push(`Sec-WebSocket-Extensions: ${value}`);ws._extensions=extensions}this.emit("headers",headers,req);socket.write(headers.concat("\r\n").join("\r\n"));socket.removeListener("error",socketOnError);ws.setSocket(socket,head,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation});if(this.clients){this.clients.add(ws);ws.on("close",()=>{this.clients.delete(ws);if(this._shouldEmitClose&&!this.clients.size){process.nextTick(emitClose,this)}})}cb(ws,req)}}module.exports=WebSocketServer;function addListeners(server,map){for(const event of Object.keys(map))server.on(event,map[event]);return function removeListeners(){for(const event of Object.keys(map)){server.removeListener(event,map[event])}}}function emitClose(server){server._state=CLOSED;server.emit("close")}function socketOnError(){this.destroy()}function abortHandshake(socket,code,message,headers){message=message||http.STATUS_CODES[code];headers={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(message),...headers};socket.once("finish",socket.destroy);socket.end(`HTTP/1.1 ${code} ${http.STATUS_CODES[code]}\r\n`+Object.keys(headers).map(h=>`${h}: ${headers[h]}`).join("\r\n")+"\r\n\r\n"+message)}function abortHandshakeOrEmitwsClientError(server,req,socket,code,message){if(server.listenerCount("wsClientError")){const err=new Error(message);Error.captureStackTrace(err,abortHandshakeOrEmitwsClientError);server.emit("wsClientError",err,socket,req)}else{abortHandshake(socket,code,message)}}},{"./constants":319,"./extension":321,"./permessage-deflate":323,"./subprotocol":327,"./websocket":330,crypto:undefined,events:undefined,http:undefined,stream:undefined}],330:[function(require,module,exports){"use strict";const EventEmitter=require("events");const https=require("https");const http=require("http");const net=require("net");const tls=require("tls");const{randomBytes:randomBytes,createHash:createHash}=require("crypto");const{Duplex:Duplex,Readable:Readable}=require("stream");const{URL:URL}=require("url");const PerMessageDeflate=require("./permessage-deflate");const Receiver=require("./receiver");const Sender=require("./sender");const{BINARY_TYPES:BINARY_TYPES,EMPTY_BUFFER:EMPTY_BUFFER,GUID:GUID,kForOnEventAttribute:kForOnEventAttribute,kListener:kListener,kStatusCode:kStatusCode,kWebSocket:kWebSocket,NOOP:NOOP}=require("./constants");const{EventTarget:{addEventListener:addEventListener,removeEventListener:removeEventListener}}=require("./event-target");const{format:format,parse:parse}=require("./extension");const{toBuffer:toBuffer}=require("./buffer-util");const closeTimeout=30*1e3;const kAborted=Symbol("kAborted");const protocolVersions=[8,13];const readyStates=["CONNECTING","OPEN","CLOSING","CLOSED"];const subprotocolRegex=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class WebSocket extends EventEmitter{constructor(address,protocols,options){super();this._binaryType=BINARY_TYPES[0];this._closeCode=1006;this._closeFrameReceived=false;this._closeFrameSent=false;this._closeMessage=EMPTY_BUFFER;this._closeTimer=null;this._extensions={};this._paused=false;this._protocol="";this._readyState=WebSocket.CONNECTING;this._receiver=null;this._sender=null;this._socket=null;if(address!==null){this._bufferedAmount=0;this._isServer=false;this._redirects=0;if(protocols===undefined){protocols=[]}else if(!Array.isArray(protocols)){if(typeof protocols==="object"&&protocols!==null){options=protocols;protocols=[]}else{protocols=[protocols]}}initAsClient(this,address,protocols,options)}else{this._autoPong=options.autoPong;this._isServer=true}}get binaryType(){return this._binaryType}set binaryType(type){if(!BINARY_TYPES.includes(type))return;this._binaryType=type;if(this._receiver)this._receiver._binaryType=type}get bufferedAmount(){if(!this._socket)return this._bufferedAmount;return this._socket._writableState.length+this._sender._bufferedBytes}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(socket,head,options){const receiver=new Receiver({allowSynchronousEvents:options.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:options.maxPayload,skipUTF8Validation:options.skipUTF8Validation});this._sender=new Sender(socket,this._extensions,options.generateMask);this._receiver=receiver;this._socket=socket;receiver[kWebSocket]=this;socket[kWebSocket]=this;receiver.on("conclude",receiverOnConclude);receiver.on("drain",receiverOnDrain);receiver.on("error",receiverOnError);receiver.on("message",receiverOnMessage);receiver.on("ping",receiverOnPing);receiver.on("pong",receiverOnPong);if(socket.setTimeout)socket.setTimeout(0);if(socket.setNoDelay)socket.setNoDelay();if(head.length>0)socket.unshift(head);socket.on("close",socketOnClose);socket.on("data",socketOnData);socket.on("end",socketOnEnd);socket.on("error",socketOnError);this._readyState=WebSocket.OPEN;this.emit("open")}emitClose(){if(!this._socket){this._readyState=WebSocket.CLOSED;this.emit("close",this._closeCode,this._closeMessage);return}if(this._extensions[PerMessageDeflate.extensionName]){this._extensions[PerMessageDeflate.extensionName].cleanup()}this._receiver.removeAllListeners();this._readyState=WebSocket.CLOSED;this.emit("close",this._closeCode,this._closeMessage)}close(code,data){if(this.readyState===WebSocket.CLOSED)return;if(this.readyState===WebSocket.CONNECTING){const msg="WebSocket was closed before the connection was established";abortHandshake(this,this._req,msg);return}if(this.readyState===WebSocket.CLOSING){if(this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)){this._socket.end()}return}this._readyState=WebSocket.CLOSING;this._sender.close(code,data,!this._isServer,err=>{if(err)return;this._closeFrameSent=true;if(this._closeFrameReceived||this._receiver._writableState.errorEmitted){this._socket.end()}});this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),closeTimeout)}pause(){if(this.readyState===WebSocket.CONNECTING||this.readyState===WebSocket.CLOSED){return}this._paused=true;this._socket.pause()}ping(data,mask,cb){if(this.readyState===WebSocket.CONNECTING){throw new Error("WebSocket is not open: readyState 0 (CONNECTING)")}if(typeof data==="function"){cb=data;data=mask=undefined}else if(typeof mask==="function"){cb=mask;mask=undefined}if(typeof data==="number")data=data.toString();if(this.readyState!==WebSocket.OPEN){sendAfterClose(this,data,cb);return}if(mask===undefined)mask=!this._isServer;this._sender.ping(data||EMPTY_BUFFER,mask,cb)}pong(data,mask,cb){if(this.readyState===WebSocket.CONNECTING){throw new Error("WebSocket is not open: readyState 0 (CONNECTING)")}if(typeof data==="function"){cb=data;data=mask=undefined}else if(typeof mask==="function"){cb=mask;mask=undefined}if(typeof data==="number")data=data.toString();if(this.readyState!==WebSocket.OPEN){sendAfterClose(this,data,cb);return}if(mask===undefined)mask=!this._isServer;this._sender.pong(data||EMPTY_BUFFER,mask,cb)}resume(){if(this.readyState===WebSocket.CONNECTING||this.readyState===WebSocket.CLOSED){return}this._paused=false;if(!this._receiver._writableState.needDrain)this._socket.resume()}send(data,options,cb){if(this.readyState===WebSocket.CONNECTING){throw new Error("WebSocket is not open: readyState 0 (CONNECTING)")}if(typeof options==="function"){cb=options;options={}}if(typeof data==="number")data=data.toString();if(this.readyState!==WebSocket.OPEN){sendAfterClose(this,data,cb);return}const opts={binary:typeof data!=="string",mask:!this._isServer,compress:true,fin:true,...options};if(!this._extensions[PerMessageDeflate.extensionName]){opts.compress=false}this._sender.send(data||EMPTY_BUFFER,opts,cb)}terminate(){if(this.readyState===WebSocket.CLOSED)return;if(this.readyState===WebSocket.CONNECTING){const msg="WebSocket was closed before the connection was established";abortHandshake(this,this._req,msg);return}if(this._socket){this._readyState=WebSocket.CLOSING;this._socket.destroy()}}}Object.defineProperty(WebSocket,"CONNECTING",{enumerable:true,value:readyStates.indexOf("CONNECTING")});Object.defineProperty(WebSocket.prototype,"CONNECTING",{enumerable:true,value:readyStates.indexOf("CONNECTING")});Object.defineProperty(WebSocket,"OPEN",{enumerable:true,value:readyStates.indexOf("OPEN")});Object.defineProperty(WebSocket.prototype,"OPEN",{enumerable:true,value:readyStates.indexOf("OPEN")});Object.defineProperty(WebSocket,"CLOSING",{enumerable:true,value:readyStates.indexOf("CLOSING")});Object.defineProperty(WebSocket.prototype,"CLOSING",{enumerable:true,value:readyStates.indexOf("CLOSING")});Object.defineProperty(WebSocket,"CLOSED",{enumerable:true,value:readyStates.indexOf("CLOSED")});Object.defineProperty(WebSocket.prototype,"CLOSED",{enumerable:true,value:readyStates.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(property=>{Object.defineProperty(WebSocket.prototype,property,{enumerable:true})});["open","error","close","message"].forEach(method=>{Object.defineProperty(WebSocket.prototype,`on${method}`,{enumerable:true,get(){for(const listener of this.listeners(method)){if(listener[kForOnEventAttribute])return listener[kListener]}return null},set(handler){for(const listener of this.listeners(method)){if(listener[kForOnEventAttribute]){this.removeListener(method,listener);break}}if(typeof handler!=="function")return;this.addEventListener(method,handler,{[kForOnEventAttribute]:true})}})});WebSocket.prototype.addEventListener=addEventListener;WebSocket.prototype.removeEventListener=removeEventListener;module.exports=WebSocket;function initAsClient(websocket,address,protocols,options){const opts={allowSynchronousEvents:true,autoPong:true,protocolVersion:protocolVersions[1],maxPayload:100*1024*1024,skipUTF8Validation:false,perMessageDeflate:true,followRedirects:false,maxRedirects:10,...options,socketPath:undefined,hostname:undefined,protocol:undefined,timeout:undefined,method:"GET",host:undefined,path:undefined,port:undefined};websocket._autoPong=opts.autoPong;if(!protocolVersions.includes(opts.protocolVersion)){throw new RangeError(`Unsupported protocol version: ${opts.protocolVersion} `+`(supported versions: ${protocolVersions.join(", ")})`)}let parsedUrl;if(address instanceof URL){parsedUrl=address}else{try{parsedUrl=new URL(address)}catch(e){throw new SyntaxError(`Invalid URL: ${address}`)}}if(parsedUrl.protocol==="http:"){parsedUrl.protocol="ws:"}else if(parsedUrl.protocol==="https:"){parsedUrl.protocol="wss:"}websocket._url=parsedUrl.href;const isSecure=parsedUrl.protocol==="wss:";const isIpcUrl=parsedUrl.protocol==="ws+unix:";let invalidUrlMessage;if(parsedUrl.protocol!=="ws:"&&!isSecure&&!isIpcUrl){invalidUrlMessage='The URL\'s protocol must be one of "ws:", "wss:", '+'"http:", "https", or "ws+unix:"'}else if(isIpcUrl&&!parsedUrl.pathname){invalidUrlMessage="The URL's pathname is empty"}else if(parsedUrl.hash){invalidUrlMessage="The URL contains a fragment identifier"}if(invalidUrlMessage){const err=new SyntaxError(invalidUrlMessage);if(websocket._redirects===0){throw err}else{emitErrorAndClose(websocket,err);return}}const defaultPort=isSecure?443:80;const key=randomBytes(16).toString("base64");const request=isSecure?https.request:http.request;const protocolSet=new Set;let perMessageDeflate;opts.createConnection=opts.createConnection||(isSecure?tlsConnect:netConnect);opts.defaultPort=opts.defaultPort||defaultPort;opts.port=parsedUrl.port||defaultPort;opts.host=parsedUrl.hostname.startsWith("[")?parsedUrl.hostname.slice(1,-1):parsedUrl.hostname;opts.headers={...opts.headers,"Sec-WebSocket-Version":opts.protocolVersion,"Sec-WebSocket-Key":key,Connection:"Upgrade",Upgrade:"websocket"};opts.path=parsedUrl.pathname+parsedUrl.search;opts.timeout=opts.handshakeTimeout;if(opts.perMessageDeflate){perMessageDeflate=new PerMessageDeflate(opts.perMessageDeflate!==true?opts.perMessageDeflate:{},false,opts.maxPayload);opts.headers["Sec-WebSocket-Extensions"]=format({[PerMessageDeflate.extensionName]:perMessageDeflate.offer()})}if(protocols.length){for(const protocol of protocols){if(typeof protocol!=="string"||!subprotocolRegex.test(protocol)||protocolSet.has(protocol)){throw new SyntaxError("An invalid or duplicated subprotocol was specified")}protocolSet.add(protocol)}opts.headers["Sec-WebSocket-Protocol"]=protocols.join(",")}if(opts.origin){if(opts.protocolVersion<13){opts.headers["Sec-WebSocket-Origin"]=opts.origin}else{opts.headers.Origin=opts.origin}}if(parsedUrl.username||parsedUrl.password){opts.auth=`${parsedUrl.username}:${parsedUrl.password}`}if(isIpcUrl){const parts=opts.path.split(":");opts.socketPath=parts[0];opts.path=parts[1]}let req;if(opts.followRedirects){if(websocket._redirects===0){websocket._originalIpc=isIpcUrl;websocket._originalSecure=isSecure;websocket._originalHostOrSocketPath=isIpcUrl?opts.socketPath:parsedUrl.host;const headers=options&&options.headers;options={...options,headers:{}};if(headers){for(const[key,value]of Object.entries(headers)){options.headers[key.toLowerCase()]=value}}}else if(websocket.listenerCount("redirect")===0){const isSameHost=isIpcUrl?websocket._originalIpc?opts.socketPath===websocket._originalHostOrSocketPath:false:websocket._originalIpc?false:parsedUrl.host===websocket._originalHostOrSocketPath;if(!isSameHost||websocket._originalSecure&&!isSecure){delete opts.headers.authorization;delete opts.headers.cookie;if(!isSameHost)delete opts.headers.host;opts.auth=undefined}}if(opts.auth&&!options.headers.authorization){options.headers.authorization="Basic "+Buffer.from(opts.auth).toString("base64")}req=websocket._req=request(opts);if(websocket._redirects){websocket.emit("redirect",websocket.url,req)}}else{req=websocket._req=request(opts)}if(opts.timeout){req.on("timeout",()=>{abortHandshake(websocket,req,"Opening handshake has timed out")})}req.on("error",err=>{if(req===null||req[kAborted])return;req=websocket._req=null;emitErrorAndClose(websocket,err)});req.on("response",res=>{const location=res.headers.location;const statusCode=res.statusCode;if(location&&opts.followRedirects&&statusCode>=300&&statusCode<400){if(++websocket._redirects>opts.maxRedirects){abortHandshake(websocket,req,"Maximum redirects exceeded");return}req.abort();let addr;try{addr=new URL(location,address)}catch(e){const err=new SyntaxError(`Invalid URL: ${location}`);emitErrorAndClose(websocket,err);return}initAsClient(websocket,addr,protocols,options)}else if(!websocket.emit("unexpected-response",req,res)){abortHandshake(websocket,req,`Unexpected server response: ${res.statusCode}`)}});req.on("upgrade",(res,socket,head)=>{websocket.emit("upgrade",res);if(websocket.readyState!==WebSocket.CONNECTING)return;req=websocket._req=null;const upgrade=res.headers.upgrade;if(upgrade===undefined||upgrade.toLowerCase()!=="websocket"){abortHandshake(websocket,socket,"Invalid Upgrade header");return}const digest=createHash("sha1").update(key+GUID).digest("base64");if(res.headers["sec-websocket-accept"]!==digest){abortHandshake(websocket,socket,"Invalid Sec-WebSocket-Accept header");return}const serverProt=res.headers["sec-websocket-protocol"];let protError;if(serverProt!==undefined){if(!protocolSet.size){protError="Server sent a subprotocol but none was requested"}else if(!protocolSet.has(serverProt)){protError="Server sent an invalid subprotocol"}}else if(protocolSet.size){protError="Server sent no subprotocol"}if(protError){abortHandshake(websocket,socket,protError);return}if(serverProt)websocket._protocol=serverProt;const secWebSocketExtensions=res.headers["sec-websocket-extensions"];if(secWebSocketExtensions!==undefined){if(!perMessageDeflate){const message="Server sent a Sec-WebSocket-Extensions header but no extension "+"was requested";abortHandshake(websocket,socket,message);return}let extensions;try{extensions=parse(secWebSocketExtensions)}catch(err){const message="Invalid Sec-WebSocket-Extensions header";abortHandshake(websocket,socket,message);return}const extensionNames=Object.keys(extensions);if(extensionNames.length!==1||extensionNames[0]!==PerMessageDeflate.extensionName){const message="Server indicated an extension that was not requested";abortHandshake(websocket,socket,message);return}try{perMessageDeflate.accept(extensions[PerMessageDeflate.extensionName])}catch(err){const message="Invalid Sec-WebSocket-Extensions header";abortHandshake(websocket,socket,message);return}websocket._extensions[PerMessageDeflate.extensionName]=perMessageDeflate}websocket.setSocket(socket,head,{allowSynchronousEvents:opts.allowSynchronousEvents,generateMask:opts.generateMask,maxPayload:opts.maxPayload,skipUTF8Validation:opts.skipUTF8Validation})});if(opts.finishRequest){opts.finishRequest(req,websocket)}else{req.end()}}function emitErrorAndClose(websocket,err){websocket._readyState=WebSocket.CLOSING;websocket.emit("error",err);websocket.emitClose()}function netConnect(options){options.path=options.socketPath;return net.connect(options)}function tlsConnect(options){options.path=undefined;if(!options.servername&&options.servername!==""){options.servername=net.isIP(options.host)?"":options.host}return tls.connect(options)}function abortHandshake(websocket,stream,message){websocket._readyState=WebSocket.CLOSING;const err=new Error(message);Error.captureStackTrace(err,abortHandshake);if(stream.setHeader){stream[kAborted]=true;stream.abort();if(stream.socket&&!stream.socket.destroyed){stream.socket.destroy()}process.nextTick(emitErrorAndClose,websocket,err)}else{stream.destroy(err);stream.once("error",websocket.emit.bind(websocket,"error"));stream.once("close",websocket.emitClose.bind(websocket))}}function sendAfterClose(websocket,data,cb){if(data){const length=toBuffer(data).length;if(websocket._socket)websocket._sender._bufferedBytes+=length;else websocket._bufferedAmount+=length}if(cb){const err=new Error(`WebSocket is not open: readyState ${websocket.readyState} `+`(${readyStates[websocket.readyState]})`);process.nextTick(cb,err)}}function receiverOnConclude(code,reason){const websocket=this[kWebSocket];websocket._closeFrameReceived=true;websocket._closeMessage=reason;websocket._closeCode=code;if(websocket._socket[kWebSocket]===undefined)return;websocket._socket.removeListener("data",socketOnData);process.nextTick(resume,websocket._socket);if(code===1005)websocket.close();else websocket.close(code,reason)}function receiverOnDrain(){const websocket=this[kWebSocket];if(!websocket.isPaused)websocket._socket.resume()}function receiverOnError(err){const websocket=this[kWebSocket];if(websocket._socket[kWebSocket]!==undefined){websocket._socket.removeListener("data",socketOnData);process.nextTick(resume,websocket._socket);websocket.close(err[kStatusCode])}websocket.emit("error",err)}function receiverOnFinish(){this[kWebSocket].emitClose()}function receiverOnMessage(data,isBinary){this[kWebSocket].emit("message",data,isBinary)}function receiverOnPing(data){const websocket=this[kWebSocket];if(websocket._autoPong)websocket.pong(data,!this._isServer,NOOP);websocket.emit("ping",data)}function receiverOnPong(data){this[kWebSocket].emit("pong",data)}function resume(stream){stream.resume()}function socketOnClose(){const websocket=this[kWebSocket];this.removeListener("close",socketOnClose);this.removeListener("data",socketOnData);this.removeListener("end",socketOnEnd);websocket._readyState=WebSocket.CLOSING;let chunk;if(!this._readableState.endEmitted&&!websocket._closeFrameReceived&&!websocket._receiver._writableState.errorEmitted&&(chunk=websocket._socket.read())!==null){websocket._receiver.write(chunk)}websocket._receiver.end();this[kWebSocket]=undefined;clearTimeout(websocket._closeTimer);if(websocket._receiver._writableState.finished||websocket._receiver._writableState.errorEmitted){websocket.emitClose()}else{websocket._receiver.on("error",receiverOnFinish);websocket._receiver.on("finish",receiverOnFinish)}}function socketOnData(chunk){if(!this[kWebSocket]._receiver.write(chunk)){this.pause()}}function socketOnEnd(){const websocket=this[kWebSocket];websocket._readyState=WebSocket.CLOSING;websocket._receiver.end();this.end()}function socketOnError(){const websocket=this[kWebSocket];this.removeListener("error",socketOnError);this.on("error",NOOP);if(websocket){websocket._readyState=WebSocket.CLOSING;this.destroy()}}},{"./buffer-util":318,"./constants":319,"./event-target":320,"./extension":321,"./permessage-deflate":323,"./receiver":324,"./sender":325,crypto:undefined,events:undefined,http:undefined,https:undefined,net:undefined,stream:undefined,tls:undefined,url:undefined}],331:[function(require,module,exports){
/**
 * Wrapper for built-in http.js to emulate the browser XMLHttpRequest object.
 *
 * This can be used with JS designed for browsers to improve reuse of code and
 * allow the use of existing libraries.
 *
 * Usage: include("XMLHttpRequest.js") and use XMLHttpRequest per W3C specs.
 *
 * @author Dan DeFelippi <dan@driverdan.com>
 * @contributor David Ellis <d.f.ellis@ieee.org>
 * @license MIT
 */
var fs=require("fs");var Url=require("url");var spawn=require("child_process").spawn;module.exports=XMLHttpRequest;XMLHttpRequest.XMLHttpRequest=XMLHttpRequest;function XMLHttpRequest(opts){"use strict";opts=opts||{};var self=this;var http=require("http");var https=require("https");var request;var response;var settings={};var disableHeaderCheck=false;var defaultHeaders={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"};var headers=Object.assign({},defaultHeaders);var forbiddenRequestHeaders=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"];var forbiddenRequestMethods=["TRACE","TRACK","CONNECT"];var sendFlag=false;var errorFlag=false;var abortedFlag=false;var listeners={};this.UNSENT=0;this.OPENED=1;this.HEADERS_RECEIVED=2;this.LOADING=3;this.DONE=4;this.readyState=this.UNSENT;this.onreadystatechange=null;this.responseText="";this.responseXML="";this.response=Buffer.alloc(0);this.status=null;this.statusText=null;var isAllowedHttpHeader=function(header){return disableHeaderCheck||header&&forbiddenRequestHeaders.indexOf(header.toLowerCase())===-1};var isAllowedHttpMethod=function(method){return method&&forbiddenRequestMethods.indexOf(method)===-1};this.open=function(method,url,async,user,password){this.abort();errorFlag=false;abortedFlag=false;if(!isAllowedHttpMethod(method)){throw new Error("SecurityError: Request method not allowed")}settings={method:method,url:url.toString(),async:typeof async!=="boolean"?true:async,user:user||null,password:password||null};setState(this.OPENED)};this.setDisableHeaderCheck=function(state){disableHeaderCheck=state};this.setRequestHeader=function(header,value){if(this.readyState!=this.OPENED){throw new Error("INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN")}if(!isAllowedHttpHeader(header)){console.warn('Refused to set unsafe header "'+header+'"');return false}if(sendFlag){throw new Error("INVALID_STATE_ERR: send flag is true")}headers[header]=value;return true};this.getResponseHeader=function(header){if(typeof header==="string"&&this.readyState>this.OPENED&&response.headers[header.toLowerCase()]&&!errorFlag){return response.headers[header.toLowerCase()]}return null};this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||errorFlag){return""}var result="";for(var i in response.headers){if(i!=="set-cookie"&&i!=="set-cookie2"){result+=i+": "+response.headers[i]+"\r\n"}}return result.substr(0,result.length-2)};this.getRequestHeader=function(name){if(typeof name==="string"&&headers[name]){return headers[name]}return""};this.send=function(data){if(this.readyState!=this.OPENED){throw new Error("INVALID_STATE_ERR: connection must be opened before send() is called")}if(sendFlag){throw new Error("INVALID_STATE_ERR: send has already been called")}var ssl=false,local=false;var url=Url.parse(settings.url);var host;switch(url.protocol){case"https:":ssl=true;case"http:":host=url.hostname;break;case"file:":local=true;break;case undefined:case"":host="localhost";break;default:throw new Error("Protocol not supported.")}if(local){if(settings.method!=="GET"){throw new Error("XMLHttpRequest: Only GET method is supported")}if(settings.async){fs.readFile(unescape(url.pathname),function(error,data){if(error){self.handleError(error,error.errno||-1)}else{self.status=200;self.responseText=data.toString("utf8");self.response=data;setState(self.DONE)}})}else{try{this.response=fs.readFileSync(unescape(url.pathname));this.responseText=this.response.toString("utf8");this.status=200;setState(self.DONE)}catch(e){this.handleError(e,e.errno||-1)}}return}var port=url.port||(ssl?443:80);var uri=url.pathname+(url.search?url.search:"");headers["Host"]=host;if(!(ssl&&port===443||port===80)){headers["Host"]+=":"+url.port}if(settings.user){if(typeof settings.password=="undefined"){settings.password=""}var authBuf=new Buffer(settings.user+":"+settings.password);headers["Authorization"]="Basic "+authBuf.toString("base64")}if(settings.method==="GET"||settings.method==="HEAD"){data=null}else if(data){headers["Content-Length"]=Buffer.isBuffer(data)?data.length:Buffer.byteLength(data);var headersKeys=Object.keys(headers);if(!headersKeys.some(function(h){return h.toLowerCase()==="content-type"})){headers["Content-Type"]="text/plain;charset=UTF-8"}}else if(settings.method==="POST"){headers["Content-Length"]=0}var agent=opts.agent||false;var options={host:host,port:port,path:uri,method:settings.method,headers:headers,agent:agent};if(ssl){options.pfx=opts.pfx;options.key=opts.key;options.passphrase=opts.passphrase;options.cert=opts.cert;options.ca=opts.ca;options.ciphers=opts.ciphers;options.rejectUnauthorized=opts.rejectUnauthorized===false?false:true}errorFlag=false;if(settings.async){var doRequest=ssl?https.request:http.request;sendFlag=true;self.dispatchEvent("readystatechange");var responseHandler=function(resp){response=resp;if(response.statusCode===302||response.statusCode===303||response.statusCode===307){settings.url=response.headers.location;var url=Url.parse(settings.url);host=url.hostname;var newOptions={hostname:url.hostname,port:url.port,path:url.path,method:response.statusCode===303?"GET":settings.method,headers:headers};if(ssl){newOptions.pfx=opts.pfx;newOptions.key=opts.key;newOptions.passphrase=opts.passphrase;newOptions.cert=opts.cert;newOptions.ca=opts.ca;newOptions.ciphers=opts.ciphers;newOptions.rejectUnauthorized=opts.rejectUnauthorized===false?false:true}request=doRequest(newOptions,responseHandler).on("error",errorHandler);request.end();return}setState(self.HEADERS_RECEIVED);self.status=response.statusCode;response.on("data",function(chunk){if(chunk){var data=Buffer.from(chunk);self.response=Buffer.concat([self.response,data])}if(sendFlag){setState(self.LOADING)}});response.on("end",function(){if(sendFlag){sendFlag=false;setState(self.DONE);self.responseText=self.response.toString("utf8")}});response.on("error",function(error){self.handleError(error)})};var errorHandler=function(error){if(request.reusedSocket&&error.code==="ECONNRESET")return doRequest(options,responseHandler).on("error",errorHandler);self.handleError(error)};request=doRequest(options,responseHandler).on("error",errorHandler);if(opts.autoUnref){request.on("socket",socket=>{socket.unref()})}if(data){request.write(data)}request.end();self.dispatchEvent("loadstart")}else{var contentFile=".node-xmlhttprequest-content-"+process.pid;var syncFile=".node-xmlhttprequest-sync-"+process.pid;fs.writeFileSync(syncFile,"","utf8");var execString="var http = require('http'), https = require('https'), fs = require('fs');"+"var doRequest = http"+(ssl?"s":"")+".request;"+"var options = "+JSON.stringify(options)+";"+"var responseText = '';"+"var responseData = Buffer.alloc(0);"+"var req = doRequest(options, function(response) {"+"response.on('data', function(chunk) {"+"  var data = Buffer.from(chunk);"+"  responseText += data.toString('utf8');"+"  responseData = Buffer.concat([responseData, data]);"+"});"+"response.on('end', function() {"+"fs.writeFileSync('"+contentFile+"', JSON.stringify({err: null, data: {statusCode: response.statusCode, headers: response.headers, text: responseText, data: responseData.toString('base64')}}), 'utf8');"+"fs.unlinkSync('"+syncFile+"');"+"});"+"response.on('error', function(error) {"+"fs.writeFileSync('"+contentFile+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');"+"fs.unlinkSync('"+syncFile+"');"+"});"+"}).on('error', function(error) {"+"fs.writeFileSync('"+contentFile+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');"+"fs.unlinkSync('"+syncFile+"');"+"});"+(data?"req.write('"+JSON.stringify(data).slice(1,-1).replace(/'/g,"\\'")+"');":"")+"req.end();";var syncProc=spawn(process.argv[0],["-e",execString]);var statusText;while(fs.existsSync(syncFile)){}self.responseText=fs.readFileSync(contentFile,"utf8");syncProc.stdin.end();fs.unlinkSync(contentFile);if(self.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)){var errorObj=JSON.parse(self.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,""));self.handleError(errorObj,503)}else{self.status=self.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1");var resp=JSON.parse(self.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1"));response={statusCode:self.status,headers:resp.data.headers};self.responseText=resp.data.text;self.response=Buffer.from(resp.data.data,"base64");setState(self.DONE,true)}}};this.handleError=function(error,status){this.status=status||0;this.statusText=error;this.responseText=error.stack;errorFlag=true;setState(this.DONE)};this.abort=function(){if(request){request.abort();request=null}headers=Object.assign({},defaultHeaders);this.responseText="";this.responseXML="";this.response=Buffer.alloc(0);errorFlag=abortedFlag=true;if(this.readyState!==this.UNSENT&&(this.readyState!==this.OPENED||sendFlag)&&this.readyState!==this.DONE){sendFlag=false;setState(this.DONE)}this.readyState=this.UNSENT};this.addEventListener=function(event,callback){if(!(event in listeners)){listeners[event]=[]}listeners[event].push(callback)};this.removeEventListener=function(event,callback){if(event in listeners){listeners[event]=listeners[event].filter(function(ev){return ev!==callback})}};this.dispatchEvent=function(event){if(typeof self["on"+event]==="function"){if(this.readyState===this.DONE&&settings.async)setTimeout(function(){self["on"+event]()},0);else self["on"+event]()}if(event in listeners){for(let i=0,len=listeners[event].length;i<len;i++){if(this.readyState===this.DONE)setTimeout(function(){listeners[event][i].call(self)},0);else listeners[event][i].call(self)}}};var setState=function(state){if(self.readyState===state||self.readyState===self.UNSENT&&abortedFlag)return;self.readyState=state;if(settings.async||self.readyState<self.OPENED||self.readyState===self.DONE){self.dispatchEvent("readystatechange")}if(self.readyState===self.DONE){let fire;if(abortedFlag)fire="abort";else if(errorFlag)fire="error";else fire="load";self.dispatchEvent(fire);self.dispatchEvent("loadend")}}}},{child_process:undefined,fs:undefined,http:undefined,https:undefined,url:undefined}],332:[function(require,module,exports){module.exports=[{type:1,objectType:2,objectKind:0,objectCount:[10,25,50,100,200,500,1e3,2500,5e3,1e4]},{type:2,objectType:0,objectKind:0,objectCount:[10,25,50,100,200,500,1e3]},{type:4,objectType:0,objectKind:0,objectCount:[1e3,2500,5e3,1e4,25e3,5e4,1e5,25e4,5e5,1e6]},{type:5,objectType:0,objectKind:0,objectCount:[10,25,50,100,200,500,1e3],data1:"hammer"},{type:6,objectType:0,objectKind:0,objectCount:[10,25,50,100,200,500,1e3]},{type:5,objectType:0,objectKind:0,objectCount:[20,50,100,200,500,1e3,2e3],data1:"any"}]},{}],333:[function(require,module,exports){module.exports=[{name:"Sword 1",type:"weapon",sprite:"sword1",buy:0},{name:"Sword 2",type:"weapon",sprite:"sword2",buy:500},{name:"Axe",type:"weapon",sprite:"axe",buy:1e3},{name:"Morning Star",type:"weapon",sprite:"morningstar",buy:1500},{name:"Blue Sword",type:"weapon",sprite:"bluesword",buy:2e3},{name:"Red Sword",type:"weapon",sprite:"redsword",buy:2500},{name:"Golden Sword",type:"weapon",sprite:"goldensword",buy:3e3},{name:"Side Sword",type:"weapon",sprite:"sidesword",buy:3500},{name:"Spear",type:"weapon",sprite:"spear",buy:4e3},{name:"Scimitar",type:"weapon",sprite:"scimitar",buy:4500},{name:"Trident",type:"weapon",sprite:"trident",buy:5e3},{name:"Blue Scimitar",type:"weapon",sprite:"bluescimitar",buy:5500},{name:"Hammer",type:"weapon",sprite:"hammer",buy:6e3},{name:"Green Light Saber",type:"weapon",sprite:"greenlightsaber",buy:6500},{name:"Sky Light Saber",type:"weapon",sprite:"skylightsaber",buy:7e3},{name:"Red Light Saber",type:"weapon",sprite:"redlightsaber",buy:7500},{name:"Bastard Sword",type:"weapon",sprite:"bastardsword",buy:8e3},{name:"Red Metal Sword",type:"weapon",sprite:"redmetalsword",buy:8500},{name:"Justice Hammer",type:"weapon",sprite:"justicehammer",buy:9e3},{name:"Rose",type:"weapon",sprite:"rose",buy:9500},{name:"Ice Rose",type:"weapon",sprite:"icerose",buy:1e4},{name:"Halberd",type:"weapon",sprite:"halberd",buy:10500},{name:"Whip",type:"weapon",sprite:"whip",buy:11e3},{name:"Forest Guardian Sword",type:"weapon",sprite:"forestguardiansword",buy:11500},{name:"Sickle",type:"weapon",sprite:"sickle",buy:12e3},{name:"Plunger",type:"weapon",sprite:"plunger",buy:12500},{name:"Red Sickle",type:"weapon",sprite:"redsickle",buy:13e3},{name:"Day Walker",type:"weapon",sprite:"daywalker",buy:13500},{name:"Purple Cloud Kallege",type:"weapon",sprite:"purplecloudkallege",buy:14e3},{name:"Sea Rage",type:"weapon",sprite:"searage",buy:14500},{name:"Breaker",type:"weapon",sprite:"breaker",buy:15e3},{name:"Enel Trident",type:"weapon",sprite:"eneltrident",buy:15500},{name:"Rainbow Sword",type:"weapon",sprite:"rainbowsword",buy:16e3},{name:"Typhoon",type:"weapon",sprite:"typhoon",buy:16500},{name:"Memme",type:"weapon",sprite:"memme",buy:17e3},{name:"Candybar",type:"weapon",sprite:"candybar",buy:17500},{name:"Butcher Knife",type:"weapon",sprite:"butcherknife",buy:18e3},{name:"Fire Shot",type:"weapon",sprite:"fireshot",buy:18500},{name:"Comb",type:"weapon",sprite:"comb",buy:19e3},{name:"Squeaky Hammer",type:"weapon",sprite:"squeakyhammer",buy:19500},{name:"Fire Play",type:"weapon",sprite:"fireplay",buy:2e4},{name:"Wea Staff",type:"weapon",sprite:"weastaff",buy:20500},{name:"Pink Sword",type:"weapon",sprite:"pinksword",buy:21e3},{name:"Conference Call",type:"weapon",sprite:"conferencecall",buy:21500},{name:"Cactus Axe",type:"weapon",sprite:"cactusaxe",buy:22e3},{name:"Devil Kazya Sword",type:"weapon",sprite:"devilkazyasword",buy:22500},{name:"Bamboo Spear",type:"weapon",sprite:"bamboospear",buy:23e3},{name:"Paewoldo",type:"weapon",sprite:"paewoldo",buy:23500},{name:"Magic Spear",type:"weapon",sprite:"magicspear",buy:24e3},{name:"Fire Sword",type:"weapon",sprite:"firesword",buy:24500},{name:"Wooden Bow",type:"weaponarcher",sprite:"woodenbow",buy:0},{name:"Plastic Bow",type:"weaponarcher",sprite:"plasticbow",buy:500},{name:"Iron Bow",type:"weaponarcher",sprite:"ironbow",buy:1e3},{name:"Red Bow",type:"weaponarcher",sprite:"redbow",buy:1500},{name:"Violet Bow",type:"weaponarcher",sprite:"violetbow",buy:2e3},{name:"Death Bow",type:"weaponarcher",sprite:"deathbow",buy:2500},{name:"Golden Bow",type:"weaponarcher",sprite:"goldenbow",buy:3e3},{name:"Watermelon Bow",type:"weaponarcher",sprite:"watermelonbow",buy:3500},{name:"Green Bow",type:"weaponarcher",sprite:"greenbow",buy:4e3},{name:"Redenel Bow",type:"weaponarcher",sprite:"redenelbow",buy:4500},{name:"Mermaid Bow",type:"weaponarcher",sprite:"mermaidbow",buy:5e3},{name:"Seahorse Bow",type:"weaponarcher",sprite:"seahorsebow",buy:5500},{name:"Hunter Bow",type:"weaponarcher",sprite:"hunterbow",buy:6e3},{name:"Green Light Bow",type:"weaponarcher",sprite:"greenlightbow",buy:6500},{name:"Sky Light Bow",type:"weaponarcher",sprite:"skylightbow",buy:7e3},{name:"Red Light Bow",type:"weaponarcher",sprite:"redlightbow",buy:7500},{name:"Captain Bow",type:"weaponarcher",sprite:"captainbow",buy:8e3},{name:"Red Metal Bow",type:"weaponarcher",sprite:"redmetalbow",buy:8500},{name:"Justice Bow",type:"weaponarcher",sprite:"justicebow",buy:9e3},{name:"Rose Bow",type:"weaponarcher",sprite:"rosebow",buy:9500},{name:"Marine Bow",type:"weaponarcher",sprite:"marinebow",buy:1e4},{name:"Crystal Bow",type:"weaponarcher",sprite:"crystalbow",buy:10500},{name:"Colorful Bow",type:"weaponarcher",sprite:"gaybow",buy:11e3},{name:"Forest Bow",type:"weaponarcher",sprite:"forestbow",buy:11500},{name:"Sickle Bow",type:"weaponarcher",sprite:"sicklebow",buy:12e3},{name:"Blood Bow",type:"weaponarcher",sprite:"bloodbow",buy:12500},{name:"Red Sickle Bow",type:"weaponarcher",sprite:"redsicklebow",buy:13e3},{name:"Cloth Armor",type:"armor",sprite:"clotharmor",buy:0},{name:"Leather Armor",type:"armor",sprite:"leatherarmor",buy:500},{name:"Mail Armor",type:"armor",sprite:"mailarmor",buy:1e3},{name:"Plate Armor",type:"armor",sprite:"platearmor",buy:1500},{name:"Red Armor",type:"armor",sprite:"redarmor",buy:2e3},{name:"Golden Armor",type:"armor",sprite:"goldenarmor",buy:2500},{name:"Green Armor",type:"armor",sprite:"greenarmor",buy:3e3},{name:"Green Wing Armor",type:"armor",sprite:"greenwingarmor",buy:3500},{name:"Guard Armor",type:"armor",sprite:"guardarmor",buy:4e3},{name:"Red Guard Armor",type:"armor",sprite:"redguardarmor",buy:4500},{name:"White Armor",type:"armor",sprite:"whitearmor",buy:5e3},{name:"Rat Armor",type:"armor",sprite:"ratarmor",buy:5500},{name:"Blue Pirate Armor",type:"armor",sprite:"bluepiratearmor",buy:6e3},{name:"Cheoli Armor",type:"armor",sprite:"cheoliarmor",buy:6500},{name:"Dovakin Armor",type:"armor",sprite:"dovakinarmor",buy:7e3},{name:"GB Wing Armor",type:"armor",sprite:"gbwingarmor",buy:7500},{name:"Red Wing Armor",type:"armor",sprite:"redwingarmor",buy:8e3},{name:"Snow Fox Armor",type:"armor",sprite:"snowfoxarmor",buy:8500},{name:"Wolf Armor",type:"armor",sprite:"wolfarmor",buy:9e3},{name:"Blue Wing Armor",type:"armor",sprite:"bluewingarmor",buy:9500},{name:"Thief Armor",type:"armor",sprite:"thiefarmor",buy:1e4},{name:"Ninja Armor",type:"armor",sprite:"ninjaarmor",buy:10500},{name:"Dragon Armor",type:"armor",sprite:"dragonarmor",buy:11e3},{name:"Fallen Armor",type:"armor",sprite:"fallenarmor",buy:11500},{name:"Paladin Armor",type:"armor",sprite:"paladinarmor",buy:12e3},{name:"Crystal Armor",type:"armor",sprite:"crystalarmor",buy:12500},{name:"Adherer Robe",type:"armor",sprite:"adhererrobe",buy:13e3},{name:"Frost Armor",type:"armor",sprite:"frostarmor",buy:13500},{name:"Strap Armor",type:"armor",sprite:"gayarmor",buy:14e3},{name:"School Uniform",type:"armor",sprite:"schooluniform",buy:14500},{name:"Beautiful Life",type:"armor",sprite:"beautifullife",buy:15e3},{name:"Region Armor",type:"armor",sprite:"regionarmor",buy:15500},{name:"Ghost Rider",type:"armor",sprite:"ghostrider",buy:16e3},{name:"Taekwondo",type:"armor",sprite:"taekwondo",buy:16500},{name:"Rabbit Armor",type:"armor",sprite:"rabbitarmor",buy:17e3},{name:"Portal Armor",type:"armor",sprite:"portalarmor",buy:17500},{name:"Pirate King",type:"armor",sprite:"pirateking",buy:18e3},{name:"Sea Dragon Armor",type:"armor",sprite:"seadragonarmor",buy:18500},{name:"Shadow Region Armor",type:"armor",sprite:"shadowregionarmor",buy:19e3},{name:"Enel Armor",type:"armor",sprite:"enelarmor",buy:19500},{name:"Mini Sea Dragon Armor",type:"armor",sprite:"miniseadragonarmor",buy:2e4},{name:"Huni Armor",type:"armor",sprite:"huniarmor",buy:20500},{name:"Dambo Armor",type:"armor",sprite:"damboarmor",buy:21e3},{name:"Squid Armor",type:"armor",sprite:"squidarmor",buy:21500},{name:"Bee Armor",type:"armor",sprite:"beearmor",buy:22e3},{name:"Blue Dambo Armor",type:"armor",sprite:"bluedamboarmor",buy:22500},{name:"Rudolf Armor",type:"armor",sprite:"rudolfarmor",buy:23e3},{name:"Christmas Armor",type:"armor",sprite:"christmasarmor",buy:23500},{name:"Robocop Armor",type:"armor",sprite:"robocoparmor",buy:24e3},{name:"Pink Cockroach Armor",type:"armor",sprite:"pinkcockroacharmor",buy:24500},{name:"Cockroach Suit",type:"armor",sprite:"cockroachsuit",buy:25e3},{name:"Dinosaur Armor",type:"armor",sprite:"dinosaurarmor",buy:25500},{name:"Cat Armor",type:"armor",sprite:"catarmor",buy:26e3},{name:"Snowman Armor",type:"armor",sprite:"snowmanarmor",buy:26500},{name:"Beetle Armor",type:"armor",sprite:"beetlearmor",buy:27e3},{name:"Hongcheol Armor",type:"armor",sprite:"hongcheolarmor",buy:27500},{name:"Tiger Armor",type:"armor",sprite:"tigerarmor",buy:28e3},{name:"Wizard Rob",type:"armor",sprite:"wizardrobe",buy:28500},{name:"Iron Knight Armor",type:"armor",sprite:"ironknightarmor",buy:29e3},{name:"Evil Armor",type:"armor",sprite:"evilarmor",buy:29500},{name:"Green Dambo Armor",type:"armor",sprite:"greendamboarmor",buy:3e4},{name:"Red Dambo Armor",type:"armor",sprite:"reddamboarmor",buy:30500},{name:"Devil Kazya Armor",type:"armor",sprite:"devilkazyaarmor",buy:31e3},{name:"Bridal Mask",type:"armor",sprite:"bridalmask",buy:31500},{name:"Black Spider Armor",type:"armor",sprite:"blackspiderarmor",buy:32e3},{name:"Frog Armor",type:"armor",sprite:"frogarmor",buy:32500},{name:"Bearseonbi Armor",type:"armor",sprite:"bearseonbiarmor",buy:33e3},{name:"Raindow A Pro",type:"armor",sprite:"rainbowapro",buy:33500},{name:"Coke Armor",type:"armor",sprite:"cokearmor",buy:34e3},{name:"Fried Potato Armor",type:"armor",sprite:"friedpotatoarmor",buy:34500},{name:"Burger Armor",type:"armor",sprite:"burgerarmor",buy:35e3},{name:"Halloween JK Armor",type:"armor",sprite:"halloweenjkarmor",buy:35500},{name:"Frankenstein Armor",type:"armor",sprite:"frankensteinarmor",buy:36e3},{name:"Admin armor",type:"armor",sprite:"adminarmor",buy:36500},{name:"Cloth Armor",type:"armorarcher",sprite:"clotharmor",buy:0},{name:"Leather Armor",type:"armorarcher",sprite:"leatherarcherarmor",buy:500},{name:"Mail Armor",type:"armorarcher",sprite:"mailarcherarmor",buy:1e3},{name:"Plate Armor",type:"armorarcher",sprite:"platearcherarmor",buy:1500},{name:"Red Armor",type:"armorarcher",sprite:"redarcherarmor",buy:2e3},{name:"Golden Armor",type:"armorarcher",sprite:"goldenarcherarmor",buy:2500},{name:"Green Armor",type:"armorarcher",sprite:"greenarcherarmor",buy:3e3},{name:"Green Wing Armor",type:"armorarcher",sprite:"greenwingarcherarmor",buy:3500},{name:"Guard Armor",type:"armorarcher",sprite:"guardarcherarmor",buy:4e3},{name:"Red Guard Armor",type:"armorarcher",sprite:"redguardarcherarmor",buy:4500},{name:"White Armor",type:"armorarcher",sprite:"whitearcherarmor",buy:5e3},{name:"Pirate Armor",type:"armorarcher",sprite:"piratearcherarmor",buy:5500},{name:"Cheoli Armor",type:"armorarcher",sprite:"cheoliarcherarmor",buy:6e3},{name:"Dovakin Armor",type:"armorarcher",sprite:"dovakinarcherarmor",buy:6500},{name:"GB Wing Armor",type:"armorarcher",sprite:"gbwingarcherarmor",buy:7e3},{name:"Red Wing Armor",type:"armorarcher",sprite:"redwingarcherarmor",buy:7500},{name:"Snow Fox Armor",type:"armorarcher",sprite:"snowfoxarcherarmor",buy:8e3},{name:"Wolf Armor",type:"armorarcher",sprite:"wolfarcherarmor",buy:8500},{name:"Blue Wing Armor",type:"armorarcher",sprite:"bluewingarcherarmor",buy:9e3},{name:"Fallen Armor",type:"armorarcher",sprite:"fallenarcherarmor",buy:9500},{name:"Crystal Armor",type:"armorarcher",sprite:"crystalarcherarmor",buy:1e4},{name:"Legolas Armor",type:"armorarcher",sprite:"legolasarmor",buy:10500},{name:"Adherer Armor",type:"armorarcher",sprite:"adhererarcherarmor",buy:11e3},{name:"School Uniform",type:"armorarcher",sprite:"archerschooluniform",buy:11500},{name:"Combat Uniform",type:"armorarcher",sprite:"combatuniform",buy:12e3},{name:"Strap Armor",type:"armorarcher",sprite:"gayarcherarmor",buy:12500}]},{}],334:[function(require,module,exports){module.exports=[{i:[[310,16]],o:104},{i:[[310,4]],o:105},{i:[[310,4]],o:106},{i:[[310,4]],o:107},{i:[[311,16]],o:108},{i:[[311,4]],o:109},{i:[[311,4]],o:110},{i:[[311,4]],o:111},{i:[[312,16]],o:112},{i:[[312,4]],o:113},{i:[[312,4]],o:114},{i:[[312,4]],o:115},{i:[[301,1],[302,3]],o:305},{i:[[301,1],[303,3]],o:306},{i:[[301,1],[304,3]],o:307},{i:[[301,6],[305,10]],o:201},{i:[[301,6],[305,10]],o:211},{i:[[301,6],[305,10]],o:221},{i:[[301,6],[305,10]],o:231},{i:[[301,6],[306,10]],o:202},{i:[[301,6],[306,10]],o:212},{i:[[301,6],[306,10]],o:222},{i:[[301,6],[306,10]],o:232},{i:[[301,6],[307,10]],o:203},{i:[[301,6],[307,10]],o:213},{i:[[301,6],[307,10]],o:223},{i:[[301,6],[307,10]],o:233}]},{}],335:[function(require,module,exports){module.exports=[]},{}],336:[function(require,module,exports){module.exports=[{name:"Scrolls",sprite:"itemloot.png",offset:[0,0],rarity:"1"},{name:"Dice",sprite:"itemloot.png",offset:[0,1],rarity:"1"},{name:"Book",sprite:"itemloot.png",offset:[0,2],rarity:"1"},{name:"Key",sprite:"itemloot.png",offset:[0,3],rarity:"1"},{name:"Bell",sprite:"itemloot.png",offset:[0,4],rarity:"1"},{name:"Padlock",sprite:"itemloot.png",offset:[0,5],rarity:"1"},{name:"Candle",sprite:"itemloot.png",offset:[0,6],rarity:"1"},{name:"Drumstick",sprite:"itemloot.png",offset:[0,7],rarity:"1"},{name:"IronHelmet",sprite:"itemloot.png",offset:[0,8],rarity:"1"},{name:"Gumnut",sprite:"itemloot.png",offset:[0,9],rarity:"1"},{name:"Fireball",sprite:"itemloot.png",offset:[1,0],rarity:"2"},{name:"WitchHat",sprite:"itemloot.png",offset:[1,1],rarity:"2"},{name:"Chest",sprite:"itemloot.png",offset:[1,2],rarity:"2"},{name:"Shield",sprite:"itemloot.png",offset:[1,3],rarity:"2"},{name:"Log",sprite:"itemloot.png",offset:[1,4],rarity:"2"},{name:"RingOne",sprite:"itemloot.png",offset:[1,5],rarity:"2"},{name:"DreamCatcher",sprite:"itemloot.png",offset:[1,6],rarity:"2"},{name:"SealedScroll",sprite:"itemloot.png",offset:[1,7],rarity:"2"},{name:"Spider",sprite:"itemloot.png",offset:[1,8],rarity:"2"},{name:"MeltedCandles",sprite:"itemloot.png",offset:[1,9],rarity:"2"},{name:"Feather",sprite:"itemloot.png",offset:[2,0],rarity:"3"},{name:"Compass",sprite:"itemloot.png",offset:[2,1],rarity:"3"},{name:"PinkFireball",sprite:"itemloot.png",offset:[2,2],rarity:"3"},{name:"Gem",sprite:"itemloot.png",offset:[2,3],rarity:"3"},{name:"FireEye",sprite:"itemloot.png",offset:[2,4],rarity:"3"},{name:"TotemFace",sprite:"itemloot.png",offset:[2,5],rarity:"3"},{name:"Gadget",sprite:"itemloot.png",offset:[2,6],rarity:"3"},{name:"Frog",sprite:"itemloot.png",offset:[2,7],rarity:"3"},{name:"ThrowingDagger",sprite:"itemloot.png",offset:[2,8],rarity:"3"},{name:"UrnOne",sprite:"itemloot.png",offset:[2,9],rarity:"3"},{name:"NecklaceOne",sprite:"itemloot.png",offset:[3,0],rarity:"4"},{name:"Squid",sprite:"itemloot.png",offset:[3,1],rarity:"4"},{name:"ClubOne",sprite:"itemloot.png",offset:[3,2],rarity:"4"},{name:"Crystals",sprite:"itemloot.png",offset:[3,3],rarity:"4"},{name:"Mace",sprite:"itemloot.png",offset:[3,4],rarity:"4"},{name:"CoinPouch",sprite:"itemloot.png",offset:[3,5],rarity:"4"},{name:"NecklaceTwo",sprite:"itemloot.png",offset:[3,6],rarity:"4"},{name:"Bones",sprite:"itemloot.png",offset:[3,7],rarity:"4"},{name:"RingTwo",sprite:"itemloot.png",offset:[3,8],rarity:"4"},{name:"AnimalSkull",sprite:"itemloot.png",offset:[3,9],rarity:"4"},{name:"Leaf",sprite:"itemloot.png",offset:[4,0],rarity:"5"},{name:"Cheese",sprite:"itemloot.png",offset:[4,1],rarity:"5"},{name:"Mushrooms",sprite:"itemloot.png",offset:[4,2],rarity:"5"},{name:"FeatherQuill",sprite:"itemloot.png",offset:[4,3],rarity:"5"},{name:"BoneEaring",sprite:"itemloot.png",offset:[4,4],rarity:"5"},{name:"Crate",sprite:"itemloot.png",offset:[4,5],rarity:"5"},{name:"Bat",sprite:"itemloot.png",offset:[4,6],rarity:"5"},{name:"PoisonVial",sprite:"itemloot.png",offset:[4,7],rarity:"5"},{name:"ScrollsThree",sprite:"itemloot.png",offset:[4,8],rarity:"5"},{name:"Bug",sprite:"itemloot.png",offset:[4,9],rarity:"5"},{name:"Anvil",sprite:"itemloot.png",offset:[5,0],rarity:"6"},{name:"BrokenGlass",sprite:"itemloot.png",offset:[5,1],rarity:"6"},{name:"Goblet",sprite:"itemloot.png",offset:[5,2],rarity:"6"},{name:"SkullRingTwo",sprite:"itemloot.png",offset:[5,3],rarity:"6"},{name:"MonsterClaw",sprite:"itemloot.png",offset:[5,4],rarity:"6"},{name:"PoisonVialTwo",sprite:"itemloot.png",offset:[5,5],rarity:"6"},{name:"BronzeHelmet",sprite:"itemloot.png",offset:[5,6],rarity:"6"},{name:"BasicKnife",sprite:"itemloot.png",offset:[5,7],rarity:"6"},{name:"Worms",sprite:"itemloot.png",offset:[5,8],rarity:"6"},{name:"AutumnLeaf",sprite:"itemloot.png",offset:[5,9],rarity:"6"},{name:"Drum",sprite:"itemloot.png",offset:[6,0],rarity:"7"},{name:"Acorns",sprite:"itemloot.png",offset:[6,1],rarity:"7"},{name:"Pendant",sprite:"itemloot.png",offset:[6,2],rarity:"7"},{name:"Lute",sprite:"itemloot.png",offset:[6,3],rarity:"7"},{name:"RingThree",sprite:"itemloot.png",offset:[6,4],rarity:"7"},{name:"BattleAxe",sprite:"itemloot.png",offset:[6,5],rarity:"7"},{name:"AncientShield",sprite:"itemloot.png",offset:[6,6],rarity:"7"},{name:"Broach",sprite:"itemloot.png",offset:[6,7],rarity:"7"},{name:"Maul",sprite:"itemloot.png",offset:[6,8],rarity:"7"},{name:"SmokePipe",sprite:"itemloot.png",offset:[6,9],rarity:"7"},{name:"Lizard",sprite:"itemloot.png",offset:[7,0],rarity:"8"},{name:"DragonEgg",sprite:"itemloot.png",offset:[7,1],rarity:"8"},{name:"MarbleJar",sprite:"itemloot.png",offset:[7,2],rarity:"8"},{name:"OldBottle",sprite:"itemloot.png",offset:[7,3],rarity:"8"},{name:"ShortSword",sprite:"itemloot.png",offset:[7,4],rarity:"8"},{name:"BookTwo",sprite:"itemloot.png",offset:[7,5],rarity:"8"},{name:"Bread",sprite:"itemloot.png",offset:[7,6],rarity:"8"},{name:"Mirror",sprite:"itemloot.png",offset:[7,7],rarity:"8"},{name:"Cards",sprite:"itemloot.png",offset:[7,8],rarity:"8"},{name:"PotOfGold",sprite:"itemloot.png",offset:[7,9],rarity:"8"},{name:"FaceMask",sprite:"itemloot.png",offset:[8,0],rarity:"9"},{name:"Bomb",sprite:"itemloot.png",offset:[8,1],rarity:"9"},{name:"HandBag",sprite:"itemloot.png",offset:[8,2],rarity:"9"},{name:"ToothNecklace",sprite:"itemloot.png",offset:[8,3],rarity:"9"},{name:"NecklaceThree",sprite:"itemloot.png",offset:[8,4],rarity:"9"},{name:"LeafWreath",sprite:"itemloot.png",offset:[8,5],rarity:"9"},{name:"Eyeball",sprite:"itemloot.png",offset:[8,6],rarity:"9"},{name:"CrudeDagger",sprite:"itemloot.png",offset:[8,7],rarity:"9"},{name:"SapJewel",sprite:"itemloot.png",offset:[8,8],rarity:"9"},{name:"Clever",sprite:"itemloot.png",offset:[8,9],rarity:"9"},{name:"MortAndPestle",sprite:"itemloot.png",offset:[9,0],rarity:"10"},{name:"WoodHorn",sprite:"itemloot.png",offset:[9,1],rarity:"10"},{name:"Pumpkin",sprite:"itemloot.png",offset:[9,2],rarity:"10"},{name:"HumanSkull",sprite:"itemloot.png",offset:[9,3],rarity:"10"},{name:"Thorns",sprite:"itemloot.png",offset:[9,4],rarity:"10"},{name:"FineComb",sprite:"itemloot.png",offset:[9,5],rarity:"10"},{name:"Cauldron",sprite:"itemloot.png",offset:[9,6],rarity:"10"},{name:"MagicBall",sprite:"itemloot.png",offset:[9,7],rarity:"10"},{name:"Mushroom",sprite:"itemloot.png",offset:[9,8],rarity:"10"},{name:"Hook",sprite:"itemloot.png",offset:[9,9],rarity:"10"},{name:"NordicCup",sprite:"itemloot.png",offset:[10,0],rarity:"10"}]},{}],337:[function(require,module,exports){module.exports=[{id:1,name:"Crude Club",type:"weapon",typemod:"attack",modifier:10,staticsheet:2,legacy:1,offset:[3,10]},{id:2,name:"Crude Sword",type:"weapon",typemod:"attack",modifier:20,staticsheet:2,legacy:1,offset:[5,9]},{id:3,name:"Beginnner Sword",type:"weapon",typemod:"attack",modifier:30,staticsheet:2,legacy:1,offset:[8,11]},{id:4,name:"Iron Sword",type:"weapon",typemod:"attack",modifier:40,staticsheet:2,legacy:1,offset:[4,0]},{id:5,name:"Steel Sword",type:"weapon",typemod:"attack",modifier:50,staticsheet:2,legacy:1,offset:[4,1]},{id:6,name:"Bronze Sword",type:"weapon",typemod:"attack",modifier:60,staticsheet:2,legacy:1,offset:[4,2]},{id:7,name:"Golden Sword",type:"weapon",typemod:"attack",modifier:70,staticsheet:2,legacy:1,offset:[4,3]},{id:8,name:"Glass Sword",type:"weapon",typemod:"attack",modifier:80,staticsheet:2,legacy:1,offset:[4,4]},{id:9,name:"Adamantite Sword",type:"weapon",typemod:"attack",modifier:90,staticsheet:2,legacy:1,offset:[4,5]},{id:10,name:"Plate Sword",type:"weapon",typemod:"attack",modifier:100,staticsheet:2,legacy:1,offset:[4,6]},{id:11,name:"Draconian Sword",type:"weapon",typemod:"attack",modifier:110,staticsheet:2,legacy:1,offset:[4,7]},{id:12,name:"Slingshot",type:"weaponarcher",typemod:"attack",modifier:10,staticsheet:2,legacy:1,offset:[1,10]},{id:13,name:"Crude Bow",type:"weaponarcher",typemod:"attack",modifier:20,staticsheet:2,legacy:1,offset:[7,8]},{id:14,name:"Beginner Bow",type:"weaponarcher",typemod:"attack",modifier:30,staticsheet:2,legacy:1,offset:[9,11]},{id:15,name:"Iron Bow",type:"weaponarcher",typemod:"attack",modifier:40,staticsheet:2,legacy:1,offset:[7,0]},{id:16,name:"Steel Bow",type:"weaponarcher",typemod:"attack",modifier:50,staticsheet:2,legacy:1,offset:[7,1]},{id:17,name:"Bronze Bow",type:"weaponarcher",typemod:"attack",modifier:60,staticsheet:2,legacy:1,offset:[7,2]},{id:18,name:"Gold Bow",type:"weaponarcher",typemod:"attack",modifier:70,staticsheet:2,legacy:1,offset:[7,3]},{id:19,name:"Glass Bow",type:"weaponarcher",typemod:"attack",modifier:80,staticsheet:2,legacy:1,offset:[7,4]},{id:20,name:"Adamantite Bow",type:"weaponarcher",typemod:"attack",modifier:90,staticsheet:2,legacy:1,offset:[7,5]},{id:21,name:"Plate Bow",type:"weaponarcher",typemod:"attack",modifier:100,staticsheet:2,legacy:1,offset:[7,6]},{id:22,name:"Draconian Bow",type:"weaponarcher",typemod:"attack",modifier:110,staticsheet:2,legacy:1,offset:[7,7]},{id:23,name:"Fur Armor",type:"armor",typemod:"defense",modifier:10,staticsheet:2,legacy:1,offset:[11,12]},{id:24,name:"Padded Armor",type:"armor",typemod:"defense",modifier:20,staticsheet:2,legacy:1,offset:[11,11]},{id:25,name:"Leather Armor",type:"armor",typemod:"defense",modifier:30,staticsheet:2,legacy:1,offset:[11,10]},{id:26,name:"Iron Armor",type:"armor",typemod:"defense",modifier:40,staticsheet:2,legacy:1,offset:[11,0]},{id:27,name:"Steel Armor",type:"armor",typemod:"defense",modifier:50,staticsheet:2,legacy:1,offset:[11,1]},{id:28,name:"Bronze Armor",type:"armor",typemod:"defense",modifier:60,staticsheet:2,legacy:1,offset:[11,2]},{id:29,name:"Golden Armor",type:"armor",typemod:"defense",modifier:70,staticsheet:2,legacy:1,offset:[11,3]},{id:30,name:"Glass Armor",type:"armor",typemod:"defense",modifier:80,staticsheet:2,legacy:1,offset:[11,4]},{id:31,name:"Adamantite Armor",type:"armor",typemod:"defense",modifier:90,staticsheet:2,legacy:1,offset:[11,5]},{id:32,name:"Plate Armor",type:"armor",typemod:"defense",modifier:100,staticsheet:2,legacy:1,offset:[11,6]},{id:33,name:"Draconian Armor",type:"armor",typemod:"defense",modifier:110,staticsheet:2,legacy:1,offset:[11,7]},{id:34,name:"Flask +500 HP",type:"object",typemod:"health",modifier:500,sprite:"item/item-flask.png",spriteName:"item-flask",offset:[0,0],buy:10,buycount:10},{id:35,name:"Burger +250 Energy",type:"object",typemod:"energy",modifier:250,sprite:"item/item-burger.png",spriteName:"item-burger",offset:[0,0],buy:30,buycount:10},{id:36,name:"Big Flask +25% HP",type:"object",typemod:"healthpercent",modifier:25,sprite:"item/item-bigflask.png",spriteName:"item-bigflask",offset:[0,0],buy:50,buycount:10},{id:100,name:"Leather Chest 1",type:"chest",typemod:"defense",level:10,modifier:10,staticsheet:1,spriteName:"armors",offset:[0,5]},{id:101,name:"Leather Helmet 1",type:"helm",typemod:"defense",level:12,modifier:5,staticsheet:1,spriteName:"armors",offset:[0,4]},{id:102,name:"Leather Gloves 1",type:"gloves",typemod:"defense",level:14,modifier:5,staticsheet:1,spriteName:"armors",offset:[0,6]},{id:103,name:"Leather Boots 1",type:"boots",typemod:"defense",level:16,modifier:5,staticsheet:1,spriteName:"armors",offset:[0,7]},{id:104,name:"Leather Chest 2",type:"chest",typemod:"defense",level:20,modifier:20,staticsheet:1,spriteName:"armors",offset:[1,5]},{id:105,name:"Leather Helmet 2",type:"helm",typemod:"defense",level:22,modifier:10,staticsheet:1,spriteName:"armors",offset:[1,4]},{id:106,name:"Leather Gloves 2",type:"gloves",typemod:"defense",level:24,modifier:10,staticsheet:1,spriteName:"armors",offset:[1,6]},{id:107,name:"Leather Boots 2",type:"boots",typemod:"defense",level:26,modifier:10,staticsheet:1,spriteName:"armors",offset:[1,7]},{id:108,name:"Leather Chest 3",type:"chest",typemod:"defense",level:30,modifier:30,staticsheet:1,spriteName:"armors",offset:[2,5]},{id:109,name:"Leather Helmet 3",type:"helm",typemod:"defense",level:32,modifier:15,staticsheet:1,spriteName:"armors",offset:[2,4]},{id:110,name:"Leather Gloves 3",type:"gloves",typemod:"defense",level:34,modifier:15,staticsheet:1,spriteName:"armors",offset:[2,6]},{id:111,name:"Leather Boots 3",type:"boots",typemod:"defense",level:36,modifier:15,staticsheet:1,spriteName:"armors",offset:[2,7]},{id:112,name:"Leather Chest 4",type:"chest",typemod:"defense",level:40,modifier:40,staticsheet:1,spriteName:"armors",offset:[3,5]},{id:113,name:"Leather Helmet 4",type:"helm",typemod:"defense",level:42,modifier:20,staticsheet:1,spriteName:"armors",offset:[3,4]},{id:114,name:"Leather Gloves 4",type:"gloves",typemod:"defense",level:44,modifier:20,staticsheet:1,spriteName:"armors",offset:[3,6]},{id:115,name:"Leather Boots 4",type:"boots",typemod:"defense",level:46,modifier:20,staticsheet:1,spriteName:"armors",offset:[3,7]},{id:200,name:"Sword 1",type:"sword",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,0]},{id:201,name:"Sword 2",type:"sword",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,0]},{id:202,name:"Sword 3",type:"sword",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,0]},{id:203,name:"Sword 4",type:"sword",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,0]},{id:204,name:"Sword 5",type:"sword",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,0]},{id:205,name:"Sword 6",type:"sword",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,0]},{id:206,name:"Sword 7",type:"sword",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,0]},{id:207,name:"Sword 8",type:"sword",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,0]},{id:208,name:"Sword 9",type:"sword",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,0]},{id:209,name:"Sword 10",type:"sword",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,0]},{id:210,name:"Bow 1",type:"bow",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,3]},{id:211,name:"Bow 2",type:"bow",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,3]},{id:212,name:"Bow 3",type:"bow",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,3]},{id:213,name:"Bow 4",type:"bow",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,3]},{id:214,name:"Bow 5",type:"bow",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,3]},{id:215,name:"Bow 6",type:"bow",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,3]},{id:216,name:"Bow 7",type:"bow",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,3]},{id:217,name:"Bow 8",type:"bow",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,3]},{id:218,name:"Bow 9",type:"bow",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,3]},{id:219,name:"Bow 10",type:"bow",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,3]},{id:220,name:"Hammer 1",type:"hammer",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,5]},{id:221,name:"Hammer 2",type:"hammer",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,5]},{id:222,name:"Hammer 3",type:"hammer",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,5]},{id:223,name:"Hammer 4",type:"hammer",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,5]},{id:224,name:"Hammer 5",type:"hammer",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,5]},{id:225,name:"Hammer 6",type:"hammer",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,5]},{id:226,name:"Hammer 7",type:"hammer",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,5]},{id:227,name:"Hammer 8",type:"hammer",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,5]},{id:228,name:"Hammer 9",type:"hammer",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,5]},{id:229,name:"Hammer 10",type:"hammer",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,5]},{id:230,name:"Axe 1",type:"axe",typemod:"attack",level:10,modifier:10,staticsheet:4,spriteName:"weapons",offset:[0,8]},{id:231,name:"Axe 2",type:"axe",typemod:"attack",level:20,modifier:20,staticsheet:4,spriteName:"weapons",offset:[1,8]},{id:232,name:"Axe 3",type:"axe",typemod:"attack",level:30,modifier:30,staticsheet:4,spriteName:"weapons",offset:[2,8]},{id:233,name:"Axe 4",type:"axe",typemod:"attack",level:40,modifier:40,staticsheet:4,spriteName:"weapons",offset:[3,8]},{id:234,name:"Axe 5",type:"axe",typemod:"attack",level:50,modifier:50,staticsheet:4,spriteName:"weapons",offset:[4,8]},{id:235,name:"Axe 6",type:"axe",typemod:"attack",level:60,modifier:60,staticsheet:4,spriteName:"weapons",offset:[5,8]},{id:236,name:"Axe 7",type:"axe",typemod:"attack",level:70,modifier:70,staticsheet:4,spriteName:"weapons",offset:[6,8]},{id:237,name:"Axe 8",type:"axe",typemod:"attack",level:80,modifier:80,staticsheet:4,spriteName:"weapons",offset:[7,8]},{id:238,name:"Axe 9",type:"axe",typemod:"attack",level:90,modifier:90,staticsheet:4,spriteName:"weapons",offset:[8,8]},{id:239,name:"Axe 10",type:"axe",typemod:"attack",level:100,modifier:100,staticsheet:4,spriteName:"weapons",offset:[9,8]},{id:300,name:"Stone",type:"craft",level:10,staticsheet:5,spriteName:"gather1",offset:[1,0]},{id:301,name:"Coal",type:"craft",level:20,staticsheet:8,spriteName:"nodeset2",offset:[1,0]},{id:302,name:"Light Iron",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[1,1]},{id:303,name:"Medium Iron",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[1,2]},{id:304,name:"Hard Iron",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[1,3]},{id:305,name:"Iron Ingot 1",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[2,1]},{id:306,name:"Iron Ingot 2",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[2,2]},{id:307,name:"Iron Ingot 3",type:"craft",staticsheet:8,spriteName:"nodeset2",offset:[2,3]},{id:310,name:"Leather 1",type:"craft",staticsheet:6,spriteName:"craft1",offset:[0,0]},{id:311,name:"Leather 2",type:"craft",staticsheet:6,spriteName:"craft1",offset:[1,0]},{id:312,name:"Leather 3",type:"craft",staticsheet:6,spriteName:"craft1",offset:[2,0]},{id:313,name:"Leather 4",type:"craft",staticsheet:6,spriteName:"craft1",offset:[3,0]},{id:320,name:"Wood",type:"craft",staticsheet:7,spriteName:"craft2",offset:[0,0]}]},{}],338:[function(require,module,exports){module.exports={EN:{BANK_FULL:"Bank is full.",EQUIPMENT_FULL:"Equipment is full.",INVENTORY_FULL:"Inventory is full.",ITEM_ADDED:"{0} added",GOLD_ADDED:"{0} gold added",GOLD_ZERO:"0 gold",GOLD_REMOVED:"{0} gold removed",EQUIPMENT_LEVEL:"You need to be level {0} to equip this.",EQUIPMENT_WRONGCLASS:"Your class cannot use this Item.",CHAT_MUTED:"You are currently muted.",MAP_ENTERED:"{0} has entered the {1} map.",NOTICE_1:"Go to the Google Play Store and rate Retro RPG Online!",TRADE_REQUESTED:"You requested a trade with {0}.",TRADE_REQUEST:"{0} has requested to trade you.",TUTORIAL_MOVE:"Click or Tap on land to move.",TUTORIAL_ATTACK:"Now click or tap on a Monster to attack",TUTORIAL_ATTACK2:"Thats it now kill more Monsters.",TUTORIAL_EQUIP:"Now I want to equip my brought gear by going into Menu Backpack and selecting it.",TUTORIAL_SHOPBUY:"I should find the Beginner Store by going to the menu and pressing Town.",TUTORIAL_SHOPBUY2:"I want to buy my first Armor and Weapon that is Level 10.",TUTORIAL_STATS:"You can now assign custom Stats in Menu >> Character >> 3rd Page (Character Stats),",TUTORIAL_PORTAL:"In the Town House move to the blue Portal near the bottom left.",SHOP_REPAIRED:"{0} item repaired.",SHOP_REMOVED:"{0} item removed.",SHOP_SOLD:"{0} has been sold.",SHOP_BUY:"{0} has been bought.",SHOP_ENCHANTED:"{0} has been enchanted.",SHOP_NOGOLD:"You don't have enough Gold.",SHOP_NOGEMS:"You don't have enough Gems.",SHOP_NOSPACE:"There is not enough space in your inventory.",SHOP_MISMATCH:"The price has been changed, please try again.",AUCTION_ADDED:"The auction item you listed has been added.",SHOP_NOCRAFTITEMS:"You do not have enough craft Items.",SHOP_MISSINGITEMS:"You are missing {0} {1}'s",SHOP_UNLOCK_CONFIRM:"Do you want to unlock this appearance for {0} gems?",COMBAT_PLAYERKILLED:"/1 {0} killed {1} in combat.",COMBAT_TARGETINVINCIBLE:"Target is invincible.",GROUP_PLAYERLEFT:"{0} has left your group.",ATTACK_TOOFAR:"You are too far away to attack.",TUTORIAL:"TUTORIAL",TUTORIAL_1:"To Move, Mouse click on the Map or an Object, or use the WASD or arrow keys.",TUTORIAL_2:"To Attack, Mouse click on the Object or get in attack range and press Space bar.",TUTORIAL_3:"To Cycle Targets, use keys T to target the closest Object or Y to reverse target.",TUTORIAL_4:"You can use Keys 1-4 for Skill Shortcuts, and Keys 5-8 for consumables like Potions.",TUTORIAL_5:"If you need to buy items you can select Menu >> Town to instantly warp to Town.",TUTORIAL_6:"At level 10 you can equip Items in Menu >> Equipment, and at level 20 you can assign Stat Points.",ACHIEVEMENTS_0:"Kill {0} Monsters.",ACHIEVEMENTS_1:"Collect {0} Items.",ACHIEVEMENTS_2:"Do {0} Damage to Monsters.",ACHIEVEMENTS_3:"Mine {0} Nodes.",ACHIEVEMENTS_4:"Log {0} Trees.",ACHIEVEMENTS_5:"Interact with {0} Objects.",ACHIEVEMENTS_0_COMPLETE:"Achievement - Kill {0} Monsters Completed. {1}XP Added.",ACHIEVEMENTS_1_COMPLETE:"Achievement - Collect {0} Items Completed. {1}XP Added.",ACHIEVEMENTS_2_COMPLETE:"Achievement - Do {0} Damage to Monsters Completed. {1}XP Added.",ACHIEVEMENTS_3_COMPLETE:"Achievement - Mine {0} Nodes Completed. {1}XP Added.",ACHIEVEMENTS_4_COMPLETE:"Achievement - Log {0} Trees Completed. {1}XP Added.",ACHIEVEMENTS_5_COMPLETE:"Achievement - Interact with {0} Objects Completed. {1}XP Added.",PARTY_PLAYER_INVITE_SENT:"Party invite sent to player {0}",PARTY_MAX_PLAYERS:"Max players reached in party.",PARTY_PLAYER_JOINED:"{0} joined your party.",PARTY_PLAYER_ADDED:"You are now partied with {0}",PARTY_YOU_REJECTED_INVITE:"You rejected {0}'s invite.",PARTY_THEY_REJECTED_INVITE:"{0} rejected your invite.",PARTY_CANNOT_KICK:"You cannot kick as you are not in a party or leader.",PARTY_PLAYER_KICKED:"You have been kicked from the party.",PARTY_NOT_LEADER:"You cannot set the leader as you are not in a party.",PARTY_YOU_LEADER:"You are now the leader.",PARTY_PLAYER_LEADER:"{0} is now leader.",PARTY_IS_LEADER:"{0} is already leader.",PARTY_NOT_IN:"You cannot leave as you are not in a party.",PARTY_PLAYER_LEFT:"{0} has left your party.",PARTY_YOU_LEFT:"You have left {0}'s party.",PARTY_ALL_LEFT:"The party has been disbanded.",NO_PLAYER_EXIST:"Player {0} does not exist.",HARVEST_INVALID:"You cannot use this at this time.",HARVEST_ADDED:"{0} has been added to your inventory",HARVEST_WRONG_TYPE:"You need to have a {0}.",HARVET_NO_WEAPON:"You do not have a harvest item equipped."}}},{}],339:[function(require,module,exports){module.exports={Rat:{name:"Rat",kind:1,attackMod:1,defenseMod:1,hpMod:1,xpMod:1,minLevel:1,maxLevel:3,aggroRange:0,attackRange:1,isAggressive:0,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"rat",idleSpeedMod:1},Crab:{name:"Crab",kind:2,attackMod:1.2,defenseMod:1.2,hpMod:1,minLevel:4,maxLevel:6,aggroRange:5,attackRange:1,isAggressive:0,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"crab",idleSpeedMod:1,modDamage:{hammer:1.2,axe:1,sword:1,bow:.8}},Skeleton:{name:"Skeleton",kind:3,attackMod:1.1,defenseMod:1.1,hpMod:1.2,minLevel:7,maxLevel:9,aggroRange:2,attackRange:1,isAggressive:1,attackRateMod:1.5,reactionMod:1.5,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"skeleton",idleSpeedMod:1,modDamage:{hammer:1.2,axe:1,sword:1,bow:.8}},Goblin:{name:"Goblin",kind:4,attackMod:1.2,defenseMod:.9,hpMod:.9,minLevel:10,maxLevel:12,aggroRange:3,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"goblin",idleSpeedMod:1},Snake:{name:"Snake",kind:5,attackMod:1.4,defenseMod:1,hpMod:.8,minLevel:13,maxLevel:15,aggroRange:3,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"snek",idleSpeedMod:1,modDamage:{axe:1.1,sword:1.1}},Bat:{name:"Bat",kind:6,attackMod:1.3,defenseMod:1,hpMod:1,minLevel:16,maxLevel:18,aggroRange:6,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:1,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"bat",idleSpeedMod:1,modDamage:{hammer:.8,axe:.9,sword:.9,bow:1}},Skeleton2:{name:"HardSkeleton",kind:7,attackMod:1.3,defenseMod:1.3,hpMod:1.2,minLevel:19,maxLevel:21,aggroRange:2,attackRange:1,isAggressive:1,attackRateMod:2,reactionMod:2,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"skeleton2",idleSpeedMod:1},Ogre:{name:"Ogre",kind:8,attackMod:1.3,defenseMod:1.1,hpMod:1.3,minLevel:22,maxLevel:24,aggroRange:5,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"ogre",idleSpeedMod:1},Eye:{name:"Eye",kind:9,attackMod:1.4,defenseMod:1,hpMod:1,minLevel:25,maxLevel:29,aggroRange:3,attackRange:1,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"eye",idleSpeedMod:1},Wizard:{name:"Wizard",kind:10,attackMod:1.4,defenseMod:1,hpMod:1,minLevel:30,maxLevel:34,aggroRange:6,attackRange:3,isAggressive:1,attackRateMod:1,reactionMod:1,moveSpeedMod:3,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"wizard",idleSpeedMod:1},Spectre:{name:"Spectre",kind:11,attackMod:1.3,defenseMod:1.3,hpMod:1,minLevel:35,maxLevel:40,aggroRange:2,attackRange:2,isAggressive:1,attackRateMod:2,reactionMod:.5,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"spectre",idleSpeedMod:1},DeathKnight:{name:"DeathKnight",kind:12,attackMod:1.5,defenseMod:1.5,hpMod:1.5,minLevel:41,maxLevel:50,aggroRange:4,attackRange:1,isAggressive:1,attackRateMod:2,reactionMod:.5,moveSpeedMod:2,respawnMod:1,dropRate:1,spawnChance:50,dropBonus:0,spriteName:"deathknight",idleSpeedMod:1}}},{}],340:[function(require,module,exports){module.exports={plot:["You have awoken","You're awake","It's awake?","You will die this time","How could this happen?","Is that you?","It cant be..","But, but I thought you were dead..","This time you will not survive.","I will kill you for good.","None can survive me!","Curses youre alive still.","But, We destroyed you..","We killed your father and well kill you.","How can you be alive still?","Your brother gasped as he died.","Its, its you..","The chosen one, ha you will pay in blood"],battle:["Argh","Ugh","Oooh","Ahhh","MMmm","Eaat","Delicious","Die","Kill it","Kill","Destroy","Maimm","Death","Foood","Starving","Rawr","Roar","Yummy","Grrr","Growl"]}},{}],341:[function(require,module,exports){module.exports=[{textid:"NOTICE1",interval:60}]},{}],342:[function(require,module,exports){module.exports={0:{type:0,text:"Kill %count Monsters Level %level or more"},1:{type:2,text:"%names! Kill %count of em"},2:{type:2,text:"I am dying kill %count of %names"},3:{type:2,text:"%names have destroyed my home kill %count"},4:{type:2,text:"%names have swarmed us kill %count"},5:{type:2,text:"We've been overtaken by %names kill %count"},6:{type:2,text:"Kill %count %names for fun, there evil."},7:{type:1,text:"Get %count %name. Return them to Collect in town."},8:{type:4,text:"Find %name. We playing hide and seek!"}}},{}],343:[function(require,module,exports){module.exports=["Aeris","Baelan","Caelum","Darian","Eldryn","Faelan","Gavriel","Haven","Ilys","Jaelin","Kaelan","Lirael","Maelis","Naelen","Ovryn","Peregrine","Quillen","Raelin","Sylas","Tyrian","Uvaine","Vaelis","Wylan","Xaelor","Yaelith","Zephyr","Aldryn","Briar","Cyran","Daelin","Elowen","Fenris","Gaelan","Harlow","Ivory","Jadis","Kieran","Loren","Myst","Nyssa"]},{}],344:[function(require,module,exports){module.exports={0:["Alters","Altes","Amel","Amew","Ancin","Ancis","Andent","Anies","Arryn","Artin","Artip","Berny","Berter","Brancent","Brancis","Chames","Charles","Charliam","Drewis","Driffin","Drobert","Droguy","Edmugh","Edmund","Enryn","Ephed","Epher","Ephes","Eran","Ernam","Ethes","Ewis","Exam","Exard","Folke","Friffin","Gauwill","Gauwyn","Geoffrey","Georguy","Gerey","Gery","Gilas","Gilip","Grarder","Grobern","Gylip","Hames","Hamund","Hany","Harrey","Hony","Ilham","Ilhard","Illiam","Inghan","Jamath","Johny","Lasym","Lesym","Mesym","Munder","Narder","Nichye","Phughye","Raffin","Ralphye","Reder","Reward","Rewilh","Rewyn","Reyny","Richye","Robern","Robern","Roge","Roge","Ryany","Stephye","Stiny","Symas","Thamath","Vyncent","Vyncis","Waltin","Wilhye","Wyny"],1:["Abeth","Adon","Aebun","Aedad","Aelburg","Aengeth","Aenthrynn","Alhhild","Alyn","Anel","Argel","Auciet","Balde","Beatrey","Bely","Bily","Breawe","Brictlu","Briga","Brihta","Brione","Brithuia","Bruda","Bryne","Brytha","Burha","Cilia","Conga","Corna","Cyna","Deburg","Deleue","Ealhbun","Ealhburh","Ealket","Eanchild","Eanswild","Ebun","Ecin","Efrix","Elil","Elin","Ellet","Ellyn","Ellys","Elyn","Enen","Enet","Engard","Ennet","Ethen","Evet","Frowe","Frude","Fruna","Godga","Goldburg","Gythiue","Hely","Heve","Hily","Hone","Idgen","Isan","Izan","Joane","Kater","Kathon","Lizab","Lyse","Malia","Mara","Marey","Marget","Mary","Mery","Mildgiue","Olburh","Phone","Ricta","Ridget","Rithuia","Sabenn","Sane","Sarry","Sidwe","Stilda","Suse","Sybel","Tortga","Ware","Wellu","Wene","Wenga","Wilthroua","Wise","Witha","Withburh","Withiue","Wrtheahburg","Wuthe"]}},{}],345:[function(require,module,exports){module.exports=[{uid:"default",index:0},{uid:"agent",name:"Auction",index:1},{uid:"ancientmanumentnpc",index:2},{uid:"angelnpc",index:3},{uid:"beachnpc",name:"Beachgoer",index:4},{uid:"bluebikinigirlnpc",index:5},{uid:"bluestoremannpc",name:"Bank",index:6},{uid:"boxingman",name:"Bank",index:7},{uid:"coder",name:"Looks",index:8},{uid:"desertnpc",name:"Repair",index:9},{uid:"doctor",name:"Looks",index:10},{uid:"elfnpc",index:11},{uid:"fairynpc",index:12},{uid:"firstsonangelnpc",index:13},{uid:"fisherman",index:14},{uid:"forestnpc",index:15},{uid:"guard",index:16},{uid:"iamverycoldnpc",index:17},{uid:"iceelfnpc",index:18},{uid:"king",index:19},{uid:"lavanpc",name:"Dying Man",index:20},{uid:"mermaidnpc",name:"Mermaid",index:21},{uid:"mojojojonpc",index:22},{uid:"momangelnpc",index:23},{uid:"nyan",index:24},{uid:"octocat",index:25},{uid:"octopus",index:26},{uid:"oddeyecat",index:27},{uid:"pirategirlnpc",index:28},{uid:"priest",index:29},{uid:"redbikinigirlnpc",index:30},{uid:"redstoremannpc",name:"Craft",index:31},{uid:"rick",name:"Collect",index:32},{uid:"scientist",index:33},{uid:"secondsonangelnpc",index:34},{uid:"shepherdboy",name:"Shop",index:35},{uid:"snowshepherdboy",name:"Beginner shop",index:36},{uid:"soldier",index:37},{uid:"sorcerer",index:38},{uid:"sponge",index:39},{uid:"superiorangelnpc",index:40},{uid:"vampire",index:41},{uid:"vendingmachine",name:"Enchant",index:42},{uid:"villagegirl",name:"Enchant",index:43},{uid:"villager",name:"Quests",index:44},{uid:"zombiegf",name:"Quests",index:45}]},{}],346:[function(require,module,exports){module.exports={2e5:{npcKind:0,name:"Intro 1-1",type:1,level:0,object:{type:2,kind:1,count:5},gold:30,expMultiplier:2},200001:{npcKind:0,name:"Intro 1-2",type:1,level:0,object:{type:2,kind:1,count:10},gold:30},200100:{npcKind:1,name:"Intro 2",type:2,level:0,object:{type:2,kind:1,level:[0,5]},object2:{type:4,kind:1,count:3,chance:20}},200200:{npcKind:2,name:"Intro 3",type:2,level:0,object:{type:2,kind:1,level:[0,5]},object2:{type:4,kind:41,count:5,chance:20}},200300:{npcKind:3,name:"Intro 4",type:2,level:0,object:{type:2,kind:2,level:[3,5]},object2:{type:4,kind:43,count:1,chance:5}},200400:{npcKind:4,name:"Intro 5",type:1,level:0,object:{type:2,kind:2,count:10}},200500:{npcKind:5,name:"Intro 6",type:2,level:0,object:{type:2,kind:2,level:[5,6]},object2:{type:4,kind:31,count:5,chance:15}},200600:{npcKind:6,name:"Intro 7",type:5,level:0,data1:2,object:{type:10,kind:3,count:5}},200700:{npcKind:7,name:"Intro 8",type:1,level:0,object:{type:2,kind:3,count:10}},200800:{npcKind:8,name:"Intro 9",type:2,level:0,object:{type:2,kind:3,level:[7,11]},object2:{type:4,kind:93,count:5,chance:15}},200900:{npcKind:9,name:"Intro 10",type:5,level:0,data1:1,object:{type:10,kind:3,count:5}},201e3:{npcKind:10,name:"Intro 11",type:1,level:0,object:{type:2,kind:4,count:20},reward:[{itemKind:100}]}}},{}],347:[function(require,module,exports){module.exports=[{name:"Beserker",skillType:"self",recharge:30,iconOffset:[1,7],detail:"Beserker [l] - Boosts your attack by 2xlevel for 10 seconds,",targetType:"self",duration:10,effects:[["self","start","attack",2],["self","end","attack",0]]},{name:"Explosive Attack",skillType:"attack",recharge:10,iconOffset:[3,12],detail:"Explosive Attack [l] - Area of Effect up to 50 damage per level",targetType:"enemy_aoe",countTotal:1,aoe:3,effects:[["self","start","damage",10],["self","end","damage",0]]},{name:"Deadly Attack",skillType:"attack",recharge:10,iconOffset:[4,7],detail:"Deadly Attack [l] - Does an attack of up to 250 damage per level.",targetType:"enemy",countTotal:1,effects:[["self","start","damage",50],["self","end","damage",0]]},{name:"Daze",skillType:"target",recharge:30,iconOffset:[0,12],detail:"Daze [l] - Dazes the target for [dpl]% seconds.",targetType:"enemy",durationPL:1,effects:[["target","start","freeze",1],["target","end","freeze",0]]},{name:"Shield",skillType:"self",recharge:30,iconOffset:[9,0],detail:"Shied [l] - Boosts your defense by 2xlevel for 10 seconds.",targetType:"self",duration:10,effects:[["self","start","defense",2],["self","end","defense",0]]},{name:"Bandaid",skillType:"self",recharge:30,iconOffset:[11,4],detail:"Bandaid [l] - Heals players 10hp per level per interval for 10 seconds.",targetType:"self",duration:10,effects:[["self","interval","hp",20],["self","end","hp",0]]},{name:"Healing",skillType:"self",recharge:30,iconOffset:[6,5],detail:"Healing [l] - Heals players 7.5% per level.",targetType:"self",duration:1,effects:[["self","start","hp",.075],["self","end","hp",0]]}]},{}],348:[function(require,module,exports){var exists,existsSync;(function(){var semver=require("semver");var module=semver.satisfies(process.version,">=0.7.1")?require("fs"):require("path");exists=module.exists;existsSync=module.existsSync})();if(!(typeof exports==="undefined")){module.exports.exists=exists;module.exports.existsSync=existsSync}},{fs:undefined,path:undefined,semver:240}],349:[function(require,module,exports){EventType={KILLMOB:1,LOOTITEM:2,KILLPLAYER:3,DAMAGE:4,USE_NODE:5,HARVEST:6};QuestType={KILLMOBKIND:1,GETITEMKIND:2,KILLMOBS:3,HIDEANDSEEK:4,USENODE:5};QuestStatus={STARTED:0,INPROGRESS:1,COMPLETE:2};InventoryMode={MODE_NORMAL:0,MODE_SELL:1,MODE_REPAIR:2,MODE_ENCHANT:3,MODE_BANK:4,MODE_AUCTION:5};SkillEffects={SkillType:{SELF:0,TARGET:1,ATTACK:2},TargetType:{SELF:0,ENEMY:1,PLAYER_AOE:2,ENEMY_AOE:3},EffectStat:{HP:0,EP:1,ATTACK:2,DEFENSE:3,DAMAGE:4,FREEZE:5,MOVESPEED:6}};Types={UserMessages:{CU_CONNECT_USER:1,CU_CREATE_USER:2,CU_LOGIN_USER:3,CU_CREATE_PLAYER:4,CU_LOGIN_PLAYER:5,CU_REMOVE_USER:6,UC_WORLD_READY:101,UC_WORLDS:102,UC_VERSION:103,UC_PLAYER_SUM:104,UC_ERROR:105,WU_CONNECT_WORLD:501,WU_GAMESERVER_INFO:502,WU_PLAYER_LOADED:503,WU_SAVE_PLAYER_AUCTIONS:504,WU_SAVE_PLAYER_LOOKS:505,WU_SAVE_PLAYERS_LIST:506,WU_SAVE_PLAYER_DATA:507,WU_PLAYER_LOGGED_IN:508,WU_SAVE_USER_BANS:509,WU_ADD_PLAYER_GOLD:510,WU_UPDATE_PLAYER_COUNT:511,UW_LOAD_PLAYER_AUCTIONS:601,UW_LOAD_PLAYER_LOOKS:602,UW_WORLD_SAVE:603,UW_WORLD_CLOSE:604,UW_LOAD_PLAYER_DATA:605,UW_LOAD_USER_BANS:606},Messages:{BI_SYNCTIME:200,CW_LOGIN_PLAYER:201,CW_ITEMSLOT:202,CW_APPEARANCEUNLOCK:203,CW_ATTACK:204,CW_AUCTIONBUY:205,CW_AUCTIONDELETE:206,CW_AUCTIONOPEN:207,CW_AUCTIONSELL:208,CW_BANKRETRIEVE:209,CW_BANKSTORE:210,CW_CHAT:211,CW_COLOR_TINT:212,CW_BLOCK_MODIFY:213,CW_GOLD:214,CW_PARTY:215,CW_HARVEST:216,CW_USE_NODE:217,CW_LOOKUPDATE:218,CW_LOOT:219,CW_MOVE:220,CW_MOVEPATH:221,CW_QUEST:222,CW_STATADD:223,CW_STOREBUY:224,CW_STORE_MODITEM:225,CW_STORESELL:226,CW_TALKTONPC:227,CW_CRAFT:228,CW_TELEPORT_MAP:229,CW_WHO:230,CW_SKILL:231,CW_SHORTCUT:232,CW_REQUEST:233,WC_ERROR:300,WC_PLAYER:301,WC_ACHIEVEMENT:302,WC_AUCTIONOPEN:303,WC_ITEMSLOT:304,WC_CHANGEPOINTS:305,WC_CHAT:306,WC_COLOR_TINT:307,WC_DAMAGE:308,WC_DESPAWN:309,WC_APPEARANCE:311,WC_GOLD:312,WC_PARTY:313,WC_PLAYERINFO:314,WC_ITEMLEVELUP:315,WC_STAT:316,WC_LEVELUP:317,WC_LIST:318,WC_LOG:320,WC_HARVEST:321,WC_MOVE:322,WC_MOVEPATH:323,WC_NOTIFY:324,WC_QUEST:325,WC_SKILLEFFECTS:326,WC_SKILLLOAD:327,WC_SPAWN:328,WC_SPEECH:329,WC_STATINFO:330,WC_TELEPORT_MAP:331,WC_SKILL_XP:332,WC_DIALOGUE:333,WC_SET_SPRITE:334,WC_SET_ANIMATION:335,WC_BLOCK_MODIFY:336,WC_PLAYERINFO:337,WC_VERSION:338},Orientations:{NONE:0,UP:1,DOWN:2,LEFT:3,RIGHT:4},EntityTypes:{NONE:0,PLAYER:1,MOB:2,ITEM:3,ITEMLOOT:4,NPCSTATIC:5,NPCMOVE:6,CHEST:7,BLOCK:8,TRAP:9,NODE:10},Keys:{ENTER:13,UP:38,DOWN:40,LEFT:37,RIGHT:39,W:87,A:65,S:83,D:68,SPACE:32,I:73,H:72,M:77,P:80,T:84,Y:89,KEYPAD_4:100,KEYPAD_6:102,KEYPAD_8:104,KEYPAD_2:98,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57},Skills:{BLOODSUCKING:1,RECOVERHEALTH:2,HEALANDHEAL:3,AVOIDATTACK:4,ADDEXPERIENCE:5,ATTACKWITHBLOOD:6,CRITICALATTACK:7,CRITICALRATIO:8},PlayerClass:{FIGHTER:0,ARCHER:1,DEFENDER:2,MAGE:3},PlayerState:{Roaming:0,Moving:1,Following:2,Aggro:3,Hurting:4,GettingItems:5,FollowPlayer:6}};var EntityTypes=Types.EntityTypes;Types.expForLevel=[];Types.defenseExp=[];Types.attackExp=[];Types.moveExp=[];Types.skillExp=[];Types.weaponExp=[];Types.expForLevel[0]=0;Types.defenseExp[0]=0;Types.attackExp[0]=0;Types.moveExp[0]=0;Types.skillExp[0]=0;Types.weaponExp[0]=0;for(i=1;i<50;i++){var points=Math.floor(i*300*Math.pow(1.5,i/5));console.info("level_"+i+"="+points);Types.expForLevel[i]=points;Types.defenseExp[i]=points*10+50;Types.attackExp[i]=points*10+50;Types.moveExp[i]=points*5+20;Types.skillExp[i]=~~(points/1.5);Types.weaponExp[i]=points*10+50}Types.getLevel=function(exp){if(typeof exp=="undefined"||exp==0)return 1;for(var i=1;i<200;i++){if(exp<Types.expForLevel[i]){return i}}return 50};Types.getAttackLevel=function(exp){if(exp==0)return 1;for(var i=1;i<200;i++){if(exp<Types.attackExp[i]){return i}}return 50};Types.getDefenseLevel=function(exp){if(exp==0)return 1;for(var i=1;i<200;i++){if(exp<Types.defenseExp[i]){return i}}return 50};Types.getMoveLevel=function(exp){if(exp==0)return 1;for(var i=1;i<200;i++){if(exp<Types.moveExp[i]){return i}}return 50};Types.getWeaponLevel=function(exp){if(exp==0)return 1;for(var i=1;i<200;i++){if(exp<Types.weaponExp[i]){return i}}return 50};Types.getSkillLevel=function(exp,level){level=level||1;if(typeof exp=="undefined"||exp==0)return 1;for(var i=level;i<10;i++){if(exp<Types.skillExp[i]){return i}}return 20};Types.isPlayer=function(kind){if(kind===1||kind===222)return true;return false};Types.getOrientationAsString=function(orientation){switch(orientation){case Types.Orientations.LEFT:return"left";break;case Types.Orientations.RIGHT:return"right";break;case Types.Orientations.UP:return"up";break;case Types.Orientations.DOWN:return"down";break}};Types.getMessageTypeAsString=function(type){var typeName;_.each(Types.Messages,function(value,name){if(value===type){typeName=name}});if(!typeName){typeName="UNKNOWN"}return typeName};if(!(typeof exports==="undefined")){module.exports=Types}},{}],350:[function(require,module,exports){var ItemTypes={};var ItemData={};var KindData={};ItemTypes.setKindData=function(kindData){KindData=kindData;ItemTypes.KindData=kindData};ItemTypes.getData=function(k){var data=KindData[k];if(!data||data.legacy==1)return null;return data};ItemTypes.getName=function(kind){try{var item=KindData[kind];if(!item)return"";return item.name}catch(e){console.error("No name found for item: "+KindData[kind]);console.error("Error stack: "+e.stack)}};ItemTypes.getWeaponLevel=function(kind){try{var item=KindData[kind];if(!item)return 0;return item.modifier}catch(e){console.error("No level found for weapon: "+KindData[kind]);console.error("Error stack: "+e.stack)}};ItemTypes.getArmorLevel=function(kind){try{var item=KindData[kind];if(!item)return 0;return item.modifier}catch(e){console.error("No level found for armor: "+KindData[kind]);console.error("Error stack: "+e.stack)}};ItemTypes.getItemByLevel=function(type,level){for(var kind in KindData){var item=KindData[kind];if((item.type=="armor"||item.type=="armorarcher")&&item.type==type&&level==item.modifier){return item}if((item.type=="weapon"||item.type=="weaponarcher")&&item.type==type&&level==item.modifier){return item}}return null};ItemTypes.getLevelByKind=function(kind){var item=KindData[kind];if(ItemTypes.isArmor(kind)){return item.level}if(ItemTypes.isWeapon(kind)){return item.level}return null};ItemTypes.getType=function(kind){try{var item=KindData[kind];return item.type}catch(e){console.error("No type found for item: "+kind);console.error("Error stack: "+e.stack)}};ItemTypes.getBuyPrice=function(kind){var item=KindData[kind];if(!item)return 0;var type=item.type;if(type=="bow"){return Math.floor(item.modifier*item.modifier*5)}else if(type=="chest"){return Math.floor(item.modifier*item.modifier*5)}else if(ItemTypes.isArmor(kind)){return Math.floor(item.modifier*item.modifier*10)}else if(ItemTypes.isWeapon(kind)){return Math.floor(item.modifier*item.modifier*5)}else if(type=="object"&&item.buy>0){if(item.buyCount>1)return item.buy*item.buyCount;else return item.buy}return 0};ItemTypes.getCraftPrice=function(k){var item=KindData[k];if(!item||item.legacy==1)return 0;if(item.buy>0)return item.buy;return~~(ItemTypes.getBuyPrice(k)/4)};ItemTypes.getEnchantSellPrice=function(item){var value=ItemTypes.getBuyPrice(item.itemKind)/10;var enchantLevel=item.itemNumber;if(enchantLevel>1){value+=~~(ItemTypes.getEnchantPrice(item)/10)}value*=item.itemDurabilityMax/900;return Math.floor(value)};ItemTypes.getEnchantPrice=function(item,current){current=current||false;if(!item)return NaN;var data=KindData[item.itemKind];var enchantLevel=current?item.itemNumber:item.itemNumber+1;var curLevel=item.itemNumber;if(enchantLevel>=25)return NaN;experience=item.itemExperience;var baseLevel=data.modifier;console.info("getEnchantPrice: "+ItemTypes.itemExpForLevel[enchantLevel]);var cost=Math.floor(baseLevel*baseLevel*10*Math.pow(2,enchantLevel)*(1-experience/ItemTypes.itemExpForLevel[enchantLevel]));console.info("cost: "+cost);return cost};var Clamp=function(min,max,value){if(value<min){return min}else if(value>max){return max}else{return value}};ItemTypes.getRepairPrice=function(item){var value=ItemTypes.getBuyPrice(item.itemKind)/10;if(item.itemDurability==item.itemDurabilityMax)return 0;if(item.itemNumber>1){value=ItemTypes.getEnchantPrice(item,true)/10}var mp=item.itemDurabilityMax/900*(1-item.itemDurability/item.itemDurabilityMax);log.info("getRepairPrice - mp: "+mp);value*=Clamp(0,1,mp);return 1+~~value};ItemTypes.isEquippable=function(kind){if(ItemTypes.isArmor(kind)||ItemTypes.isWeapon(kind)||ItemTypes.isArcherWeapon(kind)||ItemTypes.isClothes(kind))return true;return false};ItemTypes.isClothes=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="helm"||item.type==="chest"||item.type==="gloves"||item.type==="boots"};ItemTypes.isArmor=function(kind){var item=KindData[kind];if(!item)return false;return ItemTypes.isClothes(kind)};ItemTypes.isWeapon=function(kind){var item=KindData[kind];if(!item)return false;return ItemTypes.isMeleeWeapon(kind)||ItemTypes.isArcherWeapon(kind)};ItemTypes.isEquipment=function(kind){var item=KindData[kind];if(!item)return false;return ItemTypes.isWeapon(kind)||ItemTypes.isArmor(kind)};ItemTypes.getSpriteCode=function(kind){var data=KindData[kind];if(ItemTypes.isArmor(kind)){return kind}if(ItemTypes.isWeapon(kind)){var type=data.type;if(!type)return 0;if(type=="sword")return 1;if(type=="axe")return 2;if(type=="hammer")return 12;if(type=="bow")return 50}return 0};ItemTypes.getEquipmentSlot=function(kind){if(ItemTypes.isWeapon(kind))return 4;var item=KindData[kind];if(!item)return-1;if(item.type==="helm")return 0;if(item.type==="chest")return 1;if(item.type==="gloves")return 2;if(item.type==="boots")return 3;return-1};ItemTypes.isMeleeWeapon=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="sword"||item.type==="hammer"||item.type==="axe"};ItemTypes.isHarvestWeapon=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="hammer"||item.type==="axe"};ItemTypes.isArcherWeapon=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="bow"};ItemTypes.isObject=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="object"};ItemTypes.isCraftItem=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="craft"};ItemTypes.isLootItem=function(kind){return kind>=1e3&&kind<2e3};ItemTypes.isConsumableItem=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="object"};ItemTypes.isHealingItem=function(kind){var item=KindData[kind];if(!item)return false;return item.type==="object"&&(item.typemod=="health"||item.typemod=="healthpercent")};ItemTypes.isItem=function(kind){var item=ItemTypes.KindData[kind];if(!item)return false;return ItemTypes.isArmor(kind)||ItemTypes.isWeapon(kind)||item.type=="object"||item.type=="craft"};ItemTypes.isStackedItem=function(kind){var item=KindData[kind];if(!item)return false;return ItemTypes.isCraftItem(kind)||ItemTypes.isLootItem(kind)||ItemTypes.isConsumableItem(kind)};ItemTypes.forEachKind=function(callback){for(var k in kindData){callback(KindData[k],k)}};ItemTypes.forEachArmorKind=function(callback){Types.forEachKind(function(kind,kindName){if(ItemTypes.isArmor(kind)){callback(kind,kindName)}})};ItemTypes.forEachWeaponKind=function(callback){Types.forEachKind(function(kind,kindName){if(ItemTypes.isWeapon(kind)){callback(kind,kindName)}})};ItemTypes.forEachArcherWeaponKind=function(callback){Types.forEachKind(function(kind,kindName){if(ItemTypes.isArcherWeapon(kind)){callback(kind,kindName)}})};ItemTypes.getItemListBy=function(itemType,minLevel,maxLevel){var ItemsList=[];for(var k in KindData){var item=KindData[k];if(!item||item.legacy==1)continue;if(itemType==4&&!(ItemTypes.isArmor(k)||ItemTypes.isWeapon(k))){ItemsList.push({name:item.name,kind:k,type:item.type,buyCount:item.buycount,buyPrice:item.buy,craftPrice:ItemTypes.getCraftPrice(k),itemKind:k,itemNumber:item.buycount,craft:item.craft})}if(itemType==1&&item.type=="object"&&item.buy>0){ItemsList.push({name:item.name,kind:k,type:item.type,buyCount:item.buycount,buyPrice:item.buy,craftPrice:ItemTypes.getCraftPrice(k),itemKind:k,itemNumber:item.buycount,craft:item.craft})}else if(itemType==2&&ItemTypes.isArmor(k)&&item.modifier>=minLevel&&item.modifier<=maxLevel){ItemsList.push({name:item.name,kind:k,type:item.type,buyCount:item.buyCount,buyPrice:ItemTypes.getBuyPrice(k),craftPrice:ItemTypes.getCraftPrice(k),rank:item.level,itemKind:k,itemNumber:item.buycount,craft:item.craft})}else if(itemType==3&&ItemTypes.isWeapon(k)&&item.modifier>=minLevel&&item.modifier<=maxLevel){ItemsList.push({name:item.name,kind:k,type:item.type,buyCount:item.buyCount,buyPrice:ItemTypes.getBuyPrice(k),craftPrice:ItemTypes.getCraftPrice(k),rank:item.level,itemKind:k,itemNumber:item.buycount,craft:item.craft})}}if(ItemsList.length>0&&ItemsList[0].rank>0)ItemsList.sort(function(a,b){return a.rank-b.rank});return ItemsList};ItemTypes.Store={isBuy:function(id){var item=KindData[id];if(!item)return false;return item.buy>0?true:false},isBuyMultiple:function(id){var item=KindData[id];if(!item)return false;return item.buycount>0?true:false},isSell:function(id){var item=KindData[id];if(!item)return false;return item.buy>=2?true:false},getBuyCount:function(id){var item=KindData[id];if(!item)return false;return item.buyCount>1?item.buyCount:1},getItems:function(type,min,max){return ItemTypes.getItemListBy(type,min,max)}};ItemTypes.itemExpForLevel=[];ItemTypes.itemExpForLevel[0]=0;for(i=1;i<30;i++){var points=Math.floor(i*150*Math.pow(2,i/10));ItemTypes.itemExpForLevel[i]=points}ItemTypes.getItemLevel=function(exp){if(exp==0)return 1;var i=1;for(i=1;i<30;i++){if(exp>ItemTypes.itemExpForLevel[i-1]&&exp<=ItemTypes.itemExpForLevel[i]){return i}}return 30};if(!(typeof exports==="undefined")){module.exports=ItemTypes}},{}]},{},[45]);
